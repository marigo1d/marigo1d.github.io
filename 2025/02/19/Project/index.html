<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"marigo1d.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Project &amp; related">
<meta property="og:type" content="article">
<meta property="og:title" content="Project">
<meta property="og:url" content="https://marigo1d.github.io/2025/02/19/Project/index.html">
<meta property="og:site_name" content="Marigold">
<meta property="og:description" content="Project &amp; related">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/image-20250219124534631.png">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/71DF4D3AC7166BD8DE046102F534D4EB.png">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/E68452CA74D6142357E95AD499697CFB.png">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/5CF8B7418CDADCA4998A29C7F084CE08.png">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/0CE3A54805CB047FA700CFDE30A643BA.png">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/njjbtvfwn2.png">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/FnuC7iOSLJbLu9apUaP886tm7eGD">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/Camera_XHS_17416135605101040g2sg315pqsv4ohc0g5oun.jpg">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/Camera_XHS_17416135708561040g2sg315pqsv4ohc2g5oun.jpg">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/Camera_XHS_17416135670761040g2sg315pqsv4ohc205oun.jpg">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/Camera_XHS_17416135625461040g2sg315pqsv4ohc105oun.jpg">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/Camera_XHS_17416135646421040g2sg315pqsv4ohc1g5oun.jpg">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8a949368c524bed93123c832290610b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1244&amp;h=617&amp;s=43089&amp;e=png&amp;b=ffffff">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/v2-788007b6d898a775abd4889d22892a3d_1440w.jpg">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/v2-41835bffd6cf315cffaf8c4e52a94496_1440w.jpg">
<meta property="og:image" content="https://marigo1d.github.io/2025/02/19/Project/cas-1741240463041.png">
<meta property="article:published_time" content="2025-02-19T04:21:16.000Z">
<meta property="article:modified_time" content="2025-04-14T04:44:27.220Z">
<meta property="article:author" content="marigo1d">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://marigo1d.github.io/2025/02/19/Project/image-20250219124534631.png">

<link rel="canonical" href="https://marigo1d.github.io/2025/02/19/Project/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Project | Marigold</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Marigold</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Salt, Pepper and Birds~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://marigo1d.github.io/2025/02/19/Project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="marigo1d">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marigold">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Project
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-02-19 12:21:16" itemprop="dateCreated datePublished" datetime="2025-02-19T12:21:16+08:00">2025-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-14 12:44:27" itemprop="dateModified" datetime="2025-04-14T12:44:27+08:00">2025-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Project/" itemprop="url" rel="index"><span itemprop="name">Project</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1:01</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Project &amp; related</p>
<span id="more"></span>
<h1>Project</h1>
<h2 id="E-Shop">E-Shop</h2>
<h3 id="责任链模式">责任链模式</h3>
<br>
<h3 id="秒杀场景">秒杀场景</h3>
<p>采用预取-缓冲池思路</p>
<ul>
<li>在秒杀业务开启前，多地的Redis预先从数据库中扣除一定量的库存，保存在Redis中，<strong>修改数据库值</strong></li>
<li>每个service进行秒杀时，使用Lua脚本原子的扣除本地Redis的库存，<strong>不涉及数据库访问</strong></li>
<li>（如果使用本地缓存）每个service考虑预先从本地Redis中取出一定量的库存，进行本地原子扣除；若本地缓存不够，原子的从本地Redis中取出一定量的库存；</li>
<li>秒杀流量下降后（考虑使用延迟队列方式实现延时任务），多地的Redis返还数据库库存，<strong>修改数据库值</strong></li>
</ul>
<br>
<p>lua脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 参数说明：</span></span><br><span class="line"><span class="comment">-- KEYS[1]: 库存 Key (seckill:stock:&#123;商品ID&#125;)</span></span><br><span class="line"><span class="comment">-- KEYS[2]: 用户购买记录 Key (seckill:user:&#123;用户ID&#125;:&#123;商品ID&#125;)</span></span><br><span class="line"><span class="comment">-- ARGV[1]: 用户 ID</span></span><br><span class="line"><span class="comment">-- ARGV[2]: 商品 ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取库存</span></span><br><span class="line"><span class="keyword">local</span> stock = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>])) <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查库存是否大于 0</span></span><br><span class="line"><span class="keyword">if</span> stock &lt;= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> <span class="comment">-- 库存不足</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查用户是否已购买</span></span><br><span class="line"><span class="keyword">local</span> purchased = redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">if</span> purchased <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span> <span class="comment">-- 用户已购买</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 扣减库存</span></span><br><span class="line">redis.call(<span class="string">&#x27;DECR&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 标记用户已购买</span></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[<span class="number">2</span>], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回成功</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<br>
<h2 id="ShortLink">ShortLink</h2>
<p>创新点</p>
<ol>
<li>使用布隆过滤器来判断短链接是否已存在，提高了判断效率，远胜于使用分布式锁搭配查询数据库的方案。</li>
<li>借助 RocketMQ 消息队列的&quot;削峰&quot;特点，实现海量访问短链接场景下的监控信息存储功能，确保系统在高负载情况下仍能正常运行。</li>
<li>优化更新或失效场景下大量请求查询数据库问题，封装缓存不存在读取功能，采用分布式锁互斥策略，减少对数据库的频繁查询。</li>
<li>为保障短链接缓存与数据库之间的数据一致性，采用了通过更新数据库删除缓存的策略，保证了两者之间的数据一致性。</li>
<li>在消息队列消费业务中，我使用 Redis 来完成幂等场景的处理，确保消息在一定时间内仅被消费一次，避免重复处理。</li>
<li>为实现短链接在海量访问场景下的数据修改功能，我使用了 Redisson 分布式读写锁，确保数据修改的安全和一致性。</li>
<li>考虑兼容短链接用户需求，短链接数据分片的基础上增加了路由表，使用户能够方便地分页查看短链接。</li>
<li>使用 Sentinel 进行接口访问的 QPS 限流，以保障短链接系统的稳定运行。当触发限流规则时，系统能够进行降级处理，确保核心功能的可用性。</li>
</ol>
<br>
<h3 id="后端敏感信息返回">后端敏感信息返回</h3>
<p>方案一：</p>
<p>使用Spring AOP对返回信息过滤</p>
<p>方案二：</p>
<p>通过Json序列化，在Spring返回对象的序列化结果时，使用自定义序列化器进行序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneDesensitizationSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(String phone, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneDesensitization</span> <span class="operator">=</span> DesensitizedUtil.mobilePhone(phone);</span><br><span class="line">        jsonGenerator.writeString(phoneDesensitization);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonSerialize(using = PhoneDesensitizationSerializer.class)</span></span><br><span class="line"><span class="keyword">private</span> String phone;</span><br></pre></td></tr></table></figure>
<br>
<br>
<h3 id="用户会话上下文保存">用户会话上下文保存</h3>
<p>自定义 Servlet 容器 Filter 过滤器，使用ThreadLocal保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 过滤器实现从请求中截取用户名并创建对象保存到当前线程的ThreadLocal对象中</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTransmitFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(username)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">realName</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;realName&quot;</span>);</span><br><span class="line">            <span class="type">UserInfoDTO</span> <span class="variable">userInfoDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfoDTO</span>(userId, username, realName);</span><br><span class="line">            UserContext.setUser(userInfoDTO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            UserContext.removeUser(); <span class="comment">// 移除ThreadLocal对象</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上下文保存</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;https://github.com/alibaba/transmittable-thread-local&quot; /&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;UserInfoDTO&gt; USER_THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置用户至上下文</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户详情信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setUser</span><span class="params">(UserInfoDTO user)</span> &#123;</span><br><span class="line">        USER_THREAD_LOCAL.set(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="流量控制">流量控制</h3>
<p>例如，1秒中允许请求最多 x 次</p>
<p>通过 Redis <code>increment</code> 命令对 与用户名映射的数据 进行递增，超过 x 次就会返回失败；该数据有效期为 1 秒</p>
<br>
<h3 id="布隆过滤器的使用与误判">布隆过滤器的使用与误判</h3>
<p>使用布隆过滤器</p>
<p>位图 + 多个散列函数</p>
<p>例如</p>
<img src="/2025/02/19/Project/image-20250219124534631.png" class="" title="image-20250219124534631">
<br>
<p>布隆过滤器存在误判情况</p>
<p><strong>目标不存在，判定为存在</strong></p>
<blockquote>
<p>不可能情况：目标存在，判定为不存在</p>
<p>布隆过滤器不能进行删除哦</p>
</blockquote>
<p>即 布隆过滤器 会给出</p>
<ul>
<li>不存在</li>
<li>可能存在</li>
</ul>
<p>因此，</p>
<p><strong>查询时</strong>，先通过布隆过滤器判断是否存在，减少数据库查询次数。假阳性可能导致误查询，但不会漏掉真实存在的记录。</p>
<p><strong>插入时</strong>，布隆过滤器应该在数据插入数据库之后更新，以保持一致性。</p>
<p><strong>删除时</strong>，删除操作需要谨慎，布隆过滤器不直接支持删除，操作数据库。</p>
<p><strong>更新时</strong>，先通过布隆过滤器判断是否存在，然后再进行数据库查询与布隆更新。</p>
<br>
<h3 id="短链信息统计">短链信息统计</h3>
<p>相同的用户多次访问相同短链接，使用Cookie记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ShortLinkStatsRecordDTO <span class="title function_">buildLinkStatsRecordAndSetUser</span><span class="params">(String fullShortUrl, ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">AtomicBoolean</span> <span class="variable">uvFirstFlag</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>();</span><br><span class="line">        Cookie[] cookies = ((HttpServletRequest) request).getCookies();</span><br><span class="line">        AtomicReference&lt;String&gt; uv = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义一个 Runnable 任务 addResponseCookieTask，用于添加响应 Cookie 并处理首次访问的逻辑</span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">addResponseCookieTask</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            uv.set(UUID.fastUUID().toString());</span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">uvCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;uv&quot;</span>, uv.get());</span><br><span class="line">            uvCookie.setMaxAge(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>);</span><br><span class="line">            <span class="comment">// 设置 Cookie 的路径。从 fullShortUrl 中截取第一个 &#x27;/&#x27; 之后的部分作为路径。</span></span><br><span class="line">            <span class="comment">// 比如 fullShortUrl 是 &quot;http://example.com/s/xyz&quot;，那么路径就是 &quot;/s/xyz&quot;</span></span><br><span class="line">            uvCookie.setPath(StrUtil.sub(fullShortUrl, fullShortUrl.indexOf(<span class="string">&quot;/&quot;</span>), fullShortUrl.length()));</span><br><span class="line">            ((HttpServletResponse) response).addCookie(uvCookie);</span><br><span class="line">            <span class="comment">// 设置 uvFirstFlag 为 true，表示是首次访问</span></span><br><span class="line">            uvFirstFlag.set(Boolean.TRUE);</span><br><span class="line">            <span class="comment">// 将用户标识符 uv 添加到 Redis Set 中，用于统计独立访客（UV）。</span></span><br><span class="line">            <span class="comment">// Key 是 SHORT_LINK_STATS_UV_KEY + fullShortUrl。</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(SHORT_LINK_STATS_UV_KEY + fullShortUrl, uv.get());</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查请求中是否存在 Cookie</span></span><br><span class="line">        <span class="keyword">if</span> (ArrayUtil.isNotEmpty(cookies)) &#123;</span><br><span class="line">            Arrays.stream(cookies)</span><br><span class="line">                    .filter(each -&gt; Objects.equals(each.getName(), <span class="string">&quot;uv&quot;</span>))</span><br><span class="line">                    .findFirst()</span><br><span class="line">                    .map(Cookie::getValue)</span><br><span class="line">                    <span class="comment">// 如果存在名为 &quot;uv&quot; 的 Cookie，则执行以下操作：</span></span><br><span class="line">                    .ifPresentOrElse(each -&gt; &#123;</span><br><span class="line">                        <span class="comment">// 将 Cookie 的值（即已有的用户标识符）设置到 uv 中</span></span><br><span class="line">                        uv.set(each);</span><br><span class="line">                        <span class="comment">// 尝试将用户标识符添加到 Redis Set 中。</span></span><br><span class="line">                        <span class="comment">//  stringRedisTemplate.opsForSet().add() 返回一个 Long 值：</span></span><br><span class="line">                        <span class="comment">//  - 如果添加成功（即该值之前不存在于 Set 中），则返回 1。</span></span><br><span class="line">                        <span class="comment">//  - 如果添加失败（即该值已存在于 Set 中），则返回 0。</span></span><br><span class="line">                        <span class="comment">//  - 如果出现错误，可能返回 null。</span></span><br><span class="line">                        <span class="type">Long</span> <span class="variable">uvAdded</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().add(SHORT_LINK_STATS_UV_KEY + fullShortUrl, each);</span><br><span class="line">                        <span class="comment">// 设置 uvFirstFlag。如果 uvAdded 不为 null 且大于 0，则表示是首次访问，设置为 true；否则为 false。</span></span><br><span class="line">                        uvFirstFlag.set(uvAdded != <span class="literal">null</span> &amp;&amp; uvAdded &gt; <span class="number">0L</span>);</span><br><span class="line">                    &#125;, addResponseCookieTask); <span class="comment">// 如果不存在名为 &quot;uv&quot; 的 Cookie，则执行 addResponseCookieTask（即创建新的 UV 并添加到响应中）</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addResponseCookieTask.run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteAddr</span> <span class="operator">=</span> LinkUtil.getActualIp(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> LinkUtil.getOs(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">browser</span> <span class="operator">=</span> LinkUtil.getBrowser(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">device</span> <span class="operator">=</span> LinkUtil.getDevice(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">network</span> <span class="operator">=</span> LinkUtil.getNetwork(((HttpServletRequest) request));</span><br><span class="line">        <span class="comment">// 尝试将访问者的 IP 地址添加到 Redis Set 中，SHORT_LINK_STATS_UIP_KEY + fullShortUrl 为 Key，Unique IP 为 Value</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">uipAdded</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().add(SHORT_LINK_STATS_UIP_KEY + fullShortUrl, remoteAddr);</span><br><span class="line">        <span class="comment">// 如果 Redis Set 中已经存在该 IP 地址，则 uipAdded 为 null 或 0，否则为新加入的 IP 地址数量 (1)，表示这是一个新 IP</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uipFirstFlag</span> <span class="operator">=</span> uipAdded != <span class="literal">null</span> &amp;&amp; uipAdded &gt; <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ShortLinkStatsRecordDTO.builder()</span><br><span class="line">                .fullShortUrl(fullShortUrl)</span><br><span class="line">                .uv(uv.get())</span><br><span class="line">                .uvFirstFlag(uvFirstFlag.get())</span><br><span class="line">                .uipFirstFlag(uipFirstFlag)</span><br><span class="line">                .remoteAddr(remoteAddr)</span><br><span class="line">                .os(os)</span><br><span class="line">                .browser(browser)</span><br><span class="line">                .device(device)</span><br><span class="line">                .network(network)</span><br><span class="line">                .currentDate(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<br>
<h3 id="缓存击穿防护">缓存击穿防护</h3>
<p>缓存过期时间工具类：</p>
<p>1.如果date超过当前时间一周，那么设置过期时间为一周，并随机一个0~24小时的时间</p>
<p>2.如果date没有超过当前时间一周，那么设置指定的时间</p>
<p>3.如果date为null，则设置过期时间为一周，并随机一个0~24小时的时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ONE_WEEK_MILLIS</span> <span class="operator">=</span> <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>; </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* 获取短链接缓存过期时间戳</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> date 日期 </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 短链接缓存过期时间戳 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getShortLinkCacheTime</span><span class="params">(Date date)</span> &#123;    </span><br><span class="line">    <span class="comment">// 当前时间    </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();     </span><br><span class="line">    <span class="comment">// 如果 date 为 null，则默认设置为一周后的时间戳，并随机一个 0 ~ 24 小时的时间    </span></span><br><span class="line">    <span class="keyword">if</span> (date == <span class="literal">null</span>) &#123;        </span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        calendar.add(Calendar.DAY_OF_MONTH, <span class="number">7</span>);        </span><br><span class="line">        <span class="keyword">return</span> calendar.getTimeInMillis() + ThreadLocalRandom.current().nextLong(<span class="number">0</span>, <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>);    </span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="type">long</span> <span class="variable">dateMillis</span> <span class="operator">=</span> date.getTime();     <span class="comment">// 检查 date 是否超过一周    </span></span><br><span class="line">    <span class="keyword">if</span> (dateMillis - currentTimeMillis &gt; ONE_WEEK_MILLIS) &#123;        </span><br><span class="line">        <span class="comment">// 如果超过一周，那么将有效时间设置在一周后        </span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        calendar.add(Calendar.DAY_OF_MONTH, <span class="number">7</span>);        </span><br><span class="line">        <span class="keyword">return</span> calendar.getTimeInMillis() + ThreadLocalRandom.current().nextLong(<span class="number">0</span>, <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>);    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;        </span><br><span class="line">        <span class="comment">// 如果没有超过一周，则设置为 date 的时间戳        </span></span><br><span class="line">        <span class="keyword">return</span> dateMillis;    </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="缓存穿透防护">缓存穿透防护</h3>
<p>redis 保存 无效短链接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">gotoIsNullShortLink</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl));  <span class="comment">// 从redis中获取该短链接是否被标记为null。 用于防止缓存击穿。</span></span><br><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(gotoIsNullShortLink)) &#123; <span class="comment">// 如果redis中存在该短链被标记为null。</span></span><br><span class="line">((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>); <span class="comment">// 将用户重定向到一个 &quot;notfound&quot; 页面，表示该短链接URL无效。</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="消息队列更新数据库">消息队列更新数据库</h3>
<br>
<br>
<h3 id="流程">流程</h3>
<h4 id="短链生成流程">短链生成流程</h4>
<img src="/2025/02/19/Project/71DF4D3AC7166BD8DE046102F534D4EB.png" class="" title="71DF4D3AC7166BD8DE046102F534D4EB">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ShortLinkCreateRespDTO <span class="title function_">createShortLink</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    verificationWhitelist(requestParam.getOriginUrl());</span><br><span class="line">    <span class="type">String</span> <span class="variable">shortLinkSuffix</span> <span class="operator">=</span> generateSuffix(requestParam);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullShortUrl</span> <span class="operator">=</span> StrBuilder.create(createShortLinkDefaultDomain)</span><br><span class="line">        .append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">        .append(shortLinkSuffix)</span><br><span class="line">        .toString();</span><br><span class="line">    <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">        .domain(createShortLinkDefaultDomain)</span><br><span class="line">        .originUrl(requestParam.getOriginUrl())</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .createdType(requestParam.getCreatedType())</span><br><span class="line">        .validDateType(requestParam.getValidDateType())</span><br><span class="line">        .validDate(requestParam.getValidDate())</span><br><span class="line">        .describe(requestParam.getDescribe())</span><br><span class="line">        .shortUri(shortLinkSuffix)</span><br><span class="line">        .enableStatus(<span class="number">0</span>)</span><br><span class="line">        .totalPv(<span class="number">0</span>)</span><br><span class="line">        .totalUv(<span class="number">0</span>)</span><br><span class="line">        .totalUip(<span class="number">0</span>)</span><br><span class="line">        .delTime(<span class="number">0L</span>)</span><br><span class="line">        .fullShortUrl(fullShortUrl)</span><br><span class="line">        .favicon(getFavicon(requestParam.getOriginUrl()))</span><br><span class="line">        .build();</span><br><span class="line">    <span class="type">ShortLinkGotoDO</span> <span class="variable">linkGotoDO</span> <span class="operator">=</span> ShortLinkGotoDO.builder()</span><br><span class="line">        .fullShortUrl(fullShortUrl)</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        baseMapper.insert(shortLinkDO);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DuplicateKeyException ex) &#123;</span><br><span class="line">        <span class="comment">// 加入数据库失败，数据库已存在重复短链</span></span><br><span class="line">        <span class="comment">// 判断布隆中是否存在该短链，不存在则添加</span></span><br><span class="line">        <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(fullShortUrl)) &#123;</span><br><span class="line">            shortUriCreateCachePenetrationBloomFilter.add(fullShortUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(String.format(<span class="string">&quot;短链接：%s 生成重复&quot;</span>, fullShortUrl));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将短链-原链加入Redis_ex</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(</span><br><span class="line">        String.format(GOTO_SHORT_LINK_KEY, fullShortUrl),</span><br><span class="line">        requestParam.getOriginUrl(),</span><br><span class="line">        LinkUtil.getLinkCacheValidTime(requestParam.getValidDate()), TimeUnit.MILLISECONDS</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 将短链加入布隆</span></span><br><span class="line">    shortUriCreateCachePenetrationBloomFilter.add(fullShortUrl);</span><br><span class="line">    <span class="keyword">return</span> ShortLinkCreateRespDTO.builder()</span><br><span class="line">        .fullShortUrl(<span class="string">&quot;http://&quot;</span> + shortLinkDO.getFullShortUrl())</span><br><span class="line">        .originUrl(requestParam.getOriginUrl())</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ShortLinkCreateRespDTO <span class="title function_">createShortLinkByLock</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    verificationWhitelist(requestParam.getOriginUrl());</span><br><span class="line">    String fullShortUrl;</span><br><span class="line">    <span class="comment">// 分布式锁创建短链接</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(SHORT_LINK_CREATE_LOCK_KEY);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shortLinkSuffix</span> <span class="operator">=</span> generateSuffixByLock(requestParam);</span><br><span class="line">        fullShortUrl = StrBuilder.create(createShortLinkDefaultDomain)</span><br><span class="line">            .append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">            .append(shortLinkSuffix)</span><br><span class="line">            .toString();</span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">            .domain(createShortLinkDefaultDomain)</span><br><span class="line">            .originUrl(requestParam.getOriginUrl())</span><br><span class="line">            .gid(requestParam.getGid())</span><br><span class="line">            .createdType(requestParam.getCreatedType())</span><br><span class="line">            .validDateType(requestParam.getValidDateType())</span><br><span class="line">            .validDate(requestParam.getValidDate())</span><br><span class="line">            .describe(requestParam.getDescribe())</span><br><span class="line">            .shortUri(shortLinkSuffix)</span><br><span class="line">            .enableStatus(<span class="number">0</span>)</span><br><span class="line">            .totalPv(<span class="number">0</span>)</span><br><span class="line">            .totalUv(<span class="number">0</span>)</span><br><span class="line">            .totalUip(<span class="number">0</span>)</span><br><span class="line">            .delTime(<span class="number">0L</span>)</span><br><span class="line">            .fullShortUrl(fullShortUrl)</span><br><span class="line">            .favicon(getFavicon(requestParam.getOriginUrl()))</span><br><span class="line">            .build();</span><br><span class="line">        <span class="type">ShortLinkGotoDO</span> <span class="variable">linkGotoDO</span> <span class="operator">=</span> ShortLinkGotoDO.builder()</span><br><span class="line">            .fullShortUrl(fullShortUrl)</span><br><span class="line">            .gid(requestParam.getGid())</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            baseMapper.insert(shortLinkDO);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(String.format(<span class="string">&quot;短链接：%s 生成重复&quot;</span>, fullShortUrl));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(</span><br><span class="line">            String.format(GOTO_SHORT_LINK_KEY, fullShortUrl),</span><br><span class="line">            requestParam.getOriginUrl(),</span><br><span class="line">            LinkUtil.getLinkCacheValidTime(requestParam.getValidDate()), TimeUnit.MILLISECONDS</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(fullShortUrl)) &#123;</span><br><span class="line">            shortUriCreateCachePenetrationBloomFilter.add(fullShortUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ShortLinkCreateRespDTO.builder()</span><br><span class="line">        .fullShortUrl(<span class="string">&quot;http://&quot;</span> + fullShortUrl)</span><br><span class="line">        .originUrl(requestParam.getOriginUrl())</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不加锁创建短链后缀</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">generateSuffix</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">customGenerateCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    String shorUri;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (customGenerateCount &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;短链接频繁生成，请稍后再试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">originUrl</span> <span class="operator">=</span> requestParam.getOriginUrl();</span><br><span class="line">        originUrl += UUID.randomUUID().toString();  <span class="comment">// 原链 + 随机数 </span></span><br><span class="line">        shorUri = HashUtil.hashToBase62(originUrl); <span class="comment">// 原链 + 随机数 -&gt; 短链</span></span><br><span class="line">        <span class="comment">// 先查布隆，若可能存在直接下一轮</span></span><br><span class="line">        <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(createShortLinkDefaultDomain + <span class="string">&quot;/&quot;</span> + shorUri)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        customGenerateCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shorUri;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 加锁创建短链后缀</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">generateSuffixByLock</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">customGenerateCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    String shorUri;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (customGenerateCount &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;短链接频繁生成，请稍后再试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">originUrl</span> <span class="operator">=</span> requestParam.getOriginUrl();</span><br><span class="line">        originUrl += UUID.randomUUID().toString();</span><br><span class="line">        shorUri = HashUtil.hashToBase62(originUrl);</span><br><span class="line">        LambdaQueryWrapper&lt;ShortLinkDO&gt; queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)</span><br><span class="line">            .eq(ShortLinkDO::getGid, requestParam.getGid())</span><br><span class="line">            .eq(ShortLinkDO::getFullShortUrl, createShortLinkDefaultDomain + <span class="string">&quot;/&quot;</span> + shorUri)</span><br><span class="line">            .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>);</span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper);  <span class="comment">// 查数据库看新生成短链是否已存在</span></span><br><span class="line">        <span class="keyword">if</span> (shortLinkDO == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        customGenerateCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shorUri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="优化">优化</h5>
<p>使用三级通道技术</p>
<p>参考京东 <a target="_blank" rel="noopener" href="https://juejin.cn/post/7382344353068974115#heading-12">https://juejin.cn/post/7382344353068974115#heading-12</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortLinkGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY</span> <span class="operator">=</span> <span class="string">&quot;shortlink_counter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BATCH_SIZE</span> <span class="operator">=</span> <span class="number">10000</span>;  <span class="comment">// 每次从内存生成10000个短码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ID_LENGTH</span> <span class="operator">=</span> <span class="number">62</span>;   <span class="comment">// 短码的基数，62进制</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ID_RANGE</span> <span class="operator">=</span> <span class="number">99999</span>;  <span class="comment">// 最大的5位数范围</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALPHABET</span> <span class="operator">=</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis; <span class="comment">// Redis客户端</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger memoryCounter; <span class="comment">// 内存计数器，用于自增</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成短链短码</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateShortLink</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> getNextId();</span><br><span class="line">        <span class="keyword">return</span> idToShortLink(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从内存获取自增ID，如果内存已用完则从Redis取号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getNextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> getFromMemory();</span><br><span class="line">        <span class="keyword">if</span> (id == -<span class="number">1</span>) &#123; <span class="comment">// 如果内存号段用完，去Redis获取</span></span><br><span class="line">            id = getFromRedis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从内存中获取ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getFromMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 使用AtomicInteger来进行自增，确保线程安全</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> memoryCounter.get();</span><br><span class="line">        <span class="keyword">if</span> (current &gt;= BATCH_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// 内存号段用完，返回-1表示需要从Redis获取新的号段</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> memoryCounter.incrementAndGet(); <span class="comment">// 原子性地自增</span></span><br><span class="line">            <span class="keyword">return</span> current + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从Redis中获取自增ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getFromRedis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">newId</span> <span class="operator">=</span> jedis.incrBy(REDIS_KEY, BATCH_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (newId &gt; MAX_ID_RANGE) &#123;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(SHORT_LINK_CREATE_LOCK_KEY);</span><br><span class="line">        	lock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                jedis.set(REDIS_KEY, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="comment">// 重新获取ID</span></span><br><span class="line">                newId = jedis.incr(REDIS_KEY);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 更新内存计数器，保证每次内存自增时，Redis号段被完全消耗前不会重新获取</span></span><br><span class="line">        memoryCounter.set(<span class="number">0</span>); <span class="comment">// 重置内存计数器</span></span><br><span class="line">        <span class="keyword">return</span> newId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将ID转换为62进制短码</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">idToShortLink</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">shortLink</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">while</span> (id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            shortLink.append(ALPHABET.charAt((<span class="type">int</span>) (id % MAX_ID_LENGTH)));</span><br><span class="line">            id /= MAX_ID_LENGTH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shortLink.reverse().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<br>
<br>
<h4 id="短链更新流程">短链更新流程</h4>
<img src="/2025/02/19/Project/E68452CA74D6142357E95AD499697CFB.png" class="" title="E68452CA74D6142357E95AD499697CFB">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateShortLink</span><span class="params">(ShortLinkUpdateReqDTO requestParam)</span> &#123;</span><br><span class="line">    verificationWhitelist(requestParam.getOriginUrl());</span><br><span class="line">    <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(requestParam.getFullShortUrl())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;短链接记录不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LambdaQueryWrapper&lt;ShortLinkDO&gt; queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)</span><br><span class="line">        .eq(ShortLinkDO::getGid, requestParam.getOriginGid())</span><br><span class="line">        .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">        .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">        .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>);</span><br><span class="line">    <span class="type">ShortLinkDO</span> <span class="variable">hasShortLinkDO</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper); <span class="comment">// 更新数据库</span></span><br><span class="line">    <span class="keyword">if</span> (hasShortLinkDO == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;短链接记录不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(hasShortLinkDO.getGid(), requestParam.getGid())) &#123; <span class="comment">// 如果更新前后 gid 相同，即更新不换组，直接更新短链接的属性</span></span><br><span class="line">        LambdaUpdateWrapper&lt;ShortLinkDO&gt; updateWrapper = Wrappers.lambdaUpdate(ShortLinkDO.class) <span class="comment">// 构建更新操作的条件</span></span><br><span class="line">            .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">            .eq(ShortLinkDO::getGid, requestParam.getGid())</span><br><span class="line">            .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">            .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>)</span><br><span class="line">            .set(Objects.equals(requestParam.getValidDateType(), VailDateTypeEnum.PERMANENT.getType()), ShortLinkDO::getValidDate, <span class="literal">null</span>); <span class="comment">// 如果请求参数中的 有效期类型 为 永久，设置DO对象的 有效期 为null</span></span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder() <span class="comment">// 执行更新操作</span></span><br><span class="line">            .domain(hasShortLinkDO.getDomain())</span><br><span class="line">            .shortUri(hasShortLinkDO.getShortUri())</span><br><span class="line">            .favicon(Objects.equals(requestParam.getOriginUrl(), hasShortLinkDO.getOriginUrl()) ? hasShortLinkDO.getFavicon() : getFavicon(requestParam.getOriginUrl())) <span class="comment">// 请求参数中的 长链接 和 当前长链接 是否一致？不一致则更换</span></span><br><span class="line">            .createdType(hasShortLinkDO.getCreatedType())</span><br><span class="line">            .gid(requestParam.getGid())  <span class="comment">// 换组</span></span><br><span class="line">            .originUrl(requestParam.getOriginUrl())  <span class="comment">// 换长链接</span></span><br><span class="line">            .describe(requestParam.getDescribe())   <span class="comment">// 换描述</span></span><br><span class="line">            .validDateType(requestParam.getValidDateType())  <span class="comment">// 换有效类型</span></span><br><span class="line">            .validDate(requestParam.getValidDate())  <span class="comment">// 换有效期</span></span><br><span class="line">            .build();</span><br><span class="line">        baseMapper.update(shortLinkDO, updateWrapper);  <span class="comment">// 使用DO对象对数据库进行更新；更新时包含逻辑：如果请求参数的有效类型为永久，则将有效期置为null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 更新换组</span></span><br><span class="line">        <span class="comment">// 使用 Redisson 分布式读写锁确保并发安全。</span></span><br><span class="line">        <span class="type">RReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(String.format(LOCK_GID_UPDATE_KEY, requestParam.getFullShortUrl()));</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> readWriteLock.writeLock();</span><br><span class="line">        rLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LambdaUpdateWrapper&lt;ShortLinkDO&gt; linkUpdateWrapper = Wrappers.lambdaUpdate(ShortLinkDO.class)</span><br><span class="line">                .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">                .eq(ShortLinkDO::getGid, hasShortLinkDO.getGid())</span><br><span class="line">                .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">                .eq(ShortLinkDO::getDelTime, <span class="number">0L</span>)</span><br><span class="line">                .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>);</span><br><span class="line">            <span class="type">ShortLinkDO</span> <span class="variable">delShortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">                .delTime(System.currentTimeMillis())</span><br><span class="line">                .build();</span><br><span class="line">            delShortLinkDO.setDelFlag(<span class="number">1</span>);</span><br><span class="line">            baseMapper.update(delShortLinkDO, linkUpdateWrapper);</span><br><span class="line">            <span class="comment">// 将旧的短链接标记为已删除。</span></span><br><span class="line">            <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">                .domain(createShortLinkDefaultDomain)</span><br><span class="line">                .originUrl(requestParam.getOriginUrl())</span><br><span class="line">                .gid(requestParam.getGid())</span><br><span class="line">                .createdType(hasShortLinkDO.getCreatedType())</span><br><span class="line">                .validDateType(requestParam.getValidDateType())</span><br><span class="line">                .validDate(requestParam.getValidDate())</span><br><span class="line">                .describe(requestParam.getDescribe())</span><br><span class="line">                .shortUri(hasShortLinkDO.getShortUri())</span><br><span class="line">                .enableStatus(hasShortLinkDO.getEnableStatus())</span><br><span class="line">                .totalPv(hasShortLinkDO.getTotalPv())</span><br><span class="line">                .totalUv(hasShortLinkDO.getTotalUv())</span><br><span class="line">                .totalUip(hasShortLinkDO.getTotalUip())</span><br><span class="line">                .fullShortUrl(hasShortLinkDO.getFullShortUrl())</span><br><span class="line">                .favicon(Objects.equals(requestParam.getOriginUrl(), hasShortLinkDO.getOriginUrl()) ? hasShortLinkDO.getFavicon() : getFavicon(requestParam.getOriginUrl()))</span><br><span class="line">                .delTime(<span class="number">0L</span>)</span><br><span class="line">                .build();</span><br><span class="line">            baseMapper.insert(shortLinkDO);</span><br><span class="line">            <span class="comment">// 创建一个新的短链接记录，并将新的属性设置到新记录中。</span></span><br><span class="line">            LambdaQueryWrapper&lt;ShortLinkGotoDO&gt; linkGotoQueryWrapper = Wrappers.lambdaQuery(ShortLinkGotoDO.class)</span><br><span class="line">                .eq(ShortLinkGotoDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">                .eq(ShortLinkGotoDO::getGid, hasShortLinkDO.getGid());</span><br><span class="line">            <span class="type">ShortLinkGotoDO</span> <span class="variable">shortLinkGotoDO</span> <span class="operator">=</span> shortLinkGotoMapper.selectOne(linkGotoQueryWrapper);</span><br><span class="line">            <span class="comment">// 更新 ShortLinkGotoDO 表中的 gid 信息。</span></span><br><span class="line">            shortLinkGotoMapper.delete(linkGotoQueryWrapper);</span><br><span class="line">            shortLinkGotoDO.setGid(requestParam.getGid());</span><br><span class="line">            shortLinkGotoMapper.insert(shortLinkGotoDO);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果短链接的有效期类型、有效期时间或原始 URL 发生变化，则清除 GOTO_SHORT_LINK_KEY 缓存。</span></span><br><span class="line">    <span class="comment">// 如果旧的短链接已过期，并且更新后的短链接是永久有效或者新的有效期在当前时间之后，则清除 GOTO_IS_NULL_SHORT_LINK_KEY 缓存。</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(hasShortLinkDO.getValidDateType(), requestParam.getValidDateType())</span><br><span class="line">        || !Objects.equals(hasShortLinkDO.getValidDate(), requestParam.getValidDate())</span><br><span class="line">        || !Objects.equals(hasShortLinkDO.getOriginUrl(), requestParam.getOriginUrl())) &#123;</span><br><span class="line">        stringRedisTemplate.delete(String.format(GOTO_SHORT_LINK_KEY, requestParam.getFullShortUrl()));</span><br><span class="line">        <span class="type">Date</span> <span class="variable">currentDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="keyword">if</span> (hasShortLinkDO.getValidDate() != <span class="literal">null</span> &amp;&amp; hasShortLinkDO.getValidDate().before(currentDate)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(requestParam.getValidDateType(), VailDateTypeEnum.PERMANENT.getType()) || requestParam.getValidDate().after(currentDate)) &#123;</span><br><span class="line">                stringRedisTemplate.delete(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, requestParam.getFullShortUrl()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redis 与 数据库 数据一致性</p>
<p><strong>采用方案 2：数据库优先，缓存延迟更新</strong></p>
<p><strong>流程：</strong></p>
<ul>
<li>直接修改数据库中的数据</li>
<li>数据库完成修改后，删除redis中数据----（分界线：此动作前后查询到的数据发生变化）</li>
<li>访问redis发生缺失时，触发miss并查询数据库新数据，然后写入redis</li>
</ul>
<br>
<h4 id="短链解析流程">短链解析流程</h4>
<p>redis_ex - bloomFilter - redis_nx - MySQL</p>
<p>超高并发场景！！！</p>
<img src="/2025/02/19/Project/5CF8B7418CDADCA4998A29C7F084CE08.png" class="" title="5CF8B7418CDADCA4998A29C7F084CE08">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restoreUrl</span><span class="params">(String shortUri, ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serverName</span> <span class="operator">=</span> request.getServerName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">serverPort</span> <span class="operator">=</span> Optional.of(request.getServerPort())</span><br><span class="line">        .filter(each -&gt; !Objects.equals(each, <span class="number">80</span>))</span><br><span class="line">        .map(String::valueOf)</span><br><span class="line">        .map(each -&gt; <span class="string">&quot;:&quot;</span> + each)</span><br><span class="line">        .orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullShortUrl</span> <span class="operator">=</span> serverName + serverPort + <span class="string">&quot;/&quot;</span> + shortUri; <span class="comment">// 从报文中读出短链内容</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">originalLink</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(String.format(GOTO_SHORT_LINK_KEY, fullShortUrl)); <span class="comment">// 从redis获取原始链</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(originalLink)) &#123;</span><br><span class="line">        shortLinkStats(buildLinkStatsRecordAndSetUser(fullShortUrl, request, response)); <span class="comment">// 记录短链接的访问统计信息。</span></span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(originalLink);  <span class="comment">// 使用HttpServletResponse对象将用户重定向到原始链接URL。  `sendRedirect` 方法会设置 HTTP 响应的状态码为 302 (Found) 或 301 (Moved Permanently)，并在响应头中设置 `Location` 字段为目标 URL。</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">contains</span> <span class="operator">=</span> shortUriCreateCachePenetrationBloomFilter.contains(fullShortUrl); <span class="comment">// 布隆判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (!contains) &#123;  <span class="comment">// 短链不存在</span></span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>); <span class="comment">// 将用户重定向到一个 &quot;notfound&quot; 页面，表示该短链接URL无效。</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">gotoIsNullShortLink</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl));  <span class="comment">// 从redis中获取该短链接是否被标记为null。 用于防止缓存击穿。</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(gotoIsNullShortLink)) &#123; <span class="comment">// 如果redis中存在该短链被标记为null。</span></span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>); <span class="comment">// 将用户重定向到一个 &quot;notfound&quot; 页面，表示该短链接URL无效。</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(String.format(LOCK_GOTO_SHORT_LINK_KEY, fullShortUrl));</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 为什么需要做两遍？</span></span><br><span class="line">        <span class="comment">// 假如用户a和用户b均访问短链x，短链仅存在于数据库（redis中不存在，缓存穿透检查不为空）；此时用户a获得锁，并在数据库中查到信息并保存到redis和布隆；用户b获得锁进入，此时redis已包含该链接</span></span><br><span class="line">        originalLink = stringRedisTemplate.opsForValue().get(String.format(GOTO_SHORT_LINK_KEY, fullShortUrl));</span><br><span class="line">        <span class="comment">//   再次尝试从Redis中获取原始链接URL。  这一步是为了防止在获取锁之前，其他线程已经将原始链接URL放入了Redis中。</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(originalLink)) &#123;</span><br><span class="line">            shortLinkStats(buildLinkStatsRecordAndSetUser(fullShortUrl, request, response));</span><br><span class="line">            ((HttpServletResponse) response).sendRedirect(originalLink);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        gotoIsNullShortLink = stringRedisTemplate.opsForValue().get(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl));</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(gotoIsNullShortLink)) &#123;</span><br><span class="line">            ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查表获取短链映射原链</span></span><br><span class="line">        LambdaQueryWrapper&lt;ShortLinkDO&gt; queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)</span><br><span class="line">            .eq(ShortLinkDO::getGid, shortLinkGotoDO.getGid())</span><br><span class="line">            .eq(ShortLinkDO::getFullShortUrl, fullShortUrl)</span><br><span class="line">            .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">            .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>);</span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (shortLinkDO == <span class="literal">null</span> || (shortLinkDO.getValidDate() != <span class="literal">null</span> &amp;&amp; shortLinkDO.getValidDate().before(<span class="keyword">new</span> <span class="title class_">Date</span>()))) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl), <span class="string">&quot;-&quot;</span>, <span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">            <span class="comment">// 将该短链接URL标记为null，并将其存储在Redis中，有效期为30分钟。</span></span><br><span class="line">            ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存短链-原链 到 redis_ex</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set( <span class="comment">// 将原始链接URL存储在Redis中，并设置有效期。</span></span><br><span class="line">            String.format(GOTO_SHORT_LINK_KEY, fullShortUrl),</span><br><span class="line">            shortLinkDO.getOriginUrl(),</span><br><span class="line">            LinkUtil.getLinkCacheValidTime(shortLinkDO.getValidDate()), TimeUnit.MILLISECONDS</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 消息队列更新短链访问信息</span></span><br><span class="line">        shortLinkStats(buildLinkStatsRecordAndSetUser(fullShortUrl, request, response));</span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(shortLinkDO.getOriginUrl());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程</p>
<ul>
<li>
<p>检查redis_ex（内存范围）；存在直接返回，不存在进入下一步；</p>
</li>
<li>
<p>bloom判断短链接是否存在（数据库范围），不存在直接返回，可能存在进入下一步；</p>
</li>
<li>
<p>检查redis_nx，存在直接返回，不存在进入下一步；</p>
</li>
<li>
<p>开启分布式锁</p>
<ul>
<li>
<p>二次检查 redis_ex 和 redis_nx 是否存在</p>
</li>
<li>
<p>查询数据库</p>
<ul>
<li>查询表，若不存在或失效添加 redis_nx，返回；若存在进入下一步</li>
<li>将查询结果加入 redis_ex</li>
</ul>
</li>
<li>
<p>将统计状态信息发送到消息队列</p>
</li>
</ul>
</li>
</ul>
<br>
<p>Redis内容</p>
<ul>
<li>布隆过滤器</li>
<li>redis_nx（key: <code>short-link:is-null:goto_&#123;fullShortUrl&#125;</code>, value: <code>-</code>）</li>
<li>redis_ex（key: <code>short-link:goto:&#123;fullShortUrl&#125;</code>, value: <code>originUrl</code>）</li>
</ul>
<br>
<p>Q: 为什么需要做二次检查？</p>
<p>考虑如下场景：</p>
<p>场景1：生成的短链长时间未被使用（redis_ex内短链映射过期），第一次访问</p>
<p>假如用户a和用户b均访问短链x，短链仅存在于数据库（redis_ex不存在，redis_nx不存在）；此时用户a获得锁，并在数据库中查到信息并保存到redis和BloomFilter；用户b获得锁进入，此时redis已包含该链接，应当直接返回，不再查数据库；</p>
<p>场景2：无效短链，第一次访问</p>
<p>假如用户a和用户b均访问短链x，短链存在于数据库且过期（redis_ex不存在，redis_nx不存在）；此时用户a获得锁，在数据库中不能查到信息，保存到 redis_nx；用户b获得锁进入，此时 redis_nx 已指出该链接无效，应当直接返回，不再查数据库；</p>
<br>
<h4 id="短链状态信息更新流程">短链状态信息更新流程</h4>
<br>
<h4 id="可能场景分析">可能场景分析</h4>
<img src="/2025/02/19/Project/0CE3A54805CB047FA700CFDE30A643BA.png" class="" title="0CE3A54805CB047FA700CFDE30A643BA">
<br>
<h2 id="Feed流">Feed流</h2>
<img src="/2025/02/19/Project/njjbtvfwn2.png" class="" title="img">
<p>读扩散（拉模式）：粉丝去发布者的发件箱拉取内容</p>
<p>写扩散（推模式）：发布者向粉丝的收件箱推送内容</p>
<p>读写混合：如图</p>
<br>
<p>推方法：</p>
<p>发布者 发布内容 保存到mysql + redis</p>
<p>每个用户有一个对应的Redis队列，用于存储他们的动态。我们可以使用Redis的LPUSH（列表操作）命令将新的内容推送到用户的feed流队列。</p>
<p>用户上线后从自己的Redis队列获取 RRANGE 数据</p>
<p>优化</p>
<p>使用Redis Pipeline进行批量写入</p>
<p>将内容推送操作放到后台异步执行，而不是在主线程中同步完成。这可以通过消息队列（如RabbitMQ、Kafka）来实现，后台消费者异步处理推送任务。 采用延迟写入策略。可以设置一个延时队列或者利用Redis的Sorted Set来实现。在新动态发布时，动态内容先进入一个延迟队列，系统定期（例如每分钟）再批量将内容推送到用户的feed流。</p>
<p>实现方式： 使用Redis的ZADD命令将消息按照时间戳存入一个有序集合，然后定期从有序集合中取出并推送。</p>
<br>
<p>发件箱</p>
<p>sender_id, message_id, other</p>
<p>收件箱</p>
<p>(receiver_id, sequence_id,) sender_id, message_id, other</p>
<br>
<h2 id="AI-RAG">AI RAG</h2>
<h3 id="Base">Base</h3>
<p>Meta AI 的研究人员引入了一种叫做检索增强生成（Retrieval Augmented Generation，RAG）的方法来完成这类知识密集型的任务。RAG 把一个信息检索组件和文本生成模型结合在一起。RAG 可以微调，其内部知识的修改方式很高效，不需要对整个模型进行重新训练。</p>
<br>
<p>RAG 会接受输入并检索出一组相关/支撑的文档，并给出文档的来源（例如维基百科）。这些文档作为上下文和输入的原始提示词组合，送给文本生成器得到最终的输出。这样 RAG 更加适应事实会随时间变化的情况。这非常有用，因为 LLM 的参数化知识是静态的。RAG 让语言模型不用重新训练就能够获取最新的信息，基于检索生成产生可靠的输出。</p>
<br>
<p>Lewis 等人（2021）提出一个通用的 RAG 微调方法。这种方法使用预训练的 seq2seq 作为参数记忆，用维基百科的密集向量索引作为非参数记忆（使通过神经网络预训练的检索器访问）</p>
<img src="/2025/02/19/Project/FnuC7iOSLJbLu9apUaP886tm7eGD" class="" title="ai-rag-knowledge-1-01.png">
<p>向量数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;doc123&quot;,               // 唯一标识符</span><br><span class="line">    &quot;embedding&quot;: [0.1, 0.2, ...], // 向量</span><br><span class="line">    &quot;text&quot;: &quot;王大瓜，1990年出生&quot;, // 原始文本</span><br><span class="line">    &quot;metadata&quot;: &#123;                 // 元数据</span><br><span class="line">        &quot;knowledge&quot;: &quot;知识库名称&quot;,</span><br><span class="line">        &quot;timestamp&quot;: &quot;2023-10-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="访问逻辑">访问逻辑</h3>
<p>执行</p>
<ul>
<li>
<p>加载原始文档</p>
</li>
<li>
<p>使用SentenceSplitter分割文档</p>
</li>
<li>
<p>使用embedding模型将文档向量化</p>
</li>
<li>
<p>构建BM25检索和向量检索数据库</p>
</li>
<li>
<p>保存数据库到指定位置</p>
</li>
</ul>
<p>系统内部流程：</p>
<ul>
<li>
<p>先用LLM对问题进行初步回答</p>
</li>
<li>
<p>将问题和初步回答结合作为检索关键词</p>
</li>
<li>
<p>同时使用BM25和向量召回获取相关文档</p>
</li>
<li>
<p>使用重排器对结果排序</p>
</li>
<li>
<p>构造RAG prompt，包含检索到的文档内容、原问题和LLM初步回答</p>
</li>
<li>
<p>再次调用LLM生成最终回答</p>
</li>
</ul>
<br>
<p>数据流转逻辑</p>
<ol>
<li>
<p>构建阶段：</p>
<p>原始文档 -&gt; 句子分割 -&gt; 向量化 -&gt; 构建BM25和向量索引 -&gt; 保存数据库</p>
</li>
<li>
<p>检索阶段：</p>
<p>用户查询 -&gt; LLM初步回答 -&gt; 多路召回(BM25+向量) -&gt; 重排 -&gt; 构造RAG Prompt -&gt; LLM生成最终回答</p>
</li>
</ol>
<br>
<p>系统特点</p>
<p>轻量级：可以使用小型模型运行</p>
<p>模块化：各个组件可以独立替换</p>
<p>多路召回：结合BM25和向量召回，提高召回质量</p>
<p>重排优化：使用专门的重排模型提高相关性</p>
<p>灵活配置：通过配置文件可以调整各个参数</p>
<p>通过这种方式，TinyRAG实现了在有限资源下的高效知识检索和增强生成能力，可以根据用户需求和硬件条件进行定制化配置。</p>
<br>
<br>
<h2 id="弹幕">弹幕</h2>
<p><strong>技术选型分析</strong></p>
<p><strong>实时通信技术</strong></p>
<p>• <strong>WebSocket协议</strong>：作为核心通信协议，实现客户端与服务器的全双工长连接。相比HTTP轮询，WebSocket显著降低延迟（控制在1秒内），满足实时弹幕推送需求。<br>
• <strong>Netty框架</strong>：用于构建高性能网络服务（如弹幕服务器），支持WebSocket协议实现，提供异步事件驱动模型，优化I/O效率。早期架构中，Netty负责维护TCP连接池，处理10万级并发连接。</p>
<p><strong>分布式架构设计</strong></p>
<p>• <strong>模块解耦</strong>：拆分为Comet（长连接管理）、Logic（业务逻辑处理）、Router（会话存储）、Job（消息分发）、Persistence（持久化）等独立模块，通过Kafka消息队列实现松耦合通信。</p>
<p><strong>高并发处理</strong></p>
<p>• <strong>Kafka消息队列</strong>：作为消息中间件，实现水平扩展的发布/订阅模式，支持每秒千万级弹幕分发。Job模块从Kafka消费消息后，并行推送到所有Comet节点。<br>
• <strong>Redis内存数据库</strong>：存储在线用户会话信息（如用户与Comet节点的映射关系），配合BloomFilter实现快速查询。</p>
<p><strong>优化策略</strong></p>
<p>• <strong>内存优化</strong>：采用栈内存分配、内存池技术，单机承载量从25万（2015年）提升至100万（2016年）在线用户；<br>
• <strong>网络优化</strong>：部署多线IDC+专线网络，解决单点带宽瓶颈，降低跨机房延迟；<br>
• <strong>弹幕合并</strong>：高峰期对相似弹幕内容聚合，减少70%以上冗余数据传输。</p>
<hr>
<p><strong>用户使用全流程分析</strong></p>
<p><strong>连接建立阶段</strong></p>
<ol>
<li><strong>客户端初始化</strong>：用户打开视频时，前端通过WebSocket与Comet节点建立长连接；</li>
<li><strong>身份验证</strong>：Logic模块验证用户身份（账号/IP黑名单过滤）；</li>
<li><strong>会话注册</strong>：Router模块记录用户ID与Comet节点映射关系，存入Redis。</li>
</ol>
<p><strong>弹幕发送阶段</strong></p>
<ol>
<li><strong>用户输入</strong>：前端捕获输入内容，附加视频时间戳、用户ID等元数据；</li>
<li><strong>协议封装</strong>：通过WebSocket发送至Comet节点；</li>
<li><strong>逻辑处理</strong>：<br>
• Logic模块进行敏感词过滤、内容审核（集成机器学习模型）；<br>
• 合法消息写入Kafka指定Topic（按视频ID分区）。</li>
</ol>
<p><strong>消息分发阶段</strong></p>
<ol>
<li><strong>Job消费</strong>：多个Job进程并行消费Kafka消息，根据视频ID路由到对应Comet节点集群；</li>
<li><strong>并行推送</strong>：每个Comet节点通过独立通道向客户端推送消息，避免全局锁竞争；</li>
<li><strong>本地缓存</strong>：Comet节点使用内存池管理待发送消息，减少GC停顿。</li>
</ol>
<p><strong>客户端渲染阶段</strong></p>
<ol>
<li><strong>消息接收</strong>：前端WebSocket监听消息，解析弹幕内容、位置、样式属性；</li>
<li><strong>渲染优化</strong>：<br>
• Canvas/WebGL绘制，支持10万+条弹幕同屏渲染；<br>
• 动态密度控制：根据视频分辨率自动调整弹幕显示区域；</li>
<li><strong>交互处理</strong>：用户点赞/举报操作通过REST API反馈至后端，更新Redis计数。</li>
</ol>
<p><strong>核心挑战与解决方案</strong></p>
<ol>
<li><strong>流量瓶颈</strong>：单机带宽极限约3Gbps（2016年数据），通过边缘节点CDN分发弹幕流量；</li>
<li><strong>消息顺序性</strong>：Kafka分区内保序+客户端本地时间戳排序，解决网络抖动导致的乱序问题；</li>
<li><strong>历史弹幕查询</strong>：采用MongoDB分片存储，按视频ID+时间范围建立组合索引，响应时间&lt;50ms。</li>
</ol>
<br>
<br>
<h2 id="场景问题">场景问题</h2>
<img src="/2025/02/19/Project/Camera_XHS_17416135605101040g2sg315pqsv4ohc0g5oun.jpg" class="" title="Camera_XHS_17416135605101040g2sg315pqsv4ohc0g5oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135708561040g2sg315pqsv4ohc2g5oun.jpg" class="" title="Camera_XHS_17416135708561040g2sg315pqsv4ohc2g5oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135670761040g2sg315pqsv4ohc205oun.jpg" class="" title="Camera_XHS_17416135670761040g2sg315pqsv4ohc205oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135625461040g2sg315pqsv4ohc105oun.jpg" class="" title="Camera_XHS_17416135625461040g2sg315pqsv4ohc105oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135646421040g2sg315pqsv4ohc1g5oun.jpg" class="" title="Camera_XHS_17416135646421040g2sg315pqsv4ohc1g5oun">
<br>
<h3 id="热点数据发现与处理">热点数据发现与处理</h3>
<h4 id="场景分析">场景分析</h4>
<p>Redis 使用 ZSet 保存与更新热key，使用 zadd 方法和 zrange方法完成排序队列和获取</p>
<p>场景：</p>
<p><strong>商品访问时更新排名</strong>：</p>
<ul>
<li>使用 <code>ZADD</code> 命令，将商品的最新访问时间作为 <code>score</code> 添加到有序集合中。</li>
<li>如果商品已存在，则更新 <code>score</code>（即访问时间）。</li>
</ul>
<p><strong>获取前 1000 个商品</strong>：</p>
<ul>
<li>使用 <code>ZRANGE</code> 命令，按照 <code>score</code> 降序获取前 1000 个商品 ID。</li>
</ul>
<p><strong>定期清理并补充商品</strong>：</p>
<ul>
<li>使用 <code>ZREMRANGEBYRANK</code> 删除排名最后的 200 个商品。</li>
<li>从数据库中随机获取 200 个商品，并使用 <code>ZADD</code> 加入有序集合。</li>
</ul>
<p><strong>请求到达时获取商品数据</strong>：</p>
<ul>
<li>先用 <code>ZRANK</code> 确定商品是否在前 1000 名中。</li>
<li>如果命中，则从缓存获取商品详细信息，否则从数据库加载。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisZSetExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCT_RANK_KEY</span> <span class="operator">=</span> <span class="string">&quot;hot_products&quot;</span>; <span class="comment">// Redis ZSet key</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TOP_N</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REMOVE_COUNT</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT)) &#123;</span><br><span class="line">            <span class="comment">// 访问商品</span></span><br><span class="line">            accessProduct(jedis, <span class="string">&quot;product_123&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取 Top 1000 商品</span></span><br><span class="line">            Set&lt;String&gt; topProducts = getTopProducts(jedis);</span><br><span class="line">            System.out.println(<span class="string">&quot;Top Products: &quot;</span> + topProducts);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定期清理并补充数据</span></span><br><span class="line">            refreshProductList(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问商品时更新访问时间（作为score）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">accessProduct</span><span class="params">(Jedis jedis, String productId)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// 以当前时间戳作为score</span></span><br><span class="line">        jedis.zadd(PRODUCT_RANK_KEY, currentTime, productId);</span><br><span class="line">        <span class="comment">// zadd往有序集合key中加入带分值元素,若元素已存在，则覆盖其原有分值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Updated access time for product: &quot;</span> + productId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 Top 1000 商品</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">getTopProducts</span><span class="params">(Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jedis.zrevrange(PRODUCT_RANK_KEY, <span class="number">0</span>, TOP_N - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// zrevrange倒序获取有序集合key从start下标到stop下标的元素</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定期清理并补充商品数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">refreshProductList</span><span class="params">(Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">totalSize</span> <span class="operator">=</span> jedis.zcard(PRODUCT_RANK_KEY); <span class="comment">// zcard返回有序集合key中元素个数</span></span><br><span class="line">        <span class="keyword">if</span> (totalSize &gt; TOP_N) &#123;</span><br><span class="line">            <span class="comment">// 删除排名靠后的 200 个商品</span></span><br><span class="line">            jedis.zremrangeByRank(PRODUCT_RANK_KEY, <span class="number">0</span>, REMOVE_COUNT - <span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Removed least accessed products.&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 从数据库中随机获取 200 个商品（模拟）</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; REMOVE_COUNT; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">newProduct</span> <span class="operator">=</span> <span class="string">&quot;random_product_&quot;</span> + i;</span><br><span class="line">                <span class="type">double</span> <span class="variable">timeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                jedis.zadd(PRODUCT_RANK_KEY, timeStamp, newProduct);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Added 200 random products from DB.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>访问商品时更新 score</strong></p>
<ul>
<li>访问商品时，调用 <code>zadd</code> 方法，将当前时间戳作为 <code>score</code>，实现越新访问的商品排名越靠前。</li>
</ul>
<p><strong>获取前 1000 个商品</strong></p>
<ul>
<li><code>zrevrange(PRODUCT_RANK_KEY, 0, 999)</code> 获取排名靠前的 1000 个商品。</li>
</ul>
<p><strong>定期清理并补充</strong></p>
<ul>
<li><code>zremrangeByRank(PRODUCT_RANK_KEY, 0, 199)</code> 删除排名最末的 200 个商品。</li>
<li>随机从数据库选 200 个商品，使用 <code>zadd</code> 加入 Redis。</li>
</ul>
<p><strong>查询商品是否命中</strong></p>
<ul>
<li><code>zrank(PRODUCT_RANK_KEY, productId)</code> 确定是否在前 1000 名中。</li>
<li>命中则从缓存获取商品详情，否则从数据库加载。</li>
</ul>
<br>
<p>考虑Redis中热点数据自动续期</p>
<p>使用 Lua 脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> value = redis.call(<span class="string">&#x27;GET&#x27;</span>, key)</span><br><span class="line"><span class="keyword">if</span> value <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, key, ttl)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>
<br>
<h4 id="热点数据发现">热点数据发现</h4>
<ol>
<li>经验评估</li>
</ol>
<p>对于特定业务场景，我们可以预先评估哪些数据可能成为热点数据，例如秒杀商品、热门商品、大 V 的动态内容等等。</p>
<p>这种方案的优点是实施成本较低，但是由于是基于经验而非实际数据，因此最终的结果可能与实际情况有所偏差。</p>
<ol start="2">
<li>使用 hotkey 命令</li>
</ol>
<p>Redis 从版本 4.0 开始引入了 <code>hotkey</code> 命令，允许通过客户端的 <code>redis-cli --hotkeys</code> 命令扫描库中的所有热点 Key。</p>
<p>这种方案的优点是无需引入其他配置或组件，但缺点是性能较差，尤其在处理大量数据时可能会非常耗时。</p>
<ol start="3">
<li>使用 monitor 命令</li>
</ol>
<p>当通过 <code>MONITOR</code> 命令开启监视器后，Redis 将在执行命令后输出一些相关的信息。结合日志和相关分析工具（如 <code>redis-faina</code>）就可以对其进行统计。</p>
<p>这种方案的缺点在于，开启监控会显著降低 Redis 性能（单个实例会降低差不多 50% 的性能），如果 Redis 实例本身已经承受较大负荷，启用此功能可能会雪上加霜。</p>
<blockquote>
<p>具体参见：<a target="_blank" rel="noopener" href="https://redis.io/commands/monitor/">Redis 官网监控 sourl.cn/pDDVv4</a></p>
</blockquote>
<ol start="4">
<li>客户端监控</li>
</ol>
<p>通常情况下，我们会使用客户端（如 Jedis 或 Lettuce）来与 Redis 进行通信。因此，通过在代码中添加一层代理，或使用字节码插桩的方式，我们可以在程序实际请求 Redis 之前上报请求内容，然后通过第三方组件或平台进行分析，以确定哪些 Key 是热 Key。</p>
<p>这种方法的优点在于实施门槛较低，并且由于可以直接在代码里面修改，所以比较灵活。缺点在于二次开发也需要成本，而且在不同的系统中可能无法复用。</p>
<p>当然，目前市场上也有一些带客户端的一站式开源解决方案，比如京东的 <strong>Gitee/hotkey</strong>，也很好地解决了热 Key 问题。</p>
<ol start="5">
<li>代理层监控</li>
</ol>
<p>对于大规模的 Redis 集群（例如各大云商提供的 Redis 服务）的请求通常会经过代理或网关层进行转发。因此，如果代理层可以收集请求信息并上报，那就可以通过分析相关请求信息来确认热 Key。</p>
<p>这种方法与客户端监控相似，但适用范围更广，缺点是引入额外的代理层会增加运维成本，而不是所有集群都支持这种方式。</p>
<blockquote>
<p>此处推荐阅读一下得物技术团队的文章：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7202531472720756791">得物热点探测设计与实践</a></p>
</blockquote>
<ol start="6">
<li>服务端监控</li>
</ol>
<p>除了上述方法，还可以尝试在服务端监听端口以抓包分析请求，或直接修改 Redis 源码添加上报功能。这种方法类似于代理层监控，但最大的问题是实施成本较高。</p>
<p>ref: <a target="_blank" rel="noopener" href="https://open8gu.com/cache/big-hot-key/gcgigmnixrmu640t/">https://open8gu.com/cache/big-hot-key/gcgigmnixrmu640t/</a></p>
<br>
<h4 id="方案">方案</h4>
<p><strong>数据分片</strong></p>
<p>数据分片是通过将热点数据分散存储在多个Redis节点上，避免单个节点负载过高，是解决热点Key问题最常用的策略。</p>
<p>例如，在Redis Cluster模式下，数据自动按槽位分布在多个节点上，从而实现负载均衡。对于非Cluster模式，可以通过客户端或代理层实现一致性哈希等分片算法，将数据分布在多个Redis实例上。</p>
<br>
<p><strong>读写分离</strong></p>
<p>读写分离可以将读操作与写操作分开处理，降低单个节点的负载。在主从复制模式下，可以将读操作分发到从节点上，从而分担主节点的压力。此外，可以使用代理层如Redis Sentinel或Twemproxy实现自动故障转移和读写分离。</p>
<br>
<p><strong>多级缓存</strong></p>
<p>对于一些热 Key，我们可以考虑使用一些本地缓存工具（比如 Guava 或 Ehcache） 直接将其缓存到 JVM 内存中，从根本上避免对 Redis 造成压力。</p>
<p>不过，这种方案下缓存会占用额外的运行时内存，因此需要有选择进行缓存，以避免占用过多内存资源。并且当与 Redis 缓存共用时，也要考虑数据一致性问题。</p>
<br>
<p><strong>限流与熔断降级</strong></p>
<p>限流是通过控制请求的速率来防止系统过载。在应用层实现限流，可以有效减轻热点Key对Redis的压力。常见的限流算法有漏桶算法和令牌桶算法。</p>
<p>熔断降级是在系统出现问题时，自动降低系统功能的一种策略。在应用层实现熔断降级，可以在Redis出现热点Key问题时，快速降低对Redis的访问压力。熔断降级可以通过开源工具如Hystrix实现。</p>
<p>通过上述策略，可以有效解决Redis的热点Key问题。然而，在实际应用中，需要根据具体业务场景和需求选择合适的策略。接下来，我们将通过实践案例来说明如何解决热点Key问题。</p>
<br>
<br>
<h3 id="冷热数据分离">冷热数据分离</h3>
<p>四级缓存</p>
<p>guava</p>
<p>redis</p>
<p>MySQL</p>
<p>Hadoop</p>
<br>
<h3 id="多级缓存">多级缓存</h3>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8a949368c524bed93123c832290610b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1244&amp;h=617&amp;s=43089&amp;e=png&amp;b=ffffff" alt="image.png"></p>
<p>Nginx静态缓存 + 进程内缓存 + redis缓存 + MySQL缓存</p>
<br>
<p>本地缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 Caffeine 缓存实例</span></span><br><span class="line">Cache&lt;String, String&gt; caffeineCache = Caffeine.newBuilder()</span><br><span class="line"><span class="comment">// 设置缓存项在 5s 后开始自动更新</span></span><br><span class="line">.refreshAfterWrite(<span class="number">5</span>, TimeUnit.SECONDS)</span><br><span class="line"><span class="comment">// 自定义缓存更新逻辑（即获取新值逻辑）</span></span><br><span class="line">.build(<span class="keyword">new</span> <span class="title class_">CacheLoader</span>&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reload</span><span class="params">(String key, String oldValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 模拟更新缓存的操作</span></span><br><span class="line">        updateCache(key, oldValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<br>
<p>本地缓存一致性方案：</p>
<p>MQ</p>
<img src="/2025/02/19/Project/v2-788007b6d898a775abd4889d22892a3d_1440w.jpg" class="" title="img">
<p>Canal + MQ</p>
<img src="/2025/02/19/Project/v2-41835bffd6cf315cffaf8c4e52a94496_1440w.jpg" class="" title="img">
<br>
<br>
<h3 id="分库分表">分库分表</h3>
<p>使用 ShardingSphere</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="attr">t_link:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_0.t_link_$&#123;0..15&#125;</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">gid</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">link_table_hash_mod</span></span><br><span class="line">      <span class="attr">t_link_goto:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_0.t_link_goto_$&#123;0..15&#125;</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">full_short_url</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">link_goto_table_hash_mod</span></span><br><span class="line">      <span class="attr">t_group:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_0.t_group_$&#123;0..15&#125;</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">username</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">group_table_hash_mod</span></span><br><span class="line">    <span class="attr">shardingAlgorithms:</span></span><br><span class="line">      <span class="attr">link_table_hash_mod:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">sharding-count:</span> <span class="number">16</span></span><br><span class="line">      <span class="attr">link_goto_table_hash_mod:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">sharding-count:</span> <span class="number">16</span></span><br><span class="line">      <span class="attr">group_table_hash_mod:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">sharding-count:</span> <span class="number">16</span></span><br><span class="line"> <span class="bullet">-</span> <span class="type">!ENCRYPT</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="attr">t_user:</span></span><br><span class="line">        <span class="attr">columns:</span></span><br><span class="line">          <span class="attr">phone:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">phone</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">          <span class="attr">mail:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">mail</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">        <span class="attr">queryWithCipherColumn:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">encryptors:</span></span><br><span class="line">      <span class="attr">common_encryptor:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">AES</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">aes-key-value:</span> <span class="string">d6oadClrrb9A3GWo</span></span><br></pre></td></tr></table></figure>
<p><strong>分片：</strong></p>
<p>这个配置文件的作用是将三个表 (t_link, t_link_goto, t_group) 通过哈希取模的方式，各自拆分成 16 个分片，并将这些分片存储在 ds_0 数据源中。每个表的分片键分别是 gid, full_short_url 和 username。 HASH_MOD 算法会计算分片键的哈希值，然后对 16 取模，根据结果将数据路由到对应的分片表。</p>
<p>例如，对于 t_link 表，如果 gid 的哈希值对 16 取模的结果为 5，那么该条数据将被存储到 ds_0.t_link_5 表中。 其他两个表的分片过程类似，只是分片键不同。</p>
<p><strong>加密：</strong> t_user 表的 phone 和 mail 列使用 AES 算法进行加密。加密后的数据直接存储在原列中。queryWithCipherColumn: true 确保在查询 phone 和 mail 列时，查询条件会被自动加密，然后对密文列进行查询。</p>
<br>
<p><strong>分库分表产生的额外表</strong></p>
<p>在分库分表中，假如是通过用户名进行分片的，如果在查询用户信息时不带用户名，将会触发读扩散问题。</p>
<p>由于登录时没有带用户名，导致无法确定用户的分片键，使得系统无法直接锁定用户的数据位于哪个数据库或者哪张表中。为了找到用户的数据，只能对全部的数据库和表进行扫描查询，这就造成了所谓的“读请求扩散”问题。</p>
<p>也就是说，原本读请求可以直接定位到某个数据库某张表，现在却要多处查询，无疑大大增加了系统的查询负载。</p>
<p>一旦出现了读请求扩散问题，势必会导致用户的登录请求响应时间变长，严重的话还可能造成登录超时</p>
<br>
<h2 id="SSO">SSO</h2>
<img src="/2025/02/19/Project/cas-1741240463041.png" class="" title="img">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/02/03/QuestionBank/" rel="prev" title="QuestionBank">
      <i class="fa fa-chevron-left"></i> QuestionBank
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/02/19/Computer-Network/" rel="next" title="Computer-Network">
      Computer-Network <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-text">Project</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#E-Shop"><span class="nav-text">E-Shop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="nav-text">责任链模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E5%9C%BA%E6%99%AF"><span class="nav-text">秒杀场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShortLink"><span class="nav-text">ShortLink</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E8%BF%94%E5%9B%9E"><span class="nav-text">后端敏感信息返回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E4%BC%9A%E8%AF%9D%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BF%9D%E5%AD%98"><span class="nav-text">用户会话上下文保存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-text">流量控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E8%AF%AF%E5%88%A4"><span class="nav-text">布隆过滤器的使用与误判</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%AD%E9%93%BE%E4%BF%A1%E6%81%AF%E7%BB%9F%E8%AE%A1"><span class="nav-text">短链信息统计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%98%B2%E6%8A%A4"><span class="nav-text">缓存击穿防护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%98%B2%E6%8A%A4"><span class="nav-text">缓存穿透防护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">消息队列更新数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9F%AD%E9%93%BE%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B"><span class="nav-text">短链生成流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-text">优化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9F%AD%E9%93%BE%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="nav-text">短链更新流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9F%AD%E9%93%BE%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="nav-text">短链解析流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9F%AD%E9%93%BE%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="nav-text">短链状态信息更新流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%83%BD%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="nav-text">可能场景分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feed%E6%B5%81"><span class="nav-text">Feed流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-RAG"><span class="nav-text">AI RAG</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Base"><span class="nav-text">Base</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E9%80%BB%E8%BE%91"><span class="nav-text">访问逻辑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B9%E5%B9%95"><span class="nav-text">弹幕</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E9%97%AE%E9%A2%98"><span class="nav-text">场景问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E6%95%B0%E6%8D%AE%E5%8F%91%E7%8E%B0%E4%B8%8E%E5%A4%84%E7%90%86"><span class="nav-text">热点数据发现与处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="nav-text">场景分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E6%95%B0%E6%8D%AE%E5%8F%91%E7%8E%B0"><span class="nav-text">热点数据发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%88"><span class="nav-text">方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%B7%E7%83%AD%E6%95%B0%E6%8D%AE%E5%88%86%E7%A6%BB"><span class="nav-text">冷热数据分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-text">多级缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="nav-text">分库分表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSO"><span class="nav-text">SSO</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="marigo1d"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">marigo1d</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/marigo1d" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;marigo1d" rel="noopener" target="_blank">GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">marigo1d</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">525k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">15:54</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
