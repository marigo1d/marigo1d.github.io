<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>AI-Agent</title>
    <url>/2025/04/21/AI-Agent/</url>
    <content><![CDATA[<p>AI-Agentè®¾è®¡ç›¸å…³</p>
<p>æ–½å·¥ä¸­â€¦</p>
<span id="more"></span>
<h1>AI-Agent</h1>
<img src="/2025/04/21/AI-Agent/Gu-NqzLb0AAG0lX" class="" title="Agent_workflow">
<p>AI-Agentä¾§åŒºåˆ†</p>
<ul>
<li>LLMéƒ¨åˆ†ï¼ŒåŒ…å«å¯¹åŸºåº§LLMçš„ç‰¹åŒ–ï¼Œå¦‚SFTå’ŒRLHF</li>
<li>Agentéƒ¨åˆ†ï¼ŒåŒ…å«æ‰§è¡Œé“¾ï¼Œå¦‚ä¸Šä¸‹æ–‡ç®¡ç†ï¼ŒMCPï¼ˆå·¥å…·ç®¡ç†ä¸ä½¿ç”¨ï¼‰</li>
<li>æ•°æ®éƒ¨åˆ†ï¼ŒåŒ…å«è®­ç»ƒæ•°æ®å’Œæ£€ç´¢æ•°æ®ï¼Œå¦‚RAGæ£€ç´¢æ•°æ®ï¼ŒSFTè®­ç»ƒæ•°æ®ï¼ŒFAISSåº“</li>
</ul>
<blockquote>
<p>LLMéƒ¨åˆ†è¯¦è§ LLM&amp;Rela</p>
</blockquote>
<br>
<h2 id="LangChain">LangChain</h2>
<p>LangChain æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç”±è¯­è¨€æ¨¡å‹é©±åŠ¨çš„åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚å®ƒçš„ç›®æ ‡æ˜¯è®© LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰èƒ½å¤Ÿè®¿é—®å¤–éƒ¨æ•°æ®æºã€æ‰§è¡Œå¤æ‚ä»»åŠ¡é“¾å¼é€»è¾‘ï¼Œå¹¶å…·å¤‡å†³ç­–èƒ½åŠ›ã€‚LangChain æ”¯æŒå¤šç§æ¨¡å—ç»„åˆï¼Œå¦‚æç¤ºæ¨¡æ¿ã€ä¸Šä¸‹æ–‡ç®¡ç†ã€é“¾å¼è°ƒç”¨ã€æ–‡æ¡£é—®ç­”ã€ä»£ç†ç­‰ã€‚</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.langchain.com/">https://docs.langchain.com/</a></p>
</blockquote>
<br>
<h3 id="Model">Model</h3>
<h4 id="Key-methods">Key methods</h4>
<ol>
<li>invokeï¼šä¸èŠå¤©æ¨¡å‹äº¤äº’çš„ä¸»è¦æ–¹æ³•ã€‚å®ƒæ¥å—ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å‡ºã€‚</li>
<li>streamï¼šå…è®¸æ‚¨ä»¥æµçš„å½¢å¼æ¥æ”¶èŠå¤©æ¨¡å‹ç”Ÿæˆçš„è¾“å‡ºçš„æ–¹æ³•ã€‚</li>
<li>batchï¼šå…è®¸æ‚¨å°†å¤šä¸ªè¯·æ±‚æ‰¹é‡å‘é€åˆ°èŠå¤©æ¨¡å‹ï¼Œä»¥æé«˜å¤„ç†æ•ˆç‡çš„æ–¹æ³•ã€‚</li>
<li>bind_toolsï¼šä¸€ç§å…è®¸æ‚¨å°†å·¥å…·ç»‘å®šåˆ°èŠå¤©æ¨¡å‹ï¼Œä»¥ä¾¿åœ¨æ¨¡å‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨çš„æ–¹æ³•ã€‚</li>
<li>with_structured_outputï¼šé’ˆå¯¹åŸç”Ÿæ”¯æŒç»“æ„åŒ–è¾“å‡ºçš„æ¨¡å‹çš„ <code>invoke</code> æ–¹æ³•çš„åŒ…è£…å™¨ã€‚</li>
</ol>
<br>
<h4 id="Tool-calling">Tool calling</h4>
<img src="/2025/04/21/AI-Agent/tool_calling_components-bef9d2bcb9d3706c2fe58b57bf8ccb60.png" class="" title="Conceptual parts of tool calling">
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Tool creation</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> tool</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Multiply a and b.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Tool binding</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Multiply a and b.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        a: first int</span></span><br><span class="line"><span class="string">        b: second int</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line">llm_with_tools = tool_calling_model.bind_tools([multiply])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tool calls</span></span><br><span class="line">query = <span class="string">&quot;What is 3 * 12? Also, what is 11 + 49?&quot;</span></span><br><span class="line"></span><br><span class="line">llm_with_tools.invoke(query).tool_calls</span><br></pre></td></tr></table></figure>
<br>
<h4 id="Structured-Output">Structured Output</h4>
<img src="/2025/04/21/AI-Agent/structured_output-2c42953cee807dedd6e96f3e1db17f69.png" class="" title="Structured output">
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define schema</span></span><br><span class="line">schema = &#123;<span class="string">&quot;foo&quot;</span>: <span class="string">&quot;bar&quot;</span>&#125;</span><br><span class="line"><span class="comment"># Bind schema to model</span></span><br><span class="line">model_with_structure = model.with_structured_output(schema)</span><br><span class="line"><span class="comment"># Invoke the model to produce structured output that matches the schema</span></span><br><span class="line">structured_output = model_with_structure.invoke(user_input)</span><br></pre></td></tr></table></figure>
<br>
<h4 id="Multimodality">Multimodality</h4>
<p>å¤šæ¨¡æ€æŒ‡çš„æ˜¯å¤„ç†ä¸åŒå½¢å¼æ•°æ®çš„èƒ½åŠ›ï¼Œä¾‹å¦‚æ–‡æœ¬ã€éŸ³é¢‘ã€å›¾åƒå’Œè§†é¢‘ã€‚å¤šæ¨¡æ€å¯ä»¥å‡ºç°åœ¨å„ç§ç»„ä»¶ä¸­ï¼Œä½¿æ¨¡å‹å’Œç³»ç»Ÿèƒ½å¤Ÿæ— ç¼åœ°å¤„ç†è¿™äº›æ•°æ®ç±»å‹çš„æ··åˆã€‚</p>
<ul>
<li>èŠå¤©æ¨¡å‹ï¼šç†è®ºä¸Šï¼Œè¿™äº›æ¨¡å‹å¯ä»¥æ¥å—å’Œç”Ÿæˆå¤šæ¨¡æ€è¾“å…¥å’Œè¾“å‡ºï¼Œå¤„ç†å„ç§æ•°æ®ç±»å‹ï¼Œå¦‚æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘å’Œè§†é¢‘ã€‚</li>
<li>åµŒå…¥æ¨¡å‹ï¼šåµŒå…¥æ¨¡å‹å¯ä»¥è¡¨ç¤ºå¤šæ¨¡æ€å†…å®¹ï¼Œå°†å„ç§å½¢å¼çš„æ•°æ®ï¼ˆå¦‚æ–‡æœ¬ã€å›¾åƒå’ŒéŸ³é¢‘ï¼‰åµŒå…¥åˆ°å‘é‡ç©ºé—´ä¸­ã€‚</li>
<li>å‘é‡å­˜å‚¨ï¼šå‘é‡å­˜å‚¨å¯ä»¥æœç´¢è¡¨ç¤ºå¤šæ¨¡æ€æ•°æ®çš„åµŒå…¥ï¼Œå®ç°ä¸åŒç±»å‹ä¿¡æ¯çš„æ£€ç´¢ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line"></span><br><span class="line">message = HumanMessage(</span><br><span class="line">    content=[</span><br><span class="line">        &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Describe the weather in this image:&quot;</span>&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;image&quot;</span>,</span><br><span class="line">            <span class="string">&quot;source_type&quot;</span>: <span class="string">&quot;base64&quot;</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&lt;base64 string&gt;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mime_type&quot;</span>: <span class="string">&quot;image/jpeg&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">)</span><br><span class="line">response = model.invoke([message])</span><br><span class="line"></span><br><span class="line">message = HumanMessage(</span><br><span class="line">    content=[</span><br><span class="line">        &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Describe the weather in this image:&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;image_url&quot;</span>, <span class="string">&quot;image_url&quot;</span>: &#123;<span class="string">&quot;url&quot;</span>: image_url&#125;&#125;,</span><br><span class="line">    ],</span><br><span class="line">)</span><br><span class="line">response = model.invoke([message])</span><br></pre></td></tr></table></figure>
<br>
<h4 id="Memory">Memory</h4>
<img src="/2025/04/21/AI-Agent/short-vs-long.png" class="" title="img">
<h5 id="çŸ­æœŸè®°å¿†">çŸ­æœŸè®°å¿†</h5>
<p>ä¼šè¯å†å²ç®¡ç†</p>
<h6 id="ç¼–è¾‘æ¶ˆæ¯åˆ—è¡¨">ç¼–è¾‘æ¶ˆæ¯åˆ—è¡¨</h6>
<p>èŠå¤©æ¨¡å‹é€šè¿‡æ¶ˆæ¯æ¥å—ä¸Šä¸‹æ–‡ï¼Œè¿™äº›æ¶ˆæ¯åŒ…æ‹¬å¼€å‘è€…æä¾›çš„æŒ‡ä»¤ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰å’Œç”¨æˆ·è¾“å…¥ï¼ˆäººç±»æ¶ˆæ¯ï¼‰ã€‚åœ¨èŠå¤©åº”ç”¨ä¸­ï¼Œæ¶ˆæ¯åœ¨äººç±»è¾“å…¥å’Œæ¨¡å‹å“åº”ä¹‹é—´äº¤æ›¿ï¼Œå¯¼è‡´æ¶ˆæ¯åˆ—è¡¨éšç€æ—¶é—´çš„æ¨ç§»è€Œå˜é•¿ã€‚ç”±äºä¸Šä¸‹æ–‡çª—å£æœ‰é™ä¸”å¯Œæ ‡è®°çš„æ¶ˆæ¯åˆ—è¡¨å¯èƒ½æˆæœ¬é«˜æ˜‚ï¼Œè®¸å¤šåº”ç”¨å¯ä»¥ä»ä½¿ç”¨æ‰‹åŠ¨åˆ é™¤æˆ–å¿˜è®°è¿‡æ—¶ä¿¡æ¯çš„æŠ€æœ¯ä¸­å—ç›Šã€‚</p>
<img src="/2025/04/21/AI-Agent/filter.png" class="" title="img">
<p>æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ä»åˆ—è¡¨ä¸­åˆ é™¤æ—§æ¶ˆæ¯ï¼ˆç±»ä¼¼äºæœ€è¿‘æœ€å°‘ä½¿ç”¨ç¼“å­˜ï¼‰</p>
<br>
<h6 id="æ€»ç»“è¿‡å¾€å¯¹è¯">æ€»ç»“è¿‡å¾€å¯¹è¯</h6>
<p>é—®é¢˜åœ¨äºä¿®å‰ªæˆ–åˆ é™¤æ¶ˆæ¯ï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä»æ¶ˆæ¯é˜Ÿåˆ—çš„ç­›é€‰ä¸­ä¸¢å¤±ä¿¡æ¯ã€‚å› æ­¤ï¼Œä¸€äº›åº”ç”¨ç¨‹åºä»ä½¿ç”¨èŠå¤©æ¨¡å‹å¯¹æ¶ˆæ¯å†å²è¿›è¡Œæ›´å¤æ‚çš„æ€»ç»“æ–¹æ³•ä¸­å—ç›Šã€‚</p>
<img src="/2025/04/21/AI-Agent/summary.png" class="" title="img">
<br>
<h5 id="é•¿æœŸè®°å¿†">é•¿æœŸè®°å¿†</h5>
<h6 id="è®°å¿†å­˜å‚¨">è®°å¿†å­˜å‚¨</h6>
<p>é€šè¿‡{ï¼ˆç”¨æˆ·åï¼Œä¸Šä¸‹æ–‡ï¼‰ï¼šè®°å¿†}ä¿å­˜</p>
<br>
<h6 id="é•¿æœŸè®°å¿†æ€è€ƒæ¡†æ¶">é•¿æœŸè®°å¿†æ€è€ƒæ¡†æ¶</h6>
<br>
<h5 id="è®°å¿†ç±»å‹">è®°å¿†ç±»å‹</h5>
<ul>
<li>
<p>Semantic Memoryï¼š</p>
<p>è¯­ä¹‰è®°å¿†é€šå¸¸ç”¨äºé€šè¿‡è®°ä½è¿‡å»äº¤äº’ä¸­çš„äº‹å®æˆ–æ¦‚å¿µæ¥ä¸ªæ€§åŒ–åº”ç”¨ç¨‹åºã€‚ä¸ªæ€§åŒ–çš„è®°å¿†</p>
<p>ä¾‹å¦‚ä¸ªäººèµ„æ–™å’Œæ”¶è—</p>
</li>
<li>
<p>Episodic Memoryï¼š</p>
<p>æƒ…æ™¯è®°å¿†é€šå¸¸ç”¨äºå¸®åŠ©ä»£ç†è®°ä½å¦‚ä½•å®Œæˆä»»åŠ¡ã€‚</p>
</li>
<li>
<p>Procedural Memoryï¼š</p>
<p>ç¨‹åºæ€§è®°å¿†æ˜¯æ¨¡å‹æƒé‡ã€ä»£ç†ä»£ç å’Œä»£ç†æç¤ºçš„ç»„åˆï¼›</p>
<p>ä¸€èˆ¬ä»…ä¿®æ”¹ç³»ç»Ÿæç¤º</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹å‡½æ•°ï¼Œè¯¥å‡½æ•°ä½¿ç”¨å­˜å‚¨ä¸­çš„æŒ‡ä»¤æ¥è°ƒç”¨æ¨¡å‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_model</span>(<span class="params">state: State, store: BaseStore</span>):</span><br><span class="line">    <span class="comment"># å®šä¹‰å‘½åç©ºé—´ï¼Œè¿™é‡Œä½¿ç”¨&quot;agent_instructions&quot;ä½œä¸ºå‘½åç©ºé—´</span></span><br><span class="line">    namespace = (<span class="string">&quot;agent_instructions&quot;</span>, )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»å­˜å‚¨ä¸­è·å–é”®ä¸º&quot;agent_a&quot;çš„æŒ‡ä»¤æ•°æ®</span></span><br><span class="line">    <span class="comment"># [0]è¡¨ç¤ºè·å–æœç´¢ç»“æœçš„ç¬¬ä¸€é¡¹(å‡è®¾searchè¿”å›åˆ—è¡¨)</span></span><br><span class="line">    instructions = store.get(namespace, key=<span class="string">&quot;agent_a&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åº”ç”¨é€»è¾‘ï¼šä½¿ç”¨è·å–çš„æŒ‡ä»¤æ„å»ºæç¤ºè¯</span></span><br><span class="line">    <span class="comment"># prompt_templateæ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¨¡æ¿ï¼ŒåŒ…å«&#123;instructions&#125;å ä½ç¬¦</span></span><br><span class="line">    prompt = prompt_template.<span class="built_in">format</span>(instructions=instructions.value[<span class="string">&quot;instructions&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿™é‡Œåº”è¯¥æœ‰è°ƒç”¨æ¨¡å‹ç­‰åç»­æ“ä½œ...</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹å‡½æ•°ï¼Œè¯¥å‡½æ•°æ›´æ–°å­˜å‚¨ä¸­çš„æŒ‡ä»¤</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_instructions</span>(<span class="params">state: State, store: BaseStore</span>):</span><br><span class="line">    <span class="comment"># å®šä¹‰å‘½åç©ºé—´ï¼Œè¿™é‡Œä½¿ç”¨&quot;instructions&quot;ä½œä¸ºå‘½åç©ºé—´</span></span><br><span class="line">    namespace = (<span class="string">&quot;instructions&quot;</span>,)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æœç´¢å½“å‰å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œå¹¶è·å–ç¬¬ä¸€ä¸ªç»“æœ</span></span><br><span class="line">    current_instructions = store.search(namespace)[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®°å¿†é€»è¾‘ï¼šä½¿ç”¨å½“å‰æŒ‡ä»¤å’Œå¯¹è¯çŠ¶æ€æ„å»ºæç¤ºè¯</span></span><br><span class="line">    prompt = prompt_template.<span class="built_in">format</span>(</span><br><span class="line">        instructions=instructions.value[<span class="string">&quot;instructions&quot;</span>], </span><br><span class="line">        conversation=state[<span class="string">&quot;messages&quot;</span>]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è°ƒç”¨è¯­è¨€æ¨¡å‹è·å–è¾“å‡º</span></span><br><span class="line">    output = llm.invoke(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»æ¨¡å‹è¾“å‡ºä¸­æå–æ–°çš„æŒ‡ä»¤</span></span><br><span class="line">    new_instructions = output[<span class="string">&#x27;new_instructions&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°†æ–°æŒ‡ä»¤å­˜å‚¨åˆ°&quot;agent_instructions&quot;å‘½åç©ºé—´ä¸‹ï¼Œé”®ä¸º&quot;agent_a&quot;</span></span><br><span class="line">    store.put(</span><br><span class="line">        (<span class="string">&quot;agent_instructions&quot;</span>,),  <span class="comment"># å‘½åç©ºé—´</span></span><br><span class="line">        <span class="string">&quot;agent_a&quot;</span>,                <span class="comment"># é”®å</span></span><br><span class="line">        &#123;<span class="string">&quot;instructions&quot;</span>: new_instructions&#125;  <span class="comment"># å€¼(æ–°æŒ‡ä»¤)</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿™é‡Œå¯èƒ½æœ‰å…¶ä»–åç»­æ“ä½œ...</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<br>
<h5 id="è®°å¿†å†™å…¥">è®°å¿†å†™å…¥</h5>
<ul>
<li>
<p>çƒ­å†™å…¥</p>
</li>
<li>
<p>åå°å†™å…¥</p>
</li>
</ul>
<br>
<h4 id="Caching">Caching</h4>
<p>ä¸€ç§æ›¿ä»£æ–¹æ³•æ˜¯ä½¿ç”¨è¯­ä¹‰ç¼“å­˜ï¼Œå³æ ¹æ®è¾“å…¥çš„æ„ä¹‰è€Œä¸æ˜¯ç²¾ç¡®è¾“å…¥æœ¬èº«æ¥ç¼“å­˜å“åº”ã€‚åœ¨æŸäº›æƒ…å†µä¸‹è¿™å¯èƒ½æœ‰æ•ˆï¼Œä½†åœ¨å…¶ä»–æƒ…å†µä¸‹åˆ™ä¸ç„¶ã€‚</p>
<p>è¯­ä¹‰ç¼“å­˜å¼•å…¥äº†å¯¹åº”ç”¨ç¨‹åºå…³é”®è·¯å¾„ä¸Šå¦ä¸€ä¸ªæ¨¡å‹çš„ä¾èµ–ï¼ˆä¾‹å¦‚ï¼Œè¯­ä¹‰ç¼“å­˜å¯èƒ½ä¾èµ–äºåµŒå…¥æ¨¡å‹å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºï¼‰ï¼Œå¹¶ä¸”æ— æ³•ä¿è¯å‡†ç¡®æ•æ‰è¾“å…¥çš„æ„ä¹‰ã€‚</p>
<p>ç„¶è€Œï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›æƒ…å†µä¸‹ç¼“å­˜èŠå¤©æ¨¡å‹å“åº”æ˜¯æœ‰ç›Šçš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ªç”¨äºå›ç­”å¸¸è§é—®é¢˜çš„èŠå¤©æ¨¡å‹ï¼Œç¼“å­˜å“åº”å¯ä»¥å¸®åŠ©å‡è½»æ¨¡å‹æä¾›è€…çš„è´Ÿæ‹…ã€é™ä½æˆæœ¬å¹¶æé«˜å“åº”é€Ÿåº¦ã€‚</p>
<br>
<h3 id="Prompt">Prompt</h3>
<h4 id="PromptTemplate">PromptTemplate</h4>
<p>LangChain æä¾›äº† <code>PromptTemplate</code> æ¨¡å—ç”¨äºåŠ¨æ€åœ°æ„å»ºæç¤ºè¯ï¼ˆPromptï¼‰ã€‚å®ƒæ”¯æŒå˜é‡æ›¿æ¢ï¼Œè®©å¼€å‘è€…èƒ½çµæ´»æ„é€ æç¤ºè¯­å¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line">template = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;product&quot;</span>],</span><br><span class="line">    template=<span class="string">&quot;è¯·ä¸ºä»¥ä¸‹äº§å“å†™ä¸€æ®µå¹¿å‘Šæ–‡æ¡ˆï¼š&#123;product&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line">prompt = template.<span class="built_in">format</span>(product=<span class="string">&quot;æ™ºèƒ½æ‰‹è¡¨&quot;</span>)</span><br></pre></td></tr></table></figure>
<br>
<h3 id="Semantic-search-engine">Semantic search engine</h3>
<p>LangChain éå¸¸é€‚åˆæ„å»ºåŸºäºçŸ¥è¯†åº“çš„é—®ç­”ç³»ç»Ÿï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š</p>
<h4 id="Chunking">Chunking</h4>
<p>å°†é•¿æ–‡æ¡£æŒ‰æ®µè½æˆ– token é™åˆ¶æ‹†åˆ†ä¸ºå°å—ï¼ˆchunkï¼‰ï¼Œä»¥é¿å…è¾“å…¥è¶…é•¿ã€‚</p>
<p><code>RecursiveCharacterTextSplitter</code> é€šè¿‡<strong>é€’å½’å°è¯•ä¸åŒçš„åˆ†éš”ç¬¦å±‚çº§</strong>ï¼Œé€æ­¥å°†æ–‡æœ¬åˆ†å‰²ä¸ºè¯­ä¹‰è¿è´¯çš„å—ã€‚å®ƒä¼˜å…ˆå°è¯•æ›´é«˜çº§åˆ«çš„åˆ†éš”ç¬¦ï¼ˆå¦‚æ®µè½ï¼‰ï¼Œå¦‚æœåˆ†å‰²åçš„å—ä»è¿‡å¤§ï¼Œåˆ™é€’å½’ä½¿ç”¨æ›´ä½çº§åˆ«çš„åˆ†éš”ç¬¦ï¼ˆå¦‚å¥å­ã€å•è¯ï¼‰è¿›è¡ŒäºŒæ¬¡åˆ†å‰²ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line">splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="number">500</span>, chunk_overlap=<span class="number">50</span>)</span><br><span class="line">chunks = splitter.split_text(document_text)</span><br></pre></td></tr></table></figure>
<br>
<h5 id="Better-Chunking">Better Chunking</h5>
<p>ref: <a href="https://github.com/ConardLi/easy-dataset">https://github.com/ConardLi/easy-dataset</a></p>
<ol>
<li>é¦–å…ˆéœ€è¦è®¾å®šæ–‡æœ¬å—çš„æœ€å°ï¼Œæœ€å¤§åˆ†å‰²é•¿åº¦</li>
<li>è‡ªåŠ¨å¯¹ç« èŠ‚ï¼ˆMarkdownæ–‡ä»¶ä¸­çš„ <code>#, ##, ###</code>ï¼‰è¿›è¡Œè¯†åˆ«</li>
<li>å¯¹å·²è¯†åˆ«åˆ°çš„ç« èŠ‚å­—æ•°è¿›è¡Œè®¡æ•°ï¼Œåœ¨æ°å¥½ä½äº &gt; æœ€å°åˆ†å‰²é•¿åº¦ å’Œ &lt; æœ€å¤§åˆ†å‰²é•¿åº¦çš„å‰æä¸‹è¿›è¡Œåˆ†æ®µ</li>
<li>é‡åˆ°é•¿æ®µè½ï¼ˆè¶…å‡ºæœ€å¤§åˆ†å‰²é•¿åº¦ï¼‰æ—¶ï¼Œæ‰§è¡Œé€’å½’åˆ†æ®µç®—æ³• <code>RecursiveCharacterTextSplitter</code>ï¼›</li>
</ol>
<blockquote>
<p>å…¶å®å°±æ˜¯åŠ äº†ä¸€ä¸ªå¯¹ç« èŠ‚çš„è¯†åˆ«åˆ†å‰²</p>
</blockquote>
<br>
<h4 id="Embedding-Vector-Store">Embedding &amp; Vector Store</h4>
<p>ä½¿ç”¨ Embedding æ¨¡å‹ï¼ˆå¦‚ OpenAIã€HuggingFaceï¼‰å°†æ–‡æœ¬å‘é‡åŒ–ï¼Œç„¶åå­˜å…¥å‘é‡æ•°æ®åº“ï¼ˆå¦‚ FAISSã€Chromaã€Pineconeï¼‰ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.embeddings <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"></span><br><span class="line">embeddings = OpenAIEmbeddings(model=<span class="string">&quot;text-embedding-3-large&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># FAISSå­˜å‚¨</span></span><br><span class="line">embedding_dim = <span class="built_in">len</span>(embeddings.embed_query(<span class="string">&quot;hello world&quot;</span>))</span><br><span class="line">index = faiss.IndexFlatL2(embedding_dim)</span><br><span class="line"></span><br><span class="line">vector_store = FAISS(</span><br><span class="line">    embedding_function=embeddings,</span><br><span class="line">    index=index,</span><br><span class="line">    docstore=InMemoryDocstore(),</span><br><span class="line">    index_to_docstore_id=&#123;&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ids = vector_store.add_documents(documents=all_splits)</span><br></pre></td></tr></table></figure>
<br>
<h4 id="Retrieval">Retrieval</h4>
<p>ä½¿ç”¨å‘é‡æ£€ç´¢è·å–ç›¸å…³ chunkï¼Œè¾“å…¥ç»™ LLMï¼Œç”Ÿæˆç­”æ¡ˆã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@chain</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retriever</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">    <span class="keyword">return</span> vector_store.similarity_search(query, k=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">retriever.batch(</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;How many distribution centers does Nike have in the US?&quot;</span>,</span><br><span class="line">        <span class="string">&quot;When was Nike incorporated?&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<br>
<br>
<h3 id="Agent">Agent</h3>
<p>Agent æ˜¯ LangChain ä¸­å®ç° LLM æ¨ç†å’Œå†³ç­–çš„æ ¸å¿ƒæ¨¡å—ï¼Œæ”¯æŒåŠ¨æ€é€‰æ‹©å·¥å…·ï¼ˆToolï¼‰æ¥å®Œæˆå¤šæ­¥ä»»åŠ¡ã€‚</p>
<h4 id="Base">Base</h4>
<p>æ ¸å¿ƒç»„ä»¶ï¼š</p>
<ul>
<li><strong>Agent</strong>ï¼šè´Ÿè´£æ¨ç†å’Œè°ƒç”¨å·¥å…·</li>
<li><strong>Tool</strong>ï¼šå·¥å…·å‡½æ•°ï¼Œå¦‚ Web æœç´¢ã€æ•°æ®åº“æŸ¥è¯¢ã€Python è®¡ç®—ç­‰</li>
<li><strong>LLM</strong>ï¼šé©±åŠ¨ Agent çš„å¤§è„‘</li>
<li><strong>AgentExecutor</strong>ï¼šæ‰§è¡Œå™¨ï¼Œè´Ÿè´£ç®¡ç† Agent çš„æ‰§è¡Œé€»è¾‘</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Import relevant functionality</span></span><br><span class="line"><span class="keyword">from</span> langchain_anthropic <span class="keyword">import</span> ChatAnthropic</span><br><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line"><span class="keyword">from</span> langgraph.checkpoint.memory <span class="keyword">import</span> MemorySaver</span><br><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> create_react_agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the agent</span></span><br><span class="line">memory = MemorySaver()</span><br><span class="line">model = ChatAnthropic(model_name=<span class="string">&quot;claude-3-sonnet-20240229&quot;</span>)</span><br><span class="line">search = TavilySearchResults(max_results=<span class="number">2</span>)</span><br><span class="line">tools = [search]</span><br><span class="line">agent_executor = create_react_agent(model, tools, checkpointer=memory)</span><br></pre></td></tr></table></figure>
<br>
<h4 id="QA-Processing-Method">QA Processing Method</h4>
<p>Stuff Methodï¼ˆå¡å…¥å¼ï¼‰</p>
<p>ç›´æ¥å°†æ‰€æœ‰ç›¸å…³æ–‡æ¡£çš„å†…å®¹â€œå¡â€è¿› Prompt é‡Œï¼Œé€‚ç”¨äºå†…å®¹å°‘ã€ä¸Šä¸‹æ–‡çŸ­çš„åœºæ™¯ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># LLMChain + æ–‡æ¡£ç»„åˆç›´æ¥ç”Ÿæˆ Prompt</span></span><br></pre></td></tr></table></figure>
<p>MapReduce</p>
<p>å°†æ‰€æœ‰ chunk åˆ†åˆ«ç”¨ LLM å¤„ç†åï¼Œå†ç”¨å¦ä¸€ä¸ª LLM æ±‡æ€»ï¼ˆReduceï¼‰ï¼Œç±»ä¼¼ MapReduce æ€ç»´ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ–‡æ¡£åˆ‡ç‰‡ -&gt; å„ç‰‡æ®µç”Ÿæˆå›ç­”ï¼ˆMapï¼‰-&gt; æ±‡æ€»ä¸ºæœ€ç»ˆç­”æ¡ˆï¼ˆReduceï¼‰</span></span><br></pre></td></tr></table></figure>
<p>Refine</p>
<p>åˆå§‹æ–‡æ¡£å›ç­”ä¸€ä¸ªç²—ç•¥ç­”æ¡ˆï¼Œæ¥ç€é€æ­¥å¼•å…¥æ›´å¤š chunk æ¥ç»†åŒ–å’Œå®Œå–„ç­”æ¡ˆã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆæ­¥å›ç­” + åç»­ refineï¼Œé€‚åˆé€æ­¥æ·±å…¥å¤„ç†</span></span><br></pre></td></tr></table></figure>
<p>MapRerank</p>
<p>ç±»ä¼¼ Map æ–¹æ³•ï¼Œä½†æœ€åä¸æ±‡æ€»æ‰€æœ‰å›ç­”ï¼Œè€Œæ˜¯ç”± LLM å¯¹æ¯ä¸ªå›ç­”æ‰“åˆ†ï¼Œé€‰æ‹©æœ€ä¼˜ç­”æ¡ˆã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¤šä¸ªå›ç­” -&gt; æ‰“åˆ†æ’åº -&gt; è¿”å›æœ€é«˜åˆ†</span></span><br></pre></td></tr></table></figure>
<br>
<h4 id="Streaming-message-Streaming-tokens">Streaming message &amp; Streaming tokens</h4>
<p><strong>streaming tokens</strong></p>
<p>æŒ‡é€ä¸ªç”Ÿæˆæ–‡æœ¬ç‰‡æ®µï¼ˆTokenï¼‰ï¼Œé€‚ç”¨äºéœ€è¦å®æ—¶å±•ç¤ºç”Ÿæˆè¿‡ç¨‹çš„åœºæ™¯ï¼Œå¦‚é€è¯æ˜¾ç¤ºå›ç­”ã€‚</p>
<p>æµ‹è¯•ä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">model = ChatOpenAI(model=<span class="string">&quot;gpt-4o-mini&quot;</span>, streaming=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># åŒæ­¥æµå¼å¤„ç†</span></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> model.stream(<span class="string">&quot;å¤©ç©ºæ˜¯ä»€ä¹ˆé¢œè‰²ï¼Ÿ&quot;</span>):</span><br><span class="line">    <span class="built_in">print</span>(chunk.content, end=<span class="string">&quot;|&quot;</span>, flush=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºæ•ˆæœï¼š<br>
<code>The| sky| appears| blue| during| the| day|.</code></p>
<br>
<p><strong>Streaming Messages</strong></p>
<p>æˆ‘ä»¬å·²ç»çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ <code>.invoke</code> æ¥è°ƒç”¨ä»£ç†ä»¥è·å–æœ€ç»ˆå“åº”ã€‚å¦‚æœä»£ç†æ‰§è¡Œå¤šä¸ªæ­¥éª¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚ä¸ºäº†å±•ç¤ºä¸­é—´è¿›åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰æ¶ˆæ¯å‘ç”Ÿæ—¶å®æ—¶è¿”å›æ¶ˆæ¯ã€‚</p>
<p>æµ‹è¯•ä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> agent_executor.stream(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=<span class="string">&quot;whats the weather in sf?&quot;</span>)]&#125;,</span><br><span class="line">    stream_mode=<span class="string">&quot;values&quot;</span>,</span><br><span class="line">):</span><br><span class="line">    step[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">whats the weather <span class="keyword">in</span> sf?</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">[&#123;<span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;Okay, let me look up the current weather for San Francisco using a search engine:&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>&#125;, &#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;toolu_01H1brh5EZpZqtqHBxkosPtN&#x27;</span>, <span class="string">&#x27;input&#x27;</span>: &#123;<span class="string">&#x27;query&#x27;</span>: <span class="string">&#x27;san francisco weather&#x27;</span>&#125;, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;tavily_search_results_json&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;tool_use&#x27;</span>&#125;]</span><br><span class="line">Tool Calls:</span><br><span class="line">  tavily_search_results_json (toolu_01H1brh5EZpZqtqHBxkosPtN)</span><br><span class="line"> Call ID: toolu_01H1brh5EZpZqtqHBxkosPtN</span><br><span class="line">  Args:</span><br><span class="line">    query: san francisco weather</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: tavily_search_results_json</span><br><span class="line"></span><br><span class="line">[&#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.weatherapi.com/&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;&#123;&#x27;location&#x27;: &#123;&#x27;name&#x27;: &#x27;San Francisco&#x27;, &#x27;region&#x27;: &#x27;California&#x27;, &#x27;country&#x27;: &#x27;United States of America&#x27;, &#x27;lat&#x27;: 37.775, &#x27;lon&#x27;: -122.4183, &#x27;tz_id&#x27;: &#x27;America/Los_Angeles&#x27;, &#x27;localtime_epoch&#x27;: 1739994486, &#x27;localtime&#x27;: &#x27;2025-02-19 11:48&#x27;&#125;, &#x27;current&#x27;: &#123;&#x27;last_updated_epoch&#x27;: 1739994300, &#x27;last_updated&#x27;: &#x27;2025-02-19 11:45&#x27;, &#x27;temp_c&#x27;: 13.3, &#x27;temp_f&#x27;: 55.9, &#x27;is_day&#x27;: 1, &#x27;condition&#x27;: &#123;&#x27;text&#x27;: &#x27;Light rain&#x27;, &#x27;icon&#x27;: &#x27;//cdn.weatherapi.com/weather/64x64/day/296.png&#x27;, &#x27;code&#x27;: 1183&#125;, &#x27;wind_mph&#x27;: 5.8, &#x27;wind_kph&#x27;: 9.4, &#x27;wind_degree&#x27;: 195, &#x27;wind_dir&#x27;: &#x27;SSW&#x27;, &#x27;pressure_mb&#x27;: 1023.0, &#x27;pressure_in&#x27;: 30.2, &#x27;precip_mm&#x27;: 0.0, &#x27;precip_in&#x27;: 0.0, &#x27;humidity&#x27;: 87, &#x27;cloud&#x27;: 100, &#x27;feelslike_c&#x27;: 12.7, &#x27;feelslike_f&#x27;: 54.8, &#x27;windchill_c&#x27;: 9.1, &#x27;windchill_f&#x27;: 48.4, &#x27;heatindex_c&#x27;: 10.2, &#x27;heatindex_f&#x27;: 50.3, &#x27;dewpoint_c&#x27;: 9.8, &#x27;dewpoint_f&#x27;: 49.7, &#x27;vis_km&#x27;: 4.0, &#x27;vis_miles&#x27;: 2.0, &#x27;uv&#x27;: 1.4, &#x27;gust_mph&#x27;: 8.9, &#x27;gust_kph&#x27;: 14.4&#125;&#125;&quot;</span>&#125;, &#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://world-weather.info/forecast/usa/san_francisco/february-2025/&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Weather in San Francisco in February 2025 (California) - Detailed Weather Forecast for a Month Weather World Weather in San Francisco Weather in San Francisco in February 2025 San Francisco Weather Forecast for February 2025, is based on previous years&#x27; statistical data. +59Â°+50Â° +59Â°+52Â° +59Â°+50Â° +61Â°+52Â° +59Â°+50Â° +61Â°+50Â° +61Â°+52Â° +63Â°+52Â° +61Â°+52Â° +61Â°+50Â° +61Â°+50Â° +61Â°+50Â° +59Â°+50Â° +59Â°+50Â° +61Â°+50Â° +61Â°+52Â° +59Â°+50Â° +59Â°+48Â° +57Â°+48Â° +59Â°+50Â° +59Â°+48Â° +59Â°+50Â° +57Â°+46Â° +61Â°+50Â° +61Â°+50Â° +59Â°+50Â° +59Â°+48Â° +59Â°+50Â° Extended weather forecast in San Francisco HourlyWeek10-Day14-Day30-DayYear Weather in large and nearby cities Weather in Washington, D.C.+41Â° Sacramento+55Â° Pleasanton+55Â° Redwood City+55Â° San Leandro+55Â° San Mateo+54Â° San Rafael+52Â° San Ramon+52Â° South San Francisco+54Â° Vallejo+50Â° Palo Alto+55Â° Pacifica+55Â° Berkeley+54Â° Castro Valley+55Â° Concord+52Â° Daly City+54Â° Noverd+52Â° Sign Hill+54Â° world&#x27;s temperature today day day Temperature units&quot;</span>&#125;]</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">The search results provide details on the current weather conditions and forecast <span class="keyword">for</span> San Francisco. Some key details:</span><br><span class="line"></span><br><span class="line">- It is lightly raining <span class="keyword">in</span> San Francisco right now, with a temperature around 55Â°F/13Â°C. </span><br><span class="line">- The forecast <span class="keyword">for</span> the rest of February 2025 shows daytime highs mostly <span class="keyword">in</span> the upper 50s to low 60s F, with night lows <span class="keyword">in</span> the upper 40s to low 50s F. </span><br><span class="line">- Typical weather includes some rain, clouds, cool temperatures and breezy conditions.</span><br><span class="line"></span><br><span class="line">So <span class="keyword">in</span> summary, as is common <span class="keyword">for</span> San Francisco <span class="keyword">in</span> late winter, it is currently cool with light rain showers, and similar mild, unsettled weather is expected over the next couple weeks. Layers and a light jacket would be advisable <span class="keyword">for</span> being outdoors. Let me know <span class="keyword">if</span> you need any other details!</span><br></pre></td></tr></table></figure>
<br>
<h4 id="Memory-Adding">Memory Adding</h4>
<p>é€šè¿‡configå®ç°å¯¹çº¿ç¨‹ä¸Šä¸‹æ–‡çš„è®°å¿†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">agent_executor = create_react_agent(model, tools, checkpointer=memory)</span><br><span class="line"></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;abc123&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> agent_executor.stream(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=<span class="string">&quot;hi im bob!&quot;</span>)]&#125;, config</span><br><span class="line">):</span><br><span class="line">    <span class="built_in">print</span>(chunk)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;agent&#x27;</span>: &#123;<span class="string">&#x27;messages&#x27;</span>: [AIMessage(content=<span class="string">&quot;Hello Bob! It&#x27;s nice to meet you again.&quot;</span>, response_metadata=&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;msg_013C1z2ZySagEFwmU1EsysR2&#x27;</span>, <span class="string">&#x27;model&#x27;</span>: <span class="string">&#x27;claude-3-sonnet-20240229&#x27;</span>, <span class="string">&#x27;stop_reason&#x27;</span>: <span class="string">&#x27;end_turn&#x27;</span>, <span class="string">&#x27;stop_sequence&#x27;</span>: None, <span class="string">&#x27;usage&#x27;</span>: &#123;<span class="string">&#x27;input_tokens&#x27;</span>: 1162, <span class="string">&#x27;output_tokens&#x27;</span>: 14&#125;&#125;, <span class="built_in">id</span>=<span class="string">&#x27;run-f878acfd-d195-44e8-9166-e2796317e3f8-0&#x27;</span>, usage_metadata=&#123;<span class="string">&#x27;input_tokens&#x27;</span>: 1162, <span class="string">&#x27;output_tokens&#x27;</span>: 14, <span class="string">&#x27;total_tokens&#x27;</span>: 1176&#125;)]&#125;&#125;</span><br><span class="line">----</span><br></pre></td></tr></table></figure>
<p>å°è¯•ä¸Šä¸‹æ–‡è®°å¿†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> agent_executor.stream(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=<span class="string">&quot;whats my name?&quot;</span>)]&#125;, config</span><br><span class="line">):</span><br><span class="line">    <span class="built_in">print</span>(chunk)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;agent&#x27;</span>: &#123;<span class="string">&#x27;messages&#x27;</span>: [AIMessage(content=<span class="string">&#x27;You mentioned your name is Bob when you introduced yourself earlier. So your name is Bob.&#x27;</span>, response_metadata=&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;msg_01WNwnRNGwGDRw6vRdivt6i1&#x27;</span>, <span class="string">&#x27;model&#x27;</span>: <span class="string">&#x27;claude-3-sonnet-20240229&#x27;</span>, <span class="string">&#x27;stop_reason&#x27;</span>: <span class="string">&#x27;end_turn&#x27;</span>, <span class="string">&#x27;stop_sequence&#x27;</span>: <span class="literal">None</span>, <span class="string">&#x27;usage&#x27;</span>: &#123;<span class="string">&#x27;input_tokens&#x27;</span>: <span class="number">1184</span>, <span class="string">&#x27;output_tokens&#x27;</span>: <span class="number">21</span>&#125;&#125;, <span class="built_in">id</span>=<span class="string">&#x27;run-f5c0b957-8878-405a-9d4b-a7cd38efe81f-0&#x27;</span>, usage_metadata=&#123;<span class="string">&#x27;input_tokens&#x27;</span>: <span class="number">1184</span>, <span class="string">&#x27;output_tokens&#x27;</span>: <span class="number">21</span>, <span class="string">&#x27;total_tokens&#x27;</span>: <span class="number">1205</span>&#125;)]&#125;&#125;</span><br><span class="line">----</span><br></pre></td></tr></table></figure>
<br>
<h3 id="Example">Example</h3>
<h4 id="Extraction-Chain">Extraction Chain</h4>
<h5 id="Schema-Extrator">Schema &amp; Extrator</h5>
<p>Schema æè¿°å¦‚ä½•ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯ï¼Œé€šè¿‡ç»“æ„åŒ–æŒ‡å®š + prompt invokeå®ç°ä¿¡æ¯æå–</p>
<blockquote>
<p>å…³äº pydantic åº“çš„ä½¿ç”¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># å¿…å¡«å­—æ®µï¼Œå­—ç¬¦ä¸²ç±»å‹</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯é€‰å­—æ®µï¼Œå¸¦æœ‰é»˜è®¤å€¼</span></span><br><span class="line">    age: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä½¿ç”¨ Field æ·»åŠ é¢å¤–éªŒè¯å’Œå…ƒæ•°æ®</span></span><br><span class="line">    email: <span class="built_in">str</span> = Field(</span><br><span class="line">        ...,  <span class="comment"># è¡¨ç¤ºå¿…å¡«å­—æ®µ</span></span><br><span class="line">        min_length=<span class="number">5</span>,</span><br><span class="line">        max_length=<span class="number">100</span>,</span><br><span class="line">        regex=<span class="string">r&quot;^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$&quot;</span>,</span><br><span class="line">        description=<span class="string">&quot;ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¸¦æœ‰é»˜è®¤å€¼å’Œé¢å¤–éªŒè¯çš„å­—æ®µ</span></span><br><span class="line">    score: <span class="built_in">float</span> = Field(</span><br><span class="line">        default=<span class="number">0.0</span>,</span><br><span class="line">        ge=<span class="number">0</span>,</span><br><span class="line">        le=<span class="number">100</span>,</span><br><span class="line">        description=<span class="string">&quot;ç”¨æˆ·è¯„åˆ†ï¼ŒèŒƒå›´0-100&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ«åç¤ºä¾‹</span></span><br><span class="line">    full_name: <span class="built_in">str</span> = Field(..., alias=<span class="string">&quot;fullName&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ¨¡å‹</span></span><br><span class="line">user_data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;john_doe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;john@example.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;fullName&quot;</span>: <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">user = User(**user_data)</span><br><span class="line"><span class="built_in">print</span>(user)</span><br><span class="line"><span class="comment"># è¾“å‡º: username=&#x27;john_doe&#x27; age=None email=&#x27;john@example.com&#x27; score=0.0 full_name=&#x27;John Doe&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(user.<span class="built_in">dict</span>(by_alias=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># è¾“å‡º: &#123;&#x27;username&#x27;: &#x27;john_doe&#x27;, &#x27;age&#x27;: None, &#x27;email&#x27;: &#x27;john@example.com&#x27;, &#x27;score&#x27;: 0.0, &#x27;fullName&#x27;: &#x27;John Doe&#x27;&#125;</span></span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>default</code>: å­—æ®µçš„é»˜è®¤å€¼</li>
<li><code>default_factory</code>: ç”Ÿæˆé»˜è®¤å€¼çš„å¯è°ƒç”¨å¯¹è±¡</li>
<li><code>alias</code>: å­—æ®µçš„åˆ«åï¼ˆç”¨äºåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼‰</li>
<li><code>title</code>: å­—æ®µçš„æ ‡é¢˜ï¼ˆç”¨äºæ–‡æ¡£ï¼‰</li>
<li><code>description</code>: å­—æ®µçš„æè¿°ï¼ˆç”¨äºæ–‡æ¡£ï¼‰</li>
<li><code>gt</code>: å¤§äº (greater than)</li>
<li><code>ge</code>: å¤§äºç­‰äº (greater than or equal)</li>
<li><code>lt</code>: å°äº (less than)</li>
<li><code>le</code>: å°äºç­‰äº (less than or equal)</li>
<li><code>min_length</code>: æœ€å°é•¿åº¦ï¼ˆå­—ç¬¦ä¸²ã€åˆ—è¡¨ç­‰ï¼‰</li>
<li><code>max_length</code>: æœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦ä¸²ã€åˆ—è¡¨ç­‰ï¼‰</li>
<li><code>regex</code>: æ­£åˆ™è¡¨è¾¾å¼éªŒè¯</li>
</ul>
</blockquote>
<br>
<p>æ¡ˆä¾‹ä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, MessagesPlaceholder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Information about a person.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ^ Doc-string for the entity Person.</span></span><br><span class="line">    <span class="comment"># This doc-string is sent to the LLM as the description of the schema Person,</span></span><br><span class="line">    <span class="comment"># and it can help to improve extraction results.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Note that:</span></span><br><span class="line">    <span class="comment"># 1. Each field is an `optional` -- this allows the model to decline to extract it!</span></span><br><span class="line">    <span class="comment"># 2. Each field has a `description` -- this description is used by the LLM.</span></span><br><span class="line">    <span class="comment"># Having a good description can help improve extraction results.</span></span><br><span class="line">    name: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(default=<span class="literal">None</span>, description=<span class="string">&quot;The name of the person&quot;</span>)</span><br><span class="line">    hair_color: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(</span><br><span class="line">        default=<span class="literal">None</span>, description=<span class="string">&quot;The color of the person&#x27;s hair if known&quot;</span></span><br><span class="line">    )</span><br><span class="line">    height_in_meters: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(</span><br><span class="line">        default=<span class="literal">None</span>, description=<span class="string">&quot;Height measured in meters&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Extracted data about people.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Creates a model so that we can extract multiple entities.</span></span><br><span class="line">    people: <span class="type">List</span>[Person]        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># ä¸ºLLMè®¾ç½®schema</span></span><br><span class="line"><span class="comment"># structured_llm = llm.with_structured_output(schema=Person)</span></span><br><span class="line"></span><br><span class="line">structured_llm = llm.with_structured_output(schema=Data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define a custom prompt to provide instructions and any additional context.</span></span><br><span class="line"><span class="comment"># 1) You can add examples into the prompt template to improve extraction quality</span></span><br><span class="line"><span class="comment"># 2) Introduce additional parameters to take context into account (e.g., include metadata</span></span><br><span class="line"><span class="comment">#    about the document from which the text was extracted.)</span></span><br><span class="line">prompt_template = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (</span><br><span class="line">            <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;You are an expert extraction algorithm. &quot;</span></span><br><span class="line">            <span class="string">&quot;Only extract relevant information from the text. &quot;</span></span><br><span class="line">            <span class="string">&quot;If you do not know the value of an attribute asked to extract, &quot;</span></span><br><span class="line">            <span class="string">&quot;return null for the attribute&#x27;s value.&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment"># Please see the how-to about improving performance with</span></span><br><span class="line">        <span class="comment"># reference examples.</span></span><br><span class="line">        <span class="comment"># MessagesPlaceholder(&#x27;examples&#x27;),</span></span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;text&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;My name is Jeff, my hair is black and i am 6 feet tall. Anna has the same color hair as me.&quot;</span></span><br><span class="line">prompt = prompt_template.invoke(&#123;<span class="string">&quot;text&quot;</span>: text&#125;)</span><br><span class="line">structured_llm.invoke(prompt)</span><br></pre></td></tr></table></figure>
<br>
<p>output</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Data(people=[Person(name=<span class="string">&#x27;Jeff&#x27;</span>, hair_color=<span class="string">&#x27;black&#x27;</span>, height_in_meters=<span class="string">&#x27;1.83&#x27;</span>), Person(name=<span class="string">&#x27;Anna&#x27;</span>, hair_color=<span class="string">&#x27;black&#x27;</span>, height_in_meters=None)])</span><br></pre></td></tr></table></figure>
<br>
<h5 id="RAG-based-long-context-extraction">RAG based long context extraction</h5>
<p>ä½¿ç”¨ FAISS</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, MessagesPlaceholder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KeyDevelopment</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Information about a development in the history of cars.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    year: <span class="built_in">int</span> = Field(</span><br><span class="line">        ...,  <span class="comment"># `...` è¡¨ç¤ºå¿…å¡«å­—æ®µ</span></span><br><span class="line">        description=<span class="string">&quot;The year when there was an important historic development.&quot;</span></span><br><span class="line">    )</span><br><span class="line">    description: <span class="built_in">str</span> = Field(</span><br><span class="line">        ..., </span><br><span class="line">        description=<span class="string">&quot;What happened in this year? What was the development?&quot;</span></span><br><span class="line">    )</span><br><span class="line">    evidence: <span class="built_in">str</span> = Field(</span><br><span class="line">        ...,</span><br><span class="line">        description=<span class="string">&quot;Repeat verbatim the sentence(s) from which the year and description were extracted.&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExtractionData</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Extracted information about key developments in the history of cars.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    key_developments: <span class="type">List</span>[KeyDevelopment]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define a custom prompt to provide instructions and any additional context.</span></span><br><span class="line"><span class="comment"># 1) You can add examples into the prompt template to improve extraction quality</span></span><br><span class="line"><span class="comment"># 2) Introduce additional parameters to take context into account (e.g., include metadata</span></span><br><span class="line"><span class="comment">#    about the document from which the text was extracted.)</span></span><br><span class="line">prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (</span><br><span class="line">            <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;You are an expert at identifying key historic development in text. &quot;</span></span><br><span class="line">            <span class="string">&quot;Only extract important historic developments. Extract nothing if no important information can be found in the text.&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;text&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥å¿…è¦çš„åº“å’Œæ¨¡å—</span></span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS  <span class="comment"># FAISSå‘é‡æ•°æ®åº“ï¼Œç”¨äºé«˜æ•ˆç›¸ä¼¼æ€§æœç´¢</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document      <span class="comment"># æ–‡æ¡£å¤„ç†åŸºç¡€ç±»</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda <span class="comment"># å¯è¿è¡ŒLambdaå‡½æ•°</span></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings     <span class="comment"># OpenAIçš„æ–‡æœ¬åµŒå…¥æ¨¡å‹</span></span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> CharacterTextSplitter  <span class="comment"># æ–‡æœ¬åˆ†å‰²å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ–‡æœ¬åˆ†å‰²å™¨å°†æ–‡æ¡£å†…å®¹åˆ†å‰²æˆå¤šä¸ªæ–‡æœ¬å—</span></span><br><span class="line"><span class="comment"># document.page_contentæ˜¯åŸå§‹æ–‡æ¡£å†…å®¹</span></span><br><span class="line">texts = text_splitter.split_text(document.page_content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨FAISSåˆ›å»ºå‘é‡å­˜å‚¨åº“</span></span><br><span class="line"><span class="comment"># å°†åˆ†å‰²åçš„æ–‡æœ¬å—(texts)è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºï¼Œä½¿ç”¨OpenAIçš„åµŒå…¥æ¨¡å‹</span></span><br><span class="line">vectorstore = FAISS.from_texts(texts, embedding=OpenAIEmbeddings())</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ£€ç´¢å™¨(retriever)ï¼Œç”¨äºä»å‘é‡åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£</span></span><br><span class="line"><span class="comment"># search_kwargs=&#123;&quot;k&quot;: 1&#125; è¡¨ç¤ºåªè¿”å›æœ€ç›¸å…³çš„1ä¸ªæ–‡æ¡£</span></span><br><span class="line">retriever = vectorstore.as_retriever(</span><br><span class="line">    search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">extractor = prompt | llm.with_structured_output(</span><br><span class="line">    schema=ExtractionData,</span><br><span class="line">    include_raw=<span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºRAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)æå–å™¨</span></span><br><span class="line"><span class="comment"># 1. é¦–å…ˆä½¿ç”¨retrieveræ£€ç´¢æ–‡æ¡£</span></span><br><span class="line"><span class="comment"># 2. ç„¶åé€šè¿‡Lambdaå‡½æ•°æå–ç¬¬ä¸€ä¸ªæ–‡æ¡£çš„å†…å®¹(docs[0].page_content)</span></span><br><span class="line"><span class="comment"># 3. æœ€åå°†æå–çš„æ–‡æœ¬ä¼ é€’ç»™extractorè¿›è¡Œå¤„ç†</span></span><br><span class="line">rag_extractor = &#123;</span><br><span class="line">    <span class="string">&quot;text&quot;</span>: retriever | (<span class="keyword">lambda</span> docs: docs[<span class="number">0</span>].page_content)</span><br><span class="line">&#125; | extractor</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨RAGæå–å™¨ï¼ŒæŸ¥è¯¢&quot;ä¸æ±½è½¦ç›¸å…³çš„å…³é”®å‘å±•&quot;</span></span><br><span class="line"><span class="comment"># ç³»ç»Ÿä¼šå…ˆæ£€ç´¢ç›¸å…³æ–‡æ¡£ï¼Œç„¶åæå–ä¿¡æ¯</span></span><br><span class="line">results = rag_extractor.invoke(<span class="string">&quot;Key developments associated with cars&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†å¹¶æ‰“å°æå–å‡ºçš„æ¯ä¸ªå…³é”®å‘å±•</span></span><br><span class="line"><span class="keyword">for</span> key_development <span class="keyword">in</span> results.key_developments:</span><br><span class="line">    <span class="built_in">print</span>(key_development)</span><br></pre></td></tr></table></figure>
<br>
<h4 id="Classify">Classify</h4>
<p>æ¡ˆä¾‹ä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Classification</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    sentiment: <span class="built_in">str</span> = Field(..., enum=[<span class="string">&quot;happy&quot;</span>, <span class="string">&quot;neutral&quot;</span>, <span class="string">&quot;sad&quot;</span>])</span><br><span class="line">    aggressiveness: <span class="built_in">int</span> = Field(</span><br><span class="line">        ...,</span><br><span class="line">        description=<span class="string">&quot;describes how aggressive the statement is, the higher the number the more aggressive&quot;</span>,</span><br><span class="line">        enum=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    )</span><br><span class="line">    language: <span class="built_in">str</span> = Field(</span><br><span class="line">        ..., enum=[<span class="string">&quot;spanish&quot;</span>, <span class="string">&quot;english&quot;</span>, <span class="string">&quot;french&quot;</span>, <span class="string">&quot;german&quot;</span>, <span class="string">&quot;italian&quot;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tagging_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Extract the desired information from the following passage.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Only extract the properties mentioned in the &#x27;Classification&#x27; function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Passage:</span></span><br><span class="line"><span class="string">&#123;input&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># LLM</span></span><br><span class="line">llm = ChatOpenAI(temperature=<span class="number">0</span>, model=<span class="string">&quot;gpt-4o-mini&quot;</span>).with_structured_output(</span><br><span class="line">    Classification</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">inp = <span class="string">&quot;Estoy increiblemente contento de haberte conocido! Creo que seremos muy buenos amigos!&quot;</span></span><br><span class="line">prompt = tagging_prompt.invoke(&#123;<span class="string">&quot;input&quot;</span>: inp&#125;)</span><br><span class="line">response = llm.invoke(prompt)</span><br><span class="line"></span><br><span class="line">response</span><br><span class="line"><span class="comment"># output: </span></span><br><span class="line"><span class="comment"># Classification(sentiment=&#x27;positive&#x27;, aggressiveness=1, language=&#x27;Spanish&#x27;)</span></span><br><span class="line">response.model_dump()  <span class="comment"># dictionary output</span></span><br><span class="line"><span class="comment"># output: </span></span><br><span class="line"><span class="comment"># sentiment=&#x27;positive&#x27;, aggressiveness=1, language=&#x27;Spanish&#x27;</span></span><br></pre></td></tr></table></figure>
<br>
<h2 id="LangGraph">LangGraph</h2>
<h3 id="Graph">Graph</h3>
<p>Graph ç”± nodes å’Œ edge æ„æˆ</p>
<p>state ä¸ºæ¯ä¸ªå›¾çš„ contextï¼Œåœ¨å®šä¹‰å›¾æ—¶ä¼ å…¥ï¼›</p>
<p>æ¯ä¸ª <code>node</code> éƒ½å¯ä»¥æ¥æ”¶å½“å‰çš„ <code>State</code> ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡ºçŠ¶æ€æ›´æ–°ã€‚</p>
<p>The <code>State</code> includes the graphâ€™s schema and <a href="https://langchain-ai.github.io/langgraph/concepts/low_level/#reducers">reducer functions</a> that handle state updates.</p>
<br>
<p><strong>å¸¸ç”¨æ–¹æ³•</strong></p>
<p><code>add_node</code></p>
<ul>
<li>
<p>é€šè¿‡ <code>.add_node(str, node)</code> æ·»åŠ èŠ‚ç‚¹åˆ°å›¾ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå”¯ä¸€èŠ‚ç‚¹åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºèŠ‚ç‚¹è¢«ä½¿ç”¨æ—¶æ‰€è°ƒç”¨çš„å‡½æ•°æˆ–å¯¹è±¡ï¼›</p>
<blockquote>
<p>æ¯ä¸ªnodeç›¸å½“äºä¸€ä¸ªå¯æ‰§è¡Œå‡½æ•°ï¼Œå¯ä»¥åœ¨å‡½æ•°å†…åšä»»ä½•äº‹æƒ…</p>
</blockquote>
</li>
</ul>
<br>
<p><code>add_edge</code></p>
<ul>
<li>é€šè¿‡ <code>.add_edge(START, str)</code> å’Œ <code>.add_edge(node, str)</code> æ·»åŠ  <code>entry</code> point å’Œ <code>finish</code> pointï¼ŒæŒ‡åå›¾çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œstr ä¸ºèŠ‚ç‚¹å</li>
</ul>
<br>
<p><code>add_conditional_edges</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add_conditional_edges(</span><br><span class="line">    source: <span class="built_in">str</span>,</span><br><span class="line">    path: <span class="type">Union</span>[</span><br><span class="line">        <span class="type">Callable</span>[..., <span class="type">Union</span>[Hashable, <span class="built_in">list</span>[Hashable]]],</span><br><span class="line">        <span class="type">Callable</span>[</span><br><span class="line">            ..., Awaitable[<span class="type">Union</span>[Hashable, <span class="built_in">list</span>[Hashable]]]</span><br><span class="line">        ],</span><br><span class="line">        Runnable[<span class="type">Any</span>, <span class="type">Union</span>[Hashable, <span class="built_in">list</span>[Hashable]]],</span><br><span class="line">    ],</span><br><span class="line">    path_map: <span class="type">Optional</span>[</span><br><span class="line">        <span class="type">Union</span>[<span class="built_in">dict</span>[Hashable, <span class="built_in">str</span>], <span class="built_in">list</span>[<span class="built_in">str</span>]]</span><br><span class="line">    ] = <span class="literal">None</span>,</span><br><span class="line">    then: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span><br><span class="line">) -&gt; Self</span><br></pre></td></tr></table></figure>
<p>ä»èµ·å§‹èŠ‚ç‚¹æ·»åŠ æ¡ä»¶è¾¹åˆ°ä»»æ„æ•°é‡çš„ç›®æ ‡èŠ‚ç‚¹ã€‚</p>
<p><strong>Parameters: å‚æ•°ï¼š</strong></p>
<ul>
<li><code>source</code> ï¼ˆ <code>str</code> ï¼‰- èµ·å§‹èŠ‚ç‚¹ã€‚å½“é€€å‡ºæ­¤èŠ‚ç‚¹æ—¶ï¼Œå°†è¿è¡Œæ­¤æ¡ä»¶è¾¹ã€‚</li>
<li><code>path</code> ï¼ˆ <code>Union[Callable, Runnable]</code> ï¼‰- ç¡®å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–èŠ‚ç‚¹çš„å¯è°ƒç”¨å¯¹è±¡ã€‚å¦‚æœä¸æŒ‡å®š <code>path_map</code> ï¼Œå®ƒåº”è¯¥è¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ã€‚å¦‚æœè¿”å› ENDï¼Œåˆ™å›¾å½¢å°†åœæ­¢æ‰§è¡Œã€‚</li>
<li><code>path_map</code> ï¼ˆ <code>Optional[dict[Hashable, str]]</code> ï¼Œé»˜è®¤ï¼š <code>None</code> ï¼‰- å¯é€‰çš„è·¯å¾„åˆ°èŠ‚ç‚¹åç§°çš„æ˜ å°„ã€‚å¦‚æœçœç•¥ï¼Œåˆ™ <code>path</code> è¿”å›çš„è·¯å¾„åº”è¯¥æ˜¯èŠ‚ç‚¹åç§°ã€‚</li>
<li><code>then</code> ï¼ˆ <code>Optional[str]</code> ï¼Œé»˜è®¤ï¼š <code>None</code> ï¼‰- åœ¨ <code>path</code> é€‰æ‹©çš„èŠ‚ç‚¹ä¹‹åæ‰§è¡ŒèŠ‚ç‚¹çš„åç§°ã€‚</li>
</ul>
<p><strong>Returns: è¿”å›å€¼ï¼š</strong></p>
<ul>
<li><code>Self</code> ï¼ˆ <code>Self</code> ï¼‰- å›¾çš„å®ä¾‹ï¼Œå…è®¸æ–¹æ³•é“¾å¼è°ƒç”¨ã€‚</li>
</ul>
<br>
<p><code>interrupt</code></p>
<p>LangGraph ä¸­çš„ <code>interrupt</code> å‡½æ•°é€šè¿‡åœ¨ç‰¹å®šèŠ‚ç‚¹æš‚åœå›¾ã€å‘äººç±»å±•ç¤ºä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ä»–ä»¬çš„è¾“å…¥ç»§ç»­å›¾æ¥å¯ç”¨äººç±»åœ¨å¾ªç¯ä¸­çš„å·¥ä½œæµç¨‹ã€‚æ­¤åŠŸèƒ½é€‚ç”¨äºå®¡æ‰¹ã€ç¼–è¾‘æˆ–æ”¶é›†é¢å¤–è¾“å…¥ç­‰ä»»åŠ¡ã€‚ <code>interrupt</code> å‡½æ•°ä¸ <code>Command</code> å¯¹è±¡ä¸€èµ·ä½¿ç”¨ï¼Œä»¥äººç±»æä¾›çš„å€¼ç»§ç»­å›¾ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">human_approval</span>(<span class="params">state: State</span>) -&gt; Command[<span class="type">Literal</span>[<span class="string">&quot;some_node&quot;</span>, <span class="string">&quot;another_node&quot;</span>]]:</span><br><span class="line">    is_approved = interrupt(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;question&quot;</span>: <span class="string">&quot;Is this correct?&quot;</span>,</span><br><span class="line">            <span class="comment"># Surface the output that should be</span></span><br><span class="line">            <span class="comment"># reviewed and approved by the human.</span></span><br><span class="line">            <span class="string">&quot;llm_output&quot;</span>: state[<span class="string">&quot;llm_output&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_approved:</span><br><span class="line">        <span class="keyword">return</span> Command(goto=<span class="string">&quot;some_node&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> Command(goto=<span class="string">&quot;another_node&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the node to the graph in an appropriate location</span></span><br><span class="line"><span class="comment"># and connect it to the relevant nodes.</span></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;human_approval&quot;</span>, human_approval)</span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>(checkpointer=checkpointer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># After running the graph and hitting the interrupt, the graph will pause.</span></span><br><span class="line"><span class="comment"># Resume it with either an approval or rejection.</span></span><br><span class="line">thread_config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;some_id&quot;</span>&#125;&#125;</span><br><span class="line">graph.invoke(Command(resume=<span class="literal">True</span>), config=thread_config)</span><br></pre></td></tr></table></figure>
<br>
<p><strong>æ¡ˆä¾‹ä»£ç </strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>, add_messages]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¥å…·ï¼šé€šè¿‡interruptä¸äººç±»äº¤äº’</span></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="comment"># Note that because we are generating a ToolMessage for a state update, we</span></span><br><span class="line"><span class="comment"># generally require the ID of the corresponding tool call. We can use</span></span><br><span class="line"><span class="comment"># LangChain&#x27;s InjectedToolCallId to signal that this argument should not</span></span><br><span class="line"><span class="comment"># be revealed to the model in the tool&#x27;s schema.</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">human_assistance</span>(<span class="params"></span></span><br><span class="line"><span class="params">    name: <span class="built_in">str</span>, birthday: <span class="built_in">str</span>, tool_call_id: Annotated[<span class="built_in">str</span>, InjectedToolCallId]</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Request assistance from a human.&quot;&quot;&quot;</span></span><br><span class="line">    human_response = interrupt(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;question&quot;</span>: <span class="string">&quot;Is this correct?&quot;</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">            <span class="string">&quot;birthday&quot;</span>: birthday,</span><br><span class="line">        &#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># If the information is correct, update the state as-is.</span></span><br><span class="line">    <span class="keyword">if</span> human_response.get(<span class="string">&quot;correct&quot;</span>, <span class="string">&quot;&quot;</span>).lower().startswith(<span class="string">&quot;y&quot;</span>):</span><br><span class="line">        verified_name = name</span><br><span class="line">        verified_birthday = birthday</span><br><span class="line">        response = <span class="string">&quot;Correct&quot;</span></span><br><span class="line">    <span class="comment"># Otherwise, receive information from the human reviewer.</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        verified_name = human_response.get(<span class="string">&quot;name&quot;</span>, name)</span><br><span class="line">        verified_birthday = human_response.get(<span class="string">&quot;birthday&quot;</span>, birthday)</span><br><span class="line">        response = <span class="string">f&quot;Made a correction: <span class="subst">&#123;human_response&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># This time we explicitly update the state with a ToolMessage inside</span></span><br><span class="line">    <span class="comment"># the tool.</span></span><br><span class="line">    state_update = &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: verified_name,</span><br><span class="line">        <span class="string">&quot;birthday&quot;</span>: verified_birthday,</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [ToolMessage(response, tool_call_id=tool_call_id)],</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># We return a Command object in the tool to update our state.</span></span><br><span class="line">    <span class="keyword">return</span> Command(update=state_update)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Modification: tell the LLM which tools it can call</span></span><br><span class="line">tool = TavilySearchResults(max_results=<span class="number">2</span>)</span><br><span class="line">tools = [tool, human_assistance]</span><br><span class="line"></span><br><span class="line">llm = ChatAnthropic(model=<span class="string">&quot;claude-3-5-sonnet-20240620&quot;</span>)</span><br><span class="line">llm_with_tools = llm.bind_tools(tools)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chatbot</span>(<span class="params">state: State</span>):</span><br><span class="line">    message = llm_with_tools.invoke(state[<span class="string">&quot;messages&quot;</span>])</span><br><span class="line">    <span class="comment"># Because we will be interrupting during tool execution,</span></span><br><span class="line">    <span class="comment"># we disable parallel tool calling to avoid repeating any</span></span><br><span class="line">    <span class="comment"># tool invocations when we resume.</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(message.tool_calls) &lt;= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [llm_with_tools.invoke(state[<span class="string">&quot;messages&quot;</span>])]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">graph_builder = StateGraph(State)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;chatbot&quot;</span>, chatbot)</span><br><span class="line"></span><br><span class="line">tool_node = ToolNode(tools=[tool])</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;tools&quot;</span>, tool_node)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">route_tools</span>(<span class="params"></span></span><br><span class="line"><span class="params">    state: State,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Use in the conditional_edge to route to the ToolNode if the last message</span></span><br><span class="line"><span class="string">    has tool calls. Otherwise, route to the end.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(state, <span class="built_in">list</span>):</span><br><span class="line">        ai_message = state[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">elif</span> messages := state.get(<span class="string">&quot;messages&quot;</span>, []):</span><br><span class="line">        ai_message = messages[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;No messages found in input state to tool_edge: <span class="subst">&#123;state&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(ai_message, <span class="string">&quot;tool_calls&quot;</span>) <span class="keyword">and</span> <span class="built_in">len</span>(ai_message.tool_calls) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tools&quot;</span>  <span class="comment"># path å‡½æ•°è¿”å›çš„ä¸ºèŠ‚ç‚¹åç§°</span></span><br><span class="line">    <span class="keyword">return</span> END  <span class="comment"># path å‡½æ•°è¿”å›çš„ä¸ºèŠ‚ç‚¹åç§°</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># The `tools_condition` function returns &quot;tools&quot; if the chatbot asks to use a tool, and &quot;END&quot; if</span></span><br><span class="line"><span class="comment"># it is fine directly responding. This conditional routing defines the main agent loop.</span></span><br><span class="line">graph_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;chatbot&quot;</span>,</span><br><span class="line">    route_tools,</span><br><span class="line">    <span class="comment"># The following dictionary lets you tell the graph to interpret the condition&#x27;s outputs as a specific node</span></span><br><span class="line">    <span class="comment"># It defaults to the identity function, but if you</span></span><br><span class="line">    <span class="comment"># want to use a node named something else apart from &quot;tools&quot;,</span></span><br><span class="line">    <span class="comment"># You can update the value of the dictionary to something else</span></span><br><span class="line">    <span class="comment"># e.g., &quot;tools&quot;: &quot;my_tools&quot;</span></span><br><span class="line">    <span class="comment"># å¯é€‰çš„è·¯å¾„åˆ°èŠ‚ç‚¹åç§°çš„æ˜ å°„ã€‚å¦‚æœçœç•¥ï¼Œåˆ™ `path` è¿”å›çš„è·¯å¾„åº”è¯¥æ˜¯èŠ‚ç‚¹åç§°ã€‚</span></span><br><span class="line">    &#123;<span class="string">&quot;tools&quot;</span>: <span class="string">&quot;tools&quot;</span>, END: END&#125;,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># Any time a tool is called, we return to the chatbot to decide the next step</span></span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;tools&quot;</span>, <span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph_builder.add_edge(START, <span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line"><span class="comment"># graph = graph_builder.compile()</span></span><br><span class="line">memory = MemorySaver()  <span class="comment"># æ·»åŠ æ£€æŸ¥ç‚¹</span></span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>(checkpointer=memory)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line">events = graph.stream(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: (</span><br><span class="line">                    <span class="string">&quot;I&#x27;m learning LangGraph. &quot;</span></span><br><span class="line">                    <span class="string">&quot;Could you do some research on it for me?&quot;</span></span><br><span class="line">                ),</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    config,</span><br><span class="line">    stream_mode=<span class="string">&quot;values&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">in</span> event:</span><br><span class="line">        event[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure>
<br>
<br>
<h2 id="Agentic-Design-Patterns">Agentic Design Patterns</h2>
<h3 id="Design-Pattern">Design Pattern</h3>
<img src="/2025/04/21/AI-Agent/5.png" class="" title="alt text">
<ul>
<li>Short-term memory: ä¸Šä¸‹æ–‡Context</li>
<li>Long-term memory: å¤–æŒ‚æ•°æ®åº“ï¼Œä¾‹å¦‚RAGæŠ€æœ¯</li>
<li>Tool: MCP(function callâ€¦)</li>
<li>Planning: Reflectionï¼ŒSelf-criticsâ€¦</li>
</ul>
<br>
<h3 id="Reflection">Reflection</h3>
<ul>
<li>â€œ[Self-Refine: Iterative Refinement with Self-Feedback](<a href="https://arxiv.org/abs/2303.17651?utm_campaign=The">https://arxiv.org/abs/2303.17651?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-9dHVnW1I1bA3sPBbsikjT165Qez3QiiAssknCERwgki818YHG7PyHOQSgg-nxKDa0BuE7B),â€ Madaan et al. (2023)</li>
<li>â€œ[Reflexion: Language Agents with Verbal Reinforcement Learning](<a href="https://arxiv.org/abs/2303.11366?utm_campaign=The">https://arxiv.org/abs/2303.11366?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-9dHVnW1I1bA3sPBbsikjT165Qez3QiiAssknCERwgki818YHG7PyHOQSgg-nxKDa0BuE7B),â€ Shinn et al. (2023)</li>
<li>â€œ[CRITIC: Large Language Models Can Self-Correct with Tool-Interactive Critiquing](<a href="https://arxiv.org/abs/2305.11738?utm_campaign=The">https://arxiv.org/abs/2305.11738?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-9dHVnW1I1bA3sPBbsikjT165Qez3QiiAssknCERwgki818YHG7PyHOQSgg-nxKDa0BuE7B),â€ Gou et al. (2024)</li>
</ul>
<br>
<h3 id="Tool-Use">Tool Use</h3>
<ul>
<li>â€œ[Gorilla: Large Language Model Connected with Massive APIs](<a href="https://arxiv.org/abs/2305.15334?utm_campaign=The">https://arxiv.org/abs/2305.15334?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtzâ€“9ARMthd09q0ABUi-abo6BH62BLbcwPo13LrXs9hUezs-L050Ay7b_rHdWuRIqBVOD6k_S),â€ Patil et al. (2023)</li>
<li>â€œ[MM-REACT: Prompting ChatGPT for Multimodal Reasoning and Action](<a href="https://arxiv.org/abs/2303.11381?utm_campaign=The">https://arxiv.org/abs/2303.11381?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtzâ€“9ARMthd09q0ABUi-abo6BH62BLbcwPo13LrXs9hUezs-L050Ay7b_rHdWuRIqBVOD6k_S),â€ Yang et al. (2023)</li>
<li>â€œ[Efficient Tool Use with Chain-of-Abstraction Reasoning](<a href="https://arxiv.org/abs/2401.17464?utm_campaign=The">https://arxiv.org/abs/2401.17464?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtzâ€“9ARMthd09q0ABUi-abo6BH62BLbcwPo13LrXs9hUezs-L050Ay7b_rHdWuRIqBVOD6k_S),â€ Gao et al. (2024)</li>
</ul>
<br>
<h3 id="Planning">Planning</h3>
<ul>
<li>â€œ[Chain-of-Thought Prompting Elicits Reasoning in Large Language Models](<a href="https://arxiv.org/abs/2201.11903?utm_campaign=The">https://arxiv.org/abs/2201.11903?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-8Kh954rkXmE4vgpKvro3Klpjhn7IuT-Y_eXIYtgVIq9PTzwa5zFWX7FZZqv1tuDEEsTDuY),â€ Wei et al. (2022)</li>
<li>â€œ[HuggingGPT: Solving AI Tasks with ChatGPT and its Friends in Hugging Face](<a href="https://arxiv.org/abs/2303.17580?utm_campaign=The">https://arxiv.org/abs/2303.17580?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-8Kh954rkXmE4vgpKvro3Klpjhn7IuT-Y_eXIYtgVIq9PTzwa5zFWX7FZZqv1tuDEEsTDuY),â€ Shen et al. (2023)</li>
<li>â€œ[Understanding the planning of LLM agents: A survey](<a href="https://arxiv.org/pdf/2402.02716.pdf?utm_campaign=The">https://arxiv.org/pdf/2402.02716.pdf?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-8Kh954rkXmE4vgpKvro3Klpjhn7IuT-Y_eXIYtgVIq9PTzwa5zFWX7FZZqv1tuDEEsTDuY),â€ by Huang et al. (2024)</li>
</ul>
<br>
<h3 id="Multi-Agent-Collaboration">Multi-Agent Collaboration</h3>
<ul>
<li>â€œ[Communicative Agents for Software Development](<a href="https://arxiv.org/abs/2307.07924?utm_campaign=The">https://arxiv.org/abs/2307.07924?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-8TZzur2df1qdnGx09b-Fg94DTsc3-xXao4StKvKNU2HR51el3n8yOm0CPSw6GiAoLQNKua),â€ Qian et al. (2023) (the ChatDev paper)</li>
<li>â€œ[AutoGen: Enabling Next-Gen LLM Applications via Multi-Agent Conversation](<a href="https://arxiv.org/abs/2308.08155?utm_campaign=The">https://arxiv.org/abs/2308.08155?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-8TZzur2df1qdnGx09b-Fg94DTsc3-xXao4StKvKNU2HR51el3n8yOm0CPSw6GiAoLQNKua),â€ Wu et al. (2023)</li>
<li>â€œ[MetaGPT: Meta Programming for a Multi-Agent Collaborative Framework](<a href="https://arxiv.org/abs/2308.00352?utm_campaign=The">https://arxiv.org/abs/2308.00352?utm_campaign=The</a> Batch&amp;utm_source=hs_email&amp;utm_medium=email&amp;_hsenc=p2ANqtz-8TZzur2df1qdnGx09b-Fg94DTsc3-xXao4StKvKNU2HR51el3n8yOm0CPSw6GiAoLQNKua),â€ Hong et al. (2023)</li>
</ul>
<br>
<h2 id="MCP">MCP</h2>
<p>Model Context Protocol</p>
<p>ref: <a href="https://modelcontextprotocol.io/introduction">https://modelcontextprotocol.io/introduction</a></p>
<p>ref: <a href="https://zhuanlan.zhihu.com/p/29001189476">https://zhuanlan.zhihu.com/p/29001189476</a></p>
<img src="/2025/04/21/AI-Agent/v2-2bcd98f6541da0b6f14dc9082ee2dcda_1440w.jpg" class="" title="mcp">
<br>
<p><a href="https://github.com/modelcontextprotocol/python-sdk/tree/main/examples/clients/simple-chatbot/mcp_simple_chatbot">example</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># client </span></span><br><span class="line">   ... <span class="comment"># çœç•¥äº†æ— å…³çš„ä»£ç </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–æ‰€æœ‰çš„ mcp server</span></span><br><span class="line">    <span class="keyword">for</span> server <span class="keyword">in</span> self.servers:</span><br><span class="line">        <span class="keyword">await</span> server.initialize()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–æ‰€æœ‰çš„ tools å‘½åä¸º all_tools</span></span><br><span class="line">    all_tools = []</span><br><span class="line">    <span class="keyword">for</span> server <span class="keyword">in</span> self.servers:</span><br><span class="line">        tools = <span class="keyword">await</span> server.list_tools()</span><br><span class="line">        all_tools.extend(tools)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†æ‰€æœ‰çš„ tools çš„åŠŸèƒ½æè¿°æ ¼å¼åŒ–æˆå­—ç¬¦ä¸²ä¾› LLM ä½¿ç”¨</span></span><br><span class="line">    <span class="comment"># tool.format_for_llm() æˆ‘æ”¾åˆ°äº†è¿™æ®µä»£ç æœ€åï¼Œæ–¹ä¾¿é˜…è¯»ã€‚</span></span><br><span class="line">    tools_description = <span class="string">&quot;\n&quot;</span>.join(</span><br><span class="line">        [tool.format_for_llm() <span class="keyword">for</span> tool <span class="keyword">in</span> all_tools]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿™é‡Œå°±ä¸ç®€åŒ–äº†ï¼Œä»¥ä¾›å‚è€ƒï¼Œå®é™…ä¸Šå°±æ˜¯åŸºäº prompt å’Œå½“å‰æ‰€æœ‰å·¥å…·çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="comment"># è¯¢é—® LLMï¼ˆClaudeï¼‰ åº”è¯¥ä½¿ç”¨å“ªäº›å·¥å…·ã€‚</span></span><br><span class="line">    system_message = (</span><br><span class="line">        <span class="string">&quot;You are a helpful assistant with access to these tools:\n\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;tools_description&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Choose the appropriate tool based on the user&#x27;s question. &quot;</span></span><br><span class="line">        <span class="string">&quot;If no tool is needed, reply directly.\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;IMPORTANT: When you need to use a tool, you must ONLY respond with &quot;</span></span><br><span class="line">        <span class="string">&quot;the exact JSON object format below, nothing else:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">        <span class="string">&#x27;    &quot;tool&quot;: &quot;tool-name&quot;,\n&#x27;</span></span><br><span class="line">        <span class="string">&#x27;    &quot;arguments&quot;: &#123;\n&#x27;</span></span><br><span class="line">        <span class="string">&#x27;        &quot;argument-name&quot;: &quot;value&quot;\n&#x27;</span></span><br><span class="line">        <span class="string">&quot;    &#125;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#125;\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;After receiving a tool&#x27;s response:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;1. Transform the raw data into a natural, conversational response\n&quot;</span></span><br><span class="line">        <span class="string">&quot;2. Keep responses concise but informative\n&quot;</span></span><br><span class="line">        <span class="string">&quot;3. Focus on the most relevant information\n&quot;</span></span><br><span class="line">        <span class="string">&quot;4. Use appropriate context from the user&#x27;s question\n&quot;</span></span><br><span class="line">        <span class="string">&quot;5. Avoid simply repeating the raw data\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Please use only the tools that are explicitly defined above.&quot;</span></span><br><span class="line">    )</span><br><span class="line">    messages = [&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_message&#125;]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># Final... å‡è®¾è¿™é‡Œå·²ç»å¤„ç†äº†ç”¨æˆ·æ¶ˆæ¯è¾“å…¥.</span></span><br><span class="line">        messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_input&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† system_message å’Œç”¨æˆ·æ¶ˆæ¯è¾“å…¥ä¸€èµ·å‘é€ç»™ LLM</span></span><br><span class="line">        llm_response = self.llm_client.get_response(messages)</span><br><span class="line"></span><br><span class="line">    ... <span class="comment"># åé¢å’Œç¡®å®šä½¿ç”¨å“ªäº›å·¥å…·æ— å…³</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># server</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Represents a tool with its properties and formatting.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, name: <span class="built_in">str</span>, description: <span class="built_in">str</span>, input_schema: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.name: <span class="built_in">str</span> = name</span><br><span class="line">        self.description: <span class="built_in">str</span> = description</span><br><span class="line">        self.input_schema: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = input_schema</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŠŠå·¥å…·çš„åå­— / å·¥å…·çš„ç”¨é€”ï¼ˆdescriptionï¼‰å’Œå·¥å…·æ‰€éœ€è¦çš„å‚æ•°ï¼ˆargs_descï¼‰è½¬åŒ–ä¸ºæ–‡æœ¬</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format_for_llm</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Format tool information for LLM.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            A formatted string describing the tool.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args_desc = []</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;properties&quot;</span> <span class="keyword">in</span> self.input_schema:</span><br><span class="line">            <span class="keyword">for</span> param_name, param_info <span class="keyword">in</span> self.input_schema[<span class="string">&quot;properties&quot;</span>].items():</span><br><span class="line">                arg_desc = (</span><br><span class="line">                    <span class="string">f&quot;- <span class="subst">&#123;param_name&#125;</span>: <span class="subst">&#123;param_info.get(<span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;No description&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">if</span> param_name <span class="keyword">in</span> self.input_schema.get(<span class="string">&quot;required&quot;</span>, []):</span><br><span class="line">                    arg_desc += <span class="string">&quot; (required)&quot;</span></span><br><span class="line">                args_desc.append(arg_desc)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Tool: <span class="subst">&#123;self.name&#125;</span></span></span><br><span class="line"><span class="string">Description: <span class="subst">&#123;self.description&#125;</span></span></span><br><span class="line"><span class="string">Arguments:</span></span><br><span class="line"><span class="string"><span class="subst">&#123;<span class="built_in">chr</span>(<span class="number">10</span>).join(args_desc)&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<br>
<h2 id="å¾®è°ƒæ•°æ®é›†æ„å»º">å¾®è°ƒæ•°æ®é›†æ„å»º</h2>
<h3 id="Chunking-2">Chunking</h3>
<p>åˆ†å—æ–¹æ¡ˆå‚è€ƒä¸Šæ–‡</p>
<h3 id="é—®é¢˜åˆ›å»º-é—®é¢˜æ±‚è§£">é—®é¢˜åˆ›å»º&amp;é—®é¢˜æ±‚è§£</h3>
<p>é’ˆå¯¹äºåˆ†å‰²å¥½çš„æ–‡æœ¬å—ï¼Œé€šè¿‡LLMä¸ºå…¶ç”Ÿæˆå¯¹åº”é—®é¢˜</p>
<br>
<h2 id="KBQA">KBQA</h2>
<p>Knowledge Based Question Answering (KBQA) aims to answer factual questions based on the provided knowledge base (KB).</p>
<p>ref: <a href="https://github.com/RUCAIBox/Awesome-KBQA">https://github.com/RUCAIBox/Awesome-KBQA</a></p>
<br>
<h3 id="Semantic-Parsing-based-Methods">Semantic Parsing-based Methods</h3>
<br>
<h3 id="Information-retrieval-based-Methods">Information retrieval-based Methods</h3>
<br>
<h3 id="Other-Methods">Other Methods</h3>
<br>
<h2 id="RAG">RAG</h2>
<p>æŠ€æœ¯å…¥é—¨ï¼š<a href="https://github.com/fareedkhan-dev/all-rag-techniques">https://github.com/fareedkhan-dev/all-rag-techniques</a></p>
<p><a href="https://github.com/NirDiamant/RAG_Techniques">https://github.com/NirDiamant/RAG_Techniques</a></p>
<h3 id="RAG-Design">RAG Design</h3>
<p>ref: <a href="https://abdullin.com/ilya/how-to-build-best-rag/">https://abdullin.com/ilya/how-to-build-best-rag/</a></p>
<h3 id="Effective-Chunking-Strategies-for-RAG">Effective Chunking Strategies for RAG</h3>
<p><a href="https://docs.cohere.com/page/chunking-strategies">https://docs.cohere.com/page/chunking-strategies</a></p>
<h3 id="Embedding">Embedding</h3>
<p><a href="https://github.com/FlagOpen/FlagEmbedding">https://github.com/FlagOpen/FlagEmbedding</a></p>
<h3 id="Reranker">Reranker</h3>
<p><a href="https://www.pinecone.io/learn/series/rag/rerankers/">https://www.pinecone.io/learn/series/rag/rerankers/</a></p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥å®Œæˆè¿™ä¸‰é¡¹å…³äº RAG (Retrieval-Augmented Generation) æ‰©å±•æ–¹æ³•çš„è¯¦ç»†è¯´æ˜ã€‚</p>
<hr>
<h3 id="Extended-Method">Extended Method</h3>
<h4 id="å‡è®¾æ€§æ–‡æ¡£åµŒå…¥-Hypothetical-Document-Embedding-HDE">å‡è®¾æ€§æ–‡æ¡£åµŒå…¥ (Hypothetical Document Embedding - HDE)</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong><br>
ä¸å…¶ç›´æ¥å¯¹ç”¨æˆ·çš„ç®€çŸ­ã€æ¨¡ç³Šçš„æŸ¥è¯¢ï¼ˆQueryï¼‰è¿›è¡ŒåµŒå…¥ï¼Œä¸å¦‚å…ˆè®©ä¸€ä¸ªå¤§å‹è¯­è¨€æ¨¡å‹ (LLM) æ ¹æ®è¯¥æŸ¥è¯¢ç”Ÿæˆä¸€ä¸ªå®ƒè®¤ä¸ºæœ€ç†æƒ³ã€æœ€å®Œæ•´çš„â€œå‡è®¾æ€§ç­”æ¡ˆâ€æˆ–â€œå‡è®¾æ€§æ–‡æ¡£â€ï¼Œç„¶åå¯¹è¿™ä¸ªå†…å®¹æ›´ä¸°å¯Œã€è¯­ä¹‰æ›´æ˜ç¡®çš„å‡è®¾æ€§æ–‡æ¡£è¿›è¡ŒåµŒå…¥ï¼Œå†ç”¨å…¶ç”Ÿæˆçš„å‘é‡å»çŸ¥è¯†åº“ä¸­è¿›è¡Œå‘é‡æ£€ç´¢ã€‚</p>
<p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong><br>
å®ƒä¸»è¦è§£å†³â€œ<strong>æŸ¥è¯¢ä¸æ–‡æ¡£ä¹‹é—´çš„è¯­ä¹‰é¸¿æ²Ÿ (Semantic Gap)</strong>â€é—®é¢˜ã€‚ç”¨æˆ·çš„æŸ¥è¯¢é€šå¸¸å¾ˆçŸ­ï¼ˆå¦‚â€œä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨ï¼Ÿâ€ï¼‰ï¼Œè€ŒçŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£é€šå¸¸å¾ˆé•¿ï¼ŒåŒ…å«è¯¦ç»†çš„è§£é‡Šã€èƒŒæ™¯å’Œä¾‹å­ã€‚è¿™ä¸¤ç§ä¸åŒå½¢å¼çš„æ–‡æœ¬åœ¨åµŒå…¥ç©ºé—´ä¸­çš„å‘é‡å¯èƒ½ç›¸è·ç”šè¿œï¼Œå¯¼è‡´æ£€ç´¢æ•ˆæœä¸ä½³ã€‚HDEé€šè¿‡ç”Ÿæˆä¸€ä¸ªä¸ç›®æ ‡æ–‡æ¡£åœ¨æ ¼å¼ã€é•¿åº¦å’Œå†…å®¹ä¸Šéƒ½æ›´ç›¸ä¼¼çš„â€œä¸­é—´æ–‡æ¡£â€ï¼Œæå¤§åœ°ç¼©å°äº†è¿™ä¸€é¸¿æ²Ÿã€‚</p>
<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<ol>
<li>
<p><strong>æ¥æ”¶æŸ¥è¯¢ (Receive Query):</strong> ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šâ€œå¦‚ä½•ä¸ºæˆ‘çš„åˆåˆ›å…¬å¸è¿›è¡Œç§å­è½®èèµ„ï¼Ÿâ€</p>
</li>
<li>
<p><strong>ç”Ÿæˆå‡è®¾æ€§æ–‡æ¡£ (Generate Hypothetical Document):</strong> ç³»ç»Ÿå°†è¯¥æŸ¥è¯¢å‘é€ç»™ä¸€ä¸ª LLMï¼Œå¹¶æç¤ºå®ƒï¼šâ€œè¯·ç”Ÿæˆä¸€ä»½è¯¦ç»†å›ç­”â€˜å¦‚ä½•ä¸ºæˆ‘çš„åˆåˆ›å…¬å¸è¿›è¡Œç§å­è½®èèµ„ï¼Ÿâ€™è¿™ä¸ªé—®é¢˜çš„æ–‡æ¡£ã€‚â€</p>
</li>
<li>
<p><strong>LLM è¾“å‡º:</strong> LLM å¯èƒ½ä¼šç”Ÿæˆå¦‚ä¸‹çš„å‡è®¾æ€§æ–‡æ¡£ï¼š</p>
<blockquote>
<p>â€œä¸ºåˆåˆ›å…¬å¸è¿›è¡Œç§å­è½®èèµ„é€šå¸¸æ¶‰åŠå‡ ä¸ªå…³é”®æ­¥éª¤ã€‚é¦–å…ˆï¼Œä½ éœ€è¦ä¸€ä¸ªæ¸…æ™°çš„å•†ä¸šè®¡åˆ’ä¹¦ã€ä¸€ä¸ªæœ€å°å¯è¡Œäº§å“ï¼ˆMVPï¼‰å’Œä¸€ä¸ªæœ‰è¯´æœåŠ›çš„æ¼”è®²ç¨¿ã€‚å…¶æ¬¡ï¼Œå»ºç«‹ä½ çš„æŠ•èµ„äººç½‘ç»œè‡³å…³é‡è¦ï¼Œå¯ä»¥ä»å¤©ä½¿æŠ•èµ„äººå’Œæ—©æœŸé£é™©æŠ•èµ„æœºæ„å¼€å§‹ã€‚åœ¨æ¥è§¦æŠ•èµ„äººæ—¶ï¼Œè¦æ¸…æ™°åœ°é˜è¿°ä½ çš„å¸‚åœºæœºä¼šã€å›¢é˜Ÿä¼˜åŠ¿å’Œè´¢åŠ¡é¢„æµ‹â€¦â€</p>
</blockquote>
</li>
<li>
<p><strong>åµŒå…¥å‡è®¾æ€§æ–‡æ¡£ (Embed Hypothetical Document):</strong> ç³»ç»Ÿå°†è¿™ä¸ªç”± LLM ç”Ÿæˆçš„ã€å†…å®¹ä¸°å¯Œçš„å‡è®¾æ€§æ–‡æ¡£é€šè¿‡åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰è½¬æ¢æˆä¸€ä¸ªå‘é‡ã€‚</p>
</li>
<li>
<p><strong>æ‰§è¡Œæ£€ç´¢ (Perform Retrieval):</strong> ä½¿ç”¨è¿™ä¸ªæ–°ç”Ÿæˆçš„å‘é‡ï¼Œåœ¨æ–‡æ¡£/çŸ¥è¯†åº“çš„å‘é‡ç´¢å¼•ä¸­è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ï¼Œæ‰¾å‡ºä¸è¿™ä¸ªâ€œç†æƒ³ç­”æ¡ˆâ€æœ€åŒ¹é…çš„å®é™…æ–‡æ¡£ã€‚</p>
</li>
<li>
<p><strong>ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ (Generate Final Answer):</strong> å°†æ£€ç´¢åˆ°çš„æ–‡æ¡£å’ŒåŸå§‹æŸ¥è¯¢ä¸€èµ·æä¾›ç»™ LLMï¼Œç”Ÿæˆæœ€ç»ˆçš„ã€æœ‰äº‹å®ä¾æ®çš„ç­”æ¡ˆã€‚</p>
</li>
</ol>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li><strong>æé«˜æ£€ç´¢ç²¾åº¦ï¼š</strong> æ˜¾è‘—æ”¹å–„äº†æŸ¥è¯¢å’Œæ–‡æ¡£ä¹‹é—´çš„è¯­ä¹‰åŒ¹é…åº¦ï¼Œèƒ½æ‰¾åˆ°æ›´ç›¸å…³çš„å†…å®¹ã€‚</li>
<li><strong>å¤„ç†æ¨¡ç³ŠæŸ¥è¯¢ï¼š</strong> å¯¹äºæ„å›¾ä¸æ˜ç¡®æˆ–è¿‡äºç®€çŸ­çš„æŸ¥è¯¢ï¼Œæ•ˆæœæå‡å°¤ä¸ºæ˜æ˜¾ã€‚</li>
</ul>
<p><strong>æŒ‘æˆ˜ä¸è€ƒé‡ï¼š</strong></p>
<ul>
<li><strong>å¢åŠ å»¶è¿Ÿï¼š</strong> åœ¨æ£€ç´¢å‰å¢åŠ äº†ä¸€æ¬¡ LLM è°ƒç”¨ï¼Œå¯¼è‡´æ•´ä½“å“åº”æ—¶é—´å˜é•¿ã€‚</li>
<li><strong>å¢åŠ æˆæœ¬ï¼š</strong> é¢å¤–çš„ LLM è°ƒç”¨ä¼šäº§ç”Ÿé¢å¤–è´¹ç”¨ã€‚</li>
<li><strong>ä¾èµ–ç”Ÿæˆè´¨é‡ï¼š</strong> å‡è®¾æ€§æ–‡æ¡£çš„è´¨é‡ç›´æ¥å†³å®šäº†æ£€ç´¢æ•ˆæœçš„å¥½åã€‚</li>
</ul>
<hr>
<h4 id="è¿­ä»£å¼æ£€ç´¢ç”Ÿæˆ-Iterative-Retrieval-Generation-IRG">è¿­ä»£å¼æ£€ç´¢ç”Ÿæˆ (Iterative Retrieval Generation - IRG)</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong><br>
å°†æ£€ç´¢å’Œç”Ÿæˆè¿‡ç¨‹ä»â€œä¸€æ¬¡æ€§å®Œæˆâ€çš„çº¿æ€§æµç¨‹ï¼Œè½¬å˜ä¸ºä¸€ä¸ªå¾ªç¯ã€è¿­ä»£ã€é€æ­¥æ±‚ç²¾çš„è¿‡ç¨‹ã€‚ç³»ç»Ÿä¼šæ ¹æ®åˆæ­¥ç”Ÿæˆçš„ç­”æ¡ˆæˆ–ä¸­é—´æ€è€ƒï¼Œä¸»åŠ¨å‘ç°çŸ¥è¯†ç¼ºå£ï¼Œå¹¶ç”Ÿæˆæ–°çš„æŸ¥è¯¢ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼Œç›´åˆ°èƒ½å¤Ÿå½¢æˆä¸€ä¸ªå®Œæ•´ã€å‡†ç¡®çš„ç­”æ¡ˆä¸ºæ­¢ã€‚</p>
<p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong><br>
å®ƒä¸»è¦è§£å†³<strong>å¤æ‚ã€å¤šæ­¥éª¤æˆ–éœ€è¦æ•´åˆå¤šæ–¹é¢çŸ¥è¯†çš„æŸ¥è¯¢ (Complex, Multi-hop Questions)</strong>ã€‚å¯¹äºè¿™ç±»é—®é¢˜ï¼Œå•æ¬¡æ£€ç´¢å¾€å¾€æ— æ³•è·å–æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œâ€œæ¯”è¾ƒä¸€ä¸‹ã€ŠæŒ‡ç¯ç‹ã€‹å’Œã€Šå†°ä¸ç«ä¹‹æ­Œã€‹åœ¨ä¸–ç•Œæ„å»ºå’Œè§’è‰²å¡‘é€ ä¸Šçš„å¼‚åŒï¼Ÿâ€</p>
<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<ol>
<li><strong>åˆå§‹æ£€ç´¢ (Initial Retrieval):</strong> ç³»ç»Ÿæ¥æ”¶åˆå§‹æŸ¥è¯¢ï¼Œå¹¶è¿›è¡Œç¬¬ä¸€æ¬¡æ£€ç´¢ï¼Œè·å–ä¸€æ‰¹ç›¸å…³æ–‡æ¡£ã€‚</li>
<li><strong>åˆæ­¥ç”Ÿæˆä¸åˆ†æ (Initial Generation &amp; Analysis):</strong> LLM åŸºäºç¬¬ä¸€æ¬¡æ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼Œå°è¯•ç”Ÿæˆç­”æ¡ˆã€‚åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šè¯†åˆ«å‡ºå½“å‰ä¿¡æ¯ä¸­çš„ä¸è¶³ä¹‹å¤„ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½æ‰¾åˆ°äº†å…³äºã€ŠæŒ‡ç¯ç‹ã€‹ä¸–ç•Œæ„å»ºçš„èµ„æ–™ï¼Œä½†ç¼ºå°‘ã€Šå†°ä¸ç«ä¹‹æ­Œã€‹è§’è‰²å¡‘é€ çš„ç»†èŠ‚ã€‚</li>
<li><strong>ç”Ÿæˆæ–°æŸ¥è¯¢ (Generate New Queries):</strong> åŸºäºè¯†åˆ«å‡ºçš„çŸ¥è¯†ç¼ºå£ï¼Œç³»ç»Ÿï¼ˆæˆ– LLM æœ¬èº«ï¼‰ä¼šç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„ã€æ›´å…·é’ˆå¯¹æ€§çš„æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼šâ€œã€Šå†°ä¸ç«ä¹‹æ­Œã€‹ä¸­çš„ä¸»è¦è§’è‰²å¡‘é€ æŠ€å·§â€ã€â€œã€ŠæŒ‡ç¯ç‹ã€‹çš„é­”æ³•ç³»ç»Ÿè®¾å®šâ€ã€‚</li>
<li><strong>è¿­ä»£æ£€ç´¢ (Iterative Retrieval):</strong> ç³»ç»Ÿä½¿ç”¨è¿™äº›æ–°æŸ¥è¯¢å»çŸ¥è¯†åº“ä¸­è¿›è¡Œæ–°ä¸€è½®çš„æ£€ç´¢ï¼Œè·å–è¡¥å……ä¿¡æ¯ã€‚</li>
<li><strong>æ•´åˆä¸ç²¾ç‚¼ (Integration &amp; Refinement):</strong> å°†æ‰€æœ‰è½®æ¬¡æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œæ•´åˆï¼Œå¹¶äº¤ç”± LLM è¿›è¡Œæœ€ç»ˆçš„ç»¼åˆæ€§å›ç­”ã€‚</li>
<li><strong>å¾ªç¯ç»ˆæ­¢ï¼š</strong> å½“ LLM åˆ¤æ–­ä¿¡æ¯å·²ç»è¶³å¤Ÿå…¨é¢ï¼Œæˆ–è€…è¾¾åˆ°é¢„è®¾çš„è¿­ä»£æ¬¡æ•°æ—¶ï¼Œå¾ªç¯ç»“æŸã€‚</li>
</ol>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li><strong>å¤„ç†å¤æ‚é—®é¢˜ï¼š</strong> èƒ½å¤Ÿåƒäººç±»ç ”ç©¶å‘˜ä¸€æ ·ï¼Œé€æ­¥æ·±å…¥ï¼Œè§£å†³éœ€è¦å¤šæ–¹é¢ä¿¡æ¯æ”¯æŒçš„å¤æ‚é—®é¢˜ã€‚</li>
<li><strong>æé«˜ç­”æ¡ˆçš„å…¨é¢æ€§å’Œæ·±åº¦ï¼š</strong> é€šè¿‡è¡¥å……æ£€ç´¢ï¼Œç¡®ä¿ç­”æ¡ˆè¦†ç›–äº†é—®é¢˜çš„æ‰€æœ‰æ–¹é¢ã€‚</li>
</ul>
<p><strong>æŒ‘æˆ˜ä¸è€ƒé‡ï¼š</strong></p>
<ul>
<li><strong>é«˜å»¶è¿Ÿå’Œé«˜æˆæœ¬ï¼š</strong> å¤šæ¬¡æ£€ç´¢å’Œç”Ÿæˆæ­¥éª¤æ˜¾è‘—å¢åŠ äº†å“åº”æ—¶é—´å’Œè®¡ç®—æˆæœ¬ã€‚</li>
<li><strong>é€»è¾‘å¤æ‚æ€§ï¼š</strong> å®ç°ä¸€ä¸ªæœ‰æ•ˆçš„è¿­ä»£å¾ªç¯ã€åˆ¤æ–­ä½•æ—¶åœæ­¢ä»¥åŠå¦‚ä½•ç”Ÿæˆæœ‰æ•ˆçš„åç»­æŸ¥è¯¢ï¼ŒæŠ€æœ¯ä¸Šæ›´å…·æŒ‘æˆ˜æ€§ã€‚</li>
<li><strong>å¯èƒ½é™·å…¥æ— æ•ˆå¾ªç¯ï¼š</strong> å¦‚æœåç»­æŸ¥è¯¢ç”Ÿæˆå¾—ä¸å¥½ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ£€ç´¢ä¸åˆ°æœ‰ç”¨ä¿¡æ¯ï¼Œé™·å…¥ä½æ•ˆå¾ªç¯ã€‚</li>
</ul>
<hr>
<h4 id="ä¼˜åŒ–ç¨ å¯†åŠ ç¨€ç–æ£€ç´¢-Optimized-Dense-Sparse-Retrieval">ä¼˜åŒ–ç¨ å¯†åŠ ç¨€ç–æ£€ç´¢ (Optimized Dense + Sparse Retrieval)</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong><br>
è¿™æ˜¯ä¸€ç§æ··åˆæ£€ç´¢ï¼ˆHybrid Retrievalï¼‰ç­–ç•¥ï¼Œå®ƒç»“åˆäº†ä¸¤ç§ä¸»æµæ£€ç´¢æŠ€æœ¯çš„ä¼˜ç‚¹ï¼š<strong>ç¨ å¯†æ£€ç´¢ (Dense Retrieval)</strong> å’Œ <strong>ç¨€ç–æ£€ç´¢ (Sparse Retrieval)</strong>ï¼Œä»¥å®ç°æ¯”å•ä¸€æŠ€æœ¯æ›´å¼ºå¤§ã€æ›´é²æ£’çš„æ£€ç´¢æ•ˆæœã€‚</p>
<ul>
<li>
<p><strong>ç¨ å¯†æ£€ç´¢ (Dense Retrieval):</strong></p>
<ul>
<li><strong>æŠ€æœ¯:</strong> åŸºäºå‘é‡åµŒå…¥ï¼ˆEmbeddingsï¼‰å’Œå‘é‡ç›¸ä¼¼æ€§æœç´¢ï¼ˆå¦‚ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ã€‚</li>
<li><strong>ä¼˜ç‚¹:</strong> æ“…é•¿ç†è§£<strong>è¯­ä¹‰å’Œä¸Šä¸‹æ–‡</strong>ã€‚èƒ½å¤ŸåŒ¹é…æ„æ€ç›¸è¿‘ä½†ç”¨è¯ä¸åŒçš„æŸ¥è¯¢å’Œæ–‡æ¡£ï¼ˆä¾‹å¦‚ï¼ŒæŸ¥è¯¢â€œç¾å›½æ€»ç»Ÿå®˜é‚¸â€èƒ½åŒ¹é…åˆ°åŒ…å«â€œç™½å®«â€çš„æ–‡æ¡£ï¼‰ã€‚</li>
<li><strong>ç¼ºç‚¹:</strong> å¯¹äº<strong>å…³é”®è¯ã€ä¸“ä¸šæœ¯è¯­ã€ID æˆ–ç¼©å†™</strong>çš„ç²¾ç¡®åŒ¹é…èƒ½åŠ›è¾ƒå¼±ã€‚</li>
</ul>
</li>
<li>
<p><strong>ç¨€ç–æ£€ç´¢ (Sparse Retrieval):</strong></p>
<ul>
<li><strong>æŠ€æœ¯:</strong> åŸºäºå…³é”®è¯é¢‘ç‡å’Œåˆ†å¸ƒçš„ä¼ ç»Ÿä¿¡æ¯æ£€ç´¢æ–¹æ³•ï¼ˆå¦‚ BM25ã€TF-IDFï¼‰ã€‚</li>
<li><strong>ä¼˜ç‚¹:</strong> æ“…é•¿<strong>ç²¾ç¡®åŒ¹é…å…³é”®è¯</strong>ã€‚å¯¹äºåŒ…å«ç‰¹å®šæœ¯è¯­ã€äº§å“å‹å·ï¼ˆå¦‚â€œiPhone 15 Proâ€ï¼‰æˆ–ä»£ç æ ‡è¯†ç¬¦çš„æŸ¥è¯¢ï¼Œæ•ˆæœæä½³ã€‚è®¡ç®—é€Ÿåº¦å¿«ï¼Œèµ„æºæ¶ˆè€—ä½ã€‚</li>
<li><strong>ç¼ºç‚¹:</strong> æ— æ³•ç†è§£è¯­ä¹‰ã€‚æ— æ³•åŒ¹é…åŒä¹‰è¯æˆ–è¿‘ä¹‰è¯ï¼ˆæŸ¥è¯¢â€œæ±½è½¦â€æ— æ³•åŒ¹é…åˆ°åŒ…å«â€œautomobileâ€çš„æ–‡æ¡£ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å·¥ä½œåŸç† (ä¼˜åŒ–ç»“åˆ):</strong></p>
<ol>
<li><strong>å¹¶è¡Œæ£€ç´¢ (Parallel Retrieval):</strong> å½“ç”¨æˆ·è¾“å…¥æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼š<strong>åŒæ—¶</strong>ä½¿ç”¨ä¸¤ç§æ–¹æ³•è¿›è¡Œæ£€ç´¢ï¼š
<ul>
<li><strong>ç¨ å¯†è·¯å¾„ï¼š</strong> å°†æŸ¥è¯¢åµŒå…¥ä¸ºå‘é‡ï¼Œåœ¨å‘é‡æ•°æ®åº“ä¸­æœç´¢æœ€ç›¸ä¼¼çš„æ–‡æ¡£ã€‚</li>
<li><strong>ç¨€ç–è·¯å¾„ï¼š</strong> å¯¹æŸ¥è¯¢è¿›è¡Œåˆ†è¯ï¼Œåœ¨å€’æ’ç´¢å¼•ï¼ˆå¦‚ Elasticsearchï¼‰ä¸­ä½¿ç”¨ BM25 ç®—æ³•æœç´¢æœ€ç›¸å…³çš„æ–‡æ¡£ã€‚</li>
</ul>
</li>
<li><strong>ç»“æœèåˆ (Result Fusion):</strong> ç³»ç»Ÿä¼šå¾—åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„ã€æŒ‰ç›¸å…³æ€§æ’åºçš„æ–‡æ¡£åˆ—è¡¨ã€‚ä¸‹ä¸€æ­¥æ˜¯æ™ºèƒ½åœ°å°†è¿™ä¸¤ä¸ªåˆ—è¡¨èåˆæˆä¸€ä¸ªæœ€ç»ˆåˆ—è¡¨ã€‚æœ€å¸¸ç”¨çš„èåˆç®—æ³•æ˜¯ <strong>â€œå€’æ•°æ’åºèåˆâ€ (Reciprocal Rank Fusion - RRF)</strong>ã€‚
<ul>
<li><strong>RRF ç®—æ³•ï¼š</strong> è¯¥ç®—æ³•ä¸å…³å¿ƒæ¯ä¸ªæ£€ç´¢ç³»ç»Ÿçš„åŸå§‹åˆ†æ•°ï¼ˆå› ä¸ºå®ƒä»¬çš„é‡çº²ä¸åŒï¼‰ï¼Œåªå…³å¿ƒæ–‡æ¡£åœ¨å„è‡ªåˆ—è¡¨ä¸­çš„<strong>æ’å (Rank)</strong>ã€‚ä¸€ä¸ªæ–‡æ¡£çš„æœ€ç»ˆåˆ†æ•°æ˜¯å®ƒåœ¨æ¯ä¸ªåˆ—è¡¨ä¸­æ’åçš„å€’æ•°ä¹‹å’Œã€‚æ’åè¶Šé å‰ï¼Œå€’æ•°è¶Šå¤§ï¼Œæœ€ç»ˆåˆ†æ•°ä¹Ÿè¶Šé«˜ã€‚</li>
<li><strong>å…¬å¼:</strong> <code>RRF_Score(doc) = Î£ (1 / (k + rank_i(doc)))</code>ï¼Œå…¶ä¸­ <code>rank_i(doc)</code> æ˜¯æ–‡æ¡£åœ¨ç¬¬ <code>i</code> ä¸ªæ£€ç´¢ç»“æœåˆ—è¡¨ä¸­çš„æ’åï¼Œ<code>k</code> æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼ˆé€šå¸¸è®¾ä¸º60ï¼‰ï¼Œç”¨äºé™ä½ä½æ’åæ–‡æ¡£çš„å½±å“ã€‚</li>
</ul>
</li>
<li><strong>æœ€ç»ˆæ’åºä¸æˆªæ–­ (Final Ranking &amp; Truncation):</strong> æ ¹æ® RRF åˆ†æ•°å¯¹æ‰€æœ‰æ–‡æ¡£è¿›è¡Œé‡æ–°æ’åºï¼Œå¹¶é€‰å–æ’åæœ€é«˜çš„ Top-K ä¸ªæ–‡æ¡£ï¼Œç”¨äºåç»­çš„ç”Ÿæˆç¯èŠ‚ã€‚</li>
</ol>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li><strong>å–é•¿è¡¥çŸ­ï¼š</strong> ç»“åˆäº†è¯­ä¹‰ç†è§£å’Œå…³é”®è¯åŒ¹é…çš„èƒ½åŠ›ï¼Œæ˜¯ç›®å‰æœ€æœ‰æ•ˆçš„é€šç”¨æ£€ç´¢ç­–ç•¥ä¹‹ä¸€ã€‚</li>
<li><strong>é²æ£’æ€§å¼ºï¼š</strong> å³ä½¿ä¸€ç§æ£€ç´¢æ–¹æ³•æ•ˆæœä¸ä½³ï¼Œå¦ä¸€ç§æ–¹æ³•ä»å¯èƒ½å¬å›ç›¸å…³çš„æ–‡æ¡£ï¼Œå¤§å¤§é™ä½äº†æ£€ç´¢å¤±è´¥çš„é£é™©ã€‚</li>
<li><strong>æ˜¾è‘—æå‡ç›¸å…³æ€§ï¼š</strong> åœ¨å¤šæ•°åœºæ™¯ä¸‹ï¼Œæ··åˆæ£€ç´¢å¬å›çš„æ–‡æ¡£è´¨é‡è¿œé«˜äºä»»ä½•å•ä¸€æ£€ç´¢æ–¹æ³•ã€‚</li>
</ul>
<p><strong>æŒ‘æˆ˜ä¸è€ƒé‡ï¼š</strong></p>
<ul>
<li><strong>ç³»ç»Ÿå¤æ‚æ€§ï¼š</strong> éœ€è¦åŒæ—¶ç»´æŠ¤å‘é‡æ•°æ®åº“å’Œå…³é”®è¯ç´¢å¼•ä¸¤ç§åŸºç¡€è®¾æ–½ã€‚</li>
<li><strong>è°ƒä¼˜æŒ‘æˆ˜ï¼š</strong> èåˆç­–ç•¥ï¼ˆå¦‚ RRFä¸­çš„ <code>k</code> å€¼ï¼‰æˆ–ä¸åŒæ£€ç´¢ç»“æœçš„æƒé‡éœ€è¦è¿›è¡Œå®éªŒå’Œè°ƒä¼˜ï¼Œä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚</li>
</ul>
<h3 id="Improved-RAG">Improved RAG</h3>
<h4 id="GraphRAG">GraphRAG</h4>
<p><a href="https://microsoft.github.io/graphrag/">https://microsoft.github.io/graphrag/</a></p>
<ol>
<li>
<p>Source Documents â†’ Text Chunks</p>
<p>To start, the documents in the corpus are split into text chunks. The LLM extracts information from each chunk for downstream processing.</p>
</li>
<li>
<p>Text Chunks â†’ Entities &amp; Relationships</p>
<p>the LLM is promptedï¼ˆthrought few-shot promptï¼‰ to extract instances of important entities and the relationships between the entities from a given chunk. Additionally, the LLM generates short descriptions for the entities and relationships</p>
<img src="/2025/04/21/AI-Agent/image-20250604165407470.png" class="" title="image-20250604165407470">
<p>The LLM can also be prompted to extract claims about detected entities. Claims are important factual statements about entities, such as dates, events, and interactions with other entities. As with entities and relationships, in-context learning exemplars can provide domain-specific guidance.</p>
<img src="/2025/04/21/AI-Agent/image-20250604170724823.png" class="" title="image-20250604170724823">
</li>
<li>
<p>Entities &amp; Relationships â†’ Knowledge Graph</p>
<p>In the final step of the knowledge graph extraction process, these instances of entities and relationships become individual nodes and edges in the graph. Entity descriptions are aggregated and summarized for each node and edge. Relationships are aggregated into graph edges, where the number of duplicates for a given relationship becomes edge weights. Claims are aggregated similarly</p>
</li>
<li>
<p>Knowledge Graph â†’ Graph Communities</p>
<p>we use Leiden community detection (Traag et al., 2019) in a hierarchical manner, recursively detecting sub-communities within each detected community until reaching leaf communities that can no longer be partitioned. Each level of this hierarchy provides a community partition that covers the nodes of the graph in a mutually exclusive, collectively exhaustive way, enabling divide-and-conquer global summarization.</p>
</li>
<li>
<p>Graph Communities â†’ Community Summaries</p>
<img src="/2025/04/21/AI-Agent/image-20250604173158175.png" class="" title="image-20250604173158175">
</li>
<li>
<p>Community Summaries â†’ Community Answers â†’ Global Answer</p>
<img src="/2025/04/21/AI-Agent/image-20250604173209083.png" class="" title="image-20250604173209083">
</li>
</ol>
<h4 id="LightRAG">LightRAG</h4>
<p><a href="https://arxiv.org/abs/2410.05779">arxiv.org/abs/2410.05779</a></p>
<p><a href="https://github.com/HKUDS/LightRAG">https://github.com/HKUDS/LightRAG</a></p>
<img src="/2025/04/21/AI-Agent/b2aaf634151b4706892693ffb43d9093.png" class="" title="LightRAG Diagram">
<h2 id="Prompt-Engineering">Prompt Engineering</h2>
<p>ref: <a href="https://dannyzheng.me/2025/02/21/prompt-engineering/#the-prompt-engineering-lifecycle">https://dannyzheng.me/2025/02/21/prompt-engineering/#the-prompt-engineering-lifecycle</a></p>
<img src="/2025/04/21/AI-Agent/prompt_components.png" class="" title="img">
<h3 id="Base-2">Base</h3>
<h4 id="Zero-Shot-Prompting">Zero-Shot Prompting</h4>
<p>Zero-Shot Prompting æ˜¯æŒ‡åœ¨ä¸ç»™æ¨¡å‹ä»»ä½•ç¤ºä¾‹çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æå‡ºé—®é¢˜æˆ–ä»»åŠ¡ã€‚è¯¥æ–¹æ³•ä¾èµ–äºæ¨¡å‹çš„é¢„è®­ç»ƒçŸ¥è¯†ï¼Œé€‚ç”¨äºæ¨¡å‹å·²å¹¿æ³›å­¦ä¹ ç›¸å…³é¢†åŸŸä¿¡æ¯çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼š</p>
<blockquote>
<p><strong>Prompt</strong>ï¼šå°†ä¸‹é¢è¿™å¥è¯ç¿»è¯‘æˆè‹±æ–‡ï¼šæˆ‘å–œæ¬¢å­¦ä¹ äººå·¥æ™ºèƒ½ã€‚<br>
<strong>Output</strong>ï¼šI like studying artificial intelligence.</p>
</blockquote>
<p>è¯¥æ–¹æ³•ç®€å•é«˜æ•ˆï¼Œé€‚ç”¨äºä»»åŠ¡æ˜ç¡®ã€æ¨¡å‹å·²å…·å¤‡ç›¸å…³èƒŒæ™¯çŸ¥è¯†çš„åœºæ™¯ã€‚</p>
<br>
<h4 id="Few-Shot-Prompting">Few-Shot Prompting</h4>
<p>Few-Shot Prompting æ˜¯åœ¨æç¤ºä¸­æä¾›å°‘é‡ï¼ˆé€šå¸¸æ˜¯1-5ä¸ªï¼‰ç¤ºä¾‹ï¼Œä»¥å¸®åŠ©æ¨¡å‹ç†è§£ä»»åŠ¡æ ¼å¼æˆ–é€»è¾‘ã€‚è¿™ç§æ–¹å¼å¯ä»¥æ˜¾è‘—æå‡æ¨¡å‹åœ¨ç»“æ„åŒ–ä»»åŠ¡ä¸­çš„è¡¨ç°ã€‚ä¾‹å¦‚ï¼š</p>
<blockquote>
<p><strong>Prompt</strong>ï¼š<br>
ç¿»è¯‘ä¸‹åˆ—å¥å­ï¼š<br>
ä¾‹1ï¼šæˆ‘çˆ±ç¼–ç¨‹ã€‚ â†’ I love programming.<br>
ä¾‹2ï¼šå¤©æ°”å¾ˆå¥½ã€‚ â†’ The weather is nice.<br>
è¯·ç¿»è¯‘ï¼šæˆ‘åœ¨çœ‹ä¹¦ã€‚<br>
<strong>Output</strong>ï¼šI am reading a book.</p>
</blockquote>
<p>Few-Shot Prompting åˆ©ç”¨â€œç±»æ¯”â€æ–¹å¼ï¼Œå¸®åŠ©æ¨¡å‹å¯¹ä»»åŠ¡å½¢æˆæ›´æ˜ç¡®çš„ç†è§£ã€‚</p>
<br>
<h4 id="Chain-of-Thought-CoT-Prompting">Chain-of-Thought (CoT) Prompting</h4>
<p>ref: <a href="https://dannyzheng.me/2025/02/21/prompt-engineering/#the-prompt-engineering-lifecycle">https://dannyzheng.me/2025/02/21/prompt-engineering/#the-prompt-engineering-lifecycle</a></p>
<blockquote>
<p>CoT tip: Always have LLM output its thinking. Without outputting its thought process, no thinking occurs!</p>
</blockquote>
<ul>
<li>
<p>Basic prompt: Include â€œThink step-by-stepâ€ in your prompt.</p>
<ul>
<li>
<p>Lacks guidance on how to think (which is especially not ideal if a task is very specific to your app, use case, or organization)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Draft personalized emails to donors asking for contributions to this yearâ€™s Care for Kids program.</span><br><span class="line"></span><br><span class="line">Program information:</span><br><span class="line">&lt;program&gt;&#123;&#123;PROGRAM_DETAILS&#125;&#125;</span><br><span class="line">&lt;/program&gt;</span><br><span class="line"></span><br><span class="line">Donor information:</span><br><span class="line">&lt;donor&gt;&#123;&#123;DONOR_DETAILS&#125;&#125;</span><br><span class="line">&lt;/donor&gt;</span><br><span class="line"></span><br><span class="line">Think step-by-step before you write the email.</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>Guided prompt: Outline specific steps for LLM to follow in its thinking process.</p>
<ul>
<li>
<p>Lacks structuring to make it easy to strip out and separate the answer from the thinking.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Draft personalized emails to donors asking for contributions to this yearâ€™s Care for Kids program.</span><br><span class="line"></span><br><span class="line">Program information:</span><br><span class="line">&lt;program&gt;&#123;&#123;PROGRAM_DETAILS&#125;&#125;</span><br><span class="line">&lt;/program&gt;</span><br><span class="line"></span><br><span class="line">Donor information:</span><br><span class="line">&lt;donor&gt;&#123;&#123;DONOR_DETAILS&#125;&#125;</span><br><span class="line">&lt;/donor&gt;</span><br><span class="line"></span><br><span class="line">Think before you write the email. First, think through what messaging might appeal to this donor given their donation history and which campaigns theyâ€™ve supported in the past. Then, think through what aspects of the Care for Kids program would appeal to them, given their history. Finally, write the personalized donor email using your analysis.</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>Structured prompt: Use XML tags like &lt;think&gt; &lt;/think&gt; and &lt;answer&gt; &lt;/answer&gt; to separate reasoning from the final answer.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Draft personalized emails to donors asking for contributions to this yearâ€™s Care for Kids program.</span><br><span class="line"></span><br><span class="line">Program information:</span><br><span class="line">&lt;program&gt;&#123;&#123;PROGRAM_DETAILS&#125;&#125;</span><br><span class="line">&lt;/program&gt;</span><br><span class="line"></span><br><span class="line">Donor information:</span><br><span class="line">&lt;donor&gt;&#123;&#123;DONOR_DETAILS&#125;&#125;</span><br><span class="line">&lt;/donor&gt;</span><br><span class="line"></span><br><span class="line">Think before you write the email in &lt;thinking&gt; tags. First, think through what messaging might appeal to this donor given their donation history and which campaigns theyâ€™ve supported in the past. Then, think through what aspects of the Care for Kids program would appeal to them, given their history. Finally, write the personalized donor email in &lt;email&gt; tags, using your analysis.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Use code (e.g. extract from <code>&lt;answer&gt;</code> tags) to extract the desired answer from the LLMâ€™s response</p>
</blockquote>
</li>
</ul>
<br>
<h4 id="Self-Consistency-Prompting">Self-Consistency Prompting</h4>
<p>Self-Consistency Prompting æ˜¯ Chain-of-Thought çš„ä¸€ç§å¢å¼ºç­–ç•¥ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨é¢å¯¹å¤æ‚æ¨ç†é—®é¢˜æ—¶ï¼Œé€šè¿‡ç”Ÿæˆå¤šä¸ªä¸åŒçš„æ¨ç†è·¯å¾„ï¼ˆå¤šæ¬¡ç”Ÿæˆï¼‰ï¼Œç„¶åå¯¹è¿™äº›è·¯å¾„çš„æœ€ç»ˆç»“æœè¿›è¡ŒæŠ•ç¥¨æˆ–æ±‡æ€»ï¼Œä»¥æé«˜ç­”æ¡ˆçš„å¯é æ€§å’Œç¨³å®šæ€§ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äºä¸€é“æ•°å­¦é¢˜ï¼Œæ¨¡å‹å¯èƒ½åœ¨ä¸åŒå°è¯•ä¸­ç»™å‡ºä¸åŒçš„æ€è·¯æˆ–ç­”æ¡ˆï¼Œä½†é€šè¿‡â€œå¤šæ•°æŠ•ç¥¨â€å¯ä»¥è·å¾—æ›´ä¸€è‡´ã€å‡†ç¡®çš„ç»“æœã€‚</p>
<blockquote>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>ç”Ÿæˆ5æ¡ä¸åŒçš„æ¨ç†è·¯å¾„</li>
<li>æ±‡æ€»5ä¸ªæœ€ç»ˆç­”æ¡ˆ</li>
<li>é€‰æ‹©å‡ºç°é¢‘ç‡æœ€é«˜çš„ä¸€ä¸ªä½œä¸ºæœ€ç»ˆè¾“å‡º</li>
</ul>
</blockquote>
<p>è¿™ç§æ–¹æ³•ç‰¹åˆ«é€‚åˆå¯¹å•æ¬¡è¾“å‡ºä¸å¤Ÿç¨³å®šçš„ä»»åŠ¡ï¼Œæ¯”å¦‚å¤æ‚é€»è¾‘ã€æ•°å­¦é¢˜ç­‰åœºæ™¯ã€‚</p>
<br>
<h4 id="Retrieval-Augmented-Generation-RAG">Retrieval-Augmented Generation (RAG)</h4>
<p>RAG æ˜¯å°†å¤–éƒ¨çŸ¥è¯†æ£€ç´¢æœºåˆ¶ï¼ˆå¦‚æ–‡æ¡£ã€æ•°æ®åº“ã€æœç´¢å¼•æ“ï¼‰ä¸è¯­è¨€æ¨¡å‹ç”Ÿæˆèƒ½åŠ›ç»“åˆèµ·æ¥çš„ä¸€ç§æ–¹æ³•ã€‚æ¨¡å‹åœ¨å›ç­”é—®é¢˜å‰ï¼Œä¼šå…ˆâ€œæ£€ç´¢â€ç›¸å…³å†…å®¹ï¼Œå†åŸºäºæ£€ç´¢ç»“æœç”Ÿæˆç­”æ¡ˆã€‚</p>
<p>è¿™ç§æ–¹æ³•å…‹æœäº†å¤§æ¨¡å‹â€œè®°å¿†æœ‰é™â€çš„é—®é¢˜ï¼Œå°¤å…¶åœ¨å¤„ç†éœ€è¦æ—¶æ•ˆæ€§æˆ–ç‰¹å®šèƒŒæ™¯çŸ¥è¯†çš„ä»»åŠ¡æ—¶éå¸¸æœ‰æ•ˆã€‚</p>
<blockquote>
<p><strong>ç¤ºä¾‹æµç¨‹</strong>ï¼š</p>
<ol>
<li>ç”¨æˆ·æé—®ï¼šâ€œè¯·è§£é‡Šä»€ä¹ˆæ˜¯é‡å­çº ç¼ ï¼Ÿâ€</li>
<li>æ¨¡å‹è°ƒç”¨æ£€ç´¢æ¨¡å—ï¼Œä»çŸ¥è¯†åº“æˆ–ç½‘ç»œä¸­æ‰¾åˆ°é«˜ç›¸å…³èµ„æ–™</li>
<li>åŸºäºèµ„æ–™ï¼Œç”Ÿæˆç¬¦åˆä¸Šä¸‹æ–‡ã€å‡†ç¡®å¯é çš„å›ç­”</li>
</ol>
</blockquote>
<p>RAG é€‚ç”¨äºé—®ç­”ç³»ç»Ÿã€çŸ¥è¯†å¯†é›†å‹å¯¹è¯ç³»ç»Ÿã€ä¼ä¸šå†…éƒ¨çŸ¥è¯†åº“åº”ç”¨ç­‰åœºæ™¯ã€‚</p>
<br>
<h3 id="Medprompt">Medprompt</h3>
<p>MedPrompt is composed of the following prompting techniques:</p>
<ul>
<li>Dynamic few-shot selection: instead of using static few-shot examples, Medprompt selects few-shot examples dynamically based on the question.</li>
<li>Self-generated chain of thought.</li>
<li>Choice shuffle ensembling: performs choice shuffle and self-consistency prompting.</li>
</ul>
<img src="/2025/04/21/AI-Agent/Medqa-comp.png" class="" title="img">
<h2 id="å…¶ä»–">å…¶ä»–</h2>
<h3 id="RAGæ€»ç»“">RAGæ€»ç»“</h3>
<p><a href="https://holistic-authority-5c2.notion.site/RAG-1e3f66b636ba80f1b425dc15d7fae04c">https://holistic-authority-5c2.notion.site/RAG-1e3f66b636ba80f1b425dc15d7fae04c</a></p>
<h3 id="Cursorå®ç°æ¯ç§’-1000-tokens-çš„æ–‡ä»¶ç¼–è¾‘">Cursorå®ç°æ¯ç§’ 1000 tokens çš„æ–‡ä»¶ç¼–è¾‘</h3>
<p><a href="https://web.archive.org/web/20240605010559/https://www.cursor.com/blog/instant-apply">https://web.archive.org/web/20240605010559/https://www.cursor.com/blog/instant-apply</a></p>
<p>ç¬¬ä¸€é˜¶æ®µ - è§„åˆ’ï¼ˆPlanningï¼‰ï¼šä½¿ç”¨ GPT æˆ– Claude ç­‰å¼ºå¤§æ¨¡å‹ é€šè¿‡èŠå¤©ç•Œé¢ç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œåˆ¶å®šç¼–è¾‘è®¡åˆ’</p>
<p>ç¬¬äºŒé˜¶æ®µ - ä»£ç ç”Ÿæˆï¼ˆCode Generationï¼‰ï¼šåŒæ ·ä½¿ç”¨ Claude/GPT ç­‰å¤§æ¨¡å‹ æ ¹æ®è§„åˆ’ç”Ÿæˆå…·ä½“çš„ä»£ç å†…å®¹å’Œç¼–è¾‘æŒ‡ä»¤ è¾“å‡ºç±»ä¼¼&quot;åœ¨è¿™ä¸ªä½ç½®æ·»åŠ è¿™æ®µä»£ç &quot;çš„è¯¦ç»†å˜æ›´æè¿°</p>
<p>ç¬¬ä¸‰é˜¶æ®µ - å¿«é€Ÿåº”ç”¨ï¼ˆFast Applyï¼‰ï¼šä½¿ç”¨ Cursor è‡ªå·±è®­ç»ƒçš„ Llama-3-70b-ft æ¨¡å‹ ä¸“é—¨è´Ÿè´£å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ä»£ç å˜æ›´å¿«é€Ÿã€å‡†ç¡®åœ°åº”ç”¨åˆ°å®é™…æ–‡ä»¶ä¸­ é€šè¿‡ speculative edits æŠ€æœ¯å®ç° ~1000 tokens/ç§’çš„æ–‡ä»¶é‡å†™é€Ÿåº¦</p>
<p>å…³é”®ç‚¹ï¼šå‰ä¸¤ä¸ªé˜¶æ®µï¼šClaude/GPT è´Ÿè´£æ€è€ƒå’Œç”Ÿæˆä»£ç å†…å®¹ ç¬¬ä¸‰ä¸ªé˜¶æ®µï¼šCursor è‡ªè®­ç»ƒæ¨¡å‹è´Ÿè´£é«˜é€Ÿæ‰§è¡Œæ–‡ä»¶æ“ä½œ</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦ç¬¬ä¸‰é˜¶æ®µçš„ä¸“é—¨æ¨¡å‹ï¼Ÿ 1. é€Ÿåº¦ç“¶é¢ˆï¼šClaude/GPT åœ¨æ–‡ä»¶ç¼–è¾‘æ—¶å¤ªæ…¢ï¼Œä¼šæ‰“æ–­ç¼–ç¨‹æµç¨‹ 2. æŠ€æœ¯é™åˆ¶ï¼šæ— æ³•åœ¨ç¬¬ä¸‰æ–¹ API ä¸­å®ç° speculative edits ä¼˜åŒ– 3. å‡†ç¡®æ€§é—®é¢˜ï¼šå¤§æ¨¡å‹åœ¨ diff æ ¼å¼ä¸Šå®¹æ˜“å‡ºé”™ï¼Œç»å¸¸æœ‰è¯­æ³•é”™è¯¯æˆ–&quot;æ‡’æƒ°&quot;è¡Œä¸º 4. æˆæœ¬æ§åˆ¶ï¼šé¿å…æ¯æ¬¡æ–‡ä»¶æ“ä½œéƒ½è°ƒç”¨æ˜‚è´µçš„å•†ä¸š API è¿™ç§è®¾è®¡è®©å¤§æ¨¡å‹ä¸“æ³¨äºå®ƒä»¬æ“…é•¿çš„æ¨ç†å’Œä»£ç ç”Ÿæˆï¼Œè€Œè®©ä¸“é—¨ä¼˜åŒ–çš„æ¨¡å‹å¤„ç†ç²¾ç¡®ã€é«˜é€Ÿçš„æ–‡ä»¶ç¼–è¾‘æ“ä½œã€‚</p>
<br>
<h3 id="å¹»è§‰å¤„ç†">å¹»è§‰å¤„ç†</h3>
<p><a href="https://cvs-health.github.io/uqlm/latest/index.html">https://cvs-health.github.io/uqlm/latest/index.html</a></p>
<p>é»‘ç›’è¯„åˆ†å™¨</p>
<img src="/2025/04/21/AI-Agent/black_box_graphic.png" class="" title="_images&#x2F;black_box_graphic.png">
<p>ç™½ç›’è¯„åˆ†å™¨</p>
<img src="/2025/04/21/AI-Agent/white_box_graphic.png" class="" title="_images&#x2F;white_box_graphic.png">
<p>LLMè¯„åˆ†</p>
<img src="/2025/04/21/AI-Agent/judges_graphic.png" class="" title="_images&#x2F;judges_graphic.png">
<p>é›†æˆè¯„åˆ†å™¨</p>
<img src="/2025/04/21/AI-Agent/uqensemble_generate_score.png" class="" title="_images&#x2F;uqensemble_generate_score.png">
<br>
<p>GPTè®°å¿†</p>
<p>ref: <a href="https://macro.com/app/md/54115a42-3409-4f5b-9120-f144d3ecd23a">https://macro.com/app/md/54115a42-3409-4f5b-9120-f144d3ecd23a</a></p>
<img src="/2025/04/21/AI-Agent/GsmyMNLasAQ_DY6" class="" title="img">
<img src="/2025/04/21/AI-Agent/GsmySEdaQAACdBZ" class="" title="img">
<br>]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>Python, Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Database-Learning-Record</title>
    <url>/2024/08/10/Database-Learning-Record/</url>
    <content><![CDATA[<p>MySQLå’ŒRedisæ•°æ®åº“ç›¸å…³å­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>Database Learning Record</h1>
<h2 id="SQL">SQL</h2>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="operator">&lt;</span>cte_name<span class="operator">&gt;</span> <span class="keyword">AS</span> ( <span class="operator">&lt;</span>cte_query<span class="operator">&gt;</span> ) [, <span class="operator">&lt;</span>cte_name<span class="operator">&gt;</span> <span class="keyword">AS</span> ( <span class="operator">&lt;</span>cte_query<span class="operator">&gt;</span> )]...  <span class="comment">-- Common Table Expressions (å¯é€‰)</span></span><br><span class="line"><span class="keyword">SELECT</span> [<span class="keyword">DISTINCT</span> <span class="operator">|</span> <span class="keyword">ALL</span>] <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span>  <span class="comment">-- é€‰æ‹©å“ªäº›åˆ—</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> <span class="operator">|</span> <span class="operator">&lt;</span>view_name<span class="operator">&gt;</span> <span class="operator">|</span> <span class="operator">&lt;</span>joined_tables<span class="operator">&gt;</span>  <span class="comment">-- ä»å“ªä¸ªè¡¨/è§†å›¾/è¿æ¥ç»“æœä¸­é€‰æ‹©</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="operator">&lt;</span>search_condition<span class="operator">&gt;</span>  <span class="comment">-- è¿‡æ»¤è¡Œ</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>grouping_columns<span class="operator">&gt;</span>  <span class="comment">-- åˆ†ç»„è¡Œ</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="operator">&lt;</span>group_condition<span class="operator">&gt;</span>  <span class="comment">-- è¿‡æ»¤åˆ†ç»„åçš„è¡Œ</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>ordering_columns<span class="operator">&gt;</span> [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]  <span class="comment">-- æ’åºç»“æœ</span></span><br><span class="line">LIMIT <span class="operator">&lt;</span>row_count<span class="operator">&gt;</span> <span class="keyword">OFFSET</span> <span class="operator">&lt;</span><span class="keyword">offset</span><span class="operator">&gt;</span>  <span class="comment">-- é™åˆ¶è¿”å›çš„è¡Œæ•° (æŸäº›æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„è¯­æ³•ï¼Œä¾‹å¦‚ TOP)</span></span><br><span class="line"><span class="keyword">UNION</span> [<span class="keyword">ALL</span>] <span class="operator">&lt;</span>another_select_statement<span class="operator">&gt;</span>  <span class="comment">-- åˆå¹¶å¤šä¸ªæŸ¥è¯¢ç»“æœ (å¯é€‰)</span></span><br><span class="line"><span class="keyword">INTERSECT</span> <span class="operator">&lt;</span>another_select_statement<span class="operator">&gt;</span>  <span class="comment">-- è¿”å›å¤šä¸ªæŸ¥è¯¢ç»“æœçš„äº¤é›† (å¯é€‰)</span></span><br><span class="line"><span class="keyword">EXCEPT</span> <span class="operator">|</span> MINUS <span class="operator">&lt;</span>another_select_statement<span class="operator">&gt;</span>  <span class="comment">-- è¿”å›ç¬¬ä¸€ä¸ªæŸ¥è¯¢ç»“æœä¸­å­˜åœ¨ä½†ç¬¬äºŒä¸ªæŸ¥è¯¢ç»“æœä¸­ä¸å­˜åœ¨çš„è¡Œ (å¯é€‰)</span></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">UPDATE</span> [<span class="keyword">OF</span> <span class="operator">&lt;</span>column_list<span class="operator">&gt;</span>]  <span class="comment">-- é”å®šé€‰å®šçš„è¡Œä»¥è¿›è¡Œæ›´æ–° (å¯é€‰)</span></span><br></pre></td></tr></table></figure>
<p>é¡ºåºï¼š</p>
<p>1.FROM è·å¾—è¡¨æ ¼ï¼ˆåœ¨æ­¤å¤„è¿›è¡ŒJOINè”ç»“è¡¨ä¸è¡¨ï¼‰</p>
<p>2.WHERE ç­›é€‰è¡Œ</p>
<p>3.GROUP å°†è¡Œç»„æˆç»„</p>
<p>4.HAVING äºŒæ¬¡è¿‡æ»¤</p>
<p>5.ORDER BYæ’åº</p>
<p>â€¦</p>
<p>-1. SELECT ç¡®å®šè¿”å›åˆ—</p>
<p><strong>WHERE</strong></p>
<blockquote>
<p>whereå¯ä»¥ç­›æŸ¥ç¬¦åˆç›®æ ‡çš„è¡Œï¼Œ<strong>è¢«ç­›åˆ—å¯ä»¥ä¸åœ¨selectä¸­</strong></p>
<p>whereç¡®å®šè¾“å…¥æ•°æ®è¡Œï¼Œselectç¡®å®šè¿”å›åˆ—</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> device_id <span class="keyword">FROM</span> user_profile <span class="keyword">WHERE</span> gpa <span class="operator">&gt;</span> <span class="number">3.5</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>æ¯”è¾ƒè¿ç®—ç¬¦:</strong></p>
<ul>
<li><strong><code>=</code>:</strong> ç­‰äº</li>
<li><strong><code>!=</code> æˆ– <code>&lt;&gt;</code>:</strong> ä¸ç­‰äº</li>
<li><strong><code>&gt;</code>:</strong> å¤§äº</li>
<li><strong><code>&lt;</code>:</strong> å°äº</li>
<li><strong><code>&gt;=</code>:</strong> å¤§äºç­‰äº</li>
<li><strong><code>&lt;=</code>:</strong> å°äºç­‰äº</li>
</ul>
<p>ç¤ºä¾‹:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">50000</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> category <span class="operator">=</span> <span class="string">&#x27;Electronics&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><strong>é€»è¾‘è¿ç®—ç¬¦:</strong></p>
<ul>
<li><strong><code>AND</code>:</strong> ä¸¤ä¸ªæ¡ä»¶éƒ½å¿…é¡»ä¸ºçœŸ</li>
<li><strong><code>OR</code>:</strong> è‡³å°‘ä¸€ä¸ªæ¡ä»¶ä¸ºçœŸ</li>
<li><strong><code>NOT</code>:</strong>  å–åæ¡ä»¶</li>
</ul>
<p>ç¤ºä¾‹:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department <span class="operator">=</span> <span class="string">&#x27;Sales&#x27;</span> <span class="keyword">AND</span> salary <span class="operator">&gt;</span> <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> category <span class="operator">=</span> <span class="string">&#x27;Electronics&#x27;</span> <span class="keyword">OR</span> category <span class="operator">=</span> <span class="string">&#x27;Books&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> customers <span class="keyword">WHERE</span> <span class="keyword">NOT</span> country <span class="operator">=</span> <span class="string">&#x27;USA&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><strong><code>BETWEEN</code> è¿ç®—ç¬¦:</strong></p>
<p>æ£€æŸ¥å€¼æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…ã€‚</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> order_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2023-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2023-12-31&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><strong><code>LIKE</code> è¿ç®—ç¬¦:</strong></p>
<p>ç”¨äºæ¨¡å¼åŒ¹é…ã€‚</p>
<blockquote>
<p>SQL <code>LIKE</code> è¿ç®—ç¬¦ç”¨äºæ¨¡å¼åŒ¹é…ï¼Œå…è®¸ä½ æœç´¢åŒ…å«ç‰¹å®šå­—ç¬¦åºåˆ—çš„æ•°æ®ã€‚<code>LIKE</code> è¿ç®—ç¬¦é€šå¸¸ä¸é€šé…ç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œä»¥åˆ›å»ºæ›´çµæ´»çš„æœç´¢æ¨¡å¼ã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„ <code>LIKE</code> é€šé…ç¬¦ï¼š</p>
<ul>
<li>
<p><strong><code>%</code> (ç™¾åˆ†å·):</strong> åŒ¹é…ä»»æ„å­—ç¬¦åºåˆ—ï¼ˆåŒ…æ‹¬ç©ºåºåˆ—ï¼‰ã€‚å®ƒå¯ä»¥ç”¨äºåŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ã€ç»“å°¾æˆ–ä¸­é—´çš„ä»»æ„éƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>ç¤ºä¾‹:</strong>
<ul>
<li><code>LIKE 'A%'</code>: åŒ¹é…ä»¥ â€œAâ€ å¼€å¤´çš„ä»»ä½•å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œAppleâ€ã€â€œAirplaneâ€ã€â€œAâ€ã€‚</li>
<li><code>LIKE '%e'</code>: åŒ¹é…ä»¥ â€œeâ€ ç»“å°¾çš„ä»»ä½•å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œAppleâ€ã€â€œOrangeâ€ã€â€œeâ€ã€‚</li>
<li><code>LIKE '%app%'</code>: åŒ¹é…åŒ…å« â€œappâ€ çš„ä»»ä½•å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œAppleâ€ã€â€œApplicationâ€ã€â€œHappyâ€ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>_</code> (ä¸‹åˆ’çº¿):</strong> åŒ¹é…ä»»ä½•å•ä¸ªå­—ç¬¦ã€‚</p>
<ul>
<li><strong>ç¤ºä¾‹:</strong>
<ul>
<li><code>LIKE 'A_'</code>: åŒ¹é…ä»¥ â€œAâ€ å¼€å¤´ä¸”åé¢è·Ÿç€ä¸€ä¸ªä»»æ„å­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œAbâ€ã€â€œAcâ€ã€â€œA1â€ã€‚</li>
<li><code>LIKE '_pple'</code>: åŒ¹é…ä»¥ä»»æ„å­—ç¬¦å¼€å¤´ä¸”åé¢è·Ÿç€ â€œppleâ€ çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œAppleâ€ã€â€œippleâ€ã€‚</li>
<li><code>LIKE 'a__le'</code>: åŒ¹é…ä»¥ â€œaâ€ å¼€å¤´ï¼Œåé¢è·Ÿç€ä¸¤ä¸ªä»»æ„å­—ç¬¦ï¼Œå†è·Ÿç€ â€œleâ€ çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œappleâ€ã€â€œazbleâ€ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>[]</code> (æ–¹æ‹¬å·):</strong> åŒ¹é…æŒ‡å®šé›†åˆä¸­çš„ä»»ä½•å•ä¸ªå­—ç¬¦ã€‚</p>
<ul>
<li><strong>ç¤ºä¾‹:</strong>
<ul>
<li><code>LIKE '[ABC]%'</code>: åŒ¹é…ä»¥ â€œAâ€ã€â€œBâ€ æˆ– â€œCâ€ å¼€å¤´çš„ä»»ä½•å­—ç¬¦ä¸²ã€‚</li>
<li><code>LIKE 'h[aeiou]t'</code>: åŒ¹é… â€œhatâ€ã€â€œhetâ€ã€â€œhitâ€ã€â€œhotâ€ æˆ– â€œhutâ€ã€‚</li>
<li><code>LIKE '[A-Z]%'</code>: åŒ¹é…ä»¥ä»»ä½•å¤§å†™å­—æ¯å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>[^]</code> (æ–¹æ‹¬å·åŠ è„±å­—ç¬¦):</strong> åŒ¹é…ä¸åœ¨æŒ‡å®šé›†åˆä¸­çš„ä»»ä½•å•ä¸ªå­—ç¬¦ã€‚</p>
<ul>
<li><strong>ç¤ºä¾‹:</strong>
<ul>
<li><code>LIKE '[^ABC]%'</code>: åŒ¹é…ä¸ä»¥ â€œAâ€ã€â€œBâ€ æˆ– â€œCâ€ å¼€å¤´çš„ä»»ä½•å­—ç¬¦ä¸²ã€‚</li>
<li><code>LIKE 'h[^aeiou]t'</code>: åŒ¹é…ä»¥ â€œhâ€ å¼€å¤´ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸æ˜¯å…ƒéŸ³å­—æ¯ï¼Œä»¥ â€œtâ€ ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>è½¬ä¹‰å­—ç¬¦:</strong></p>
<p>å¦‚æœéœ€è¦åœ¨ <code>LIKE</code> æ¨¡å¼ä¸­åŒ¹é…é€šé…ç¬¦å­—ç¬¦æœ¬èº«ï¼ˆä¾‹å¦‚ï¼Œä½ æƒ³æŸ¥æ‰¾åŒ…å« â€œ%â€ çš„å­—ç¬¦ä¸²ï¼‰ï¼Œä½ éœ€è¦ä½¿ç”¨è½¬ä¹‰å­—ç¬¦ã€‚ ä½ å¯ä»¥åœ¨ <code>LIKE</code> å­å¥ä¸­ä½¿ç”¨ <code>ESCAPE</code> å…³é”®å­—æ¥æŒ‡å®šè½¬ä¹‰å­—ç¬¦ä¸º<code>!</code>ã€‚</p>
<ul>
<li><strong>ç¤ºä¾‹:</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> product_name <span class="keyword">LIKE</span> <span class="string">&#x27;%10\% off%&#x27;</span>; <span class="comment">-- é”™è¯¯ï¼Œä¼šå°† &quot;%&quot; è§†ä¸ºé€šé…ç¬¦</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> product_name <span class="keyword">LIKE</span> <span class="string">&#x27;%10!% off%&#x27;</span> <span class="keyword">ESCAPE</span> <span class="string">&#x27;!&#x27;</span>;  <span class="comment">-- æ­£ç¡®ï¼Œä½¿ç”¨ &quot;!&quot; ä½œä¸ºè½¬ä¹‰å­—ç¬¦ï¼ŒæŸ¥æ‰¾åŒ…å« &quot;10% off&quot; çš„å­—ç¬¦ä¸²</span></span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>ESCAPE '!'</code>  æŒ‡å®š â€œ!â€ ä½œä¸ºè½¬ä¹‰å­—ç¬¦ã€‚ å› æ­¤ï¼Œ<code>!%</code> è¢«è§£é‡Šä¸ºå­—é¢ä¸Šçš„ â€œ%â€ å­—ç¬¦ï¼Œè€Œä¸æ˜¯é€šé…ç¬¦ã€‚</p>
<p><strong>ç»“åˆä½¿ç”¨:</strong></p>
<ul>
<li><strong>ç¤ºä¾‹:</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> customers <span class="keyword">WHERE</span> email <span class="keyword">LIKE</span> <span class="string">&#x27;[a-z]%@[a-z]%.[a-z]%&#x27;</span>;  <span class="comment">-- åŒ¹é…ç®€å•çš„ç”µå­é‚®ä»¶åœ°å€æ ¼å¼</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong><code>IN</code> è¿ç®—ç¬¦:</strong></p>
<p>æ£€æŸ¥å€¼æ˜¯å¦åœ¨æŒ‡å®šçš„å€¼åˆ—è¡¨ä¸­ã€‚</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> category <span class="keyword">IN</span> (<span class="string">&#x27;Electronics&#x27;</span>, <span class="string">&#x27;Books&#x27;</span>, <span class="string">&#x27;Clothing&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong><code>IS NULL</code> è¿ç®—ç¬¦:</strong></p>
<p>æ£€æŸ¥å€¼æ˜¯å¦ä¸º NULLã€‚</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> customers <span class="keyword">WHERE</span> email <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>
<p><strong><code>IS NOT NULL</code> è¿ç®—ç¬¦:</strong></p>
<p>æ£€æŸ¥å€¼æ˜¯å¦ä¸ä¸º NULLã€‚</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> customers <span class="keyword">WHERE</span> email <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>å…¶ä»–è¿ç®—ç¬¦:</p>
<p>ä¸€äº›æ•°æ®åº“ç³»ç»Ÿè¿˜æ”¯æŒå…¶ä»–è¿ç®—ç¬¦ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><strong><code>EXISTS</code>:</strong> æ£€æŸ¥å­æŸ¥è¯¢æ˜¯å¦è¿”å›ä»»ä½•è¡Œã€‚</li>
<li><strong><code>ANY</code> / <code>SOME</code> / <code>ALL</code>:</strong>  ä¸å­æŸ¥è¯¢ä¸€èµ·ä½¿ç”¨ï¼Œæ¯”è¾ƒå€¼ä¸å­æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰å€¼ã€‚</li>
</ul>
<p><code>GROUP BY [column]</code>:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CustomerID, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> OrderCount</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> CustomerID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> Region, Product, <span class="built_in">SUM</span>(Sales) <span class="keyword">AS</span> TotalSales</span><br><span class="line"><span class="keyword">FROM</span> Sales</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Region, Product;</span><br></pre></td></tr></table></figure>
<p>å½“ä½¿ç”¨ GROUP BY å­å¥æ—¶ï¼ŒSELECT åˆ—è¡¨ä¸­åªèƒ½åŒ…å«ä»¥ä¸‹ä¸¤ç±»åˆ—ï¼š</p>
<ol>
<li>å‡ºç°åœ¨ GROUP BY å­å¥ä¸­çš„åˆ—ã€‚</li>
<li>ä½¿ç”¨èšåˆå‡½æ•°ï¼ˆå¦‚ COUNTã€SUMã€AVGã€MAXã€MIN ç­‰ï¼‰çš„åˆ—ã€‚</li>
</ol>
<p>GROUP BY å­å¥å¯ä»¥æŒ‰å¤šåˆ—è¿›è¡Œåˆ†ç»„ï¼Œ <strong>æ¯ç§ç»„åˆå½¢æˆä¸€è¡Œ</strong>ã€‚</p>
<p><strong>å‡½æ•°</strong></p>
<p><strong>æ ‡é‡å‡½æ•° (Scalar Functions):</strong> æ ‡é‡å‡½æ•°å¯¹æ¯ä¸€è¡Œè¾“å…¥éƒ½è¿”å›ä¸€ä¸ªå•ä¸€çš„å€¼ã€‚ å¤§å¤šæ•°å­—ç¬¦ä¸²å‡½æ•°ã€æ•°å€¼å‡½æ•°ã€æ—¥æœŸå‡½æ•°ä»¥åŠä¸€äº›å…¶ä»–å‡½æ•°ï¼ˆå¦‚ COALESCE å’Œ NULLIFï¼‰éƒ½å±äºæ ‡é‡å‡½æ•°ã€‚</p>
<p><strong>æ•°å€¼å‡½æ•°:</strong></p>
<ul>
<li><strong>ABS:</strong> è¿”å›æ•°å€¼çš„ç»å¯¹å€¼ã€‚</li>
<li><strong>ROUND:</strong> å°†æ•°å€¼å››èˆäº”å…¥åˆ°æŒ‡å®šçš„å°æ•°ä½æ•°ã€‚</li>
<li><strong>TRUNC æˆ– TRUNCATE:</strong> æˆªæ–­æ•°å€¼åˆ°æŒ‡å®šçš„å°æ•°ä½æ•°ã€‚</li>
<li><strong>CEIL æˆ– CEILING:</strong> è¿”å›å¤§äºæˆ–ç­‰äºæŒ‡å®šæ•°å€¼çš„æœ€å°æ•´æ•°ã€‚</li>
<li><strong>FLOOR:</strong> è¿”å›å°äºæˆ–ç­‰äºæŒ‡å®šæ•°å€¼çš„æœ€å¤§æ•´æ•°ã€‚</li>
<li><strong>MOD:</strong> è¿”å›ä¸¤ä¸ªæ•°å€¼ç›¸é™¤çš„ä½™æ•°ã€‚</li>
<li><strong>POWER:</strong> è¿”å›ä¸€ä¸ªæ•°å€¼çš„æŒ‡å®šæ¬¡å¹‚ã€‚</li>
<li><strong>SQRT:</strong> è¿”å›æ•°å€¼çš„å¹³æ–¹æ ¹ã€‚</li>
</ul>
<p><strong>èšåˆå‡½æ•°:</strong>  èšåˆå‡½æ•°å¯¹ä¸€ç»„å€¼è¿›è¡Œè®¡ç®—å¹¶è¿”å›ä¸€ä¸ªå•ä¸€çš„å€¼</p>
<ul>
<li><strong>COUNT:</strong> è®¡ç®—è¡Œæ•°ã€‚
<ul>
<li><strong>COUNT(*):</strong> è®¡ç®—è¡¨ä¸­çš„æ‰€æœ‰è¡Œæ•°ï¼ŒåŒ…æ‹¬åŒ…å« NULL å€¼çš„è¡Œã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯è®¡ç®—è¡¨ä¸­çš„æ€»è¡Œæ•°ã€‚</li>
<li><strong>COUNT(column):</strong> è®¡ç®—æŒ‡å®šåˆ—ä¸­é NULL å€¼çš„è¡Œæ•°ã€‚å¦‚æœæŒ‡å®šåˆ—ä¸­çš„æŸä¸ªå€¼ä¸º NULLï¼Œåˆ™è¯¥è¡Œä¸ä¼šè¢«è®¡å…¥ã€‚</li>
</ul>
</li>
<li><strong>SUM:</strong> è®¡ç®—æ•°å€¼çš„æ€»å’Œã€‚</li>
<li><strong>AVG:</strong> è®¡ç®—æ•°å€¼çš„å¹³å‡å€¼ã€‚</li>
<li><strong>MAX:</strong> è¿”å›æœ€å¤§å€¼ã€‚</li>
<li><strong>MIN:</strong> è¿”å›æœ€å°å€¼ã€‚</li>
</ul>
<p><strong>LIMIT 1:</strong></p>
<p>LIMITçº¦æŸè¿”å›å€¼ç»“æœæ•°é‡</p>
<p><strong>å­æŸ¥è¯¢</strong></p>
<blockquote>
<p>æ¨èä½¿ç”¨å­æŸ¥è¯¢</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> region, total_sales</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> region, <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> total_sales</span><br><span class="line">    <span class="keyword">FROM</span> sales</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> region</span><br><span class="line">) <span class="keyword">AS</span> regional_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_sales <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id, first_name, last_name, salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees);</span><br></pre></td></tr></table></figure>
<p><code>union</code></p>
<p>åˆå¹¶æŸ¥è¯¢ç»“æœ</p>
<ul>
<li><strong>UNION</strong>: ä¼šè‡ªåŠ¨å»é™¤åˆå¹¶ç»“æœé›†ä¸­çš„é‡å¤è¡Œï¼Œåªä¿ç•™å”¯ä¸€çš„è¡Œã€‚ è¿™æ¶‰åŠåˆ°é¢å¤–çš„æ’åºå’Œå»é‡æ“ä½œï¼Œå› æ­¤æ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚</li>
<li><strong>UNION ALL</strong>: ç®€å•åœ°å°†æ‰€æœ‰ SELECT è¯­å¥çš„ç»“æœé›†åˆå¹¶ï¼Œä¿ç•™æ‰€æœ‰è¡Œï¼ŒåŒ…æ‹¬é‡å¤çš„è¡Œã€‚ æ€§èƒ½è¾ƒé«˜ï¼Œå› ä¸ºå®ƒé¿å…äº†å»é‡æ“ä½œã€‚</li>
</ul>
<blockquote>
<p><strong>åˆ—çš„æ•°é‡å¿…é¡»ç›¸åŒ</strong>ï¼š æ‰€æœ‰ SELECT è¯­å¥å¿…é¡»è¿”å›ç›¸åŒæ•°é‡çš„åˆ—ã€‚</p>
<p><strong>å¯¹åº”åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»å…¼å®¹</strong>ï¼š æ¯ä¸ª SELECT è¯­å¥ä¸­å¯¹åº”ä½ç½®çš„åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»å…¼å®¹ï¼ˆå¯ä»¥éšå¼è½¬æ¢ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥åˆå¹¶åˆ°ä¸€ä¸ªåˆ—ä¸­ã€‚</p>
<p><strong>åˆ—åå¯ä»¥ä¸åŒï¼Œä½†ç»“æœé›†ä¼šé‡‡ç”¨ç¬¬ä¸€ä¸ª SELECT è¯­å¥çš„åˆ—å</strong>ï¼š åˆå¹¶åçš„ç»“æœé›†ä¼šä½¿ç”¨ç¬¬ä¸€ä¸ª SELECT è¯­å¥ä¸­çš„åˆ—åä½œä¸ºæœ€ç»ˆçš„åˆ—åã€‚ å¦‚æœéœ€è¦æŒ‡å®šä¸åŒçš„åˆ—åï¼Œå¯ä»¥åœ¨ç¬¬ä¸€ä¸ª SELECT è¯­å¥ä¸­ä½¿ç”¨ AS åˆ«åã€‚</p>
</blockquote>
<h2 id="SQLæ‰§è¡Œæµç¨‹">SQLæ‰§è¡Œæµç¨‹</h2>
<img src="/2024/08/10/Database-Learning-Record/db-mysql-sql-8.png" class="" title="img">
<img src="/2024/08/10/Database-Learning-Record/db-mysql-sql-14.png" class="" title="sqlworkflow">
<p>app ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± è¿æ¥æ•°æ®åº“</p>
<p>æ•°æ®åº“çº¿ç¨‹æ¥æ”¶è¿æ¥ï¼Œå¾—åˆ°sqlè¯­å¥</p>
<p>sqlè¯­å¥è§£æ</p>
<p>sqlè¯­å¥æŸ¥è¯¢ä¼˜åŒ–</p>
<p>æ‰§è¡Œå™¨è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£å»å®Œæˆ SQL çš„æ‰§è¡Œ</p>
<blockquote>
<p>è¿›å…¥å­˜å‚¨å¼•æ“</p>
</blockquote>
<p>MySQLï¼ˆinnodbï¼‰ä¼šå…ˆå»ç¼“å†²æ± ï¼ˆBufferPoolï¼‰ä¸­å»æŸ¥æ‰¾è¿™æ¡æ•°æ®ï¼Œæ²¡æ‰¾åˆ°å°±ä¼šå»ç£ç›˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°å°±ä¼šå°†è¿™æ¡æ•°æ®åŠ è½½åˆ°ç¼“å†²æ± ï¼ˆBufferPoolï¼‰ä¸­</p>
<p>åœ¨åŠ è½½åˆ° Buffer Pool çš„åŒæ—¶ï¼Œä¼šå°†è¿™æ¡æ•°æ®çš„åŸå§‹è®°å½•ä¿å­˜åˆ° undo æ—¥å¿—æ–‡ä»¶ä¸­</p>
<p>innodb ä¼šåœ¨ Buffer Pool ä¸­æ‰§è¡Œæ›´æ–°æ“ä½œ</p>
<p>æ›´æ–°åçš„æ•°æ®ä¼šè®°å½•åœ¨ redo log buffer ä¸­</p>
<p>å®Œæˆä»¥åå°±å¯ä»¥æäº¤äº‹åŠ¡ï¼Œåœ¨æäº¤çš„åŒæ—¶ä¼šåšä»¥ä¸‹ä¸‰ä»¶äº‹</p>
<ul>
<li>å°†redo log bufferä¸­çš„æ•°æ®åˆ·å…¥åˆ° redo log æ–‡ä»¶ä¸­</li>
<li>å°†æœ¬æ¬¡æ“ä½œè®°å½•å†™å…¥åˆ° bin logæ–‡ä»¶ä¸­</li>
<li>å°† bin log æ–‡ä»¶åå­—å’Œæ›´æ–°å†…å®¹åœ¨ bin log ä¸­çš„ä½ç½®è®°å½•åˆ°redo logä¸­ï¼ŒåŒæ—¶åœ¨ redo log æœ€åæ·»åŠ  commit æ ‡è®°</li>
</ul>
<h2 id="property">property</h2>
<h3 id="æ•°æ®åº“äº‹åŠ¡çš„-ACID-ç‰¹æ€§">æ•°æ®åº“äº‹åŠ¡çš„ ACID ç‰¹æ€§</h3>
<p>ACID æ˜¯æ•°æ®åº“äº‹åŠ¡çš„å››ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒä»¬ä¿è¯äº†äº‹åŠ¡çš„å¯é æ€§å’Œä¸€è‡´æ€§ã€‚</p>
<p><strong>1. åŸå­æ€§ (Atomicity)</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> ä¸€ä¸ªäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„æƒ…å†µã€‚</li>
<li><strong>ä½œç”¨:</strong> ä¿è¯æ•°æ®åº“çŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå³ä½¿äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œæ•°æ®åº“ä¹Ÿèƒ½å›æ»šåˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿè¿‡ä¸€æ ·ã€‚</li>
<li><strong>ä¸¾ä¾‹:</strong> è½¬è´¦æ“ä½œéœ€è¦ä»è´¦æˆ· A æ‰£æ¬¾å¹¶å‘è´¦æˆ· B åŠ æ¬¾ï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¿…é¡»ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚å¦‚æœåªæ‰£æ¬¾æˆåŠŸè€ŒåŠ æ¬¾å¤±è´¥ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ul>
<p><strong>2. ä¸€è‡´æ€§ (Consistency)</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“å¿…é¡»ä¿æŒä¸€è‡´çš„çŠ¶æ€ï¼Œæ»¡è¶³æ‰€æœ‰é¢„å®šä¹‰çš„çº¦æŸå’Œè§„åˆ™ã€‚</li>
<li><strong>ä½œç”¨:</strong> ä¿è¯æ•°æ®åº“æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ï¼Œé˜²æ­¢æ•°æ®å‡ºç°é€»è¾‘ä¸Šçš„é”™è¯¯ã€‚</li>
<li><strong>ä¸¾ä¾‹:</strong> é“¶è¡Œè´¦æˆ·çš„ä½™é¢ä¸èƒ½å°äºé›¶ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡å¯¼è‡´è´¦æˆ·ä½™é¢å˜ä¸ºè´Ÿæ•°ï¼Œåˆ™è¯¥äº‹åŠ¡è¿åäº†ä¸€è‡´æ€§çº¦æŸï¼Œæ•°æ®åº“ä¼šå›æ»šäº‹åŠ¡ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§ã€‚</li>
</ul>
<p><strong>3. éš”ç¦»æ€§ (Isolation)</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œå½¼æ­¤ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ï¼Œå°±åƒæ¯ä¸ªäº‹åŠ¡éƒ½æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„ä¸€æ ·ã€‚</li>
<li><strong>ä½œç”¨:</strong> é˜²æ­¢å¹¶å‘äº‹åŠ¡ä¹‹é—´çš„æ•°æ®å†²çªï¼Œä¿è¯æ¯ä¸ªäº‹åŠ¡éƒ½èƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®ã€‚</li>
<li><strong>ä¸¾ä¾‹:</strong> ç”¨æˆ· A å’Œç”¨æˆ· B åŒæ—¶è¯»å–è´¦æˆ· C çš„ä½™é¢ï¼Œç„¶ååˆ†åˆ«è¿›è¡Œè½¬è´¦æ“ä½œã€‚éš”ç¦»æ€§ä¿è¯äº†ç”¨æˆ· A å’Œç”¨æˆ· B çš„æ“ä½œä¸ä¼šç›¸äº’å½±å“ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æ­£ç¡®çš„è´¦æˆ·ä½™é¢ã€‚</li>
</ul>
<p><strong>4. æŒä¹…æ€§ (Durability)</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> ä¸€æ—¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œå…¶å¯¹æ•°æ®åº“çš„ä¿®æ”¹å°†æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</li>
<li><strong>ä½œç”¨:</strong> ä¿è¯æ•°æ®çš„å¯é æ€§å’Œå®‰å…¨æ€§ï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒï¼Œæ•°æ®ä¹Ÿèƒ½æ¢å¤åˆ°æœ€æ–°çŠ¶æ€ã€‚</li>
<li><strong>ä¸¾ä¾‹:</strong> ç”¨æˆ· A æˆåŠŸè½¬è´¦åï¼Œå³ä½¿æ•°æ®åº“çªç„¶æ–­ç”µï¼Œè½¬è´¦æ“ä½œçš„ç»“æœä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œæ•°æ®åº“é‡å¯åï¼Œè´¦æˆ· A å’Œè´¦æˆ· B çš„ä½™é¢ä»ç„¶ä¼šåæ˜ è½¬è´¦åçš„çŠ¶æ€ã€‚</li>
</ul>
<h3 id="éš”ç¦»çº§åˆ«">éš”ç¦»çº§åˆ«</h3>
<p><strong>1. Read Uncommitted (è¯»æœªæäº¤)</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹:</strong> äº‹åŠ¡å¯ä»¥è¯»å–åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ•°æ®ã€‚</li>
<li><strong>é—®é¢˜:</strong>
<ul>
<li><strong>è„è¯» (Dirty Read):</strong> äº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œå¦‚æœäº‹åŠ¡ B å›æ»šï¼Œäº‹åŠ¡ A è¯»å–çš„æ•°æ®å°±æ˜¯æ— æ•ˆçš„ã€‚</li>
</ul>
</li>
<li><strong>åº”ç”¨åœºæ™¯:</strong> å‡ ä¹æ²¡æœ‰å®é™…åº”ç”¨åœºæ™¯ï¼Œå› ä¸ºè„è¯»ä¼šå¯¼è‡´æ•°æ®ä¸¥é‡ä¸ä¸€è‡´ã€‚</li>
</ul>
<p><strong>2. Read Committed (è¯»å·²æäº¤)</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹:</strong> äº‹åŠ¡åªèƒ½è¯»å–åˆ°å…¶ä»–å·²æäº¤äº‹åŠ¡çš„æ•°æ®ã€‚</li>
<li><strong>é—®é¢˜:</strong>
<ul>
<li><strong>ä¸å¯é‡å¤è¯» (Non-repeatable Read):</strong> åŒä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œè¯»å–åˆ°çš„ç»“æœå¯èƒ½ä¸åŒï¼Œå› ä¸ºå…¶ä»–äº‹åŠ¡å¯èƒ½å·²ç»ä¿®æ”¹å¹¶æäº¤äº†è¯¥æ•°æ®ã€‚</li>
</ul>
</li>
<li><strong>åº”ç”¨åœºæ™¯:</strong> å¤§å¤šæ•°æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œå¯ä»¥é¿å…è„è¯»ï¼Œä½†å­˜åœ¨ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚</li>
</ul>
<p><strong>3. Repeatable Read (å¯é‡å¤è¯»)</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹:</strong> åŒä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œè¯»å–åˆ°çš„ç»“æœç›¸åŒï¼Œå³ä½¿å…¶ä»–äº‹åŠ¡å·²ç»ä¿®æ”¹å¹¶æäº¤äº†è¯¥æ•°æ®ã€‚</li>
<li><strong>é—®é¢˜:</strong>
<ul>
<li><strong>å¹»è¯» (Phantom Read):</strong> äº‹åŠ¡ A è¯»å–æŸä¸ªèŒƒå›´çš„æ•°æ®ï¼Œäº‹åŠ¡ B åœ¨è¯¥èŒƒå›´å†…æ’å…¥æˆ–åˆ é™¤äº†æ•°æ®ï¼Œå¯¼è‡´äº‹åŠ¡ A å†æ¬¡è¯»å–æ—¶ï¼Œå‘ç°ç»“æœé›†å‘ç”Ÿäº†å˜åŒ–ã€‚</li>
</ul>
</li>
<li><strong>åº”ç”¨åœºæ™¯:</strong> MySQL InnoDB å¼•æ“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œå¯ä»¥é¿å…è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å­˜åœ¨å¹»è¯»çš„é—®é¢˜ã€‚</li>
</ul>
<p><strong>4. Serializable (ä¸²è¡ŒåŒ–)</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹:</strong> æ‰€æœ‰äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œç›¸å½“äºåªæœ‰ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œï¼Œé¿å…äº†æ‰€æœ‰å¹¶å‘é—®é¢˜ã€‚</li>
<li><strong>é—®é¢˜:</strong> å¹¶å‘æ€§èƒ½æä½ï¼Œå› ä¸ºæ‰€æœ‰äº‹åŠ¡éƒ½éœ€è¦æ’é˜Ÿæ‰§è¡Œã€‚</li>
<li><strong>åº”ç”¨åœºæ™¯:</strong> å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼Œä¾‹å¦‚é‡‘èäº¤æ˜“ã€‚</li>
</ul>
<h2 id="MVCC">MVCC</h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<p>äº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°ï¼šé€šè¿‡å‘<strong>æ™®é€šè¡Œ</strong>å¼•å…¥éšè—åˆ—çš„æ–¹å¼å®ç°</p>
<p>UNDO Log</p>
<ul>
<li><strong>é’ˆå¯¹å•ä¸ªè¡Œçš„undo logï¼š</strong> å¯¹äºæ•°æ®åº“çš„æ¯ä¸€è¡Œæ•°æ®ï¼ŒUNDOæ—¥å¿—ä¼šè®°å½•å¯¹è¯¥è¡Œæ•°æ®çš„æ¯ä¸€æ¬¡ä¿®æ”¹ä¹‹å‰çš„å€¼ï¼Œæ¯”å¦‚é’ˆå¯¹æŸè¡Œæ•°æ®çš„UPDATEæ“ä½œï¼Œä¼šè®°å½•ä¿®æ”¹ä¹‹å‰è¯¥è¡Œæ•°æ®çš„å®Œæ•´å†…å®¹ã€‚è¿™äº›UNDOæ—¥å¿—æ¡ç›®ä¼šé€šè¿‡ç±»ä¼¼é“¾è¡¨çš„æ–¹å¼è¿æ¥èµ·æ¥ã€‚ æ–°çš„ä¿®æ”¹äº§ç”Ÿæ–°çš„UNDOæ—¥å¿—æ¡ç›®ï¼ŒæŒ‡å‘ä¹‹å‰çš„UNDOæ—¥å¿—æ¡ç›®ï¼Œå½¢æˆä¸€ä¸ªå†å²é“¾ã€‚</li>
<li><strong>é’ˆå¯¹æ•´ä¸ªäº‹åŠ¡çš„undo logï¼š</strong> å¯¹äºæ•´ä¸ªäº‹åŠ¡æ¥è¯´ï¼Œäº‹åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œä¼šè®°å½•ä¸€ä¸ªç‰¹æ®Šçš„UNDOæ—¥å¿—æ¡ç›®ï¼Œè¿™ä¸ªæ¡ç›®å¯ä»¥ç†è§£ä¸ºæ•´ä¸ªäº‹åŠ¡çš„é“¾è¡¨å¤´ã€‚ äº‹åŠ¡ä¸­ï¼Œæ¯ä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„UNDOæ—¥å¿—æ¡ç›®ä¼šé“¾æ¥åˆ°è¿™ä¸ªé“¾è¡¨ä¸Šã€‚ è¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾è¡¨ï¼ŒæŒ‰ç…§æ“ä½œç›¸åçš„é¡ºåºï¼Œæ’¤é”€äº‹åŠ¡ä¸­æ‰€æœ‰çš„ä¿®æ”¹ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<ol>
<li><strong>å¯¹äº insert æ“ä½œ:</strong>
<ul>
<li>Undo Log ä¼šè®°å½•ä¸‹å¦‚ä½•æ’¤é”€ insert æ“ä½œçš„ä¿¡æ¯ã€‚ é€šå¸¸ï¼Œè¿™ä¼šåŒ…æ‹¬åˆ é™¤åˆšåˆšåˆ›å»ºçš„è¡Œçš„å¿…è¦ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè¡¨åã€è¡Œçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰ã€‚</li>
<li>Undo Log å®é™…ä¸Šå­˜å‚¨çš„æ˜¯åˆ é™¤è¯¥è¡Œçš„æ“ä½œã€‚</li>
</ul>
</li>
<li><strong>å¯¹äº update æ“ä½œ:</strong>
<ul>
<li>Undo Log ä¼šè®°å½•è¢«ä¿®æ”¹è¡Œçš„åŸå§‹å€¼ï¼ˆä¿®æ”¹å‰çš„å®Œæ•´æ•°æ®ï¼‰ã€‚</li>
<li>Undo Log ä¼šè®°å½•ä¿®æ”¹å‘ç”Ÿæ‰€åœ¨çš„è¡¨ã€è¡Œæ ‡è¯†ç¬¦ä»¥åŠè¢«ä¿®æ”¹çš„å­—æ®µã€‚</li>
<li>Undo Log ä¸­ä¼šåŒ…å«æŒ‡å‘å‰ä¸€ä¸ªç‰ˆæœ¬ Undo Log çš„æŒ‡é’ˆï¼Œå½¢æˆä¸€ä¸ªé“¾ã€‚</li>
</ul>
</li>
<li><strong>äº‹åŠ¡çš„é“¾å¼ç»“æ„:</strong>
<ul>
<li>äº‹åŠ¡å¼€å§‹æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª â€œäº‹åŠ¡å¼€å§‹â€ Undo Log æ¡ç›®ã€‚</li>
<li>è¯¥äº‹åŠ¡å†…çš„æ‰€æœ‰ CREATE å’Œ CHANGE æ“ä½œçš„ Undo Log æ¡ç›®éƒ½ä¼šé“¾æ¥åˆ°è¿™ä¸ª â€œäº‹åŠ¡å¼€å§‹â€ æ¡ç›®ï¼Œå½¢æˆä¸€ä¸ªé“¾ã€‚ è¿™ä¸ªé“¾ä¿è¯äº†å¯ä»¥æŒ‰ç…§ç›¸åçš„é¡ºåºæ’¤é”€äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œã€‚</li>
</ul>
</li>
</ol>
<p><a href="https://www.cnblogs.com/cswiki/p/15338928.html">https://www.cnblogs.com/cswiki/p/15338928.html</a></p>
<p>å­—æ®µ</p>
<ul>
<li>DB_TRX_ID: å­˜å‚¨ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡id</li>
<li>DB_ROLL_PTR: æ–°æ•°æ®å­˜å‚¨æŒ‡å‘æ—§æ•°æ®åˆ—çš„æŒ‡é’ˆï¼ˆupdateï¼‰</li>
<li>ROW_ID: æ— ä¸»é”®idæ—¶å¯ç”¨</li>
</ul>
<img src="/2024/08/10/Database-Learning-Record/20210924000726.png" class="" title="img">
<p><strong>ReadViewï¼šåˆ¤æ–­å½“å‰äº‹åŠ¡èƒ½å¤Ÿçœ‹è§å“ªäº›ç‰ˆæœ¬çš„</strong></p>
<ul>
<li><code>m_ids</code>ï¼šç”Ÿæˆ ReadView æ—¶æœ‰å“ªäº›äº‹åŠ¡åœ¨æ‰§è¡Œä½†æ˜¯è¿˜æ²¡æäº¤çš„ï¼ˆç§°ä¸º â€<strong>æ´»è·ƒäº‹åŠ¡</strong>â€œï¼‰ï¼Œè¿™äº›æ´»è·ƒäº‹åŠ¡çš„ id å°±å­˜åœ¨è¿™ä¸ªå­—æ®µé‡Œ</li>
<li><code>min_trx_id</code>ï¼šm_ids é‡Œæœ€å°çš„å€¼ï¼Œ<strong>å½“å‰äº‹åŠ¡å¯åŠ¨æ—¶æœ€å¤§trx_idçš„å·²æäº¤äº‹åŠ¡</strong></li>
<li><code>max_trx_id</code>ï¼šç”Ÿæˆ ReadView æ—¶ä¸‹ä¸€ä¸ªä¼šå¯åŠ¨äº‹åŠ¡çš„ ID çš„å€¼ï¼ˆäº‹åŠ¡ ID æ˜¯é€’å¢åˆ†é…çš„ï¼Œè¶Šåé¢ç”³è¯·çš„äº‹åŠ¡ ID è¶Šå¤§ï¼‰</li>
<li><code>creator_trx_id</code>ï¼šå½“å‰åˆ›å»º ReadView äº‹åŠ¡çš„ ID</li>
</ul>
<p>äº‹åŠ¡A(trx_id = 100)ï¼Œå°äºmin_trx_idï¼Œäº‹åŠ¡Bå¯ä»¥çœ‹è§äº‹åŠ¡Açš„ä¿®æ”¹</p>
<p>äº‹åŠ¡C(trx_id = 300)ï¼Œä½äº(min_trx_id, max_trx_id)ä¹‹ä¸­ï¼Œäº‹åŠ¡Bä¸èƒ½çœ‹è§äº‹åŠ¡Cçš„ä¿®æ”¹ï¼ˆinsertï¼Œupdateï¼‰ï¼Œé€šè¿‡undo logæŸ¥åˆ°å°äºmin_trx_idç‰ˆæœ¬çš„å€¼</p>
<p>äº‹åŠ¡D(trx_id = 500)ï¼Œå¤§äºmax_trx_idï¼Œäº‹åŠ¡Bä¸èƒ½çœ‹è§äº‹åŠ¡Dçš„ä¿®æ”¹</p>
<img src="/2024/08/10/Database-Learning-Record/20210924205057.png" class="" title="img">
<h3 id="MVCCä¸å¹»è¯»">MVCCä¸å¹»è¯»</h3>
<p>é€šè¿‡MVCCå®ç°å¿«ç…§è¯»ï¼ˆselect  * from table where â€¦ï¼‰</p>
<p>é€šè¿‡é—´éš™é”å®ç°å½“å‰è¯»ï¼ˆselect â€¦ for updateï¼‰</p>
<h2 id="MySQL-Struc">MySQL Struc</h2>
<img src="/2024/08/10/Database-Learning-Record/image-20240919111718667.png" class="" title="image-20240919111718667">
<h3 id="åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯</h3>
<p>é¡µ ä½œä¸º Bæ ‘çš„èŠ‚ç‚¹</p>
<p>Bæ ‘çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‡åŒ…å«æ•°æ¡æ•°æ®</p>
<p>é¡µä¸­ è¡Œçš„ä¸»é”®ä½œä¸ºBæ ‘èŠ‚ç‚¹çš„key</p>
<img src="/2024/08/10/Database-Learning-Record/image-20240919155834155.png" class="" title="image-20240919155834155">
<p>B+æ ‘</p>
<p>å°†åŸBæ ‘çš„ <strong>éå¶å­èŠ‚ç‚¹çš„æ•°æ®è¡Œ</strong> å­˜æ”¾åœ¨ <strong>å¶å­èŠ‚ç‚¹</strong>ï¼ŒåŸ <strong>éå¶å­èŠ‚ç‚¹çš„æ•°æ®è¡Œ</strong> æ•°æ®åŒºåŸŸå˜æ›´ä¸ºä¿å­˜ç›®æ ‡é¡µåœ°å€ -&gt; ç¨³å®šæŸ¥è¯¢æ¬¡æ•°</p>
<p><strong>éå¶å­èŠ‚ç‚¹</strong>ç”±äºä¸å†ä¿å­˜çœŸå®æ•°æ®ï¼Œå¯ä¿å­˜æ¡ç›®å¢åŠ  -&gt; æ ‘é«˜åº¦é™ä½</p>
<p>å¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ -&gt; èŒƒå›´æŸ¥è¯¢</p>
<img src="/2024/08/10/Database-Learning-Record/image-20240919160103358.png" class="" title="image-20240919160103358">
<p><strong>Buffer Pool</strong></p>
<p>å­˜å‚¨é¡µ</p>
<h3 id="Undo-Log">Undo Log</h3>
<p><strong>Undo Log åˆ·ç›˜</strong></p>
<p>åœ¨ MySQL ä¸­ï¼Œ<code>UNDO LOG</code> é»˜è®¤æ˜¯å­˜å‚¨åœ¨ <code>InnoDB</code> çš„è¡¨ç©ºé—´ä¸­çš„ï¼Œå…·ä½“æ¥è¯´ï¼Œå®ƒå­˜å‚¨åœ¨ <strong>Undo Tablespace</strong> ä¸­ã€‚<code>UNDO LOG</code> å¹¶ä¸æ˜¯ç›´æ¥å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä¼šå®šæœŸåˆ·ç›˜åˆ°ç£ç›˜ä¸Šï¼Œä»¥ç¡®ä¿äº‹åŠ¡çš„æŒä¹…æ€§å’Œä¸€è‡´æ€§ã€‚</p>
<p>åœ¨ MySQL 5.7 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>UNDO LOG</code> é»˜è®¤å­˜å‚¨åœ¨ç‹¬ç«‹çš„ Undo Tablespace ä¸­ï¼ˆè€Œä¸æ˜¯åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼‰ï¼Œå¹¶ä¸”è¿™äº› Undo Tablespace æ–‡ä»¶ä¼šå®šæœŸåˆ·ç›˜åˆ°ç£ç›˜ä¸Šã€‚</p>
<p><strong>å†…å­˜ä¸­çš„ UNDO LOG å¦‚ä½•æ¸…ç†ï¼Ÿ</strong></p>
<p>å†…å­˜ä¸­çš„ <code>UNDO LOG</code> ä¸»è¦é€šè¿‡ä»¥ä¸‹æœºåˆ¶è¿›è¡Œæ¸…ç†ï¼š</p>
<ol>
<li><strong>äº‹åŠ¡æäº¤æˆ–å›æ»š</strong>ï¼šå½“ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šæ—¶ï¼Œç›¸å…³çš„ <code>UNDO LOG</code> ä¼šè¢«æ ‡è®°ä¸ºå¯æ¸…ç†çŠ¶æ€ã€‚äº‹åŠ¡æäº¤åï¼Œ<code>UNDO LOG</code> ä¸å†éœ€è¦ç”¨äºå›æ»šï¼Œå› æ­¤å¯ä»¥è¢«æ¸…ç†ã€‚</li>
<li><strong>Purge çº¿ç¨‹</strong>ï¼šMySQL æœ‰ä¸€ä¸ªåå°çš„ <strong>Purge çº¿ç¨‹</strong>ï¼Œè´Ÿè´£æ¸…ç†ä¸å†éœ€è¦çš„ <code>UNDO LOG</code>ã€‚Purge çº¿ç¨‹ä¼šå®šæœŸæ‰«æ <code>UNDO LOG</code>ï¼Œå¹¶æ¸…ç†é‚£äº›å·²ç»ä¸å†è¢«ä»»ä½•æ´»åŠ¨äº‹åŠ¡å¼•ç”¨çš„ <code>UNDO LOG</code> è®°å½•ã€‚</li>
<li><strong>Undo Tablespace å›æ”¶</strong>ï¼šå½“ <code>UNDO LOG</code> è¢«æ¸…ç†åï¼Œç›¸å…³çš„ç©ºé—´ä¼šè¢«å›æ”¶ï¼Œä»¥ä¾¿åç»­çš„äº‹åŠ¡å¯ä»¥å¤ç”¨è¿™äº›ç©ºé—´ã€‚MySQL ä¼šè‡ªåŠ¨ç®¡ç† Undo Tablespace çš„å¤§å°ï¼Œç¡®ä¿ä¸ä¼šæ— é™å¢é•¿ã€‚</li>
<li><strong>Undo Log çš„è½®è½¬</strong>ï¼šMySQL ä¼šå®šæœŸè½®è½¬ <code>UNDO LOG</code>ï¼Œå³å½“æŸä¸ª Undo Tablespace ä¸­çš„ <code>UNDO LOG</code> è®°å½•ä¸å†éœ€è¦æ—¶ï¼ŒMySQL ä¼šå°†å…¶æ ‡è®°ä¸ºå¯é‡ç”¨ï¼Œå¹¶åœ¨éœ€è¦æ—¶è¦†ç›–è¿™äº›ç©ºé—´ã€‚</li>
</ol>
<h3 id="redo-log-å’Œ-binlog">redo log å’Œ binlog</h3>
<img src="/2024/08/10/Database-Learning-Record/wal.png" class="" title="img">
<p>äº‹åŠ¡å¼€å§‹æ—¶ï¼Œè®°å½•å¯¹æ•°æ®åº“çš„ä¿®æ”¹ï¼ŒåŒæ—¶å†™å…¥redo logå’ŒUndo logï¼Œå¦‚æœå‘ç”Ÿå´©æºƒï¼Œå¯é€šè¿‡redo logé‡æ”¾æ¢å¤åˆ°å´©æºƒå‰çŠ¶æ€</p>
<p>redo log å’Œ binlog å‡éœ€è¦æŒä¹…åŒ–åˆ°ç£ç›˜</p>
<blockquote>
<p>redo logåœ¨ç£ç›˜ä¸Šæ˜¯é¡ºåºå†™ï¼Œæ•ˆç‡é«˜äºä¿®æ”¹æ•°æ®åç›´æ¥å†™ç£ç›˜æ—¶çš„éšæœºå†™ï¼›</p>
<p>å› æ­¤ï¼Œä¿®æ”¹æ•°æ®ç›´æ¥ä¿®æ”¹ä½äºBuffer Poolä¸­çš„è„é¡µï¼Œé€šè¿‡è¿½åŠ å†™redo logåˆ·ç›˜</p>
</blockquote>
<p>redo logéç›´æ¥å†™å…¥ç£ç›˜ï¼Œç›¸ä¼¼çš„ï¼Œredologå…ˆå†™å…¥redo log bufferï¼Œåœ¨ä»¥ä¸‹æ—¶æœºåˆ·å…¥ç£ç›˜ï¼š</p>
<ul>
<li>MySQLæ­£å¸¸å…³é—­æ—¶åˆ·å…¥ç£ç›˜</li>
<li>å½“redo log bufferä¸­è®°å½•é‡å¤§äºredo log bufferæ€»å®¹é‡çš„ä¸€åŠæ—¶åˆ·å…¥ç£ç›˜</li>
<li>Innodbåå°çº¿ç¨‹æ¯1ç§’æ‰§è¡Œåˆ·å…¥ç£ç›˜</li>
<li>äº‹åŠ¡æäº¤æ—¶åˆ·å…¥ç£ç›˜ï¼ˆå‚æ•°innodb_flush_log_at_trx_commitæ§åˆ¶ï¼‰</li>
</ul>
<p>æ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ä¸ªredo log fileï¼Œredo log bufferåˆ·ç›˜æ—¶ï¼Œç¯å½¢å†™å…¥redo log file0å’Œredo log file1ï¼›</p>
<p>check pointè¡¨ç¤ºbuffer poolä¸­è„é¡µå·²åˆ·ç›˜ï¼Œä¸éœ€è¦é‡æ”¾çš„æ•°æ®ã€‚å¦‚æœwrite posè¿½ä¸Šcheck pointï¼Œåˆ™MySQLä¼šå¼ºåˆ¶æš‚åœå¼€å§‹å°†buffer poolè„é¡µåˆ·ç›˜ï¼›</p>
<img src="/2024/08/10/Database-Learning-Record/checkpoint.png" class="" title="img">
<p>äº‹åŠ¡æ¯æ¡è¯­å¥ä¼šäº§ç”Ÿä¸€æ¡ binlog è®°å½•åˆ° binlog bufferï¼›å½“äº‹åŠ¡æäº¤æ—¶ï¼Œå†™ binlog buffer åˆ°ç£ç›˜ï¼›</p>
<p>binlog åªè®°å½•å¯¹æ•°æ®åº“çš„æ›´æ–°æ“ä½œ</p>
<p><strong>å¯¹æ¯”</strong></p>
<p>é€‚ç”¨å¯¹è±¡</p>
<ul>
<li>binlog æ˜¯ MySQL çš„ Server å±‚å®ç°çš„æ—¥å¿—ï¼Œæ‰€æœ‰å­˜å‚¨å¼•æ“å‡å¯ä½¿ç”¨</li>
<li>redo log æ˜¯ MySQL å­˜å‚¨å¼•æ“å®ç°çš„æ—¥å¿—</li>
</ul>
<p>æ–‡ä»¶æ ¼å¼</p>
<ul>
<li>binlog å­˜åœ¨ 3 ç§æ ¼å¼ï¼šSTATEMENT(ä¿®æ”¹æ“ä½œ), ROW(ä¿®æ”¹ç»“æœ), MIXEDï¼Œä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å½¢å¼</li>
<li>redolog å­˜å‚¨æ‰§è¡Œè¿‡çš„ DML è¯­å¥</li>
</ul>
<p>å†™å…¥æ–¹å¼</p>
<ul>
<li>binlog è¿½åŠ å†™ï¼Œå†™æ»¡äº†åˆ›å»ºæ–°æ–‡ä»¶</li>
<li>redo log å¾ªç¯å†™ï¼Œå†™æ»¡ä»å¤´å¼€å§‹å¾ªç¯</li>
</ul>
<h3 id="ä¸»ç´¢å¼•ä¸è¾…åŠ©ç´¢å¼•"><strong>ä¸»ç´¢å¼•ä¸è¾…åŠ©ç´¢å¼•</strong></h3>
<p><strong>æ˜¯å¦éœ€è¦å»ºç«‹ç´¢å¼•ä»¥åŠåœ¨å“ªäº›åˆ—ä¸Šå»ºç«‹ç´¢å¼•é€šå¸¸ç”±ç¨‹åºå‘˜æ‰‹åŠ¨æŒ‡å®š</strong>ã€‚è™½ç„¶ä¸€äº›æ•°æ®åº“ç³»ç»Ÿï¼ˆå¦‚ MySQLï¼‰å¯èƒ½è‡ªåŠ¨ä¸ºä¸»é”®å’Œå”¯ä¸€é”®åˆ›å»ºç´¢å¼•ï¼Œä½†å…¶ä»–ç´¢å¼•éœ€è¦å¼€å‘äººå‘˜æ ¹æ®å®é™…æŸ¥è¯¢éœ€æ±‚æ¥æ‰‹åŠ¨è®¾è®¡å’Œåˆ›å»ºã€‚</p>
<p>å½“ä¸ºå…¶ä»–åˆ—åˆ›å»ºç´¢å¼•æ—¶ï¼Œ<strong>æ•°æ®åº“ä¼šé¢å¤–åˆ›å»ºä¸€æ£µæ–°çš„ B+ æ ‘</strong>ï¼Œç”¨äºå­˜å‚¨è¯¥åˆ—çš„ç´¢å¼•ç»“æ„ã€‚</p>
<p><strong>åˆ›å»ºè¡¨æ—¶ï¼Œä¸»ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•çš„ç»“æ„ï¼š</strong></p>
<ul>
<li>åœ¨ä½¿ç”¨ InnoDB å­˜å‚¨å¼•æ“æ—¶ï¼š
<ul>
<li>ä¸»ç´¢å¼•å®é™…ä¸Šå°±æ˜¯æ•°æ®æœ¬èº«ï¼Œæ•°æ®æŒ‰ç…§ä¸»é”®çš„é¡ºåºå­˜å‚¨ã€‚</li>
<li>è¾…åŠ©ç´¢å¼•æ˜¯å•ç‹¬çš„ç»“æ„ï¼Œå®ƒå­˜å‚¨äº†å¯¹åº”çš„åˆ—å€¼ï¼ˆå³ç´¢å¼•åˆ—å€¼ï¼‰å’Œä¸»é”®å€¼çš„æ˜ å°„å…³ç³»ã€‚</li>
</ul>
</li>
<li>è¾…åŠ©ç´¢å¼•å¹¶ä¸æ˜¯å•ç‹¬å­˜å‚¨â€œå®Œæ•´æ•°æ®è¡Œâ€ï¼Œå®ƒä»…åŒ…å«è¾…åŠ©ç´¢å¼•åˆ—å’Œä¸»é”®å€¼ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> students (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY, <span class="comment">-- ä¸»ç´¢å¼•</span></span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    age <span class="type">INT</span>,</span><br><span class="line">    INDEX idx_name (name) <span class="comment">-- è¾…åŠ©ç´¢å¼•</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>åœ¨æ­¤è¡¨ä¸­ï¼š</p>
<ul>
<li>ä¸»ç´¢å¼•ï¼š<code>id</code> ç›´æ¥å­˜å‚¨äº†å®Œæ•´çš„æ•°æ®è¡Œã€‚</li>
<li>è¾…åŠ©ç´¢å¼• <code>idx_name</code>ï¼šå­˜å‚¨äº† <code>name</code> åˆ—åŠå…¶å¯¹åº”çš„ä¸»é”®å€¼ <code>id</code>ã€‚</li>
</ul>
<hr>
<p><strong>æŸ¥è¯¢è¿‡ç¨‹ï¼š</strong> å½“æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢æ—¶ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> students <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>MySQL ä½¿ç”¨è¾…åŠ©ç´¢å¼• <code>idx_name</code>ï¼Œæ‰¾åˆ° <code>name = 'Alice'</code> å¯¹åº”çš„ä¸»é”®å€¼ <code>id</code>ï¼ˆå‡å¦‚ä¸º <code>10</code>ï¼‰ã€‚</li>
<li>æ ¹æ®æ‰¾åˆ°çš„ä¸»é”®å€¼ <code>id = 10</code>ï¼Œå†åˆ°ä¸»ç´¢å¼•ï¼ˆå³ä¸»é”® <code>id</code> å¯¹åº”çš„èšç°‡ç´¢å¼•ï¼‰ä¸­æ‰¾åˆ°å®Œæ•´çš„æ•°æ®è¡Œã€‚</li>
</ol>
<p>è¿™ç§è¿‡ç¨‹å«åš <strong>å›è¡¨æ“ä½œ</strong>ï¼Œå› ä¸ºæŸ¥è¯¢å…ˆé€šè¿‡è¾…åŠ©ç´¢å¼•ï¼Œå†â€œå›åˆ°â€ä¸»ç´¢å¼•è·å–æ•°æ®ã€‚</p>
<hr>
<p><strong>ä¸»ç´¢å¼• vs è¾…åŠ©ç´¢å¼•çš„æŸ¥è¯¢æ•ˆç‡</strong></p>
<ul>
<li>å¦‚æœ <code>WHERE</code> å­å¥ä½¿ç”¨ä¸»é”®ï¼ˆå¦‚ <code>id = 10</code>ï¼‰ï¼Œç›´æ¥é€šè¿‡ä¸»ç´¢å¼•æ‰¾åˆ°æ•°æ®è¡Œï¼Œ<strong>æ— éœ€å›è¡¨</strong>ï¼ŒæŸ¥è¯¢æ•ˆç‡æœ€é«˜ã€‚</li>
<li>å¦‚æœ <code>WHERE</code> å­å¥ä½¿ç”¨çš„æ˜¯è¾…åŠ©ç´¢å¼•åˆ—ï¼ˆå¦‚ <code>name = 'Alice'</code>ï¼‰ï¼Œéœ€è¦å›è¡¨æŸ¥æ‰¾å®Œæ•´æ•°æ®è¡Œï¼Œæ•ˆç‡ç›¸å¯¹ç¨ä½ã€‚</li>
<li>å¦‚æœæŸ¥è¯¢åªæ¶‰åŠè¾…åŠ©ç´¢å¼•çš„åˆ—ï¼ˆå¦‚ <code>SELECT name FROM students WHERE name = 'Alice'</code>ï¼‰ï¼ŒMySQL å¯èƒ½ä¼š <strong>è¦†ç›–ç´¢å¼•</strong>ï¼Œç›´æ¥ä»è¾…åŠ©ç´¢å¼•ä¸­è¿”å›ç»“æœï¼Œæ— éœ€å›è¡¨ã€‚</li>
</ul>
<h3 id="è”åˆç´¢å¼•ä¸ä¼˜åŒ–">è”åˆç´¢å¼•ä¸ä¼˜åŒ–</h3>
<p>è”åˆç´¢å¼•æ ¸å¿ƒï¼š</p>
<p>ï¼ˆa,b,cï¼‰aå…¨å±€æœ‰åºï¼Œåœ¨aç›¸åŒçš„æƒ…å†µä¸‹bæœ‰åºï¼Œabç›¸åŒæƒ…å†µä¸‹cæœ‰åº</p>
<p><strong>è”åˆç´¢å¼•</strong>å°†å¤šä¸ªåˆ—çš„å€¼æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œä½œä¸º B+ æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„ <code>key</code>ã€‚æ ‘èŠ‚ç‚¹æŒ‰ç…§ç´¢å¼•åˆ—çš„é¡ºåºå­˜å‚¨ï¼Œå…ˆæ¯”è¾ƒç¬¬ä¸€ä¸ªåˆ—ï¼ˆå³ä¸»åˆ—ï¼‰çš„å€¼ï¼Œå¦‚æœç›¸åŒï¼Œå†æ¯”è¾ƒç¬¬äºŒä¸ªåˆ—çš„å€¼ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<blockquote>
<p>ç´¢å¼•åˆ—çš„é¡ºåºå¾ˆé‡è¦ï¼Œåº”æŒ‰ç…§æŸ¥è¯¢æ¡ä»¶çš„å¸¸ç”¨æ¨¡å¼è®¾è®¡ï¼Œä»¥å……åˆ†åˆ©ç”¨å·¦å‰ç¼€åŸåˆ™ã€‚</p>
<p>å½“b+æ ‘çš„æ•°æ®é¡¹æ˜¯å¤åˆçš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚(name,age,sex)çš„æ—¶å€™ï¼Œb+æ•°æ˜¯æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºæ¥å»ºç«‹æœç´¢æ ‘çš„ï¼Œæ¯”å¦‚å½“(å¼ ä¸‰,20,F)è¿™æ ·çš„æ•°æ®æ¥æ£€ç´¢çš„æ—¶å€™ï¼Œb+æ ‘ä¼šä¼˜å…ˆæ¯”è¾ƒnameæ¥ç¡®å®šä¸‹ä¸€æ­¥çš„æ‰€æœæ–¹å‘ï¼Œå¦‚æœnameç›¸åŒå†ä¾æ¬¡æ¯”è¾ƒageå’Œsexï¼Œæœ€åå¾—åˆ°æ£€ç´¢çš„æ•°æ®ï¼›ä½†å½“(20,F)è¿™æ ·çš„æ²¡æœ‰nameçš„æ•°æ®æ¥çš„æ—¶å€™ï¼Œb+æ ‘å°±ä¸çŸ¥é“ä¸‹ä¸€æ­¥è¯¥æŸ¥å“ªä¸ªèŠ‚ç‚¹ï¼Œå› ä¸ºå»ºç«‹æœç´¢æ ‘çš„æ—¶å€™nameå°±æ˜¯ç¬¬ä¸€ä¸ªæ¯”è¾ƒå› å­ï¼Œå¿…é¡»è¦å…ˆæ ¹æ®nameæ¥æœç´¢æ‰èƒ½çŸ¥é“ä¸‹ä¸€æ­¥å»å“ªé‡ŒæŸ¥è¯¢ã€‚æ¯”å¦‚å½“(å¼ ä¸‰,F)è¿™æ ·çš„æ•°æ®æ¥æ£€ç´¢æ—¶ï¼Œb+æ ‘å¯ä»¥ç”¨nameæ¥æŒ‡å®šæœç´¢æ–¹å‘ï¼Œä½†ä¸‹ä¸€ä¸ªå­—æ®µageçš„ç¼ºå¤±ï¼Œæ‰€ä»¥åªèƒ½æŠŠåå­—ç­‰äºå¼ ä¸‰çš„æ•°æ®éƒ½æ‰¾åˆ°ï¼Œç„¶åå†åŒ¹é…æ€§åˆ«æ˜¯Fçš„æ•°æ®äº†ï¼Œ è¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„æ€§è´¨ï¼Œå³ç´¢å¼•çš„æœ€å·¦åŒ¹é…ç‰¹æ€§ã€‚</p>
<hr>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/db/sql-mysql/sql-mysql-index-improve-mt.html">https://pdai.tech/md/db/sql-mysql/sql-mysql-index-improve-mt.html</a></p>
</blockquote>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<p>å‡è®¾è¡¨ <code>payment</code>ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> payment (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    customer_id <span class="type">INT</span>,</span><br><span class="line">    staff_id <span class="type">INT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºå¤šåˆ—ç´¢å¼•</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_customer_staff <span class="keyword">ON</span> payment (customer_id, staff_id);</span><br></pre></td></tr></table></figure>
<p>ç´¢å¼•å†…å®¹ï¼ˆB+ æ ‘çš„ <code>key</code>ï¼‰å¯èƒ½å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(customer_id, staff_id) -&gt; id</span><br><span class="line">(101, 1) -&gt; 10</span><br><span class="line">(101, 2) -&gt; 11</span><br><span class="line">(102, 1) -&gt; 12</span><br></pre></td></tr></table></figure>
<p><strong>B+ æ ‘èŠ‚ç‚¹å­˜å‚¨ï¼š</strong></p>
<p>æ¯ä¸ªèŠ‚ç‚¹çš„ <code>key</code> æ˜¯ <code>(customer_id, staff_id)</code> çš„ç»„åˆå€¼ï¼Œè€Œ <code>value</code> æ˜¯ä¸»é”® <code>id</code> æˆ–è¡Œçš„ç‰©ç†æŒ‡é’ˆã€‚</p>
<ul>
<li>æ¯”å¦‚å¯¹äº <code>(101, 1)</code>ï¼Œ<code>key</code> æ˜¯ <code>101</code> å’Œ <code>1</code> çš„ç»„åˆï¼Œ<code>value</code> æ˜¯ä¸»é”® <code>id</code> æˆ–è¡Œçš„ç‰©ç†æŒ‡é’ˆã€‚</li>
</ul>
<p><strong>å‰ç¼€ç´¢å¼•</strong></p>
<p>å¯¹äº BLOBã€TEXT å’Œ VARCHAR ç±»å‹çš„åˆ—ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•å¯ä»¥é™ä½ç´¢å¼•çš„å­˜å‚¨ç©ºé—´ï¼ŒåŒæ—¶æå‡æŸ¥è¯¢æ•ˆç‡ã€‚</p>
<ul>
<li>
<p>å…¨åˆ—ç´¢å¼•ï¼ˆç´¢å¼•æ•´ä¸ª <code>email</code> åˆ—ï¼‰å¯èƒ½å ç”¨å¤§é‡ç©ºé—´ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé•¿å­—ç¬¦ä¸²ã€‚</p>
</li>
<li>
<p>å‰ç¼€ç´¢å¼•é€šè¿‡æˆªå–å‰ N ä¸ªå­—ç¬¦ï¼Œæ—¢èƒ½èŠ‚çœç©ºé—´åˆèƒ½åŠ é€ŸåŒ¹é…ã€‚</p>
</li>
<li>
<p>å‰ç¼€é•¿åº¦åº”æ ¹æ®é€‰æ‹©æ€§ç¡®å®šï¼Œé¿å…ç´¢å¼•è¿‡çŸ­å¯¼è‡´å¤§é‡é‡å¤å€¼ã€‚</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å‡è®¾è¡¨ emails ä¸­ email åˆ—ä¸º VARCHAR(255)</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emails (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    content TEXT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºå‰ç¼€ç´¢å¼•</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_email_prefix <span class="keyword">ON</span> emails (email(<span class="number">10</span>)); <span class="comment">-- åªç´¢å¼•å‰ 10 ä¸ªå­—ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emails <span class="keyword">WHERE</span> email <span class="keyword">LIKE</span> <span class="string">&#x27;example%&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>MySQL ä¸ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼š</strong></p>
<ul>
<li>ç´¢å¼•åˆ—è¢«è®¡ç®—æˆ–å‡½æ•°åŒ…è£¹ã€‚</li>
<li>å¤åˆç´¢å¼•ä¸ç¬¦åˆæœ€å·¦å‰ç¼€åŸåˆ™ã€‚</li>
<li>å­˜åœ¨èŒƒå›´æŸ¥è¯¢é˜»æ–­ç´¢å¼•åŒ¹é…ã€‚</li>
<li>åˆ—çš„åŒºåˆ†åº¦è¿‡ä½æˆ–éšå¼ç±»å‹è½¬æ¢ã€‚</li>
</ul>
<p><strong>ç´¢å¼•çš„ä½¿ç”¨åœºæ™¯</strong></p>
<ul>
<li>å¯¹äºéå¸¸å°çš„è¡¨ã€å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç®€å•çš„å…¨è¡¨æ‰«ææ¯”å»ºç«‹ç´¢å¼•æ›´é«˜æ•ˆã€‚</li>
<li>å¯¹äºä¸­åˆ°å¤§å‹çš„è¡¨ï¼Œç´¢å¼•å°±éå¸¸æœ‰æ•ˆã€‚</li>
<li>ä½†æ˜¯å¯¹äºç‰¹å¤§å‹çš„è¡¨ï¼Œå»ºç«‹å’Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·å°†ä¼šéšä¹‹å¢é•¿ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç”¨åˆ°ä¸€ç§æŠ€æœ¯å¯ä»¥ç›´æ¥åŒºåˆ†å‡ºéœ€è¦æŸ¥è¯¢çš„ä¸€ç»„æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¡è®°å½•ä¸€æ¡è®°å½•åœ°åŒ¹é…ï¼Œä¾‹å¦‚å¯ä»¥ä½¿ç”¨åˆ†åŒºæŠ€æœ¯ã€‚</li>
</ul>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/db/sql-mysql/sql-mysql-b-tree.html">https://pdai.tech/md/db/sql-mysql/sql-mysql-b-tree.html</a></p>
<p><strong>è‡ªé€‚åº”å“ˆå¸Œç´¢å¼• (Adaptive Hash Index, AHI)</strong></p>
<ol>
<li><strong>ç›‘æ§çƒ­ç‚¹é¡µ:</strong> InnoDB å¼•æ“ä¼šç›‘æ§ç´¢å¼•é¡µçš„è®¿é—®é¢‘ç‡ã€‚å½“æŸä¸ªç´¢å¼•é¡µè¢«é¢‘ç¹è®¿é—®ï¼Œè¾¾åˆ°é¢„è®¾é˜ˆå€¼åï¼Œä¼šè¢«è®¤ä¸ºæ˜¯çƒ­ç‚¹é¡µã€‚</li>
<li><strong>åˆ›å»ºå“ˆå¸Œç´¢å¼•:</strong> InnoDB å¼•æ“ä¼šè‡ªåŠ¨ä¸ºçƒ­ç‚¹é¡µåˆ›å»ºå“ˆå¸Œç´¢å¼•ï¼Œå¹¶å°†å“ˆå¸Œç´¢å¼•å­˜å‚¨åœ¨å†…å­˜çš„å“ˆå¸Œè¡¨ä¸­ã€‚</li>
<li><strong>åŠ é€ŸæŸ¥è¯¢:</strong> å½“æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼ŒInnoDB å¼•æ“ä¼šå…ˆæŸ¥æ‰¾å“ˆå¸Œç´¢å¼•ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°å¯¹åº”çš„ç´¢å¼•é¡µï¼Œé¿å…äº† B-tree ç´¢å¼•çš„å¤šæ¬¡æŸ¥æ‰¾ï¼Œä»è€Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚</li>
</ol>
<p><strong>Undo Buffer &amp;&amp; Undo Tablespace</strong></p>
<p>Undo Log è®°å½•äº†äº‹åŠ¡ä¸­æ¯ä¸€ä¸ªæ•°æ®ä¿®æ”¹æ“ä½œçš„åå‘æ“ä½œï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>æ’å…¥æ“ä½œçš„ Undo Log è®°å½•äº†åˆ é™¤ç›¸åº”è®°å½•çš„æ“ä½œã€‚</li>
<li>æ›´æ–°æ“ä½œçš„ Undo Log è®°å½•äº†å°†æ•°æ®æ¢å¤åˆ°æ—§å€¼çš„æ“ä½œã€‚</li>
<li>åˆ é™¤æ“ä½œçš„ Undo Log è®°å½•äº†æ’å…¥è¢«åˆ é™¤è®°å½•çš„æ“ä½œã€‚</li>
</ul>
<p><strong>Undo Log</strong> ä¸»è¦ç”¨äºäº‹åŠ¡å›æ»šå’Œå®ç° MVCC</p>
<blockquote>
<p><strong>è¯»å–ä¸€è‡´æ€§ (MVCC)ï¼š</strong> å³ä½¿äº‹åŠ¡ A å·²ç»æäº¤ï¼Œå…¶ä»–æœªæäº¤çš„äº‹åŠ¡æˆ–ä½¿ç”¨äº†å¿«ç…§è¯»çš„äº‹åŠ¡ä»ç„¶å¯èƒ½éœ€è¦è®¿é—®äº‹åŠ¡ A ä¿®æ”¹ä¹‹å‰çš„æ•°æ®ç‰ˆæœ¬ã€‚Undo Log ä¸­ä¿ç•™çš„äº‹åŠ¡ A çš„è®°å½•å¯ä»¥ç”¨æ¥æ„å»ºè¿™äº›æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼Œä¿è¯è¯»å–ä¸€è‡´æ€§ã€‚</p>
</blockquote>
<p>Undo Log å­˜å‚¨åœ¨ Undo Tablespace ä¸­ï¼Œå¯ä»¥é…ç½®ä¸ºç‹¬ç«‹çš„è¡¨ç©ºé—´æˆ– InnoDB ç³»ç»Ÿè¡¨ç©ºé—´çš„ä¸€éƒ¨åˆ†</p>
<p><strong>Redo Log Buffer &amp;&amp;  Redo Log Files</strong></p>
<p>Redo Log è®°å½•äº†æ•°æ®åº“çš„ç‰©ç†ä¿®æ”¹ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>åœ¨å“ªä¸ªæ•°æ®é¡µä¿®æ”¹äº†å“ªä¸ªå­—èŠ‚ï¼Œä¿®æ”¹åçš„å€¼æ˜¯ä»€ä¹ˆã€‚</li>
</ul>
<p>å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œå…ˆå°†ä¿®æ”¹è®°å½•å†™å…¥ Redo Log Buffer, åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œå°† Redo Log Buffer ä¸­çš„å†…å®¹åˆ·æ–°åˆ° Redo Log Files, æ•°æ®åº“å´©æºƒæ¢å¤/å†…å­˜æ‰ç”µæ•°æ®æ¸…ç©ºæ—¶ï¼Œä¼šè¯»å– Redo Log Filesï¼Œé‡æ–°æ‰§è¡Œå…¶ä¸­çš„ä¿®æ”¹æ“ä½œï¼Œå°†æ•°æ®åº“æ¢å¤åˆ°å´©æºƒå‰çš„æœ€æ–°çŠ¶æ€ã€‚</p>
<p><strong>Redo Log çš„ä½œç”¨æ˜¯ä¿è¯å·²æäº¤äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œè€Œä¸æ˜¯æœªæäº¤äº‹åŠ¡çš„æ¢å¤ã€‚</strong></p>
<p>Redo Log å­˜å‚¨åœ¨ Redo Log Files ä¸­ï¼Œé€šå¸¸æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªå¾ªç¯ä½¿ç”¨çš„æ–‡ä»¶ã€‚</p>
<h2 id="MySQLå­˜å‚¨å¼•æ“">MySQLå­˜å‚¨å¼•æ“</h2>
<p>MyISAM å­˜å‚¨å¼•æ“ å’Œ InnoDB å­˜å‚¨å¼•æ“</p>
<p>InnoDB å­˜å‚¨å¼•æ“ï¼š</p>
<ul>
<li>B+æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜æ•°æ®æœ¬èº«ï¼›</li>
<li>æ”¯æŒäº‹åŠ¡ï¼Œå¤–é”®çº¦æŸ</li>
<li>æ›´æ–°å¯†é›†ï¼Œ</li>
</ul>
<blockquote>
<p>å¤–é”®çº¦æŸï¼šåœ¨è¡¨Bä¸­æŒ‡å®šæŸå­—æ®µä¸ºå¤–é”®åï¼ˆè¡¨Açš„ä¸»é”®ï¼‰ï¼Œæ’å…¥æ•°æ®æ—¶å¿…é¡»æ˜¯è¡¨Aä¸­å­˜åœ¨çš„å€¼ï¼›å¤–é”®ä¸ä¸€å®šéè¦å¼•ç”¨å…¶ä»–è¡¨çš„<strong>ä¸»é”®</strong>ã€‚è™½ç„¶é€šå¸¸æƒ…å†µä¸‹ï¼Œå¤–é”®æ˜¯ç”¨æ¥å¼•ç”¨å…¶ä»–è¡¨çš„ä¸»é”®æˆ–å”¯ä¸€çº¦æŸï¼ˆ<code>UNIQUE</code>ï¼‰å­—æ®µï¼Œä½†å¤–é”®å®é™…ä¸Šå¯ä»¥å¼•ç”¨è¡¨ä¸­çš„ä»»ä½•åˆ—ï¼Œåªè¦è¯¥åˆ—å…·æœ‰<strong>å”¯ä¸€æ€§çº¦æŸ</strong>ï¼Œæ¯”å¦‚<code>UNIQUE</code>æˆ–<code>PRIMARY KEY</code>ã€‚</p>
<p>å¦‚æœåœ¨å¤–é”®çº¦æŸä¸­è®¾ç½®äº†çº§è”åˆ é™¤ï¼Œå½“ä½ åœ¨è¡¨Aä¸­åˆ é™¤æŸè¡Œæ—¶ï¼Œè¡¨Bä¸­æ‰€æœ‰å¼•ç”¨è¯¥è¡Œçš„è®°å½•ä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚å¦‚æœåœ¨å¤–é”®çº¦æŸä¸­è®¾ç½®äº†â€œç½®ç©ºâ€æ“ä½œï¼Œå½“ä½ åˆ é™¤è¡¨Aä¸­çš„è®°å½•æ—¶ï¼Œè¡¨Bä¸­æ‰€æœ‰å¼•ç”¨è¯¥è®°å½•çš„å¤–é”®å­—æ®µä¼šè¢«ç½®ä¸º<code>NULL</code>ã€‚è¿™æ„å‘³ç€è¡¨Bä¸­ä¸å†å…³è”ä»»ä½•è¡¨Aä¸­çš„è¡Œï¼Œä½†è¡¨Bä¸­çš„å…¶ä»–æ•°æ®ä»ç„¶å­˜åœ¨ã€‚</p>
</blockquote>
<p>MyISAM å­˜å‚¨å¼•æ“ï¼š</p>
<ul>
<li>B+æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜æ•°æ®çš„ç‰©ç†åœ°å€ï¼›</li>
<li>MyISAMè¡¨æ— æ³•å¤„ç†äº‹åŠ¡</li>
<li>MyISAMå­˜å‚¨å¼•æ“åœ¨ç­›é€‰å¤§é‡æ•°æ®æ—¶éå¸¸è¿…é€Ÿï¼Œå¹¶å‘æ’å…¥ç‰¹æ€§å…è®¸åŒæ—¶é€‰æ‹©å’Œæ’å…¥æ•°æ®ã€‚</li>
</ul>
<h2 id="MySQLä¸»ä»å¤åˆ¶">MySQLä¸»ä»å¤åˆ¶</h2>
<p>MySQLçš„ä¸»ä»å¤åˆ¶ä¸ºBinLog</p>
<img src="/2024/08/10/Database-Learning-Record/master-slave.png" class="" title="mysqlms">
<p>ä¸»è¦æ¶‰åŠä¸‰ä¸ªçº¿ç¨‹: binlog çº¿ç¨‹ã€I/O çº¿ç¨‹å’Œ SQL çº¿ç¨‹ã€‚</p>
<ul>
<li><strong>binlog çº¿ç¨‹</strong> : è´Ÿè´£å°†ä¸»æœåŠ¡å™¨ä¸Šçš„æ•°æ®æ›´æ”¹å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ä¸­ã€‚</li>
<li><strong>I/O çº¿ç¨‹</strong> : è´Ÿè´£ä»ä¸»æœåŠ¡å™¨ä¸Šè¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¹¶å†™å…¥ä»æœåŠ¡å™¨çš„ä¸­ç»§æ—¥å¿—ä¸­ã€‚</li>
<li><strong>SQL çº¿ç¨‹</strong> : è´Ÿè´£è¯»å–ä¸­ç»§æ—¥å¿—å¹¶é‡æ”¾å…¶ä¸­çš„ SQL è¯­å¥ã€‚</li>
</ul>
<p><strong>æµç¨‹</strong></p>
<ol>
<li><strong>ä¸»æ•°æ®åº“</strong>æ¥æ”¶åˆ°ä¸€ä¸ªå†™æ“ä½œï¼ˆå¦‚ INSERTã€UPDATEã€DELETEï¼‰æ—¶ï¼Œä¼šå°†è¿™ä¸ªæ“ä½œè®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary Logï¼‰ä¸­ï¼Œå°†æ•°æ®ä¿®æ”¹çš„æ“ä½œæŒ‰é¡ºåºè®°å½•ä¸‹æ¥ã€‚</li>
<li><strong>ä»æ•°æ®åº“</strong> IO çº¿ç¨‹ä¼šè‡ªåŠ¨è¿æ¥<strong>ä¸»æ•°æ®åº“</strong>ï¼Œä»äºŒè¿›åˆ¶æ—¥å¿—ä¸­è¯»å–æ“ä½œä¿¡æ¯ï¼Œè®°å½•åˆ°ä¸­ç»§æ—¥å¿—ï¼ˆRelay Logï¼‰ä¸­ã€‚</li>
<li>ä»æ•°æ®åº“çš„ SQL çº¿ç¨‹ä¼šå®šæœŸä»ä¸­ç»§æ—¥å¿—ä¸­è·å–åŒæ­¥æ•°æ®ï¼Œå†™å…¥åˆ°ä»æ•°æ®åº“ä¸­ã€‚</li>
</ol>
<p><strong>Bin Log æ—¥å¿—æ ¼å¼</strong></p>
<p>Binary Log äºŒçº§åˆ¶æ—¥å¿—ï¼Œå®ƒæ€»å…±æœ‰ä»¥ä¸‹ä¸‰ç§æ ¼å¼ï¼ˆä¸åŒçš„æ—¥å¿—æ ¼å¼å†³å®šäº†ä¸åŒçš„ä¸»ä»åŒæ­¥æ•ˆæœï¼‰ï¼š</p>
<ol>
<li>STATEMENT æ ¼å¼ï¼ˆè¯­å¥æ¨¡å¼ï¼Œå‡ºç°åœ¨ MySQL 5.1 ä¹‹å‰ï¼‰ï¼šåœ¨è¿™ç§æ ¼å¼ä¸‹ï¼Œbinlog è®°å½•çš„æ˜¯æ‰§è¡Œçš„ SQL è¯­å¥çš„æ–‡æœ¬ã€‚
<ol>
<li>ä¼˜ç‚¹ï¼šæ—¥å¿—æ–‡ä»¶é€šå¸¸è¾ƒå°ï¼Œå¤åˆ¶æ•ˆç‡è¾ƒé«˜ã€‚</li>
<li>ç¼ºç‚¹ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºæ•°æ®åº“ç¯å¢ƒçš„å·®å¼‚ï¼ˆå¦‚è¡¨ç»“æ„ã€å­—ç¬¦é›†ç­‰ï¼‰ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šé‡æ”¾è¿™äº› SQL è¯­å¥å¯èƒ½ä¼šå¯¼è‡´ä¸ä¸€è‡´çš„ç»“æœã€‚ä¾‹å¦‚ï¼Œè·å–å½“å‰æ—¶é—´çš„å‡½æ•°æˆ–å­˜å‚¨è¿‡ç¨‹ç­‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ol>
</li>
<li>ROW æ ¼å¼ï¼ˆè¡Œæ¨¡å¼ï¼Œè¯ç”Ÿäº MySQL 5.1ï¼‰ï¼šåœ¨è¿™ç§æ ¼å¼ä¸‹ï¼Œbinlog è®°å½•çš„æ˜¯æ¯ä¸€è¡Œæ•°æ®æ›´æ”¹çš„å…·ä½“å†…å®¹ã€‚
<ol>
<li>ä¼˜ç‚¹ï¼šèƒ½å¤Ÿç²¾ç¡®åœ°è®°å½•æ•°æ®çš„å˜åŒ–ï¼Œé¿å…äº† STATEMENT æ ¼å¼ä¸­çš„ç¯å¢ƒä¾èµ–é—®é¢˜ï¼Œæä¾›äº†æ›´å¼ºçš„ä¸€è‡´æ€§ä¿è¯ã€‚</li>
<li>ç¼ºç‚¹ï¼šæ—¥å¿—æ–‡ä»¶å¯èƒ½ä¼šæ¯” STATEMENT æ ¼å¼å¤§ï¼Œå› ä¸ºè®°å½•äº†æ¯ä¸€è¡Œçš„è¯¦ç»†å˜åŒ–ã€‚æ­¤å¤–ï¼ŒROW æ ¼å¼çš„æ—¥å¿—åœ¨è¿›è¡Œå¤§é‡æ•°æ®æ›´æ–°æ—¶å¯èƒ½ä¼šå¯¼è‡´æ›´é«˜çš„ I/O å¼€é”€ã€‚</li>
</ol>
</li>
<li>MIXED æ ¼å¼ï¼ˆæ··åˆæ¨¡å¼ï¼‰ï¼šåœ¨è¿™ç§æ ¼å¼ä¸‹ï¼Œbinlog å¯ä»¥æ ¹æ®å…·ä½“çš„ SQL è¯­å¥å’Œæ“ä½œè‡ªåŠ¨é€‰æ‹©ä½¿ç”¨ STATEMENT æˆ– ROW æ ¼å¼ã€‚
<ol>
<li>ä¼˜ç‚¹ï¼šç»“åˆäº† STATEMENT å’Œ ROW æ ¼å¼çš„ä¼˜ç‚¹ï¼Œèƒ½å¤Ÿåœ¨ä¿è¯ä¸€è‡´æ€§çš„åŒæ—¶å°½å¯èƒ½åœ°ä¼˜åŒ–æ—¥å¿—å¤§å°å’Œå¤åˆ¶æ€§èƒ½ã€‚</li>
<li>ç¼ºç‚¹ï¼šç”±äºæ··åˆä½¿ç”¨äº†ä¸¤ç§æ ¼å¼ï¼Œå¯èƒ½éœ€è¦æ›´å¤æ‚çš„ç®¡ç†å’Œç›‘æ§ã€‚åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ï¼ŒMIXED æ ¼å¼å¯èƒ½æ— æ³•è¾¾åˆ°æœ€ä¼˜çš„æ€§èƒ½æˆ–ä¸€è‡´æ€§ã€‚</li>
</ol>
</li>
</ol>
<p><strong>ä¸»ä»å¤åˆ¶æ¨¡å¼</strong></p>
<p>MySQL ä¸­ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§ä¸»ä»å¤åˆ¶çš„æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯å¼‚æ­¥å¤åˆ¶å’ŒåŠåŒæ­¥å¤åˆ¶ã€‚</p>
<ol>
<li>å¼‚æ­¥å¤åˆ¶ï¼šMySQL ä¸»ä»å¤åˆ¶ä¸­æœ€å¸¸è§å’Œé»˜è®¤çš„æ¨¡å¼ã€‚åœ¨å¼‚æ­¥å¤åˆ¶æ¨¡å¼ä¸­ï¼Œä¸»æœåŠ¡å™¨å°†æ•°æ®ä¿®æ”¹æ“ä½œè®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary Logï¼‰ä¸­ï¼Œå¹¶ç”±<strong>ä»æœåŠ¡å™¨</strong>çš„IOçº¿ç¨‹è¯»å–<strong>ä¸»æœåŠ¡å™¨</strong>æ—¥å¿—ã€‚ä»æœåŠ¡å™¨æ¥æ”¶åˆ°äºŒè¿›åˆ¶æ—¥å¿—åï¼Œä¼šå¼‚æ­¥åœ°åº”ç”¨è¿™äº›æ—¥å¿—è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚
<ol>
<li>ä¼˜ç‚¹ï¼šå®ƒçš„ä¼˜ç‚¹æ˜¯åŠæ—¶å“åº”ç»™ä½¿ç”¨è€…ï¼Œä¸»æœåŠ¡å™¨ä¸ä¼šå—åˆ°ä»æœåŠ¡å™¨çš„å½±å“è€Œç­‰å¾…ç¡®è®¤ï¼Œå¯ä»¥æé«˜ä¸»æœåŠ¡å™¨çš„æ€§èƒ½ã€‚</li>
<li>ç¼ºç‚¹ï¼šç”±äºæ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¼ è¾“çš„å»¶è¿Ÿï¼Œä¸”ä»æœåŠ¡å™¨ä¸Šçš„å¤åˆ¶è¿‡ç¨‹æ˜¯ä¸å¯é çš„ã€‚å¦‚æœä¸»æœåŠ¡å™¨æ•…éšœï¼Œå°šæœªåº”ç”¨åˆ°ä»æœåŠ¡å™¨çš„æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ã€‚</li>
</ol>
</li>
<li>åŠåŒæ­¥å¤åˆ¶ï¼šåŠåŒæ­¥å¤åˆ¶æ˜¯ MySQL ä¸»ä»å¤åˆ¶ä¸­çš„ä¸€ç§å¢å¼ºæ¨¡å¼ã€‚åœ¨åŠåŒæ­¥å¤åˆ¶æ¨¡å¼ä¸­ï¼Œä¸»æœåŠ¡å™¨å°†æ•°æ®ä¿®æ”¹æ“ä½œè®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¹¶ç­‰å¾…è‡³å°‘ä¸€ä¸ªä»æœåŠ¡å™¨ç¡®è®¤å·²æ¥æ”¶åˆ°å¹¶åº”ç”¨äº†è¿™äº›æ—¥å¿—åæ‰ç»§ç»­æ‰§è¡Œåç»­æ“ä½œã€‚
<ol>
<li>ä¼˜ç‚¹ï¼šå¯ä»¥æä¾›æ›´é«˜çš„æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§ï¼Œç¡®ä¿è‡³å°‘ä¸€ä¸ªä»æœåŠ¡å™¨ä¸ä¸»æœåŠ¡å™¨ä¿æŒåŒæ­¥ã€‚å¦‚æœä¸»æœåŠ¡å™¨æ•…éšœï¼Œå·²ç»ç¡®è®¤æ¥æ”¶å¹¶åº”ç”¨åˆ°ä»æœåŠ¡å™¨çš„æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚</li>
<li>ç¼ºç‚¹ï¼šç”±äºåŠåŒæ­¥å¤åˆ¶éœ€è¦ç­‰å¾…ä»æœåŠ¡å™¨çš„ç¡®è®¤ï¼Œå› æ­¤ç›¸å¯¹äºå¼‚æ­¥å¤åˆ¶ï¼Œä¼šå¢åŠ ä¸€å®šçš„å»¶è¿Ÿï¼Œå¯èƒ½ä¼šå½±å“ä¸»æœåŠ¡å™¨çš„æ€§èƒ½ã€‚</li>
</ol>
</li>
</ol>
<p>å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§è¦æ±‚è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åŠåŒæ­¥å¤åˆ¶ï¼›å¦‚æœå¯¹å»¶è¿Ÿå’Œä¸»æœåŠ¡å™¨æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´å¤åˆ¶æ¨¡å¼ã€‚</p>
<h2 id="MySQLé”">MySQLé”</h2>
<h3 id="è¡¨çº§é”">è¡¨çº§é”</h3>
<p>æ„å‘é”</p>
<table>
<thead>
<tr>
<th>é”ç±»å‹</th>
<th>ä½œç”¨å¯¹è±¡</th>
<th>ä¸»è¦ç”¨é€”</th>
<th>æ˜¯å¦å†²çª</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>IS é”</strong></td>
<td>è¡¨çº§</td>
<td>è¡¨ç¤ºäº‹åŠ¡è¦åœ¨æŸäº›è¡ŒåŠ  <strong>S é”</strong></td>
<td><strong>ä¸ä¸ IS æˆ– IX å†²çª</strong>ï¼Œä½†ä¸ <strong>è¡¨çº§ X é”</strong> å†²çª</td>
</tr>
<tr>
<td><strong>IX é”</strong></td>
<td>è¡¨çº§</td>
<td>è¡¨ç¤ºäº‹åŠ¡è¦åœ¨æŸäº›è¡ŒåŠ  <strong>X é”</strong></td>
<td><strong>ä¸ä¸ IS æˆ– IX å†²çª</strong>ï¼Œä½†ä¸ <strong>è¡¨çº§ S/X é”</strong> å†²çª</td>
</tr>
<tr>
<td><strong>S é”</strong></td>
<td>è¡Œçº§</td>
<td>å…è®¸è¯»å–ä½†ä¸å…è®¸ä¿®æ”¹è¯¥è¡Œ</td>
<td><strong>ä¸ X é”å†²çª</strong></td>
</tr>
<tr>
<td><strong>X é”</strong></td>
<td>è¡Œçº§</td>
<td>å…è®¸è¯»å†™è¯¥è¡Œï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½è®¿é—®</td>
<td><strong>ä¸ S/X é”å†²çª</strong></td>
</tr>
</tbody>
</table>
<p>æ„å‘é”ç”¨äºï¼Œå½“æŸä¸ªäº‹åŠ¡å°è¯•å¯¹è¡¨è¿›è¡ŒåŠ é”æ—¶ï¼Œä¸éœ€è¦éå†æŸ¥æ‰¾è¯¥è¡¨çš„è¡Œçº§é”åŠ é”æƒ…å†µ</p>
<h3 id="è¡Œçº§é”">è¡Œçº§é”</h3>
<p>è¡Œçº§é”åˆ†ä¸º</p>
<ul>
<li>Xè¡Œçº§é”</li>
<li>Sè¡Œçº§é”</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select ... lock in share mode </span><br></pre></td></tr></table></figure>
<p>è·å–Sé” (next-key lock)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select ... for update </span><br><span class="line"></span><br><span class="line">update ... </span><br><span class="line"></span><br><span class="line">delete ...</span><br></pre></td></tr></table></figure>
<p>è·å–Xé” (next-key lock)</p>
<blockquote>
<p>insert â€¦ è¯­å¥æ’å…¥å—é˜»æ—¶è·å–æ’å…¥æ„å‘é”</p>
<p>æ’å…¥æ„å‘é”ä¸ºä¸€ç§ç‰¹æ®Šçš„é—´éš™é”ï¼Œå³æ’å…¥æ„å‘é”ä¸æ’å…¥æ„å‘é”ä¸äº’æ–¥ï¼Œä¸å…¶ä»–ç±»å‹é”äº’æ–¥</p>
<p>åœºæ™¯ï¼šå¦‚æœè¢«æ’åŒºé—´å­˜åœ¨é—´éš™é”ï¼Œè·å–æ„å‘é”ï¼›</p>
</blockquote>
<p>è¡Œçº§é”åˆ†ä¸º</p>
<ul>
<li>
<p>next-key lockï¼ˆä¸´é”®é” = è®°å½•é”+é—´éš™é”ï¼‰<strong>å·¦å¼€å³é—­</strong></p>
</li>
<li>
<p>è®°å½•é”</p>
</li>
<li>
<p>é—´éš™é” <strong>å·¦å¼€å³å¼€</strong></p>
</li>
</ul>
<blockquote>
<p>é—´éš™é”ä¸äº’æ–¥ï¼ŒåŒ…æ‹¬åŒºé—´è¦†ç›–</p>
</blockquote>
<h3 id="é”å¯¹è±¡">é”å¯¹è±¡</h3>
<p>åŸºäºç´¢å¼•åŠ é”</p>
<p>ä½¿ç”¨ä¸»é”®ç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œä»…åœ¨åœ¨ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰ä¸ŠåŠ é”</p>
<p>ä½¿ç”¨éä¸»é”®ç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œåœ¨äºŒçº§ç´¢å¼•ä¸ŠåŠ é”ï¼ŒåŒæ—¶åŠ é”ä¸»é”®ç´¢å¼•</p>
<p>ä¸ä½¿ç”¨ç´¢å¼•ä¼šå¯¼è‡´é”å…¨è¡¨</p>
<h2 id="ç´¢å¼•">ç´¢å¼•</h2>
<p>ä¸»ç´¢å¼•ï¼Œå³èšç°‡ç´¢å¼•ï¼ˆä¹Ÿç§°èšé›†ç´¢å¼•ï¼Œclustered indexï¼‰</p>
<p>è¾…åŠ©ç´¢å¼•ï¼ˆæœ‰æ—¶ä¹Ÿç§°éèšç°‡ç´¢å¼•æˆ–äºŒçº§ç´¢å¼•ï¼Œsecondary indexï¼Œnon-clustered indexï¼‰ã€‚</p>
<img src="/2024/08/10/Database-Learning-Record/db-mysql-index-1.png" class="" title="index">
<p>å¦‚ä¸Šå›¾ï¼Œ<strong>ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜çš„æ˜¯çœŸæ­£çš„æ•°æ®ã€‚è€Œè¾…åŠ©ç´¢å¼•å¶å­èŠ‚ç‚¹çš„æ•°æ®åŒºä¿å­˜çš„æ˜¯ä¸»é”®ç´¢å¼•å…³é”®å­—çš„å€¼</strong>ã€‚</p>
<p>å‡å¦‚è¦æŸ¥è¯¢name = C çš„æ•°æ®ï¼Œå…¶æœç´¢è¿‡ç¨‹å¦‚ä¸‹ï¼ša) å…ˆåœ¨è¾…åŠ©ç´¢å¼•ä¸­é€šè¿‡CæŸ¥è¯¢æœ€åæ‰¾åˆ°ä¸»é”®id = 9; b) åœ¨ä¸»é”®ç´¢å¼•ä¸­æœç´¢idä¸º9çš„æ•°æ®ï¼Œæœ€ç»ˆåœ¨ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­è·å–åˆ°çœŸæ­£çš„æ•°æ®ã€‚æ‰€ä»¥é€šè¿‡è¾…åŠ©ç´¢å¼•è¿›è¡Œæ£€ç´¢ï¼Œéœ€è¦æ£€ç´¢ä¸¤æ¬¡ç´¢å¼•ã€‚</p>
<p>ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œä¸€ä¸ªåŸå› å°±æ˜¯ï¼šå¦‚æœå’ŒMyISAMä¸€æ ·åœ¨ä¸»é”®ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­éƒ½å­˜æ”¾æ•°æ®è¡ŒæŒ‡é’ˆï¼Œä¸€æ—¦æ•°æ®å‘ç”Ÿè¿ç§»ï¼Œåˆ™éœ€è¦å»é‡æ–°ç»„ç»‡ç»´æŠ¤æ‰€æœ‰çš„ç´¢å¼•ã€‚</p>
<p>ref: <a href="https://pdai.tech/md/interview/x-interview.html#_8-2-mysql">https://pdai.tech/md/interview/x-interview.html#_8-2-mysql</a></p>
<p><strong>ç´¢å¼•å¤±æ•ˆåœºæ™¯</strong></p>
<ul>
<li>
<p>ä½¿ç”¨å·¦æˆ–è€…å·¦å³æ¨¡ç³Šæœç´ ï¼Œä¾‹å¦‚ï¼Œ<code>like %xx</code>, <code>like %xx%</code></p>
</li>
<li>
<p>å¯¹ç´¢å¼•åˆ—ä½¿ç”¨å‡½æ•°/è¡¨è¾¾å¼è®¡ç®—</p>
</li>
<li>
<p>å¯¹ç´¢å¼•éšå¼ç±»å‹è½¬åŒ–ï¼ˆä¾‹å¦‚ï¼ŒStringè½¬intï¼Œå‘ç”Ÿäº†å‡½æ•°è®¡ç®—ï¼‰</p>
</li>
<li>
<p>è”åˆç´¢å¼•éæœ€å·¦åŒ¹é…</p>
</li>
<li>
<p>WHERE å­å¥ä½¿ç”¨ ORï¼Œå­˜åœ¨ OR çš„å­—æ®µä¸æ˜¯ç´¢å¼•åˆ—</p>
</li>
</ul>
<p><strong>ç´¢å¼•æ„å»ºåŸåˆ™</strong></p>
<p>æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™</p>
<blockquote>
<p>æ³¨æ„ï¼Œå‡å¦‚è¯´è”åˆç´¢å¼•ä¸º (a,b,c)ï¼Œæ‰§è¡ŒæŸ¥è¯¢ <code>where b = 1 and a = 2</code>ï¼Œå°†ä½¿ç”¨ç´¢å¼•ï¼SQLä¼˜åŒ–å™¨ä¼šé‡æ’åºwhereè¯­å¥ä¸­çº¦æŸçš„ä½ç½®</p>
<p>æ‰§è¡ŒæŸ¥è¯¢ <code>where a = 1 and c = 3</code> ï¼Œä¼šå‘ç”Ÿç´¢å¼•æˆªæ–­ï¼š</p>
<p>å¯¹äº MySQL 5.5 ï¼Œå°†é€šè¿‡ a åœ¨è”åˆç´¢å¼•æŸ¥æ‰¾åˆ°ä¸»é”®å€¼ï¼Œå›è¡¨ï¼Œè·å–æ•°æ®è¡Œï¼Œå¯¹æ•°æ®è¡Œè¿›è¡Œ c çš„ç­›é€‰ï¼›</p>
<p>å¯¹äº MySQL 5.6 ~ï¼Œå°†è¿›è¡Œç´¢å¼•ä¸‹æ¨ï¼›å¼•æ“å±‚ç›´æ¥ç­›é€‰å‡ºæ»¡è¶³ a å’Œ c æ¡ä»¶çš„æ•°æ®è¡Œ</p>
</blockquote>
<p>é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—ä½œä¸ºç´¢å¼•</p>
<p>ç´¢å¼•åˆ—ä¸èƒ½å‚ä¸è®¡ç®—</p>
<blockquote>
<p>ç´¢å¼•çš„B+æ ‘ä¸­ä¿å­˜çš„æ˜¯å­—æ®µå€¼ï¼Œå¦‚æœå¯¹å­—æ®µä½¿ç”¨å‡½æ•°ï¼Œåˆ™éœ€è¦å°†è¯¥å­—æ®µçš„å€¼è®¡ç®—ä¸ºæ–°å€¼ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•</p>
</blockquote>
<p><strong>ç»„åˆç´¢å¼•</strong></p>
<img src="/2024/08/10/Database-Learning-Record/492e0e5857459a335db7c7aea5377791.png" class="" title="combine_index">
<blockquote>
<p>æ„Ÿè§‰å¯ç”¨ç†è§£ä¸ºï¼Œæ¯ä¸€ä¸ªfiledå‡è¿›è¡Œhashcodeè®¡ç®—ï¼Œç„¶ååŠ å’Œï¼Œç„¶åæŒ‰ç…§å’Œçš„å¤§å°å»ºç«‹B+æ ‘</p>
</blockquote>
<h2 id="SQLä¼˜åŒ–">SQLä¼˜åŒ–</h2>
<p>ä½¿ç”¨ <code>EXPLAIN</code> ä¼˜åŒ–</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> name, age <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span> <span class="keyword">AND</span> salary <span class="operator">&gt;</span> <span class="number">50000</span>;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<p><strong>explain</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">   <span class="keyword">distinct</span> cert.emp_id </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">   cm_log cl </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">   (</span><br><span class="line">      <span class="keyword">select</span></span><br><span class="line">         emp.id <span class="keyword">as</span> emp_id,</span><br><span class="line">         emp_cert.id <span class="keyword">as</span> cert_id </span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">         employee emp </span><br><span class="line">      <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">         emp_certificate emp_cert </span><br><span class="line">            <span class="keyword">on</span> emp.id <span class="operator">=</span> emp_cert.emp_id </span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">         emp.is_deleted<span class="operator">=</span><span class="number">0</span></span><br><span class="line">   ) cert </span><br><span class="line">      <span class="keyword">on</span> (</span><br><span class="line">         cl.ref_table<span class="operator">=</span><span class="string">&#x27;Employee&#x27;</span> </span><br><span class="line">         <span class="keyword">and</span> cl.ref_oid<span class="operator">=</span> cert.emp_id</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">or</span> (</span><br><span class="line">         cl.ref_table<span class="operator">=</span><span class="string">&#x27;EmpCertificate&#x27;</span> </span><br><span class="line">         <span class="keyword">and</span> cl.ref_oid<span class="operator">=</span> cert.cert_id</span><br><span class="line">      ) </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">   cl.last_upd_date <span class="operator">&gt;=</span><span class="string">&#x27;2013-11-07 15:03:00&#x27;</span> </span><br><span class="line">   <span class="keyword">and</span> cl.last_upd_date<span class="operator">&lt;=</span><span class="string">&#x27;2013-11-08 16:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>æ€è·¯ï¼šå°† cm_log è¡¨ä¸ (emp+emp_cert) cert è¡¨å–äº¤é›†ï¼Œçº¦æŸèŒƒå›´å¹¶è¿”å›emp_id</p>
<blockquote>
<p>æ˜¾ç„¶ (emp+emp_cert) cert è¡¨çš„è¡Œæ•°è‚¯å®šå¾ˆå¤šï¼Œå†å’Œä¸€ä¸ªæ²¡æœ‰åšå€¼ç­›é€‰çš„è¡¨è¿›è¡Œäº¤é›†ï¼Œéå¸¸æ…¢</p>
<p>ä¼˜åŒ–æ€è·¯ï¼Œå°†  cm_log è¡¨åˆ†åˆ«ä¸ emp è¡¨å’Œ emp_cert è¡¨åšäº¤é›†ï¼Œå†union</p>
</blockquote>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>PRIMARY</td>
<td>cl</td>
<td>range</td>
<td>cm_log_cls_id,idx_last_upd_date</td>
<td>idx_last_upd_date</td>
<td>8</td>
<td>NULL</td>
<td>379</td>
<td>Using where; Using temporary</td>
</tr>
<tr>
<td>1</td>
<td>PRIMARY</td>
<td>&lt;derived2&gt;</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>63727</td>
<td>Using where; Using join buffer</td>
</tr>
<tr>
<td>2</td>
<td>DERIVED</td>
<td>emp</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>13317</td>
<td>Using where</td>
</tr>
<tr>
<td>2</td>
<td>DERIVED</td>
<td>emp_cert</td>
<td>ref</td>
<td>emp_certificate_empid</td>
<td>emp_certificate_empid</td>
<td>4</td>
<td><a href="http://meituanorg.emp.id">meituanorg.emp.id</a></td>
<td>1</td>
<td>Using index</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>id = 1 (PRIMARY)</strong>ï¼šè¿™æ˜¯æœ€å¤–å±‚çš„ SELECT æŸ¥è¯¢ã€‚
<ul>
<li>table = clï¼šè¯¥æŸ¥è¯¢é¦–å…ˆè®¿é—® cm_log è¡¨ï¼ˆclï¼‰ã€‚</li>
<li>type = rangeï¼šä½¿ç”¨äº†èŒƒå›´æ‰«æï¼Œé€šè¿‡ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
<li>possible_keys = cm_log_cls_id, idx_last_upd_dateï¼šä¼˜åŒ–å™¨è€ƒè™‘äº†ä¸¤ä¸ªç´¢å¼• cm_log_cls_id å’Œ idx_last_upd_dateã€‚</li>
<li>key = idx_last_upd_dateï¼šæœ€ç»ˆé€‰æ‹©äº† idx_last_upd_date ç´¢å¼•ã€‚</li>
<li>key_len = 8ï¼šä½¿ç”¨äº†ç´¢å¼•çš„å…¨éƒ¨é•¿åº¦ã€‚</li>
<li>rows = 379ï¼šä¼°è®¡éœ€è¦æ‰«æ 379 è¡Œã€‚</li>
<li>Extra = Using where; Using temporaryï¼šUsing where è¡¨ç¤ºåœ¨ç´¢å¼•æ‰«æåï¼Œè¿˜éœ€è¦è¿›è¡Œ WHERE æ¡ä»¶çš„è¿‡æ»¤ã€‚Using temporary è¡¨ç¤ºéœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨æ¥å¤„ç†ç»“æœï¼Œé€šå¸¸å‘ç”Ÿåœ¨éœ€è¦æ’åºæˆ–è€…å»é‡æ“ä½œæ—¶ï¼Œè¿™é‡Œå¾ˆæœ‰å¯èƒ½æ˜¯ distinct å¯¼è‡´ã€‚</li>
<li>table = &lt;derived2&gt;ï¼šè¯¥æŸ¥è¯¢è¿˜éœ€è¦è®¿é—® id=2 çš„å­æŸ¥è¯¢äº§ç”Ÿçš„ç»“æœè¡¨ï¼Œä¹Ÿå°±æ˜¯å­æŸ¥è¯¢ certã€‚</li>
<li>type = ALLï¼šå¯¹å­æŸ¥è¯¢çš„ç»“æœè¡¨è¿›è¡Œäº†å…¨è¡¨æ‰«æã€‚</li>
<li>rows = 63727ï¼šä¼°è®¡éœ€è¦æ‰«æ 63727 è¡Œã€‚</li>
<li>Extra = Using where; Using join bufferï¼šUsing where è¡¨ç¤ºéœ€è¦è¿›è¡Œ WHERE æ¡ä»¶çš„è¿‡æ»¤ã€‚ Using join buffer è¯´æ˜ MySQL ä½¿ç”¨äº† Join Buffer æ¥åŠ é€Ÿ Join è¿‡ç¨‹ã€‚</li>
</ul>
</li>
<li><strong>id = 2 (DERIVED)</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œåˆ«åä¸º certã€‚
<ul>
<li>table = empï¼šè¯¥å­æŸ¥è¯¢é¦–å…ˆè®¿é—® employee è¡¨ï¼ˆempï¼‰ã€‚</li>
<li>type = ALLï¼šå¯¹ employee è¡¨è¿›è¡Œäº†å…¨è¡¨æ‰«æã€‚</li>
<li>rows = 13317ï¼šä¼°è®¡éœ€è¦æ‰«æ 13317 è¡Œã€‚</li>
<li>Extra = Using whereï¼šè¡¨ç¤ºåœ¨å…¨è¡¨æ‰«æåï¼Œéœ€è¦è¿›è¡Œ WHERE æ¡ä»¶ emp.is_deleted=0 çš„è¿‡æ»¤ã€‚</li>
<li>table = emp_certï¼šè¯¥å­æŸ¥è¯¢è¿˜è®¿é—® emp_certificate è¡¨ï¼ˆemp_certï¼‰ã€‚</li>
<li>type = refï¼šä½¿ç”¨äº† ref ç±»å‹çš„è¿æ¥ï¼Œé€šè¿‡ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
<li>possible_keys = emp_certificate_empidï¼šä¼˜åŒ–å™¨è€ƒè™‘äº†ç´¢å¼• emp_certificate_empidã€‚</li>
<li>key = emp_certificate_empidï¼šæœ€ç»ˆé€‰æ‹©äº† emp_certificate_empid ç´¢å¼•ã€‚</li>
<li>key_len = 4ï¼šä½¿ç”¨äº†ç´¢å¼•çš„å…¨éƒ¨é•¿åº¦ã€‚</li>
<li>ref = <a href="http://meituanorg.emp.id">meituanorg.emp.id</a>ï¼šä½¿ç”¨ <a href="http://emp.id">emp.id</a> ä½œä¸ºç´¢å¼•çš„å‚è€ƒå€¼ã€‚</li>
<li>rows = 1ï¼šä¼°è®¡å¯¹äºæ¯ä¸ª <a href="http://emp.id">emp.id</a>ï¼Œåªéœ€è¦æ‰«æ emp_certificate è¡¨çš„ 1 è¡Œã€‚</li>
<li>Extra = Using indexï¼šè¡¨ç¤ºæŸ¥è¯¢å¯ä»¥ç›´æ¥ä½¿ç”¨ç´¢å¼•ä¸­çš„æ•°æ®ï¼Œä¸éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/db/sql-mysql/sql-mysql-index-improve-mt.html">https://pdai.tech/md/db/sql-mysql/sql-mysql-index-improve-mt.html</a></p>
<p><strong>é”™è¯¯ç”¨æ³•</strong>ï¼š<code>from_unixtime(create_time) = '2014-05-29'</code></p>
<ul>
<li>è¿™ä¸ªæŸ¥è¯¢ä¼šä½¿ç”¨<code>from_unixtime</code>å‡½æ•°å¯¹<code>create_time</code>è¿›è¡Œè½¬æ¢ï¼Œç„¶åä¸å­—ç¬¦ä¸²<code>'2014-05-29'</code>æ¯”è¾ƒã€‚</li>
<li>é—®é¢˜æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>create_time</code>å­—æ®µçš„ç´¢å¼•å°†æ— æ³•ä½¿ç”¨ï¼Œå› ä¸º<code>from_unixtime(create_time)</code>ä¼šä½¿å¾—æ•°æ®åº“éœ€è¦å¯¹æ¯ä¸ª<code>create_time</code>å€¼éƒ½è¿›è¡Œå‡½æ•°è®¡ç®—ï¼Œæ— æ³•ç›´æ¥é€šè¿‡ç´¢å¼•å®šä½åˆ°å¯¹åº”çš„è®°å½•ã€‚</li>
<li>ç»“æœæ˜¯ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šä¸‹é™ï¼Œæ•°æ®åº“å¯èƒ½éœ€è¦å…¨è¡¨æ‰«æã€‚</li>
</ul>
<p><strong>ä¼˜åŒ–ç”¨æ³•</strong>ï¼š<code>create_time = unix_timestamp('2014-05-29')</code></p>
<ul>
<li>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ç›´æ¥ä½¿ç”¨<code>create_time</code>å­—æ®µçš„åŸå§‹å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸éœ€è¦ä»»ä½•è®¡ç®—æˆ–å‡½æ•°è°ƒç”¨ã€‚</li>
<li>å› ä¸º<code>create_time</code>åˆ—ä¸Šçš„ç´¢å¼•å¯ä»¥ç›´æ¥ç”¨äºå®šä½è®°å½•ï¼ŒæŸ¥è¯¢æ€§èƒ½å¤§å¤§æé«˜ã€‚</li>
</ul>
<h2 id="Redis">Redis</h2>
<h3 id="è¯­æ³•">è¯­æ³•</h3>
<p>æŒ‡ä»¤ å¯¹è±¡ [value]/[key-value]</p>
<h3 id="æ•°æ®ç»“æ„-åº•å±‚åŸç†">æ•°æ®ç»“æ„&amp;åº•å±‚åŸç†</h3>
<img src="/2024/08/10/Database-Learning-Record/db-redis-object-2-3.png" class="" title="redisds">
<p>redisæ‰€æœ‰æ•°æ®ç»“æ„å‡ä¸º key - valueç»“æ„</p>
<p><strong>valueä¸ºä»¥ä¸‹ç»“æ„</strong></p>
<p>String(~)</p>
<img src="/2024/08/10/Database-Learning-Record/raw.png" class="" title="img">
<ul>
<li>int æˆ–è€… SDSï¼Œ SDSç”±é•¿åº¦ï¼ˆ<code>len</code>ï¼‰ã€å†…å­˜ç©ºé—´å¤§å°ï¼ˆ<code>alloc</code>ï¼‰ã€å­—ç¬¦ä¸²ç±»å‹ï¼ˆ<code>flags</code>ï¼‰å’Œå­˜å‚¨çš„å­—èŠ‚æ•°ç»„ï¼ˆ<code>buf</code>ï¼‰å››ä¸ªéƒ¨åˆ†ç»„æˆã€‚</li>
</ul>
<p>å¯ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼é”ï¼Œåˆ†å¸ƒå¼sessionï¼ŒåŸå­è®¡æ•°</p>
<p>List(L~)</p>
<p>åœ¨Redis 3.2ç‰ˆæœ¬åï¼ŒListæ•°æ®ç»“æ„åº•å±‚å®ç°ä¸º quicklist</p>
<p>3.2ç‰ˆæœ¬å‰</p>
<ul>
<li>å‹ç¼©åˆ—è¡¨ï¼ˆåˆ—è¡¨ä¸­å•ä¸ªæ•°æ®å°äº64å­—èŠ‚ï¼Œåˆ—è¡¨ä¸­æ•°æ®ä¸ªæ•°å°äº512ä¸ªï¼‰
<ul>
<li>æ¯ä¸ªå…ƒç´ ä½¿ç”¨ï¼ˆæ•°æ®é•¿+æ•°æ®å€¼ï¼‰å­˜å‚¨ï¼Œæ¯ä¸ªå…ƒç´ sizeä¸ç­‰</li>
<li>ä¸ç­‰é•¿å…ƒç´ å‹ç¼©äº†å­˜å‚¨ç©ºé—´</li>
</ul>
</li>
<li>åŒå‘å¾ªç¯åˆ—è¡¨</li>
</ul>
<p>Hash(H~)</p>
<p>åœ¨Reids 7.0åï¼Œæ›¿æ¢å‹ç¼©åˆ—è¡¨ä¸º listpack ç»“æ„</p>
<ul>
<li>å‹ç¼©åˆ—è¡¨ï¼ˆå­—å…¸ä¸­å•ä¸ªK-Vå°äº64å­—èŠ‚ï¼Œå­—å…¸ä¸­ä¸­K-Vä¸ªæ•°å°äº512ä¸ªï¼‰</li>
<li>å“ˆå¸Œè¡¨
<ul>
<li>è‡ªåŠ¨æ‰©å®¹ + é“¾è¡¨</li>
</ul>
</li>
</ul>
<p>å¯ç”¨åœºæ™¯ï¼šè´­ç‰©è½¦ï¼Œå¯¹è±¡ç¼“å­˜ (key, [(Field, Value), (Field, Value), â€¦]</p>
<p>Set(S~)</p>
<ul>
<li>æ•´æ•°é›†åˆï¼ˆå…ƒç´ å‡ä¸ºæ•´æ•°ï¼Œå…ƒç´ ä¸ªæ•°å°äº512ä¸ªï¼‰</li>
<li>å“ˆå¸Œè¡¨</li>
</ul>
<p>å¯ç”¨åœºæ™¯ï¼šæŠ½å¥–æ´»åŠ¨ï¼Œç‚¹èµï¼Œå…±åŒå…³æ³¨</p>
<p>Sorted Set(Z~)</p>
<p>Redis 7.0åï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„è¢«åºŸå¼ƒï¼Œæ”¹ä¸º listpack å®ç°</p>
<ul>
<li>å‹ç¼©åˆ—è¡¨ï¼ˆå…ƒç´ sizeå°äº64å­—èŠ‚ï¼Œå…ƒç´ ä¸ªæ•°å°äº512ä¸ªï¼‰</li>
<li>è·³è¡¨ + å­—å…¸</li>
</ul>
<img src="/2024/08/10/Database-Learning-Record/19063731-d7bc5026051ea412.png" class="" title="skip-pic">
<img src="/2024/08/10/Database-Learning-Record/image-20250306123144745.png" class="" title="image-20250306123144745">
<p>å¯ç”¨åœºæ™¯ï¼šæ’è¡Œæ¦œï¼Œç”µè¯/å§“åæ’åºï¼Œå»¶è¿Ÿé˜Ÿåˆ—</p>
<p>Bitmap(~BIT)</p>
<ul>
<li>String/bitæ•°ç»„</li>
</ul>
<p>å¯ç”¨åœºæ™¯ï¼šç­¾åˆ°ç»Ÿè®¡ï¼Œåˆ¤æ–­ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œè¿ç»­ç­¾åˆ°ç”¨æˆ·æ€»æ•°</p>
<p>Geo(GEO)</p>
<h3 id="RedisæŒä¹…åŒ–">RedisæŒä¹…åŒ–</h3>
<p>Redis çš„æ•°æ®æŒä¹…åŒ–æœºåˆ¶å…è®¸å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ï¼Œä»¥ä¾¿åœ¨æœåŠ¡é‡å¯æˆ–å®•æœºåå¯ä»¥æ¢å¤æ•°æ®ã€‚ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æœºåˆ¶ï¼š</p>
<p><strong>RDBï¼ˆRedis DataBaseï¼‰æŒä¹…åŒ–</strong></p>
<p>RDB æ˜¯ Redis çš„å¿«ç…§æ–¹å¼ï¼Œå®šæœŸå°†å†…å­˜ä¸­çš„æ•°æ®ä»¥äºŒè¿›åˆ¶æ–‡ä»¶çš„å½¢å¼ä¿å­˜åˆ°ç£ç›˜ã€‚</p>
<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<ul>
<li>Redis ä¼šé€šè¿‡ <code>SAVE</code> æˆ– <code>BGSAVE</code> å‘½ä»¤ç”Ÿæˆ RDB æ–‡ä»¶ã€‚
<ul>
<li><code>SAVE</code> å‘½ä»¤ï¼š
<ul>
<li>åœ¨ä¸»çº¿ç¨‹ä¸­å®Œæˆå¿«ç…§ä¿å­˜æ“ä½œï¼Œé˜»å¡ Redis çš„è¯»å†™ã€‚</li>
</ul>
</li>
<li><code>BGSAVE</code> å‘½ä»¤ï¼š
<ul>
<li>Redis åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹è´Ÿè´£å°†æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œä¸»çº¿ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li>
<li>å­è¿›ç¨‹ç”Ÿæˆå¿«ç…§æ—¶ä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Write, COWï¼‰æŠ€æœ¯ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>è§¦å‘æ–¹å¼ï¼š</strong></p>
<ul>
<li>
<p>**è‡ªåŠ¨è§¦å‘ï¼š**é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ <code>save</code> é€‰é¡¹è®¾ç½®å®šæœŸè§¦å‘è§„åˆ™ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">save 900 1   # 15 åˆ†é’Ÿå†…æœ‰ 1 æ¬¡å†™æ“ä½œ</span><br><span class="line">save 300 10  # 5 åˆ†é’Ÿå†…æœ‰ 10 æ¬¡å†™æ“ä½œ</span><br><span class="line">save 60 10000 # 1 åˆ†é’Ÿå†…æœ‰ 10000 æ¬¡å†™æ“ä½œ</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>**æ‰‹åŠ¨è§¦å‘ï¼š**æ‰§è¡Œ <code>SAVE</code> æˆ– <code>BGSAVE</code> å‘½ä»¤ã€‚</p>
</li>
</ul>
<p><strong>è¯»å†™å½±å“ï¼š</strong></p>
<ul>
<li>**<code>SAVE</code> å‘½ä»¤ï¼š**é˜»å¡ä¸»çº¿ç¨‹ï¼Œå½±å“è¯»å†™æ€§èƒ½ï¼Œé€‚åˆéé«˜è´Ÿè½½åœºæ™¯ã€‚</li>
<li>**<code>BGSAVE</code> å‘½ä»¤ï¼š**ä½¿ç”¨å­è¿›ç¨‹å®Œæˆï¼Œä½†å¯èƒ½å¢åŠ ç³»ç»Ÿ I/O å‹åŠ›ï¼Œç‰¹åˆ«æ˜¯æ•°æ®é‡è¾ƒå¤§æ—¶ã€‚</li>
</ul>
<hr>
<p><strong>AOFï¼ˆAppend Only Fileï¼‰æŒä¹…åŒ–</strong></p>
<p>AOF æ˜¯ Redis çš„æ—¥å¿—æ–¹å¼ï¼Œå°†æ¯æ¬¡å†™æ“ä½œè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€šè¿‡é‡æ”¾æ—¥å¿—æ¢å¤æ•°æ®ã€‚</p>
<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<ul>
<li>Redis å°†æ¯æ¬¡å†™æ“ä½œçš„å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æœ«å°¾ã€‚</li>
<li>æ”¯æŒä¸‰ç§åŒæ­¥ç­–ç•¥ï¼ˆé€šè¿‡ <code>appendfsync</code> å‚æ•°é…ç½®ï¼‰ï¼š
<ol>
<li>**alwaysï¼š**æ¯æ¬¡å†™æ“ä½œéƒ½åŒæ­¥åˆ°ç£ç›˜ï¼Œæœ€å®‰å…¨ä½†æ€§èƒ½è¾ƒå·®ã€‚</li>
<li>**everysecï¼š**æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œé»˜è®¤è®¾ç½®ï¼Œå…¼é¡¾æ€§èƒ½ä¸æ•°æ®å®‰å…¨ã€‚</li>
<li>**noï¼š**ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶åŒæ­¥ï¼Œæ€§èƒ½æœ€å¥½ï¼Œä½†å¯èƒ½ä¸¢å¤±æ•°æ®ã€‚</li>
</ol>
</li>
</ul>
<p><strong>è§¦å‘é‡å†™ï¼š</strong></p>
<ul>
<li>AOF æ–‡ä»¶ä¼šä¸æ–­å¢é•¿ï¼Œå› æ­¤éœ€è¦å®šæœŸé‡å†™ï¼ˆrewriteï¼‰ä»¥å‹ç¼©æ—¥å¿—ã€‚</li>
<li>Redis é€šè¿‡ <code>BGREWRITEAOF</code> å‘½ä»¤åˆ›å»ºå­è¿›ç¨‹å®Œæˆé‡å†™ï¼Œç±»ä¼¼ <code>BGSAVE</code>ã€‚</li>
</ul>
<p><strong>è¯»å†™å½±å“ï¼š</strong></p>
<ul>
<li>**è¿½åŠ æ¨¡å¼ï¼š**æ€§èƒ½å½±å“è¾ƒå°ï¼Œå› å†™æ“ä½œåªéœ€è¿½åŠ æ—¥å¿—ã€‚</li>
<li>**é‡å†™æ“ä½œï¼š**ç”±å­è¿›ç¨‹å®Œæˆï¼Œä¸»çº¿ç¨‹ç»§ç»­å¤„ç†è¯·æ±‚ï¼Œå¯èƒ½å¢åŠ  I/O å‹åŠ›ã€‚</li>
</ul>
<h3 id="Redis-æ·˜æ±°æœºåˆ¶">Redis æ·˜æ±°æœºåˆ¶</h3>
<p><strong>Redis è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥</strong></p>
<p>Redis ä¸»è¦æœ‰ä¸¤ç§ç­–ç•¥æ¥åˆ é™¤è¿‡æœŸé”®ï¼š</p>
<ul>
<li><strong>æƒ°æ€§åˆ é™¤ï¼ˆLazy Deletionï¼‰</strong>ï¼šå½“ä¸€ä¸ªé”®è¢«è®¿é—®æ—¶ï¼ŒRedis ä¼šæ£€æŸ¥è¯¥é”®æ˜¯å¦å·²ç»è¿‡æœŸã€‚å¦‚æœå·²è¿‡æœŸï¼ŒRedis ä¼šåˆ é™¤è¯¥é”®ï¼Œå¹¶è¿”å›ç›¸åº”çš„ç©ºå€¼ã€‚è¿™ç§æ–¹å¼åªä¼šåœ¨é”®è¢«è®¿é—®æ—¶æ£€æŸ¥è¿‡æœŸæƒ…å†µï¼Œå¹¶åˆ é™¤è¿‡æœŸé”®ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›è¿‡æœŸé”®åœ¨ä¸€æ®µæ—¶é—´å†…ä»ç„¶å ç”¨å†…å­˜ã€‚</li>
<li><strong>å®šæœŸåˆ é™¤ï¼ˆPeriodic Deletionï¼‰</strong>ï¼šRedis ä¼šå®šæœŸéšæœºæ£€æŸ¥ä¸€éƒ¨åˆ†è¿‡æœŸçš„é”®ï¼Œå¹¶å°†å…¶åˆ é™¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ 100 æ¯«ç§’ Redis ä¼šéšæœºæ£€æŸ¥ 10 ä¸ªè¿‡æœŸçš„é”®è¿›è¡Œåˆ é™¤ã€‚è¿™ç§æ–¹å¼ä¸ä¼šè®©è¿‡æœŸé”®æ°¸ä¹…å ç”¨å†…å­˜ï¼Œä½†ä»å¯èƒ½å­˜åœ¨ä¸€äº›è¿‡æœŸé”®åœ¨ä¸‹ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ä¸ä¼šè¢«åˆ é™¤ã€‚</li>
</ul>
<p><strong>å†…å­˜é™åˆ¶é…ç½®</strong></p>
<p>é€šè¿‡å‚æ•° <code>maxmemory</code> è®¾ç½® Redis å®ä¾‹çš„å†…å­˜ä¸Šé™ã€‚å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿è¡Œæ—¶å‘½ä»¤åŠ¨æ€é…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CONFIG SET maxmemory &lt;bytes&gt;</span><br></pre></td></tr></table></figure>
<p><strong>Redis å†…å­˜æ·˜æ±°ç­–ç•¥</strong></p>
<p>å½“ Redis çš„å†…å­˜è¶…è¿‡æœ€å¤§å†…å­˜é™åˆ¶ï¼ˆ<code>maxmemory</code>ï¼‰æ—¶ï¼Œä¼šè§¦å‘å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œé€šè¿‡å‚æ•° <code>maxmemory-policy</code> é…ç½® Redis çš„æ·˜æ±°ç­–ç•¥ã€‚ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p>
<p>ä¸æ·˜æ±°</p>
<ul>
<li>noeviction ï¼ˆv4.0åé»˜è®¤çš„ï¼‰</li>
</ul>
<p>å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±°</p>
<ul>
<li>éšæœºï¼švolatile-random</li>
<li>ttlï¼švolatile-ttl</li>
<li>lruï¼švolatile-lru</li>
<li>lfuï¼švolatile-lfu</li>
</ul>
<p>å…¨éƒ¨æ•°æ®è¿›è¡Œæ·˜æ±°</p>
<ul>
<li>éšæœºï¼šallkeys-random</li>
<li>lruï¼šallkeys-lru</li>
<li>lfuï¼šallkeys-lfu</li>
</ul>
<blockquote>
<p><strong>LRU ä¸ LFU æœºåˆ¶</strong></p>
<p>ï¼ˆ1ï¼‰<strong>LRUï¼ˆLeast Recently Usedï¼‰</strong></p>
<ul>
<li><strong>åŸç†</strong>ï¼šæ·˜æ±°æœ€ä¹…æœªè¢«è®¿é—®çš„é”®ã€‚</li>
<li><strong>å®ç°</strong>ï¼šRedis ä½¿ç”¨ä¸€ç§è¿‘ä¼¼ LRU ç®—æ³•ï¼Œé€šè¿‡é‡‡æ ·æ³•ï¼ˆé»˜è®¤ 5 ä¸ªé”®ï¼‰æ¥é€‰æ‹©è¢«æ·˜æ±°çš„é”®ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰<strong>LFUï¼ˆLeast Frequently Usedï¼‰</strong></p>
<ul>
<li><strong>åŸç†</strong>ï¼šæ·˜æ±°è®¿é—®é¢‘ç‡æœ€ä½çš„é”®ã€‚</li>
<li><strong>å®ç°</strong>ï¼šRedis é€šè¿‡ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼ˆ<code>counter</code>ï¼‰è·Ÿè¸ªæ¯ä¸ªé”®çš„è®¿é—®é¢‘ç‡ï¼Œé‡‡ç”¨é€’å‡æœºåˆ¶é¿å…è®¡æ•°å™¨æ— é™å¢é•¿ã€‚</li>
</ul>
</blockquote>
<h3 id="Redisé«˜å¯ç”¨">Redisé«˜å¯ç”¨</h3>
<h4 id="æŒä¹…åŒ–">æŒä¹…åŒ–</h4>
<img src="/2024/08/10/Database-Learning-Record/redis-x-rdb-4.jpg" class="" title="redisms">
<ol>
<li>RDBæŒä¹…åŒ–æ˜¯æŠŠå½“å‰è¿›ç¨‹æ•°æ®ç”Ÿæˆå¿«ç…§ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„è¿‡ç¨‹; é’ˆå¯¹RDBä¸é€‚åˆå®æ—¶æŒä¹…åŒ–çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFæŒä¹…åŒ–æ–¹å¼æ¥è§£å†³.</li>
<li>AOFæ˜¯â€œå†™åâ€æ—¥å¿—ï¼ŒRediså…ˆæ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®<strong>å…ˆå†™å…¥å†…å­˜ï¼Œå†è®°å½•æ—¥å¿—</strong>ã€‚æ—¥å¿—é‡Œè®°å½•çš„æ˜¯Redisæ”¶åˆ°çš„æ¯ä¸€æ¡å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤æ˜¯ä»¥æ–‡æœ¬å½¢å¼ä¿å­˜ã€‚</li>
<li>Redis 4.0 ä¸­æå‡ºäº†ä¸€ä¸ª<strong>æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§</strong>çš„æ–¹æ³•ã€‚ç®€å•æ¥è¯´ï¼Œå†…å­˜å¿«ç…§ä»¥ä¸€å®šçš„é¢‘ç‡æ‰§è¡Œï¼Œåœ¨ä¸¤æ¬¡å¿«ç…§ä¹‹é—´ï¼Œä½¿ç”¨ AOF æ—¥å¿—è®°å½•è¿™æœŸé—´çš„æ‰€æœ‰å‘½ä»¤æ“ä½œã€‚</li>
</ol>
<p>è¿™æ ·ä¸€æ¥ï¼Œå¿«ç…§ä¸ç”¨å¾ˆé¢‘ç¹åœ°æ‰§è¡Œï¼Œè¿™å°±é¿å…äº†é¢‘ç¹ fork å¯¹ä¸»çº¿ç¨‹çš„å½±å“ã€‚è€Œä¸”ï¼ŒAOF æ—¥å¿—ä¹Ÿåªç”¨è®°å½•ä¸¤æ¬¡å¿«ç…§é—´çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸éœ€è¦è®°å½•æ‰€æœ‰æ“ä½œäº†ï¼Œå› æ­¤ï¼Œå°±ä¸ä¼šå‡ºç°æ–‡ä»¶è¿‡å¤§çš„æƒ…å†µäº†ï¼Œä¹Ÿå¯ä»¥é¿å…é‡å†™å¼€é”€ã€‚</p>
<hr>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/interview/x-interview.html">https://pdai.tech/md/interview/x-interview.html</a></p>
<p>è§¦å‘æŒä¹…åŒ–</p>
<p><strong>saveå‘½ä»¤</strong>ï¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œç›´åˆ°RDBè¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œå¯¹äºå†…å­˜ æ¯”è¾ƒå¤§çš„å®ä¾‹ä¼šé€ æˆé•¿æ—¶é—´<strong>é˜»å¡</strong>ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</p>
<p><strong>bgsaveå‘½ä»¤</strong>ï¼šRedisè¿›ç¨‹æ‰§è¡Œforkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼ŒRDBæŒä¹…åŒ–è¿‡ç¨‹ç”±å­ è¿›ç¨‹è´Ÿè´£ï¼Œå®Œæˆåè‡ªåŠ¨ç»“æŸã€‚é˜»å¡åªå‘ç”Ÿåœ¨forké˜¶æ®µï¼Œä¸€èˆ¬æ—¶é—´å¾ˆçŸ­</p>
<p>RDBä¸­çš„æ ¸å¿ƒæ€è·¯æ˜¯Copy-on-Writeï¼Œæ¥ä¿è¯åœ¨è¿›è¡Œå¿«ç…§æ“ä½œçš„è¿™æ®µæ—¶é—´ï¼Œéœ€è¦å‹ç¼©å†™å…¥ç£ç›˜ä¸Šçš„æ•°æ®åœ¨å†…å­˜ä¸­ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚åœ¨æ­£å¸¸çš„å¿«ç…§æ“ä½œä¸­ï¼Œä¸€æ–¹é¢Redisä¸»è¿›ç¨‹ä¼šforkä¸€ä¸ªæ–°çš„å¿«ç…§è¿›ç¨‹ä¸“é—¨æ¥åšè¿™ä¸ªäº‹æƒ…ï¼Œè¿™æ ·ä¿è¯äº†RedisæœåŠ¡ä¸ä¼šåœæ­¢å¯¹å®¢æˆ·ç«¯åŒ…æ‹¬å†™è¯·æ±‚åœ¨å†…çš„ä»»ä½•å“åº”ã€‚å¦ä¸€æ–¹é¢è¿™æ®µæ—¶é—´å‘ç”Ÿçš„æ•°æ®å˜åŒ–ä¼šä»¥å‰¯æœ¬çš„æ–¹å¼å­˜æ”¾åœ¨å¦ä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸï¼Œå¾…å¿«ç…§æ“ä½œç»“æŸåæ‰ä¼šåŒæ­¥åˆ°åŸæ¥çš„å†…å­˜åŒºåŸŸã€‚</p>
<hr>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/interview/x-interview.html">https://pdai.tech/md/interview/x-interview.html</a></p>
<img src="/2024/08/10/Database-Learning-Record/redis-x-aof-42.jpg" class="" title="bgsavecpow">
<h4 id="é›†ç¾¤å“¨å…µ">é›†ç¾¤å“¨å…µ</h4>
<p>ä¸»ä»å¤åˆ¶</p>
<p>Redisçš„ä¸»ä»å¤åˆ¶ä¸ºRDBæ–‡ä»¶+å‘½ä»¤</p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-copy-1.png" class="" title="redisss">
<p>ä¸»ä»åº“ä¹‹é—´é‡‡ç”¨çš„æ˜¯<strong>è¯»å†™åˆ†ç¦»</strong>çš„æ–¹å¼ã€‚</p>
<ul>
<li>è¯»æ“ä½œï¼šä¸»åº“ã€ä»åº“éƒ½å¯ä»¥æ¥æ”¶ï¼›</li>
<li>å†™æ“ä½œï¼šé¦–å…ˆåˆ°ä¸»åº“æ‰§è¡Œï¼Œç„¶åï¼Œä¸»åº“å°†å†™æ“ä½œåŒæ­¥ç»™ä»åº“ã€‚</li>
</ul>
<p>åœ¨2.8ç‰ˆæœ¬ä¹‹å‰åªæœ‰å…¨é‡å¤åˆ¶ï¼Œè€Œ2.8ç‰ˆæœ¬åæœ‰å…¨é‡å’Œå¢é‡å¤åˆ¶ï¼š</p>
<ul>
<li>
<p><strong>å…¨é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶</strong>ï¼šæ¯”å¦‚ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶</p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-copy-2.jpg" class="" title="img">
</li>
<li>
<p><strong>å¢é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶</strong>ï¼šåªä¼šæŠŠä¸»ä»åº“ç½‘ç»œæ–­è¿æœŸé—´ä¸»åº“æ”¶åˆ°çš„å‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»åº“</p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-copy-3.jpg" class="" title="img">
</li>
</ul>
<p><strong>å“¨å…µ</strong></p>
<p><strong>å“¨å…µé›†ç¾¤ç»„å»º</strong></p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-sen-6.jpg" class="" title="img">
<p><strong>ç›‘æ§è¿‡ç¨‹</strong></p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-sen-7.jpg" class="" title="img">
<p><strong>åº“ç¦»çº¿åˆ¤æ–­</strong></p>
<ul>
<li><strong>ä¸»è§‚ä¸‹çº¿</strong>ï¼šä»»ä½•ä¸€ä¸ªå“¨å…µéƒ½æ˜¯å¯ä»¥ç›‘æ§æ¢æµ‹ï¼Œå¹¶ä½œå‡ºRedisèŠ‚ç‚¹ä¸‹çº¿çš„åˆ¤æ–­ï¼›</li>
<li><strong>å®¢è§‚ä¸‹çº¿</strong>ï¼šæœ‰å“¨å…µé›†ç¾¤å…±åŒå†³å®šRedisèŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿ï¼›</li>
</ul>
<p>å½“æŸä¸ªå“¨å…µï¼ˆå¦‚ä¸‹å›¾ä¸­çš„å“¨å…µ2ï¼‰åˆ¤æ–­ä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€åï¼Œå°±ä¼šç»™å…¶ä»–å“¨å…µå‘é€ <code>is-master-down-by-addr</code> å‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»åº“çš„è¿æ¥æƒ…å†µï¼Œåšå‡º Y æˆ– N çš„å“åº”ï¼ŒY ç›¸å½“äºèµæˆç¥¨ï¼ŒN ç›¸å½“äºåå¯¹ç¥¨ã€‚</p>
<p>å¦‚æœèµæˆç¥¨æ•°ï¼ˆè¿™é‡Œæ˜¯2ï¼‰æ˜¯å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ <code>quorum</code> é…ç½®é¡¹ï¼ˆæ¯”å¦‚è¿™é‡Œå¦‚æœæ˜¯quorum=2ï¼‰, åˆ™å¯ä»¥åˆ¤å®š<strong>ä¸»åº“å®¢è§‚ä¸‹çº¿</strong>äº†ã€‚</p>
<hr>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/interview/x-interview.html">https://pdai.tech/md/interview/x-interview.html</a></p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-sen-2.jpg" class="" title="img">
<blockquote>
<p><strong>Redis å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</strong></p>
<p>Redis å“¨å…µï¼ˆSentinelï¼‰æ˜¯ Redis é›†ç¾¤ä¸­è´Ÿè´£ç›‘æ§ã€é€šçŸ¥ã€è‡ªåŠ¨æ•…éšœè½¬ç§»å’ŒæœåŠ¡å‘ç°çš„ç»„ä»¶ã€‚å®ƒçš„é€‰ä¸¾æœºåˆ¶æ˜¯ç¡®ä¿åœ¨ä¸»èŠ‚ç‚¹ï¼ˆMasterï¼‰æ•…éšœæ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨é€‰ä¸¾ä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¿ƒä½¿ç³»ç»Ÿæ¢å¤æ­£å¸¸è¿è¡Œã€‚</p>
<ul>
<li><strong>å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„</strong>ï¼Ÿ</li>
</ul>
<p>å“¨å…µçš„é€‰ä¸¾æœºåˆ¶å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªRafté€‰ä¸¾ç®—æ³•ï¼š <strong>é€‰ä¸¾çš„ç¥¨æ•°å¤§äºç­‰äºnum(sentinels)/2+1æ—¶ï¼Œå°†æˆä¸ºé¢†å¯¼è€…ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œç»§ç»­é€‰ä¸¾</strong></p>
<p>Raftç®—æ³•å¯ä»¥å‚çœ‹è¿™ç¯‡æ–‡ç« <a href="">åˆ†å¸ƒå¼ç®—æ³• - Raftç®—æ³•</a></p>
<ul>
<li>ä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º ä¸»èŠ‚ç‚¹ çš„èŠ‚ç‚¹ï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š
<ul>
<li>ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›</li>
<li>ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚</li>
</ul>
</li>
</ul>
<p>ä»¥ 3 ä¸ªå“¨å…µä¸ºä¾‹ï¼Œå‡è®¾æ­¤æ—¶çš„ quorum è®¾ç½®ä¸º 2ï¼Œé‚£ä¹ˆï¼Œä»»ä½•ä¸€ä¸ªæƒ³æˆä¸ºä¸»èŠ‚ç‚¹ åªè¦æ‹¿åˆ° 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥äº†ã€‚</p>
<p><a href="#redis-1%E4%B8%BB4%E4%BB%8E-5%E4%B8%AA%E5%93%A8%E5%85%B5-%E5%93%A8%E5%85%B5%E9%85%8D%E7%BD%AEquorum%E4%B8%BA2-%E5%A6%82%E6%9E%9C3%E4%B8%AA%E5%93%A8%E5%85%B5%E6%95%85%E9%9A%9C-%E5%BD%93%E4%B8%BB%E5%BA%93%E5%AE%95%E6%9C%BA%E6%97%B6-%E5%93%A8%E5%85%B5%E8%83%BD%E5%90%A6%E5%88%A4%E6%96%AD%E4%B8%BB%E5%BA%93-%E5%AE%A2%E8%A7%82%E4%B8%8B%E7%BA%BF-%E8%83%BD%E5%90%A6%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2">#</a>Redis 1ä¸»4ä»ï¼Œ5ä¸ªå“¨å…µï¼Œå“¨å…µé…ç½®quorumä¸º2ï¼Œå¦‚æœ3ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»åº“å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»åº“â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿèƒ½å¦è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ</p>
<p>ç»è¿‡å®é™…æµ‹è¯•ï¼š</p>
<p>1ã€å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“â€œå®¢è§‚ä¸‹çº¿â€ã€‚ç”±äºquorum=2ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤–ä¸€ä¸ªå“¨å…µåä¹Ÿä¼šå¾—åˆ°åŒæ ·çš„ç»“æœï¼Œ2ä¸ªå“¨å…µéƒ½åˆ¤å®šâ€œä¸»è§‚ä¸‹çº¿â€ï¼Œè¾¾åˆ°äº†quorumçš„å€¼ï¼Œå› æ­¤ï¼Œ<strong>å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€</strong>ã€‚</p>
<p>2ã€<strong>ä½†å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢</strong>ã€‚å“¨å…µæ ‡è®°ä¸»åº“â€œå®¢è§‚ä¸‹çº¿åâ€ï¼Œåœ¨é€‰ä¸¾â€œä¸»èŠ‚ç‚¹â€æ—¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ‹¿åˆ°è¶…è¿‡å¤šæ•°çš„é€‰ç¥¨(5/2+1=3ç¥¨)ã€‚ä½†ç›®å‰åªæœ‰2ä¸ªå“¨å…µæ´»ç€ï¼Œæ— è®ºæ€ä¹ˆæŠ•ç¥¨ï¼Œä¸€ä¸ªèŠ‚ç‚¹æœ€å¤šåªèƒ½æ‹¿åˆ°2ç¥¨ï¼Œæ°¸è¿œæ— æ³•è¾¾åˆ°<code>N/2+1</code>é€‰ç¥¨çš„ç»“æœã€‚</p>
</blockquote>
<p><strong>æ•…éšœè½¬ç§»</strong></p>
<img src="/2024/08/10/Database-Learning-Record/db-redis-sen-4.png" class="" title="img">
<h3 id="Luaè„šæœ¬-ä¸-Redisäº‹åŠ¡">Luaè„šæœ¬ ä¸ Redisäº‹åŠ¡</h3>
<p><strong>Luaè„šæœ¬</strong>ï¼š</p>
<ul>
<li>Redis åœ¨æ‰§è¡Œ Lua è„šæœ¬æ—¶ï¼Œä¿è¯è„šæœ¬ä¸­çš„æ‰€æœ‰å‘½ä»¤åœ¨ä¸€ä¸ªåŸå­æ“ä½œå†…å®Œæˆã€‚å³ä½¿è„šæœ¬åŒ…å«å¤šä¸ª Redis å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¹Ÿä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤æ’å…¥ã€‚</li>
<li>Redis ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ï¼ŒLua è„šæœ¬æ‰§è¡ŒæœŸé—´ä¸ä¼šæœ‰å…¶ä»–å‘½ä»¤è¢«æ‰§è¡Œï¼Œå› æ­¤å…·å¤‡å¤©ç„¶çš„åŸå­æ€§ã€‚</li>
</ul>
<p><strong>äº‹åŠ¡ï¼ˆMULTI/EXECï¼‰</strong>ï¼š</p>
<ul>
<li>Redis äº‹åŠ¡ä¸­çš„å‘½ä»¤ä» MULTI åˆ° EXEC çš„æäº¤è¿‡ç¨‹è¢«ç§°ä¸ºäº‹åŠ¡å—ã€‚ä½† Redis ä¸ä¿è¯äº‹åŠ¡ä¸­çš„å‘½ä»¤æ˜¯å®Œå…¨åŸå­çš„ã€‚</li>
<li>å¦‚æœäº‹åŠ¡ä¸­çš„æŸäº›å‘½ä»¤å¤±è´¥ï¼ˆä¾‹å¦‚æ“ä½œæ•°æ®ç±»å‹é”™è¯¯ï¼‰ï¼Œäº‹åŠ¡ä¸­å…¶ä»–å‘½ä»¤ä»ä¼šæ‰§è¡Œã€‚</li>
<li>äº‹åŠ¡æœ¬è´¨ä¸Šæ˜¯æ‰¹é‡å‘é€å‘½ä»¤ï¼Œä½†å®ƒä¸æä¾›ç±»ä¼¼ Lua çš„åŸå­æ€§ä¿éšœã€‚</li>
</ul>
<blockquote>
<p>â€œäº‹åŠ¡æœ¬è´¨ä¸Šæ˜¯æ‰¹é‡å‘é€å‘½ä»¤â€ï¼Œè¿™æ„å‘³ç€å¦‚æœå¤šä¸ªå®¢æˆ·ç«¯å‘redisæœåŠ¡ç«¯å‘é€äº‹åŠ¡å—ï¼Œç”±äºä¸€ä¸ªredisæœåŠ¡ç«¯æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹çš„ï¼Œ<strong>æœ‰å¾ˆå¤§å¯èƒ½è¿™å¤šä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡å—ä¸­çš„å‘½ä»¤æ˜¯äº¤é”™æ‰§è¡Œçš„</strong>ï¼Œæ²¡æœ‰ä¿è¯åŸå­æ€§</p>
</blockquote>
<h3 id="Redis-åˆ†å¸ƒå¼é”"><strong>Redis åˆ†å¸ƒå¼é”</strong></h3>
<p><strong>åœºæ™¯</strong></p>
<p>å‡è®¾åœ¨ä¸€ä¸ªç”µå•†ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹åŒæ—¶å¯¹å•†å“åº“å­˜è¿›è¡Œæ‰£å‡æ“ä½œï¼Œä¸ºäº†é˜²æ­¢è¶…å–é—®é¢˜ï¼Œéœ€è¦å¼•å…¥åˆ†å¸ƒå¼é”æ¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®ä¾‹å¯ä»¥æ“ä½œæŸä»¶å•†å“çš„åº“å­˜ã€‚</p>
<p><strong>å®ç°</strong></p>
<p>ä½¿ç”¨ Redis çš„ <code>SET</code> æŒ‡ä»¤å®ç°åˆ†å¸ƒå¼é”ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥ Redis</span></span><br><span class="line">redis_client = redis.StrictRedis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, decode_responses=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">acquire_lock</span>(<span class="params">lock_key, lock_value, expire_time</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°è¯•è·å–é”</span></span><br><span class="line"><span class="string">    :param lock_key: é”çš„é”®</span></span><br><span class="line"><span class="string">    :param lock_value: é”çš„å”¯ä¸€æ ‡è¯†å€¼ï¼ˆé€šå¸¸ç”¨ UUIDï¼‰</span></span><br><span class="line"><span class="string">    :param expire_time: é”çš„è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰</span></span><br><span class="line"><span class="string">    :return: True è·å–æˆåŠŸï¼ŒFalse è·å–å¤±è´¥</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> redis_client.<span class="built_in">set</span>(lock_key, lock_value, ex=expire_time, nx=<span class="literal">True</span>)  // ä½¿ç”¨SETNXå®ç°</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">release_lock</span>(<span class="params">lock_key, lock_value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é‡Šæ”¾é”</span></span><br><span class="line"><span class="string">    :param lock_key: é”çš„é”®</span></span><br><span class="line"><span class="string">    :param lock_value: é”çš„å”¯ä¸€æ ‡è¯†å€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">        return redis.call(&quot;DEL&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">        return 0</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    redis_client.<span class="built_in">eval</span>(script, <span class="number">1</span>, lock_key, lock_value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šä½¿ç”¨é”</span></span><br><span class="line">lock_key = <span class="string">&quot;product_123_lock&quot;</span></span><br><span class="line">lock_value = <span class="string">&quot;unique_id_456&quot;</span>  <span class="comment"># é€šå¸¸ç”¨ UUID ç”Ÿæˆ</span></span><br><span class="line">expire_time = <span class="number">10</span>  <span class="comment"># é”çš„è¿‡æœŸæ—¶é—´ä¸º 10 ç§’</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> acquire_lock(lock_key, lock_value, expire_time):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œå¤„ç†é€»è¾‘...&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)  <span class="comment"># æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        release_lock(lock_key, lock_value)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é”å·²é‡Šæ”¾&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œç¨åå†è¯•&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹</strong></p>
<ol>
<li>SET å‘½ä»¤çš„å‚æ•°ï¼š
<ul>
<li><code>NX</code> è¡¨ç¤ºå½“é”®ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ã€‚</li>
<li><code>EX</code> è¡¨ç¤ºè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ã€‚</li>
</ul>
</li>
<li>ä½¿ç”¨ Lua è„šæœ¬ä¿è¯é‡Šæ”¾é”çš„åŸå­æ€§ã€‚</li>
<li>é”çš„ <code>value</code> å¿…é¡»å”¯ä¸€ï¼Œç”¨äºé¿å…è¯¯é‡Šæ”¾å…¶ä»–çº¿ç¨‹çš„é”ã€‚</li>
</ol>
<h3 id="Redis-åˆ†å¸ƒå¼ä¼šè¯"><strong>Redis åˆ†å¸ƒå¼ä¼šè¯</strong></h3>
<p><strong>åœºæ™¯</strong></p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼ˆå¦‚ç™»å½•çŠ¶æ€ï¼‰éœ€è¦å…±äº«åœ¨å¤šä¸ªå®ä¾‹ä¹‹é—´ã€‚Redis æ˜¯å¸¸ç”¨çš„åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚</p>
<p><strong>å®ç°</strong></p>
<p>å‡è®¾ç”¨æˆ·ç™»å½•ç³»ç»Ÿåï¼Œç”Ÿæˆä¸€ä¸ªä¼šè¯ IDï¼ˆå¦‚ <code>session_id</code>ï¼‰ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° Redis ä¸­ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥ Redis</span></span><br><span class="line">redis_client = redis.StrictRedis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, decode_responses=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_session</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ›å»ºä¼šè¯</span></span><br><span class="line"><span class="string">    :param user_id: ç”¨æˆ· ID</span></span><br><span class="line"><span class="string">    :return: session_id</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session_id = <span class="built_in">str</span>(uuid.uuid4())  <span class="comment"># ç”Ÿæˆå”¯ä¸€ä¼šè¯ ID</span></span><br><span class="line">    session_key = <span class="string">f&quot;session:<span class="subst">&#123;session_id&#125;</span>&quot;</span></span><br><span class="line">    session_data = &#123;<span class="string">&quot;user_id&quot;</span>: user_id, <span class="string">&quot;login_time&quot;</span>: time.time()&#125;</span><br><span class="line">    redis_client.hmset(session_key, session_data)</span><br><span class="line">    redis_client.expire(session_key, <span class="number">3600</span>)  <span class="comment"># è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 1 å°æ—¶</span></span><br><span class="line">    <span class="keyword">return</span> session_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_session</span>(<span class="params">session_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–ä¼šè¯ä¿¡æ¯</span></span><br><span class="line"><span class="string">    :param session_id: ä¼šè¯ ID</span></span><br><span class="line"><span class="string">    :return: ä¼šè¯æ•°æ®</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session_key = <span class="string">f&quot;session:<span class="subst">&#123;session_id&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> redis_client.hgetall(session_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_session</span>(<span class="params">session_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ é™¤ä¼šè¯</span></span><br><span class="line"><span class="string">    :param session_id: ä¼šè¯ ID</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session_key = <span class="string">f&quot;session:<span class="subst">&#123;session_id&#125;</span>&quot;</span></span><br><span class="line">    redis_client.delete(session_key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šåˆ›å»ºå’Œè·å–ä¼šè¯</span></span><br><span class="line">user_id = <span class="number">101</span></span><br><span class="line">session_id = create_session(user_id)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ–°ä¼šè¯åˆ›å»ºæˆåŠŸï¼š<span class="subst">&#123;session_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ä¼šè¯</span></span><br><span class="line">session_data = get_session(session_id)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ä¼šè¯æ•°æ®ï¼š<span class="subst">&#123;session_data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ä¼šè¯</span></span><br><span class="line">delete_session(session_id)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä¼šè¯å·²åˆ é™¤&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹</strong></p>
<ol>
<li><strong>ä¼šè¯ ID</strong>ï¼šæ¯ä¸ªç”¨æˆ·å¯¹åº”ä¸€ä¸ªå”¯ä¸€ä¼šè¯ IDï¼Œå¯é€šè¿‡ <code>uuid</code> ç”Ÿæˆã€‚</li>
<li><strong>ä¼šè¯å­˜å‚¨æ ¼å¼</strong>ï¼šé€šå¸¸ä½¿ç”¨ Redis çš„å“ˆå¸Œç»“æ„ï¼ˆ<code>HSET</code>ï¼‰å­˜å‚¨ç”¨æˆ·æ•°æ®ã€‚</li>
<li><strong>ä¼šè¯è¿‡æœŸæ—¶é—´</strong>ï¼šé€šè¿‡ <code>EXPIRE</code> è®¾ç½®ä¼šè¯çš„æœ‰æ•ˆæœŸï¼Œè¶…æ—¶åè‡ªåŠ¨æ¸…é™¤ã€‚</li>
</ol>
<h2 id="Redis-åˆ†å¸ƒå¼é”-2">Redis åˆ†å¸ƒå¼é”</h2>
<table>
<thead>
<tr>
<th>åˆ†ç±»</th>
<th>æ–¹æ¡ˆ</th>
<th>å®ç°åŸç†</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸºäºæ•°æ®åº“</td>
<td>åŸºäºmysql è¡¨å”¯ä¸€ç´¢å¼•</td>
<td>1.è¡¨å¢åŠ å”¯ä¸€ç´¢å¼• 2.åŠ é”ï¼šæ‰§è¡Œinsertè¯­å¥ï¼Œè‹¥æŠ¥é”™ï¼Œåˆ™è¡¨æ˜åŠ é”å¤±è´¥ 3.è§£é”ï¼šæ‰§è¡Œdeleteè¯­å¥</td>
<td>å®Œå…¨åˆ©ç”¨DBç°æœ‰èƒ½åŠ›ï¼Œå®ç°ç®€å•</td>
<td>1.é”æ— è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶ï¼Œæœ‰æ­»é”é£é™© 2.ä¸æ”¯æŒé”é‡å…¥ï¼Œä¸æ”¯æŒé˜»å¡ç­‰å¾… 3.æ“ä½œæ•°æ®åº“å¼€é”€å¤§ï¼Œæ€§èƒ½ä¸é«˜</td>
</tr>
<tr>
<td>åŸºäºMongoDB findAndModifyåŸå­æ“ä½œ</td>
<td>1.åŠ é”ï¼šæ‰§è¡ŒfindAndModifyåŸå­å‘½ä»¤æŸ¥æ‰¾documentï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ–°å¢ 2.è§£é”ï¼šåˆ é™¤document</td>
<td>å®ç°ä¹Ÿå¾ˆå®¹æ˜“ï¼Œè¾ƒåŸºäºMySQLå”¯ä¸€ç´¢å¼•çš„æ–¹æ¡ˆï¼Œæ€§èƒ½è¦å¥½å¾ˆå¤š</td>
<td>1.å¤§éƒ¨åˆ†å…¬å¸æ•°æ®åº“ç”¨MySQLï¼Œå¯èƒ½ç¼ºä¹ç›¸åº”çš„MongoDBè¿ç»´ã€å¼€å‘äººå‘˜ 2.é”æ— è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶</td>
<td></td>
</tr>
<tr>
<td>åŸºäºåˆ†å¸ƒå¼åè°ƒç³»ç»Ÿ</td>
<td>åŸºäºZooKeeper</td>
<td>1.åŠ é”ï¼šåœ¨/lockç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼Œåˆ¤æ–­åˆ›å»ºçš„èŠ‚ç‚¹åºå·æ˜¯å¦æœ€å°ã€‚è‹¥æ˜¯ï¼Œåˆ™è¡¨ç¤ºè·å–åˆ°é”ï¼›å¦ï¼Œåˆ™åˆ™watch /lockç›®å½•ä¸‹åºå·æ¯”è‡ªèº«å°çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ 2.è§£é”ï¼šåˆ é™¤èŠ‚ç‚¹</td>
<td>1.ç”±zkä¿éšœç³»ç»Ÿé«˜å¯ç”¨ 2.Curatoræ¡†æ¶å·²åŸç”Ÿæ”¯æŒç³»åˆ—åˆ†å¸ƒå¼é”å‘½ä»¤ï¼Œä½¿ç”¨ç®€å•</td>
<td>éœ€å•ç‹¬ç»´æŠ¤ä¸€å¥—zké›†ç¾¤ï¼Œç»´ä¿æˆæœ¬é«˜</td>
</tr>
<tr>
<td>åŸºäºç¼“å­˜</td>
<td>åŸºäºrediså‘½ä»¤</td>
<td>1. åŠ é”ï¼šæ‰§è¡Œsetnxï¼Œè‹¥æˆåŠŸå†æ‰§è¡Œexpireæ·»åŠ è¿‡æœŸæ—¶é—´ 2. è§£é”ï¼šæ‰§è¡Œdeleteå‘½ä»¤</td>
<td>å®ç°ç®€å•ï¼Œç›¸æ¯”æ•°æ®åº“å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„å®ç°ï¼Œè¯¥æ–¹æ¡ˆæœ€è½»ï¼Œæ€§èƒ½æœ€å¥½</td>
<td>1.setnxå’Œexpireåˆ†2æ­¥æ‰§è¡Œï¼ŒéåŸå­æ“ä½œï¼›è‹¥setnxæ‰§è¡ŒæˆåŠŸï¼Œä½†expireæ‰§è¡Œå¤±è´¥ï¼Œå°±å¯èƒ½å‡ºç°æ­»é” 2.deleteå‘½ä»¤å­˜åœ¨è¯¯åˆ é™¤éå½“å‰çº¿ç¨‹æŒæœ‰çš„é”çš„å¯èƒ½ 3.ä¸æ”¯æŒé˜»å¡ç­‰å¾…ã€ä¸å¯é‡å…¥</td>
</tr>
<tr>
<td>åŸºäºç¼“å­˜</td>
<td>åŸºäºredis Luaè„šæœ¬èƒ½åŠ›</td>
<td>1. åŠ é”ï¼šæ‰§è¡ŒSET lock_name random_value EX seconds NX å‘½ä»¤  2. è§£é”ï¼šæ‰§è¡ŒLuaè„šæœ¬ï¼Œé‡Šæ”¾é”æ—¶éªŒè¯random_value  â€“ ARGV[1]ä¸ºrandom_value, KEYS[1]ä¸ºlock_nameif redis.call(â€œgetâ€, KEYS[1]) == ARGV[1] then  return redis.call(â€œdelâ€,KEYS[1])else  return 0end</td>
<td>åŒä¸Šï¼›å®ç°é€»è¾‘ä¸Šä¹Ÿæ›´ä¸¥è°¨ï¼Œé™¤äº†å•ç‚¹é—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ç”¨è¿™ç§æ–¹æ¡ˆï¼Œé—®é¢˜ä¹Ÿä¸å¤§ã€‚</td>
<td>ä¸æ”¯æŒé”é‡å…¥ï¼Œä¸æ”¯æŒé˜»å¡ç­‰å¾…</td>
</tr>
</tbody>
</table>
<p><strong>Redisson åˆ†å¸ƒå¼é‡å…¥é”ç”¨æ³•</strong></p>
<p>Redisson æ”¯æŒå•ç‚¹æ¨¡å¼ã€ä¸»ä»æ¨¡å¼ã€å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼ï¼Œè¿™é‡Œä»¥å•ç‚¹æ¨¡å¼ä¸ºä¾‹ï¼š</p>
<p><strong>åº•å±‚åŸç†</strong>ï¼šRedisson ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ã€‚é€šè¿‡ Redis çš„ <code>SETNX</code> å‘½ä»¤ï¼ˆSET if Not eXistsï¼‰å’Œé”®å€¼è¿‡æœŸæœºåˆ¶ï¼Œç¡®ä¿å³ä½¿æŸä¸ªå®¢æˆ·ç«¯å´©æºƒï¼Œé”ä¹Ÿä¼šè‡ªåŠ¨è¿‡æœŸï¼Œä¸ä¼šå¯¼è‡´æ­»é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.æ„é€ redissonå®ç°åˆ†å¸ƒå¼é”å¿…è¦çš„Config</span></span><br><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config.useSingleServer().setAddress(<span class="string">&quot;redis://127.0.0.1:5379&quot;</span>).setPassword(<span class="string">&quot;123456&quot;</span>).setDatabase(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 2.æ„é€ RedissonClient</span></span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line"><span class="comment">// 3.è·å–é”å¯¹è±¡å®ä¾‹ï¼ˆæ— æ³•ä¿è¯æ˜¯æŒ‰çº¿ç¨‹çš„é¡ºåºè·å–åˆ°ï¼‰</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> redissonClient.getLock(lockKey);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4.å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     * waitTimeout å°è¯•è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ï¼Œåˆ™è®¤ä¸ºè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">     * leaseTime   é”çš„æŒæœ‰æ—¶é—´,è¶…è¿‡è¿™ä¸ªæ—¶é—´é”ä¼šè‡ªåŠ¨å¤±æ•ˆï¼ˆå€¼åº”è®¾ç½®ä¸ºå¤§äºä¸šåŠ¡å¤„ç†çš„æ—¶é—´ï¼Œç¡®ä¿åœ¨é”æœ‰æ•ˆæœŸå†…ä¸šåŠ¡èƒ½å¤„ç†å®Œï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> rLock.tryLock((<span class="type">long</span>)waitTimeout, (<span class="type">long</span>)leaseTime, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="comment">//æˆåŠŸè·å¾—é”ï¼Œåœ¨è¿™é‡Œå¤„ç†ä¸šåŠ¡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;aquire lock fail&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    <span class="comment">//æ— è®ºå¦‚ä½•, æœ€åéƒ½è¦è§£é”</span></span><br><span class="line">    rLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Redis-ä¸-æ•°æ®åº“-æ•°æ®ä¸€è‡´æ€§">Redis ä¸ æ•°æ®åº“ æ•°æ®ä¸€è‡´æ€§</h2>
<p>å‡è®¾ redisï¼Œæ•°æ®åº“ å­˜åœ¨ç›¸åŒæ•°æ®</p>
<p><strong>æ–¹æ¡ˆ 1ï¼šåˆ ç¼“å­˜å†™æ•°æ®åº“</strong></p>
<img src="/2024/08/10/Database-Learning-Record/ed50ea3d-77c9-42fc-bafe-6a5d1349cacb" class="" title="img">
<p>å­˜åœ¨å›¾ä¸­æ‰€ç¤ºé—®é¢˜</p>
<p><strong>æ–¹æ¡ˆ 2ï¼šå†™æ•°æ®åº“ï¼Œåˆ ç¼“å­˜</strong></p>
<img src="/2024/08/10/Database-Learning-Record/cff9f70e-fa29-4188-873f-7daabc142dab" class="" title="img">
<p><strong>æµç¨‹ï¼š</strong></p>
<ul>
<li>ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®</li>
<li>æ•°æ®åº“å®Œæˆä¿®æ”¹åï¼Œåˆ é™¤redisä¸­æ•°æ®----ï¼ˆåˆ†ç•Œçº¿ï¼šæ­¤åŠ¨ä½œå‰åæŸ¥è¯¢åˆ°çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼‰</li>
<li>è®¿é—®rediså‘ç”Ÿç¼ºå¤±æ—¶ï¼Œè§¦å‘misså¹¶æŸ¥è¯¢æ•°æ®åº“æ–°æ•°æ®ï¼Œç„¶åå†™å…¥redis</li>
</ul>
<p>æ–¹æ¡ˆ2å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<p>å‡è®¾Aè¯·æ±‚æ›´æ–°äº†æ•°æ®åº“ï¼Œè¿˜æœªæƒ…å†µç¼“å­˜çš„æƒ…å†µä¸‹ï¼ŒBè¯·æ±‚æ‹¿åˆ°çš„æ˜¯ç¼“å­˜å†…çš„æ—§æ•°æ®ï¼Œå› ä¸ºAè¿˜æ²¡æ¥å¾—åŠæŠŠæ–°çš„æ•°æ®å¡«å……åˆ°ç¼“å­˜ã€‚</p>
<p>æç«¯æ¡ä»¶</p>
<img src="/2024/08/10/Database-Learning-Record/03971152-0047-4160-a366-599329148f02" class="" title="img">
<p>å¦‚å›¾</p>
<p>åˆ é™¤Redisä¸­ç¼“å­˜æ—¶å¤±è´¥</p>
<ul>
<li>è·å–ä¸åˆ° Redis è¿æ¥ï¼Œå› ä¸ºå•ä¸ª Redis èŠ‚ç‚¹çš„è¿æ¥æœ‰é™ï¼Œå¦‚æœç”¨å®Œäº†åˆ™æ— æ³•è·å–ï¼Œè¿›è€ŒæŠ¥é”™ã€‚</li>
<li>å¦‚æœ Redis æœåŠ¡å™¨å®•æœºæˆ–ç½‘ç»œä¸å¯ç”¨ï¼Œå°†å¯¼è‡´æ— æ³•æ‰§è¡Œä»»ä½• Redis æ“ä½œã€‚</li>
<li>ç”±äºç½‘ç»œæ•…éšœæˆ–å»¶è¿Ÿï¼Œå¯èƒ½å¯¼è‡´ Redis æ“ä½œå¤±è´¥ã€‚</li>
</ul>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p>æ–¹æ¡ˆ1ï¼šredisä¸­æ•°æ®å‡è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é•¿ï¼Œåˆ é™¤å¤±è´¥ç­‰å¾…å…¶è¿‡æœŸ</p>
<p>æ–¹æ¡ˆ2ï¼šè‹¥åˆ é™¤å¤±è´¥ï¼Œå°†Redis Keyå†™å…¥å¾…åˆ é™¤æ•°æ®åº“è¡¨ä¸­ï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡æ‰«æå¾…åˆ é™¤è¡¨ï¼Œå°è¯•å†æ¬¡åˆ é™¤</p>
<p><strong>æ–¹æ¡ˆ3ï¼šç¼“å­˜åŒåˆ </strong></p>
<img src="/2024/08/10/Database-Learning-Record/01b1956b-a3b0-451a-83bb-7117859ef9b5" class="" title="img">
<p>å¯èƒ½å­˜åœ¨é—®é¢˜ï¼šæ— æ³•ä¿è¯ç¬¬äºŒæ¬¡åˆ é™¤åœ¨è¯»è¯·æ±‚å›å†™ç¼“å­˜ä¹‹å</p>
<p>é€šè¿‡å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—/å»¶è¿Ÿé˜Ÿåˆ—å®ç°</p>
<img src="/2024/08/10/Database-Learning-Record/885e438e-cf54-41f6-880e-faf36e72cd57" class="" title="img">
<p><strong>æ–¹æ¡ˆ4ï¼šBinlog é…åˆ MQ å®ç°ç¼“å­˜ä¸€è‡´æ€§</strong></p>
<img src="/2024/08/10/Database-Learning-Record/f2993d30-3803-4543-97db-f98cdca3a493" class="" title="img">
<h2 id="åˆ†åº“åˆ†è¡¨ç›¸å…³">åˆ†åº“åˆ†è¡¨ç›¸å…³</h2>
<blockquote>
<p>æµç¨‹ï¼šå•è¡¨ -&gt; è¯»å†™åˆ†ç¦» -&gt; åˆ†è¡¨ -&gt; åˆ†åº“</p>
</blockquote>
<p><strong>åœºæ™¯</strong></p>
<p>åˆ†åº“ï¼šæ•°æ®åº“è¿æ¥å¯ç”¨é‡ä¸å¤Ÿ</p>
<p>åˆ†è¡¨ï¼šå•è¡¨è¿‡å¤§</p>
<p><strong>åˆ†åº“åˆ†è¡¨æ–¹æ³•</strong></p>
<p>å‚ç›´åˆ†ï¼šæŒ‰åˆ—ï¼Œdomainåˆ’åˆ†</p>
<ul>
<li>æŒ‰ç…§ä¸šåŠ¡ç›¸å…³å†…å®¹ï¼Œåˆ’åˆ†ä¸ºç”¨æˆ·è¡¨ï¼Œè®¢å•è¡¨ï¼Œâ€¦</li>
</ul>
<p>æ°´å¹³åˆ†ï¼šæŒ‰è¡Œï¼ŒèŒƒå›´åˆ’åˆ†</p>
<ul>
<li>æŒ‰ç…§è¦†ç›–èŒƒå›´ï¼Œä¾‹å¦‚ï¼Œå°†ç”¨æˆ·å HashCode å– 10 çš„ä½™æ•°åˆ’åˆ†</li>
</ul>
<p>åˆ†åº“åˆ†è¡¨æ¡†æ¶</p>
<p>ShardingSphere</p>
<p>é€šè¿‡æ¡†æ¶è¿›è¡Œåˆ†ç‰‡ï¼šuser_0, user_1, user_2 â€¦</p>
<blockquote>
<p>å°±æ˜¯åˆ†å‡ºæ¥çš„å„ä¸ªè¡¨ï¼Œä½¿ç”¨ hash code å–æ¨¡</p>
</blockquote>
<p>åˆ†ç‰‡é”®ï¼š</p>
<ul>
<li>ç»å¸¸è®¿é—®çš„æ•°æ®éœ€æ”¾åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸Š</li>
<li>æ•°æ®å‡åŒ€çš„åˆ†å¸ƒåœ¨å„åˆ†ç‰‡ä¸Š</li>
<li>åˆ†ç‰‡é”®åº”è¯¥ä¸å¯å˜</li>
</ul>
<h2 id="ç¼“å­˜ç©¿é€ï¼Œç¼“å­˜é›ªå´©ï¼Œç¼“å­˜å‡»ç©¿">ç¼“å­˜ç©¿é€ï¼Œç¼“å­˜é›ªå´©ï¼Œç¼“å­˜å‡»ç©¿</h2>
<p><strong>ç¼“å­˜ç©¿é€</strong></p>
<p>å®¢æˆ·ç«¯è¯·æ±‚ç¼“å­˜å’Œæ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“ä¸Š</p>
<p>è€ƒè™‘é™æµ + æš‚å­˜ä¸å­˜åœ¨æ•°æ®åˆ°ç¼“å­˜ + å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨å°†ç»´æŠ¤æ‰€æœ‰åˆæ³•keyï¼‰</p>
<p><strong>ç¼“å­˜å‡»ç©¿</strong></p>
<p>ç¼“å­˜è¿‡æœŸ / ç¼“å­˜è¢«ä¸æ­£å¸¸ç§»é™¤ï¼Œå¯¼è‡´æŸ¥è¯¢å‘½ä¸­æ•°æ®åº“</p>
<p>åˆ¤æ–­çƒ­ç‚¹æ•°æ®è¿‡æœŸé€»è¾‘æ˜¯å¦åˆé€‚</p>
<p><strong>ç¼“å­˜é›ªå´©</strong></p>
<p>ç¼“å­˜å¤§é¢ç§¯è¿‡æœŸ / ç¼“å­˜å¤§é‡è¢«ç§»é™¤ï¼Œå¯¼è‡´å¤§é‡æŸ¥è¯¢å‘½ä¸­æ•°æ®åº“</p>
<p>ç¼“å­˜é¢„çƒ­ + é‡è®¾çƒ­ç‚¹æ•°æ®è¿‡æœŸæ—¶é—´ï¼ˆä¾‹å¦‚ï¼ŒåŠ å…¥éšæœºè¿‡æœŸæ—¶é—´ï¼‰+ åŠ å…¥åŒæ­¥é”</p>
<h2 id="ç¼“å­˜å¯ç”¨æ€§">ç¼“å­˜å¯ç”¨æ€§</h2>
<p>æé«˜Rediså¯ç”¨æ€§ï¼šRedisé›†ç¾¤æ¶æ„ + ä¸»ä»å“¨å…µ</p>
<p>å‡å°‘å¯¹Redisä¾èµ–ï¼šåŠ å…¥æœ¬åœ°ç¼“å­˜ Guava</p>
<p>ä¸šåŠ¡é™çº§ï¼šé™æµ</p>
<h2 id="count-ä¸-count-1">count(*) ä¸ count(1)</h2>
<p><code>count()</code> ç”¨äºç»Ÿè®¡å¤åˆæ¡ä»¶çš„è®°å½•ä¸­ï¼Œå‡½æ•°æŒ‡å®šå‚æ•°ä¸ä¸ºnullçš„è®°å½•çš„æ•°é‡</p>
<p><strong>æ€§èƒ½æ’åº</strong></p>
<p>count(*) = count(1) &gt; count(ä¸»é”®å­—æ®µ) &gt; count(å­—æ®µ)</p>
<p>count(1) è¡¨ç¤º åœ¨è¡¨ä¸­ï¼Œä½¿ <code>1</code> è¿™ä¸ªè¡¨è¾¾å¼ä¸ä¸ºNULLçš„è®°å½•çš„æ•°é‡</p>
<p>count(*) = count(0)</p>
<h2 id="ä¸€è‡´æ€§å“ˆå¸Œ">ä¸€è‡´æ€§å“ˆå¸Œ</h2>
<p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±å¾ˆå¥½åœ°è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨æ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œå‘ç”Ÿè¿‡å¤šçš„æ•°æ®è¿ç§»çš„é—®é¢˜ã€‚</p>
<p><strong>ä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼</strong>ã€‚</p>
<p>å¯¹å­˜å‚¨èŠ‚ç‚¹è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯å¯¹å­˜å‚¨èŠ‚ç‚¹åšå“ˆå¸Œæ˜ å°„ï¼Œæ¯”å¦‚æ ¹æ®èŠ‚ç‚¹çš„ IP åœ°å€è¿›è¡Œå“ˆå¸Œï¼›</p>
<p>å½“å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨æˆ–è®¿é—®æ—¶ï¼Œå¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼›</p>
<p><strong>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Š</strong>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äºæŸæ•°æ®Aï¼Œè¿›è¡Œå“ˆå¸Œæ˜ å°„åä½äºå“ˆå¸Œç¯çš„æŸä½ç½®ï¼›ä»è¯¥ä½ç½®å‡ºå‘ï¼Œæ²¿ç€å“ˆå¸Œç¯é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¿å­˜åˆ°è¯¥èŠ‚ç‚¹</p>
<p>å­˜åœ¨èŠ‚ç‚¹ä¸å‡åŒ€é—®é¢˜</p>
<p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹å‡åŒ€åˆ†å¸ƒåœ¨å“ˆå¸Œç¯ä¸Šï¼Œ çœŸå®èŠ‚ç‚¹åˆ†æ•£çš„æ˜ å°„åˆ°è™šæ‹ŸèŠ‚ç‚¹</p>
]]></content>
      <categories>
        <category>Database</category>
      </categories>
      <tags>
        <tag>MySQL, Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Algo Learning Record</title>
    <url>/2024/04/25/Algo-Learning-Record/</url>
    <content><![CDATA[<p>ç®—æ³•ç›¸å…³å­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>Java æ•°ç»„ String ä¸å®¹å™¨</h1>
<h2 id="æ•°ç»„">æ•°ç»„</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é™æ€åˆå§‹åŒ–</span></span><br><span class="line">String[][] names = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Charlie&quot;</span>, <span class="string">&quot;David&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Eve&quot;</span>, <span class="string">&quot;Frank&quot;</span>, <span class="string">&quot;Grace&quot;</span>, <span class="string">&quot;Henry&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// å£°æ˜ä¸€ä¸ª 3x4 çš„ int å‹äºŒç»´æ•°ç»„</span></span><br><span class="line"><span class="type">int</span>[][] matrix = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>][<span class="number">4</span>];  <span class="comment">// 3 è¡Œ 4 åˆ—</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// javaå…è®¸åˆ›å»ºä¸è§„åˆ™äºŒç»´æ•°ç»„</span></span><br><span class="line"><span class="type">int</span>[][] jaggedArray = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>][];  <span class="comment">// åªæŒ‡å®šè¡Œæ•°</span></span><br><span class="line"></span><br><span class="line">jaggedArray[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">5</span>]; <span class="comment">// ç¬¬ä¸€è¡Œæœ‰ 5 åˆ—</span></span><br><span class="line">jaggedArray[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>]; <span class="comment">// ç¬¬äºŒè¡Œæœ‰ 3 åˆ—</span></span><br><span class="line">jaggedArray[<span class="number">2</span>] = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">7</span>]; <span class="comment">// ç¬¬ä¸‰è¡Œæœ‰ 7 åˆ—</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ•°ç»„å’Œ</span></span><br><span class="line"><span class="type">int</span>[] numbers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(numbers).sum();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ç”¨è¿­ä»£</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i: numbers)</span><br><span class="line">&#123;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Comparator">Comparator</h2>
<p><strong>Comparator æ¥å£çš„ compare(T o1, T o2) æ–¹æ³•ï¼š</strong></p>
<ul>
<li><strong>è¿”å›è´Ÿæ•°ï¼š</strong> å¦‚æœ o1 åº”è¯¥æ’åœ¨ o2 <em>ä¹‹å‰</em> ï¼ˆå³ o1 å°äº o2ï¼‰ã€‚</li>
<li><strong>è¿”å›é›¶ï¼š</strong> å¦‚æœ o1 å’Œ o2 ç›¸ç­‰ã€‚</li>
<li><strong>è¿”å›æ­£æ•°ï¼š</strong> å¦‚æœ o1 åº”è¯¥æ’åœ¨ o2 <em>ä¹‹å</em> ï¼ˆå³ o1 å¤§äº o2ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>é€šä¿—ç†è§£ï¼Œ o1 åœ¨ o2 çš„å‰é¢å³ä¸ºå‡åºæ’åºï¼ˆo1, o2ï¼‰</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(students, (s1, s2) -&gt; Integer.compare(s1.getAge(), s2.getAge()));</span><br><span class="line"></span><br><span class="line">Arrays.sort(nums, (o1, o2) -&gt; o1 - o2);</span><br></pre></td></tr></table></figure>
<h2 id="String">String</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;apple&quot;</span>;</span><br><span class="line"><span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> s.charAt(i);  </span><br><span class="line"><span class="keyword">if</span> ( s.indexOf(c) == s.lastIndexOf(c)) <span class="keyword">return</span> s.indexOf(c) +<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;apple,banana,orange,grape&quot;</span>;</span><br><span class="line"><span class="comment">// ä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦è¿›è¡Œåˆ†å‰²</span></span><br><span class="line">String[] fruits = str.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">t</span> <span class="operator">=</span> <span class="string">&quot;coode&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">p</span> <span class="operator">=</span> <span class="string">&quot;c*de&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">wildcardIndex</span> <span class="operator">=</span> p.indexOf(<span class="string">&#x27;*&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> p.substring(<span class="number">0</span>, wildcardIndex);</span><br><span class="line"><span class="comment">// substring beginIndex: å­—ç¬¦ä¸²èµ·å§‹ç´¢å¼•ï¼ˆåŒ…å«ï¼‰</span></span><br><span class="line"><span class="comment">// substring endIndex: å­—ç¬¦ä¸²ç»“æŸç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> p.substring(wildcardIndex + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (t.startsWith(prefix) &amp;&amp; t.endsWith(suffix)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Character x : s.toCharArray()) &#123; <span class="comment">// è½¬å­—ç¬¦ä¸²ä¸ºcharæ•°ç»„</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();  <span class="comment">// ä½¿ç”¨length()è·å–å­—ç¬¦ä¸²é•¿ï¼ŒåŒStringBuilderä½¿ç”¨length()è·å–å­—ç¬¦ä¸²é•¿</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.parseInt(s); <span class="comment">// è½¬å­—ç¬¦ä¸²ä¸ºæ•´å‹</span></span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Integer.toString(i); <span class="comment">// è½¬æ•´å½¢ä¸ºå­—ç¬¦ä¸²</span></span><br></pre></td></tr></table></figure>
<h2 id="StringBuilder">StringBuilder</h2>
<p>StringBuilderå’ŒStringå‡ä½¿ç”¨length()è·å¾—é•¿åº¦</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringBufferExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º StringBuffer å¯¹è±¡</span></span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Initial StringBuffer: &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// append() - è¿½åŠ å­—ç¬¦ä¸²</span></span><br><span class="line">        sb.append(<span class="string">&quot; World&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;append(): &quot;</span> + sb);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        sb.append(sb1); <span class="comment">// å‘StringBuilderä¸­è¿½åŠ å…¶ä»–çš„StringBuilder</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// insert() - æ’å…¥å­—ç¬¦ä¸²ï¼Œæ’å…¥ä½ç½®çš„ç´¢å¼•ï¼Œä» 0 å¼€å§‹ï¼Œç›®æ ‡ç´¢å¼•çš„å³ä¾§å¼€å§‹æ’å…¥ã€‚</span></span><br><span class="line">        sb.insert(<span class="number">5</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;insert(): &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// delete() - åˆ é™¤å­—ç¬¦ä¸²</span></span><br><span class="line">        sb.delete(<span class="number">5</span>, <span class="number">7</span>); <span class="comment">// åˆ é™¤ &quot;, &quot;</span></span><br><span class="line">        System.out.println(<span class="string">&quot;delete(): &quot;</span> + sb);</span><br><span class="line">        sb.delete(<span class="number">0</span>, sb.length()); <span class="comment">// æ¸…ç©ºå­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// deleteCharAt() - åˆ é™¤æŒ‡å®šä½ç½®å­—ç¬¦</span></span><br><span class="line">        sb.deleteCharAt(<span class="number">5</span>); <span class="comment">//åˆ é™¤é€—å·</span></span><br><span class="line">        System.out.println(<span class="string">&quot;deleteCharAt(): &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// replace() - æ›¿æ¢å­—ç¬¦ä¸²</span></span><br><span class="line">        sb.replace(<span class="number">5</span>, <span class="number">10</span>, <span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;replace(): &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// charAt() - è·å–æŒ‡å®šä½ç½®å­—ç¬¦</span></span><br><span class="line">        <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> sb.charAt(<span class="number">0</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;charAt(0): &quot;</span> + ch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// setCharAt() - è®¾ç½®æŒ‡å®šä½ç½®å­—ç¬¦</span></span><br><span class="line">        sb.setCharAt(<span class="number">0</span>, <span class="string">&#x27;J&#x27;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;setCharAt(0, &#x27;J&#x27;): &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// substring() - è·å–å­å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sub1</span> <span class="operator">=</span> sb.substring(<span class="number">5</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;substring(5): &quot;</span> + sub1);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sub2</span> <span class="operator">=</span> sb.substring(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;substring(0, 5): &quot;</span> + sub2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reverse() - åè½¬å­—ç¬¦ä¸²</span></span><br><span class="line">        sb.reverse();</span><br><span class="line">        System.out.println(<span class="string">&quot;reverse(): &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// length() - è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼ï¼ï¼ä¸æ˜¯size()</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> sb.length();</span><br><span class="line">        System.out.println(<span class="string">&quot;length(): &quot;</span> + len);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// capacity() - è·å–å®¹é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> sb.capacity();</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity(): &quot;</span> + capacity); <span class="comment">// é»˜è®¤å®¹é‡ä¸º 16 + åˆå§‹å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//indexOf</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index1</span> <span class="operator">=</span> sb.indexOf(<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;indexOf(\&quot;Java\&quot;): &quot;</span> + index1);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">index2</span> <span class="operator">=</span> sb.indexOf(<span class="string">&quot;Java&quot;</span>, <span class="number">6</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;indexOf(\&quot;Java\&quot;, 6): &quot;</span> + index2);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastIndex1</span> <span class="operator">=</span> sb.lastIndexOf(<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;lastIndexOf(\&quot;Java\&quot;): &quot;</span> + lastIndex1);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastIndex2</span> <span class="operator">=</span> sb.lastIndexOf(<span class="string">&quot;Java&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;lastIndexOf(\&quot;Java\&quot;, 10): &quot;</span> + lastIndex2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// toString() - è½¬æ¢ä¸º String</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;toString(): &quot;</span> + str);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ensureCapacity</span></span><br><span class="line">        sb.ensureCapacity(<span class="number">50</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ensureCapacity(50): &quot;</span> + sb.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setLength</span></span><br><span class="line">        sb.setLength(<span class="number">5</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;setLength(5): &quot;</span> + sb);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="List">List</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList</span><br><span class="line"><span class="keyword">import</span> java.util.List    </span><br><span class="line">    </span><br><span class="line">List&lt;String&gt; l = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; l1 = List.of(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">l.add(<span class="string">&quot;apple&quot;</span>); <span class="comment">// æ·»åŠ å…ƒç´ </span></span><br><span class="line">l.add(<span class="number">1</span>, <span class="string">&quot;banana&quot;</span>); <span class="comment">// æŒ‡å®šç´¢å¼•ä½æ·»åŠ å…ƒç´ </span></span><br><span class="line"><span class="type">String</span> <span class="variable">fruit</span> <span class="operator">=</span> l.get(<span class="number">0</span>); <span class="comment">// è·å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ </span></span><br><span class="line">l.set(<span class="number">0</span>, <span class="string">&quot;orange&quot;</span>); <span class="comment">// ä¿®æ”¹æŒ‡å®šç´¢å¼•ä½çš„å…ƒç´ å€¼</span></span><br><span class="line">list.remove(<span class="number">0</span>); <span class="comment">// ç§»é™¤æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ï¼Œåç»­å…ƒç´ å‰ç§»</span></span><br><span class="line">list.remove(<span class="string">&quot;banana&quot;</span>); <span class="comment">// ç§»é™¤æŒ‡å®šå¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œæ³¨æ„ï¼šå­˜åœ¨å¤šä¸ªç›¸åŒé¡¹æ—¶ï¼Œä»…ç§»é™¤ç¬¬ä¸€ä¸ª</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> list.remove(<span class="string">&quot;grape&quot;</span>); <span class="comment">// è¿”å›æ˜¯å¦æˆåŠŸç§»é™¤</span></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isContains</span> <span class="operator">=</span> l.contains(<span class="string">&quot;apple&quot;</span>); <span class="comment">// æ£€æŸ¥listæ˜¯å¦å«æœ‰æŒ‡å®šå…ƒç´ </span></span><br><span class="line"></span><br><span class="line">list.clear(); <span class="comment">// ç§»é™¤æ‰€æœ‰å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> list.indexOf(<span class="string">&quot;apple&quot;</span>); <span class="comment">// è¿”å›æŒ‡å®šå¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹çš„ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å› -1</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; linkedList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// LinkedList æ”¯æŒé¦–å°¾æ·»åŠ /ç§»é™¤</span></span><br><span class="line">linkedList.addLast(<span class="number">1</span>);</span><br><span class="line">linkedList.removeLast();</span><br><span class="line">linkedList.addFirst(<span class="number">2</span>);</span><br><span class="line">linkedList.removeFirst();</span><br><span class="line"></span><br><span class="line"><span class="comment">// List è½¬ä¸º äºŒç»´æ•°ç»„</span></span><br><span class="line">List&lt;<span class="type">int</span>[]&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">res.toArray(<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">0</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// è¿™é‡Œ new int[0][0] åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„äºŒç»´æ•´æ•°æ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment">// toArray æ–¹æ³•ä½¿ç”¨è¿™ä¸ªæ•°ç»„æ¥ç¡®å®šè¿”å›æ•°ç»„çš„ç±»å‹ã€‚å³ä½¿ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼ŒtoArray æ–¹æ³•ä¹Ÿä¼šæ ¹æ®é›†åˆçš„å¤§å°åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå¹¶å°†å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ã€‚</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ArrayListåŠ¨æ€æ‰©å®¹æœºåˆ¶</p>
<p>addæ’å…¥å…ƒç´ æ—¶</p>
<ul>
<li>æ£€æŸ¥å®¹é‡æ˜¯å¦æ»¡è¶³
<ul>
<li>è®¡ç®—æ–°çš„æ•°ç»„å®¹é‡</li>
<li>copyç§»åŠ¨åŸæ•°ç»„å†…å…ƒç´ åˆ°åˆ›å»ºæ–°çš„æ•°ç»„</li>
</ul>
</li>
<li>æ’å…¥å…ƒç´ </li>
</ul>
<p><code>add(val, index)</code>æ–¹æ³•é€šè¿‡copyç›®æ ‡ç´¢å¼•åçš„å…ƒç´ å‘åç§»åŠ¨çš„æ–¹å¼ï¼Œç•™ç©ºç›®æ ‡ç´¢å¼•ä½ç½®å¹¶æ’å…¥</p>
<p><code>remove(index)</code>æ–¹æ³•å°†åˆ é™¤ä½ç½®åé¢çš„å…ƒç´ å‘å‰ç§»åŠ¨ä¸€ä½</p>
<p>LinkedListä¸ºå«å¤´æŒ‡é’ˆï¼Œå°¾æŒ‡é’ˆçš„é“¾è¡¨</p>
</blockquote>
<h2 id="æ ˆ">æ ˆ</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayDeque;</span><br><span class="line"></span><br><span class="line">ArrayDeque&lt;Integer&gt; s = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">s.push(<span class="number">1</span>);  <span class="comment">// å‹æ ˆ</span></span><br><span class="line">q.pop();  <span class="comment">// å‡ºæ ˆæ“ä½œ</span></span><br><span class="line">q.peek();  <span class="comment">// è·å–æ ˆé¡¶å…ƒç´ </span></span><br><span class="line">queue.isEmpty();</span><br></pre></td></tr></table></figure>
<h2 id="æœ€å°å †">æœ€å°å †</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.PriorityQueue</span><br><span class="line"></span><br><span class="line">PriorityQueue&lt;Integer&gt; minHeap = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">minHeap.add(<span class="number">5</span>);</span><br><span class="line">minHeap.add(<span class="number">1</span>);</span><br><span class="line">minHeap.add(<span class="number">3</span>);</span><br><span class="line">minHeap.add(<span class="number">7</span>);</span><br><span class="line">minHeap.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;æœ€å°å †å…ƒç´  (ä½¿ç”¨è¿­ä»£å™¨éå†ï¼Œé¡ºåºä¸ä¿è¯): &quot;</span> + minHeap);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">&quot;æŒ‰é¡ºåºå–å‡ºæœ€å°å…ƒç´ : &quot;</span>);</span><br><span class="line"><span class="keyword">while</span> (!minHeap.isEmpty()) &#123;</span><br><span class="line">	System.out.print(minHeap.poll() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é˜Ÿåˆ—">é˜Ÿåˆ—</h2>
<p>Queue</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line">Queue&lt;Integer&gt; q = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">q.add(<span class="number">1</span>);  <span class="comment">// æ— è¿”å›å€¼ï¼Œé˜Ÿåˆ—æ»¡æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">q.offer(<span class="number">1</span>);  <span class="comment">// å¦‚æœæ’å…¥æˆåŠŸï¼Œè¿”å› trueï¼›å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¿”å› falseï¼Œè€Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> dq.peek();  <span class="comment">// æŸ¥çœ‹é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">first = q.poll();  <span class="comment">// å‡ºé˜Ÿæ“ä½œ</span></span><br><span class="line">queue.isEmpty();</span><br></pre></td></tr></table></figure>
<p>Deque</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList</span><br><span class="line"><span class="keyword">import</span> java.util.Deque    </span><br><span class="line"></span><br><span class="line">Deque&lt;Integer&gt; dq = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜Ÿå°¾æ“ä½œ</span></span><br><span class="line">dq.add(<span class="number">1</span>);</span><br><span class="line">dq.offer(<span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> deque.peekLast();</span><br><span class="line">last = dq.removeLast();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜Ÿé¦–æ“ä½œ</span></span><br><span class="line">dq.push(<span class="number">1</span>);</span><br><span class="line">dq.offerFirst(<span class="number">2</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> dq.peek();</span><br><span class="line">first = dq.poll();</span><br><span class="line">first = dq.removeFirst();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Set">Set</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Set</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet</span><br><span class="line"><span class="keyword">import</span> java.util.TreeSet</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; hashSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">hashSet.add(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">hashSet.add(<span class="string">&quot;banana&quot;</span>);</span><br><span class="line">hashSet.add(<span class="string">&quot;apple&quot;</span>); <span class="comment">// é‡å¤å…ƒç´ ä¼šè¢«å¿½ç•¥</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">containsApple</span> <span class="operator">=</span> hashSet.contains(<span class="string">&quot;apple&quot;</span>); <span class="comment">// å¿«é€ŸæŸ¥æ‰¾</span></span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; linkedHashSet = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">linkedHashSet.add(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">linkedHashSet.add(<span class="string">&quot;banana&quot;</span>);</span><br><span class="line">linkedHashSet.forEach(System.out::println);</span><br><span class="line"><span class="comment">// System.out::printlnä¸ºæ–¹æ³•å¼•ç”¨ï¼Œå¼•ç”¨System.outå¯¹è±¡çš„printlnæ–¹æ³•ï¼Œç¼–è¯‘å™¨å°†å…¶è½¬æ¢ä¸ºç›¸åº”çš„å‡½æ•°å¼æ¥å£å®ä¾‹ï¼Œå¾—åˆ°ä¸€ä¸ªConsumer&lt;String&gt; çš„å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; treeSet = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;();</span><br><span class="line">treeSet.add(<span class="string">&quot;banana&quot;</span>);</span><br><span class="line">treeSet.add(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (String fruit : treeSet)</span><br><span class="line">&#123;</span><br><span class="line">    System.out.println(fruit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Map">Map</h2>
<p>Map</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line">Map&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">map.put(<span class="string">&quot;Alice&quot;</span>, <span class="number">90</span>);  <span class="comment">// æ·»åŠ é”®å€¼å¯¹</span></span><br><span class="line">map.get(<span class="string">&quot;Alice&quot;</span>);  <span class="comment">// æ ¹æ®é”®è·å–å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†é”®å€¼å¯¹</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">	<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">    System.out.println(<span class="string">&quot;å§“å: &quot;</span> + entry.getKey() + <span class="string">&quot;, åˆ†æ•°: &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†é”®</span></span><br><span class="line"><span class="keyword">for</span> (Integer i : m.keySet())  <span class="comment">// æ³¨æ„æ˜¯ keySet</span></span><br><span class="line">&#123;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†å€¼</span></span><br><span class="line"><span class="keyword">for</span> (Integer i : m.values())  <span class="comment">// æ³¨æ„æ˜¯ values</span></span><br><span class="line">&#123;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ˜¯å¦åŒ…å«æŸé”®æˆ–æŸå€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;æ˜¯å¦åŒ…å«Bob: &quot;</span> + map.containsKey(<span class="string">&quot;Bob&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;æ˜¯å¦åŒ…å«åˆ†æ•°85: &quot;</span> + map.containsValue(<span class="number">85</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤é”®å€¼å¯¹</span></span><br><span class="line">map.remove(<span class="string">&quot;Charlie&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;åˆ é™¤åHashMapå†…å®¹: &quot;</span> + map);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶…å®ç”¨ï¼ï¼ï¼å¦‚æœ key ä¸å­˜åœ¨ï¼Œè®¾ç½®é»˜è®¤å€¼ä¸º0ï¼›key å­˜åœ¨ï¼Œåˆ™ value+1</span></span><br><span class="line"><span class="comment">// Lambda è¡¨è¾¾å¼çš„è¿”å›å€¼ä¼šè‡ªåŠ¨èµ‹å€¼ç»™ value</span></span><br><span class="line">map.compute(key, (k, v) -&gt; (v == <span class="literal">null</span>) ? <span class="number">1</span> : v + <span class="number">1</span>);</span><br><span class="line">map.compute(key, (key, value) -&gt; value != <span class="number">1</span> ? value - <span class="number">1</span> : <span class="literal">null</span>);</span><br><span class="line"><span class="comment">// æ‰€ä»¥è¯´å¦‚æœvä¸ºåˆ—è¡¨å¿…é¡»æŒ‰ä»¥ä¸‹å½¢å¼å†™</span></span><br><span class="line">listInMap.compute(key, (k, v) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="literal">null</span>) &#123;</span><br><span class="line">        v = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    v.add(someElement);  <span class="comment">// someElement æ˜¯ä½ å¸Œæœ›æ·»åŠ çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>TreeMap</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.TreeMap</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªç„¶æ’åºï¼ˆå¯¹äº String é”®æ¥è¯´æ˜¯å­—æ¯é¡ºåºï¼‰</span></span><br><span class="line">TreeMap&lt;String, Integer&gt; treeMap1 = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">treeMap1.put(<span class="string">&quot;Apple&quot;</span>, <span class="number">1</span>);</span><br><span class="line">treeMap1.put(<span class="string">&quot;Banana&quot;</span>, <span class="number">2</span>);</span><br><span class="line">treeMap1.put(<span class="string">&quot;Orange&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> treeMap1.get(<span class="string">&quot;Banana&quot;</span>); <span class="comment">// è·å–é”®ä¸º &quot;Banana&quot; çš„å€¼</span></span><br><span class="line">System.out.println(value); <span class="comment">// è¾“å‡º 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// getOrDefault() æ–¹æ³•å¯ä»¥åœ¨é”®ä¸å­˜åœ¨æ—¶è¿”å›é»˜è®¤å€¼</span></span><br><span class="line"><span class="type">int</span> <span class="variable">defaultValue</span> <span class="operator">=</span> treeMap1.getOrDefault(<span class="string">&quot;Grape&quot;</span>, <span class="number">0</span>); <span class="comment">// &quot;Grape&quot; ä¸å­˜åœ¨ï¼Œè¿”å› 0</span></span><br><span class="line">System.out.println(defaultValue); <span class="comment">// è¾“å‡º 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ forEach éå†</span></span><br><span class="line">treeMap1.forEach((key, value) -&gt; System.out.println(<span class="string">&quot;Key: &quot;</span> + key + <span class="string">&quot;, Value: &quot;</span> + value));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ entrySet() éå†</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : treeMap1.entrySet()) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Key: &quot;</span> + entry.getKey() + <span class="string">&quot;, Value: &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ keySet() éå†é”®ï¼Œç„¶åè·å–å€¼</span></span><br><span class="line"><span class="keyword">for</span> (String key : treeMap1.keySet()) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Key: &quot;</span> + key + <span class="string">&quot;, Value: &quot;</span> + treeMap1.get(key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TreeMap&lt;String, Integer&gt; treeMap2 = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;((s1, s2) -&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">value1</span> <span class="operator">=</span> treeMap1.getOrDefault(s1, <span class="number">0</span>); <span class="comment">// å¤„ç†é”®ä¸å­˜åœ¨çš„æƒ…å†µ</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">value2</span> <span class="operator">=</span> treeMap1.getOrDefault(s2, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> value2 - value1;</span><br><span class="line">    <span class="comment">// è¿”å›å€¼å«ä¹‰</span></span><br><span class="line">    <span class="comment">// è´Ÿæ•°: è¡¨ç¤º s1 å°äº s2 (æŒ‰å€¼é€†åºæ’åˆ—ï¼Œå€¼å¤§çš„æ’åœ¨å‰é¢)ã€‚</span></span><br><span class="line">	<span class="comment">// é›¶: è¡¨ç¤º s1 ç­‰äº s2ã€‚</span></span><br><span class="line">	<span class="comment">// æ­£æ•°: è¡¨ç¤º s1 å¤§äº s2 (æŒ‰å€¼é€†åºæ’åˆ—ï¼Œå€¼å°çš„æ’åœ¨åé¢)ã€‚</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">treeMap2.putAll(treeMap1); <span class="comment">// å°† treeMap1 çš„å…ƒç´ å¤åˆ¶åˆ° treeMap2</span></span><br><span class="line"></span><br><span class="line">treeMap2.forEach((key, value) -&gt; System.out.println(<span class="string">&quot;Key: &quot;</span> + key + <span class="string">&quot;, Value: &quot;</span> + value));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>HashMap åº•å±‚ä¸ºæ•°ç»„å®ç°ï¼Œé€šè¿‡å“ˆå¸Œç ï¼ˆintç±»å‹ï¼‰ä¸æ•°ç»„é•¿å–æ¨¡å¾—åˆ°æ’å…¥ä½ç½®</p>
<p>å½“å‰çš„å…ƒç´ æ•°é‡è¶…è¿‡äº† <strong>æ‰©å®¹é˜ˆå€¼</strong>ï¼ˆ <code>å®¹é‡ï¼ˆcapacityï¼‰ * è´Ÿè½½å› å­ï¼ˆloadFactorï¼‰</code>ï¼‰æ—¶å‘ç”Ÿæ‰©å®¹</p>
<p>æ‰©å®¹é€šè¿‡åˆ›å»ºæ–°æ•°ç»„å¹¶è½¬ç§»ï¼ˆéå†æ¯ä¸ªå…ƒç´ å¹¶é‡æ–°è®¡ç®—å­˜æ”¾ä½ç½®ï¼‰åŸæ•°ç»„ä¸­çš„Entryå®ç°</p>
<p>å½“å…ƒç´ å‘ç”Ÿä½ç½®å†²çªæ—¶ï¼Œä½¿ç”¨é“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼ˆJava 8+ï¼‰å­˜å‚¨å†²çªå…ƒç´ ï¼Œé‡æ–°åˆ†å¸ƒåˆ°æ–°æ•°ç»„çš„å¯¹åº”é“¾è¡¨ä¸­ã€‚</p>
</blockquote>
<h1>å¸¸ç”¨æ’åº</h1>
<h2 id="å†’æ³¡æ’åº">å†’æ³¡æ’åº*</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BubbleSort</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bubbleSort</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> arr.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n - i - <span class="number">1</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (arr[j] &gt; arr[j + <span class="number">1</span>]) &#123;  <span class="comment">// å¤§çš„å‘ä¸Šå†’æ³¡</span></span><br><span class="line">                    <span class="comment">// æ¯”è¾ƒç›¸é‚»çš„ä¸¤ä¸ªå…ƒç´ å¹¶äº¤æ¢å®ƒä»¬çš„ä½ç½®</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[j];</span><br><span class="line">                    arr[j] = arr[j + <span class="number">1</span>];</span><br><span class="line">                    arr[j + <span class="number">1</span>] = temp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é€‰æ‹©æ’åº">é€‰æ‹©æ’åº</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelectionSort</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selectionSort</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> arr.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">minIndex</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (arr[j] &lt; arr[minIndex]) &#123;</span><br><span class="line">                    minIndex = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¯æ¬¡ä»æœªæ’åºéƒ¨åˆ†ä¸­æ‰¾åˆ°æœ€å°å€¼ï¼Œå¹¶å°†å…¶æ”¾åˆ°å·²æ’åºéƒ¨åˆ†çš„æœ«å°¾ã€‚</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[minIndex];</span><br><span class="line">            arr[minIndex] = arr[i];</span><br><span class="line">            arr[i] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ’å…¥æ’åº">æ’å…¥æ’åº*</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsertionSort</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯æ¬¡ä»æœªæ’åºéƒ¨åˆ†å–ä¸€ä¸ªå…ƒç´ ï¼Œæ’å…¥åˆ°å·²æ’åºéƒ¨åˆ†çš„åˆé€‚ä½ç½®ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">insertionSort</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> arr.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> arr[i];  <span class="comment">// ç›¸å½“äºå–å‡ºäº†åœ¨ä½ç½®içš„å…ƒç´ </span></span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i - <span class="number">1</span>;  <span class="comment">// å·²æ’åºéƒ¨åˆ†çš„æœ«å°¾</span></span><br><span class="line">            <span class="keyword">while</span> (j &gt;= <span class="number">0</span> &amp;&amp; arr[j] &gt; key) &#123;</span><br><span class="line">                arr[j + <span class="number">1</span>] = arr[j]; <span class="comment">// å‘å³ç§»åŠ¨å·²æ’åºéƒ¨åˆ†</span></span><br><span class="line">                j--;</span><br><span class="line">            &#125;</span><br><span class="line">            arr[j + <span class="number">1</span>] = key; <span class="comment">// å†™å…¥ç›®æ ‡ä½ç½®</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å¿«é€Ÿæ’åº">å¿«é€Ÿæ’åº*</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuickSort</span> &#123;</span><br><span class="line">    <span class="comment">// é€‰æ‹©ä¸€ä¸ªåŸºå‡†å€¼ï¼ˆpivotï¼‰ã€‚</span></span><br><span class="line">	<span class="comment">// å°†å°äºåŸºå‡†å€¼çš„å…ƒç´ æ”¾åˆ°å·¦ä¾§ï¼Œå¤§äºåŸºå‡†å€¼çš„å…ƒç´ æ”¾åˆ°å³ä¾§ã€‚</span></span><br><span class="line">	<span class="comment">// å¯¹å·¦å³éƒ¨åˆ†é€’å½’æ’åºï¼Œç›´åˆ°æ•°ç»„è¢«å®Œå…¨æ’åºã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">quickSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> low, <span class="type">int</span> high)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (low &lt; high) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">pi</span> <span class="operator">=</span> partition(arr, low, high);</span><br><span class="line">            quickSort(arr, low, pi - <span class="number">1</span>);</span><br><span class="line">            quickSort(arr, pi + <span class="number">1</span>, high);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">partition</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> low, <span class="type">int</span> high)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pivot</span> <span class="operator">=</span> arr[high];  <span class="comment">// é€‰æ‹©æœ€å³ç«¯å…ƒç´ ä¸ºæ¢å€¼å¹¶å–å‡º</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> low - <span class="number">1</span>;  <span class="comment">// i ä¸ºå°äºpivotçš„æ•°çš„æœ€å¤§ç´¢å¼•ï¼Œæ­¤æ—¶ç›¸å½“äº-1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> low; j &lt; high; j++) &#123; <span class="comment">// éå†èŒƒå›´[low, high - 1]</span></span><br><span class="line">            <span class="keyword">if</span> (arr[j] &lt; pivot) &#123;  <span class="comment">// å…ƒç´ å€¼å°äºæ¢å€¼</span></span><br><span class="line">                i++;  <span class="comment">// å°†è¯¥å…ƒç´ äº¤æ¢åˆ°å°äºæ¢å€¼çš„å…ƒç´ ç»„çš„æœ€å³ç«¯</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[i];</span><br><span class="line">                arr[i] = arr[j];</span><br><span class="line">                arr[j] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[i + <span class="number">1</span>];  <span class="comment">// å°†æ¢å€¼æ’å›å°äºæ¢å€¼çš„å…ƒç´ ç»„çš„æœ€å³ç«¯çš„å³ä¾§</span></span><br><span class="line">        arr[i + <span class="number">1</span>] = arr[high];</span><br><span class="line">        arr[high] = temp;</span><br><span class="line">        <span class="keyword">return</span> i + <span class="number">1</span>; <span class="comment">// è¿”å›æ¢å€¼ç´¢å¼•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éšæœºæ¢çº½</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();  <span class="comment">// åˆ›å»º Random å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">partition</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. é€‰æ‹©éšæœº pivot å¹¶äº¤æ¢åˆ° end ä½ç½®</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">randomIdx</span> <span class="operator">=</span> start + random.nextInt(end - start + <span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> nums[randomIdx];</span><br><span class="line">        nums[randomIdx] = nums[end];</span><br><span class="line">        nums[end] = tmp;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ç»§ç»­ Lomuto åˆ†åŒº</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pivotValue</span> <span class="operator">=</span> nums[end];  <span class="comment">// é€‰æ‹© pivot</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pIdx</span> <span class="operator">=</span> start;  <span class="comment">// pIdx æŒ‡å‘å°äº pivot çš„åŒºåŸŸçš„ä¸‹ä¸€ä¸ªä½ç½®</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] &lt; pivotValue) &#123;</span><br><span class="line">                <span class="comment">// äº¤æ¢ nums[i] å’Œ nums[pIdx]</span></span><br><span class="line">                tmp = nums[i];</span><br><span class="line">                nums[i] = nums[pIdx];</span><br><span class="line">                nums[pIdx] = tmp;</span><br><span class="line">                pIdx++;  <span class="comment">// å³ç§» pIdx</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// äº¤æ¢ pivotValue å’Œ nums[pIdx]ï¼Œç¡®ä¿ pivot å½’ä½</span></span><br><span class="line">        tmp = nums[pIdx];</span><br><span class="line">        nums[pIdx] = nums[end];</span><br><span class="line">        nums[end] = tmp;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> pIdx;  <span class="comment">// è¿”å› pivot çš„æ­£ç¡®ç´¢å¼•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">quickSort</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (start &gt;= end) &#123;  <span class="comment">// é€’å½’ç»ˆæ­¢æ¡ä»¶</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pivotIdx</span> <span class="operator">=</span> partition(nums, start, end);</span><br><span class="line">        quickSort(nums, start, pivotIdx - <span class="number">1</span>);  <span class="comment">// é€’å½’æ’åºå·¦ä¾§</span></span><br><span class="line">        quickSort(nums, pivotIdx + <span class="number">1</span>, end);  <span class="comment">// é€’å½’æ’åºå³ä¾§</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] sortArray(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">        quickSort(nums, <span class="number">0</span>, nums.length - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å½’å¹¶æ’åº">å½’å¹¶æ’åº*</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MergeSort</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">mergeSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (left &lt; right) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> left + (right - left) / <span class="number">2</span>;</span><br><span class="line">            mergeSort(arr, left, mid);</span><br><span class="line">            mergeSort(arr, mid + <span class="number">1</span>, right);</span><br><span class="line">            merge(arr, left, mid, right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æ•°ç»„ä¸æ–­åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç›´åˆ°æ— æ³•å†åˆ†ã€‚</span></span><br><span class="line">	<span class="comment">// ç„¶åé€šè¿‡åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„çš„æ–¹å¼ï¼Œå°†å°è§„æ¨¡æ•°ç»„é€æ­¥åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´æœ‰åºæ•°ç»„ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">merge</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> left, <span class="type">int</span> mid, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> mid - left + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> right - mid;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span>[] L = <span class="keyword">new</span> <span class="title class_">int</span>[n1];</span><br><span class="line">        <span class="type">int</span>[] R = <span class="keyword">new</span> <span class="title class_">int</span>[n2];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n1; i++) L[i] = arr[left + i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n2; j++) R[j] = arr[mid + <span class="number">1</span> + j];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>, k = left;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; n1 &amp;&amp; j &lt; n2) &#123;</span><br><span class="line">            <span class="keyword">if</span> (L[i] &lt;= R[j]) &#123;</span><br><span class="line">                arr[k] = L[i];</span><br><span class="line">                i++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                arr[k] = R[j];</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; n1) arr[k++] = L[i++];</span><br><span class="line">        <span class="keyword">while</span> (j &lt; n2) arr[k++] = R[j++];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å †æ’åº">å †æ’åº*</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapSort</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">heapSort</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> arr.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) </span><br><span class="line">            heapify(arr, n, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[<span class="number">0</span>];</span><br><span class="line">            arr[<span class="number">0</span>] = arr[i];</span><br><span class="line">            arr[i] = temp;</span><br><span class="line"></span><br><span class="line">            heapify(arr, i, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æ•°ç»„æ„é€ æˆä¸€ä¸ªå¤§é¡¶å †ï¼ˆçˆ¶èŠ‚ç‚¹å¤§äºæˆ–ç­‰äºå­èŠ‚ç‚¹ï¼‰ã€‚</span></span><br><span class="line">	<span class="comment">// å–å‡ºå †é¡¶å…ƒç´ ï¼ˆæœ€å¤§å€¼ï¼‰ï¼Œå¹¶å°†å…¶ä¸å †çš„æœ«å°¾å…ƒç´ äº¤æ¢ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> n, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">largest</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">2</span> * i + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">2</span> * i + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left &lt; n &amp;&amp; arr[left] &gt; arr[largest]) </span><br><span class="line">            largest = left;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (right &lt; n &amp;&amp; arr[right] &gt; arr[largest]) </span><br><span class="line">            largest = right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (largest != i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">swap</span> <span class="operator">=</span> arr[i];</span><br><span class="line">            arr[i] = arr[largest];</span><br><span class="line">            arr[largest] = swap;</span><br><span class="line"></span><br><span class="line">            heapify(arr, n, largest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] arr = &#123;<span class="number">64</span>, <span class="number">34</span>, <span class="number">25</span>, <span class="number">12</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">90</span>&#125;;</span><br><span class="line">        QuickSort.quickSort(arr, <span class="number">0</span>, arr.length - <span class="number">1</span>);</span><br><span class="line">        System.out.println(Arrays.toString(arr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>æ’åºç®—æ³•</th>
<th>æ—¶é—´å¤æ‚åº¦ (æœ€å¥½/æœ€å/å¹³å‡)</th>
<th>ç©ºé—´å¤æ‚åº¦</th>
<th>ç¨³å®šæ€§</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>å†’æ³¡æ’åº</td>
<td>O(n) / O(nÂ²) / O(nÂ²)</td>
<td>O(1)</td>
<td>ç¨³å®š</td>
<td>ç®€å•å°è§„æ¨¡æ•°æ®</td>
</tr>
<tr>
<td>é€‰æ‹©æ’åº</td>
<td>O(nÂ²) / O(nÂ²) / O(nÂ²)</td>
<td>O(1)</td>
<td>ä¸ç¨³å®š</td>
<td>ç®€å•æ•°æ®ï¼Œæ— éœ€ç¨³å®šæ€§</td>
</tr>
<tr>
<td>æ’å…¥æ’åº</td>
<td>O(n) / O(nÂ²) / O(nÂ²)</td>
<td>O(1)</td>
<td>ç¨³å®š</td>
<td>å°è§„æ¨¡ã€éƒ¨åˆ†æœ‰åºæ•°æ®</td>
</tr>
<tr>
<td>å¿«é€Ÿæ’åº</td>
<td>O(n log n) / O(nÂ²) / O(n log n)</td>
<td>O(log n)</td>
<td>ä¸ç¨³å®š</td>
<td>å¤§è§„æ¨¡æ•°æ®ï¼Œè¿½æ±‚é«˜æ•ˆç‡</td>
</tr>
<tr>
<td>å½’å¹¶æ’åº</td>
<td>O(n log n) / O(n log n) / O(n log n)</td>
<td>O(n)</td>
<td>ç¨³å®š</td>
<td>å¤§è§„æ¨¡æ•°æ®ï¼Œéœ€è¦ç¨³å®šæ€§</td>
</tr>
<tr>
<td>å †æ’åº</td>
<td>O(n log n) / O(n log n) / O(n log n)</td>
<td>O(1)</td>
<td>ä¸ç¨³å®š</td>
<td>å¤§è§„æ¨¡æ•°æ®ï¼Œéœ€è¦åŸåœ°æ’åº</td>
</tr>
</tbody>
</table>
<h1>ç®—æ³•é¢˜ç›®ä¸è®¾è®¡æ¨¡å¼</h1>
<h2 id="çº¢é»‘æ ‘">çº¢é»‘æ ‘</h2>
<p>æ”¹è¿›å¹³è¡¡äºŒå‰æ ‘</p>
<ul>
<li>æ ¹èŠ‚ç‚¹ä¸ºé»‘</li>
<li>ä¸å­˜åœ¨çº¢èŠ‚ç‚¹ç›¸é‚»</li>
<li>é»‘é«˜ä¸€è‡´</li>
<li>å¶èŠ‚ç‚¹ä¸ºé»‘ï¼ˆNILèŠ‚ç‚¹æˆ–ç©ºèŠ‚ç‚¹ï¼‰</li>
</ul>
<p>é»‘é«˜ä¸ä¸€è‡´/çº¢èŠ‚ç‚¹ç›¸é‚»æ—¶ <strong>å‘ç”Ÿå¹³è¡¡</strong></p>
<p><strong>é»˜è®¤æ’å…¥èŠ‚ç‚¹ä¸ºçº¢è‰²</strong></p>
<p>æŒ‰å¹³è¡¡äºŒå‰æ ‘é€»è¾‘æ’å…¥çº¢è‰²æ–°èŠ‚ç‚¹ï¼Œäº¤æ›¿ä»¥ä¸‹è¿‡ç¨‹</p>
<p>1.çˆ¶èŠ‚ç‚¹é‡æ–°æŸ“è‰² &lt;-&gt; 2.ä»ä¸‹å¾€ä¸Šç¬¬ä¸€ä¸ªé»‘é«˜ä¸ä¸€è‡´èŠ‚ç‚¹æ—‹è½¬</p>
<h2 id="Bæ ‘ä¸B-æ ‘">Bæ ‘ä¸B+æ ‘</h2>
<p>äºŒå‰æœç´¢æ ‘</p>
<ul>
<li>
<p>æ‰€æœ‰éå¶å­ç»“ç‚¹è‡³å¤šæ‹¥æœ‰ä¸¤ä¸ªå„¿å­ï¼ˆLeftå’ŒRightï¼‰ï¼›</p>
</li>
<li>
<p>æ‰€æœ‰ç»“ç‚¹å­˜å‚¨ä¸€ä¸ªå…³é”®å­—ï¼›</p>
</li>
<li>
<p>éå¶å­ç»“ç‚¹çš„å·¦æŒ‡é’ˆæŒ‡å‘å°äºå…¶å…³é”®å­—çš„å­æ ‘ï¼Œå³æŒ‡é’ˆæŒ‡å‘å¤§äºå…¶å…³é”®å­—çš„å­æ ‘ã€‚</p>
</li>
</ul>
<p>(mé˜¶)Bæ ‘</p>
<img src="/2024/04/25/Algo-Learning-Record/afba36911df7499610fe68102efe9e41.png" class="" title="img">
<ul>
<li>æ ¹èŠ‚ç‚¹æœ€å¤š M - 1ä¸ªå…³é”®å­—ï¼Œæœ€å¤š M ä¸ªå­èŠ‚ç‚¹ï¼›<strong>æœ€å°‘ 1 ä¸ªå…³é”®å­—ï¼Œæœ€å°‘ 2 ä¸ªå­èŠ‚ç‚¹</strong></li>
<li>éæ ¹èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å¶èŠ‚ç‚¹ï¼‰æœ€å¤šM - 1ä¸ªå…³é”®å­—ï¼Œæœ€å¤š M ä¸ªå­èŠ‚ç‚¹ï¼›æœ€å°‘ M/2-1 ä¸ªå…³é”®å­—ï¼Œæœ€å°‘ M/2 ä¸ªå­èŠ‚ç‚¹</li>
<li>èŠ‚ç‚¹å†…å…³é”®å­—æœ‰åºæ’åˆ—</li>
<li>æ‰€æœ‰å¶å­ç»“ç‚¹ä½äºåŒä¸€å±‚</li>
</ul>
<p>(mé˜¶)B+æ ‘</p>
<img src="/2024/04/25/Algo-Learning-Record/20200926212656.png" class="" title="img">
<p>ç»§æ‰¿Bæ ‘</p>
<ul>
<li>
<p>éå¶å­ç»“ç‚¹ä¸ºç´¢å¼•èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹æä¾›ä¿¡æ¯</p>
</li>
<li>
<p><strong>å¶å­èŠ‚ç‚¹æœ€å¤§å…ƒç´ æ•°ä¸º mï¼Œæœ€å°ä¸º m/2</strong></p>
<blockquote>
<p>ç”±äºéå¶èŠ‚ç‚¹ä¸ä¿å­˜ä¿¡æ¯ï¼Œæ•…å¶å­èŠ‚ç‚¹å¯ä¿å­˜å…ƒç´ å˜å¤šï¼Œé‡å¤ä¿å­˜éå¶ä¸­çš„ç´¢å¼•èŠ‚ç‚¹å€¼ï¼›æŸ¥æ‰¾è¿‡ç¨‹ç›¸å½“äºç´¢å¼•å·¦å³ä¸¤è¾¹æ˜¯å·¦å¼€å³é—­åŒºé—´</p>
</blockquote>
</li>
<li>
<p>å¶å­èŠ‚ç‚¹æ–°å¢é“¾æŒ‡é’ˆ</p>
</li>
<li>
<p>æ‰€æœ‰å…³é”®å­—å‡åœ¨å¶å­èŠ‚ç‚¹å‡ºç°</p>
</li>
</ul>
<p><strong>å¯¹æ¯”</strong></p>
<ul>
<li>
<p>Bæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨äº†keyå’Œdataï¼Œè€ŒB+æ ‘çš„dataå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸Šã€‚<br>
<strong>B+æ ‘éå¶å­èŠ‚ç‚¹ä»…å­˜å‚¨keyä¸å­˜å‚¨dataï¼Œè¿™æ ·ä¸€ä¸ªèŠ‚ç‚¹å°±å¯ä»¥å­˜å‚¨æ›´å¤šçš„keyï¼Œå¯ä»¥ä½¿å¾—B+æ ‘ç›¸å¯¹Bæ ‘æ¥è¯´æ›´çŸ®ï¼ˆIOæ¬¡æ•°å°±æ˜¯æ ‘çš„é«˜åº¦ï¼‰ï¼Œæ‰€ä»¥ä¸ç£ç›˜äº¤æ¢çš„IOæ“ä½œæ¬¡æ•°æ›´å°‘ã€‚</strong></p>
</li>
<li>
<p>B+æ ‘æ‰€æœ‰å¶å­èŠ‚ç‚¹æ„æˆä¸€ä¸ª <em>æœ‰åºé“¾è¡¨</em>ï¼ŒæŒ‰ä¸»é”®æ’åºæ¥éå†å…¨éƒ¨è®°å½•ï¼Œèƒ½æ›´å¥½æ”¯æŒ<strong>èŒƒå›´æŸ¥æ‰¾</strong>ã€‚<br>
ç”±äºæ•°æ®é¡ºåºæ’åˆ—å¹¶ä¸”ç›¸è¿ï¼Œæ‰€ä»¥ä¾¿äºåŒºé—´æŸ¥æ‰¾å’Œæœç´¢ã€‚è€ŒBæ ‘åˆ™éœ€è¦è¿›è¡Œæ¯ä¸€å±‚çš„é€’å½’éå†ï¼Œç›¸é‚»çš„å…ƒç´ å¯èƒ½åœ¨å†…å­˜ä¸­ä¸ç›¸é‚»ï¼Œæ‰€ä»¥ç¼“å­˜å‘½ä¸­æ€§æ²¡æœ‰B+æ ‘å¥½ã€‚</p>
</li>
<li>
<p>B+æ ‘æ‰€æœ‰çš„æŸ¥è¯¢éƒ½è¦ä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œ<strong>æŸ¥è¯¢æ€§æ›´ç¨³å®š</strong>ï¼›è€ŒBæ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½æŸ¥æ‰¾åˆ°æ•°æ®ï¼Œéœ€è¦åœ¨å¶å­èŠ‚ç‚¹å’Œå†…éƒ¨èŠ‚ç‚¹ä¸åœçš„å¾€è¿”ç§»åŠ¨ï¼Œæ‰€ä»¥ä¸ç¨³å®šã€‚</p>
</li>
</ul>
<p>ä½œè€…ï¼šæ¢¦<br>
é“¾æ¥ï¼š<a href="https://juejin.cn/post/7117516433386373133">https://juejin.cn/post/7117516433386373133</a><br>
æ¥æºï¼šç¨€åœŸæ˜é‡‘<br>
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
<h2 id="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</h2>
<h3 id="å•ä¾‹æ¨¡å¼">å•ä¾‹æ¨¡å¼</h3>
<p>ç¯å¢ƒä¸­ä»…å­˜åœ¨å”¯ä¸€çš„å¯¹è±¡</p>
<h3 id="å·¥å‚æ¨¡å¼">å·¥å‚æ¨¡å¼</h3>
<p>é€‚ç”¨äºå¤šç§ç›¸ä¼¼ç±»å‹çš„ç±»çš„åˆ›å»º</p>
<p>ä¾‹å¦‚ï¼šå·¥å‚ç±»å­˜åœ¨æ–¹æ³•Aå’Œæ–¹æ³•B</p>
<p>æ–¹æ³•Aç”¨äºåˆ›å»ºå®ç°äº†æ¥å£Açš„ç±»A1å’Œç±»A2ï¼Œé€šè¿‡ä¼ å…¥å‚æ•°åŒºåˆ«ï¼›</p>
<p>æ–¹æ³•Bç”¨äºåˆ›å»ºå®ç°äº†æ¥å£Bçš„ç±»B1å’Œç±»B2ï¼Œé€šè¿‡ä¼ å…¥å‚æ•°åŒºåˆ«ï¼›</p>
<h3 id="å»ºé€ è€…æ¨¡å¼">å»ºé€ è€…æ¨¡å¼</h3>
<p>æ„é€ æ—¶å…è®¸æŸäº›å‚æ•°ä¸ä¼ é€’ï¼ˆå¯é€‰å‚æ•°ï¼‰å’Œé“¾å¼åˆ›å»ºï¼ˆUser.builder().name().age().email().build()ï¼‰</p>
<p>ä¾‹å¦‚ï¼šLombokæ³¨è§£</p>
<p><code>@Builder</code> è‡ªåŠ¨ç”Ÿæˆæ„é€ æ–¹æ³•</p>
<h3 id="é€‚é…å™¨æ¨¡å¼">é€‚é…å™¨æ¨¡å¼</h3>
<p>è¢«è°ƒç±»å®ç°é€‚é…å™¨æ¥å£ï¼Œè°ƒç”¨ç±»å¯ä»¥ç»Ÿä¸€è°ƒç”¨</p>
<p>ä¾‹å¦‚ï¼š Spring MVC é‡Œçš„ <code>HandlerAdapter</code></p>
<p>æ•°æ®åº“é©±åŠ¨ <code>JDBC DriverManager</code></p>
<h3 id="è£…é¥°è€…æ¨¡å¼">è£…é¥°è€…æ¨¡å¼</h3>
<p>ä¾‹å¦‚ï¼šSpring AOP / python è£…é¥°å™¨</p>
<p>Open/Closed Principleï¼ŒOCP</p>
<p><strong>å¯¹æ‰©å±•å¼€æ”¾ï¼ˆOpen for extensionï¼‰ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼ˆClosed for modificationï¼‰</strong>ã€‚</p>
<h2 id="å¸¸è§æ¶æ„">å¸¸è§æ¶æ„</h2>
<h3 id="MVC">MVC</h3>
<p>MVC æ¶æ„è°ƒç”¨æµç¨‹</p>
<img src="/2024/04/25/Algo-Learning-Record/road-map-230623-02.png" class="" title="MVC">
<img src="/2024/04/25/Algo-Learning-Record/road-map-230623-03.png" class="" title="MVC_workflow">
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">é¡¹ç›®ç»“æ„</span><br><span class="line">â”œâ”€â”€ docs</span><br><span class="line">â”‚   â””â”€â”€ mvc.drawio - æ¶æ„æ–‡æ¡£</span><br><span class="line">â”œâ”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ src</span><br><span class="line">â”‚   â”œâ”€â”€ main</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ java</span><br><span class="line">â”‚   â”‚   â”‚   â””â”€â”€ cn</span><br><span class="line">â”‚   â”‚   â”‚       â””â”€â”€ bugstack</span><br><span class="line">â”‚   â”‚   â”‚           â””â”€â”€ xfg</span><br><span class="line">â”‚   â”‚   â”‚               â””â”€â”€ frame</span><br><span class="line">â”‚   â”‚   â”‚                   â”œâ”€â”€ Application.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”œâ”€â”€ common</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”œâ”€â”€ Constants.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â””â”€â”€ Result.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”œâ”€â”€ controller</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â””â”€â”€ UserController.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”œâ”€â”€ dao</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â””â”€â”€ IUserDao.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”œâ”€â”€ domain</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”œâ”€â”€ po</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”‚   â””â”€â”€ User.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”œâ”€â”€ req</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”‚   â””â”€â”€ UserReq.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”œâ”€â”€ res</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â”‚   â””â”€â”€ UserRes.java</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚   â””â”€â”€ vo</span><br><span class="line">â”‚   â”‚   â”‚                   â”‚       â””â”€â”€ UserInfo.java</span><br><span class="line">â”‚   â”‚   â”‚                   â””â”€â”€ service</span><br><span class="line">â”‚   â”‚   â”‚                       â”œâ”€â”€ IUserService.java</span><br><span class="line">â”‚   â”‚   â”‚                       â””â”€â”€ impl</span><br><span class="line">â”‚   â”‚   â”‚                           â””â”€â”€ UserServiceImpl.java</span><br><span class="line">â”‚   â”‚   â””â”€â”€ resources</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ application.yml</span><br><span class="line">â”‚   â”‚       â””â”€â”€ mybatis</span><br><span class="line">â”‚   â”‚           â”œâ”€â”€ config</span><br><span class="line">â”‚   â”‚           â”‚   â””â”€â”€ mybatis-config.xml</span><br><span class="line">â”‚   â”‚           â””â”€â”€ mapper</span><br><span class="line">â”‚   â”‚               â””â”€â”€ User_Mapper.xml</span><br><span class="line">â”‚   â””â”€â”€ test</span><br><span class="line">â”‚       â””â”€â”€ java</span><br><span class="line">â”‚           â””â”€â”€ cn</span><br><span class="line">â”‚               â””â”€â”€ bugstack</span><br><span class="line">â”‚                   â””â”€â”€ xfg</span><br><span class="line">â”‚                       â””â”€â”€ frame</span><br><span class="line">â”‚                           â””â”€â”€ test</span><br><span class="line">â”‚                               â””â”€â”€ ApiTest.java</span><br><span class="line">â””â”€â”€ road-map.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="DDD">DDD</h3>
<img src="/2024/04/25/Algo-Learning-Record/roadmap-ddd-stc-11.png" class="" title="ddd">
<h3 id="Diff">Diff</h3>
<p>mvc</p>
<img src="/2024/04/25/Algo-Learning-Record/ddd-easy-guide-03-02.png" class="" title="diff">
<p>ddd</p>
<img src="/2024/04/25/Algo-Learning-Record/ddd-easy-guide-03-04.png" class="" title="diff2">
<img src="/2024/04/25/Algo-Learning-Record/ddd-easy-guide-03-05.png" class="" title="diff3">
<h2 id="é¢˜ç›®">é¢˜ç›®</h2>
<h3 id="å›¾">å›¾</h3>
<p><a href="https://leetcode.cn/problems/course-schedule/">è¯¾ç¨‹è¡¨</a>ï¼š</p>
<p>ä½¿ç”¨é‚»æ¥è¡¨+å…¥åº¦è¡¨ï¼›ä»å…¥åº¦ä¸º0çš„èŠ‚ç‚¹å‡ºå‘ï¼Œä»å›¾ä¸­ç§»é™¤ï¼›</p>
<h3 id="æ ‘">æ ‘</h3>
<blockquote>
<p>æ˜ç¡®é€’å½’è¿”å›å€¼ï¼›</p>
<p>åˆç†ä½¿ç”¨é€’å½’è¿”å›å€¼ä¸ºå˜é‡èµ‹å€¼ï¼›</p>
</blockquote>
<p><a href="https://leetcode.cn/problems/kth-smallest-element-in-a-bst/">äºŒå‰æœç´¢æ ‘ä¸­ç¬¬ K å°çš„å…ƒç´ </a>:</p>
<p>ä¸­åºéå†çš„ç¬¬kä¸ªå…ƒç´ </p>
<blockquote>
<p>ç¬¬kå¤§ ä»¥ ï¼ˆå³-&gt;æ ¹-&gt;å·¦ï¼‰ æ–¹å¼éå†çš„ç¬¬kä¸ªå…ƒç´ </p>
</blockquote>
<p><a href="https://leetcode.cn/problems/validate-binary-search-tree/">éªŒè¯äºŒå‰æœç´¢æ ‘</a>ï¼š</p>
<p>æ¯ä¸ªå­æ ‘çš„èŠ‚ç‚¹éƒ½éœ€è¦å°äº/å¤§äºå½“å‰èŠ‚ç‚¹ï¼Œä¸èƒ½åªæ¯”è¾ƒå½“å‰èŠ‚ç‚¹ä¸å·¦å³å­æ ‘ï¼›æ•…éœ€è¦åœ¨é€’å½’ä¸­éœ€è¦ä¼ é€’å…è®¸æœ€å¤§å€¼/å…è®¸æœ€å°å€¼ï¼›</p>
<p><a href="https://leetcode.cn/problems/diameter-of-binary-tree/">äºŒå‰æ ‘çš„ç›´å¾„</a>ï¼š</p>
<p>ä»»æ„ä¸¤ç‚¹çš„è·ç¦»ï¼›ä½¿ç”¨å…¨å±€å˜é‡ä¿å­˜æœ€å¤§å€¼ï¼›</p>
<p><a href="https://leetcode.cn/problems/implement-trie-prefix-tree/">å®ç° Trie (å‰ç¼€æ ‘)</a>ï¼š</p>
<p>å­—å…¸æ ‘æ¯ä¸ªèŠ‚ç‚¹ç”± è¯ç»“æŸæ ‡ï¼ˆå½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºä¸€ä¸ªè¯çš„ç»“å°¾å­—ç¬¦ï¼‰ + èŠ‚ç‚¹æ•°ç»„ï¼ˆæ•°ç»„ä¸­ä¸ä¸ºnullçš„ä½ç½®çš„ç´¢å¼•å¯¹åº”äºè¯¥èŠ‚ç‚¹æ‰€è¡¨ç¤ºçš„å­—ç¬¦ï¼Œè¯¥ä½ç½®çš„å€¼ä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼‰ ç»„æˆ</p>
<p>æ ¹èŠ‚ç‚¹çš„èŠ‚ç‚¹æ•°ç»„ä¸å«è¯ä¿¡æ¯ï¼Œä»…ä½œä¸ºå‡ºå‘ç‚¹ä½¿ç”¨</p>
<p>ref: <a href="https://blog.csdn.net/m0_46202073/article/details/107253959">https://blog.csdn.net/m0_46202073/article/details/107253959</a></p>
<h3 id="å­—ç¬¦ä¸²">å­—ç¬¦ä¸²</h3>
<p><a href="https://www.fastprep.io/problems/amazon-match-strings">co*dä¸codeçš„åŒ¹é… </a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] matchStrings(String[] text, String[] pat) &#123;</span><br><span class="line">       String[] results = <span class="keyword">new</span> <span class="title class_">String</span>[text.length];</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; text.length; i++) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">t</span> <span class="operator">=</span> text[i];</span><br><span class="line">           <span class="type">String</span> <span class="variable">p</span> <span class="operator">=</span> pat[i];</span><br><span class="line">           <span class="type">int</span> <span class="variable">wildcardIndex</span> <span class="operator">=</span> p.indexOf(<span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// Split pattern into prefix and suffix</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> p.substring(<span class="number">0</span>, wildcardIndex);</span><br><span class="line">           <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> p.substring(wildcardIndex + <span class="number">1</span>);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// Check if the prefix matches the start of the text</span></span><br><span class="line">           <span class="comment">// and the suffix matches the end of the text</span></span><br><span class="line">           <span class="keyword">if</span> (t.startsWith(prefix) &amp;&amp; t.endsWith(suffix)) &#123;</span><br><span class="line">               <span class="comment">// Check if the combined length of prefix and suffix is less than or equal to text length</span></span><br><span class="line">               <span class="keyword">if</span> (prefix.length() + suffix.length() &lt;= t.length()) &#123;</span><br><span class="line">                   results[i] = <span class="string">&quot;YES&quot;</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   results[i] = <span class="string">&quot;NO&quot;</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               results[i] = <span class="string">&quot;NO&quot;</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> results;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="å †">å †</h3>
<p><a href="https://leetcode.cn/problems/kth-largest-element-in-an-array/">æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ </a></p>
<p>ä»midå‘å‰éå†åˆ°rootï¼Œè°ƒç”¨ è‡ªä¸Šè€Œä¸‹ çš„æœ€å¤§å †å‡½æ•°ï¼Œå®ç°æœ€å¤§å †å»ºç«‹</p>
<h3 id="å•è°ƒæ ˆ">å•è°ƒæ ˆ</h3>
<p>å•è°ƒå¢æ ˆ</p>
<ul>
<li>
<p>å•è°ƒé€’å¢æ ˆå³æ ˆå†…å…ƒç´ ä¿æŒå•è°ƒé€’å¢çš„æ ˆ</p>
</li>
<li>
<p>å¦‚æœæ–°çš„å…ƒç´ æ¯”æ ˆé¡¶å…ƒç´ å¤§ï¼Œå°±å…¥æ ˆ</p>
</li>
<li>
<p>å¦‚æœæ–°çš„å…ƒç´ è¾ƒå°ï¼Œé‚£å°±ä¸€ç›´æŠŠæ ˆå†…å…ƒç´ å¼¹å‡ºæ¥ï¼Œç›´åˆ°æ ˆé¡¶æ¯”æ–°å…ƒç´ å°</p>
</li>
</ul>
<p>æ ¸å¿ƒï¼š</p>
<ul>
<li>å½“éå†åˆ°å…ƒç´ Xæ—¶ï¼Œå‘ç”Ÿå‡ºæ ˆï¼Œå‡ºæ ˆå…ƒç´ Aï¼Œè¯´æ˜å…ƒç´ Xæ˜¯å‡ºæ ˆå…ƒç´ Aå‘åæ–¹å‘ç¬¬ä¸€ä¸ªæ¯”å…¶å°çš„å…ƒç´ </li>
<li>å½“éå†åˆ°å…ƒç´ Xæ—¶ï¼Œå‘ç”Ÿå‡ºæ ˆï¼Œå‡ºæ ˆå…ƒç´ Aï¼Œå½“å‰æ ˆé¡¶å…ƒç´ Bï¼Œè¯´æ˜æ ˆé¡¶å…ƒç´ Bæ˜¯å‡ºæ ˆå…ƒç´ Aå‘å‰æ–¹å‘ç¬¬ä¸€ä¸ªæ¯”å…¶å°çš„å…ƒç´ </li>
</ul>
<p><a href="https://leetcode.cn/problems/largest-rectangle-in-histogram/">æŸ±çŠ¶å›¾ä¸­æœ€å¤§çš„çŸ©å½¢</a></p>
<p><a href="https://leetcode.cn/problems/trapping-rain-water/">æ¥é›¨æ°´</a></p>
<h3 id="å›æº¯">å›æº¯</h3>
<p>ç”»å‡ºå›æº¯æ ‘ï¼</p>
<p>å›æº¯ä½“ï¼šå¶èŠ‚ç‚¹å¤„ç†-&gt;å·¦å­æ ‘è¿›å…¥-&gt;å³å­æ ‘è¿›å…¥</p>
<p><a href="https://leetcode.cn/problems/subsets/">å­é›†</a></p>
<p>åŸºç¡€</p>
<p><a href="https://leetcode.cn/problems/permutations-ii/">å…¨æ’åˆ— II</a></p>
<p>å‰ªææ¡ä»¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">i &gt; <span class="number">0</span> &amp;&amp; nums[i] == nums[i-<span class="number">1</span>] &amp;&amp; used[i-<span class="number">1</span>] == <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>å‰ªææ¡ä»¶ 1ï¼šç”¨è¿‡çš„å…ƒç´ ä¸èƒ½å†ä½¿ç”¨;</p>
<p>å‰ªææ¡ä»¶ 2ï¼šå½“å‰å…ƒç´ å’Œå‰ä¸€ä¸ªå…ƒç´ å€¼ç›¸åŒï¼ˆæ­¤å¤„éšå«è¿™ä¸ªå…ƒç´ çš„ index&gt;0 ï¼‰ï¼Œå¹¶ä¸”å‰ä¸€ä¸ªå…ƒç´ è¿˜æ²¡æœ‰è¢«ä½¿ç”¨è¿‡çš„æ—¶å€™</p>
<h3 id="åŒæŒ‡é’ˆ">åŒæŒ‡é’ˆ</h3>
<p>ã€ŒåŒæŒ‡é’ˆã€ï¼Œå½“æˆ‘ä»¬éœ€è¦æšä¸¾æ•°ç»„ä¸­çš„ä¸¤ä¸ªå…ƒç´ æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å‘ç°éšç€ç¬¬ä¸€ä¸ªå…ƒç´ çš„é€’å¢ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯é€’å‡çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨åŒæŒ‡é’ˆçš„æ–¹æ³•ï¼Œå°†æšä¸¾çš„æ—¶é—´å¤æ‚åº¦ä» O(N^2) å‡å°‘è‡³ O(N)ã€‚</p>
<p>å³åœ¨ä¸€æ¬¡å¾ªç¯ä¸­ï¼ŒåŒæ—¶å­˜åœ¨ä¸¤ä¸ªç§»åŠ¨çš„æŒ‡é’ˆï¼Œ<strong>è¯¥æ–¹æ³•æ—¨åœ¨å‡å°‘ä¸€å±‚å¾ªç¯</strong></p>
<h3 id="äºŒåˆ†æŸ¥æ‰¾">äºŒåˆ†æŸ¥æ‰¾</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] array, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">low</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">high</span> <span class="operator">=</span> array.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> low + (high - low) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (array[mid] == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array[mid] &lt; target) &#123;</span><br><span class="line">            low = mid + <span class="number">1</span>; <span class="comment">// lowç§»åŠ¨åˆ°mid + 1, é˜²æ­¢ä¸å¿…è¦çš„æ¯”è¾ƒå’Œæ— é™å¾ªç¯</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            high = mid - <span class="number">1</span>; <span class="comment">// ç›¸åŒåŸå› </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// æœªæ‰¾åˆ°ç›®æ ‡å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ»‘åŠ¨çª—å£">æ»‘åŠ¨çª—å£</h3>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆè¡¨ç¤ºå­—ç¬¦ä¸²ä¸­çš„æŸä¸ªå­ä¸²ï¼ˆæˆ–çª—å£ï¼‰çš„å·¦å³è¾¹ç•Œï¼›</p>
<p>åœ¨æ¯ä¸€æ­¥çš„æ“ä½œä¸­ï¼Œæˆ‘ä»¬ä¼šå°†å·¦æŒ‡é’ˆå‘å³ç§»åŠ¨ä¸€æ ¼ï¼Œè¡¨ç¤º æˆ‘ä»¬å¼€å§‹æšä¸¾ä¸‹ä¸€ä¸ªå­—ç¬¦ä½œä¸ºèµ·å§‹ä½ç½®ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä¸æ–­åœ°å‘å³ç§»åŠ¨å³æŒ‡é’ˆï¼Œä½†éœ€è¦ä¿è¯è¿™ä¸¤ä¸ªæŒ‡é’ˆå¯¹åº”çš„å­ä¸²ä¸­æ²¡æœ‰é‡å¤çš„å­—ç¬¦ã€‚åœ¨ç§»åŠ¨ç»“æŸåï¼Œè¿™ä¸ªå­ä¸²å°±å¯¹åº”ç€ ä»¥å·¦æŒ‡é’ˆå¼€å§‹çš„ï¼Œä¸åŒ…å«é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²ã€‚æˆ‘ä»¬è®°å½•ä¸‹è¿™ä¸ªå­ä¸²çš„é•¿åº¦ï¼›</p>
<p>åœ¨æšä¸¾ç»“æŸåï¼Œæˆ‘ä»¬æ‰¾åˆ°çš„æœ€é•¿çš„å­ä¸²çš„é•¿åº¦å³ä¸ºç­”æ¡ˆã€‚</p>
<p><strong>è¯¥æ–¹æ³•æ—¨åœ¨åˆ©ç”¨å·²æœ‰çš„ä¿¡æ¯ï¼ˆå³å·²ç»éå†è¿‡çš„ä¸åŠ é‡å¤éå†ï¼Œç±»ä¼¼äºåŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼‰</strong></p>
<h3 id="çº¿æ®µæ ‘">çº¿æ®µæ ‘</h3>
<p>ç»Ÿè®¡æ•°ç»„ä¸­ä»»æ„ [a, b] çš„å’Œ/æœ€å¤§å€¼/â€¦</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">maxSubArrayIterState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> lSum, rSum, mSum, iSum;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">maxSubArrayIterState</span><span class="params">(<span class="type">int</span> lSum, <span class="type">int</span> rSum, <span class="type">int</span> mSum, <span class="type">int</span> iSum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lSum = lSum;</span><br><span class="line">        <span class="built_in">this</span>.rSum = rSum;</span><br><span class="line">        <span class="built_in">this</span>.iSum = iSum;</span><br><span class="line">        <span class="built_in">this</span>.mSum = mSum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> maxSubArrayIterState <span class="title function_">maxSubArrayIter</span><span class="params">(<span class="type">int</span>[] a, <span class="type">int</span> l, <span class="type">int</span> r)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">maxSubArrayIterState</span>(a[l], a[l], a[l], a[l]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">maxSubArrayIterState</span> <span class="variable">lInterval</span> <span class="operator">=</span> maxSubArrayIter(a,l, (l + r) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="type">maxSubArrayIterState</span> <span class="variable">rInterval</span> <span class="operator">=</span> maxSubArrayIter(a, (((l + r) &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>), r);</span><br><span class="line">    <span class="type">int</span> <span class="variable">lS</span> <span class="operator">=</span> Math.max(lInterval.lSum, lInterval.iSum + rInterval.lSum);</span><br><span class="line">    <span class="type">int</span> <span class="variable">rS</span> <span class="operator">=</span> Math.max(rInterval.rSum, rInterval.iSum + lInterval.rSum);</span><br><span class="line">    <span class="type">int</span> <span class="variable">mS</span> <span class="operator">=</span> Math.max(Math.max(lInterval.mSum, rInterval.mSum), lInterval.rSum + rInterval.lSum);</span><br><span class="line">    <span class="type">int</span> <span class="variable">iS</span> <span class="operator">=</span> lInterval.iSum + rInterval.iSum;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">maxSubArrayIterState</span>(lS, rS, mS, iS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Dynamic-Programming">Dynamic Programming</h3>
<p>æ¨¡æ¿</p>
<p><a href="https://leetcode.cn/problems/edit-distance/">ç¼–è¾‘è·ç¦»</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="comment">// å®Œæ•´dpæ¨¡æ¿</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minDistance</span><span class="params">(String word1, String word2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l1</span> <span class="operator">=</span> word1.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">l2</span> <span class="operator">=</span> word2.length();</span><br><span class="line">        <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[l1 + <span class="number">1</span>][l2 + <span class="number">1</span>];  </span><br><span class="line">        <span class="comment">// dp[i][j]è¡¨ç¤ºword1[0:i]å’Œword2[0:j]ä¹‹é—´çš„ç¼–è¾‘è·ç¦»ã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; l1 + <span class="number">1</span>; i++) &#123; <span class="comment">// 0åˆ—åˆå§‹åŒ–</span></span><br><span class="line">            dp[i][<span class="number">0</span>] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; l2 + <span class="number">1</span>; j++) &#123; <span class="comment">// 0è¡Œåˆå§‹åŒ–</span></span><br><span class="line">            dp[<span class="number">0</span>][j] = j;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= l1; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= l2; ++j)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// é€’æ¨å…¬å¼</span></span><br><span class="line">                <span class="keyword">if</span> (word1.charAt(i - <span class="number">1</span>) == word2.charAt(j - <span class="number">1</span>)) &#123;</span><br><span class="line">                    dp[i][j] = <span class="number">1</span> + Math.min(dp[i - <span class="number">1</span>][j - <span class="number">1</span>] - <span class="number">1</span>, Math.min(dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>]));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dp[i][j] = <span class="number">1</span> + Math.min(dp[i - <span class="number">1</span>][j - <span class="number">1</span>], Math.min( dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[l1][l2];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜åŒ–ç‚¹ï¼š</p>
<ol>
<li>
<p><code>dp[nums.length]</code> æˆ– <code>dp[nums.length + 1]</code></p>
</li>
<li>
<p>åˆå§‹åŒ–</p>
</li>
<li>
<p>éå†é¡ºåº</p>
</li>
<li>
<p>é€’æ¨å…¬å¼</p>
</li>
<li>
<p>è¿”å›å€¼</p>
</li>
</ol>
<p><s>åŠ¨æ€è§„åˆ’</s></p>
<p>è´ªå¿ƒå‰ªæçš„å…¨çŠ¶æ€å€¼è®°å½•</p>
<h4 id="DPé—®é¢˜åˆ†æ">DPé—®é¢˜åˆ†æ</h4>
<p>é€’å½’&amp;åŠ¨æ€è§„åˆ’</p>
<img src="/2024/04/25/Algo-Learning-Record/IMG_0091.PNG" class="" title="IMG_0091(20240425-192828)">
<p><strong>DPæ ¸å¿ƒï¼š</strong></p>
<p>1.çŠ¶æ€</p>
<blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼ŒæŸä¸€å¤©ä¸ºçŠ¶æ€ç»´åº¦1ï¼ŒæŸä¸€å¤©çš„æŸä¸€ç§çŠ¶æ€ä¸ºçŠ¶æ€ç»´åº¦2</p>
</blockquote>
<p>2.èµ·ç‚¹å’Œç»ˆç‚¹</p>
<blockquote>
<p>ä¸€èˆ¬ç»ˆç‚¹éƒ½æ˜¯ç¡®å®šçš„ï¼Œå¶å°”èµ·ç‚¹ä¹Ÿä¼šæ˜¯ç¡®å®šçš„</p>
</blockquote>
<p>3.å¦‚ä½•è½¬ç§»+å‰ªæ</p>
<blockquote>
<p>è¶Šå¤æ‚çš„é—®é¢˜è½¬ç§»è¶Šå¤æ‚ï¼Œä¾‹å¦‚ï¼šä»<code>çŠ¶æ€[x][y][z]</code>è½¬ç§»åˆ°<code>çŠ¶æ€[x+1][y][z]</code></p>
<p>ä¸€èˆ¬é‡‡ç”¨è´ªå¿ƒå‰ªæï¼Œç§»é™¤ä¸éœ€è¦çš„çŠ¶æ€é“¾</p>
</blockquote>
<h4 id="æ— æƒå›¾ä¸¤ç‚¹é—´è·¯å¾„æ•°">æ— æƒå›¾ä¸¤ç‚¹é—´<strong>è·¯å¾„æ•°</strong></h4>
<p>é€’å½’æ€è·¯ï¼š</p>
<p>1.ä»ç»ˆç‚¹å‡ºå‘ï¼Œå­˜åœ¨å¤šä¸ªé€‰æ‹©ï¼Œæ¯ä¸ªé€‰æ‹©ä¸ºåˆ†æ”¯ï¼Œ<strong>ä¼ å…¥é€’å½’å‡½æ•°</strong>å¹¶è¿›å…¥ï¼›å–å¾—é€’å½’ç»“æœç›¸åŠ ã€‚</p>
<p>2.å¯¹äºæ¯ä¸€ä¸ªä¸­é—´æ€ï¼Œå­˜åœ¨å¤šä¸ªé€‰æ‹©ï¼Œ<strong>ä¼ å…¥é€’å½’å‡½æ•°</strong>å¹¶è¿›å…¥ï¼›</p>
<p>3.åˆ°è¾¾èµ·ç‚¹ï¼Œå½“å‰é€’å½’ç»“æŸï¼Œè¿”å›ï¼›</p>
<p>DPæ€è·¯ï¼š</p>
<p>1.ä»èµ·ç‚¹å‡ºå‘ï¼Œåˆ°è¾¾æ‰€æœ‰<strong>é‚»æ¥ç‚¹</strong>çš„èµ°æ³•å·²çŸ¥ï¼›</p>
<p>2.åˆ°è¾¾<strong>æ¬¡é‚»æ¥ç‚¹</strong>çš„èµ°æ³•ä¸ºä»<strong>é‚»æ¥ç‚¹</strong>åˆ°<strong>æ¬¡é‚»æ¥ç‚¹</strong>çš„èµ°æ³•ä¹‹å’Œï¼›</p>
<p>3.åˆ°è¾¾ç»ˆç‚¹çš„èµ°æ³•ä¸ºä»<strong>ç»ˆç‚¹é‚»æ¥ç‚¹</strong>åˆ°ç»ˆç‚¹çš„èµ°æ³•ä¹‹å’Œï¼›</p>
<p>å®ä¾‹ï¼š</p>
<img src="/2024/04/25/Algo-Learning-Record/image-20240426101614103.png" class="" title="image-20240426101614103">
<p>é€’å½’</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">pathsCount</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ°è¾¾èµ·ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span>(m == <span class="number">1</span> || n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//ä»ç»ˆç‚¹å‰è¿›</span></span><br><span class="line">    <span class="keyword">return</span> pathsCount(m - <span class="number">1</span>, n) + pathsCount(m , n -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DP</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">pathsCounts</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[m][n];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–èµ·ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span> || j == <span class="number">0</span>) &#123;</span><br><span class="line">                dp[i][j] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//ä»èµ·ç‚¹å‰è¿›</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = dp[i-<span class="number">1</span>][j] + dp[i][j-<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ°è¾¾ç»ˆç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> dp[m-<span class="number">1</span>][n-<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æœ‰æƒå›¾ä¸¤ç‚¹é—´æœ€å¤§è·¯å¾„">æœ‰æƒå›¾ä¸¤ç‚¹é—´<strong>æœ€å¤§è·¯å¾„</strong></h4>
<p>é€’å½’æ€è·¯ï¼š</p>
<p>1.ä»ç»ˆç‚¹å‡ºå‘ï¼Œå­˜åœ¨å¤šä¸ªé€‰æ‹©ï¼Œæ¯ä¸ªé€‰æ‹©ä¸ºåˆ†æ”¯ï¼Œ<strong>ä¼ å…¥é€’å½’å‡½æ•°</strong>å¹¶è¿›å…¥ï¼›å–å¾—é€’å½’ç»“æœå–æœ€å¤§ã€‚</p>
<p>2.å¯¹äºæ¯ä¸€ä¸ªä¸­é—´æ€ï¼Œå­˜åœ¨å¤šä¸ªé€‰æ‹©ï¼Œ<strong>ä¼ å…¥é€’å½’å‡½æ•°</strong>å¹¶è¿›å…¥ï¼›</p>
<p>3.åˆ°è¾¾èµ·ç‚¹ï¼Œå½“å‰é€’å½’ç»“æŸï¼Œè¿”å›å½“å‰èŠ‚ç‚¹å€¼ï¼›</p>
<p>DPæ€è·¯ï¼š</p>
<p>1.ä»èµ·ç‚¹å‡ºå‘ï¼Œåˆ°è¾¾æ‰€æœ‰<strong>é‚»æ¥ç‚¹</strong>çš„è·ç¦»å¯çŸ¥ï¼›</p>
<p>2.åˆ°è¾¾<strong>æ¬¡é‚»æ¥ç‚¹</strong>çš„æœ€å¤§è·ç¦»ä¸ºä»<strong>é‚»æ¥ç‚¹</strong>åˆ°<strong>æ¬¡é‚»æ¥ç‚¹</strong>çš„æœ€å¤§è·ç¦»ï¼›</p>
<p>3.åˆ°è¾¾ç»ˆç‚¹çš„èµ°æ³•ä¸ºä»<strong>ç»ˆç‚¹é‚»æ¥ç‚¹</strong>åˆ°ç»ˆç‚¹çš„æœ€å¤§è·ç¦»ï¼›</p>
<p>å®ä¾‹ï¼š</p>
<img src="/2024/04/25/Algo-Learning-Record/image-20240426102031155.png" class="" title="image-20240426102031155">
<p>é€’å½’</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minPathSum</span><span class="params">(<span class="type">int</span>[][] grid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> grid.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="comment">//ä»ç»ˆç‚¹å‰è¿›</span></span><br><span class="line">    <span class="keyword">return</span> getMin(grid, m-<span class="number">1</span>, n-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMin</span><span class="params">(<span class="type">int</span>[][] grid, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ°è¾¾èµ·ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">0</span> &amp;&amp; j == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> grid[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> grid[i][j] + getMin(grid, i, j-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(j == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> grid[i][j] + getMin(grid, i-<span class="number">1</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">minRow</span> <span class="operator">=</span> getMin(grid, i-<span class="number">1</span>, j);</span><br><span class="line">    <span class="type">int</span> <span class="variable">minColumn</span> <span class="operator">=</span> getMin(grid, i, j-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> grid[i][j] + Math.min(minRow, minColumn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DP</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minPathSum</span><span class="params">(<span class="type">int</span>[][] grid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> grid.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[m][n];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–èµ·ç‚¹</span></span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = grid[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; m ;i++) &#123;</span><br><span class="line">        dp[i][<span class="number">0</span>] = dp[i-<span class="number">1</span>][<span class="number">0</span>] + grid[i][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n;i++) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = dp[<span class="number">0</span>][i-<span class="number">1</span>] + grid[<span class="number">0</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»èµ·ç‚¹å‰è¿›</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = grid[i][j] + Math.min(dp[i-<span class="number">1</span>][j], dp[i][j-<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ°è¾¾ç»ˆç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> dp[m-<span class="number">1</span>][n-<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æŠ€å·§">æŠ€å·§</h3>
<p><a href="https://leetcode.cn/problems/find-the-duplicate-number/">å¯»æ‰¾é‡å¤æ•°</a>ï¼šæ•°ç»„ä¸­å­˜åœ¨å”¯ä¸€çš„å‡ºç°äº†ä¸¤æ¬¡çš„æ•°ï¼Œå…¶ä»–æ•°å‡ä¸ºä¸€æ¬¡</p>
<p>index-&gt;value(index)-&gt;value(index)â€¦ï¼Œå½¢æˆå«ç¯é“¾è¡¨ï¼š0-&gt;1-&gt;3-&gt;2-&gt;4-&gt;2-&gt;4â€¦</p>
<p>1ï¼Œ3ï¼Œ4ï¼Œ2ï¼Œ2ï¼›// value</p>
<p>0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼› // index</p>
<p><a href="https://leetcode.cn/problems/single-number/">åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—</a>ï¼šæ•°ç»„ä¸­å‡ºç°å”¯ä¸€ä»…å‡ºç°ä¸€æ¬¡çš„æ•°ï¼Œå…¶ä»–æ•°å‡ä¸ºä¸¤æ¬¡</p>
<p>å¼‚æˆ–</p>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>Java, Design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker/K8s</title>
    <url>/2024/08/16/Docker-K8s/</url>
    <content><![CDATA[<p>å®¹å™¨ç›¸å…³å­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>Container-related Learning Records</h1>
<p>å¾…å®Œæˆ</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-Learning-Record</title>
    <url>/2024/07/28/Android-Learning-Record/</url>
    <content><![CDATA[<p>Androidå­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>Android Learning Record</h1>
<h2 id="Androidç¨‹åº">Androidç¨‹åº</h2>
<h3 id="View">View</h3>
<p><strong>dp å’Œ sp</strong></p>
<p><strong>dp (Density-independent Pixel - å¯†åº¦æ— å…³åƒç´ )</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> dp æ˜¯ä¸€ä¸ªåŸºäºå±å¹•å¯†åº¦çš„æŠ½è±¡å•ä½ã€‚å®ƒä»£è¡¨äº†åœ¨ 160 dpi (dots per inch) å±å¹•ä¸Šä¸€ä¸ªç‰©ç†åƒç´ çš„é•¿åº¦ã€‚</li>
<li><strong>ç”¨é€”:</strong> ä¸»è¦ç”¨äºå®šä¹‰ View çš„å°ºå¯¸å’Œé—´è·ï¼Œä¾‹å¦‚æŒ‰é’®çš„å®½åº¦ã€è¾¹è·ã€å†…è¾¹è·ç­‰ã€‚</li>
<li><strong>ä¼˜åŠ¿:</strong> ä½¿ç”¨ dp å¯ä»¥ä¿è¯åº”ç”¨åœ¨ä¸åŒå±å¹•å¯†åº¦çš„è®¾å¤‡ä¸Šä¿æŒä¸€è‡´çš„æ˜¾ç¤ºæ•ˆæœã€‚ç³»ç»Ÿä¼šæ ¹æ®è®¾å¤‡çš„å±å¹•å¯†åº¦è‡ªåŠ¨å°† dp å€¼è½¬æ¢ä¸ºå¯¹åº”çš„åƒç´ å€¼ã€‚</li>
<li><strong>ç¤ºä¾‹:</strong>
<ul>
<li>android:layout_width=â€œ100dpâ€ è¡¨ç¤ºè¯¥ View çš„å®½åº¦ä¸º 100dpï¼Œåœ¨ä¸åŒå¯†åº¦çš„å±å¹•ä¸Šï¼Œç³»ç»Ÿä¼šå°†å…¶è½¬æ¢ä¸ºå¯¹åº”çš„åƒç´ å€¼ï¼Œä»¥ä¿æŒç›¸åŒçš„ç‰©ç†å°ºå¯¸ã€‚</li>
</ul>
</li>
</ul>
<p><strong>sp (Scale-independent Pixel - ç¼©æ”¾æ— å…³åƒç´ )</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> sp ä¸ dp ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåŸºäºå±å¹•å¯†åº¦çš„æŠ½è±¡å•ä½ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œsp è¿˜å—åˆ°ç”¨æˆ·å­—ä½“å¤§å°è®¾ç½®çš„å½±å“ã€‚</li>
<li><strong>ç”¨é€”:</strong> ä¸»è¦ç”¨äºå®šä¹‰æ–‡å­—å¤§å°ã€‚</li>
<li><strong>ä¼˜åŠ¿:</strong> ä½¿ç”¨ sp å¯ä»¥æ ¹æ®ç”¨æˆ·çš„å­—ä½“å¤§å°åå¥½è‡ªåŠ¨è°ƒæ•´æ–‡å­—å¤§å°ï¼Œæé«˜åº”ç”¨çš„å¯è®¿é—®æ€§ã€‚</li>
<li><strong>ç¤ºä¾‹:</strong>
<ul>
<li>android:textSize=â€œ18spâ€ è¡¨ç¤ºè¯¥ TextView çš„æ–‡å­—å¤§å°ä¸º 18spï¼Œå¦‚æœç”¨æˆ·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­è°ƒæ•´äº†å­—ä½“å¤§å°ï¼Œè¯¥ TextView çš„æ–‡å­—å¤§å°ä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚</li>
</ul>
</li>
</ul>
<p><strong>layout_gravity å’Œ gravity</strong></p>
<p><strong>layout_gravity</strong></p>
<ul>
<li><strong>ä½œç”¨ç›®æ ‡:</strong> layout_gravity å±æ€§ç”¨äºæ§åˆ¶ <strong>å½“å‰ View åœ¨å…¶çˆ¶å¸ƒå±€ä¸­çš„å¯¹é½æ–¹å¼</strong>ã€‚</li>
<li><strong>é€‚ç”¨èŒƒå›´:</strong> è¯¥å±æ€§åªèƒ½åº”ç”¨äº <strong>ViewGroup çš„å­ View</strong>ï¼Œå› ä¸ºå®ƒéœ€è¦ä¾èµ–äºçˆ¶å¸ƒå±€çš„ç‰¹æ€§æ‰èƒ½ç”Ÿæ•ˆã€‚</li>
<li><strong>å¸¸è§å–å€¼:</strong>
<ul>
<li>topã€bottomã€leftã€rightï¼šåˆ†åˆ«è¡¨ç¤ºé¡¶éƒ¨å¯¹é½ã€åº•éƒ¨å¯¹é½ã€å·¦ä¾§å¯¹é½ã€å³ä¾§å¯¹é½ã€‚</li>
<li>centerï¼šè¡¨ç¤ºæ°´å¹³å’Œå‚ç›´å±…ä¸­å¯¹é½ã€‚</li>
<li>center_horizontalã€center_verticalï¼šåˆ†åˆ«è¡¨ç¤ºæ°´å¹³å±…ä¸­å¯¹é½ã€å‚ç›´å±…ä¸­å¯¹é½ã€‚</li>
<li>startã€endï¼šåˆ†åˆ«è¡¨ç¤ºåœ¨å½“å‰è¯­è¨€ç¯å¢ƒä¸‹ï¼Œå†…å®¹å¼€å§‹çš„æ–¹å‘å¯¹é½ã€å†…å®¹ç»“æŸçš„æ–¹å‘å¯¹é½ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨ | ç¬¦å·ç»„åˆå¤šä¸ªå€¼ï¼Œä¾‹å¦‚ android:layout_gravity=â€œbottom|rightâ€ è¡¨ç¤ºå³ä¸‹è§’å¯¹é½ã€‚</li>
</ul>
</li>
</ul>
<p><strong>gravity</strong></p>
<ul>
<li>
<p><strong>ä½œç”¨ç›®æ ‡:</strong> gravity å±æ€§ç”¨äºæ§åˆ¶ <strong>å½“å‰ View ä¸­çš„å†…å®¹å¯¹é½æ–¹å¼</strong>ã€‚</p>
</li>
<li>
<p><strong>é€‚ç”¨èŒƒå›´:</strong> è¯¥å±æ€§å¯ä»¥åº”ç”¨äº <strong>ä»»ä½• View</strong>ï¼Œå› ä¸ºå®ƒæ§åˆ¶çš„æ˜¯ View è‡ªèº«å†…å®¹çš„æ˜¾ç¤ºæ–¹å¼ã€‚</p>
</li>
<li>
<p><strong>å¸¸è§å–å€¼:</strong></p>
<ul>
<li>ä¸ layout_gravity çš„å–å€¼åŸºæœ¬ç›¸åŒï¼Œä¾‹å¦‚ topã€bottomã€leftã€rightã€center ç­‰ç­‰ã€‚</li>
</ul>
</li>
</ul>
<p><strong>padding ä¸ margin</strong></p>
<ul>
<li>
<p><strong>padding(å†…è¾¹è·)ï¼š</strong></p>
<ul>
<li>ä½¿è§†å›¾çš„å†…å®¹ä¸å…¶è¾¹ç•Œä¿æŒä¸€å®šçš„è·ç¦»ã€‚</li>
<li>ä½¿ TextView ä¸­çš„æ–‡å­—è·ç¦» TextView çš„è¾¹ç•Œ 10dpï¼Œè®¾ç½® android:padding=â€œ10dpâ€ã€‚</li>
<li>padding å°±åƒæ˜¯åœ¨è§†å›¾å†…éƒ¨åŠ äº†ä¸€åœˆç©ºç™½è¾¹æ¡†ï¼Œä½¿å¾—å†…å®¹ä¸ä¼šç´§è´´ç€è§†å›¾è¾¹ç•Œã€‚</li>
</ul>
</li>
<li>
<p><strong>margin(å¤–è¾¹è·)ï¼š</strong></p>
<ul>
<li>æ§åˆ¶è§†å›¾åœ¨å¸ƒå±€ä¸­çš„ä½ç½®ï¼Œæˆ–è€…è®©è§†å›¾ä¹‹é—´ä¿æŒä¸€å®šçš„è·ç¦»ã€‚</li>
<li>ä½¿ä¸¤ä¸ª Button ä¹‹é—´ä¿æŒ 20dp çš„è·ç¦»ï¼Œå°±å¯ä»¥ä¸ºå…¶ä¸­ä¸€ä¸ª Button è®¾ç½® android:layout_marginRight=â€œ20dpâ€ï¼Œæˆ–è€…ä¸ºå¦ä¸€ä¸ª Button è®¾ç½® android:layout_marginLeft=â€œ20dpâ€ã€‚</li>
<li><strong>margin å°±åƒæ˜¯åœ¨è§†å›¾å¤–éƒ¨åŠ äº†ä¸€åœˆé€æ˜è¾¹æ¡†ï¼Œä½¿å¾—è§†å›¾ä¸å…¶ä»–è§†å›¾ä¹‹é—´ä¿æŒä¸€å®šçš„è·ç¦»ã€‚</strong></li>
</ul>
</li>
</ul>
<p>marginå’Œpaddingä½œç”¨å¯¹è±¡éƒ½æ˜¯è‡ªèº«ï¼Œéå…¶ä»–è§†å›¾</p>
<p><strong>ConstrainLayout</strong></p>
<ul>
<li>
<p><strong>android:layout_width=â€œ0dpâ€:</strong> åœ¨ ConstraintLayout ä¸­ï¼Œå°†è§†å›¾çš„å®½åº¦è®¾ç½®ä¸º 0dp æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç”¨æ³•ã€‚å®ƒè¡¨ç¤ºè¯¥è§†å›¾çš„å®½åº¦åº”è¯¥ <strong>åŒ¹é…çº¦æŸæ¡ä»¶</strong>ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒButton çš„å·¦å³ä¸¤è¾¹åˆ†åˆ«è¢«çº¦æŸåˆ°äº† login_container çš„å·¦å³ä¸¤è¾¹ (app:layout_constraintEnd_toEndOf=â€œ@id/login_containerâ€ å’Œ app:layout_constraintStart_toStartOf=â€œ@id/login_containerâ€)ï¼Œå› æ­¤ Button çš„å®½åº¦ä¼šæ‰©å±•åˆ°ä¸ login_container çš„å®½åº¦ç›¸åŒã€‚</p>
</li>
<li>
<p><strong>app:layout_marginâ€¦</strong>: è¿™æ˜¯ä¸€ç»„ä¸“é—¨ç”¨äº ConstraintLayout çš„ margin å±æ€§ï¼Œç”¨äºè®¾ç½®è§†å›¾ä¸å…¶çº¦æŸç›®æ ‡ä¹‹é—´çš„è·ç¦»ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>app:layout_marginStartï¼šè®¾ç½®è§†å›¾ä¸å…¶çº¦æŸç›®æ ‡çš„èµ·å§‹è¾¹è·ï¼ˆå–å†³äºå¸ƒå±€æ–¹å‘ï¼Œå¯èƒ½æ˜¯å·¦è¾¹è·æˆ–å³è¾¹è·ï¼‰ã€‚</li>
<li>app:layout_marginEndï¼šè®¾ç½®è§†å›¾ä¸å…¶çº¦æŸç›®æ ‡çš„ç»“æŸè¾¹è·ã€‚</li>
<li>app:layout_marginTopï¼šè®¾ç½®è§†å›¾ä¸å…¶çº¦æŸç›®æ ‡çš„é¡¶éƒ¨è¾¹è·ã€‚</li>
<li>app:layout_marginBottomï¼šè®¾ç½®è§†å›¾ä¸å…¶çº¦æŸç›®æ ‡çš„åº•éƒ¨è¾¹è·ã€‚</li>
</ul>
</li>
</ul>
<p><strong>RecyclerView</strong></p>
<p>onCreateViewHolderè§¦å‘æ—¶æœº</p>
<ul>
<li><strong>é¦–æ¬¡åŠ è½½ RecyclerView æ—¶ï¼š</strong> å½“ RecyclerView ç¬¬ä¸€æ¬¡è¢«åŠ è½½åˆ°å±å¹•ä¸Šæ—¶ï¼ŒonCreateViewHolder æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œç”¨äºåˆ›å»º ViewHolder å®ä¾‹ã€‚æ­¤æ—¶ï¼ŒRecyclerView éœ€è¦æ ¹æ®ä½ çš„å¸ƒå±€æ–‡ä»¶å®ä¾‹åŒ– ViewHolderï¼Œå¹¶å°†å®ƒä»¬ç¼“å­˜èµ·æ¥ä»¥å¤‡åç”¨ã€‚</li>
<li><strong>ç¼“å­˜ä¸­æ²¡æœ‰å¯ç”¨çš„ ViewHolder æ—¶ï¼š</strong> å½“ç”¨æˆ·æ»šåŠ¨ RecyclerViewï¼Œéœ€è¦æ˜¾ç¤ºæ–°çš„ itemï¼Œè€Œç¼“å­˜ä¸­æ²¡æœ‰å¯ç”¨çš„ ViewHolder æ—¶ï¼ŒonCreateViewHolder ä¼šè¢«è°ƒç”¨ä»¥åˆ›å»ºæ–°çš„ ViewHolderã€‚</li>
</ul>
<p>onBindViewHolderè§¦å‘æ—¶æœº</p>
<ul>
<li><strong>é¦–æ¬¡åŠ è½½ RecyclerView æ—¶ï¼š</strong> åœ¨ onCreateViewHolder åˆ›å»ºäº† ViewHolder åï¼ŒonBindViewHolder æ–¹æ³•ä¼šè¢«ç«‹å³è°ƒç”¨ï¼Œç”¨äºå°†æ•°æ®ç»‘å®šåˆ° ViewHolder ä¸Šã€‚</li>
<li><strong>ç”¨æˆ·æ»šåŠ¨ RecyclerViewï¼Œæ–°çš„ item éœ€è¦æ˜¾ç¤ºæ—¶ï¼š</strong> å½“ç”¨æˆ·æ»šåŠ¨ RecyclerViewï¼Œæ–°çš„ item è¿›å…¥å±å¹•æ—¶ï¼ŒonBindViewHolder ä¼šè¢«è°ƒç”¨ï¼Œå°†å¯¹åº”ä½ç½®çš„æ•°æ®ç»‘å®šåˆ°å¤ç”¨çš„ ViewHolder ä¸Šã€‚</li>
<li><strong>è°ƒç”¨ notifyDataSetChanged() ç­‰æ–¹æ³•åˆ·æ–° RecyclerView æ—¶ï¼š</strong> å½“ä½ æ›´æ–°äº†æ•°æ®æºå¹¶è°ƒç”¨ notifyDataSetChanged()ã€notifyItemInserted() ç­‰æ–¹æ³•åˆ·æ–° RecyclerView æ—¶ï¼ŒonBindViewHolder ä¼šè¢«è°ƒç”¨ï¼Œä»¥æ›´æ–° ViewHolder çš„æ•°æ®ã€‚</li>
</ul>
<p><strong>LayoutInflater</strong></p>
<p>LayoutInflater æ˜¯ä¸ Context ç»‘å®šçš„ï¼Œè€Œ Activity æœ¬èº«å°±æ˜¯ä¸€ä¸ª Contextã€‚æ¯ä¸ª Activity éƒ½ä¼šæŒæœ‰è‡ªå·±å”¯ä¸€çš„ LayoutInflater å¯¹è±¡ï¼Œç”¨äºåŠ è½½å¸ƒå±€æ–‡ä»¶ã€‚</p>
<p>è¯¥ Activity ä¸­æ‰€æœ‰çš„ Fragment å’Œ RecyclerView æ‰€ä½¿ç”¨çš„ LayoutInflater å¯¹è±¡ä¸º Activity å¯¹åº”çš„ Context LayoutInflater å¯¹è±¡</p>
<p>**ViewBinding ä¸ ViewHolder **</p>
<p>åœ¨å¯ç”¨ViewBindingåï¼ŒViewBinding ä¼šä¸ºæ¯ä¸ª XML å¸ƒå±€æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªç»‘å®šç±»</p>
<p>é’ˆå¯¹æ¯ä¸ªxmlæ–‡ä»¶ï¼Œå°†ä½¿ç”¨(xmlçš„é©¼å³°æ–‡ä»¶å+Bindng)ä½œä¸ºjavaæ–‡ä»¶åçš„æ–¹å¼ï¼Œç”Ÿæˆå¯¹åº”çš„javaç±»</p>
<p>xmlå¯¹åº”ç”Ÿæˆçš„ ViewBinding ç±»ï¼š</p>
<p><strong>æ ¹è§†å›¾å±æ€§ (<code>root</code>)</strong>:</p>
<ul>
<li>æ¯ä¸ªç”Ÿæˆçš„ ViewBinding ç±»éƒ½æœ‰ä¸€ä¸ª <code>root</code> å±æ€§ï¼Œè¡¨ç¤ºå¸ƒå±€çš„æ ¹è§†å›¾ï¼ˆé€šå¸¸æ˜¯æœ€å¤–å±‚çš„ <code>ViewGroup</code>ï¼‰ï¼Œé€šè¿‡ <code>getRoot()</code> è·å–ï¼Œä¸º View ç±»å‹ã€‚</li>
</ul>
<p><strong>æ¯ä¸ªè§†å›¾çš„å±æ€§ (<code>views</code>)</strong> :</p>
<ul>
<li>å¯¹äºå¸ƒå±€ä¸­çš„æ¯ä¸ªè§†å›¾ï¼ŒViewBinding ç±»ä¼šç”Ÿæˆä¸€ä¸ªç›¸åº”çš„å±æ€§ã€‚è¿™äº›å±æ€§çš„åç§°æ˜¯åŸºäºè§†å›¾çš„ <code>id</code> è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ ¼å¼ä¸º <code>viewId</code>ï¼Œå…¶ä¸­ <code>viewId</code> æ˜¯ XML å¸ƒå±€ä¸­è§†å›¾çš„ <code>android:id</code> å±æ€§ã€‚</li>
</ul>
<p><strong><code>inflate</code> æ–¹æ³•</strong>:</p>
<ul>
<li>ViewBinding ç±»æä¾›é™æ€ <code>inflate</code> æ–¹æ³•ï¼Œç”¨äºå°†å¸ƒå±€æ–‡ä»¶è½¬æ¢ä¸ºç›¸åº”çš„è§†å›¾å±‚æ¬¡ç»“æ„ï¼Œå¹¶è¿”å› ViewBinding ç±»çš„å®ä¾‹ã€‚
<ul>
<li><code>inflate</code> æ–¹æ³•è°ƒç”¨ LayoutInflater å°†å¸ƒå±€æ–‡ä»¶è½¬æ¢ä¸ºå¯¹åº”çš„ View å±‚çº§ç»“æ„ã€‚</li>
<li><code>inflate</code> æ–¹æ³•å°† View å®ä¾‹ç»‘å®šåˆ° Binding å¯¹è±¡çš„å±æ€§ä¸­ã€‚</li>
</ul>
</li>
</ul>
<p><strong><code>bind</code> æ–¹æ³•</strong>:</p>
<ul>
<li>ViewBinding ç±»è¿˜æä¾›ä¸€ä¸ªé™æ€ <code>bind</code> æ–¹æ³•ï¼Œç”¨äºå°†ç°æœ‰çš„è§†å›¾ï¼ˆæ¯”å¦‚å·²ç»é€šè¿‡ <code>setContentView()</code> åŠ è½½çš„è§†å›¾ï¼‰ç»‘å®šåˆ° ViewBinding ç±»ä¸Šã€‚</li>
</ul>
<p>ViewHolderåœ¨åˆ›å»ºæ—¶ï¼Œé€šè¿‡ new Viewholder(binding) åˆ›å»ºï¼Œå®é™…ä¸Šæ˜¯å°† binding.root èµ‹å€¼ç»™äº† ViewHolder.itemView</p>
<blockquote>
<p>ViewHolder åƒæ˜¯è§†å›¾çš„â€œæ§åˆ¶å™¨â€: ViewHolder å¯¹æ ¹è§†å›¾ (itemView) è¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œä½†å®ƒæ›´åƒæ˜¯ MVC æ¨¡å¼ä¸­çš„ Controllerï¼Œè´Ÿè´£ç®¡ç†è§†å›¾çš„ç”Ÿå‘½å‘¨æœŸã€æ•°æ®ç»‘å®šã€äº‹ä»¶å¤„ç†ç­‰é€»è¾‘ã€‚</p>
<p>ViewHolder åƒæ˜¯è§†å›¾çš„â€œè®¿é—®å™¨â€: ViewBinding æ˜¯å¯¹ View æ ‘è¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ï¼Œä½†å®ƒæ›´åƒæ˜¯æä¾›äº† ç±»å‹å®‰å…¨ã€ä¾¿æ· çš„æ–¹å¼æ¥è®¿é—®è§†å›¾ã€‚</p>
</blockquote>
<h3 id="Context">Context</h3>
<ul>
<li><strong>èµ„æºè®¿é—®:</strong> è·å–å­—ç¬¦ä¸²ã€é¢œè‰²ã€å°ºå¯¸ã€å›¾ç‰‡ç­‰èµ„æºã€‚</li>
<li><strong>ç»„ä»¶å¯åŠ¨:</strong> å¯åŠ¨ Activityã€Serviceã€BroadcastReceiver ç­‰ç»„ä»¶ã€‚</li>
<li><strong>ç³»ç»ŸæœåŠ¡è·å–:</strong> è·å–å¸ƒå±€æœåŠ¡ (LayoutInflater)ã€åŒ…ç®¡ç†å™¨ (PackageManager)ã€é€šçŸ¥æœåŠ¡ (NotificationManager) ç­‰ç³»ç»ŸæœåŠ¡ã€‚</li>
<li><strong>æ–‡ä»¶æ“ä½œ:</strong> è®¿é—®è®¾å¤‡å­˜å‚¨ã€ç¼“å­˜ç›®å½•ç­‰ã€‚</li>
<li><strong>æ•°æ®åº“æ“ä½œ:</strong> ä½¿ç”¨ SQLite æ•°æ®åº“ã€‚</li>
<li><strong>ç½‘ç»œæ“ä½œ:</strong> å‘é€ç½‘ç»œè¯·æ±‚ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å­—ç¬¦ä¸²èµ„æº</span></span><br><span class="line"><span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> context.getString(R.string.app_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–é¢œè‰²èµ„æº</span></span><br><span class="line"><span class="type">int</span> <span class="variable">primaryColor</span> <span class="operator">=</span> context.getColor(R.color.colorPrimary);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨ Activity</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context, SecondActivity.class);</span><br><span class="line">context.startActivity(intent);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å¸ƒå±€åŠ è½½å™¨</span></span><br><span class="line"><span class="type">LayoutInflater</span> <span class="variable">inflater</span> <span class="operator">=</span> LayoutInflater.from(context);</span><br><span class="line"><span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.my_layout, parent, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–åŒ…ç®¡ç†å™¨</span></span><br><span class="line"><span class="type">PackageManager</span> <span class="variable">packageManager</span> <span class="operator">=</span> context.getPackageManager();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–é€šçŸ¥æœåŠ¡</span></span><br><span class="line"><span class="type">NotificationManager</span> <span class="variable">notificationManager</span> <span class="operator">=</span> </span><br><span class="line">    (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);</span><br></pre></td></tr></table></figure>
<p><strong>ContextImplä¸ContextWrapper</strong></p>
<p>Contextç±»ä¸ºæŠ½è±¡ç±»ï¼Œå…¶ä¸­<strong>ContextImplæ˜¯Contextçš„å…·ä½“å®ç°ç±»ï¼ŒContextWrapperæ˜¯Contextçš„åŒ…è£…ç±»</strong>ã€‚ContextWrapperåœ¨åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºContextImplå¯¹è±¡ï¼ŒContextImplå¯¹è±¡å®ç°äº†Contextä¸­æ–¹æ³•ã€‚</p>
<blockquote>
<p>æ‰€ä»¥è¯´getApplication()å’ŒgetApplicationContext()è·å–åˆ°çš„éƒ½æ˜¯Applictionå¯¹è±¡ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ getApplicationContext() åº”è¯¥æ˜¯ä½¿ç”¨Applictionå¯¹è±¡çš„åŸºç±»ContextImplå¯¹è±¡</p>
</blockquote>
<p>åº”ç”¨ç¨‹åºä¸­æ‹¥æœ‰Contextçš„å¯¹è±¡ï¼š1 + numActivity + numService</p>
<ul>
<li>
<p><strong>Application:</strong> ç»§æ‰¿è‡ªContextWrapper</p>
</li>
<li>
<p><strong>Activity:</strong> ç»§æ‰¿äºContextWrapperçš„å­ç±»ContextThemeWrapperç±»ï¼Œ</p>
</li>
<li>
<p><strong>Service:</strong> ç»§æ‰¿äºContextWrapperç±»</p>
</li>
<li>
<p><strong>BroadcastReceiver:</strong> éç»§æ‰¿ï¼Œé€šè¿‡å…¶ä»–ä¼ å…¥è·å¾—</p>
</li>
<li>
<p><strong>ContentProvider:</strong> éç»§æ‰¿ï¼Œé€šè¿‡å…¶ä»–ä¼ å…¥è·å¾—</p>
</li>
</ul>
<p>å¯åŠ¨å…¶ä»–Activityå’Œå¼¹å‡ºDialogå¿…é¡»ä½¿ç”¨Activityçš„Context</p>
<ul>
<li>åŸºäºæŸActivityçš„Contextå¯åŠ¨çš„Activityå°†åœ¨æ­¤ActivityåŸºç¡€ä¸Šå½¢æˆä»»åŠ¡æ ˆï¼ˆå³Activityæ ˆï¼‰ï¼Œå¦‚æœä½¿ç”¨éActivityçš„Contextå¯åŠ¨Activityï¼Œå¿…é¡»æŒ‡å®šè¯¥Activityçš„å¯åŠ¨æ–¹å¼ä¸º <code>FLAG_ACTIVITY_NEW_TASK</code></li>
<li>View.getContextè¿”å›çš„æ˜¯è®¾ç½®è¯¥Viewå¸ƒå±€çš„Activityå¯¹è±¡çš„Context</li>
</ul>
<h2 id="Android">Android</h2>
<h3 id="å››å¤§ç»„ä»¶">å››å¤§ç»„ä»¶</h3>
<p>Activityï¼ˆæ´»åŠ¨ï¼‰ã€Serviceï¼ˆæœåŠ¡ï¼‰ã€BroadcastReceiverï¼ˆå¹¿æ’­æ¥æ”¶å™¨ï¼‰å’Œ ContentProviderï¼ˆå†…å®¹æä¾›è€…ï¼‰</p>
<h3 id="æŒä¹…åŒ–">æŒä¹…åŒ–</h3>
<p><strong>æ–‡ä»¶å­˜å‚¨</strong></p>
<p><strong>SharedPreference - DataStore</strong></p>
<p>key - value</p>
<p><strong>SQLite</strong></p>
<p>æ•°æ®åº“</p>
<h3 id="Adapter">Adapter</h3>
<p><code>Adapter</code> è´Ÿè´£ï¼š</p>
<ul>
<li>ä»æ•°æ®æºè·å–æ•°æ®</li>
<li>åˆ›å»º <code>View</code> å¹¶å°†æ•°æ®ç»‘å®šåˆ° <code>View</code> ä¸Š</li>
<li>é€šè¿‡ <code>notifyDataSetChanged()</code> åŠ¨æ€æ›´æ–° UI</li>
</ul>
<p>View â†’ adapter â†’ data</p>
<h3 id="Activityä¸Fragmentç”Ÿå‘½å‘¨æœŸ">Activityä¸Fragmentç”Ÿå‘½å‘¨æœŸ</h3>
<img src="/2024/07/28/Android-Learning-Record/activity_lifecycle.png" class="" title="image1.png">
<p>å•ä¸ªActivity:</p>
<p>åº”ç”¨å¼€å¯æ—¶ï¼šonCreate() -&gt; onStart() -&gt; onResume();</p>
<p>æŒ‰ä¸‹è¿”å›é”®ï¼šonPause() -&gt; onStop() -&gt; onDestory();</p>
<p>å¤šä¸ªActivityä¹‹é—´äº¤äº’æ—¶ï¼š</p>
<p>ä»ç¬¬ä¸€ä¸ªActivityå¯åŠ¨ç¬¬äºŒä¸ªActivityæ—¶ï¼š</p>
<table>
<thead>
<tr>
<th>FirstActivity</th>
<th>SecondActivity</th>
</tr>
</thead>
<tbody>
<tr>
<td>onPause()</td>
<td></td>
</tr>
<tr>
<td></td>
<td>onCreate()</td>
</tr>
<tr>
<td></td>
<td>onStart()</td>
</tr>
<tr>
<td></td>
<td>onResume()</td>
</tr>
<tr>
<td>onStop()</td>
<td></td>
</tr>
</tbody>
</table>
<p>æŒ‰ä¸‹é”å±é”®æ—¶</p>
<table>
<thead>
<tr>
<th>SecondActivity</th>
</tr>
</thead>
<tbody>
<tr>
<td>onPause()</td>
</tr>
<tr>
<td>onStop()</td>
</tr>
</tbody>
</table>
<p>å±å¹•è§£é”</p>
<table>
<thead>
<tr>
<th>SecondActivity</th>
</tr>
</thead>
<tbody>
<tr>
<td>onRestart()</td>
</tr>
<tr>
<td>OnStart()</td>
</tr>
<tr>
<td>OnResume()</td>
</tr>
</tbody>
</table>
<p>æŒ‰ä¸‹è¿”å›é”® / SecondActivityè°ƒç”¨ <code>finish()</code></p>
<table>
<thead>
<tr>
<th>FirstActivity</th>
<th>SecondActivity</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>onPause()</td>
</tr>
<tr>
<td>onRestart()</td>
<td></td>
</tr>
<tr>
<td>onStart()</td>
<td></td>
</tr>
<tr>
<td>onResume()</td>
<td></td>
</tr>
<tr>
<td></td>
<td>onStop()</td>
</tr>
<tr>
<td></td>
<td>onDestory()</td>
</tr>
</tbody>
</table>
<p>Fragment</p>
<p>åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯Activityå¸¦é¢†Fragmentæ‰§è¡Œç”Ÿå‘½å‘¨æœŸä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p>
<p>1.Activityâ€“onCreate();</p>
<p>2.Fragmentâ€“onAttach();</p>
<p>3.Fragmentâ€“onCreate();</p>
<p>4.Fragmentâ€“onCreateView();</p>
<p>5.Fragmentâ€“onActivityCreated();</p>
<p>æ¥ç€æ˜¯è¿™æ ·çš„ï¼š</p>
<p>6.Activityâ€“onStart();</p>
<p>7.Fragmentâ€“onStart();</p>
<p>8.Activityâ€“onResume();</p>
<p>9.Fragmentâ€“onResume();</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ— è®ºå¯¹äºActivityè¿˜æ˜¯å¯¹äºFragmentï¼ŒonResumeè¿™ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ä»–ä»¬æ‰§è¡Œæ—¶é—´æœ€é•¿çš„ï¼Œå½“æˆ‘ä»¬çš„Activityæˆ–è€…Fragmentæ‰“å¼€ä¹‹åï¼Œå®ƒå°±ä¸€ç›´å¤„äºè¿™ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ã€‚</p>
<p>å½“é”€æ¯çš„æ—¶å€™ï¼Œæ˜¥æ±Ÿæ°´æš–é¸­å…ˆçŸ¥ï¼Œå½“ç„¶æ˜¯Fragmentå…ˆæ„ŸçŸ¥åˆ°ï¼Œäºæ˜¯é”€æ¯çš„æ—¶å€™å°±æ˜¯Fragmentå¸¦é¢†Activityï¼š</p>
<p>10.Fragmentâ€“onPause();</p>
<p>11.Activityâ€“onPause();</p>
<p>12.Fragmentâ€“onStop();</p>
<p>13.Activityâ€“onStop();</p>
<p>14.Fragmentâ€“onDestroyView();</p>
<p>15.Fragmentâ€“onDestroy();</p>
<p>16.Fragmentâ€“onDetach();</p>
<p>17.Activityâ€“onDestroy();</p>
<p>ä¸Šé¢è¿™ä¸ªé¡ºåºæœ‰ä¸€ä¸ªå‰æï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€æœ‰çš„æ—¥å¿—æ‰“å°ä»£ç éƒ½æ˜¯ç´§æŒ¨ç€superæ–¹æ³•å†™ã€‚å› ä¸ºå¦‚æœæˆ‘ä»¬å¦‚æœæŠŠFragmentå†™åœ¨äº†å¸ƒå±€æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶åˆåœ¨Activityçš„onCreate()æ–¹æ³•ä¸­çš„setContentViewä¹‹åæ‰“å°æ—¥å¿—ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹åˆ°çš„ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œé¡ºåºå°±ä¼šæœ‰æ‰€ä¸åŒï¼Œä¸è¿‡åªæ˜¯ç»†å¾®çš„å·®åˆ«ï¼Œè¿™ç‚¹å¤§å®¶è‡ªå·±ç ”ç©¶ï¼Œé“ç†ä¹Ÿå¾ˆå¥½æ˜ç™½ã€‚</p>
<p>æ€»ä¹‹ä¸€å¥è¯ï¼Œåœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯Activityå¸¦é¢†ç€Fragmentï¼Œåœ¨é”€æ¯çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯Fragmentå¸¦é¢†ç€Activityã€‚</p>
<p>æ–‡ç« æ¥æº: <a href="http://wangsong.blog.csdn.net">wangsong.blog.csdn.net</a>ï¼Œä½œè€…ï¼š_æ±Ÿå—ä¸€ç‚¹é›¨ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ï¼Œå¦‚éœ€è½¬è½½ï¼Œè¯·è”ç³»ä½œè€…ã€‚</p>
<h3 id="æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</h3>
<p>ä¸ºäº†è§£å†³æ‰‹åŠ¨å†…å­˜ç®¡ç†å¸¦æ¥çš„é—®é¢˜è€Œè®¾è®¡çš„ã€‚å®ƒä»¬é€šè¿‡å¼•ç”¨è®¡æ•°æ¥è·Ÿè¸ªæœ‰å¤šå°‘ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<ul>
<li>å½“ä½ åˆ›å»ºä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ  1ã€‚</li>
<li>å½“æ™ºèƒ½æŒ‡é’ˆè¶…å‡ºä½œç”¨åŸŸæˆ–è¢«èµ‹å€¼ä¸ºå…¶ä»–å€¼æ—¶ï¼Œå¼•ç”¨è®¡æ•°å‡ 1ã€‚</li>
<li>å½“å¼•ç”¨è®¡æ•°å˜ä¸º 0 æ—¶ï¼Œæ™ºèƒ½æŒ‡é’ˆä¼šè‡ªåŠ¨é”€æ¯å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ã€‚</li>
</ul>
<p><strong>å¾ªç¯å¼•ç”¨é—®é¢˜</strong>ï¼š å¯¹è±¡Aä¸­å­˜åœ¨æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘å¯¹è±¡Bï¼Œå¯¹è±¡Bä¸­å­˜åœ¨æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘å¯¹è±¡Aï¼›</p>
<p>ç”±äºæ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°å§‹ç»ˆä¸ä¸º0ï¼Œå¯¹è±¡Aå’Œå¯¹è±¡Bå°†å§‹ç»ˆä¸èƒ½è¢«é‡Šæ”¾ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨å¼±å¼•ç”¨ï¼›å¯¹æŸå¯¹è±¡ä½¿ç”¨å¼±å¼•ç”¨å°†ä¸å¢åŠ å¼•ç”¨è®¡æ•°ã€‚</p>
<h3 id="Javaå±‚ä¸Nativeå±‚">Javaå±‚ä¸Nativeå±‚</h3>
<p><strong>æµç¨‹</strong></p>
<p><strong>1. Java å±‚è°ƒç”¨ native æ–¹æ³•ï¼š</strong></p>
<ul>
<li>å½“ Java ä»£ç æ‰§è¡Œåˆ° native æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¾‹å¦‚ System.loadLibrary(â€œmylibâ€); æˆ–è°ƒç”¨æŸä¸ª native æ–¹æ³•ï¼ŒJVM ä¼šæš‚åœå½“å‰ Java æ–¹æ³•çš„æ‰§è¡Œã€‚</li>
</ul>
<p><strong>2. æ£€æŸ¥æ–¹æ³•è¡¨ï¼š</strong></p>
<ul>
<li>JVM ä¼šå…ˆæ£€æŸ¥è¯¥ native æ–¹æ³•æ˜¯å¦å·²ç»é“¾æ¥åˆ°å¯¹åº”çš„ native å‡½æ•°ã€‚</li>
<li>æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªæ–¹æ³•è¡¨ï¼ˆ<strong>methodTable</strong>ï¼‰ï¼Œå­˜å‚¨äº†è¯¥ç±»çš„æ‰€æœ‰æ–¹æ³•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ native æ–¹æ³•ã€‚</li>
<li>å¦‚æœæ–¹æ³•è¡¨ä¸­å·²ç»æœ‰è¯¥ native æ–¹æ³•çš„å…¥å£åœ°å€ï¼Œè¯´æ˜å·²ç»å®Œæˆé“¾æ¥ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°æ­¥éª¤ 6 æ‰§è¡Œ native ä»£ç ã€‚</li>
</ul>
<p><strong>3. åŠ è½½åŠ¨æ€é“¾æ¥åº“ï¼š</strong></p>
<ul>
<li>å¦‚æœæ–¹æ³•è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ° native æ–¹æ³•çš„å…¥å£åœ°å€ï¼Œè¯´æ˜è¯¥ native æ–¹æ³•è¿˜æ²¡æœ‰é“¾æ¥ã€‚</li>
<li>JVM ä¼šè°ƒç”¨ System.loadLibrary() æ–¹æ³•åŠ è½½æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“ (ä¾‹å¦‚ <a href="http://libmylib.so">libmylib.so</a>)ã€‚</li>
<li>åŠ¨æ€é“¾æ¥åº“åŠ è½½åï¼Œä¼šè¢«æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</li>
</ul>
<p><strong>4. æŸ¥æ‰¾ JNI_OnLoad å‡½æ•°ï¼š</strong></p>
<ul>
<li>JVM ä¼šåœ¨åŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ä¸­æŸ¥æ‰¾åä¸º JNI_OnLoad çš„å‡½æ•°ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°æ˜¯å¯é€‰çš„ï¼Œå¦‚æœå­˜åœ¨ï¼ŒJVM ä¼šè°ƒç”¨å®ƒã€‚</li>
<li>JNI_OnLoad å‡½æ•°å¯ä»¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œä¾‹å¦‚æ³¨å†Œ native æ–¹æ³•ã€‚</li>
</ul>
<p><strong>5. æ³¨å†Œ native æ–¹æ³•ï¼š</strong></p>
<ul>
<li>å¦‚æœåŠ¨æ€é“¾æ¥åº“ä¸­å­˜åœ¨ JNI_OnLoad å‡½æ•°ï¼Œå¹¶ä¸”è¯¥å‡½æ•°è°ƒç”¨äº† RegisterNatives æ–¹æ³•ï¼Œé‚£ä¹ˆ JVM ä¼šæ ¹æ® RegisterNatives æä¾›çš„å‚æ•°ï¼Œå°† Java native æ–¹æ³•ä¸åŠ¨æ€é“¾æ¥åº“ä¸­çš„ native å‡½æ•°è¿›è¡Œå…³è”ã€‚</li>
<li>JVM ä¼šæ›´æ–°æ–¹æ³•è¡¨ï¼Œå°† native æ–¹æ³•çš„å…¥å£åœ°å€è®¾ç½®ä¸ºå¯¹åº”çš„ native å‡½æ•°åœ°å€ã€‚</li>
</ul>
<p><strong>6. æ‰§è¡Œ native ä»£ç ï¼š</strong></p>
<ul>
<li>ç°åœ¨ï¼ŒJVM å·²ç»æ‰¾åˆ°äº† native æ–¹æ³•å¯¹åº”çš„ native å‡½æ•°åœ°å€ã€‚</li>
<li>JVM å°†æ§åˆ¶æƒè½¬ç§»åˆ° native å‡½æ•°ï¼Œå¹¶å°†å¿…è¦çš„å‚æ•°ä¼ é€’ç»™ native å‡½æ•°ã€‚
<ul>
<li><strong>å‚æ•°è½¬æ¢ï¼š</strong> Java å’Œ native ä»£ç ä½¿ç”¨ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå› æ­¤ JVM éœ€è¦å°† Java å‚æ•°è½¬æ¢ä¸º native å‡½æ•°èƒ½å¤Ÿç†è§£çš„æ•°æ®ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œå°† Java çš„ String ç±»å‹è½¬æ¢ä¸º C çš„ char* ç±»å‹ã€‚</li>
<li><strong>å‹å…¥ JNIEnv æŒ‡é’ˆï¼š</strong> JVM ä¼šå°† JNIEnv æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å‹å…¥ native æ–¹æ³•æ ˆã€‚ JNIEnv æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡ï¼ŒåŒ…å«äº†å¤§é‡çš„ JNI å‡½æ•°æŒ‡é’ˆï¼Œnative å‡½æ•°å¯ä»¥é€šè¿‡è¿™äº›å‡½æ•°ä¸ JVM è¿›è¡Œäº¤äº’ã€‚</li>
<li><strong>å‹å…¥ jclass æˆ– jobject å¼•ç”¨ï¼š</strong> å¯¹äºéé™æ€ native æ–¹æ³•ï¼ŒJVM è¿˜ä¼šå°†è°ƒç”¨è¯¥æ–¹æ³•çš„ Java å¯¹è±¡çš„å¼•ç”¨ (jobject) å‹å…¥ native æ–¹æ³•æ ˆã€‚ å¯¹äºé™æ€ native æ–¹æ³•ï¼Œåˆ™ä¼šå°†è¯¥æ–¹æ³•æ‰€å±ç±»çš„å¼•ç”¨ (jclass) å‹å…¥ native æ–¹æ³•æ ˆã€‚</li>
</ul>
</li>
<li>native å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†ç»“æœè¿”å›ç»™ JVMã€‚</li>
</ul>
<p><strong>7. è¿”å› Java å±‚ï¼š</strong></p>
<ul>
<li>JVM æ¢å¤ Java æ–¹æ³•çš„æ‰§è¡Œï¼Œå¹¶ä½¿ç”¨ native å‡½æ•°è¿”å›çš„ç»“æœç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ã€‚</li>
</ul>
<blockquote>
<p><strong>JNIEnv</strong> ä»…ç”¨äºè®¿é—® <strong>JVM è‡ªå¸¦çš„ JNI å‡½æ•°</strong></p>
<p><strong>ç¨‹åºå‘˜è‡ªè¡ŒåŠ è½½çš„ JNI å‡½æ•°</strong> é€šè¿‡JVMæŸ¥ç±»çš„<strong>methodTable</strong>è·å–JNIå‡½æ•°å…¥å£</p>
<p><strong>so åº“ä¸­çš„ native å‡½æ•°:</strong></p>
<ul>
<li>è¿™äº›å‡½æ•°æ˜¯ç”±å¼€å‘è€…ä½¿ç”¨ C/C++ ç­‰ native è¯­è¨€ç¼–å†™çš„ï¼Œç”¨äºå®ç°ç‰¹å®šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚è®¿é—®ç¡¬ä»¶ã€è°ƒç”¨ç¬¬ä¸‰æ–¹åº“ç­‰ã€‚</li>
<li>è¿™äº›å‡½æ•°éœ€è¦é€šè¿‡ JNI_OnLoad å’Œ RegisterNatives æ³¨å†Œåˆ° JVMï¼Œæ‰èƒ½è¢« Java ä»£ç è°ƒç”¨ã€‚</li>
</ul>
<p><strong>JVM è‡ªèº«å®ç°çš„ JNI å‡½æ•°:</strong></p>
<ul>
<li>è¿™äº›å‡½æ•°æ˜¯ JVM å†…éƒ¨å®ç°çš„ï¼Œç”¨äºå¤„ç† Java å’Œ native ä»£ç ä¹‹é—´çš„äº¤äº’ï¼Œä¾‹å¦‚åˆ›å»º Java å¯¹è±¡ã€è°ƒç”¨ Java æ–¹æ³•ã€å¤„ç†å¼‚å¸¸ç­‰ç­‰ã€‚</li>
<li>è¿™äº›å‡½æ•°ä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨æ³¨å†Œï¼Œå®ƒä»¬æ˜¯ JVM çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ JNIEnv æŒ‡é’ˆè®¿é—®ã€‚</li>
</ul>
<p>â€“ NewStringUTF å‡½æ•°ï¼š è¿™ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ Java å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå®ƒæ˜¯ JVM è‡ªèº«å®ç°çš„ JNI å‡½æ•°ï¼Œä½ å¯ä»¥åœ¨ jni.h å¤´æ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒçš„å£°æ˜ã€‚<br>
â€“ FindClass å‡½æ•°ï¼š è¿™ä¸ªå‡½æ•°ç”¨äºæŸ¥æ‰¾æŒ‡å®šçš„ Java ç±»ï¼Œå®ƒä¹Ÿæ˜¯ JVM è‡ªèº«å®ç°çš„ JNI å‡½æ•°ã€‚<br>
â€“ CallObjectMethod å‡½æ•°ï¼š è¿™ä¸ªå‡½æ•°ç”¨äºè°ƒç”¨ Java å¯¹è±¡çš„å®ä¾‹æ–¹æ³•ï¼Œå®ƒä¹Ÿæ˜¯ JVM è‡ªèº«å®ç°çš„ JNI å‡½æ•°ã€‚</p>
</blockquote>
<p><strong>Javaå‡½æ•°ï¼Œnativeå‡½æ•°ä¸JNIå‡½æ•°</strong></p>
<p>nativeå‡½æ•°</p>
<p>å³ä¸ºæ ‡å‡†c/c++å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—ä¸¤ä¸ªæ•´æ•°çš„å’Œ</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Javaå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ‰“å°å­—ç¬¦ä¸²åˆ°æ§åˆ¶å°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printString</span><span class="params">(String str)</span> &#123;</span><br><span class="line">  System.out.println(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JNIå‡½æ•°ï¼šå¯ä¾›Javaè¯­è¨€è°ƒç”¨çš„ï¼ŒéJavaè¯­è¨€å®ç°å‡½æ•°ï¼ˆæœåŠ¡äºJavaçš„Cå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å– Java å­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_example_MyClass_getStringLength</span><span class="params">(JNIEnv *env, jobject thiz, jstring str)</span> </span>&#123;  <span class="comment">// JNIEXPORT å’Œ JNICALL æ˜¯å¹³å°ç›¸å…³çš„å®å®šä¹‰</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* nativeStr = env-&gt;<span class="built_in">GetStringUTFChars</span>(str, <span class="number">0</span>);</span><br><span class="line">  jint len = <span class="built_in">strlen</span>(nativeStr); </span><br><span class="line">  env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(str, nativeStr);</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Javaå‡½æ•°è°ƒç”¨JNIå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Java ä»£ç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJavaClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;my_native_lib&quot;</span>); <span class="comment">// åŠ è½½ Native åº“</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜ native æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getSumFromNative</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyJavaClass</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyJavaClass</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> obj.getSumFromNative(<span class="number">5</span>, <span class="number">3</span>); <span class="comment">// è°ƒç”¨ native æ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Sum from Native: &quot;</span> + sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JNI å‡½æ•° (C++)</span></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL </span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_MyJavaClass_getSumFromNative</span><span class="params">(JNIEnv *env, jobject thiz, jint a, jint b)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®— a å’Œ b çš„å’Œ</span></span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nativeå‡½æ•°è°ƒç”¨Javaå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JNI å‡½æ•° (C++)</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL </span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_MyNativeClass_callJavaMethod</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;  <span class="comment">// å®é™…ä¸Šæ™®é€šçš„Cå‡½æ•°å°±å¯ä»¥ä½¿ç”¨JNIEnvè°ƒç”¨javaå‡½æ•°ï¼Œè¿™é‡Œå†™æˆJNIå‡½æ•°æ˜¯ä¸ºäº†ä½¿ç”¨Javaè®¿é—®è¯¥å‡½æ•°å†è°ƒç”¨å…¶ä»–çš„javaå‡½æ•°</span></span><br><span class="line">    <span class="comment">// è·å– Java ç±»</span></span><br><span class="line">    jclass cls = env-&gt;<span class="built_in">GetObjectClass</span>(thiz); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– Java æ–¹æ³•çš„ ID</span></span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(cls, <span class="string">&quot;printMessage&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Java å­—ç¬¦ä¸²</span></span><br><span class="line">    jstring message = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;Hello from Native!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ Java æ–¹æ³•</span></span><br><span class="line">    env-&gt;<span class="built_in">CallVoidMethod</span>(thiz, mid, message); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Java ä»£ç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyNativeClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Message from Native: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¸¸è§å†…å­˜æ³„éœ²æƒ…å†µ">å¸¸è§å†…å­˜æ³„éœ²æƒ…å†µ</h3>
<p><strong>éé™æ€çš„å†…éƒ¨ç±»é»˜è®¤æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨</strong></p>
<p>å°†ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ï¼ˆåŒ¿åï¼‰å†…éƒ¨ç±»å¯¹è±¡ä¼ é€’ç»™å…¶ä»–å¯¹è±¡ï¼Œè€Œè¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ¯”å¤–éƒ¨ç±»æ›´é•¿ï¼Œå°±ä¼šå¯¼è‡´å¤–éƒ¨ç±»æ— æ³•è¢«åƒåœ¾å›æ”¶ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView textView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_leaky);</span><br><span class="line"></span><br><span class="line">        textView = findViewById(R.id.text_view);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">10000</span>); <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶ 10 ç§’</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å°è¯•æ›´æ–° UIï¼Œä½†æ­¤æ—¶ Activity å¯èƒ½å·²ç»é”€æ¯</span></span><br><span class="line">                textView.setText(<span class="string">&quot;æ›´æ–° UI&quot;</span>); <span class="comment">// è¿™é‡Œä¼šé€ æˆå†…å­˜æ³„æ¼</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨é™æ€å†…éƒ¨ç±» + å¼±å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">MyHandler</span> <span class="variable">mMyHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHandler</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;Activity&gt; mReference;</span><br><span class="line"></span><br><span class="line">        MyHandler(Activity reference) &#123;</span><br><span class="line">            mReference = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(reference);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            <span class="type">MainActivity</span> <span class="variable">activity</span> <span class="operator">=</span> (MainActivity) mReference.get();</span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">                activity.handleMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        mMyHandler.removeCallbacksAndMessages(<span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>åŒ¿åå†…éƒ¨ç±»ä¸åŒ¿åå‡½æ•° (Lambda è¡¨è¾¾å¼)</strong></p>
<p><strong>åŒ¿åå†…éƒ¨ç±»</strong></p>
<p><strong>å®šä¹‰ï¼š</strong></p>
<ul>
<li>åŒ¿åå†…éƒ¨ç±»æ˜¯<strong>æ²¡æœ‰åå­—çš„ç±»å®šä¹‰</strong>ï¼Œé€šå¸¸åœ¨éœ€è¦ä½¿ç”¨ç±»çš„åœ°æ–¹ç›´æ¥å®šä¹‰å’Œå®ä¾‹åŒ–ã€‚</li>
<li>å¿…é¡»ç»§æ‰¿ä¸€ä¸ªç±»æˆ–å®ç°ä¸€ä¸ªæ¥å£ã€‚</li>
</ul>
<p><strong>è¯­æ³•ï¼š</strong></p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> çˆ¶ç±»/æ¥å£() &#123;</span><br><span class="line">    <span class="comment">// ç±»ä½“ï¼Œå¯ä»¥åŒ…å«æˆå‘˜å˜é‡ã€æ–¹æ³•ã€æ„é€ å‡½æ•°ç­‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå®ç° Runnable æ¥å£çš„åŒ¿åå†…éƒ¨ç±»</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¿åå†…éƒ¨ç±»æ‰§è¡Œä¸­...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(runnable).start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ™®é€šç±»å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyButtonListener</span> <span class="keyword">implements</span> <span class="title class_">ActionListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actionPerformed</span><span class="params">(ActionEvent e)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼ (æ™®é€šç±»)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">JButton</span> <span class="variable">button</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JButton</span>(<span class="string">&quot;ç‚¹å‡»æˆ‘&quot;</span>);</span><br><span class="line">        <span class="type">MyButtonListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyButtonListener</span>();</span><br><span class="line">        button.addActionListener(listener); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¿åå†…éƒ¨ç±»å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">JButton</span> <span class="variable">button</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JButton</span>(<span class="string">&quot;ç‚¹å‡»æˆ‘&quot;</span>);</span><br><span class="line">        button.addActionListener(<span class="keyword">new</span> <span class="title class_">ActionListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actionPerformed</span><span class="params">(ActionEvent e)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼ (åŒ¿åå†…éƒ¨ç±»)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åŒ¿åå‡½æ•° (Lambda è¡¨è¾¾å¼)</strong></p>
<p><strong>å®šä¹‰ï¼š</strong></p>
<ul>
<li>Lambda è¡¨è¾¾å¼æ˜¯ Java 8 å¼•å…¥çš„ä¸€ç§<strong>ç®€æ´çš„å‡½æ•°å¼ç¼–ç¨‹è¯­æ³•</strong>ã€‚</li>
<li>å¯ä»¥çœ‹ä½œæ˜¯<strong>åŒ¿åå‡½æ•°</strong>ï¼Œå¯ä»¥ç›´æ¥ä¼ é€’ç»™éœ€è¦å‡½æ•°å¼æ¥å£ä½œä¸ºå‚æ•°çš„æ–¹æ³•ã€‚</li>
</ul>
<p><strong>è¯­æ³•ï¼š</strong></p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">(å‚æ•°åˆ—è¡¨) -&gt; &#123; å‡½æ•°ä½“ &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å‚æ•°åˆ—è¡¨å¯ä»¥çœç•¥ç±»å‹ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ‹¬å·ä¹Ÿå¯ä»¥çœç•¥ã€‚</li>
<li>å¦‚æœå‡½æ•°ä½“åªæœ‰ä¸€è¡Œä»£ç ï¼ŒèŠ±æ‹¬å·ä¹Ÿå¯ä»¥çœç•¥ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ Lambda è¡¨è¾¾å¼åˆ›å»º Runnable å®ä¾‹</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">&quot;Lambda è¡¨è¾¾å¼æ‰§è¡Œä¸­...&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(runnable).start();</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>é™æ€å˜é‡æŒæœ‰å¯¹è±¡</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>(context);  <span class="comment">// é™æ€å˜é‡æŒæœ‰contextå¯¹è±¡ï¼Œå¯¼è‡´Activityå¯¹è±¡æ— æ³•è¢«GC</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Message">Message</h3>
<h4 id="Handlerï¼ŒLooperä¸MessageQueue">Handlerï¼ŒLooperä¸MessageQueue</h4>
<p><strong>Message</strong></p>
<img src="/2024/07/28/Android-Learning-Record/image-20240813144056439.png" class="" title="image-20240813144056439">
<ul>
<li>obtain(): è‹¥sPoolä¸­å­˜åœ¨msgï¼Œå–å‡ºå¹¶è¿”å›ï¼›å¦åˆ™newè¿”å›</li>
<li>obtain(h: Handler): è°ƒç”¨obtain()å¹¶æŒ‡å®šmsgçš„targetä¸ºHandler</li>
<li>obtain(h: Handler, callback: Runnable): é¢å¤–æŒ‡å®šcallback</li>
</ul>
<p><strong>Looper&amp;MessageQueue</strong></p>
<img src="/2024/07/28/Android-Learning-Record/image-20240813145303945.png" class="" title="image-20240813145303945">
<img src="/2024/07/28/Android-Learning-Record/image-20240813145313326.png" class="" title="image-20240813145313326">
<p>ä¸»çº¿ç¨‹æœ‰ä¸”åªæœ‰ä¸€ä¸ª Looperï¼Œå®ƒæ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºå¹¶å¯åŠ¨çš„ã€‚</p>
<p>å­çº¿ç¨‹é»˜è®¤æ²¡æœ‰Looperï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºå’Œå¯åŠ¨ã€‚</p>
<p>Looperä¸MessageQueue</p>
<ul>
<li>
<p>æ¯ä¸ª Looper éƒ½ä¼šå…³è”ä¸€ä¸ªå”¯ä¸€çš„ MessageQueueã€‚Looper å¯¹è±¡åˆ›å»ºæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª MessageQueue å¯¹è±¡ã€‚</p>
</li>
<li>
<p>MessageQueue å°±åƒä¸€ä¸ªæ¶ˆæ¯å®¹å™¨ï¼Œè´Ÿè´£å­˜å‚¨æ¶ˆæ¯ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ Handler å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯å¹¶ä¸ä¼šç›´æ¥è¢«å¤„ç†ï¼Œè€Œæ˜¯ä¼šè¢«æ·»åŠ åˆ° Looper å…³è”çš„ MessageQueue ä¸­ã€‚</p>
</li>
<li>
<p>Looper é€šè¿‡ä¸€ä¸ªæ— é™å¾ªç¯ä¸æ–­åœ°ä» MessageQueue ä¸­è¯»å–æ¶ˆæ¯ã€‚å½“ Looper å‘ç° MessageQueue ä¸­æ²¡æœ‰æ¶ˆæ¯å¯å¤„ç†æ—¶ï¼Œå°±ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ IdleHandler éœ€è¦æ‰§è¡Œï¼›è‹¥æ²¡æœ‰ï¼Œ Looper å°±ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…æ–°çš„æ¶ˆæ¯åˆ°æ¥ã€‚</p>
</li>
<li>
<p>å½“ Looper ä» MessageQueue ä¸­è¯»å–åˆ°æ¶ˆæ¯åï¼Œä¼šæ ¹æ®æ¶ˆæ¯çš„ target å±æ€§ï¼ˆå³å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨çš„ Handler å¯¹è±¡ï¼‰ï¼Œå°†æ¶ˆæ¯åˆ†å‘ç»™å¯¹åº”çš„ Handler è¿›è¡Œå¤„ç†ã€‚</p>
</li>
</ul>
<p><strong>ä¸€ä¸ªçº¿ç¨‹æœ€å¤šä¸€ä¸ªLooperï¼ï¼ï¼</strong></p>
<blockquote>
<p>å¦‚ä½•ä¿è¯ä¸€ä¸ªçº¿ç¨‹æœ€å¤šä¸€ä¸ªLooperï¼Ÿ</p>
<p>ThreadLocalæ˜¯ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„æ•°æ®å­˜å‚¨ç±»ï¼Œå½“æŸä¸ªçº¿ç¨‹è°ƒç”¨prepareæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆé€šè¿‡ThreadLocalæ£€æŸ¥è¿™ä¸ªçº¿ç¨‹æ˜¯å¦å·²ç»åˆ›å»ºäº†Looper,å¦‚æœè¿˜æ²¡åˆ›å»ºï¼Œåˆ™å®ä¾‹åŒ–Looperå¹¶å°†å®ä¾‹åŒ–åçš„Looperä¿å­˜åˆ°ThreadLocalä¸­ï¼Œè€Œå¦‚æœThreadLocalä¸­å·²ç»ä¿å­˜äº†Looperï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªRuntimeExceptionçš„å¼‚å¸¸ã€‚é‚£ä¹ˆæ„å‘³ç€åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æœ€å¤šåªèƒ½è°ƒç”¨ä¸€æ¬¡prepareæ–¹æ³•ï¼Œè¿™æ ·å°±ä¿è¯äº†Looperçš„å”¯ä¸€æ€§ã€‚</p>
</blockquote>
<p><strong>Handler</strong></p>
<img src="/2024/07/28/Android-Learning-Record/image-20240813144733590.png" class="" title="image-20240813144733590">
<p>Handlerä¸ä¼šè¢«é»˜è®¤åˆ›å»ºï¼Œéœ€æ‰‹åŠ¨åˆ›å»º</p>
<p><strong>å¤šä¸ª Handler å¯ç»‘å®šåŒä¸€ä¸ª Looper</strong>ï¼Œåœ¨åˆ›å»º Handler æ—¶ï¼Œè‹¥æœªæŒ‡å®š Looperï¼Œåˆ™é»˜è®¤ç»‘å®šå½“å‰çº¿ç¨‹çš„ Looper</p>
<p>ä½¿ç”¨ Handler å¯¹è±¡çš„ send æˆ– post æ–¹æ³•ï¼Œå‘ Handler å¯¹è±¡ç»‘å®šçš„ Looper å¯¹åº”çš„ MessageQueue å‘é€Msgã€‚<strong>è‹¥å‘é€çš„ä¸ºrunnableï¼Œhandlerä¼šå°†å…¶å°è£…ä¸ºMessageã€‚</strong></p>
<p>Looper.loop() æ–¹æ³•ä¸æ–­ä» MessageQueue ä¸­å–å‡ºæ¶ˆæ¯ã€‚</p>
<p>Looper å–å‡ºæ¶ˆæ¯åï¼Œä¼šæ ¹æ® Message.target å±æ€§æ‰¾åˆ°å½“åˆå‘é€è¯¥æ¶ˆæ¯çš„ Handlerã€‚</p>
<p><strong>Handler å¤„ç†æ¶ˆæ¯:</strong> Handler æ¥æ”¶åˆ° Looper æ´¾å‘çš„æ¶ˆæ¯åï¼Œæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p>
<ul>
<li>
<p>æ£€æŸ¥ Message æ˜¯å¦æºå¸¦ Callbackï¼Œè‹¥æœ‰åˆ™è°ƒç”¨ Callback.run() å¤„ç†æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>è‹¥ Message æ²¡æœ‰ Callbackï¼Œåˆ™æ£€æŸ¥Handlerè‡ªèº«æ˜¯å¦è®¾ç½®äº†é»˜è®¤çš„ mCallbackï¼Œè‹¥æœ‰åˆ™è°ƒç”¨ mCallback.handleMessage() å¤„ç†æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>è‹¥ä»¥ä¸Šä¸¤ç§ Callback éƒ½æ²¡æœ‰ï¼Œåˆ™è°ƒç”¨è‡ªèº« handleMessage() æ–¹æ³•å¤„ç†æ¶ˆæ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="comment">// msg.callback.run() msgå¤„ç†æ¬¡åº1</span></span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="literal">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="literal">null</span>) &#123;  <span class="comment">// msgå¤„ç†æ¬¡åº2</span></span><br><span class="line">            <span class="comment">// mCallback.handleMessage(msg)</span></span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// msgå¤„ç†æ¬¡åº3</span></span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleCallback</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">    message.callback.run();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Callback</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>æ³¨æ„1ï¼šè¿›è¡ŒMsgå¤„ç†ï¼ˆè°ƒç”¨ handleMessage æ–¹æ³•ï¼‰çš„æ˜¯Handleræ‰€ç»‘å®šçš„Looperæ‰€åœ¨çš„çº¿ç¨‹ï¼Œå³æ¶ˆæ¯å‘é€åˆ°å“ªä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—æ‰€åœ¨çº¿ç¨‹å°±è¿›è¡Œæ¶ˆæ¯å¤„ç†</strong></p>
<p><strong>æ³¨æ„2ï¼šä¸»çº¿ç¨‹çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ Looper çš„å¾ªç¯ä¸­åº¦è¿‡ï¼Œæ‰€æœ‰çš„æ“ä½œï¼ŒåŒ…æ‹¬ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨ã€UI æ›´æ–°ã€äº‹ä»¶å¤„ç†ç­‰ï¼Œéƒ½æ˜¯ä½œä¸ºæ¶ˆæ¯è¢« Looper ä¾æ¬¡å¤„ç†çš„ï¼Œæ¯ä¸ªæ¶ˆæ¯çš„å¤„ç†éƒ½æ˜¯çŸ­æš‚çš„ã€‚ä¸€ä¸ªæ¶ˆæ¯å¤„ç†å®Œæ¯•åï¼ŒLooper ç«‹å³å¤„ç†ä¸‹ä¸€ä¸ªæ¶ˆæ¯æˆ–ç­‰å¾…æ–°æ¶ˆæ¯ã€‚</strong></p>
<p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹åˆ›å»º Handler å¯¹è±¡å¹¶ç»‘å®šmainLooperï¼Œå­çº¿ç¨‹ä½¿ç”¨è¯¥ Handler å¯¹è±¡å‘é€ä¿¡æ¯åˆ°ä¸»çº¿ç¨‹çš„MessageQueue ï¼Œå½“ Looper ä» MessageQueue ä¸­è¯»å–åˆ°æ¶ˆæ¯åï¼Œè°ƒç”¨å‘é€è¯¥ Msg çš„ Handler handleMessage æ–¹æ³•å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler networkHandler;</span><br><span class="line">    <span class="keyword">private</span> Handler uiHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¤„ç†ç½‘ç»œè¯·æ±‚çš„ Handler</span></span><br><span class="line">        networkHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†ç½‘ç»œè¯·æ±‚ç»“æœ</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String) msg.obj;</span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;ç½‘ç»œè¯·æ±‚ç»“æœ: &quot;</span> + result, Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶çš„ Handler</span></span><br><span class="line">        uiHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> (String) msg.obj;</span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;ç”¨æˆ·è¾“å…¥: &quot;</span> + input, Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚</span></span><br><span class="line">        simulateNetworkRequest();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥äº‹ä»¶</span></span><br><span class="line">        simulateUserInput();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">simulateNetworkRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å‘é€ç½‘ç»œè¯·æ±‚ç»“æœ</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.obtain();</span><br><span class="line">            message.obj = <span class="string">&quot;æˆåŠŸ!&quot;</span>;</span><br><span class="line">            networkHandler.sendMessage(message);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">simulateUserInput</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å‘é€ç”¨æˆ·è¾“å…¥äº‹ä»¶</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.obtain();</span><br><span class="line">        message.obj = <span class="string">&quot;Hello!&quot;</span>;</span><br><span class="line">        uiHandler.sendMessageDelayed(message, <span class="number">3000</span>); <span class="comment">// å»¶è¿Ÿ 3 ç§’å‘é€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>runOnUiThread()</p>
<p>Android åº”ç”¨ä¸­çš„ UI å…ƒç´ ï¼ˆä¾‹å¦‚æŒ‰é’®ã€æ–‡æœ¬æ¡†ã€å›¾ç‰‡ç­‰ï¼‰éƒ½æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œè¿™ä¸ªä¸»çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸º UI çº¿ç¨‹ã€‚å¦‚æœåœ¨åå°çº¿ç¨‹ï¼ˆé UI çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆä¾‹å¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰ï¼Œæ“ä½œå®Œæˆåå¦‚æœéœ€è¦æ›´æ–° UIï¼Œå°±ä¸èƒ½ç›´æ¥åœ¨åå°çº¿ç¨‹ä¸­è¿›è¡Œã€‚è¿™æ˜¯å› ä¸º Android è§„å®šåªèƒ½åœ¨ UI çº¿ç¨‹ä¸­æ›´æ–° UI å…ƒç´ ã€‚</p>
<p>runOnUiThread() æ–¹æ³•çš„ä½œç”¨æ˜¯å°†ä¸€æ®µä»£ç é€»è¾‘æ”¾å…¥ UI çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… UI çº¿ç¨‹ç©ºé—²æ—¶æ‰§è¡Œã€‚è¿™æ ·å°±ä¿è¯äº†æ›´æ–° UI çš„æ“ä½œä¸€å®šä¼šåœ¨ UI çº¿ç¨‹ä¸­è¿›è¡Œï¼Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">runOnUiThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Toast.makeText(getApplicationContext(), <span class="string">&quot;This is a Toast message&quot;</span>, Toast.LENGTH_SHORT).show();  <span class="comment">// Toastå¿…é¡»æ”¾åœ¨Uiçº¿ç¨‹æ‰§è¡Œå“¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>IdleHandler</strong></p>
<p><strong>æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯</strong>: Looper ä¼šå–å‡ºæ¶ˆæ¯å¹¶åˆ†å‘ç»™å¯¹åº”çš„ Handler å¤„ç†ã€‚</p>
<p><strong>æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©º</strong>: Looper ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ IdleHandler éœ€è¦æ‰§è¡Œã€‚å¦‚æœæœ‰ï¼Œå°±ä¾æ¬¡æ‰§è¡Œ IdleHandler çš„ queueIdle() æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰ï¼ŒLooper å°±ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…æ–°çš„æ¶ˆæ¯åˆ°æ¥ã€‚</p>
<p>queueIdle() æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªbooleanå€¼ï¼Œè¿”å›trueä¼šå°†IdleHandlerä¿ç•™ï¼Œå¦åˆ™ä¼šå°†å…¶ç§»é™¤ã€‚é‡å†™Idleçš„ queueIdle æ–¹æ³•å®ç°åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºæ—¶è¿›è¡Œçš„ä»»åŠ¡ã€‚</p>
<p>åœ¨MessageQueueä¸­ç»´æŠ¤äº†ä¸€ä¸ªIdleHandleré›†åˆ<code>mIdleHandlers</code>ï¼Œå¹¶ä¸”æä¾›äº†æ·»åŠ IdleHandlerå’Œç§»é™¤IdleHandlerçš„æ–¹æ³•ã€‚å¯ä»¥é€šè¿‡ <code>Looper.myQueue().addIdleHandler(new Idler())</code> æ·»åŠ ä¸€ä¸ªIdleHandlerã€‚</p>
<p><strong>HandlerThread</strong></p>
<p>è‡ªå¸¦ Looper çš„çº¿ç¨‹ï¼Œå¯åŠ¨åä¼šè‡ªåŠ¨åˆ›å»ºå¹¶è¿è¡Œ Looper çš„æ¶ˆæ¯å¾ªç¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.os.HandlerThread;</span><br><span class="line"><span class="keyword">import</span> android.os.Message;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HandlerThread mCompressThread;</span><br><span class="line">    <span class="keyword">private</span> Handler mCompressHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º HandlerThread</span></span><br><span class="line">        mCompressThread = <span class="keyword">new</span> <span class="title class_">HandlerThread</span>(<span class="string">&quot;CompressThread&quot;</span>);</span><br><span class="line">        mCompressThread.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º Handlerï¼Œç»‘å®šåˆ° HandlerThread çš„ Looper</span></span><br><span class="line">        mCompressHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(mCompressThread.getLooper()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿå›¾ç‰‡å‹ç¼©æ“ä½œ</span></span><br><span class="line">                <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> (Bitmap) msg.obj;</span><br><span class="line">                compressImage(bitmap);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»»åŠ¡å®Œæˆï¼Œè®¡æ•°å™¨å‡ä¸€</span></span><br><span class="line">                ((CountDownLatch) msg.getData().getParcelable(<span class="string">&quot;latch&quot;</span>)).countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ·»åŠ å¤šä¸ªå›¾ç‰‡å‹ç¼©ä»»åŠ¡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">imageCount</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(imageCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; imageCount; i++) &#123;</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> BitmapFactory.decodeResource(getResources(), R.drawable.ic_launcher_background);</span><br><span class="line">            addTaskToQueue(bitmap, latch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;æ‰€æœ‰å›¾ç‰‡å‹ç¼©ä»»åŠ¡å·²å®Œæˆ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ å‹ç¼©ä»»åŠ¡åˆ°æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addTaskToQueue</span><span class="params">(Bitmap bitmap, CountDownLatch latch)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.obtain();</span><br><span class="line">        message.obj = bitmap;</span><br><span class="line">        <span class="type">Bundle</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">        data.putParcelable(<span class="string">&quot;latch&quot;</span>, latch);</span><br><span class="line">        message.setData(data);</span><br><span class="line">        mCompressHandler.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿå›¾ç‰‡å‹ç¼©æ“ä½œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">compressImage</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="number">80</span>, baos);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>); <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;å›¾ç‰‡å‹ç¼©å®Œæˆï¼Œçº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        <span class="comment">// é€€å‡º HandlerThread</span></span><br><span class="line">        mCompressThread.quitSafely();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åŒæ­¥å±éšœ">åŒæ­¥å±éšœ</h4>
<p><a href="https://juejin.cn/post/6924733444509892622">å›¾ç¤ºAndroidç³»ç»ŸåŸç†ä¹‹HandleråŒæ­¥å±éšœï¼ˆäºŒï¼‰ç­”ï¼šDemoå·¥ç¨‹ä¸­è¯¦ç»†æ¼”ç¤ºäº†æ’å…¥å±éšœæ¶ˆæ¯çš„æ–¹å¼ã€‚æ’å…¥å’Œç§»é™¤å±éšœæ¶ˆ - æ˜é‡‘</a></p>
<p>è¾“å…¥äº‹ä»¶/invalidateæ–¹æ³•è¯·æ±‚å±å¹•åˆ·æ–°åï¼Œä¼šäº§ç”ŸåŒæ­¥å±éšœï¼Œå±è”½åŒæ­¥æ¶ˆæ¯çš„å¤„ç†ï¼Œç›´åˆ°ä¸€ä¸‹æ¬¡Vsyncä¿¡å·åˆ°è¾¾â†’Choreographeræ’¤é”€åŒæ­¥å±éšœï¼Œæ‰§è¡Œmeasure, layout, draw</p>
<h3 id="è¿›ç¨‹é—´äº¤äº’">è¿›ç¨‹é—´äº¤äº’</h3>
<p>å¹³æ—¶æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„å‰ç«¯ï¼ˆWeb\Android\iOSï¼‰é€šè¿‡ç½‘ç»œä¸æœåŠ¡å™¨é€šä¿¡æ˜¯å®¢æˆ·ç«¯-æœåŠ¡ç«¯æ¨¡å¼çš„ä½“ç°ï¼Œè€Œåœ¨Android Frameworkä¸­ï¼Œå››å¤§ç»„ä»¶çš„åˆ›å»ºã€ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯é€šè¿‡è¿™æ ·çš„æ¨¡å¼è¿›è¡Œé€šä¿¡ï¼š</p>
<ul>
<li>æœåŠ¡å™¨ç«¯(server)æŒ‡çš„å°±æ˜¯SystemServerè¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹æä¾›äº†å¾ˆå¤šæœåŠ¡ï¼Œæ¯”å¦‚AMSã€PMSã€WMSç­‰ç­‰ï¼Œæ‰€æœ‰çš„APPè¿›ç¨‹éƒ½å¯ä»¥ä¸å…¶é€šä¿¡ã€‚</li>
<li>å®¢æˆ·ç«¯(client)æŒ‡çš„å°±æ˜¯å„ä¸ªç‹¬ç«‹çš„APPè¿›ç¨‹ã€‚</li>
</ul>
<p>Androidå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡PackageåŒ…åå’ŒActivityç±»åï¼Œæ¥æ‰“å¼€ä¸€ä¸ªAPPã€‚å®é™…ä¸Šï¼Œé¡¹ç›®é‡Œçš„ä¸šåŠ¡ä»£ç startActivity()æ–¹æ³•å¹¶ä¸æ˜¯ç›´æ¥åˆ›å»ºè¿›ç¨‹ã€æ‹‰èµ·APPçš„ã€‚è€Œæ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼ŒæŠŠè¯·æ±‚ä¼ é€’ç»™SystemServerçš„AMSã€‚AMSæ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå†é€šçŸ¥zygoteè¿›ç¨‹æ¥forkä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæ¥å¼€å¯æˆ‘ä»¬çš„ç›®æ ‡APPã€‚APPä¸­æ‰€æœ‰Activityçš„ç”Ÿå‘½å‘¨æœŸè¿‡ç¨‹ï¼Œéƒ½ç”±AMSï¼ˆSystemServerè¿›ç¨‹ï¼‰ç»Ÿä¸€è°ƒåº¦ï¼Œå¹¶åœ¨APPè‡ªèº«è¿›ç¨‹ä¸­å…·ä½“å®Œæˆã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°3ä¸ªè¿›ç¨‹ï¼šAPPè¿›ç¨‹ã€SystemServerè¿›ç¨‹ã€Zygoteè¿›ç¨‹ã€‚</p>
<ul>
<li>APPè¿›ç¨‹ä¸SystemServerè¿›ç¨‹é€šè¿‡Binderæœºåˆ¶ï¼Œè¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚</li>
<li>SystemServerè¿›ç¨‹ä¸Zygoteè¿›ç¨‹é€šè¿‡Socketï¼Œè¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚</li>
</ul>
<img src="/2024/07/28/Android-Learning-Record/image-20240723153011448-1722133358773.png" class="" title="image-20240723153011448">
<h4 id="AIDLä¸Binder">AIDLä¸Binder</h4>
<p><strong>Android Interface Definition Language</strong></p>
<p>ä»…å½“éœ€è¦åœ¨<strong>ä¸åŒåº”ç”¨é—´é€šè¿‡ IPC æ–¹å¼è®¿é—®æœåŠ¡ï¼ˆåœ¨æœåŠ¡ä¸­è¿›è¡Œå¤šçº¿ç¨‹å¤„ç†ï¼‰æ—¶</strong>æ‰æœ‰å¿…è¦ä½¿ç”¨ AIDLã€‚è‹¥<strong>æ— éœ€è·¨è¶Šä¸åŒåº”ç”¨ï¼ŒåŒåº”ç”¨å†…æ‰§è¡Œå¹¶å‘ IPCï¼Œåˆ™åº”é€šè¿‡å®ç° Binder</strong> æ¥åˆ›å»ºæ¥å£ï¼›åˆæˆ–è€…<strong>åªæƒ³æ‰§è¡Œ IPCï¼Œä½†ä¸éœ€è¦å¤„ç†å¤šçº¿ç¨‹æ—¶ä½¿ç”¨ Messenger</strong> æ¥å®ç°æ¥å£ã€‚</p>
<p>serverè¿›ç¨‹ä¸clientè¿›ç¨‹äº¤äº’</p>
<p><strong>æ™®é€šæ–¹å¼</strong></p>
<p>serverè¿›ç¨‹ï¼š</p>
<p>ç»§æ‰¿Serviceï¼Œå®ç°onBinderå¹¶è¿”å›Binderå¯¹è±¡ï¼›</p>
<p>éœ€åœ¨è¯¥Binderå¯¹è±¡ä¸­å®ç°onTransact(â€¦)å’ŒæœåŠ¡æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradeService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> REQUEST_CODE=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Binder</span> <span class="variable">mBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Binder</span>() &#123;</span><br><span class="line">        <span class="comment">// é€è¿‡åŒ¿åå†…éƒ¨ç±»æ–¹å¼ç»§æ‰¿Binderå¹¶å®ç°æœåŠ¡æ–¹æ³•ï¼Œè¯¥æ–¹å¼å­˜åœ¨å†…å­˜æ³„éœ²</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, <span class="meta">@NonNull</span> Parcel data, <span class="meta">@Nullable</span> Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">if</span> (code == REQUEST_CODE) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> data.readString();</span><br><span class="line">                <span class="comment">// æ ¹æ®å§“åæŸ¥è¯¢å­¦ç”Ÿæˆç»©å¹¶å°†æˆç»©å†™å…¥åˆ°è¿”å›æ•°æ®</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">studentGrade</span> <span class="operator">=</span> getStudentGrade(name);</span><br><span class="line">                <span class="keyword">if</span> (reply != <span class="literal">null</span>)</span><br><span class="line">                    reply.writeInt(studentGrade);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœåŠ¡æ–¹æ³•ï¼šæ ¹æ®å§“åæŸ¥è¯¢å­¦ç”Ÿæˆç»©</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span> &#123;         </span><br><span class="line">            <span class="keyword">return</span> StudentMap.getStudentGrade(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>clientè¿›ç¨‹ï¼š</p>
<p>é€šè¿‡bindService(intent, mServiceConnection, xxx)ç»‘å®šæœåŠ¡ï¼Œ</p>
<p>mServiceConnectionå¯¹è±¡ä¸­å®ç°onServiceConnectedå’ŒonServiceDisconnectedæ–¹æ³•ï¼Œæ–¹æ³•ä¸­è·å¾—serverè¿›ç¨‹è¿”å›çš„Binderå¯¹è±¡</p>
<p>è°ƒç”¨Binderå¯¹è±¡çš„onTransactæ–¹æ³•å¾—åˆ°ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">// è¿œç¨‹æœåŠ¡çš„Binderä»£ç†</span></span><br><span class="line">    <span class="keyword">private</span> IBinder mRemoteBinder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ServiceConnection</span> <span class="variable">mServiceConnection</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–è¿œç¨‹æœåŠ¡çš„Binderä»£ç†</span></span><br><span class="line">            mRemoteBinder = iBinder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">            mRemoteBinder = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_binder);</span><br><span class="line">        <span class="comment">// ç»‘å®šæœåŠ¡</span></span><br><span class="line">        findViewById(R.id.btn_bind_service).setOnClickListener(view -&gt; bindGradeService());</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å­¦ç”Ÿæˆç»©</span></span><br><span class="line">        findViewById(R.id.btn_find_grade).setOnClickListener(view -&gt; getStudentGrade(<span class="string">&quot;Anna&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»‘å®šè¿œç¨‹æœåŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindGradeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> <span class="string">&quot;android.intent.action.server.gradeservice&quot;</span>;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(action);</span><br><span class="line">        intent.setPackage(getPackageName());</span><br><span class="line">        bindService(intent, mServiceConnection, BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»è¿œç¨‹æœåŠ¡æŸ¥è¯¢å­¦ç”Ÿæˆç»©</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">int</span> <span class="variable">grade</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRemoteBinder == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Need Bind Remote Server...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRemoteBinder.transact(REQUEST_CODE, data, reply, <span class="number">0</span>);</span><br><span class="line">            grade = reply.readInt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> grade;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä½¿ç”¨ServiceConnectionå¯¹è±¡çš„åŸå› </p>
<ul>
<li>ç»‘å®šæœåŠ¡æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼ŒæœåŠ¡è¿›ç¨‹çš„è¿æ¥å’Œå¯åŠ¨éƒ½éœ€è¦æ—¶é—´ã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯è¿›ç¨‹åŒæ­¥ç­‰å¾…æœåŠ¡è¿æ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´ UI çº¿ç¨‹é˜»å¡ï¼Œé€ æˆ ANR (Application Not Responding)ã€‚</li>
<li><code>ServiceConnection</code>  æä¾›äº†ä¸€ç§å¼‚æ­¥å›è°ƒæœºåˆ¶ï¼Œå½“æœåŠ¡è¿æ¥æˆåŠŸæˆ–æ–­å¼€æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›è°ƒ <code>ServiceConnection</code>  ä¸­çš„ <code>onServiceConnected()</code>  å’Œ <code>onServiceDisconnected()</code>  æ–¹æ³•ï¼Œé€šçŸ¥å®¢æˆ·ç«¯è¿›ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒbindService() æ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œå› æ­¤ ServiceConnection çš„å›è°ƒæ–¹æ³•ä¹Ÿä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</li>
<li>è¿™æ ·ï¼Œå®¢æˆ·ç«¯è¿›ç¨‹å°±å¯ä»¥åœ¨ <code>onServiceConnected()</code>  æ–¹æ³•ä¸­è·å–åˆ°æœåŠ¡çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶åœ¨ <code>onServiceDisconnected()</code>  æ–¹æ³•ä¸­å¤„ç†æœåŠ¡æ–­å¼€çš„æƒ…å†µï¼Œè€Œæ— éœ€é˜»å¡ç­‰å¾…ã€‚</li>
</ul>
<p>å®¢æˆ·ç«¯è°ƒç”¨Binderå¯¹è±¡çš„transactæ–¹æ³•ä¸­è½¬</p>
<ul>
<li>å®¢æˆ·ç«¯è°ƒç”¨çš„æ˜¯ Binder ä»£ç†å¯¹è±¡ï¼ˆå®¢æˆ·ç«¯å†…çš„binderå¯¹è±¡ï¼‰çš„ transact()ã€‚è¿™ä¸ªæ–¹æ³•ä¼šå°†è¯·æ±‚å‘é€ç»™ Binder é©±åŠ¨ã€‚</li>
<li>Binder é©±åŠ¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ‰¾åˆ°å¯¹åº”çš„æœåŠ¡ç«¯ Binder å¯¹è±¡ï¼Œå¹¶åœ¨æœåŠ¡ç«¯è¿›ç¨‹è°ƒç”¨ <strong>æœåŠ¡ç«¯ Binder å¯¹è±¡</strong> çš„ onTransact() æ–¹æ³•ã€‚</li>
</ul>
<p><strong>xxxbinder.transact() æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œè¿™æ„å‘³ç€åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¿›ç¨‹ä¼šåœ¨è°ƒç”¨ transact() æ–¹æ³•åé˜»å¡ï¼Œç›´åˆ°æœåŠ¡ç«¯è¿›ç¨‹å®Œæˆè¯·æ±‚å¹¶è¿”å›ç»“æœã€‚</strong></p>
</blockquote>
<p><strong>ä»£ç†æ¨¡å¼</strong></p>
<p>serverè¿›ç¨‹ï¼š</p>
<p>å¼•å…¥æœåŠ¡æ–¹æ³•ç«¯å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IGradeInterface</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¼•å…¥xxxBinderç»§æ‰¿ä¸€èˆ¬Binderç±»å¹¶å®ç°æœåŠ¡ç«¯å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradeBinder</span> <span class="keyword">extends</span> <span class="title class_">Binder</span> <span class="keyword">implements</span> <span class="title class_">IGradeInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StudentMap.getStudentGrade(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, <span class="meta">@NonNull</span> Parcel data, <span class="meta">@Nullable</span> Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">if</span> (code == REQUEST_CODE) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> data.readString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">studentGrade</span> <span class="operator">=</span> getStudentGrade(name);</span><br><span class="line">            <span class="keyword">if</span> (reply != <span class="literal">null</span>)</span><br><span class="line">                reply.writeInt(studentGrade);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡ç«¯ç»§æ‰¿Serviceï¼Œå®ç°onBinderå¹¶è¿”å›xxxBinderå¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradeService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> REQUEST_CODE=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Binder</span> <span class="variable">mBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GradeBinder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>clientè¿›ç¨‹ï¼š</p>
<p>å¼•å…¥æœåŠ¡æ–¹æ³•ç«¯å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IGradeInterface</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°æœåŠ¡æ¥å£å¾—åˆ°ä»£ç†Binderç±»å‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderProxy</span> <span class="keyword">implements</span> <span class="title class_">IGradeInterface</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">BinderProxy</span><span class="params">(IBinder binder)</span> &#123;</span><br><span class="line">        mBinder = binder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// é€šè¿‡BinderæŸ¥è¯¢æˆç»©</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">int</span> <span class="variable">grade</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mBinder == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Need Bind Remote Server...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mBinder.transact(REQUEST_CODE, data, reply, <span class="number">0</span>);</span><br><span class="line">            grade = reply.readInt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> grade;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–Binderä»£ç†ç±»çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IGradeInterface <span class="title function_">asInterface</span><span class="params">(IBinder iBinder)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (iBinder == <span class="literal">null</span>) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å§‹ç»ˆè¿”å› BinderProxy å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BinderProxy</span>(iBinder); </span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»activityä¸­é€šè¿‡ServiceConnectionå¯¹è±¡çš„onServiceConnectedæ–¹æ³•ä»æœåŠ¡ç«¯å¾—åˆ°è¿”å›çš„Binderå¯¹è±¡ï¼Œè½¬æˆä»£ç†ç±»å‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ServiceConnection</span> <span class="variable">mServiceConnection</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> &#123;</span><br><span class="line">      	<span class="comment">// è¿æ¥æœåŠ¡æˆåŠŸï¼Œæ ¹æ®æ˜¯å¦è·¨è¿›ç¨‹è·å–BinderProxyæˆ–è€…GradeBinderå®ä¾‹</span></span><br><span class="line">        mBinderProxy = BinderProxy.asInterface(iBinder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">        mBinderProxy = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>å…³äº onTransact()/transact(â€¦) æ–¹æ³•ï¼š</strong></p>
<ul>
<li>è™½ç„¶å®¢æˆ·ç«¯ä»£ç ä¸­æ²¡æœ‰ç›´æ¥è°ƒç”¨ transact(â€¦) æ–¹æ³•ï¼Œä½†å®é™…ä¸Šï¼Œå®¢æˆ·ç«¯çš„BinderProxy çš„ getStudentGrade() æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ mBinder.transact(â€¦)ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šèµ°åˆ°æœåŠ¡ç«¯çš„ onTransact() æ–¹æ³•ã€‚</li>
<li>ä»£ç†æ¨¡å¼åªæ˜¯éšè—äº†åº•å±‚çš„é€šä¿¡ç»†èŠ‚ï¼Œè®©å®¢æˆ·ç«¯ä»£ç çœ‹èµ·æ¥åƒæ˜¯åœ¨è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä½†å®é™…ä¸Šè·¨è¿›ç¨‹é€šä¿¡ä»ç„¶æ˜¯é€šè¿‡ transact() å’Œ onTransact() æ–¹æ³•æ¥å®Œæˆçš„ã€‚</li>
</ul>
</blockquote>
<p><strong>AIDL</strong></p>
<blockquote>
<p>ç±»ä¼¼äºä»£ç†æ¨¡å¼ï¼ŒAIDL ä¼šè‡ªåŠ¨ç”Ÿæˆç±»ä¼¼äºæ‰€å†™çš„ <code>IGradeInterface</code>ã€æœåŠ¡ç«¯<code>GradeBinder</code>ã€å®¢æˆ·ç«¯<code>BinderProxy</code>  è¿™æ ·çš„ä»£ç ç»“æ„ï¼Œä»è€Œç®€åŒ–äº† Binder é€šä¿¡çš„å¼€å‘ã€‚</p>
</blockquote>
<p>serverè¿›ç¨‹ï¼š</p>
<p>åˆ›å»ºAIDLæ–‡ä»¶ï¼Œå°†æš´éœ²ç»™å®¢æˆ·ç«¯çš„<strong>æ¥å£åœ¨è¿™ä¸ªAIDLæ–‡ä»¶ä¸­å£°æ˜</strong>ï¼Œ</p>
<ul>
<li>åœ¨æœåŠ¡ç«¯é¡¹ç›®çš„ src/main ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º aidl çš„æ–‡ä»¶å¤¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰ã€‚</li>
<li>åœ¨ aidl æ–‡ä»¶å¤¹å†…åˆ›å»ºä¸€ä¸ªä¸ä½ çš„åŒ…åç›¸åŒçš„æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚ com/example/gradeserviceã€‚</li>
<li>åœ¨è¯¥åŒ…åæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º IGradeService.aidl çš„æ–‡ä»¶</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// IGradeService.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.example.gradeservice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IGradeService</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Serviceä¸­å®ç°è¿™ä¸ªAIDLæ¥å£å¹¶åˆ›å»º<strong>Serviceç”¨æ¥ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚</strong>ã€‚</p>
<ul>
<li>Rebuild é¡¹ç›®ã€‚Android Studio ä¼šè‡ªåŠ¨æ ¹æ® AIDL æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ Java æ¥å£æ–‡ä»¶ï¼ˆIGradeService.javaï¼‰ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªåä¸º GradeService çš„ Service ç±»ï¼Œå¹¶å®ç° IGradeService.Stub æŠ½è±¡ç±»ã€‚</li>
<li>åœ¨ GradeService ä¸­å®ç° getStudentGrade() æ–¹æ³•ï¼Œæä¾›å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// GradeService.java</span></span><br><span class="line"><span class="keyword">package</span> com.example.gradeservice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradeService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IGradeService.<span class="type">Stub</span> <span class="variable">mBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IGradeService</span>.Stub() &#123; <span class="comment">// å®ç°æ¥å£IGradeServiceçš„binderç±»</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">return</span> StudentMap.getStudentGrade(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>clientè¿›ç¨‹ï¼š</p>
<p>å¼•å…¥AIDL</p>
<ul>
<li>å°†æœåŠ¡ç«¯çš„ IGradeService.aidl æ–‡ä»¶ <strong>åŸå°ä¸åŠ¨åœ°</strong> å¤åˆ¶åˆ°å®¢æˆ·ç«¯é¡¹ç›®çš„ src/main/aidl/com/example/gradeservice/ ç›®å½•ä¸‹ã€‚</li>
</ul>
<p><strong>ç»‘å®šæœåŠ¡ç«¯çš„Service</strong>ï¼Œç»‘å®šæˆåŠŸåï¼Œå°†<strong>æœåŠ¡ç«¯è¿”å›çš„Binderå¯¹è±¡è½¬æˆAIDLæ¥å£æ‰€å±çš„ç±»å‹</strong>ï¼Œè°ƒç”¨AIDLæ¥å£ä¸­çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.gradeservice.IGradeService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MainActivity.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseViewBindingActivity</span>&lt;ActivityBinderBinding&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IGradeService mBinderProxy;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ServiceConnection</span> <span class="variable">mServiceConnection</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> &#123;</span><br><span class="line">          	<span class="comment">// é€è¿‡æœåŠ¡ç«¯è¿”å›çš„binderå¯¹è±¡è½¬æ¢ä¸ºä»£ç†binderå¯¹è±¡</span></span><br><span class="line">            mBinderProxy = IGradeService.Stub.asInterface(iBinder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">            mBinderProxy = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        binding.btnBindService.setOnClickListener(view -&gt; bindGradeService());</span><br><span class="line">      	<span class="comment">// æŸ¥è¯¢å­¦ç”Ÿæˆç»©</span></span><br><span class="line">        binding.btnFindGrade.setOnClickListener(view -&gt; getStudentGrade(<span class="string">&quot;Anna&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// ç»‘å®šæœåŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindGradeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> <span class="string">&quot;android.intent.action.server.aidl.gradeservice&quot;</span>;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(action);</span><br><span class="line">        intent.setPackage(getPackageName());</span><br><span class="line">        bindService(intent, mServiceConnection, BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">		<span class="comment">// æŸ¥è¯¢æˆç»©</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getStudentGrade</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">grade</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            grade = mBinderProxy.getStudentGrade(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        ToastUtils.showShort(<span class="string">&quot;Anna grade is &quot;</span> + grade);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Binderå®ç°">Binderå®ç°</h4>
<p><a href="https://www.cnblogs.com/samchen2009/p/3316001.html">https://www.cnblogs.com/samchen2009/p/3316001.html</a></p>
<p><a href="https://sharrychoo.github.io/blog/android-source/dc-binder1">https://sharrychoo.github.io/blog/android-source/dc-binder1</a></p>
<p>è¿›ç¨‹ä½¿ç”¨Binderä¸System_Serveré€šä¿¡ï¼Œä¾‹å¦‚ï¼šAlarmManagerServiceã€BluetoothService å’Œ BatteryServiceï¼Œ</p>
<p><strong>Binderç»“æ„</strong></p>
<p><strong>device_node</strong>: Binderè®¾å¤‡èŠ‚ç‚¹ã€‚</p>
<p><strong>global_state</strong>: å…¨å±€çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€è¿›ç¨‹è®¡æ•°ã€çº¿ç¨‹è®¡æ•°ç­‰ã€‚</p>
<p><strong>binder_procs</strong>: ä½¿ç”¨Binderçš„è¿›ç¨‹åˆ—è¡¨ï¼Œæ¯ä¸ª<strong>binder_proc</strong>åŒ…å«ï¼š</p>
<ul>
<li>nodes: çº¢é»‘æ ‘ï¼Œç”¨äºå­˜å‚¨è¯¥è¿›ç¨‹åˆ›å»ºçš„æ‰€æœ‰ Binder å¯¹è±¡ã€‚
<ul>
<li><strong>Binder å¯¹è±¡:</strong> æä¾›ç‰¹å®šåŠŸèƒ½çš„æ¥å£ï¼Œä¾‹å¦‚ MediaPlayerServiceã€ActivityManagerService ç­‰ç³»ç»ŸæœåŠ¡ã€‚è¿›ç¨‹æ¯æä¾›ä¸€ç§æœåŠ¡å°±æœ‰ä¸€ä¸ªbinderå¯¹è±¡ã€‚</li>
</ul>
</li>
<li>refs: è®°å½•å…¶ä»–è¿›ç¨‹å¯¹è¯¥è¿›ç¨‹ä¸­ Binder å¯¹è±¡çš„å¼•ç”¨ã€‚
<ul>
<li><strong>Binder å¼•ç”¨å¯¹è±¡:</strong> ä»£è¡¨å¯¹ä¸€ä¸ª Binder å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯è¿›ç¨‹æŒæœ‰çš„æœåŠ¡ç«¯ Binder å¯¹è±¡çš„å¼•ç”¨ã€‚</li>
</ul>
</li>
<li>buffers: ç®¡ç† Binder é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„å†…å­˜ç¼“å†²åŒºã€‚</li>
<li>binder_thread: binder_thread ç»“æ„ä½“æŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨äº†è¯¥è¿›ç¨‹æ‰€æœ‰ Binder çº¿ç¨‹çš„ä¿¡æ¯ã€‚</li>
</ul>
<img src="/2024/07/28/Android-Learning-Record/image-20240806112818621.png" class="" title="image-20240806112818621">
<p><strong>Binderæºç </strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> &#123;</span></span><br><span class="line">	<span class="comment">// ç”¨äºå°†è¯¥ binder_proc ç»“æ„ä½“æ’å…¥åˆ°ä¸€ä¸ªå“ˆå¸Œé“¾è¡¨ä¸­ã€‚è¯¥å“ˆå¸Œé“¾è¡¨å­˜å‚¨äº†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ binder_proc ç»“æ„ä½“ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">proc_node</span>;</span></span><br><span class="line">	<span class="comment">// çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚è¯¥çº¢é»‘æ ‘å­˜å‚¨äº†è¯¥è¿›ç¨‹ä¸­æ‰€æœ‰çš„ binder_thread ç»“æ„ä½“</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">threads</span>;</span></span><br><span class="line">	<span class="comment">// çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚è¯¥çº¢é»‘æ ‘å­˜å‚¨äº†è¯¥è¿›ç¨‹ä¸­æ‰€æœ‰çš„ binder_node ç»“æ„ä½“ï¼Œç”¨äºç®¡ç† Binder å®ä½“</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">nodes</span>;</span></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é©±åŠ¨å‡½æ•°æ˜ å°„ã€‚å®šä¹‰äº† Binder é©±åŠ¨çš„æ–‡ä»¶æ“ä½œå‡½æ•°é›†ã€‚æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å¤„ç†ç‰¹å®šæ–‡ä»¶æ“ä½œçš„å‡½æ•°ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">binder_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.poll = binder_poll,</span><br><span class="line">	.unlocked_ioctl = binder_ioctl,</span><br><span class="line">	.compat_ioctl = binder_ioctl,</span><br><span class="line">	.mmap = binder_mmap,</span><br><span class="line">	.open = binder_open,</span><br><span class="line">	.flush = binder_flush,</span><br><span class="line">	.release = binder_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œé©±åŠ¨å‚æ•°ç»“æ„ä½“</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">binder_miscdev</span> =</span> &#123;</span><br><span class="line">	.minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    <span class="comment">// é©±åŠ¨åç§°</span></span><br><span class="line">	.name = <span class="string">&quot;binder&quot;</span>,</span><br><span class="line">	.fops = &amp;binder_fops</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// binder_open : å¤„ç† open ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‰“å¼€ Binder è®¾å¤‡æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="comment">// binder_mmap: å¤„ç† mmap ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºå°† Binder é©±åŠ¨çš„å†…å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">binder_open</span><span class="params">(<span class="keyword">struct</span> inode *nodp, <span class="keyword">struct</span> file *filp)</span>&#123;......&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">binder_mmap</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> vm_area_struct *vma)</span>&#123;......&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">binder_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="comment">// åˆ›å»ºåä¸ºbinderçš„å•çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—</span></span><br><span class="line">    binder_deferred_workqueue = create_singlethread_workqueue(<span class="string">&quot;binder&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!binder_deferred_workqueue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// æ³¨å†Œé©±åŠ¨ï¼Œmiscè®¾å¤‡å…¶å®ä¹Ÿå°±æ˜¯ç‰¹æ®Šçš„å­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    ret = misc_register(&amp;binder_miscdev);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é©±åŠ¨æ³¨å†Œå‡½æ•°</span></span><br><span class="line">device_initcall(binder_init);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Binder é€šä¿¡æµç¨‹:</strong></p>
<p><strong>Main_MediaServer.cpp</strong></p>
<p>Serverè·å¾—ProcessStateå®ä¾‹ï¼Œä½¿ç”¨è¯¥å®ä¾‹åˆ›å»ºçº¿ç¨‹æ± </p>
<p>Serverè°ƒç”¨<code>defaultServiceManager()</code>è·å¾— IServiceManagerï¼Œå³BpBinderï¼Œå¯¹åº”ServiceManagerçš„å®¢æˆ·ç«¯Binder</p>
<p><strong>ProcessState.cpp</strong></p>
<p>ProcessStateçš„æ„é€ å‡½æ•°åˆå§‹åŒ–</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240806155020313.png" class="" title="image-20240806155020313">
<img src="/2024/07/28/Android-Learning-Record/image-20240806155033149.png" class="" title="image-20240806155033149">
<p><code>open_driver()</code>å‡½æ•°æ‰“å¼€äº†è®¾å¤‡ <code>/dev/binder</code> ï¼Œå¹¶è®¾ç½®è¯¥è¿›ç¨‹åœ¨Binderä¸­çš„çº¿ç¨‹æ± </p>
<blockquote>
<p>æ¯ä¸ªä½¿ç”¨Binderçš„è¿›ç¨‹éƒ½åœ¨Binderé©±åŠ¨ä¸­æœ‰è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹ç”¨äºä¿¡æ¯çš„å¤„ç†</p>
</blockquote>
<p>ç„¶åï¼Œè°ƒç”¨<code>mmap(...)</code>åˆ›å»ºå†…å­˜æ˜ å°„ï¼Œå³ä¸ºä¸‹å›¾ä¸­çš„Serverè¿›ç¨‹ä¸­æ“ä½œ</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240805194744173.png" class="" title="image-20240805194744173">
<p><strong>IServiceManager.cpp</strong></p>
<p>è¿”å›BpBinder(handler)ï¼Œå³ IServiceManager</p>
<h4 id="Messageè·¨è¿›ç¨‹é€šä¿¡">Messageè·¨è¿›ç¨‹é€šä¿¡</h4>
<h4 id="Socket">Socket</h4>
<img src="/2024/07/28/Android-Learning-Record/image-20240721155920403-1722133033018.png" class="" title="image-20240721155920403">
<h3 id="Viewä¸äº‹ä»¶åˆ†å‘æœºåˆ¶">Viewä¸äº‹ä»¶åˆ†å‘æœºåˆ¶</h3>
<h4 id="äº‹ä»¶åˆ†å‘æµç¨‹">äº‹ä»¶åˆ†å‘æµç¨‹</h4>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.cn/post/6931914294980411406">https://juejin.cn/post/6931914294980411406</a></p>
<p>æ¯æ¬¡è¿›è¡Œäº‹ä»¶ä¼ é€’çš„æ˜¯å•ä¸ªäº‹ä»¶ï¼Œå³ ACTION_DOWN, ACTION_MOVE, ACTION_UP, å¹¶éäº‹ä»¶åºåˆ—</p>
<p>case 1: -&gt; dispatch -&gt; dispatch -&gt; InterceptTouchEvent -&gt; TouchEvent - &gt; TouchEvent</p>
<p>case 2: -&gt; dispatch -&gt; dispatch -&gt; TouchEvent - &gt; TouchEvent</p>
<p>case 3: -&gt; dispatch -&gt; dispatch -&gt; TouchEvent</p>
<ol>
<li>
<p><strong>äº‹ä»¶ä¼ é€’ï¼š</strong> å½“ç”¨æˆ·è§¦æ‘¸å±å¹•æ—¶ï¼Œç³»ç»Ÿä¼šå°†äº‹ä»¶å°è£…æˆ MotionEvent å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™å½“å‰ Activity çš„ dispatchTouchEvent(â€¦) æ–¹æ³•ã€‚</p>
</li>
<li>
<p><strong>åˆ†å‘ï¼š</strong> Activity ä¼šå°†äº‹ä»¶ä¼ é€’ç»™å…¶æ ¹è§†å›¾ViewGroupï¼ˆé€šå¸¸æ˜¯ DecorViewï¼‰çš„ dispatchTouchEvent(â€¦) æ–¹æ³•ã€‚ViewGroupå’ŒViewå°†ç»§ç»­è°ƒç”¨dispatchTouchEvent(â€¦) æ–¹æ³•åˆ†å‘è¯¥åŠ¨ä½œã€‚</p>
</li>
</ol>
<ul>
<li>å¦‚æœè¿”å› trueï¼Œåˆ™è¡¨ç¤º<strong>å½“å‰äº‹ä»¶åœ¨æ­¤ View åŠå…¶å­ View ä¸­è¢«å¤„ç†</strong>ï¼Œåç»­äº‹ä»¶åºåˆ—å°†è¢«ç»§ç»­ä¸‹å‘ã€‚</li>
<li>å¦‚æœè¿”å› falseï¼Œåˆ™è¡¨ç¤º<strong>å½“å‰äº‹ä»¶åœ¨æ­¤ View åŠå…¶å­ View ä¸­æœªè¢«å¤„ç†</strong>ï¼Œåç»­äº‹ä»¶åºåˆ—å°†ä¸ä¼šåˆ°è¾¾æ­¤View</li>
</ul>
<ol start="3">
<li><strong>æ‹¦æˆªï¼š</strong> ViewGroup åœ¨æ¥æ”¶åˆ°äº‹ä»¶åï¼Œä¼šè°ƒç”¨è‡ªèº«çš„ onInterceptTouchEvent() æ–¹æ³•åˆ¤æ–­æ˜¯å¦æ‹¦æˆªè¯¥äº‹ä»¶ã€‚</li>
</ol>
<ul>
<li>å¦‚æœè¿”å› trueï¼Œåˆ™è¡¨ç¤ºæ‹¦æˆªè¯¥äº‹ä»¶ï¼Œäº‹ä»¶å°†ç”± ViewGroup è‡ªèº«å¤„ç†ï¼Œè°ƒç”¨è‡ªèº«çš„ onTouchEvent() æ–¹æ³•ã€‚
<ul>
<li>å¦‚æœè¿”å› falseï¼Œåˆ™è¡¨ç¤ºä¸æ‹¦æˆªè¯¥äº‹ä»¶ï¼Œäº‹ä»¶å°†ç»§ç»­ä¼ é€’ç»™å…¶å­ View æˆ– ViewGroup è¿›è¡Œåˆ†å‘ã€‚</li>
</ul>
</li>
</ul>
<ol start="4">
<li>
<p><strong>å¤„ç†ï¼š</strong> View å’Œ ViewGroup æ¥æ”¶åˆ°äº‹ä»¶åï¼Œä¼šè°ƒç”¨è‡ªèº«çš„ onTouchEvent() æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚ ACTION_DOWN äº‹ä»¶åœ¨å¤„ç†åï¼Œå°†å½’å±äºè¯¥Viewè¿›è¡Œå®Œæ•´äº‹ä»¶åºåˆ—å¤„ç†ã€‚</p>
<ul>
<li>å¦‚æœè¿”å› trueï¼Œåˆ™è¡¨ç¤ºè¯¥äº‹ä»¶è¢«æ¶ˆè´¹ï¼Œäº‹ä»¶ä¼ é€’ç»“æŸã€‚</li>
<li>å¦‚æœè¿”å› falseï¼Œåˆ™è¡¨ç¤ºè¯¥äº‹ä»¶æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œäº‹ä»¶å°†å›ä¼ ç»™çˆ¶ View çš„ onTouchEvent() æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
</li>
<li>
<p><strong>äº‹ä»¶å›ä¼ ï¼š</strong> å¦‚æœäº‹ä»¶æ²¡æœ‰è¢«ä»»ä½• View æ¶ˆè´¹ï¼Œæœ€ç»ˆä¼šå›åˆ° Activity çš„ onTouchEvent() æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p>
</li>
</ol>
<blockquote>
<p><strong>äº‹ä»¶ä¼ é€’æ–¹å‘ï¼š</strong></p>
<ul>
<li>å‘ä¸‹ä¼ é€’ï¼ˆåˆ†å‘ï¼‰ï¼š äº‹ä»¶æ˜¯ä»æ ¹è§†å›¾ (DecorView) å¼€å§‹ï¼Œæ²¿ç€è§†å›¾æ ‘ <strong>é€å±‚å‘ä¸‹</strong> åˆ†å‘ï¼Œç›´åˆ°ä¼ é€’åˆ°æœ€ç»ˆå¤„ç†è¯¥äº‹ä»¶çš„å­è§†å›¾æˆ–è¢«æŸä¸ª ViewGroup æ‹¦æˆªã€‚</li>
<li>å‘ä¸Šå›ä¼ ï¼š å¦‚æœäº‹ä»¶æ²¡æœ‰è¢«ä»»ä½•å­è§†å›¾æ¶ˆè´¹ï¼Œåˆ™ä¼š <strong>åŸè·¯è¿”å›</strong>ï¼Œæ²¿ç€è§†å›¾æ ‘ <strong>é€å±‚å‘ä¸Š</strong> å›ä¼ ï¼Œç›´åˆ°è¢«æŸä¸ª View æˆ– ViewGroup å¤„ç†æˆ–æœ€ç»ˆåˆ°è¾¾ Activityã€‚</li>
</ul>
<p><strong>äº‹ä»¶æ‹¦æˆª</strong></p>
<p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªäº‹ä»¶åºåˆ—åªåº”è¯¥ç”±å•ç‹¬ä¸€ä¸ª View æˆ–è€… ViewGroup è¿›è¡Œå¤„ç†ã€‚è¿™æ„å‘³ç€ï¼Œ å“ªä¸ª View æ¶ˆè´¹äº† ACTION_DOWN äº‹ä»¶ï¼Œå“ªä¸ª View å°±ä¼šæ¥ç®¡æ•´ä¸ªäº‹ä»¶åºåˆ—çš„å¤„ç†ï¼Œä¸å†ç»è¿‡å…¶ä»–äº‹ä»¶</p>
<ol>
<li>
<p>æ‹¦æˆª&amp;å¤„ç†ï¼šæ•´ä¸ªäº‹ä»¶åºåˆ—å°†ç›´æ¥ä¼ é€’ç»™è¯¥ViewGroupå¤„ç†ï¼Œä¸å†ç»è¿‡å…¶ä»–äº‹ä»¶</p>
</li>
<li>
<p>æ‹¦æˆª&amp;ä¸å¤„ç†ï¼šåç»­äº‹ä»¶åºåˆ—å°†ä¸ä¼šå†ä¼ é€’ç»™è¯¥ ViewGroupï¼Œè€Œæ˜¯ç›´æ¥äº¤ç»™å…¶çˆ¶è§†å›¾å¤„ç†</p>
</li>
</ol>
<p>extï¼šè‹¥æ‰€æœ‰Viewå’ŒViewGroupå‡ä¸å¤„ç† ACTION_DOWN äº‹ä»¶ï¼Œåç»­äº‹ä»¶åºåˆ—å°†ç›´æ¥ç”±Activityå¤„ç†ï¼›</p>
</blockquote>
<p><strong>åæ ‡ç³»</strong></p>
<p><strong>å±å¹•åæ ‡ç³»</strong>ï¼š Raw ä»¥å±å¹•å·¦ä¸Šè§’ä½œä¸ºåæ ‡åŸç‚¹ï¼Œæ°´å¹³å‘å³æ–¹å‘ä¸º X è½´æ­£è½´æ–¹å‘ï¼Œç«–ç›´å‘ä¸‹æ–¹å‘ä¸º Y è½´æ­£è½´æ–¹å‘ã€‚</p>
<p><strong>View åæ ‡ç³»</strong>ï¼š é»˜è®¤ ä»¥ View æ‰€åœ¨çš„ ViewGroup çš„å·¦ä¸Šè§’ä½œä¸ºåæ ‡åŸç‚¹ï¼Œæ°´å¹³å‘å³æ–¹å‘ä¸º X è½´æ­£è½´æ–¹å‘ï¼Œç«–ç›´å‘ä¸‹æ–¹å‘ä¸º Y è½´æ­£è½´æ–¹å‘ã€‚View ç±»åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ç”¨äºè·å–å…¶ç›¸å¯¹çˆ¶å®¹å™¨ ViewGroup çš„è·ç¦»ï¼š</p>
<ul>
<li>getLeft()ã€‚View å·¦ä¾§åˆ° ViewGroup å·¦ä¾§ä¹‹é—´çš„è·ç¦»</li>
<li>getTop()ã€‚View é¡¶éƒ¨åˆ° ViewGroup é¡¶éƒ¨ä¹‹é—´çš„è·ç¦»</li>
<li>getRight()ã€‚View å³ä¾§åˆ° ViewGroup å·¦ä¾§ä¹‹é—´çš„è·ç¦»</li>
<li>getBottom()ã€‚View åº•éƒ¨åˆ° ViewGroup é¡¶éƒ¨ä¹‹é—´çš„è·ç¦»</li>
</ul>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.cn/post/6931914294980411406">https://juejin.cn/post/6931914294980411406</a></p>
<p><strong>äº‹ä»¶åºåˆ—</strong></p>
<p>ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶åºåˆ—ï¼ŒæŒ‡çš„æ˜¯ä»æ‰‹æŒ‡è§¦æ‘¸å±å¹•å¼€å§‹ï¼Œåˆ°æ‰‹æŒ‡ç¦»å¼€å±å¹•ç»“æŸï¼ŒæœŸé—´äº§ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ã€‚</p>
<p>è¿™ä¸ªåºåˆ—åŒ…å«å¦‚ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li><strong>æŒ‰ä¸‹ï¼ˆACTION_DOWNï¼‰ï¼š</strong> æ‰‹æŒ‡è§¦ç¢°å±å¹•çš„ç¬é—´è§¦å‘ã€‚</li>
<li><strong>ç§»åŠ¨ï¼ˆACTION_MOVEï¼‰ï¼š</strong> æ‰‹æŒ‡åœ¨å±å¹•ä¸Šæ»‘åŠ¨æ—¶ï¼Œä¼šå¤šæ¬¡è§¦å‘è¯¥äº‹ä»¶ã€‚</li>
<li><strong>æŠ¬èµ·ï¼ˆACTION_UPï¼‰ï¼š</strong> æ‰‹æŒ‡ç¦»å¼€å±å¹•çš„ç¬é—´è§¦å‘ã€‚</li>
</ol>
<p><strong>Mutil View</strong></p>
<blockquote>
<p>æ ¸å¿ƒï¼š(ViewGroup)DispatchTouchEvent() -&gt; (ViewGroup)onInterceptTouchEvent()  -&gt; {(ViewGroup)onTouchEvent()} -&gt; (View)DispatchTouchEvent() -&gt;  (View)onTouchEvent()</p>
<p>DispatchTouchEvent è¿”å› True äº‹ä»¶è¢«æ¶ˆè´¹</p>
<p>onInterceptTouchEvent è¿”å› True äº‹ä»¶è¢«æ‹¦æˆªï¼Œè°ƒç”¨å½“å‰çº§çš„onTouch()</p>
<p>onTouchEvent() è¿”å› True äº‹ä»¶è¢«æ¶ˆè´¹</p>
<p>Activity: DispatchTouchEvent + onTouchEvent</p>
<p>ViewGroup: DispatchTouchEvent + onInterceptTouchEvent + onTouchEvent</p>
<p>View: DispatchTouchEvent + onTouchEvent</p>
</blockquote>
<p><strong>View</strong></p>
<p>Android ç•Œé¢ä¸­æ‰€æœ‰å¯è§†åŒ–å…ƒç´ çš„åŸºç±»ï¼Œä»£è¡¨ä¸€ä¸ªçŸ©å½¢åŒºåŸŸï¼Œè´Ÿè´£è‡ªèº«å†…å®¹çš„ç»˜åˆ¶ã€äº‹ä»¶å¤„ç†ä»¥åŠå¸ƒå±€ç­‰ã€‚<strong>å¸¸è§å­ç±»ï¼š</strong> TextViewã€Buttonã€ImageViewã€EditText ç­‰ã€‚</p>
<ul>
<li>
<p>DispatchTouchEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="comment">// ç”¨äºè¡¨ç¤ºå½“å‰ View æ˜¯å¦æ¶ˆè´¹äº†è¯¥äº‹ä»¶</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">actionMasked</span> <span class="operator">=</span> event.getActionMasked();</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">        <span class="comment">//Viewå¯ç”¨&amp;&amp;handleScrollBarDraggingè¿”å›true</span></span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å­˜åœ¨OnTouchListener&amp;&amp;Viewå¯ç”¨&amp;&amp;OnTouchListenerè¿”å›true</span></span><br><span class="line">        <span class="comment">//OnTouchListenerä¼˜å…ˆçº§é«˜äºonClickListenerï¼ï¼</span></span><br><span class="line">        <span class="type">ListenerInfo</span> <span class="variable">li</span> <span class="operator">=</span> mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="literal">null</span> &amp;&amp; li.mOnTouchListener != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">            &amp;&amp; li.mOnTouchListener.onTouch(<span class="built_in">this</span>, event)) &#123;</span><br><span class="line">           result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//resultä»ä¸ºfalse&amp;&amp;è‡ªèº«onTouchEventæ¶ˆè´¹åŠ¨ä½œäº‹ä»¶</span></span><br><span class="line">        <span class="comment">// onClickListeneråœ¨onTouchEventæ–¹æ³•ä¸­è¢«è°ƒç”¨çš„</span></span><br><span class="line">        <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>OnTouchEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="comment">// äº‹ä»¶å¯ç‚¹å‡»åˆ¤æ–­</span></span><br><span class="line">    <span class="comment">// CLICKABLEã€LONG_CLICKABLEã€CONTEXT_CLICKABLEå¯¹åº”ç€ï¼šå¯ç‚¹å‡»ã€å¯é•¿æŒ‰ç‚¹å‡»ã€å¯ä¸Šä¸‹æ–‡ç‚¹å‡»</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">clickable</span> <span class="operator">=</span> ((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">          || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">          || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰ View å¤„äºç¦ç”¨çŠ¶æ€ DISABLED çš„è¯ï¼Œå½“å‰ View æ˜¯å¦ä¼šæ¶ˆè€—è§¦æ‘¸äº‹ä»¶éƒ½ç”± clickable æ¥å†³å®šï¼Œ</span></span><br><span class="line">        <span class="keyword">return</span> clickable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TouchDelegate å¯ä»¥ç”¨äºæ”¹å˜ View çš„è§¦æ‘¸åŒºåŸŸï¼Œä¾‹å¦‚å°†ä¸€ä¸ªè¾ƒå°çš„ View çš„è§¦æ‘¸åŒºåŸŸæ‰©å¤§ã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœè®¾ç½®äº† TouchDelegateï¼Œè°ƒç”¨ TouchDelegate çš„ onTouchEvent æ–¹æ³•å¤„ç†è§¦æ‘¸äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¯ç‚¹å‡» OR Viewä¸ºå·¥å…·æç¤º</span></span><br><span class="line">    <span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦å–å¾—ç„¦ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (!focusTaken) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPerformClick == <span class="literal">null</span>) &#123;</span><br><span class="line">                mPerformClick = <span class="keyword">new</span> <span class="title class_">PerformClick</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// PerformClick å¯¹è±¡æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (!post(mPerformClick)) &#123;</span><br><span class="line">               <span class="comment">// å¦‚æœæ— æ³•å°† PerformClick å¯¹è±¡æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œåˆ™ç›´æ¥è°ƒç”¨ performClickInternal æ–¹æ³•æ‰§è¡Œç‚¹å‡»äº‹ä»¶ã€‚performClickInternal() æ–¹æ³•æ˜¯ View ç±»ä¸­çš„ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œå®ƒä¼šæ‰§è¡Œå®é™…çš„ç‚¹å‡»æ“ä½œï¼Œä¾‹å¦‚è°ƒç”¨ OnClickListener çš„ onClick() æ–¹æ³•ç­‰ã€‚</span></span><br><span class="line">               performClickInternal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Â·Â·Â·</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>ViewGroup</strong></p>
<p>ç»§æ‰¿è‡ª Viewï¼Œä½†å®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªå­ Viewï¼Œå¹¶è´Ÿè´£ç®¡ç†è¿™äº›å­ View çš„å¸ƒå±€å’Œäº‹ä»¶åˆ†å‘ã€‚<strong>å¸¸è§å­ç±»ï¼š</strong>  LinearLayoutã€RelativeLayoutã€FrameLayoutã€ConstraintLayout ç­‰ã€‚</p>
<ul>
<li>
<p>DispatchTouchEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">     Â·Â·Â·</span><br><span class="line">     <span class="type">boolean</span> <span class="variable">handled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">     <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">int</span> <span class="variable">action</span> <span class="operator">=</span> ev.getAction();</span><br><span class="line">         <span class="keyword">final</span> <span class="type">int</span> <span class="variable">actionMasked</span> <span class="operator">=</span> action &amp; MotionEvent.ACTION_MASK;</span><br><span class="line">  </span><br><span class="line">         <span class="comment">// æ–°çš„äº‹ä»¶åºåˆ—</span></span><br><span class="line">         <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">             <span class="comment">// æ¸…é™¤æ—§äº‹ä»¶å¼•ç”¨</span></span><br><span class="line">             cancelAndClearTouchTargets(ev);</span><br><span class="line">             resetTouchState();</span><br><span class="line">         &#125;</span><br><span class="line">  </span><br><span class="line">         <span class="comment">// æ–°äº‹ä»¶åºåˆ— æˆ– å­˜åœ¨æ—§äº‹ä»¶å¼•ç”¨</span></span><br><span class="line">         <span class="comment">// å­˜åœ¨æ—§äº‹ä»¶å¼•ç”¨æ„å‘³ç€æœ‰å­Viewæ¶ˆè´¹äº†å½“å‰äº‹ä»¶åºåˆ—çš„ACTION_DOWN</span></span><br><span class="line">         <span class="keyword">final</span> <span class="type">boolean</span> intercepted;</span><br><span class="line">         <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                 || mFirstTouchTarget != <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="comment">// å­Viewå¯ä»¥è¯·æ±‚çˆ¶Viewä¸æ‹¦æˆª</span></span><br><span class="line">             <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">disallowIntercept</span> <span class="operator">=</span> (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                 <span class="comment">// è°ƒç”¨onInterceptTouchEventåˆ¤æ–­æ˜¯å¦æ‹¦æˆª</span></span><br><span class="line">                 intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                 ev.setAction(action);</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">// å­Viewè¯·æ±‚çˆ¶Viewä¸æ‹¦æˆª</span></span><br><span class="line">                 intercepted = <span class="literal">false</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             intercepted = <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">  </span><br><span class="line">         Â·Â·Â·</span><br><span class="line">  </span><br><span class="line">         <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line">             <span class="type">View</span> <span class="variable">childWithAccessibilityFocus</span> <span class="operator">=</span> ev.isTargetAccessibilityFocus()</span><br><span class="line">                     ? findChildWithAccessibilityFocus() : <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">             <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                     || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">                     || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">                 <span class="keyword">final</span> <span class="type">int</span> <span class="variable">actionIndex</span> <span class="operator">=</span> ev.getActionIndex(); <span class="comment">// always 0 for down</span></span><br><span class="line">                 <span class="keyword">final</span> <span class="type">int</span> <span class="variable">idBitsToAssign</span> <span class="operator">=</span> split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</span><br><span class="line">                         : TouchTarget.ALL_POINTER_IDS;</span><br><span class="line">  </span><br><span class="line">                 <span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></span><br><span class="line">                 <span class="comment">// have become out of sync.</span></span><br><span class="line">                 removePointersFromTouchTargets(idBitsToAssign);</span><br><span class="line">  </span><br><span class="line">                 <span class="comment">// éå†å­Viewæ‰¾åˆ°ACTION_DOWNè½ç‚¹</span></span><br><span class="line">                 <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childrenCount</span> <span class="operator">=</span> mChildrenCount;</span><br><span class="line">                 <span class="keyword">if</span> (newTouchTarget == <span class="literal">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</span><br><span class="line">                     Â·Â·Â·</span><br><span class="line">                     <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                         Â·Â·Â·</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                     Â·Â·Â·</span><br><span class="line">                 &#125;</span><br><span class="line">	   Â·Â·Â·</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">  </span><br><span class="line">         <span class="keyword">if</span> (mFirstTouchTarget == <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="comment">// åŠ¨ä½œæœªè¢«å­ç±»æ¶ˆè´¹ æˆ– è¢«æ‹¦æˆª</span></span><br><span class="line">             handled = dispatchTransformedTouchEvent(ev, canceled, <span class="literal">null</span>,</span><br><span class="line">                     TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// </span></span><br><span class="line">             <span class="type">TouchTarget</span> <span class="variable">predecessor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">             <span class="type">TouchTarget</span> <span class="variable">target</span> <span class="operator">=</span> mFirstTouchTarget;</span><br><span class="line">             <span class="keyword">while</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">final</span> <span class="type">TouchTarget</span> <span class="variable">next</span> <span class="operator">=</span> target.next;</span><br><span class="line">                 <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</span><br><span class="line">                     handled = <span class="literal">true</span>;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">cancelChild</span> <span class="operator">=</span> resetCancelNextUpFlag(target.child)</span><br><span class="line">                             || intercepted;</span><br><span class="line">                     <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">                             target.child, target.pointerIdBits)) &#123;</span><br><span class="line">                         handled = <span class="literal">true</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">if</span> (cancelChild) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (predecessor == <span class="literal">null</span>) &#123;</span><br><span class="line">                             mFirstTouchTarget = next;</span><br><span class="line">                         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                             predecessor.next = next;</span><br><span class="line">                         &#125;</span><br><span class="line">                         target.recycle();</span><br><span class="line">                         target = next;</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 predecessor = target;</span><br><span class="line">                 target = next;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">Â·Â·Â·</span><br><span class="line">     &#125;</span><br><span class="line">  </span><br><span class="line">     <span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="literal">null</span>) &#123;</span><br><span class="line">         mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> handled;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>PhoneWindowä¸DecorView</strong></p>
<ul>
<li>æ¯ä¸ª Activity éƒ½å¯¹åº”ä¸€ä¸ª PhoneWindowï¼Œå³æ¯ä¸ª Activity å®ä¾‹å‡åŒ…å«äº†ä¸€ä¸ª PhoneWindow å¯¹è±¡</li>
<li>æ¯ä¸ª PhoneWindow éƒ½å¯¹åº”ä¸€ä¸ª DecorViewï¼ŒDecorView ä¾é  PhoneWindow ä½œä¸ºæ„é€ å‚æ•°ä¹‹ä¸€æ¥å®ä¾‹åŒ–</li>
<li>DecorView æ˜¯ FrameLayout çš„å­ç±»ï¼Œæ˜¯ Activity è§†å›¾æ ‘çš„æ ¹è§†å›¾ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ setContentView æ‰€æ·»åŠ çš„ View å°±å¯¹åº” DecorView çš„ ContentParent åŒºåŸŸ</li>
<li>åœ¨è¿™ä¸‰è€…ä¸­ DecorView ä¼šæœ€å…ˆæ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶ï¼ŒDecorView ä½œä¸ºè§†å›¾æ ‘çš„æ ¹è§†å›¾ï¼Œå°±è´Ÿè´£å‘å…¶å†…éƒ¨ View ä¸‹å‘è§¦æ‘¸äº‹ä»¶</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Activity</span><br><span class="line">â”‚</span><br><span class="line">â””â”€â”€ PhoneWindow</span><br><span class="line">    â”‚</span><br><span class="line">    â””â”€â”€ DecorView (ç»§æ‰¿FrameLayout)</span><br><span class="line">		â”‚</span><br><span class="line">		â””â”€â”€ LinearLayout</span><br><span class="line">                â”‚</span><br><span class="line">                â”œâ”€â”€ TitleBar/ActionBar</span><br><span class="line">                â”‚</span><br><span class="line">                â””â”€â”€ ContentView (setContentView(..))</span><br><span class="line">                    â”‚</span><br><span class="line">                    â””â”€â”€ ... å…¶ä»– View</span><br></pre></td></tr></table></figure>
<blockquote>
<p>StatusBar (çŠ¶æ€æ ) ä¸å±äº å½“å‰Activityï¼Œä½äºå±å¹•æœ€ä¸Šæ–¹</p>
<p>TitleBar/ActionBar å±äº DecorViewï¼Œä½äº StatusBar (çŠ¶æ€æ ) ä¸‹æ–¹</p>
</blockquote>
<img src="/2024/07/28/Android-Learning-Record/944365-34992eb46bdf93e7.png" class="" title="image-20240812184518922">
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.cn/post/6931914294980411406">https://juejin.cn/post/6931914294980411406</a></p>
<blockquote>
<p>ç¡¬ä»¶ -&gt; WindowManager -&gt; ViewRoot(ViewRootImplç±»ï¼Œè¿æ¥å±‚) -&gt; DecorView -&gt; Activity-PhoneWindow-DecorView -&gt; ViewGroup -&gt; View</p>
<p>è¿™ä¸‰è€…ä¹‹é—´çš„è”ç³»åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿè¿™æ ·å…œå…œè½¬è½¬ä¸€åœˆï¼Œå…¶å®å°±æ˜¯ DecorView å…ˆå°†äº‹ä»¶ä¼ ç»™äº† Activityï¼ŒActivity åˆä¼ ç»™äº† PhoneWindowï¼ŒPhoneWindow åˆå°†äº‹ä»¶ä¼ ç»™äº† DecorViewï¼ŒDecorView æœ€ååˆæŒ‰ç…§ ViewGroup é»˜è®¤çš„æ–¹å¼è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œçœ‹èµ·æ¥å°±æ˜¯åœ¨ç»•åœˆï¼Œè¿™æ ·è®¾è®¡çš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å…¶å®ï¼ŒDecorView ä½œä¸ºè§¦æ‘¸äº‹ä»¶çš„ç¬¬ä¸€ä¸ªæ¥æ”¶è€…ï¼Œæ˜¯è§¦æ‘¸äº‹ä»¶ä»ç³»ç»Ÿä¸‹å‘åˆ° Activity ä¹‹é—´çš„ä¸€ä¸ªæ²Ÿé€šæ¡¥æ¢ï¼Œè€Œå¼€å‘è€…å¯ä»¥ç›´æ¥æ¥è§¦å¹¶ç»§æ‰¿çš„æ˜¯ Activityã€‚DecorView éœ€è¦å…ˆå°†äº‹ä»¶è½¬å‘ç»™æœ€å¤–å±‚çš„ Activityï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥é€šè¿‡é‡å†™ dispatchTouchEvent å’Œ onTouchEvent æ–¹æ³•ä»¥è¾¾åˆ°å¯¹å½“å‰å±å¹•è§¦æ‘¸äº‹ä»¶è¿›è¡Œæ‹¦æˆªçš„ç›®çš„ã€‚DecorView ä½œä¸º View æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä» PhoneWindow æ¥æ”¶åˆ°äº‹ä»¶åï¼Œåˆè´Ÿè´£å°†å°†äº‹ä»¶äº‹ä»¶åˆ†å‘ç»™å­ Viewï¼Œä»è€Œå°†æ•´ä¸ªäº‹ä»¶é“¾ç»™ä¸²è”äº†èµ·æ¥</p>
</blockquote>
<img src="/2024/07/28/Android-Learning-Record/image-20240831191655656.png" class="" title="image-20240831191655656">
<img src="/2024/07/28/Android-Learning-Record/image-20240831192314544.png" class="" title="image-20240831192314544">
<p>Activity åˆ›å»º æ—¶ï¼š</p>
<p>â€‹	åˆ›å»ºPhoneWindowå¯¹è±¡(Windowå¯¹è±¡å®ç°)ï¼›</p>
<p>â€‹	PhoneWindow.setCallback(this)</p>
<p>â€‹	PhoneWindow.setWindowManger(â€¦)</p>
<p>Activity setContentView æ—¶ï¼š</p>
<p>â€‹	setContentView</p>
<p>â€‹		-&gt; installDecor()</p>
<p>â€‹			-&gt; generateDecor() -&gt;new DecorView(getContext(), -1)</p>
<p>â€‹			    generateLayout(mDecor)</p>
<p>â€‹	InitWindowDecorActionBar</p>
<p><strong>messageï¼Œhandlerä¸Viewäº¤äº’æ¡ˆä¾‹</strong></p>
<ol>
<li>è§¦æ‘¸äº‹ä»¶çš„äº§ç”Ÿï¼š<br>
å½“ç”¨æˆ·è§¦æ‘¸å±å¹•æ—¶ï¼ŒAndroidç³»ç»Ÿçš„åº•å±‚ï¼ˆInputç³»ç»Ÿï¼‰ä¼šæ•è·è¿™ä¸ªç‰©ç†äº‹ä»¶ã€‚</li>
<li>äº‹ä»¶çš„åˆæ­¥å¤„ç†ï¼š<br>
è¿™ä¸ªè§¦æ‘¸äº‹ä»¶é¦–å…ˆè¢«å°è£…æˆä¸€ä¸ªåŸå§‹çš„è¾“å…¥äº‹ä»¶ï¼ˆInput Eventï¼‰ã€‚</li>
<li>äº‹ä»¶åˆ†å‘åˆ°åº”ç”¨ï¼š<br>
ç³»ç»Ÿå°†è¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™å½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºã€‚</li>
<li>è½¬åŒ–ä¸ºæ¶ˆæ¯ï¼š<br>
åœ¨åº”ç”¨ç¨‹åºè¿™ä¸€å±‚ï¼Œè¿™ä¸ªè¾“å…¥äº‹ä»¶è¢«è½¬æ¢æˆä¸€ä¸ªæ¶ˆæ¯ï¼ˆMessageï¼‰ï¼Œå¹¶è¢«æ·»åŠ åˆ°ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰ä¸­ã€‚</li>
<li>Looperå¤„ç†æ¶ˆæ¯ï¼š<br>
ä¸»çº¿ç¨‹çš„Looperä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºè¿™ä¸ªæ¶ˆæ¯ï¼Œå¹¶å°†å…¶åˆ†å‘ç»™é€‚å½“çš„Handlerå¤„ç†ã€‚</li>
<li>ViewRootImplçš„è§’è‰²ï¼š<br>
åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸ªHandleræ˜¯ä¸ViewRootImplå…³è”çš„ã€‚ViewRootImplæ˜¯è¿æ¥WindowManagerå’ŒDecorViewçš„çº½å¸¦ã€‚</li>
<li>äº‹ä»¶çš„å‘ä¸‹åˆ†å‘ï¼š<br>
ViewRootImplæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šè°ƒç”¨DecorViewçš„dispatchTouchEvent()æ–¹æ³•ï¼Œå¼€å§‹äº‹ä»¶çš„å‘ä¸‹åˆ†å‘è¿‡ç¨‹ã€‚</li>
<li>åˆ°è¾¾ç›®æ ‡Viewï¼š<br>
äº‹ä»¶ä¼šæ²¿ç€Viewå±‚çº§æ ‘å‘ä¸‹ä¼ é€’ï¼Œç›´åˆ°åˆ°è¾¾ä½ ç‚¹å‡»çš„æŒ‰é’®ï¼ˆButtonï¼‰ã€‚</li>
<li>OnClickListenerçš„è°ƒç”¨ï¼š<br>
å¦‚æœæŒ‰é’®è®¾ç½®äº†OnClickListenerï¼Œå…¶onClick()æ–¹æ³•ä¼šåœ¨è¿™ä¸ªåˆ†å‘è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ã€‚</li>
</ol>
<p>å‚è€ƒï¼š<a href="https://www.jianshu.com/p/38015afcdb58">https://www.jianshu.com/p/38015afcdb58</a></p>
<p>Activityäº‹ä»¶åˆ†å‘</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240831145006895.png" class="" title="image-20240831145006895">
<p>ViewGroupäº‹ä»¶åˆ†å‘</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240831150437519.png" class="" title="image-20240831150437519">
<p>æ‹¦æˆªå‘ç”Ÿæ—¶ï¼Œè°ƒç”¨è‡ªå·±çš„æ²¡æœ‰è¢«é‡å†™çš„dispatchTouchEvent()å¤„ç†äº‹ä»¶ï¼›</p>
<p>ä¾‹å¤–ï¼š</p>
<p>è‹¥ViewGroupæ‹¦æˆªäº†ä¸­é—´äº‹ä»¶ï¼ˆå³æ²¡æœ‰æ‹¦æˆªACTION_DOWNï¼Œæ‹¦æˆªäº†ACTION_MOVEï¼‰ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªè¢«æ‹¦æˆªçš„äº‹ä»¶å°†æˆä¸ºACTION_CANCELä¼ é€’è‡³ViewGroupçš„å­ViewCï¼Œåç»­äº‹ä»¶å°†è¿›å…¥ViewGroupçš„æ²¡æœ‰é‡å†™çš„dispatchTouchEvent()ï¼Œä¸”ViewCä¹Ÿå°†ä¸å†æ¥å—åˆ°åç»­äº‹ä»¶ï¼›</p>
<blockquote>
<p>ViewGroupçˆ¶ç±»dispatchTouchEvent()è¯´æ˜ï¼š</p>
<p>ViewGroupç»§æ‰¿äºViewï¼Œå…¶ä¸ºåŒ…å«å…¶ä»–Viewçš„ç‰¹æ®Šçš„Viewï¼›ViewGroupç»§æ‰¿Viewåé‡å†™äº†çˆ¶ç±»çš„dispatchTouchEvent()æ–¹æ³•</p>
<p>æ­¤å¤„æ‰§è¡ŒViewGroupçˆ¶ç±»dispatchTouchEvent()å³ä¸ºè°ƒç”¨çˆ¶ç±»çš„æ²¡æœ‰è¢«é‡å†™çš„View.dispatchTouchEvent()</p>
</blockquote>
<p>Viewäº‹ä»¶åˆ†å‘</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240831152442110.png" class="" title="image-20240831152442110">
<p><strong>Viewè§¦æ‘¸äº‹ä»¶ä¼˜å…ˆçº§é«˜äºç‚¹å‡»äº‹ä»¶ï¼ï¼</strong></p>
<p><strong>Viewä¸­è‹¥æ§ä»¶å¯ç‚¹å‡»(Clickable)ï¼Œåˆ™View.dispatchTouchEvent(â€¦)â€”&gt;View.onTouchEvent(â€¦)ä¸€å®šè¿”å›trueï¼›è‹¥ä¸å¯ç‚¹å‡»ï¼Œåˆ™ä¸€å®šè¿”å›falseï¼ï¼ï¼</strong></p>
<p>åœ¨ä¸è®¾ç½®è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨çš„æƒ…å†µä¸‹ï¼ŒViewå’ŒViewGroupå‡é»˜è®¤ä½¿ç”¨onTouchEvent()å¤„ç†äº‹ä»¶ï¼›</p>
<p>PS: å¯ä»¥åŒæ—¶è§¦å‘<strong>è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨</strong>å’Œ<strong>ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨</strong></p>
<blockquote>
<p>Touchå¤„ç†æ‰€æœ‰ç‚¹å‡»äº‹ä»¶ï¼Œå³ï¼š</p>
<ul>
<li><strong>MotionEvent.ACTION_DOWN</strong>: æ‰‹æŒ‡åˆæ¬¡æ¥è§¦åˆ°å±å¹•çš„ç¬é—´ã€‚</li>
<li><strong>MotionEvent.ACTION_MOVE</strong>: æ‰‹æŒ‡åœ¨å±å¹•ä¸Šæ»‘åŠ¨æ—¶ï¼Œä¼šæŒç»­è§¦å‘æ­¤äº‹ä»¶ã€‚</li>
<li><strong>MotionEvent.ACTION_UP</strong>: æ‰‹æŒ‡ç¦»å¼€å±å¹•çš„ç¬é—´ã€‚</li>
<li><strong>MotionEvent.ACTION_CANCEL</strong>: è§¦æ‘¸äº‹ä»¶è¢«ç³»ç»Ÿå–æ¶ˆï¼Œä¾‹å¦‚çªç„¶å¼¹å‡ºå¯¹è¯æ¡†ã€‚</li>
<li><strong>MotionEvent.ACTION_POINTER_DOWN</strong>: å¤šç‚¹è§¦æ§æ—¶ï¼Œå¦ä¸€åªæ‰‹æŒ‡è§¦ç¢°å±å¹•ã€‚</li>
<li><strong>MotionEvent.ACTION_POINTER_UP</strong>: å¤šç‚¹è§¦æ§æ—¶ï¼Œå…¶ä¸­ä¸€åªæ‰‹æŒ‡ç¦»å¼€å±å¹•ã€‚</li>
</ul>
<p>Clickå¤„ç†ä¸€ä¸ªå®Œæ•´çš„ç‚¹å‡»æ“ä½œï¼ˆæŒ‰ä¸‹/æŠ¬èµ·ï¼‰ï¼Œå³ï¼š</p>
<ul>
<li>ACTION_DOWN -&gt; ACTION_UP</li>
</ul>
</blockquote>
<h4 id="æ»‘åŠ¨å†²çªä¸è§£å†³">æ»‘åŠ¨å†²çªä¸è§£å†³</h4>
<p>å‡è®¾å­˜åœ¨ä¸€ä¸ªåŒ…å« <code>ScrollView</code> çš„å¸ƒå±€ï¼Œè€Œ <code>ScrollView</code> å†…éƒ¨åµŒå¥—äº†ä¸€ä¸ª <code>RecyclerView</code>ã€‚ä¸¤è€…éƒ½æœ‰æ»‘åŠ¨èƒ½åŠ›ï¼Œ<code>ScrollView</code> ç”¨äºå‚ç›´æ»šåŠ¨ï¼Œ<code>RecyclerView</code> ç”¨äºæ˜¾ç¤ºåˆ—è¡¨é¡¹ï¼Œå¹¶ä¸”æœ¬èº«æ”¯æŒå‚ç›´æ»‘åŠ¨ã€‚è¿™ç§å¸ƒå±€ä¼šå®¹æ˜“å‘ç”Ÿæ»‘åŠ¨å†²çªã€‚</p>
<p><strong>å¤–éƒ¨æ‹¦æˆªæ³•</strong>ï¼šçˆ¶å®¹å™¨å»æ§åˆ¶äº‹ä»¶çš„æ‹¦æˆªï¼Œè‹¥äº‹ä»¶æ˜¯çˆ¶å®¹å™¨éœ€è¦çš„ï¼Œåˆ™è¿›è¡Œæ‹¦æˆªï¼Œä¸éœ€è¦çš„åˆ™å‘ä¸‹ä¼ é€’ã€‚</p>
<p><strong>çˆ¶è§†å›¾å¼ºåˆ¶æ‹¦æˆªäº‹ä»¶</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çˆ¶è§†å›¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyScrollView</span> <span class="keyword">extends</span> <span class="title class_">ScrollView</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> mIsScrolling;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyScrollView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyScrollView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æ»‘åŠ¨äº‹ä»¶ï¼Œè‹¥æ˜¯åˆ™æ‹¦æˆª</span></span><br><span class="line">        <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_MOVE) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå­è§†å›¾æœ‰æ»‘åŠ¨éœ€æ±‚ï¼Œçˆ¶è§†å›¾å°±ä¸å†æ‹¦æˆª</span></span><br><span class="line">            <span class="keyword">if</span> (mIsScrolling) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// ä¸æ‹¦æˆªï¼Œäº¤ç»™å­è§†å›¾</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onInterceptTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_MOVE) &#123;</span><br><span class="line">            mIsScrolling = <span class="literal">true</span>;  <span class="comment">// æ»‘åŠ¨æ—¶ï¼Œè®¾ç½®ä¸ºæ­£åœ¨æ»šåŠ¨</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>çˆ¶è§†å›¾é€šè¿‡æ¨ªå‘ç§»åŠ¨è·ç¦»/çºµå‘ç§»åŠ¨è·ç¦»æ‹¦æˆªäº‹ä»¶</strong></p>
<p>ä½œè€…ï¼šparting_soul<br>
é“¾æ¥ï¼š<a href="https://juejin.cn/post/6844903806308712456">https://juejin.cn/post/6844903806308712456</a><br>
æ¥æºï¼šç¨€åœŸæ˜é‡‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çˆ¶è§†å›¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewPager</span> <span class="keyword">extends</span> <span class="title class_">ViewPager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mLastX;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mLastY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewPager</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewPager</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸€äº›ViewPageræ‹–æ‹½çš„æ ‡å¿—ä½è¦è®¾ç½®ï¼Œå¿…è°ƒsuperï¼Œå¦åˆ™çœ‹ä¸åˆ°æ•ˆæœ</span></span><br><span class="line">        <span class="built_in">super</span>.onInterceptTouchEvent(ev);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isIntercepted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">switch</span> (ev.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="keyword">if</span> (needEvent(ev)) &#123;</span><br><span class="line">                    isIntercepted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">        &#125;</span><br><span class="line">        mLastX = (<span class="type">int</span>) ev.getX();</span><br><span class="line">        mLastY = (<span class="type">int</span>) ev.getY();</span><br><span class="line"></span><br><span class="line">        LogUtils.d(<span class="string">&quot; lastX = &quot;</span> + mLastX + <span class="string">&quot; lastY = &quot;</span> + mLastY);</span><br><span class="line">        <span class="keyword">return</span> isIntercepted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">needEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="comment">//æ°´å¹³æ»šåŠ¨è·ç¦»å¤§äºå‚ç›´æ»šåŠ¨è·ç¦»åˆ™å°†äº‹ä»¶äº¤ç”±ViewPagerå¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> Math.abs(ev.getX() - mLastX) &gt; Math.abs(ev.getY() - mLastY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>å†…éƒ¨æ‹¦æˆªæ³•</strong>ï¼šViewGroupé»˜è®¤æƒ…å†µä¸‹ä¸æ‹¦æˆªäº‹ä»¶ï¼Œç”±å­Viewå»æ§åˆ¶äº‹ä»¶çš„å¤„ç†ï¼Œè‹¥å­Viewéœ€è¦æ­¤äº‹ä»¶ï¼Œåˆ™è‡ªå·±å¤„ç†ï¼Œå¦åˆ™äº¤ç”±çˆ¶å®¹å™¨å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å­è§†å›¾</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ev.getAction()) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            <span class="comment">//ç¦æ­¢çˆ¶å®¹å™¨æ‹¦æˆªäº‹ä»¶</span></span><br><span class="line">            getParent().requestDisallowInterceptTouchEvent(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            <span class="keyword">if</span> (å½“æœŸViewä¸éœ€è¦æ­¤äº‹ä»¶) &#123;</span><br><span class="line">                <span class="comment">// å…è®¸çˆ¶å®¹å™¨æ‹¦æˆªäº‹ä»¶</span></span><br><span class="line">                getParent().requestDisallowInterceptTouchEvent(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çˆ¶è§†å›¾</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ev.getAction()) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="RecyclerViewä¸ListViewç¼“å­˜æœºåˆ¶">RecyclerViewä¸ListViewç¼“å­˜æœºåˆ¶</h3>
<p>ListViewçš„ç¼“å­˜åˆ†ä¸ºä¸¤çº§</p>
<p>ListViewå­˜åœ¨å†…éƒ¨ç±» RecycleBinï¼ŒRecycleBinå­˜åœ¨å¯¹è±¡Active Viewå’ŒScrap View</p>
<ul>
<li>
<p>Active View</p>
</li>
<li>
<p>Scrap view</p>
</li>
</ul>
<p>Active Viewæ˜¯åœ¨å±å¹•å†…çš„ItemViewï¼Œå½“åˆ—è¡¨æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå±å¹•å†…çš„æ•°æ®å¯ä»¥ç›´æ¥æ‹¿æ¥å¤ç”¨ï¼Œæ— é¡»è¿›è¡Œæ•°æ®ç»‘å®šã€‚</p>
<p>Scrap viewæ˜¯åœ¨å±å¹•å¤–çš„ItemViewï¼Œè¿™é‡Œæ‰€æœ‰çš„ç¼“å­˜çš„æ•°æ®éƒ½æ˜¯â€™è„çš„â€™ï¼Œä¹Ÿå°±æ˜¯æ•°æ®éœ€è¦é‡æ–°ç»‘å®šï¼Œä¹Ÿå°±æ˜¯è¯´å±å¹•å¤–çš„æ‰€æœ‰æ•°æ®åœ¨è¿›å…¥å±å¹•çš„æ—¶å€™éœ€è¦æ‰§è¡Œ <code>getView()</code> æ–¹æ³•ã€‚</p>
<p>ListViewç¼“å­˜æœºåˆ¶ï¼š</p>
<p>åœ¨mActiveViewsç¼“å­˜é›†åˆä¸­æŸ¥æ‰¾ï¼ŒæˆåŠŸè¿”å›itemViewï¼Œå¤±è´¥è¿›å…¥ä¸‹ä¸€çº§ç¼“å­˜ï¼›</p>
<p>ä¸‹ä¸€çº§ç¼“å­˜mScrapViewsä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ŒæˆåŠŸè¿”å›itemViewï¼Œå¤±è´¥åˆ›å»ºCreateViewã€‚</p>
<p>RecyclerView çš„ç¼“å­˜åˆ†ä¸ºå››çº§</p>
<ul>
<li>
<p>AttachedScrap</p>
</li>
<li>
<p>CachedViews</p>
</li>
<li>
<p>ViewCacheExtension</p>
</li>
<li>
<p>RecycledViewPool</p>
</li>
</ul>
<p>Scrap å¯¹åº” ListView çš„ Active Viewï¼Œä¸ºå±å¹•å†…ç¼“å­˜æ•°æ®ï¼›</p>
<blockquote>
<p>ChangedScrapå†…ViewHolderåœ¨å¤ç”¨æ—¶ï¼Œéœ€è°ƒç”¨ onBindViewHolder(ViewHolder viewHolder, int position) æ–¹æ³•å°†æ•°æ®ç»‘å®šåœ¨ ViewHolder å¯¹è±¡ä¸­ã€‚</p>
</blockquote>
<p>CachedViews ä¸ºæœ€è¿‘ç§»å‡ºå±å¹•çš„ ViewHolderï¼Œé»˜è®¤å¤§å°æ˜¯2ä¸ªï¼›å½“å…¶å®¹é‡æ»¡æ—¶ä¸”å‡ºç°æ–°çš„æ•°æ®æ·»åŠ æ—¶ï¼Œä¼šæ ¹æ®FIFOåŸåˆ™ï¼ŒåŸ ViewHolder ç§»å‡ºå¹¶æ”¾åˆ°ä¸‹ä¸€çº§ç¼“å­˜ã€‚</p>
<p>CachedViews é‡Œé¢çš„æ•°æ®æ˜¯å¹²å‡€çš„ï¼Œä¹Ÿå°±æ˜¯æºå¸¦äº†åŸæ¥çš„ ViewHolder çš„æ‰€æœ‰æ•°æ®ä¿¡æ¯ï¼Œæ•°æ®å¯ä»¥ç›´æ¥æ¥æ‹¿æ¥å¤ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCachedViews æ˜¯æ ¹æ® position æ¥å¯»æ‰¾æ•°æ®çš„ï¼Œè¿™ä¸ª postion æ˜¯æ ¹æ®ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªå¯è§çš„ item çš„ position ä»¥åŠç”¨æˆ·æ“ä½œè¡Œä¸ºï¼ˆä¸Šæ‹‰è¿˜æ˜¯ä¸‹æ‹‰ï¼‰ã€‚</p>
<blockquote>
<p>ä¾‹ï¼šå½“å‰å±å¹•å†…ç¬¬ä¸€ä¸ªå¯è§çš„ item çš„ position æ˜¯1ï¼Œç”¨æˆ·è¿›è¡Œäº†ä¸€ä¸ªä¸‹æ‹‰æ“ä½œï¼Œé‚£ä¹ˆå½“å‰é¢„æµ‹çš„ position å°±ç›¸å½“äºï¼ˆ1-1=0ï¼‰ï¼Œä¹Ÿå°±æ˜¯ position = 0 çš„é‚£ä¸ª item è¦è¢«æ‹‰å›åˆ°å±å¹•ï¼Œæ­¤æ—¶ RecyclerView å°±ä» Cache é‡Œé¢æ‰¾ position=0 çš„æ•°æ®ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±ç›´æ¥æ‹¿æ¥å¤ç”¨ã€‚</p>
</blockquote>
<p>ViewCacheExtension æ˜¯ google ç•™ç»™å¼€å‘è€…è‡ªå·±æ¥è‡ªå®šä¹‰ç¼“å­˜çš„</p>
<p>RecycledViewPool å¯¹æ¯”äº Cache é»˜è®¤ç¼“å­˜æ•°é‡æ˜¯2ä¸ªï¼Œå½“ Cache ç¼“å­˜æ»¡äº†ä»¥åä¼šæ ¹æ® FIFO æŠŠ Cache ä¸­çš„ ViewHolder ç§»å‡ºå¹¶ç¼“å­˜åˆ° RecycledViewPool ä¸­ï¼ŒRecycledViewPool é»˜è®¤ç¼“å­˜æ•°ä¸º5ã€‚</p>
<p>RecycledViewPool ä¸ Cache ç›¸æ¯”ä¸åŒçš„æ˜¯ï¼Œä» Cache é‡Œé¢ç§»å‡ºçš„ ViewHolder åœ¨å­˜å…¥ RecycledViewPool ä¹‹å‰ï¼Œè¯¥ ViewHolder çš„æ•°æ®ä¼šè¢«å…¨éƒ¨é‡ç½®ï¼Œç›¸å½“äºä¸€ä¸ªæ–°çš„ ViewHolder ï¼›åŒæ—¶ Cache æ˜¯æ ¹æ® position æ¥è·å– ViewHolderï¼Œè€Œ RecycledViewPool æ˜¯æ ¹æ® itemType è·å–çš„ï¼Œå¦‚æœæ²¡æœ‰é‡å†™ <code>getItemType()</code> æ–¹æ³•ï¼ŒitemType å°±æ˜¯é»˜è®¤çš„ã€‚ç”±äº RecycledViewPool ç¼“å­˜çš„ ViewHolder æ˜¯å…¨æ–°çš„ï¼Œæ‰€ä»¥å–å‡ºæ¥çš„æ—¶å€™éœ€è¦æ‰§è¡Œ <code>onBindViewHolder()</code> æ–¹æ³•ã€‚</p>
<p>RecyclerViewçš„å¤ç”¨æ•´ä½“æµç¨‹ï¼š</p>
<p>é¦–å…ˆä¼šå» Scrap è¿™ä¸ªé›†åˆ mAttachedScrap ä¸­æ‰¾æ˜¯å¦æœ‰ ViewHolderï¼Œæœ‰å°±å¤ç”¨ ViewHolderï¼Œæ²¡æœ‰å°±å»ä¸‹ä¸€çº§ç¼“å­˜é›†åˆ mCachedViews ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±ç›´æ¥å¤ç”¨ï¼Œæ²¡æœ‰å°±å»ä¸‹ä¸€çº§ç¼“å­˜è‡ªå®šä¹‰çš„ mViewCacheExtension è¿™ä¸ªç±»ä¸­æŸ¥æ‰¾ï¼Œä½†æ˜¯åŸºæœ¬å¾ˆå°‘ç”¨ï¼Œæ²¡æ‰¾åˆ°å°±å»ä¸‹ä¸€çº§ RecyclerViewPool ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±ç›´æ¥å¤ç”¨ï¼Œæ²¡æ‰¾åˆ°å°±ä¼šè°ƒç”¨æˆ‘ä»¬åœ¨adapterä¸­é‡å†™çš„æ–¹æ³• onCreateViewHolder æ–°å»ºã€‚</p>
<p><strong>æ¯å½“ RecyclerView çš„å­é¡¹å‡ºç°åœ¨å±å¹•ä¸Šæ—¶æˆ–å°†è¦å‡ºç°åœ¨å±å¹•ä¸Šæ—¶ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºè°ƒç”¨å‡½æ•°</strong></p>
<p>1 è°ƒç”¨ getItemCount() æ–¹æ³•è·å–å­é¡¹çš„æ•°é‡ã€‚</p>
<p>2 è°ƒç”¨ onCreateViewHolder(ViewGroup parent, int viewType) æ–¹æ³•åŠ è½½æ¯ä¸€ä¸ªå­é¡¹çš„å¸ƒå±€</p>
<p>3 æ„é€ ä¸€ä¸ª ViewHolder å¯¹è±¡ã€‚</p>
<p>4 è°ƒç”¨ onBindViewHolder(ViewHolder viewHolder, int position) æ–¹æ³•å°†æ•°æ®ç»‘å®šåœ¨ ViewHolder å¯¹è±¡ä¸­ã€‚</p>
<p><strong>æ¯ä¸ªå­é¡¹åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šé‡å¤å¾ªç¯ä¸Šé¢4ä¸ªæ­¥éª¤ï¼Œç›´åˆ°æ‰€æœ‰çš„å­é¡¹åŠ è½½å®Œ</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cc27655e1184f1fa60b1b8ac4ed4a3b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="recyclerView"></p>
<p>é€šè¿‡mAttachedScrapã€mCachedViewsåŠmViewCacheExtensionè·å–çš„ViewHolderä¸éœ€è¦é‡æ–°åˆ›å»ºå¸ƒå±€(<code>onCreateViewHolder()</code>)åŠç»‘å®šæ•°æ®(<code>onBindViewHolder()</code>)ï¼›é€šè¿‡ç¼“å­˜æ± mRecyclerPoolè·å–çš„ViewHolderä¸éœ€è¦é‡æ–°åˆ›å»ºå¸ƒå±€ï¼Œä½†æ˜¯éœ€è¦é‡æ–°ç»‘å®šæ•°æ®ï¼›å¦‚æœä¸Šè¿°ç¼“å­˜ä¸­éƒ½æ²¡æœ‰è·å–åˆ°ç›®æ ‡ViewHolderï¼Œé‚£ä¹ˆå°±ä¼šå›è°ƒAdapter#onCreateViewHolderåˆ›å»ºå¸ƒå±€ï¼Œä»¥åŠå›è°ƒAdapter#onBindViewHolderæ¥ç»‘å®šæ•°æ®ã€‚</p>
<p>ä½œè€…ï¼š<em>å°é©¬å¿«è·‘</em><br>
é“¾æ¥ï¼š<a href="https://juejin.cn/post/7229895703392518205">https://juejin.cn/post/7229895703392518205</a></p>
<h3 id="å±å¹•åˆ·æ–°">å±å¹•åˆ·æ–°</h3>
<p>ç”»é¢æ’•è£‚ï¼šDisplayåœ¨è¯»å–bufferå†…æ•°æ®æ—¶ï¼Œè¢«è¯»å–æ•°æ®è¢«CPU/GPUä¿®æ”¹ï¼Œå¯¼è‡´å½“å‰ç”»é¢å·¦ä¸Šéƒ¨åˆ†å’Œå³ä¸‹éƒ¨åˆ†æ¥è‡ªä¸åŒå¸§</p>
<p>åŒç¼“å†²ï¼ˆæ˜¾ç¤ºå™¨ä½¿ç”¨Frame Bufferï¼ŒCPU/GPUä½¿ç”¨Back Bufferï¼‰</p>
<p>BackBufferçš„æ•°æ®å°±ç»ªåï¼Œå†™æ•°æ®åˆ°FrameBufferï¼Œé˜²æ­¢ç”»é¢æ’•è£‚</p>
<p><a href="https://juejin.cn/post/7163858831309537294">&quot;ä¸€æ–‡è¯»æ‡‚&quot;ç³»åˆ—ï¼šAndroidå±å¹•åˆ·æ–°æœºåˆ¶ä¸ºä»€ä¹ˆè¦å­¦ä¹ å±å¹•åˆ·æ–°çŸ¥è¯†ï¼Ÿ å¾ˆå¤šåŒå­¦è§‰å¾—å±å¹•åˆ·æ–°ç»˜åˆ¶çŸ¥è¯†ç‚¹å¯¹ä»–ä»¬å¼€å‘ä¸é‡è¦ï¼Œ - æ˜é‡‘</a></p>
<p>ä½œè€…ï¼šèƒ¡é£æ´‹é“¾æ¥ï¼š<a href="https://juejin.cn/post/6863756420380196877%E6%9D%A5%E6%BA%90%EF%BC%9A%E7%A8%80%E5%9C%9F%E6%8E%98%E9%87%91%E8%91%97%E4%BD%9C%E6%9D%83%E5%BD%92%E4%BD%9C%E8%80%85%E6%89%80%E6%9C%89%E3%80%82%E5%95%86%E4%B8%9A%E8%BD%AC%E8%BD%BD%E8%AF%B7%E8%81%94%E7%B3%BB%E4%BD%9C%E8%80%85%E8%8E%B7%E5%BE%97%E6%8E%88%E6%9D%83%EF%BC%8C%E9%9D%9E%E5%95%86%E4%B8%9A%E8%BD%AC%E8%BD%BD%E8%AF%B7%E6%B3%A8%E6%98%8E%E5%87%BA%E5%A4%84%E3%80%82">https://juejin.cn/post/6863756420380196877æ¥æºï¼šç¨€åœŸæ˜é‡‘è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</a></p>
<p>VSync(å‚ç›´åŒæ­¥):</p>
<p>å‚ç›´åŒæ­¥åˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚</p>
<p>å½“æ‰«æå®Œä¸€ä¸ªå±å¹•åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚æ­¤ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚</p>
<p>ä»¥æ—¶é—´çš„é¡ºåºæ¥çœ‹ä¸‹å°†ä¼šå‘ç”Ÿçš„è¿‡ç¨‹ï¼š</p>
<ol>
<li>Displayæ˜¾ç¤ºç¬¬0å¸§æ•°æ®ï¼Œæ­¤æ—¶CPUå’ŒGPUæ¸²æŸ“ç¬¬1å¸§ç”»é¢ï¼Œä¸”åœ¨Displayæ˜¾ç¤ºä¸‹ä¸€å¸§å‰å®Œæˆ</li>
<li>å› ä¸ºæ¸²æŸ“åŠæ—¶ï¼ŒDisplayåœ¨ç¬¬0å¸§æ˜¾ç¤ºå®Œæˆåï¼Œä¹Ÿå°±æ˜¯ç¬¬1ä¸ªVSyncåï¼Œç¼“å­˜è¿›è¡Œäº¤æ¢ï¼Œç„¶åæ­£å¸¸æ˜¾ç¤ºç¬¬1å¸§</li>
<li>æ¥ç€ç¬¬2å¸§å¼€å§‹å¤„ç†ï¼Œæ˜¯ç›´åˆ°ç¬¬2ä¸ªVSyncå¿«æ¥å‰æ‰å¼€å§‹å¤„ç†çš„ã€‚</li>
<li>ç¬¬2ä¸ªVSyncæ¥æ—¶ï¼Œç”±äºç¬¬2å¸§æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œç¼“å­˜æ²¡æœ‰äº¤æ¢ï¼Œæ˜¾ç¤ºçš„è¿˜æ˜¯ç¬¬1å¸§ã€‚è¿™ç§æƒ…å†µè¢«Androidå¼€å‘ç»„å‘½åä¸ºâ€œJankâ€ï¼Œå³å‘ç”Ÿäº†<strong>ä¸¢å¸§</strong>ã€‚</li>
<li>å½“ç¬¬2å¸§æ•°æ®å‡†å¤‡å®Œæˆåï¼Œå®ƒå¹¶ä¸ä¼šé©¬ä¸Šè¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯è¦ç­‰å¾…ä¸‹ä¸€ä¸ªVSync è¿›è¡Œç¼“å­˜äº¤æ¢å†æ˜¾ç¤ºã€‚</li>
</ol>
<p>æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å±å¹•å¹³ç™½æ— æ•…åœ°å¤šæ˜¾ç¤ºäº†ä¸€æ¬¡ç¬¬1å¸§ã€‚</p>
<p>åŸå› æ˜¯ ç¬¬2å¸§çš„CPU/GPUè®¡ç®— æ²¡èƒ½åœ¨VSyncä¿¡å·åˆ°æ¥å‰å®Œæˆ ã€‚</p>
<p><strong>ä¸€æ—¦æ”¶åˆ°VSyncé€šçŸ¥ï¼ˆ16msè§¦å‘ä¸€æ¬¡ï¼‰ï¼ŒCPUå’ŒGPU æ‰ç«‹åˆ»å¼€å§‹è®¡ç®—ç„¶åæŠŠæ•°æ®å†™å…¥buffer</strong>ã€‚</p>
<p><strong>VSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚</strong></p>
<p>é—®é¢˜åˆæ¥äº†ï¼Œå¦‚æœç•Œé¢æ¯”è¾ƒå¤æ‚ï¼ŒCPU/GPUçš„å¤„ç†æ—¶é—´è¾ƒé•¿ è¶…è¿‡äº†16.6mså‘¢ï¼Ÿ</p>
<ol>
<li>åœ¨ç¬¬äºŒä¸ªæ—¶é—´æ®µå†…ï¼Œä½†å´å›  GPU è¿˜åœ¨å¤„ç† B å¸§ï¼Œç¼“å­˜æ²¡èƒ½äº¤æ¢ï¼Œå¯¼è‡´ A å¸§è¢«é‡å¤æ˜¾ç¤ºã€‚</li>
<li>è€ŒBå®Œæˆåï¼Œåˆå› ä¸ºç¼ºä¹VSync pulseä¿¡å·ï¼Œå®ƒåªèƒ½ç­‰å¾…ä¸‹ä¸€ä¸ªsignalçš„æ¥ä¸´ã€‚äºæ˜¯åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€å¤§æ®µæ—¶é—´æ˜¯è¢«æµªè´¹çš„ã€‚</li>
<li>å½“ä¸‹ä¸€ä¸ªVSyncå‡ºç°æ—¶ï¼ŒCPU/GPUé©¬ä¸Šæ‰§è¡Œæ“ä½œï¼ˆAå¸§ï¼‰ï¼Œä¸”ç¼“å­˜äº¤æ¢ï¼Œç›¸åº”çš„æ˜¾ç¤ºå±å¯¹åº”çš„å°±æ˜¯Bã€‚è¿™æ—¶çœ‹èµ·æ¥å°±æ˜¯æ­£å¸¸çš„ã€‚åªä¸è¿‡ç”±äºæ‰§è¡Œæ—¶é—´ä»ç„¶è¶…è¿‡16msï¼Œå¯¼è‡´ä¸‹ä¸€æ¬¡åº”è¯¥æ‰§è¡Œçš„ç¼“å†²åŒºäº¤æ¢åˆè¢«æ¨è¿Ÿäº†â€”â€”å¦‚æ­¤å¾ªç¯åå¤ï¼Œä¾¿å‡ºç°äº†è¶Šæ¥è¶Šå¤šçš„â€œJankâ€ã€‚</li>
</ol>
<p><strong>ä¸‰ç¼“å­˜</strong></p>
<p>å°±æ˜¯åœ¨åŒç¼“å†²æœºåˆ¶åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ª Graphic Buffer ç¼“å†²åŒºï¼Œè¿™æ ·å¯ä»¥æœ€å¤§é™åº¦çš„åˆ©ç”¨ç©ºé—²æ—¶é—´ï¼Œå¸¦æ¥çš„åå¤„æ˜¯å¤šä½¿ç”¨çš„ä¸€ä¸ª Graphic Buffer æ‰€å ç”¨çš„å†…å­˜ã€‚</p>
<ol>
<li>ç¬¬ä¸€ä¸ªJankï¼Œæ˜¯ä¸å¯é¿å…çš„ã€‚ä½†æ˜¯åœ¨ç¬¬äºŒä¸ª 16ms æ—¶é—´æ®µï¼ŒCPU/GPU ä½¿ç”¨ <strong>ç¬¬ä¸‰ä¸ª Buffer</strong> å®ŒæˆCå¸§çš„è®¡ç®—ï¼Œè™½ç„¶è¿˜æ˜¯ä¼šå¤šæ˜¾ç¤ºä¸€æ¬¡ A å¸§ï¼Œä½†åç»­æ˜¾ç¤ºå°±æ¯”è¾ƒé¡ºç•…äº†ï¼Œæœ‰æ•ˆé¿å… Jank çš„è¿›ä¸€æ­¥åŠ å‰§ã€‚</li>
<li>æ³¨æ„åœ¨ç¬¬3æ®µä¸­ï¼ŒAå¸§çš„è®¡ç®—å·²å®Œæˆï¼Œä½†æ˜¯åœ¨ç¬¬4ä¸ªvsyncæ¥çš„æ—¶å€™æ‰æ˜¾ç¤ºï¼Œå¦‚æœæ˜¯åŒç¼“å†²ï¼Œé‚£åœ¨ç¬¬ä¸‰ä¸ªvynscå°±å¯ä»¥æ˜¾ç¤ºäº†ã€‚</li>
</ol>
<p><strong>ä¸‰ç¼“å†²æœ‰æ•ˆåˆ©ç”¨äº†ç­‰å¾…vysncçš„æ—¶é—´ï¼Œå‡å°‘äº†jankï¼Œä½†æ˜¯å¸¦æ¥äº†å»¶è¿Ÿã€‚</strong></p>
<p><strong>è°·æ­Œåœ¨4.1ä¹‹åå¯¹å±å¹•ç»˜åˆ¶ä¸åˆ·æ–°è¿‡ç¨‹å¼•å…¥äº†Project Butterï¼ˆé»„æ²¹å·¥ç¨‹ï¼‰ï¼Œç³»ç»Ÿåœ¨æ”¶åˆ°VSyncä¿¡å·ä¹‹åï¼Œé©¬ä¸Šè¿›è¡ŒCPUçš„ç»˜åˆ¶ä»¥åŠGPUçš„bufferå†™å…¥</strong>ã€‚</p>
<h3 id="Viewç»˜åˆ¶æµç¨‹">Viewç»˜åˆ¶æµç¨‹</h3>
<img src="/2024/07/28/Android-Learning-Record/944365-c1adb9dd2d22c056.png" class="" title="image-20240831192540253">
<img src="/2024/07/28/Android-Learning-Record/944365-858de1faa38df1b2.png" class="" title="image-20240831192606617">
<p>Viewç»˜åˆ¶æµç¨‹</p>
<p>åˆ›å»ºActivityè°ƒç”¨onCreateæ–¹æ³•ï¼Œæ–¹æ³•å†…è°ƒç”¨handleResumeActivity(â€¦)</p>
<p>handleResumeActivity(â€¦)è°ƒç”¨performResumeActivity(token, clearHide)ï¼Œè·å¾—ActivityClientRecord r</p>
<p>é€šè¿‡rè·å–DecorViewå’ŒWindowManager</p>
<p>ä½¿ç”¨WindowManageræ‰§è¡Œæ–¹æ³•addView</p>
<p>addViewæ–¹æ³•åˆ›å»ºViewRootImplå®ä¾‹ï¼Œ<em>æŠŠDecorViewåŠ è½½åˆ°Windowä¸­</em></p>
<p>ç»˜åˆ¶ä¼šä»æ ¹è§†å›¾ViewRootçš„performTraversals()æ–¹æ³•å¼€å§‹ï¼Œä»ä¸Šåˆ°ä¸‹éå†æ•´ä¸ªè§†å›¾æ ‘ï¼Œæ¯ä¸ªViewæ§ä»¶è´Ÿè´£ç»˜åˆ¶è‡ªå·±ï¼Œè€ŒViewGroupè¿˜éœ€è¦è´Ÿè´£é€šçŸ¥è‡ªå·±çš„å­Viewè¿›è¡Œç»˜åˆ¶æ“ä½œã€‚</p>
<p>performTraversals {getRootMeasureSpec + performMeasure + performLayout + performDraw}</p>
<p>ç»˜åˆ¶æµç¨‹ä»æ ¹è§†å›¾ <code>ViewRootImpl</code> çš„ <code>performTraversals()</code> æ–¹æ³•å¼€å§‹ï¼ŒæŒ‰ç…§ <strong>Measure â†’ Layout â†’ Draw</strong> çš„é¡ºåºï¼Œè‡ªé¡¶å‘ä¸‹éå†æ•´ä¸ªè§†å›¾æ ‘è¿›è¡Œç»˜åˆ¶ã€‚æ¯ä¸ª <code>View</code> è´Ÿè´£ç»˜åˆ¶è‡ªèº«ï¼Œè€Œ <code>ViewGroup</code> è¿˜éœ€è¦é€šçŸ¥å…¶å­ <code>View</code> è¿›è¡Œæµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶æ“ä½œã€‚</p>
<p><code>performTraversals()</code> æ–¹æ³•ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>è·å–æ ¹è§†å›¾çš„ MeasureSpec</strong>ï¼ˆ<code>getRootMeasureSpec</code>ï¼‰</li>
<li><strong>æ‰§è¡Œæµ‹é‡æµç¨‹</strong>ï¼ˆ<code>performMeasure</code>ï¼‰</li>
<li><strong>æ‰§è¡Œå¸ƒå±€æµç¨‹</strong>ï¼ˆ<code>performLayout</code>ï¼‰</li>
<li><strong>æ‰§è¡Œç»˜åˆ¶æµç¨‹</strong>ï¼ˆ<code>performDraw</code>ï¼‰</li>
</ol>
<p><strong>æµ‹é‡ï¼ˆperformMeasureï¼‰</strong></p>
<p>è§†å›¾çš„æµ‹é‡æµç¨‹æ˜¯ä¸€ä¸ª <strong>é€’å½’</strong> è¿‡ç¨‹ï¼š</p>
<ul>
<li><code>ViewGroup</code> é€’å½’è°ƒç”¨å­ <code>View</code> çš„ <code>measure()</code> æ–¹æ³•ï¼Œå­ <code>View</code> å†æ ¹æ®çˆ¶ <code>View</code> ä¼ é€’çš„ <code>MeasureSpec</code> è®¡ç®—è‡ªèº«çš„å°ºå¯¸ã€‚</li>
<li><code>MeasureSpec</code> è®¡ç®—è§„åˆ™ï¼š
<ul>
<li><strong>å¯¹äº <code>DecorView</code>ï¼ˆæ ¹è§†å›¾ï¼‰</strong>ï¼š<code>MeasureSpec</code> ç”±çª—å£å°ºå¯¸å’Œ <code>LayoutParams</code> å…±åŒå†³å®šã€‚</li>
<li><strong>å¯¹äºæ™®é€š <code>View</code></strong>ï¼š<code>MeasureSpec</code> ç”±çˆ¶è§†å›¾çš„ <code>MeasureSpec</code> å’Œ <code>LayoutParams</code> å…±åŒå†³å®šã€‚</li>
</ul>
</li>
<li><code>MeasureSpec</code> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š
<ul>
<li>æ¨¡å¼ï¼ˆModeï¼‰ï¼š
<ul>
<li><code>EXACTLY</code>ï¼ˆç²¾ç¡®æ¨¡å¼ï¼‰ï¼šView çš„å°ºå¯¸å·²ç»ç¡®å®šï¼Œä½¿ç”¨æŒ‡å®šçš„å€¼ã€‚</li>
<li><code>AT_MOST</code>ï¼ˆæœ€å¤§æ¨¡å¼ï¼‰ï¼šView çš„æœ€å¤§å°ºå¯¸ç”± <code>MeasureSpec</code> é™åˆ¶ï¼Œå®é™…å¤§å°ä¸èƒ½è¶…è¿‡æ­¤å€¼ã€‚</li>
<li><code>UNSPECIFIED</code>ï¼ˆæœªæŒ‡å®šæ¨¡å¼ï¼‰ï¼šView çš„å¤§å°ä¸å—é™åˆ¶ï¼Œé€šå¸¸ç”¨äº <code>ScrollView</code> è¿™ç±»åœºæ™¯ã€‚</li>
</ul>
</li>
<li><strong>å¤§å°ï¼ˆSizeï¼‰</strong>ï¼šå…·ä½“çš„æ•°å€¼ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å¸ƒå±€ï¼ˆperformLayoutï¼‰</strong></p>
<ul>
<li><code>ViewGroup</code> é€’å½’è°ƒç”¨å­ <code>View</code> çš„ <code>layout()</code> æ–¹æ³•ï¼Œå­ <code>View</code> å†æ ¹æ®çˆ¶ <code>View</code> åˆ†é…çš„ä½ç½®å’Œè‡ªèº«çš„æµ‹é‡ç»“æœï¼Œç¡®å®šè‡ªå·±çš„æœ€ç»ˆä½ç½®ã€‚</li>
<li><strong><code>layout(left, top, right, bottom)</code></strong> æ–¹æ³•ç”¨äºç¡®å®š <code>View</code> çš„æ‘†æ”¾ä½ç½®ã€‚</li>
<li><code>ViewGroup</code> éœ€è¦éå†æ‰€æœ‰å­ <code>View</code> å¹¶è°ƒç”¨å®ƒä»¬çš„ <code>layout()</code> æ–¹æ³•ï¼Œä»¥ç¡®ä¿æ¯ä¸ª <code>View</code> åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šã€‚</li>
</ul>
<p><strong>ç»˜åˆ¶ï¼ˆperformDrawï¼‰</strong></p>
<p>ç»˜åˆ¶æµç¨‹åŒæ ·æ˜¯ä¸€ä¸ª <strong>é€’å½’</strong> è¿‡ç¨‹ï¼Œæ¯ä¸ª <code>View</code> è´Ÿè´£ç»˜åˆ¶è‡ªèº«ï¼Œè€Œ <code>ViewGroup</code> è¿˜éœ€è¦é€šçŸ¥å­ <code>View</code> è¿›è¡Œç»˜åˆ¶ã€‚</p>
<p><strong>ç»˜åˆ¶çš„6ä¸ªæ­¥éª¤</strong></p>
<ol>
<li>ç»˜åˆ¶ <code>View</code> çš„èƒŒæ™¯
<ul>
<li>è°ƒç”¨ <code>drawBackground(canvas)</code> æ–¹æ³•ï¼Œå¦‚æœ <code>View</code> è®¾ç½®äº†èƒŒæ™¯ï¼Œåˆ™ä¼šå…ˆç»˜åˆ¶èƒŒæ™¯ã€‚</li>
</ul>
</li>
<li>å¦‚æœéœ€è¦çš„è¯ï¼Œä¿å­˜ <code>Canvas</code> çš„å›¾å±‚ï¼Œä¸º <code>fading</code> åšå‡†å¤‡
<ul>
<li>ä¸»è¦ç”¨äº <code>FadingEdge</code>ï¼ˆæ¸å˜è¾¹ç¼˜æ•ˆæœï¼‰ï¼Œå¦‚æœ <code>View</code> å…·æœ‰ <code>fading edge</code>ï¼Œåˆ™ä¼šä¿å­˜ <code>Canvas</code> ä»¥ä¾¿åç»­æ¢å¤ã€‚</li>
</ul>
</li>
<li>ç»˜åˆ¶ <code>View</code> çš„å†…å®¹
<ul>
<li>è°ƒç”¨ <code>onDraw(canvas)</code>ï¼Œç»˜åˆ¶ <code>View</code> çš„ä¸»ä½“å†…å®¹ï¼ˆå¦‚ <code>TextView</code> ç»˜åˆ¶æ–‡æœ¬ã€<code>ImageView</code> ç»˜åˆ¶å›¾ç‰‡ç­‰ï¼‰ã€‚</li>
</ul>
</li>
<li>ç»˜åˆ¶ <code>View</code> çš„å­ <code>View</code>
<ul>
<li>å¦‚æœå½“å‰ <code>View</code> æ˜¯ <code>ViewGroup</code>ï¼Œä¼šéå†æ‰€æœ‰å­ <code>View</code> å¹¶è°ƒç”¨ <code>drawChild(canvas, child, drawingTime)</code> é€’å½’ç»˜åˆ¶ã€‚</li>
</ul>
</li>
<li>å¦‚æœéœ€è¦çš„è¯ï¼Œç»˜åˆ¶ <code>View</code> çš„ <code>fading</code> è¾¹ç¼˜å¹¶æ¢å¤ <code>Canvas</code>
<ul>
<li>å¤„ç† <code>FadingEdge</code>ï¼Œç»˜åˆ¶ <code>View</code> è¾¹ç¼˜çš„æ¸å˜æ•ˆæœï¼Œå¹¶æ¢å¤ <code>Canvas</code> ä»¥ä¿è¯åç»­ç»˜åˆ¶ä¸å—å½±å“ã€‚</li>
</ul>
</li>
<li>ç»˜åˆ¶ <code>View</code> çš„è£…é¥°ï¼ˆå¦‚æ»šåŠ¨æ¡ç­‰ï¼‰
<ul>
<li>å¦‚æœ <code>View</code> éœ€è¦æ»šåŠ¨æ¡ï¼Œåˆ™ä¼šåœ¨ <code>dispatchDraw()</code> ä¹‹åç»˜åˆ¶æ»šåŠ¨æ¡ã€‚</li>
</ul>
</li>
</ol>
<h3 id="Gradle">Gradle</h3>
<p>æ¯ä¸ª Gradle é¡¹ç›®éƒ½ç”±ä¸€ä¸ªæˆ–å¤šä¸ª Project æ„æˆï¼Œæ¯ä¸ª Project åˆéƒ½ç”± Task æ„æˆã€‚ä¸€ä¸ª <code>build.gradle</code>æ–‡ä»¶ä¾¿æ˜¯å¯¹ä¸€ä¸ª Project å¯¹è±¡çš„é…ç½®ã€‚åœ¨ Android é¡¹ç›®ä¸­ï¼Œæ ¹ç›®å½•ä¼šå­˜åœ¨ä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ï¼Œæ¯ä¸ªæ¨¡å—ä¸‹ä¹Ÿä¼šæœ‰ä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ã€‚</p>
<p><strong>é—­åŒ…</strong></p>
<p><strong>å°è£…ä»£ç å—</strong>: å°±åƒæ™®é€šçš„å‡½æ•°ä¸€æ ·ï¼Œé—­åŒ…å°è£…äº†ä¸€æ®µå¯ä»¥æ‰§è¡Œçš„ä»£ç å—ã€‚</p>
<p><strong>è®¿é—®å¤–éƒ¨ä½œç”¨åŸŸ</strong>: é—­åŒ…æœ€å…³é”®çš„ç‰¹ç‚¹æ˜¯ï¼Œå®ƒå¯ä»¥â€œæ•è·â€å¹¶è®¿é—®å®šä¹‰å®ƒæ‰€åœ¨çš„å¤–éƒ¨ä½œç”¨åŸŸï¼ˆä¹Ÿç§°ä¸ºè¯æ³•ä½œç”¨åŸŸï¼‰ä¸­çš„å˜é‡ï¼Œå³ä½¿åœ¨å®šä¹‰ä½œç”¨åŸŸä¹‹å¤–æ‰§è¡Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p>
<p><strong>ä½œä¸ºå¯¹è±¡ä¼ é€’</strong>: é—­åŒ…å¯ä»¥åƒæ™®é€šå˜é‡ä¸€æ ·è¢«ä¼ é€’ã€å­˜å‚¨å’Œè¿”å›ï¼Œå› ä¸ºå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚è¿™å¯ä»¥é˜²æ­¢å¤–éƒ¨å¯¹è±¡è¢«åƒåœ¾å›æ”¶ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªé—­åŒ…</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeCounter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>; <span class="comment">// å®šä¹‰åœ¨å¤–éƒ¨å‡½æ•°ä½œç”¨åŸŸ</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// è¿”å›ä¸€ä¸ªé—­åŒ…</span></span><br><span class="line">    <span class="keyword">return</span> ++count;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸¤ä¸ªè®¡æ•°å™¨</span></span><br><span class="line"><span class="keyword">let</span> counter1 = <span class="title function_">makeCounter</span>();</span><br><span class="line"><span class="keyword">let</span> counter2 = <span class="title function_">makeCounter</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯ä¸ªè®¡æ•°å™¨éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„ count å˜é‡</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">counter1</span>()); <span class="comment">// è¾“å‡º 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">counter1</span>()); <span class="comment">// è¾“å‡º 2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">counter2</span>()); <span class="comment">// è¾“å‡º 1</span></span><br></pre></td></tr></table></figure>
<p><strong>Gradle Wrapper</strong></p>
<p>Gradle åŒ…è£…å™¨ã€‚ä¸ºäº†åº”å¯¹å›¢é˜Ÿå¼€å‘ä¸­ Gradle ç¯å¢ƒå’Œç‰ˆæœ¬çš„å·®å¼‚ä¼šå¯¹ç¼–è¯‘ç»“æœå¸¦æ¥çš„ä¸ç¡®å®šæ€§ï¼Œä½¿ç”¨ Gradle Wrapperï¼Œå®ƒæ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå¯ä»¥æŒ‡å®šæ„å»ºç‰ˆæœ¬ã€å¿«é€Ÿè¿è¡Œé¡¹ç›®ï¼Œä»è€Œè¾¾åˆ°æ ‡å‡†åŒ–ã€æåˆ°å¼€å‘æ•ˆç‡ã€‚Android Studio æ–°å»ºé¡¹ç›®æ—¶è‡ªå¸¦ Gradle Wrapperï¼Œå› æ­¤ Android å¼€å‘è€…å¾ˆå°‘å•ç‹¬ä¸‹è½½å®‰è£… Gradle</p>
<p><strong>å¸¸è§æ–‡ä»¶</strong></p>
<p><strong><code>build.gradle</code></strong></p>
<ul>
<li>
<p>å®šä¹‰é¡¹ç›®çš„æ„å»ºé…ç½®ï¼ŒåŒ…æ‹¬ä¾èµ–é¡¹ã€æ’ä»¶ã€ä»»åŠ¡ç­‰ã€‚</p>
</li>
<li>
<p><strong>ç±»å‹:</strong></p>
<ul>
<li>
<p><strong>é¡¶å±‚ <code>build.gradle</code> (Project):</strong></p>
<ul>
<li>
<p><strong>ä½œç”¨:</strong> é…ç½®æ•´ä¸ªé¡¹ç›®çš„å…¨å±€è®¾ç½®</p>
</li>
<li>
<p><strong>ä»£ç ç¤ºä¾‹:</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span> <span class="comment">// ç”¨äºå£°æ˜é¡¹ç›®éœ€è¦ä½¿ç”¨çš„Gradleæ’ä»¶ã€‚è¿™äº›æ’ä»¶ç›´æ¥å½±å“é¡¹ç›®çš„æ„å»ºè¿‡ç¨‹å’Œå¯ç”¨ä»»åŠ¡ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildscript &#123;  <span class="comment">// ç”¨äºå£°æ˜æ„å»ºè„šæœ¬è‡ªèº«éœ€è¦çš„ä¾èµ–ã€‚è¿™äº›ä¾èµ–é€šå¸¸æ˜¯Gradleæ’ä»¶ï¼Œå®ƒä»¬åœ¨æ„å»ºè¿‡ç¨‹ä¸­è¢«ä½¿ç”¨ï¼Œä½†ä¸ç›´æ¥æˆä¸ºé¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚</span></span><br><span class="line">    repositories &#123;  </span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">  dependencies &#123;  </span><br><span class="line">        classpath <span class="string">&quot;com.android.tools.build:gradle:7.0.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123; <span class="comment">// é€šå¸¸ç”¨äºå®šä¹‰å…±äº«çš„é…ç½®å’Œä»“åº“, ä¸æ¨èåœ¨è¿™é‡Œå£°æ˜å…·ä½“çš„é¡¹ç›®ä¾èµ–</span></span><br><span class="line">    repositories &#123;  </span><br><span class="line">      google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><strong>æ¨¡å—çº§ <code>build.gradle</code> (Module):</strong></p>
<ul>
<li>
<p><strong>ä½œç”¨:</strong> é…ç½®ç‰¹å®šæ¨¡å—çš„æ„å»ºé€‰é¡¹</p>
</li>
<li>
<p><strong>ä»£ç ç¤ºä¾‹ (Android åº”ç”¨æ¨¡å—):</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">  plugins &#123;</span><br><span class="line">      id <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">      id <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">31</span>  <span class="comment">// æŒ‡å®šç”¨äºç¼–è¯‘åº”ç”¨çš„Android SDKç‰ˆæœ¬</span></span><br><span class="line">      </span><br><span class="line">      defaultConfig &#123;</span><br><span class="line">          applicationId <span class="string">&quot;com.example.myapp&quot;</span></span><br><span class="line">          minSdkVersion <span class="number">21</span>  <span class="comment">// æŒ‡å®šæ‚¨å¸Œæœ›åº”ç”¨æ”¯æŒçš„æœ€ä½ Android ç‰ˆæœ¬ã€‚è®¾ç½® minSdk å¯é™åˆ¶å“ªäº›è®¾å¤‡å¯ä»¥å®‰è£…æ‚¨çš„åº”ç”¨ã€‚</span></span><br><span class="line">          targetSdkVersion <span class="number">31</span>  <span class="comment">// å¦‚æœè®¾å¤‡æ­è½½çš„ Android ç‰ˆæœ¬é«˜äº targetSdkï¼ŒAndroid ä¼šä»¥å…¼å®¹æ¨¡å¼è¿è¡Œæ‚¨çš„åº”ç”¨</span></span><br><span class="line">          versionCode <span class="number">1</span></span><br><span class="line">          versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">          <span class="comment">// å€ŸåŠ© compileSdkï¼Œæ‚¨å¯ä»¥è®¿é—®æ–° API</span></span><br><span class="line">  		<span class="comment">// targetSdk ç”¨äºè®¾ç½®åº”ç”¨çš„è¿è¡Œæ—¶è¡Œä¸º</span></span><br><span class="line">  		<span class="comment">// targetSdkå¿…é¡»å°äºæˆ–ç­‰äº compileSdk</span></span><br><span class="line">          </span><br><span class="line">          testInstrumentationRunner <span class="string">&quot;androidx.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      buildTypes &#123;  <span class="comment">// å®šä¹‰ä¸åŒçš„æ„å»ºç±»å‹ã€‚è¿™é‡Œé…ç½®äº†releaseæ„å»ºç±»å‹,å¯ç”¨äº†ä»£ç æ··æ·†ã€‚</span></span><br><span class="line">          release &#123;</span><br><span class="line">              minifyEnabled <span class="literal">true</span></span><br><span class="line">              proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      compileOptions &#123;  <span class="comment">// è®¾ç½®Javaç¼–è¯‘é€‰é¡¹ã€‚</span></span><br><span class="line">          sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">          targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      kotlinOptions &#123;  <span class="comment">// è®¾ç½®Kotlinç¼–è¯‘é€‰é¡¹ã€‚</span></span><br><span class="line">          jvmTarget = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  dependencies &#123;</span><br><span class="line">      implementation <span class="string">&#x27;androidx.core:core-ktx:1.7.0&#x27;</span></span><br><span class="line">      implementation <span class="string">&#x27;androidx.appcompat:appcompat:1.4.1&#x27;</span></span><br><span class="line">      implementation <span class="string">&#x27;com.google.android.material:material:1.5.0&#x27;</span></span><br><span class="line">      implementation <span class="string">&#x27;androidx.constraintlayout:constraintlayout:2.1.3&#x27;</span></span><br><span class="line">      testImplementation <span class="string">&#x27;junit:junit:4.13.2&#x27;</span></span><br><span class="line">      androidTestImplementation <span class="string">&#x27;androidx.test.ext:junit:1.1.3&#x27;</span></span><br><span class="line">      androidTestImplementation <span class="string">&#x27;androidx.test.espresso:espresso-core:3.4.0&#x27;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Pluginsæ˜¯ç”¨äºGradleçš„ï¼ŒDependenciesæ˜¯ç”¨äºjava/kotliné¡¹ç›®çš„</p>
<p>é€šè¿‡å¼•å…¥ä¸åŒçš„Pluginsï¼Œå¯ä»¥æ„å»ºä¸åŒè¯­è¨€çš„é¡¹ç›®ï¼Œæ¯”å¦‚è¯´javaè¯­è¨€ç¼–å†™çš„androidé¡¹ç›®ï¼Œkotlinè¯­è¨€ç¼–å†™çš„androidé¡¹ç›®ï¼Œæ··åˆJavaå’ŒKotlinçš„Androidé¡¹ç›®ï¼ŒFlutteré¡¹ç›®â€¦</p>
<p>Dependencies ä¸»è¦æ˜¯æŒ‡é¡¹ç›®æ‰€éœ€çš„å¤–éƒ¨åº“æˆ–æ¨¡å—ï¼Œå¦‚Javaåº“ï¼ŒKotlinåº“</p>
</blockquote>
<p><strong><code>gradle.properties</code></strong></p>
<ul>
<li>
<p><strong>ä½œç”¨:</strong> é…ç½®å…¨å±€ Gradle è®¾ç½®ï¼Œå½±å“æ‰€æœ‰ä½¿ç”¨è¯¥ Gradle ç‰ˆæœ¬çš„é¡¹ç›®ã€‚</p>
</li>
<li>
<p><strong>ç¤ºä¾‹:</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">org.gradle.daemon</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">org.gradle.parallel</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">android.useAndroidX</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong><code>gradle-wrapper.properties</code></strong></p>
<ul>
<li>
<p><strong>ä½œç”¨:</strong> é…ç½® Gradle Wrapperï¼Œç¡®ä¿é¡¹ç›®ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬çš„ Gradle è¿›è¡Œæ„å»ºã€‚</p>
</li>
<li>
<p><strong>ç¤ºä¾‹:</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">gradle-wrapperdistributionBase</span>=<span class="string">GRADLE_USER_HOME</span></span><br><span class="line"><span class="attr">distributionPath</span>=<span class="string">wrapper/dists</span></span><br><span class="line"><span class="attr">distributionUrl</span>=<span class="string">https\://services.gradle.org/distributions/gradle-7.4.2-bin.zip</span></span><br><span class="line"><span class="attr">zipStoreBase</span>=<span class="string">GRADLE_USER_HOME</span></span><br><span class="line"><span class="attr">zipStorePath</span>=<span class="string">wrapper/dists</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>gradle-wrapper</p>
<p>gradle-wrapperå°±åƒpythonçš„vir_env/minicondaï¼Œä¸ºæ¯ä¸ªé¡¹ç›®æä¾›äº†ç›¸äº’ç‹¬ç«‹çš„gradleç¯å¢ƒã€‚é€šè¿‡è¯»å–é…ç½®æ–‡ä»¶ä¸­gradleçš„ç‰ˆæœ¬ï¼Œä¸ºæ¯ä¸ªé¡¹ç›®è‡ªåŠ¨çš„ä¸‹è½½å’Œé…ç½®gradle</p>
<ol>
<li>å½“æ‰§è¡Œ gradlew è„šæœ¬æ—¶ï¼Œå®ƒä¼šè¯»å– gradle-wrapper.properties æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯ã€‚</li>
<li>å¦‚æœæœ¬åœ°æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„ Gradle ç‰ˆæœ¬ï¼ŒGradle Wrapper ä¼šè‡ªåŠ¨ä» distributionUrl ä¸‹è½½å¹¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚</li>
<li>ä¸‹è½½å®Œæˆåï¼ŒGradle Wrapper ä¼šä½¿ç”¨æŒ‡å®šçš„ Gradle ç‰ˆæœ¬æ‰§è¡Œæ„å»ºä»»åŠ¡ã€‚</li>
</ol>
</blockquote>
<p><strong><code>settings.gradle</code></strong></p>
<ul>
<li>
<p><strong>ä½œç”¨:</strong> æ­¤è®¾ç½®æ–‡ä»¶ä¼šå®šä¹‰é¡¹ç›®çº§ä»£ç åº“è®¾ç½®ï¼Œå¹¶å‘ŠçŸ¥ Gradle åœ¨æ„å»ºåº”ç”¨æ—¶åº”å°†å“ªäº›æ¨¡å—åŒ…å«åœ¨å†…ã€‚å¤šæ¨¡å—é¡¹ç›®éœ€è¦æŒ‡å®šåº”åŒ…å«åœ¨æœ€ç»ˆ build ä¸­çš„æ¯ä¸ªæ¨¡å—ã€‚</p>
</li>
<li>
<p><strong>ç¤ºä¾‹:</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">pluginManagement &#123;  <span class="comment">// é›†ä¸­ç®¡ç†æ’ä»¶ç‰ˆæœ¬ï¼šé¡¹ç›®ä¸­ä½¿ç”¨çš„æ‰€æœ‰çš„ä½¿ç”¨äº Gradle çš„æ’ä»¶ç‰ˆæœ¬ ä¸ é…ç½®æ’ä»¶è·å–ä»“åº“</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * pluginManagement.repositories ä»£ç å—é…ç½®äº† Gradle ç”¨äº</span></span><br><span class="line"><span class="comment">      * æœç´¢æˆ–ä¸‹è½½ Gradle æ’ä»¶åŠå…¶ä¼ é€’ä¾èµ–é¡¹çš„ä»“åº“ã€‚Gradle é¢„å…ˆé…ç½®äº†å¯¹è¿œç¨‹ä»“åº“çš„æ”¯æŒï¼Œ</span></span><br><span class="line"><span class="comment">      * ä¾‹å¦‚ JCenterã€Maven Central å’Œ Ivyã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨æœ¬åœ°ä»“åº“æˆ–å®šä¹‰è‡ªå·±çš„è¿œç¨‹ä»“åº“ã€‚</span></span><br><span class="line"><span class="comment">      * ä¸‹é¢çš„ä»£ç å°† Gradle æ’ä»¶é—¨æˆ·ã€Google çš„ Maven ä»“åº“å’Œ Maven ä¸­å¤®ä»“åº“å®šä¹‰ä¸º</span></span><br><span class="line"><span class="comment">      * Gradle åº”è¯¥ç”¨æ¥æŸ¥æ‰¾å…¶ä¾èµ–é¡¹çš„ä»“åº“ã€‚</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        gradlePluginPortal()</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencyResolutionManagement &#123;  <span class="comment">// é›†ä¸­ç®¡ç†é¡¹ç›®ä¾èµ–é¡¹ï¼ˆJava åº“ã€Android åº“ç­‰ï¼‰ï¼Œè·å–ä»“åº“ä¸é…ç½®ä¾èµ–è§£æè§„åˆ™</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * æ‚¨å¯ä»¥åœ¨ dependencyResolutionManagement.repositories ä»£ç å—ä¸­é…ç½®</span></span><br><span class="line"><span class="comment">      * é¡¹ç›®ä¸­æ‰€æœ‰æ¨¡å—ä½¿ç”¨çš„ä»“åº“å’Œä¾èµ–é¡¹ï¼Œä¾‹å¦‚æ‚¨ç”¨äºåˆ›å»ºåº”ç”¨ç¨‹åºçš„åº“ã€‚ä½†æ˜¯ï¼Œæ‚¨åº”è¯¥</span></span><br><span class="line"><span class="comment">      * åœ¨æ¯ä¸ªæ¨¡å—çº§åˆ«çš„ build.gradle æ–‡ä»¶ä¸­é…ç½®æ¨¡å—ç‰¹å®šçš„ä¾èµ–é¡¹ã€‚å¯¹äºæ–°é¡¹ç›®ï¼Œ</span></span><br><span class="line"><span class="comment">      * Android Studio é»˜è®¤åŒ…å« Google çš„ Maven ä»“åº“å’Œ Maven ä¸­å¤®ä»“åº“ï¼Œ</span></span><br><span class="line"><span class="comment">      * ä½†å®ƒä¸ä¼šé…ç½®ä»»ä½•ä¾èµ–é¡¹ï¼ˆé™¤éæ‚¨é€‰æ‹©éœ€è¦æŸäº›ä¾èµ–é¡¹çš„æ¨¡æ¿ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)  <span class="comment">// è¿™æ„å‘³ç€ Gradle å°†åªåœ¨ settings.gradle.kts æ–‡ä»¶ä¸­å®šä¹‰çš„ä»“åº“ä¸­æŸ¥æ‰¾ä¾èµ–é¡¹ï¼Œè€Œä¸ä¼šåœ¨é¡¹ç›®æ¨¡å—çš„ build.gradle æ–‡ä»¶ä¸­å®šä¹‰çš„ä»“åº“ä¸­æŸ¥æ‰¾ã€‚</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;&#125;  <span class="comment">// å£°æ˜ä¾èµ–ç‰ˆæœ¬ï¼Œä½†ä¸ä¼šå°†ä¾èµ–æ·»åŠ åˆ°ä»»ä½•æ¨¡å—ï¼Œä»…ç”¨äºç‰ˆæœ¬çº¦æŸã€‚</span></span><br><span class="line">    resolutionStrategy &#123;</span><br><span class="line">        <span class="comment">// å¼ºåˆ¶ä½¿ç”¨ 2.0.0 ç‰ˆæœ¬çš„ Gson åº“</span></span><br><span class="line">        force(<span class="string">&quot;com.google.code.gson:gson:2.0.0&quot;</span>) </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">rootProject.name = <span class="string">&quot;My Application&quot;</span>  <span class="comment">// è®¾ç½®é¡¹ç›®çš„æ ¹æ¨¡å—åç§°ä¸º &quot;My Application&quot;ã€‚</span></span><br><span class="line">include <span class="string">&#x27;:app&#x27;</span>  <span class="comment">// è¿™æ„å‘³ç€é¡¹ç›®ä¸­å­˜åœ¨ä¸€ä¸ªåä¸º &quot;app&quot; çš„å­ç›®å½•ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¨¡å—çº§åˆ«çš„ build.gradle æ–‡ä»¶ï¼Œç”¨äºé…ç½®è¯¥æ¨¡å—çš„æ„å»ºè®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><code>build.gradle</code> allprojects {} ä¸­çš„ <code>settings.gradle</code> dependencies {} çš„åŒºåˆ«</p>
<ul>
<li>dependencyResolutionManagement {} ä¸­çš„ dependencies {} ä»…å£°æ˜ä¾èµ–ç‰ˆæœ¬ï¼Œä¸æ·»åŠ ä¾èµ–ã€‚</li>
<li>allprojects {} ä¸­çš„ dependencies {} ä¼šå°†ä¾èµ–æ·»åŠ åˆ°æ‰€æœ‰æ¨¡å—ã€‚</li>
</ul>
</blockquote>
<p><strong><code>local.properties</code></strong></p>
<ul>
<li>
<p><strong>ä½œç”¨:</strong> ä¸ºæ„å»ºç³»ç»Ÿé…ç½®æœ¬åœ°ç¯å¢ƒå±æ€§ï¼Œä¾‹å¦‚ SDK å’Œ NDK è·¯å¾„ã€‚ç”±Android Studioè‡ªåŠ¨ç”Ÿæˆ</p>
</li>
<li>
<p><strong>ç¤ºä¾‹:</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## This file is automatically generated by Android Studio.</span></span><br><span class="line"><span class="comment"># Do not modify this file -- YOUR CHANGES WILL BE ERASED!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Local properties for the project.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sdk.dir</span>=<span class="string">/Users/username/Library/Android/Sdk</span></span><br><span class="line"><span class="attr">ndk.dir</span>=<span class="string">/Users/username/Library/Android/Sdk/ndk</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong><code>multiDexKeep.pro</code>&amp;<code>proguard-rules.pro</code></strong>: å¯é€‰çš„æ··æ·†æ–‡ä»¶ï¼Œç”¨äºé…ç½®æ”¾ç½®åœ¨ä¸» Dex çš„ç±»ã€å£°æ˜é¿å…æ··æ·†çš„ç±»</p>
<p><strong>å¸¸è§å—</strong></p>
<p><strong><code>buildscript</code> å—</strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: é…ç½® Gradle æ„å»ºç³»ç»Ÿæœ¬èº«æ‰€éœ€çš„ä¾èµ–å’Œä»“åº“ã€‚</li>
<li><strong>å‡ºç°ä½ç½®</strong>: é¡¶å±‚ <code>build.gradle</code> æ–‡ä»¶ã€‚</li>
</ul>
<p><strong>ä»£ç æ¡ˆä¾‹:</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google() <span class="comment">// Google Maven ä»“åº“</span></span><br><span class="line">        mavenCentral() <span class="comment">// Maven ä¸­å¤®ä»“åº“</span></span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&quot;com.android.tools.build:gradle:7.2.1&quot;</span> <span class="comment">// Android Gradle æ’ä»¶</span></span><br><span class="line">        classpath <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.10&quot;</span> <span class="comment">// Kotlin Gradle æ’ä»¶ (å¦‚æœä½¿ç”¨ Kotlin)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>allprojects</code> å—</strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: é…ç½®æ‰€æœ‰å­é¡¹ç›®/æ¨¡å—é€šç”¨çš„é€‰é¡¹ï¼Œä¾‹å¦‚ä»“åº“ã€æ’ä»¶ç‰ˆæœ¬ç­‰ã€‚</li>
<li><strong>å‡ºç°ä½ç½®</strong>: é¡¶å±‚ <code>build.gradle</code> æ–‡ä»¶ã€‚</li>
</ul>
<p><strong>ä»£ç æ¡ˆä¾‹:</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        <span class="comment">// æ·»åŠ å…¶ä»–éœ€è¦çš„ä»“åº“</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>plugins</code> å—</strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: å£°æ˜å’Œåº”ç”¨æ’ä»¶ï¼Œç”¨äºæ‰©å±• Gradle çš„åŠŸèƒ½ã€‚</li>
<li><strong>å‡ºç°ä½ç½®</strong>: é¡¶å±‚æˆ–æ¨¡å—çº§ <code>build.gradle</code> æ–‡ä»¶ã€‚</li>
</ul>
<p><strong>ä»£ç æ¡ˆä¾‹:</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;com.android.application&#x27;</span> version <span class="string">&#x27;7.2.1&#x27;</span> apply <span class="literal">false</span> <span class="comment">// åº”ç”¨ Android Application æ’ä»¶ (ä»…åœ¨æ¨¡å—çº§åº”ç”¨)</span></span><br><span class="line">    id <span class="string">&#x27;org.jetbrains.kotlin.android&#x27;</span> version <span class="string">&#x27;1.7.10&#x27;</span> apply <span class="literal">false</span> <span class="comment">// åº”ç”¨ Kotlin Android æ’ä»¶ (ä»…åœ¨æ¨¡å—çº§åº”ç”¨)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>android</code> å—</strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: é…ç½® Android é¡¹ç›®ç›¸å…³çš„æ„å»ºé€‰é¡¹ã€‚</li>
<li><strong>å‡ºç°ä½ç½®</strong>: æ¨¡å—çº§ <code>build.gradle</code> æ–‡ä»¶ã€‚</li>
</ul>
<p><strong>ä»£ç æ¡ˆä¾‹:</strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">33</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.example.myapp&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">21</span></span><br><span class="line">        targetSdkVersion <span class="number">33</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dependencies</code> å—: å£°æ˜é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚</p>
<p><code>repositories</code>: å®šä¹‰ Gradle æŸ¥æ‰¾ä¾èµ–é¡¹çš„ä»“åº“åœ°å€ã€‚</p>
<p><code>task</code>: å®šä¹‰ Gradle ä»»åŠ¡ï¼Œç”¨äºæ‰§è¡Œç‰¹å®šçš„æ„å»ºæ“ä½œã€‚</p>
<p><code>ext</code>: å®šä¹‰é¢å¤–çš„å±æ€§ï¼Œå¯ä»¥åœ¨æ„å»ºè„šæœ¬ä¸­ä½¿ç”¨ã€‚</p>
<h3 id="Androidå¯åŠ¨">Androidå¯åŠ¨</h3>
<p>Androidç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå¯åŠ¨linuxå†…æ ¸ï¼Œç„¶ååŠ è½½init.rcæ–‡ä»¶ï¼Œå¯åŠ¨initè¿›ç¨‹ã€‚ç„¶åï¼Œinitè¿›ç¨‹é€šè¿‡è§£æinit.rcæ–‡ä»¶forkç”ŸæˆZygoteè¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹ä¹Ÿæ˜¯Androidç³»ç»Ÿçš„é¦–ä¸ªJavaè¿›ç¨‹ã€‚ä¹‹åZygoteè¿›ç¨‹è´Ÿè´£å­µåŒ–System Serverè¿›ç¨‹å’ŒAPPè¿›ç¨‹ã€‚</p>
<p><img src="Android-learning-record/image-20240714103234291.png" alt="image-20240714103234291"></p>
<h4 id="Initè¿›ç¨‹">Initè¿›ç¨‹</h4>
<p>è®¾ç½®å­è¿›ç¨‹é€€å‡ºä¿¡å·å¤„ç†å‡½æ•°</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240731155705321.png" class="" title="image-20240731155705321">
<blockquote>
<p>æœ¬è¿›ç¨‹åœ¨æ¥å—åˆ°å­è¿›ç¨‹é€€å‡ºä¿¡å·åï¼Œè°ƒç”¨sigchld_handlerå‡½æ•°</p>
</blockquote>
<p>åˆ›å»ºæ–‡ä»¶å¤¹ä¸æŒ‚è½½è®¾å¤‡</p>
<p>å°†æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯é‡å®šå‘åˆ° <code>/dev/null</code> å’Œ å°†<code>init</code> è¿›ç¨‹çš„æ—¥å¿—è¾“å‡ºè®¾ç½®ä¸º <code>/dev/__kmsg__</code></p>
<img src="/2024/07/28/Android-Learning-Record/image-20240731160912852.png" class="" title="image-20240731160912852">
<blockquote>
<p>é‡å®šå‘æ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯çš„æ–¹å¼æ˜¯é€šè¿‡ä¿®æ”¹è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨</p>
<p>int dup2(int oldfd, int newfd)ï¼šé€šè¿‡å°†æ—§æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶åˆ°æ–°æ–‡ä»¶æè¿°ç¬¦ä½ç½®ï¼ˆå³å°†oldfdå†…å®¹å†™å…¥newfdåœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æ‰€åœ¨çš„ä½ç½®ï¼‰ï¼Œè‹¥æ–°æ–‡ä»¶æè¿°ç¬¦å·²æ‰“å¼€ï¼Œåˆ™å°†å…¶å…³é—­å¹¶å¤åˆ¶ï¼Œä½¿å¾—åç»­è®¿é—®æ–‡ä»¶æè¿°ç¬¦è¡¨å¯¹åº”ä½ç½®çš„æ—¶å€™è¢«é‡å®šå‘åˆ°ä¿®æ”¹åä½ç½®</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/dev/null&quot;</span>, O_RDWR); <span class="comment">// è¯»å†™æ–¹å¼æ‰“å¼€ /dev/null</span></span><br><span class="line"><span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    dup2(fd, <span class="number">0</span>); <span class="comment">// é‡å®šå‘æ ‡å‡†è¾“å…¥åˆ° /dev/null</span></span><br><span class="line">    dup2(fd, <span class="number">1</span>); <span class="comment">// é‡å®šå‘æ ‡å‡†è¾“å‡ºåˆ° /dev/null</span></span><br><span class="line">    dup2(fd, <span class="number">2</span>); <span class="comment">// é‡å®šå‘æ ‡å‡†é”™è¯¯åˆ° /dev/null</span></span><br><span class="line">    <span class="keyword">if</span> (fd &gt; <span class="number">2</span>) &#123;</span><br><span class="line">        close(fd); <span class="comment">// å…³é—­å¤šä½™çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>è§£æ<code>init.rc</code>æ–‡ä»¶</p>
<p>è·å–ç¡¬ä»¶åå¹¶æ ¹æ®ç¡¬ä»¶åè§£æ<code>init.&lt;ç¡¬ä»¶å&gt;.rc</code>æ–‡ä»¶</p>
<p>ä»æ–‡ä»¶ä¸­è·å¾—<code>early-init</code>é˜¶æ®µéœ€è¦æ‰§è¡Œçš„åŠ¨ä½œï¼Œå°†åŠ¨ä½œæ·»åŠ åˆ°ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—çš„å°¾éƒ¨å¹¶æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰åŠ¨ä½œ</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240731162932328.png" class="" title="image-20240731162932328">
<blockquote>
<p>åŠ¨ä½œä¸€èˆ¬æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œæ‰§è¡ŒåŠ¨ä½œæ—¶é€šè¿‡å‡½æ•°æŒ‡é’ˆæ‰§è¡Œå‡½æ•°</p>
</blockquote>
<p>è·å¾— <code>device</code>, <code>property</code>, <code>keychord</code>çš„æ–‡ä»¶æè¿°ç¬¦</p>
<p>åŠ è½½æ–‡ä»¶ä½œä¸ºç³»ç»Ÿçš„å¼€æœºç”»é¢</p>
<p>åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦åœ¨QEMUè™šæ‹Ÿæœºè¿è¡Œï¼Œæ‰§è¡Œï¼Ÿæ“ä½œ</p>
<p>è®¾ç½®ç³»ç»Ÿå±æ€§</p>
<p>æ‰§è¡Œä½äº<code>init</code>é˜¶æ®µçš„åŠ¨ä½œ</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240801102057483.png" class="" title="image-20240801102057483">
<p>å¯åŠ¨å±æ€§æœåŠ¡</p>
<p>åˆ›å»ºsocket</p>
<p>æ‰§è¡Œ <code>early-boot</code> å’Œ <code>boot</code> é˜¶æ®µåŠ¨ä½œ</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240801102304897.png" class="" title="image-20240801102304897">
<p>åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦æ•°ç»„ï¼Œå°†<code>device</code>, <code>property</code>, <code>signal_recv</code>,<code>keychord</code>çš„æ–‡ä»¶æè¿°ç¬¦å†™å…¥ï¼Œæ·»åŠ æœŸæœ›åŠ¨ä½œã€‚</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240801102823567.png" class="" title="image-20240801102823567">
<img src="/2024/07/28/Android-Learning-Record/image-20240801102846996.png" class="" title="image-20240801102846996">
<p>å¾ªç¯ï¼Œæ¸…ç©ºæ¥æ”¶åŠ¨ä½œï¼›å¼€å§‹ç›‘è§†æ–‡ä»¶æè¿°ç¬¦ä¼ å…¥ä¿¡æ¯ï¼Œå¹¶æ ¹æ®ä¼ å…¥ä¿¡æ¯æ‰§è¡Œå¯¹åº”åŠ¨ä½œ</p>
<img src="/2024/07/28/Android-Learning-Record/image-20240801103107985.png" class="" title="image-20240801103107985">
<blockquote>
<p>poll() å‡½æ•°ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦(å®é™…ä¸Šç›‘è§†çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶è¡¨é¡¹çš„<code>f_flags</code>å±æ€§)ï¼Œç­‰å¾…å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªå˜ä¸ºå¯è¯»ã€å¯å†™æˆ–å‘ç”Ÿé”™è¯¯ã€‚åœ¨å…¶å˜åŒ–æ—¶ï¼Œreventå°†è®°å½•è¯¥å˜åŒ–ã€‚</p>
</blockquote>
<h4 id="Zygoteè¿›ç¨‹">Zygoteè¿›ç¨‹</h4>
<p><strong>App_main.cpp</strong></p>
<p>å¯¹ä¼ å…¥å‚æ•°è¿›è¡Œç»Ÿè®¡ä¸è®¾ç½®</p>
<p>åˆ›å»º<code>AppRuntime</code>ï¼Œå¹¶è®¾ç½®æˆå‘˜å€¼</p>
<p>åˆ¤æ–­æ¡ä»¶ï¼Œä¿®æ”¹è¿›ç¨‹åä¸æ‰§è¡Œ<code>runtime.start(...)</code></p>
<p><strong>AndroidRuntime.cpp</strong></p>
<p><code>runtime.start(...)</code></p>
<ul>
<li>åˆ›å»ºè™šæ‹Ÿæœº<code>AndroidRuntime:startVm(...)</code></li>
<li>æ³¨å†ŒJNIå‡½æ•°<code>AndroidRuntime:startReg(...)</code></li>
<li>ä½¿ç”¨æ³¨å†ŒJNIå‡½æ•°çš„<code>JNIEnv</code>è°ƒç”¨Javaå‡½æ•°ï¼Œè¿›å…¥Java</li>
</ul>
<p><code>AndroidRuntime:startVm(...)</code></p>
<ul>
<li>è®¾ç½®è™šæ‹Ÿæœºå‚æ•°</li>
<li>è°ƒç”¨<code>JNI_CreateJavaVM(...)</code>åˆ›å»ºè™šæ‹Ÿæœºå¹¶å¾—åˆ°å½“å‰çº¿ç¨‹çš„<code>JNIEnv</code></li>
</ul>
<p><code>AndroidRuntime:startReg(...)</code></p>
<ul>
<li>è°ƒç”¨<code>register_jni_procs(...)</code>æ³¨å†ŒJNIå‡½æ•°</li>
</ul>
<img src="/2024/07/28/Android-Learning-Record/image-20240805152408375.png" class="" title="image-20240805152408375">
<img src="/2024/07/28/Android-Learning-Record/image-20240805152418585.png" class="" title="image-20240805152418585">
<blockquote>
<p>æ³¨å†ŒJNIå‡½æ•°å³å°†è¯¥å‡½æ•°æŒ‡é’ˆå†™å…¥æŒ‡å®šjavaç±»çš„æ–¹æ³•è¡¨(Method Table)ä¸­ï¼Œåœ¨javaç±»ä½¿ç”¨è¯¥æ–¹æ³•æ—¶ï¼Œå¯ä»¥ç›´æ¥æŸ¥æ–¹æ³•è¡¨å¾—åˆ°è¯¥å‡½æ•°çš„åœ°å€å¹¶è®¿é—®/ä½¿ç”¨</p>
</blockquote>
<p><strong>ZygoteInit.java</strong></p>
<p>è°ƒç”¨<code>registerZygoteSocket()</code>æ³¨å†Œzygoteçš„socket</p>
<p>è°ƒç”¨<code>preloadClasses()</code>&amp;<code>preloadResource()</code>é¢„åŠ è½½ç±»å’Œèµ„æº</p>
<p>è°ƒç”¨<code>startSystemServer()</code>å¯åŠ¨system_serverè¿›ç¨‹</p>
<p>è°ƒç”¨<code>runSelectLoopMode()</code>å‡½æ•°</p>
<p>è°ƒç”¨<code>caller.run()</code>å‡½æ•°</p>
<p><code>registerZygoteSocket()</code></p>
<ul>
<li>åˆ›å»ºæœåŠ¡ç«¯Socket</li>
</ul>
<p><code>preloadClasses()</code>&amp;<code>preloadResource()</code></p>
<ul>
<li>åŠ è½½èµ„æº</li>
</ul>
<p><code>startSystemServer()</code></p>
<ul>
<li>forkå­è¿›ç¨‹ï¼Œåˆ›å»ºsystem_serverè¿›ç¨‹</li>
</ul>
<p><code>runSelectLoopMode()</code></p>
<ul>
<li>å¤„ç†å®¢æˆ·è¿æ¥å’Œå®¢æˆ·è¯·æ±‚</li>
</ul>
<img src="/2024/07/28/Android-Learning-Record/image-20240805193239427.png" class="" title="image-20240805193239427">
<p>-&gt; <code>runOnce()</code></p>
<img src="/2024/07/28/Android-Learning-Record/image-20240805193517661.png" class="" title="image-20240805193517661">
<img src="/2024/07/28/Android-Learning-Record/image-20240805193529451.png" class="" title="image-20240805193529451">
<h4 id="SystemServerè¿›ç¨‹">SystemServerè¿›ç¨‹</h4>
<ul>
<li>ç”±Zygoteè¿›ç¨‹forkç”Ÿæˆï¼ŒSystemServeræ˜¯Zygoteå­µåŒ–çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>è´Ÿè´£å¯åŠ¨ã€ç®¡ç†æ•´ä¸ªJava Frameworkï¼Œç³»ç»Ÿé‡Œé¢é‡è¦çš„æœåŠ¡éƒ½æ˜¯åœ¨è¿™ä¸ªè¿›ç¨‹é‡Œé¢å¼€å¯çš„ï¼Œæ¯”å¦‚ActivityManagerServiceã€WindowManagerServiceã€‚</li>
</ul>
<p><strong>ActivityManagerService.java</strong></p>
<p>å‡½æ•°<code>startProcessLocked(...)</code>ä¸­è°ƒç”¨<code>Process.start()</code>å¯åŠ¨Process</p>
<p><strong>Process.java</strong></p>
<p><code>Process.start()</code></p>
<ul>
<li>è°ƒç”¨<code>startViaZygote(...)</code></li>
</ul>
<p><code>startViaZygote(...)</code></p>
<ul>
<li>å‚æ•°å¤„ç†</li>
<li>è°ƒç”¨<code>zygoteSendArgsAndGetPid(å‚æ•°)</code></li>
</ul>
<p><code>zygoteSendArgsAndGetPid(...)</code></p>
<ul>
<li>åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸zygoteé€šä¿¡çš„Socketï¼Œå¹¶åˆ›å»ºè¿æ¥</li>
<li>å‘é€è¯·æ±‚å‚æ•°åˆ°Zygoteå¹¶è·å–è¿”å›ç»“æœpid</li>
</ul>
<h4 id="APPè¿›ç¨‹">APPè¿›ç¨‹</h4>
<ul>
<li>Zygoteè¿›ç¨‹åœ¨Appå±‚ä¸­å­µåŒ–å‡ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯Launcherè¿›ç¨‹ï¼Œå³æ‰‹æœºçš„æ¡Œé¢APPã€‚</li>
<li>Zygoteè¿˜ä¼šå­µåŒ–å‡ºBrowserã€Emailã€Phoneç­‰APPè¿›ç¨‹ï¼Œæ¯ä¸ªAPPè‡³å°‘è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸Šã€‚</li>
<li>æ‰€æœ‰APPè¿›ç¨‹éƒ½ç”±Zygoteè¿›ç¨‹forkç”Ÿæˆã€‚</li>
</ul>
<img src="/2024/07/28/Android-Learning-Record/image-20240805193338222.png" class="" title="image-20240805193338222">
<p>ä¸Šæ¥<code>runOnce()</code></p>
<img src="/2024/07/28/Android-Learning-Record/image-20240805193638556.png" class="" title="image-20240805193638556">
<h3 id="å¸¸ç”¨æ¡†æ¶">å¸¸ç”¨æ¡†æ¶</h3>
<h4 id="Glide">Glide</h4>
<h4 id="okHttp">okHttp</h4>
<p>å¾…å®Œæˆ</p>
<h4 id="Retrofit">Retrofit</h4>
<p>å¾…å®Œæˆ</p>
<h4 id="RxJava">RxJava</h4>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android, Java</tag>
      </tags>
  </entry>
  <entry>
    <title>MQ-Learning-Record</title>
    <url>/2025/01/17/MQ-Learning-Record/</url>
    <content><![CDATA[<p>MQç›¸å…³å­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>Message Queue</h1>
<h2 id="åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</h2>
<p><strong>ä½¿ç”¨MQåŸå› </strong></p>
<p>è§£è€¦ï¼šå°†åç»­å·¥ä½œä¸å‰åºå·¥ä½œè§£è€¦</p>
<p>å‰Šå³°ï¼šä½¿å¤§é‡æ¶Œå…¥çš„äº‹ä»¶å¾—åˆ°ç¨³å®šçš„å¤„ç†</p>
<p>å¼‚æ­¥ï¼šå°†éœ€è¦å®Œæˆçš„å·¥ä½œå‹å…¥æ¶ˆæ¯é˜Ÿåˆ—</p>
<p><strong>æ¶ˆæ¯é˜Ÿåˆ—å·®å¼‚</strong></p>
<p>Rabbit MQ*</p>
<ul>
<li>
<p>Producers å°†æ¶ˆæ¯å‘é€ç»™ Exchangesï¼ŒExchanges æ ¹æ®è·¯ç”±è§„åˆ™ï¼ˆå¦‚ directã€fanoutã€topic ç­‰ï¼‰å°†æ¶ˆæ¯åˆ†å‘åˆ° Queuesï¼ŒConsumers ä» Queues ä¸­æ¶ˆè´¹æ¶ˆæ¯ã€‚é€šè¿‡ç»‘å®šé”®å¯ä»¥çµæ´»å®ç°æ¶ˆæ¯è·¯ç”±ã€‚</p>
</li>
<li>
<p>è½»é‡ï¼Œå¼€ç®±å³ç”¨</p>
</li>
<li>
<p>æ¶ˆæ¯å †ç§¯æ”¯æŒå·®ï¼Œå¹¶å‘ä½ï¼Œéš¾ä»¥äºŒæ¬¡å¼€å‘</p>
</li>
</ul>
<p>Kafka-zooKeeper</p>
<ul>
<li>åˆ†å¸ƒå¼ï¼ŒProducers å°†æ¶ˆæ¯å‘é€åˆ° Primary Brokerï¼ŒBroker åŸºäºåˆ†åŒºå°†æ¶ˆæ¯å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼›åŒæ—¶ï¼Œé€šè¿‡ Replicas (Brokers) å®ç°æ¶ˆæ¯å¤‡ä»½ï¼ŒConsumers ä» Brokers ä¸­æŒ‡å®šçš„åˆ†åŒºæ¶ˆè´¹æ¶ˆæ¯ã€‚ZooKeeper è´Ÿè´£é›†ç¾¤ç®¡ç†ï¼Œå¦‚ Broker çš„å…ƒæ•°æ®å’Œ Leader é€‰ä¸¾ã€‚</li>
<li>æ€§èƒ½å¥½ï¼Œå¹¶å‘é«˜</li>
<li>å»¶è¿Ÿé«˜ï¼Œtopicå¤šå¯¼è‡´æ€§èƒ½ä¸å¥½</li>
</ul>
<p>Rocket MQ</p>
<ul>
<li>åˆ†å¸ƒå¼ï¼ŒProducers ä» Name Server å‘ç° Brokerï¼ˆç±»ä¼¼äºåŸŸåæŸ¥æ‰¾ï¼‰ï¼Œç„¶åå°†å°†æ¶ˆæ¯å‘é€è‡³è·å–åˆ°çš„ Broker é›†ç¾¤ï¼ŒBroker é€šè¿‡ä¸»ä»å¤åˆ¶æœºåˆ¶ï¼ˆMaster-Slaveï¼‰è¿›è¡Œæ•°æ®å¤‡ä»½ï¼ŒConsumers æ ¹æ®è®¢é˜…æ¨¡å‹æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ”¯æŒç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰å’Œå‘å¸ƒ-è®¢é˜…ï¼ˆPub/Subï¼‰ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ã€‚</li>
</ul>
<h3 id="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</h3>
<p><strong>å®šä¹‰</strong></p>
<p>æ­»ä¿¡é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ï¼ˆå³â€œæ­»ä¿¡â€æ¶ˆæ¯ï¼‰ã€‚æ¶ˆæ¯æˆä¸ºæ­»ä¿¡çš„åŸå› é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>
<ol>
<li><strong>æ¶ˆæ¯è¢«æ‹’ç»</strong>ï¼šæ¶ˆè´¹è€…ä½¿ç”¨ <code>basicNack</code> æˆ– <code>basicReject</code> ä¸” <code>requeue</code> å‚æ•°è®¾ç½®ä¸º <code>false</code>ã€‚</li>
<li><strong>æ¶ˆæ¯è¿‡æœŸ</strong>ï¼šæ¶ˆæ¯è®¾ç½®äº† <code>TTL</code>ï¼ˆTime-To-Liveï¼‰å±æ€§å¹¶è¶…è¿‡äº†æœ‰æ•ˆæœŸã€‚</li>
<li><strong>é˜Ÿåˆ—é•¿åº¦é™åˆ¶</strong>ï¼šé˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦åï¼Œæ–°çš„æ¶ˆæ¯æ— æ³•è¿›å…¥é˜Ÿåˆ—è€Œè¢«è½¬ä¸ºæ­»ä¿¡ã€‚</li>
</ol>
<p><strong>å¤„ç†æ–¹å¼</strong></p>
<ol>
<li>é…ç½®ä¸€ä¸ªæ™®é€šé˜Ÿåˆ—ï¼ˆä¸»é˜Ÿåˆ—ï¼‰ï¼Œå¹¶ç»‘å®šä¸€ä¸ªæ­»ä¿¡äº¤æ¢å™¨ï¼ˆDLXï¼ŒDead Letter Exchangeï¼‰ã€‚</li>
<li>å½“ä¸»é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å› ä¸Šè¿°åŸå› æˆä¸ºæ­»ä¿¡æ—¶ï¼Œä¼šè‡ªåŠ¨è·¯ç”±åˆ°æ­»ä¿¡äº¤æ¢å™¨ï¼Œå†ç”±æ­»ä¿¡äº¤æ¢å™¨è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ã€‚</li>
</ol>
<h3 id="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—</h3>
<p><strong>å®šä¹‰</strong></p>
<p>å»¶è¿Ÿé˜Ÿåˆ—æ˜¯ä¸€ç§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶ä¸­çš„æ¶ˆæ¯ä¼šåœ¨æŒ‡å®šçš„æ—¶é—´åè¢«æ¶ˆè´¹ã€‚å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°é€šå¸¸ä¾èµ–äºæ¶ˆæ¯çš„ <code>TTL</code>ï¼ˆTime-To-Liveï¼‰å±æ€§å’Œæ­»ä¿¡æœºåˆ¶ã€‚</p>
<p><strong>å¤„ç†æ–¹å¼</strong></p>
<p>æ¶ˆæ¯ TTL å’Œæ­»ä¿¡æœºåˆ¶å®ç°ï¼š</p>
<ul>
<li>ä¸ºå»¶è¿Ÿé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯çš„ <code>TTL</code> å±æ€§ã€‚</li>
<li>é…ç½®ä¸€ä¸ªæ­»ä¿¡äº¤æ¢å™¨ï¼Œæ¶ˆæ¯åœ¨ TTL åˆ°æœŸåè¿›å…¥æ­»ä¿¡äº¤æ¢å™¨ï¼Œå†è·¯ç”±åˆ°ç›®æ ‡é˜Ÿåˆ—ã€‚</li>
</ul>
<p>æ’ä»¶å®ç°ï¼š</p>
<ul>
<li>ä½¿ç”¨ RabbitMQ çš„å®˜æ–¹å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶ï¼ˆ<code>rabbitmq_delayed_message_exchange</code>ï¼‰ï¼Œå…è®¸ç›´æ¥ä¸ºæ¶ˆæ¯è®¾ç½®å»¶è¿Ÿæ—¶é—´ã€‚</li>
</ul>
<h2 id="MQé«˜å¯ç”¨">MQé«˜å¯ç”¨</h2>
<p>æ™®é€šé›†ç¾¤</p>
<p>ä»…ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå­˜æ”¾å…ƒæ•°æ®å’Œå®é™…æ•°æ®</p>
<p>å…¶ä»–èŠ‚ç‚¹ä»…ä¿å­˜å…ƒæ•°æ®</p>
<p>æ¶ˆè´¹è€…å¯ä»å…¶ä»–èŠ‚ç‚¹æ‹‰å–å…ƒæ•°æ®ï¼Œç”±å…¶ä»–èŠ‚ç‚¹å‘å®Œæ•´èŠ‚ç‚¹æ‹‰å–æ•°æ®ï¼›</p>
<p>èŠ‚ç‚¹æŒ‚ä¸€ä¸ªä»ç„¶å¯ç”¨</p>
<p>é•œåƒé›†ç¾¤</p>
<p>æ¯ä¸ªèŠ‚ç‚¹å‡æœ‰å®Œæ•´æ•°æ®ï¼›ä¸»ä»åŒæ­¥ï¼›</p>
<h2 id="é‡å¤æ¶ˆæ¯äº§ç”Ÿ-æ¶ˆæ¯æ¶ˆè´¹å¹‚ç­‰æ€§ä¿è¯">é‡å¤æ¶ˆæ¯äº§ç”Ÿ&amp;æ¶ˆæ¯æ¶ˆè´¹å¹‚ç­‰æ€§ä¿è¯</h2>
<p>é‡å¤æ¶ˆæ¯äº§ç”Ÿ</p>
<ul>
<li>MQæ²¡æœ‰æ­£ç¡®å‘ŠçŸ¥ç”Ÿäº§è€…æ¶ˆæ¯å·²æ¥æ”¶</li>
<li>æ¶ˆè´¹è€…æ²¡æœ‰æ­£ç¡®å‘ŠçŸ¥MQæˆåŠŸæ¶ˆè´¹</li>
</ul>
<p>æ¶ˆæ¯æ¶ˆè´¹å¹‚ç­‰æ€§ä¿è¯</p>
<ul>
<li>æ¶ˆæ¯æºå¸¦å”¯ä¸€idï¼Œæ¶ˆè´¹è€…æ¥å—åˆ°æ¶ˆæ¯å<strong>æŸ¥è¯¢è®°å½•ï¼šidæ˜¯å¦è¢«å¤„ç†è¿‡</strong></li>
<li>å»é‡è¡¨</li>
</ul>
<h2 id="æ¶ˆæ¯æ¶ˆè´¹é¡ºåºä¿è¯">æ¶ˆæ¯æ¶ˆè´¹é¡ºåºä¿è¯</h2>
<p>å±€éƒ¨æ¶ˆæ¯é¡ºåºæ€§</p>
<ul>
<li>
<p>æœ‰é¡ºåºçš„æ¶ˆæ¯è¢«å­˜å…¥åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</p>
</li>
<li>
<p>ä¸ºå•ç‹¬æ¶ˆæ¯é˜Ÿåˆ—åŠ é”</p>
</li>
</ul>
<h2 id="Rabbit-MQ">Rabbit MQ</h2>
<p>ref: <a href="https://kangshitao.github.io/2021/10/26/rabbitmq/">https://kangshitao.github.io/2021/10/26/rabbitmq/</a></p>
<img src="/2025/01/17/MQ-Learning-Record/rabbitmq_1.png" class="" title="rabbitmq">
<h3 id="Rabbit-MQ-æ¶ˆæ¯é€è¾¾ä¿è¯"><strong>Rabbit MQ æ¶ˆæ¯é€è¾¾ä¿è¯</strong></h3>
<p>ç¡®ä¿æ¶ˆæ¯å‘é€åˆ°MQ</p>
<ul>
<li>å‘é€æ–¹ç¡®è®¤æœºåˆ¶ï¼šå¯ç”¨ <code>ConfirmCallback</code> å’Œ <code>ReturnCallback</code>ï¼Œç¡®ä¿æ¶ˆæ¯è¢« RabbitMQ æˆåŠŸæ¥æ”¶ã€‚</li>
</ul>
<p>ç¡®ä¿æ¶ˆæ¯è·¯ç”±åˆ°æ­£ç¡®çš„é˜Ÿåˆ—</p>
<ul>
<li>è·¯ç”±å¤±è´¥é€šçŸ¥ï¼šå¯ç”¨ <code>mandatory</code> å±æ€§ï¼Œå¹¶ä½¿ç”¨ <code>ReturnCallback</code> ç›‘å¬æœªæˆåŠŸè·¯ç”±çš„æ¶ˆæ¯ã€‚</li>
</ul>
<p>ç¡®ä¿æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­æ­£ç¡®çš„å­˜å‚¨</p>
<ul>
<li>æŒä¹…åŒ–ï¼šExchangersï¼ŒQueueå†…çš„æ¶ˆæ¯éœ€è¦æŒä¹…åŒ–</li>
</ul>
<p>ç¡®ä¿æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­æ­£ç¡®çš„æŠ•é€’åˆ°æ¶ˆè´¹è€…</p>
<ul>
<li>æ¶ˆè´¹è€…æ‰‹åŠ¨ACKç¡®è®¤</li>
</ul>
<p>Producer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReliableRabbitMQProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;reliable_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;reliable_key&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;reliable_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">             <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å£°æ˜äº¤æ¢å™¨ï¼ˆæŒä¹…åŒ–ï¼‰</span></span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;direct&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// å£°æ˜é˜Ÿåˆ—ï¼ˆæŒä¹…åŒ–ï¼‰</span></span><br><span class="line">            channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢å™¨</span></span><br><span class="line">            channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, ROUTING_KEY);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é…ç½® ReturnCallback</span></span><br><span class="line">            channel.addReturnListener((replyCode, replyText, exchange, routingKey, properties, body) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">                System.err.println(<span class="string">&quot;Message returned: &quot;</span> + message + <span class="string">&quot;, ReplyCode: &quot;</span> + replyCode);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¯ç”¨å‘é€æ–¹ç¡®è®¤æœºåˆ¶</span></span><br><span class="line">            channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Reliable Message&quot;</span>;</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, <span class="literal">true</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties.Builder()</span><br><span class="line">                            .deliveryMode(<span class="number">2</span>) <span class="comment">// æŒä¹…åŒ–æ¶ˆæ¯</span></span><br><span class="line">                            .build(),</span><br><span class="line">                    message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot; [x] Sent: &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç¡®è®¤å›è°ƒ</span></span><br><span class="line">            channel.addConfirmListener(</span><br><span class="line">                    (deliveryTag, multiple) -&gt; System.out.println(<span class="string">&quot;Message confirmed: &quot;</span> + deliveryTag),</span><br><span class="line">                    (deliveryTag, multiple) -&gt; System.err.println(<span class="string">&quot;Message not confirmed: &quot;</span> + deliveryTag)</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Comsumer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReliableRabbitMQConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;reliable_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">             <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å£°æ˜é˜Ÿåˆ—ï¼ˆæŒä¹…åŒ–ï¼Œç¡®ä¿æ¶ˆè´¹è€…åœ¨é˜Ÿåˆ—å­˜åœ¨æ—¶è¿æ¥ï¼‰</span></span><br><span class="line">            channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot; [*] Waiting for messages. To exit press CTRL+C&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¶ˆè´¹æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot; [x] Received: &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿå¤„ç†å®Œæˆåæ‰‹åŠ¨ACK</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>); <span class="comment">// æ¨¡æ‹Ÿå¤„ç†æ—¶é—´</span></span><br><span class="line">                    channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot; [x] Message acknowledged&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Failed to process message: &quot;</span> + e.getMessage());</span><br><span class="line">                    <span class="comment">// æ¶ˆæ¯æœªå¤„ç†æˆåŠŸå¯é€‰æ‹© requeue</span></span><br><span class="line">                    channel.basicNack(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¼€å¯æ‰‹åŠ¨ACK</span></span><br><span class="line">            channel.basicConsume(QUEUE_NAME, <span class="literal">false</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Kafka">Kafka</h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<p>ref: <a href="https://segmentfault.com/a/1190000038173886">https://segmentfault.com/a/1190000038173886</a></p>
<img src="/2025/01/17/MQ-Learning-Record/1460000038173889" class="" title="kafka">
<p>é»‘è‰²ç›´è§’è¾¹çŸ©å½¢ï¼šä¸€ä¸ªBroker</p>
<p>Brokerå†…è“è‰²åœ†è§’çŸ©å½¢ï¼šä¸€ä¸ªpartition</p>
<p>Leader - Followerï¼šä¸»ä»å¤åˆ¶</p>
<p>Topic-Partitionï¼šç‰©ç†ä¸ŠæŠŠ topic åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ª patitionï¼ˆå¯¹åº” server.properties ä¸­çš„ num.partitions=3 é…ç½®ï¼‰ï¼Œæ¯ä¸ª patition ç‰©ç†ä¸Šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆè¯¥æ–‡ä»¶å¤¹å­˜å‚¨è¯¥ patition çš„æ‰€æœ‰æ¶ˆæ¯å’Œç´¢å¼•æ–‡ä»¶ï¼‰</p>
<p>controllerï¼škafka é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç”¨æ¥è¿›è¡Œ leader election ä»¥åŠ å„ç§ failoverã€‚</p>
<p>zookeeperï¼škafka é€šè¿‡ zookeeper æ¥å­˜å‚¨é›†ç¾¤çš„ meta ä¿¡æ¯ã€‚</p>
<p>topic â‰¥0 â€”â€” â‰¥0 customer group</p>
<p>topic contain &gt;0 partiton</p>
<p>customer group contain &gt;0 customer</p>
<p>customer 1 â€” â‰¥0 partition</p>
<p><strong>å·¥ä½œåŸç†</strong></p>
<ul>
<li>
<p>Kafka é€šè¿‡ <strong>Consumer Group</strong> æœºåˆ¶æ¥å®ç°<strong>æ°´å¹³æ‰©å±•</strong>ï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹çš„å¤šä¸ª Consumer å…±åŒæ¶ˆè´¹ä¸€ä¸ª Topic çš„æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p><strong>æ¯ä¸ª Partition åœ¨åŒä¸€ä¸ªæ¶ˆè´¹ç»„å†…åªèƒ½è¢«ä¸€ä¸ª Consumer æ¶ˆè´¹</strong>ã€‚</p>
</li>
<li>
<p><strong>ä¸€ä¸ª Consumer å¯ä»¥æ¶ˆè´¹å¤šä¸ª Partition</strong>ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä¸ºä»€ä¹ˆåŒä¸€ä¸ªç»„çš„æ¶ˆè´¹è€…ä¸èƒ½åŒæ—¶æ¶ˆè´¹åŒä¸€ä¸ª partition ï¼Ÿ</p>
<p>å¦‚æœåŒä¸€ä¸ª Partition èƒ½è¢«å¤šä¸ª Consumer è¯»å–ï¼Œé‚£ä¹ˆç›¸åŒçš„æ¶ˆæ¯å¯èƒ½ä¼šè¢«å¤šä¸ª Consumer åŒæ—¶å¤„ç†ï¼Œå¯¼è‡´æ•°æ®é‡å¤æ¶ˆè´¹ï¼Œç ´å**â€œæ¯æ¡æ¶ˆæ¯ä»…è¢«æ¶ˆè´¹ä¸€æ¬¡â€ï¼ˆExactly Once æˆ– At Least Onceï¼‰**çš„è¯­ä¹‰ã€‚</p>
<p>Kafka <strong>ä¿è¯äº† Partition å†…éƒ¨çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„</strong>ã€‚å¦‚æœåŒä¸€ä¸ª Partition è¢«å¤šä¸ª Consumer è¯»å–ï¼Œä¸åŒçš„ Consumer å¯èƒ½ä¼šä¹±åºå¤„ç†æ¶ˆæ¯ï¼Œä»è€Œç ´åé¡ºåºæ¶ˆè´¹çš„éœ€æ±‚ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¸åŒç»„çš„æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€ä¸ª Partitionï¼Ÿ</p>
<p>Kafka <strong>ä¸ºæ¯ä¸ªæ¶ˆè´¹ç»„ç‹¬ç«‹å­˜å‚¨æ¶ˆè´¹è¿›åº¦ï¼ˆOffsetï¼‰</strong>ï¼Œè¿™æ ·ï¼š</p>
<ul>
<li><strong>ä¸åŒæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹æ§åˆ¶æ¶ˆè´¹è¿›åº¦</strong>ï¼Œæ¯”å¦‚ä¸€ä¸ªç»„å¯ä»¥æ¶ˆè´¹å¾—æ›´å¿«ï¼Œè€Œå¦ä¸€ä¸ªç»„å¯èƒ½ä¼šæ»åï¼Œä½†å½¼æ­¤ä¸ä¼šå½±å“ã€‚</li>
<li><strong>æ”¯æŒå›æº¯æ¶ˆè´¹</strong>ï¼šä¸€ä¸ªæ¶ˆè´¹ç»„å¯ä»¥åœ¨ç‰¹å®šæ—¶é—´ç‚¹é‡æ–°æ¶ˆè´¹ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–æ¶ˆè´¹ç»„çš„è¿›åº¦ã€‚</li>
</ul>
<p>è€ƒè™‘éœ€æ±‚ï¼šæ—¥å¿—åˆ†æï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ç»„å¤„ç†æ—¥å¿—å­˜å‚¨ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ç”¨äºå®æ—¶ç›‘æ§å’Œå‘Šè­¦ã€‚</p>
</blockquote>
<p>æ¡ˆä¾‹é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="comment"># Kafkaè¿æ¥é…ç½®</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="string">localhost:9092</span>  <span class="comment"># Kafkaé›†ç¾¤åœ°å€ï¼Œå¯ä»¥æ˜¯å•ä¸ªåœ°å€æˆ–è€…å¤šä¸ªåœ°å€çš„é€—å·åˆ†éš”åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”Ÿäº§è€…é…ç½®</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">acks:</span> <span class="string">all</span>  <span class="comment"># ç”Ÿäº§è€…ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤ï¼Œä¿è¯æ¶ˆæ¯å¯é é€è¾¾</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span>  <span class="comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span></span><br><span class="line">      <span class="attr">batch-size:</span> <span class="number">16384</span>  <span class="comment"># ç”Ÿäº§è€…æ‰¹é‡å‘é€çš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚</span></span><br><span class="line">      <span class="attr">linger-ms:</span> <span class="number">1</span>  <span class="comment"># ç”Ÿäº§è€…ç­‰å¾…æ—¶é—´ï¼ˆmsï¼‰ï¼Œç”¨äºæ‰¹é‡å‘é€æ§åˆ¶</span></span><br><span class="line">      <span class="attr">buffer-memory:</span> <span class="number">33554432</span>  <span class="comment"># ç”Ÿäº§è€…ç¼“å†²åŒºå†…å­˜å¤§å°</span></span><br><span class="line">      <span class="attr">key-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span>  <span class="comment"># æ¶ˆæ¯Keyçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">      <span class="attr">value-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span>  <span class="comment"># æ¶ˆæ¯Valueçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">test-group</span>  <span class="comment"># æ¶ˆè´¹è€…ç»„IDï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±äº«åŒä¸€ç»„ID</span></span><br><span class="line">      <span class="attr">enable-auto-commit:</span> <span class="literal">false</span>  <span class="comment"># ç¦æ­¢è‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»ï¼Œç¡®ä¿æ‰‹åŠ¨ç¡®è®¤</span></span><br><span class="line">      <span class="attr">auto-offset-reset:</span> <span class="string">earliest</span>  <span class="comment"># å¦‚æœæ²¡æœ‰æ¶ˆè´¹çš„ä½ç§»ï¼Œé»˜è®¤ä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹</span></span><br><span class="line">      <span class="attr">key-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span>  <span class="comment"># æ¶ˆæ¯Keyçš„ååºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">      <span class="attr">value-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span>  <span class="comment"># æ¶ˆæ¯Valueçš„ååºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¶ˆè´¹è€…ç«¯çš„ackæ¨¡å¼é…ç½®</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">ack-mode:</span> <span class="string">manual</span>  <span class="comment"># æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹ï¼Œæ¨èä½¿ç”¨æ‰‹åŠ¨ç¡®è®¤ä»¥ä¿è¯æ¶ˆæ¯å¯é æ¶ˆè´¹</span></span><br><span class="line">      <span class="attr">concurrency:</span> <span class="number">3</span>  <span class="comment"># æ¶ˆè´¹è€…å¹¶å‘çº¿ç¨‹æ•°ï¼Œå¯ä»¥æé«˜æ¶ˆè´¹ååé‡</span></span><br><span class="line">      <span class="attr">missing-topics-fatal:</span> <span class="literal">false</span>  <span class="comment"># å¦‚æœæŸä¸ªtopicä¸å­˜åœ¨ï¼Œæ˜¯å¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="attr">auto-startup:</span> <span class="literal">true</span>  <span class="comment"># æ˜¯å¦è‡ªåŠ¨å¯åŠ¨æ¶ˆè´¹è€…</span></span><br><span class="line">      <span class="attr">poll-timeout:</span> <span class="number">3000</span>  <span class="comment"># æ‹‰å–æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Kafkaé›†ç¾¤çš„é…ç½®</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span>  <span class="comment"># Kafkaé›†ç¾¤çš„é‡è¯•æ¬¡æ•°</span></span><br><span class="line">      <span class="attr">retry-backoff:</span> <span class="number">1000</span>  <span class="comment"># é‡è¯•æ—¶é—´é—´éš”ï¼Œå•ä½æ¯«ç§’</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Kafkaçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ç›‘æ§é…ç½®</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># æ˜¯å¦å¯ç”¨Kafkaçš„ç›‘æ§åŠŸèƒ½</span></span><br><span class="line">      <span class="attr">jmx-enabled:</span> <span class="literal">true</span>  <span class="comment"># æ˜¯å¦å¯ç”¨JMXæ¥ç›‘æ§Kafka</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Kafkaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–å™¨çš„é…ç½®ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦é…ç½®å…¶ä»–ç±»å‹çš„åºåˆ—åŒ–å™¨ï¼‰</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="comment"># ç”Ÿäº§è€…é…ç½®ä¸­çš„å±æ€§</span></span><br><span class="line">      <span class="attr">producer:</span></span><br><span class="line">        <span class="attr">buffer.memory:</span> <span class="number">33554432</span>  <span class="comment"># ç”Ÿäº§è€…çš„å†…å­˜ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">        <span class="attr">batch.size:</span> <span class="number">16384</span>  <span class="comment"># æ¯ä¸ªæ‰¹æ¬¡çš„æ¶ˆæ¯å¤§å°</span></span><br><span class="line">        <span class="attr">linger.ms:</span> <span class="number">1</span>  <span class="comment"># æ‰¹æ¬¡å‘é€çš„å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line">      <span class="comment"># æ¶ˆè´¹è€…é…ç½®ä¸­çš„å±æ€§</span></span><br><span class="line">      <span class="attr">consumer:</span></span><br><span class="line">        <span class="attr">fetch.max.wait.ms:</span> <span class="number">500</span>  <span class="comment"># æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="attr">fetch.min.bytes:</span> <span class="number">1</span>  <span class="comment"># æ¯æ¬¡æ‹‰å–æ¶ˆæ¯çš„æœ€å°å­—èŠ‚æ•°</span></span><br><span class="line">        <span class="attr">max.poll.records:</span> <span class="number">500</span>  <span class="comment"># æ¯æ¬¡pollæ“ä½œæœ€å¤šæ‹‰å–çš„æ¶ˆæ¯æ•°é‡</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="kafka-ç¡®ä¿æ¶ˆæ¯çš„æœ‰åºæ€§">kafka ç¡®ä¿æ¶ˆæ¯çš„æœ‰åºæ€§</h3>
<p>æ¶ˆè´¹è€…ç»„æ˜¯ç”±å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆçš„ï¼Œè¿™äº›æ¶ˆè´¹è€…å…±åŒæ¶ˆè´¹ä¸€ä¸ªæˆ–å¤šä¸ª Topic çš„æ¶ˆæ¯ã€‚</p>
<p>å½“å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªæ¶ˆè´¹è€…ç»„æ—¶ï¼ŒKafka ä¼šç¡®ä¿æ¯ä¸ªåˆ†åŒºåªèƒ½è¢«æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸”æ¯ä¸ªæ¶ˆè´¹è€…ä¼šå¤„ç†å®ƒæ‰€åˆ†é…çš„åˆ†åŒºä¸­çš„æ¶ˆæ¯ã€‚</p>
<p>åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œè¦åšåˆ°ç”Ÿäº§è€…å‘æ¶ˆæ¯æ—¶æ¶ˆæ¯çš„æœ‰åºæ€§ï¼Œç”Ÿäº§è€…å‘æ¶ˆæ¯çš„æ—¶å€™åº”è¯¥æŒ‡å®š Key è¿›è¡ŒæŠ•é€’åˆ° Partitionï¼Œç›¸åŒçš„ Key ä¼šå‘é€åˆ°ä¸€ä¸ª Partition ä¸­</p>
<img src="/2025/01/17/MQ-Learning-Record/71007988-b9c6-406e-9e4b-26165e6427e7" class="" title="image.png">
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ä¸‹å•</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line"><span class="comment">//send æ–¹æ³•å‚æ•°, å‚æ•°1: topic å‚æ•°2: key å‚æ•°3: å†…å®¹</span></span><br><span class="line">kafkaTemplate.send(TOPIC_ORDER, orderId, <span class="string">&quot;åˆ›å»ºè®¢å•ï¼š&quot;</span> + orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Message Queue</category>
      </categories>
      <tags>
        <tag>MQ, Java</tag>
      </tags>
  </entry>
  <entry>
    <title>LLM&amp;Rela</title>
    <url>/2025/03/19/LLM-Rela/</url>
    <content><![CDATA[<p>LLMç›¸å…³</p>
<p>æ–½å·¥ä¸­â€¦</p>
<span id="more"></span>
<h1>LLM&amp;Rela</h1>
<h2 id="LLM-base">LLM-base</h2>
<h3 id="æœŸæœ›ä¸æ–¹å·®">æœŸæœ›ä¸æ–¹å·®</h3>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>æ€§è´¨</strong></th>
<th style="text-align:center"><strong>æœŸæœ› E[â‹…]</strong></th>
<th style="text-align:center"><strong>æ–¹å·® Var(â‹…)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>çº¿æ€§å˜æ¢</strong></td>
<td style="text-align:center">$E[aX+b]=aE[X]+b$</td>
<td style="text-align:center">$Var(aX+b)=a^2Var(X)$</td>
</tr>
<tr>
<td style="text-align:center"><strong>ç‹¬ç«‹æ€§å½±å“</strong></td>
<td style="text-align:center">$E[XY]=E[X]E[Y]$ï¼ˆè‹¥ç‹¬ç«‹ï¼‰</td>
<td style="text-align:center">$Var(X+Y)=Var(X)+Var(Y)$ï¼ˆè‹¥ç‹¬ç«‹ï¼‰</td>
</tr>
<tr>
<td style="text-align:center"><strong>ä¸çŸ©çš„å…³ç³»</strong></td>
<td style="text-align:center">ä¸€é˜¶åŸç‚¹çŸ©</td>
<td style="text-align:center">äºŒé˜¶ä¸­å¿ƒçŸ©</td>
</tr>
</tbody>
</table>
<br>
<h3 id="åæ–¹å·®">åæ–¹å·®</h3>
<p>$$Cov(X, Y) = E[XY] - E[X]E[Y]$$</p>
<p>X, Yç›¸äº’ç‹¬ç«‹ -&gt; $Cov(X, Y) = 0$</p>
<p>åæ–¹å·®ä¸ºé›¶ä»…æ’é™¤çº¿æ€§å…³ç³»ï¼Œè€Œç‹¬ç«‹æ€§æ’é™¤æ‰€æœ‰å½¢å¼çš„ä¾èµ–ï¼Œåœ¨è”åˆæ­£æ€åˆ†å¸ƒä¸­ï¼Œä¸¤è€…ç­‰ä»·ï¼Œè¿™æ˜¯ç‰¹ä¾‹è€Œéæ™®éè§„å¾‹ã€‚</p>
<blockquote>
<p>æ²¡æœ‰çº¿æ€§å…³ç³»æ„å‘³ç€ ä¸èƒ½é€šè¿‡çº¿æ€§æ–¹ç¨‹ ï¼ˆå¦‚ $Y = aX + b$ï¼‰æ¥æè¿°å˜é‡é—´çš„å…³ç³»ï¼Œä½†æ˜¯å®ƒä»¬å¯èƒ½å­˜åœ¨éçº¿æ€§å…³ç³»ï¼ˆå¦‚ $Y = aX^2 + bX + c$ æˆ– $Y = sin(X)$ï¼‰</p>
<p><strong>ç‹¬ç«‹æ€§</strong> æ„å‘³ç€ä¸¤ä¸ªéšæœºå˜é‡ $X$ å’Œ $Y$ çš„è”åˆåˆ†å¸ƒå®Œå…¨ç”±å®ƒä»¬çš„è¾¹ç¼˜åˆ†å¸ƒå†³å®šï¼Œå³ $P(X,Y)=P(X)P(Y)$ï¼Œä¸”<strong>æ— æ³•é€šè¿‡ç”¨ä»»ä½•æœ‰ç»Ÿè®¡æ„ä¹‰çš„ä»»ä½•å‡½æ•°ï¼ˆæ— è®ºæ˜¯çº¿æ€§è¿˜æ˜¯éçº¿æ€§ï¼‰ä»å…¶ä¸­ä¸€ä¸ªå˜é‡é¢„æµ‹å¦ä¸€ä¸ªå˜é‡</strong>ã€‚</p>
</blockquote>
<br>
<h3 id="æ¿€æ´»å‡½æ•°">æ¿€æ´»å‡½æ•°</h3>
<p>æ¿€æ´»å‡½æ•°åœ¨ç¥ç»ç½‘ç»œçš„æ¯ä¸€å±‚ä¸­å¼•å…¥éçº¿æ€§ï¼Œä½¿å¾—ç¥ç»ç½‘ç»œèƒ½å¤Ÿæ‹Ÿåˆå¤æ‚çš„éçº¿æ€§æ¨¡å¼ã€‚å¸¸è§çš„æ¿€æ´»å‡½æ•°æœ‰ Sigmoidã€ReLUï¼ˆRectified Linear Unitï¼‰ã€Tanhã€Leaky ReLU ç­‰</p>
<p><strong>Sigmoid å‡½æ•°</strong></p>
<blockquote>
<p>sigmoid ä¹™å‹å½¢çŠ¶ $(-\infty, 0) \to (0,\frac{1}{2})$ &amp; $(0, +\infty) \to (\frac{1}{2}, 1)$</p>
</blockquote>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\sigma(x) = \frac{1}{1 + e^{-x}}$</p>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>è¾“å‡ºèŒƒå›´åœ¨ (0, 1) ä¹‹é—´</li>
<li>å¸¸ç”¨äºäºŒåˆ†ç±»é—®é¢˜çš„è¾“å‡ºå±‚</li>
<li>ç¼ºç‚¹ï¼šåœ¨æç«¯å€¼å¤„æ¢¯åº¦å¾ˆå°ï¼Œå®¹æ˜“å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±</li>
</ul>
<br>
<p><strong>Tanhï¼ˆåŒæ›²æ­£åˆ‡ï¼‰å‡½æ•°</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\tanh(x) = \frac{e^x - e^{-x}}{e^x + e^{-x}}$</p>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>è¾“å‡ºèŒƒå›´åœ¨ (-1, 1) ä¹‹é—´</li>
<li>ç›¸æ¯” Sigmoid æ›´é€‚åˆéšè—å±‚ï¼Œå› ä¸ºå®ƒçš„å‡å€¼ä¸º 0</li>
<li>åŒæ ·å­˜åœ¨æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼ˆä½†ç¨å¼±äº Sigmoidï¼‰</li>
</ul>
<br>
<p><strong>ReLUï¼ˆRectified Linear Unitï¼‰å‡½æ•°</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\text{ReLU}(x) = \max(0, x)$</p>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ç®€å•ã€é«˜æ•ˆï¼Œæ”¶æ•›é€Ÿåº¦å¿«</li>
<li>è¾“å‡ºèŒƒå›´ï¼š[0, +âˆ)</li>
<li>ç¼ºç‚¹ï¼šè´Ÿå€¼éƒ¨åˆ†æ¢¯åº¦ä¸º 0ï¼Œå¯èƒ½å¯¼è‡´â€œç¥ç»å…ƒæ­»äº¡â€</li>
</ul>
<br>
<p><strong>Leaky ReLU å‡½æ•°</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\text{Leaky ReLU}(x) = \begin{cases} x &amp; \text{if } x \geq 0 \ \alpha x &amp; \text{if } x &lt; 0 \end{cases}$</p>
<p>å…¶ä¸­ï¼Œ$\alpha$ æ˜¯ä¸€ä¸ªå¾ˆå°çš„æ­£æ•°ï¼ˆå¦‚ 0.01ï¼‰</p>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>æ”¹è¿›äº† ReLU çš„â€œæ­»äº¡ç¥ç»å…ƒâ€é—®é¢˜</li>
<li>å…è®¸è´Ÿæ–¹å‘æœ‰å¾®å°çš„æ¢¯åº¦ï¼Œé¿å…å®Œå…¨å¤±æ´»</li>
</ul>
<br>
<h3 id="æŸå¤±å‡½æ•°">æŸå¤±å‡½æ•°</h3>
<p><strong>å‡æ–¹è¯¯å·®ï¼ˆMean Squared Error, MSEï¼‰</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\text{MSE} = \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2$</p>
<ul>
<li>$y_i$ï¼šçœŸå®å€¼</li>
<li>$\hat{y}_i$ï¼šé¢„æµ‹å€¼</li>
<li>$n$ï¼šæ ·æœ¬æ•°</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å›å½’é—®é¢˜ï¼ˆå¦‚æˆ¿ä»·é¢„æµ‹ï¼‰</li>
<li>å¯¹å¼‚å¸¸å€¼æ•æ„Ÿï¼Œå¹³æ–¹é¡¹æ”¾å¤§è¯¯å·®</li>
</ul>
<br>
<p><strong>å¹³å‡ç»å¯¹è¯¯å·®ï¼ˆMean Absolute Error, MAEï¼‰</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} |y_i - \hat{y}_i|$</p>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å›å½’é—®é¢˜</li>
<li>æ›´é²æ£’ï¼Œä¸åƒ MSE é‚£æ ·å¯¹å¼‚å¸¸å€¼æ•æ„Ÿ</li>
</ul>
<br>
<p><strong>Huber Lossï¼ˆå¹³æ»‘çš„ MSE å’Œ MAE çš„ç»“åˆï¼‰</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$L_\delta(a) = \begin{cases} \frac{1}{2} a^2 &amp; \text{if } |a| \leq \delta \ \delta (|a| - \frac{1}{2} \delta) &amp; \text{otherwise} \end{cases}$</p>
<p>å…¶ä¸­ $a = y - \hat{y}$</p>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å›å½’é—®é¢˜</li>
<li>åŒæ—¶å…¼é¡¾ MAE çš„é²æ£’æ€§å’Œ MSE çš„å¯å¯¼æ€§</li>
</ul>
<br>
<p><strong>äº¤å‰ç†µæŸå¤±ï¼ˆCross-Entropy Lossï¼‰</strong></p>
<p>â–¶ äºŒåˆ†ç±»äº¤å‰ç†µï¼ˆBinary Cross-Entropyï¼‰ï¼š</p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\text{Loss} = - \left[ y \log(\hat{y}) + (1 - y) \log(1 - \hat{y}) \right]$</p>
<ul>
<li>$y \in {0, 1}$ ä¸ºçœŸå®æ ‡ç­¾</li>
<li>$\hat{y}$ æ˜¯é¢„æµ‹æ¦‚ç‡</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>äºŒåˆ†ç±»é—®é¢˜ï¼ˆå¦‚çŒ« vs ç‹—ï¼‰</li>
</ul>
<blockquote>
<p>é¢„æµ‹å€¼åœ¨logå†…</p>
<p>æœ‰è´Ÿå·</p>
</blockquote>
<br>
<p>â–¶ å¤šåˆ†ç±»äº¤å‰ç†µï¼ˆCategorical Cross-Entropyï¼‰ï¼š</p>
<p><strong>å…¬å¼ï¼ˆsoftmax è¾“å‡ºï¼‰ï¼š</strong></p>
<p>$\text{Loss} = - \sum_{i=1}^{C} y_i \log(\hat{y}_i)$</p>
<ul>
<li>$C$ æ˜¯ç±»åˆ«æ€»æ•°</li>
<li>$y_i$ æ˜¯ one-hot ç¼–ç çš„çœŸå®æ ‡ç­¾</li>
<li>$\hat{y}_i$ æ˜¯ç¬¬ ii ç±»çš„é¢„æµ‹æ¦‚ç‡</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å¤šåˆ†ç±»é—®é¢˜ï¼ˆå¦‚æ•°å­—è¯†åˆ«ï¼‰</li>
</ul>
<br>
<p><strong>KL æ•£åº¦ï¼ˆKullbackâ€“Leibler Divergenceï¼‰</strong></p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$D_{KL}(P \parallel Q) = \sum_{i} P(i) \log\left(\frac{P(i)}{Q(i)}\right)$</p>
<ul>
<li>$P$ï¼šçœŸå®åˆ†å¸ƒ</li>
<li>$Q$ï¼šé¢„æµ‹åˆ†å¸ƒ</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>åˆ†å¸ƒä¹‹é—´çš„è·ç¦»åº¦é‡ï¼ˆå¦‚åœ¨ç”Ÿæˆæ¨¡å‹ä¸­ï¼‰</li>
</ul>
<blockquote>
<p>äº¤å‰ç†µ = KLæ•£åº¦ + ç†µ</p>
</blockquote>
<br>
<h3 id="ä¼˜åŒ–ç®—æ³•">ä¼˜åŒ–ç®—æ³•</h3>
<h4 id="æ¢¯åº¦ä¸‹é™">æ¢¯åº¦ä¸‹é™</h4>
<p>Gradient Descent</p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\theta := \theta - \eta \cdot \nabla_\theta J(\theta)$</p>
<ul>
<li>$\theta$ï¼šæ¨¡å‹å‚æ•°</li>
<li>$\eta$ï¼šå­¦ä¹ ç‡ï¼ˆlearning rateï¼‰</li>
<li>$\nabla_\theta J(\theta)$ï¼šæŸå¤±å‡½æ•° $J$ å…³äºå‚æ•° $\theta$ çš„æ¢¯åº¦</li>
</ul>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>æ¯æ¬¡ç”¨<strong>å…¨éƒ¨æ•°æ®</strong>è®¡ç®—æ¢¯åº¦ï¼Œæ›´æ–°å‚æ•°</li>
<li>ç²¾åº¦é«˜ä½†è®¡ç®—å¼€é”€å¤§ï¼Œé€‚åˆå°æ•°æ®é›†</li>
</ul>
<br>
<h4 id="éšæœºæ¢¯åº¦ä¸‹é™">éšæœºæ¢¯åº¦ä¸‹é™</h4>
<p>Stochastic Gradient Descent, SGD</p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\theta := \theta - \eta \cdot \nabla_\theta J(\theta; x^{(i)}, y^{(i)})$</p>
<ul>
<li>æ¯æ¬¡ä»…ç”¨<strong>ä¸€ä¸ªæ ·æœ¬</strong> $(x(i),y(i))(x^{(i)}, y^{(i)})$ æ›´æ–°ä¸€æ¬¡å‚æ•°</li>
</ul>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>è®¡ç®—æ•ˆç‡é«˜ã€æ›´æ–°é¢‘ç¹</li>
<li>å™ªå£°å¤§ï¼Œæœ‰æ—¶ä¸ç¨³å®šï¼Œä½†æœ‰åŠ©äºè·³å‡ºå±€éƒ¨æœ€ä¼˜</li>
</ul>
<br>
<h4 id="å°æ‰¹é‡æ¢¯åº¦ä¸‹é™">å°æ‰¹é‡æ¢¯åº¦ä¸‹é™</h4>
<p>Adaptive Moment Estimation</p>
<p><strong>å…¬å¼ï¼š</strong></p>
<p>$\theta := \theta - \eta \cdot \frac{1}{m} \sum_{i=1}^{m} \nabla_\theta J(\theta; x^{(i)}, y^{(i)})$</p>
<ul>
<li>æ¯æ¬¡ç”¨ä¸€å°æ‰¹ï¼ˆmini-batchï¼‰æ ·æœ¬æ¥è®¡ç®—æ¢¯åº¦</li>
<li>æŠ˜ä¸­æ•ˆç‡ä¸ç¨³å®šæ€§ï¼Œæ˜¯æ·±åº¦å­¦ä¹ ä¸­<strong>æœ€å¸¸ç”¨çš„æ–¹å¼</strong></li>
</ul>
<br>
<h4 id="Adam">Adam</h4>
<p>Adaptive Moment Estimation</p>
<p>Adam = <strong>Momentumï¼ˆåŠ¨é‡ï¼‰</strong> + <strong>RMSPropï¼ˆè‡ªé€‚åº”å­¦ä¹ ç‡ï¼‰</strong> + <strong>åå·®ä¿®æ­£</strong></p>
<br>
<p><strong>åŠ¨é‡æ³•ï¼ˆMomentumï¼‰æ¥æº</strong></p>
<p>å…ˆçœ‹æ™®é€šçš„æ¢¯åº¦ä¸‹é™æ›´æ–°ï¼š</p>
<p>$\theta := \theta - \eta \cdot \nabla_\theta J(\theta)$</p>
<p>ä½†è¿™ä¸ªæ›´æ–°æ–¹å‘å®¹æ˜“â€œæ¥å›éœ‡è¡â€ï¼Œæ‰€ä»¥å¼•å…¥åŠ¨é‡çš„æ€æƒ³ï¼Œè®©å‚æ•°æ›´æ–°åƒâ€œå¸¦æƒ¯æ€§çš„å°çƒâ€é‚£æ ·æ»‘ä¸‹å»ï¼š</p>
<p>åŠ¨é‡æ³•å…¬å¼ï¼š</p>
<p>$v_t = \beta_1 v_{t-1} + (1 - \beta_1) \nabla_\theta J(\theta)Î¸:=Î¸âˆ’Î·â‹…vt\theta := \theta - \eta \cdot v_t$</p>
<p>è¿™ä¸ªåŠ¨é‡ $v_t$ ç›¸å½“äºå¯¹æ¢¯åº¦çš„æŒ‡æ•°åŠ æƒå¹³å‡ã€‚</p>
<p>Adam çš„ç¬¬ä¸€éƒ¨åˆ†ï¼š</p>
<p>$m_t = \beta_1 m_{t-1} + (1 - \beta_1) \cdot g_t$</p>
<p>å°±æ˜¯æ¥è‡ªè¿™ä¸ªæ€è·¯ï¼Œ$m_t$ â‰ˆ å¹³æ»‘æ¢¯åº¦ï¼ˆmomentumï¼‰</p>
<br>
<p><strong>RMSProp æ¥æºï¼šè‡ªé€‚åº”å­¦ä¹ ç‡</strong></p>
<p>RMSProp æƒ³è§£å†³çš„é—®é¢˜æ˜¯ï¼š<strong>ä¸åŒå‚æ•°çš„æ¢¯åº¦å°ºåº¦ä¸åŒæ—¶ï¼Œç”¨ç›¸åŒå­¦ä¹ ç‡ä¸åˆé€‚</strong>ã€‚</p>
<p>æ‰€ä»¥å®ƒå¼•å…¥ä¸€ä¸ªâ€œå¹³æ–¹æ¢¯åº¦çš„æŒ‡æ•°å¹³å‡â€ï¼š</p>
<p>$s_t = \beta_2 s_{t-1} + (1 - \beta_2) g_t^2Î¸:=Î¸âˆ’Î·st+Ïµâ‹…gt\theta := \theta - \frac{\eta}{\sqrt{s_t} + \epsilon} \cdot g_t$</p>
<p>Adam çš„ç¬¬äºŒéƒ¨åˆ†ï¼š</p>
<p>$v_t = \beta_2 v_{t-1} + (1 - \beta_2) g_t^2$</p>
<p>å°±æ˜¯å€Ÿé‰´äº† RMSPropï¼Œè®©å­¦ä¹ ç‡æ ¹æ®æ¢¯åº¦å†å²è‡ªé€‚åº”è°ƒæ•´ã€‚</p>
<br>
<p><strong>åå·®ä¿®æ­£çš„æ¥ç”±</strong></p>
<p>Adam ä¸€å¼€å§‹ m_1, v_1 éƒ½æ˜¯ä» 0 å¼€å§‹çš„ï¼Œä½†å› ä¸ºæ˜¯æŒ‡æ•°åŠ æƒå¹³å‡ï¼Œä¼šå¯¼è‡´åˆå§‹å‡ æ­¥åå°ï¼Œ<strong>â€œæœ‰åä¼°è®¡â€</strong>ã€‚</p>
<p>æ‰€ä»¥åšäº†ä¿®æ­£ï¼š</p>
<p>$\hat{m}_t = \frac{m_t}{1 - \beta_1^t}, \quad \hat{v}_t = \frac{v_t}{1 - \beta_2^t}$</p>
<p>è¿™ä¸ªå…¬å¼æ¥æºäºâ€œæœŸæœ›çš„æ— åä¼°è®¡æ¨å¯¼â€ï¼Œç”¨æ•°å­¦æ–¹æ³•æ ¡æ­£åˆæœŸåå°çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>Qï¼šä¸ºä»€ä¹ˆè¦åšåå·®ä¿®æ­£ï¼Ÿ</p>
<p>Aï¼šå› ä¸ºåˆå§‹æ—¶åˆ» $m_t$ã€$v_t$ éƒ½ä» 0 å¼€å§‹ï¼Œç”¨æŒ‡æ•°åŠ æƒä¼šé€ æˆâ€œä½ä¼°â€çœŸå®å€¼ï¼ˆç‰¹åˆ«åœ¨å‰å‡ æ­¥ï¼‰ã€‚</p>
<p>æ‰€ä»¥ Adam ä¸­å¼•å…¥äº†ï¼š</p>
<p>$\hat{m}_t = \frac{m_t}{1 - \beta_1^t}, \quad \hat{v}_t = \frac{v_t}{1 - \beta_2^t}$</p>
<p>ä¸‹é¢<strong>æ¨å¯¼</strong>è¿™ä¸ªä¿®æ­£é¡¹æ˜¯æ€ä¹ˆæ¥çš„ã€‚</p>
<p>æ¨å¯¼ä¸€é˜¶åŠ¨é‡åå·®ä¿®æ­£é¡¹ï¼ˆä»¥ $m_t$ ä¸ºä¾‹ï¼‰</p>
<p>æˆ‘ä»¬ä»é€’æ¨å…¬å¼å‡ºå‘ï¼ˆå‡è®¾ $m_0$ = 0ï¼‰ï¼š</p>
<p>$m_1 = (1 - \beta_1) g_1  $</p>
<p>$m_2 = \beta_1 m_1 + (1 - \beta_1) g_2 = \beta_1 (1 - \beta_1) g_1 + (1 - \beta_1) g_2$</p>
<p>$m_3 = \beta_1^2 (1 - \beta_1) g_1 + \beta_1 (1 - \beta_1) g_2 + (1 - \beta_1) g_3$</p>
<p>å¯æ¨å¹¿ä¸ºï¼š</p>
<p>$m_t = (1 - \beta_1) \sum_{i=1}^{t} \beta_1^{t-i} g_i$</p>
<p>æœŸæœ›åˆ†æï¼š$m_t$ æ˜¯ä¸€ä¸ª<strong>æœ‰åä¼°è®¡</strong></p>
<p>æˆ‘ä»¬å¸Œæœ›çš„æ˜¯ï¼š</p>
<p>$\mathbb{E}[m_t] = \mathbb{E}[g_t]$</p>
<p>ä½†æ˜¯ä¸Šé¢æ¨å¯¼çš„å½¢å¼ä¸­ï¼š</p>
<p>$\mathbb{E}[m_t] = (1 - \beta_1) \sum_{i=1}^{t} \beta_1^{t-i} \mathbb{E}[g_i]$</p>
<p>å¦‚æœæˆ‘ä»¬å‡è®¾ï¼š</p>
<ul>
<li>
<p>æ¢¯åº¦æ˜¯å¹³ç¨³çš„ï¼ˆå³å„æ—¶åˆ»æœŸæœ›ç›¸åŒï¼‰ï¼š</p>
<p>$\mathbb{E}[g_1] = \mathbb{E}[g_2] = \dots = \mathbb{E}[g_t] = \mu$</p>
</li>
</ul>
<p>é‚£ä¹ˆå°±æœ‰ï¼š</p>
<p>$\mathbb{E}[m_t] = (1 - \beta_1) \cdot \mu \sum_{i=1}^{t} \beta_1^{t - i} = \mu \cdot (1 - \beta_1) \cdot \sum_{k=0}^{t-1} \beta_1^k$</p>
<p>è¿™æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ï¼Œæ±‚å’Œåå¾—åˆ°ï¼š</p>
<p>$\mathbb{E}[m_t] = \mu \cdot (1 - \beta_1) \cdot \frac{1 - \beta_1^t}{1 - \beta_1} = \mu \cdot (1 - \beta_1^t)$</p>
<p>æ‰€ä»¥ï¼š</p>
<p>$\boxed{\mathbb{E}[m_t] = \mu \cdot (1 - \beta_1^t)} \quad \text{æœ‰åï¼}$</p>
<p>å¦‚ä½•ä¿®æ­£ï¼Ÿ</p>
<p>ä¸ºäº†å¾—åˆ°æ— åä¼°è®¡ï¼Œæˆ‘ä»¬è®©ï¼š</p>
<p>$\hat{m}_t = \frac{m_t}{1 - \beta_1^t}$</p>
<p>é‚£ä¹ˆï¼š</p>
<p>$\mathbb{E}[\hat{m}_t] = \frac{\mathbb{E}[m_t]}{1 - \beta_1^t} = \mu$</p>
<p>æˆåŠŸä¿®æ­£åå·® ğŸ‰ï¼</p>
<p>åŒç†ï¼š</p>
<p>å¯¹äºäºŒé˜¶åŠ¨é‡ $v_t$ï¼Œå®Œå…¨ä¸€æ ·çš„æ¨ç†è¿‡ç¨‹ä¹Ÿå¯ä»¥å¾—åˆ°ï¼š</p>
<p>$\hat{v}_t = \frac{v_t}{1 - \beta_2^t}$</p>
</blockquote>
<br>
<p><strong>Adamå…¬å¼ï¼š</strong></p>
<ol>
<li>
<p>ä¸€é˜¶çŸ©ä¼°è®¡ï¼ˆç±»ä¼¼åŠ¨é‡ï¼‰ï¼š</p>
<p>$m_t = \beta_1 m_{t-1} + (1 - \beta_1) \nabla_\theta J(\theta)$</p>
</li>
<li>
<p>äºŒé˜¶çŸ©ä¼°è®¡ï¼ˆå¹³æ–¹æ¢¯åº¦ï¼‰ï¼š</p>
<p>$v_t = \beta_2 v_{t-1} + (1 - \beta_2)(\nabla_\theta J(\theta))^2$</p>
</li>
<li>
<p>åå·®æ ¡æ­£ï¼š</p>
<p>$\hat{m}_t = \frac{m_t}{1 - \beta_1^t}, \quad \hat{v}_t = \frac{v_t}{1 - \beta_2^t}$</p>
</li>
<li>
<p>å‚æ•°æ›´æ–°ï¼š</p>
<p>$\theta := \theta - \eta \cdot \frac{\hat{m}_t}{\sqrt{\hat{v}_t} + \epsilon}$</p>
</li>
</ol>
<ul>
<li>é€šå¸¸ $\beta_1 = 0.9, \beta_2 = 0.999, \epsilon = 10^{-8}$</li>
</ul>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>è‡ªé€‚åº”è°ƒæ•´æ¯ä¸ªå‚æ•°çš„å­¦ä¹ ç‡</li>
<li>é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®å’Œå‚æ•°æ¨¡å‹ï¼Œæ·±åº¦å­¦ä¹ ä¸­çš„é»˜è®¤é€‰æ‹©ä¹‹ä¸€</li>
</ul>
<br>
<h3 id="æ¢¯åº¦æ¶ˆå¤±-çˆ†ç‚¸">æ¢¯åº¦æ¶ˆå¤±&amp;çˆ†ç‚¸</h3>
<p>æ¢¯åº¦æ¶ˆå¤±æ˜¯æŒ‡ï¼ŒæŸå¤±å‡½æ•°å¯¹ç½‘ç»œä¸­æŸå‚æ•°è®¡ç®—æ¢¯åº¦ï¼Œç”±äºé“¾å¼æ³•åˆ™ï¼Œè®¡ç®—é“¾è¿‡é•¿ï¼Œå¾—åˆ°çš„æ¢¯åº¦è®¡ç®—ç»“æœæ¥è¿‘0</p>
<p>å¯èƒ½å‡ºç°ï¼š</p>
<ol>
<li>å‚æ•°åˆå§‹åŒ–å­˜åœ¨é—®é¢˜ï¼Œæƒé‡å‚æ•°w_iè¿‡å°å¯¼è‡´æ¢¯åº¦è®¡ç®—å€¼æ¥è¿‘0</li>
<li>å‚æ•°/æ¿€æ´»å‡½æ•°å­˜åœ¨éçº¿æ€§è¿ç®—ï¼Œå€¼è¢«å¿«é€Ÿç¼©å°å¯¼è‡´æ¢¯åº¦è®¡ç®—å€¼æ¥è¿‘0</li>
</ol>
<p>å‚æ•°çš„æ›´æ–°ä¾èµ–äºæ¢¯åº¦ï¼Œå½“å‡ºç°æ¢¯åº¦æ¶ˆå¤±æ—¶ï¼Œå‚æ•°æ— æ³•å¾—åˆ°æ›´æ–°</p>
<br>
<p><strong>è§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜çš„æ–¹æ³•ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨æ°å½“çš„æ¿€æ´»å‡½æ•°ï¼šæŸäº›æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ReLUå’ŒLeaky ReLUï¼‰åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­æ›´ä¸å®¹æ˜“å‡ºç°æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å®ƒä»¬æ›¿ä»£Sigmoidå’ŒTanhã€‚</li>
<li>æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰ï¼šæ‰¹é‡å½’ä¸€åŒ–å¯ä»¥åŠ é€Ÿè®­ç»ƒè¿‡ç¨‹ï¼Œè¿˜å¯ä»¥ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½¿å¾—ç½‘ç»œæ›´ç¨³å®šå’Œæ›´æ˜“è®­ç»ƒã€‚</li>
<li>ä½¿ç”¨æ®‹å·®è¿æ¥ï¼ˆResidual Connectionsï¼‰ï¼šæ®‹å·®è¿æ¥å¯ä»¥è·³è¿‡æŸäº›å±‚ï¼Œå°†è¾“å…¥ç›´æ¥ä¸è¾“å‡ºç›¸åŠ ï¼Œæœ‰åŠ©äºä¿¡æ¯çš„ä¼ é€’å’Œæ¢¯åº¦çš„æµåŠ¨ï¼Œå‡å°‘æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚</li>
<li>è°ƒæ•´ç½‘ç»œæ¶æ„ï¼šé€‚å½“è°ƒæ•´ç½‘ç»œçš„æ·±åº¦ï¼Œé¿å…è®¾è®¡è¿‡æ·±çš„ç½‘ç»œç»“æ„ï¼Œä¹Ÿæœ‰åŠ©äºå‡å°‘æ¢¯åº¦æ¶ˆå¤±çš„å½±å“ã€‚</li>
</ol>
<p><strong>è§£å†³æ¢¯åº¦çˆ†ç‚¸é—®é¢˜çš„æ–¹æ³•ï¼š</strong></p>
<ol>
<li>æ¢¯åº¦æˆªæ–­ï¼ˆGradient Clippingï¼‰ï¼šè®¾ç½®ä¸€ä¸ªæ¢¯åº¦é˜ˆå€¼ï¼Œåœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ¢¯åº¦è¶…è¿‡è¯¥é˜ˆå€¼ï¼Œåˆ™å°†å…¶è£å‰ªä¸ºé˜ˆå€¼ä»¥å†…çš„æ•°å€¼ï¼Œé¿å…æ¢¯åº¦çˆ†ç‚¸ã€‚</li>
<li>ä½¿ç”¨æ°å½“çš„æƒé‡åˆå§‹åŒ–ï¼šåˆé€‚çš„æƒé‡åˆå§‹åŒ–å¯ä»¥å‡å°‘æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒXavier/Glorotåˆå§‹åŒ–é’ˆå¯¹Sigmoidå’ŒTanhæ¿€æ´»å‡½æ•°çš„ç½‘ç»œæ•ˆæœè¾ƒå¥½ï¼Œè€ŒHeåˆå§‹åŒ–é’ˆå¯¹ReLUæ¿€æ´»å‡½æ•°çš„ç½‘ç»œæ•ˆæœè¾ƒå¥½ã€‚</li>
<li>å‡å°‘å­¦ä¹ ç‡ï¼šè¾ƒå°çš„å­¦ä¹ ç‡å¯ä»¥ç¼“è§£æ¢¯åº¦çˆ†ç‚¸çš„å½±å“ï¼Œä½†è¦æ³¨æ„ä¸è¦å°†å­¦ä¹ ç‡è®¾ç½®å¾—è¿‡å°ï¼Œä»¥å…å½±å“æ”¶æ•›é€Ÿåº¦ã€‚</li>
<li>æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰ï¼šåŒæ ·ï¼Œæ‰¹é‡å½’ä¸€åŒ–åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æœ‰åŠ©äºæ§åˆ¶æ¢¯åº¦çš„å¤§å°ï¼Œå‡å°‘æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚</li>
</ol>
<br>
<h3 id="æ­£åˆ™åŒ–-å½’ä¸€åŒ–">æ­£åˆ™åŒ–&amp;å½’ä¸€åŒ–</h3>
<p><strong>æ­£åˆ™åŒ–ï¼ˆRegularizationï¼‰ï¼š</strong> æ­£åˆ™åŒ–æ˜¯é€šè¿‡åœ¨æŸå¤±å‡½æ•°ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„é¡¹ï¼Œæ¥é™åˆ¶æ¨¡å‹å‚æ•°çš„å¤§å°ï¼Œä»è€Œé¿å…è¿‡æ‹Ÿåˆé—®é¢˜ã€‚å¸¸è§çš„æ­£åˆ™åŒ–é¡¹æœ‰L1æ­£åˆ™åŒ–å’ŒL2æ­£åˆ™åŒ–ã€‚</p>
<ul>
<li>L1æ­£åˆ™åŒ–ï¼šåœ¨æŸå¤±å‡½æ•°ä¸­æ·»åŠ æ¨¡å‹å‚æ•°çš„ç»å¯¹å€¼ä¹‹å’Œã€‚L1æ­£åˆ™åŒ–æœ‰åŠ©äºç¨€ç–æ¨¡å‹ï¼Œå³å°†ä¸€äº›å‚æ•°çš„å€¼å‹ç¼©ä¸º0ï¼Œä»è€Œå‡å°‘æ¨¡å‹çš„å¤æ‚åº¦ã€‚</li>
<li>L2æ­£åˆ™åŒ–ï¼šåœ¨æŸå¤±å‡½æ•°ä¸­æ·»åŠ æ¨¡å‹å‚æ•°çš„å¹³æ–¹ä¹‹å’Œã€‚L2æ­£åˆ™åŒ–å¯¹å‚æ•°çš„æƒ©ç½šæ›´åŠ å¹³æ»‘ï¼Œé€šå¸¸ä¼šè®©å‚æ•°æ¥è¿‘äº0ï¼Œä½†ä¸ä¼šä¸¥æ ¼åœ°ç­‰äº0ã€‚</li>
</ul>
<p>æ­£åˆ™åŒ–çš„ç›®çš„æ˜¯é˜²æ­¢æ¨¡å‹åœ¨è®­ç»ƒé›†ä¸Šè¿‡åº¦æ‹Ÿåˆï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°æ³›åŒ–åˆ°æœªè§è¿‡çš„æ–°æ•°æ®ä¸Šã€‚</p>
<p>å‡è®¾æˆ‘ä»¬åœ¨çº¿æ€§å›å½’ä¸­è®­ç»ƒä¸€ä¸ªæ¨¡å‹ï¼š</p>
<p>åŸå§‹æŸå¤±å‡½æ•°ï¼ˆMSEï¼‰ï¼š</p>
<p>$Loss = (y - yÌ‚ )Â²$</p>
<p>åŠ å…¥ L2 æ­£åˆ™åŒ–åï¼š</p>
<p>$Loss = (y - yÌ‚ )Â² + Î» * ||w||Â²$</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><code>||w||Â²</code> è¡¨ç¤ºæ‰€æœ‰æƒé‡çš„å¹³æ–¹å’Œ</li>
<li><code>Î»</code> æ˜¯æ­£åˆ™åŒ–å¼ºåº¦ï¼ˆè¶…å‚æ•°ï¼‰</li>
</ul>
<p>â¡ï¸ <strong>ä½œç”¨ï¼š</strong> å¦‚æœæŸäº›æƒé‡å¤ªå¤§ï¼Œä¼šè¢«æƒ©ç½šï¼Œä»è€Œè®©æ¨¡å‹æ›´ç®€å•ã€æ³›åŒ–èƒ½åŠ›æ›´å¼ºã€‚</p>
<br>
<p><strong>å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰ï¼š</strong> å½’ä¸€åŒ–æ˜¯å°†æ•°æ®æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œä½¿å…¶å€¼è½åœ¨ç‰¹å®šèŒƒå›´å†…ã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œå¸¸è§çš„å½’ä¸€åŒ–æ–¹æ³•æ˜¯å°†è¾“å…¥ç‰¹å¾ç¼©æ”¾åˆ°0å’Œ1ä¹‹é—´ï¼Œæˆ–è€…ä½¿å…¶å‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1ã€‚</p>
<ul>
<li>æœ€å°-æœ€å¤§å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰ï¼šå°†æ•°æ®ç¼©æ”¾åˆ°æŒ‡å®šçš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´ï¼Œå…¬å¼ä¸ºï¼š$(x - x_{min}) / (x_{max} - x_{min})$</li>
<li>å‡å€¼-æ–¹å·®å½’ä¸€åŒ–ï¼ˆStandardizationï¼‰ï¼šå°†æ•°æ®ç¼©æ”¾ä¸ºå‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1çš„åˆ†å¸ƒï¼Œå…¬å¼ä¸ºï¼š$(x - mean) / std$</li>
</ul>
<p>å½’ä¸€åŒ–çš„ç›®çš„æ˜¯å°†ç‰¹å¾çš„å€¼ç»Ÿä¸€åˆ°ç›¸ä¼¼çš„èŒƒå›´å†…ï¼ŒåŠ é€Ÿæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ï¼ŒåŒæ—¶æœ‰åŠ©äºæ¢¯åº¦çš„ä¼ æ’­å’Œä¼˜åŒ–ç®—æ³•çš„æ”¶æ•›ã€‚</p>
<p>å¸¸è§æ–¹æ³•ï¼š</p>
<ul>
<li>
<p><strong>Min-Max å½’ä¸€åŒ–ï¼š</strong> æŠŠæ•°æ®å‹ç¼©åˆ° [0,1] åŒºé—´</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x&#x27; = (x - min) / (max - min)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Z-score æ ‡å‡†åŒ–ï¼ˆStandardizationï¼‰ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x&#x27; = (x - mean) / std</span><br></pre></td></tr></table></figure>
</li>
</ul>
<br>
<p><strong>ä¸¤è€…çš„ä½œç”¨ï¼š</strong></p>
<ul>
<li>æ­£åˆ™åŒ–ç”¨äºé˜²æ­¢è¿‡æ‹Ÿåˆï¼Œé€šè¿‡çº¦æŸæ¨¡å‹å‚æ•°çš„å¤§å°ï¼Œå‡å°‘æ¨¡å‹çš„å¤æ‚åº¦ï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
<li>å½’ä¸€åŒ–ç”¨äºå°†æ•°æ®çš„ç‰¹å¾ç¼©æ”¾åˆ°ç»Ÿä¸€çš„èŒƒå›´å†…ï¼Œä½¿å¾—è®­ç»ƒè¿‡ç¨‹æ›´ç¨³å®šï¼ŒåŠ é€Ÿä¼˜åŒ–ç®—æ³•çš„æ”¶æ•›ï¼Œå¹¶ä¸”æœ‰åŠ©äºé¿å…æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚</li>
</ul>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ­£åˆ™åŒ–å’Œå½’ä¸€åŒ–é€šå¸¸æ˜¯ä¸€èµ·ä½¿ç”¨çš„ï¼Œä»¥æé«˜æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½å’Œè®­ç»ƒæ•ˆæœã€‚</p>
<br>
<h3 id="batch">batch</h3>
<p>åœ¨æœºå™¨å­¦ä¹ ï¼Œç‰¹åˆ«æ˜¯æ·±åº¦å­¦ä¹ è®­ç»ƒä¸­ï¼Œbatch_size ä¸º 1 åšä¸¤æ¬¡è®­ç»ƒï¼ˆå‡è®¾æ•°æ®é›†ç›¸åŒï¼‰å’Œ batch_size ä¸º 2 åšä¸€æ¬¡è®­ç»ƒ<strong>ä¸ç­‰ä»·</strong>ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p>
<ol>
<li><strong>æ¢¯åº¦è®¡ç®—ï¼š</strong>
<ul>
<li><strong>Batch Size = 1 (ä¸¤æ¬¡è®­ç»ƒ)ï¼š</strong> æ¯æ¬¡è®­ç»ƒè¿­ä»£æ—¶ï¼Œæ¨¡å‹ä¼šè®¡ç®—<strong>ä¸€ä¸ªæ ·æœ¬</strong>çš„æŸå¤±ï¼Œå¹¶åŸºäºè¿™ä¸€ä¸ªæ ·æœ¬çš„æŸå¤±æ¥è®¡ç®—æ¢¯åº¦ã€‚ç„¶åï¼Œä¼˜åŒ–å™¨ä¼šä½¿ç”¨è¿™ä¸ªæ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹çš„æƒé‡ã€‚è¿™æ„å‘³ç€æ¢¯åº¦æ›´æ–°çš„æ–¹å·®ä¼šéå¸¸å¤§ï¼Œå› ä¸ºæ¯æ¬¡æ›´æ–°éƒ½åªä¾èµ–äºä¸€ä¸ªéå¸¸å°çš„â€œæ ·æœ¬â€ä¿¡æ¯ã€‚</li>
<li><strong>Batch Size = 2 (ä¸€æ¬¡è®­ç»ƒ)ï¼š</strong> æ¯æ¬¡è®­ç»ƒè¿­ä»£æ—¶ï¼Œæ¨¡å‹ä¼šè®¡ç®—<strong>ä¸¤ä¸ªæ ·æœ¬</strong>çš„æŸå¤±ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªæ ·æœ¬çš„æ¢¯åº¦<strong>å¹³å‡</strong>ï¼ˆæˆ–æ±‚å’Œåå½’ä¸€åŒ–ï¼‰èµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªæ›´ç¨³å®šçš„æ¢¯åº¦ã€‚ä¼˜åŒ–å™¨ä¼šä½¿ç”¨è¿™ä¸ªå¹³å‡æ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹çš„æƒé‡ã€‚</li>
</ul>
</li>
<li><strong>æ¢¯åº¦æ›´æ–°çš„é¢‘ç‡ä¸æ–¹å‘ï¼š</strong>
<ul>
<li>batch_size = 1 åšä¸¤æ¬¡è®­ç»ƒï¼šä¼šå‘ç”Ÿä¸¤æ¬¡<strong>ç‹¬ç«‹çš„</strong>æƒé‡æ›´æ–°ã€‚ä¸¤æ¬¡æ›´æ–°çš„æ–¹å‘å¯èƒ½å·®å¼‚å¾ˆå¤§ï¼Œå› ä¸ºå®ƒä»¬åŸºäºä¸åŒçš„å•ä¸ªæ ·æœ¬ã€‚</li>
<li>batch_size = 2 åšä¸€æ¬¡è®­ç»ƒï¼šä¼šå‘ç”Ÿä¸€æ¬¡æƒé‡æ›´æ–°ï¼Œè¿™ä¸ªæ›´æ–°çš„æ–¹å‘æ˜¯ä¸¤ä¸ªæ ·æœ¬çš„æ¢¯åº¦<strong>ç»¼åˆå¹³å‡</strong>çš„ç»“æœã€‚</li>
</ul>
</li>
<li><strong>æŸå¤±å‡½æ•°è¯„ä¼°ï¼š</strong>
<ul>
<li>batch_size = 1 åšä¸¤æ¬¡è®­ç»ƒï¼šæŸå¤±æ˜¯åœ¨å•ä¸ªæ ·æœ¬ä¸Šè¯„ä¼°çš„ã€‚</li>
<li>batch_size = 2 åšä¸€æ¬¡è®­ç»ƒï¼šæŸå¤±æ˜¯åœ¨ä¸¤ä¸ªæ ·æœ¬çš„å¹³å‡æˆ–æ€»å’Œä¸Šè¯„ä¼°çš„ã€‚</li>
</ul>
</li>
<li><strong>æ”¶æ•›æ€§ä¸ç¨³å®šæ€§ï¼š</strong>
<ul>
<li><strong>Batch Size = 1 (éšæœºæ¢¯åº¦ä¸‹é™SGD)ï¼š</strong> æ¢¯åº¦æ–¹å·®å¤§ï¼Œå¯¼è‡´è®­ç»ƒè¿‡ç¨‹æ›´ä¸ç¨³å®šï¼Œè·¯å¾„æ›´â€œæŠ–åŠ¨â€ã€‚è™½ç„¶ç†è®ºä¸ŠSGDåœ¨éå‡¸ä¼˜åŒ–ä¸­ä¹Ÿèƒ½æ‰¾åˆ°å±€éƒ¨æœ€ä¼˜è§£ï¼Œä½†æ”¶æ•›é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ï¼Œå¹¶ä¸”åœ¨å®è·µä¸­æ›´å®¹æ˜“é™·å…¥æ¬¡ä¼˜è§£æˆ–åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°éœ‡è¡ã€‚è¿™ç§æç«¯æƒ…å†µä¸‹çš„SGDé€šå¸¸è¢«ç§°ä¸º<strong>åœ¨çº¿å­¦ä¹ ï¼ˆOnline Learningï¼‰</strong>ã€‚</li>
<li><strong>Batch Size = 2 (å°æ‰¹é‡æ¢¯åº¦ä¸‹é™Mini-Batch GD)ï¼š</strong> é€šè¿‡å¯¹å¤šä¸ªæ ·æœ¬çš„æ¢¯åº¦è¿›è¡Œå¹³å‡ï¼Œå¯ä»¥å‡å°‘æ¢¯åº¦çš„æ–¹å·®ï¼Œä½¿æ¢¯åº¦æ–¹å‘æ›´ç¨³å®šã€æ›´å‡†ç¡®åœ°æŒ‡å‘æŸå¤±å‡½æ•°çš„ä¸‹é™æ–¹å‘ã€‚è¿™é€šå¸¸èƒ½å¸¦æ¥æ›´ç¨³å®šçš„è®­ç»ƒè¿‡ç¨‹å’Œæ›´å¿«çš„æ”¶æ•›é€Ÿåº¦ã€‚</li>
</ul>
</li>
</ol>
<br>
<h3 id="é€šé“">é€šé“</h3>
<img src="/2025/03/19/LLM-Rela/8361e16bac5ee3235ef89c78b1a1cf6b.png" class="" title="channel">
<p>å¤šé€šé“å·ç§¯è¿‡ç¨‹</p>
<p>è¾“å…¥ä¸€å¼ ä¸‰é€šé“çš„å›¾ç‰‡ï¼Œæœ‰å¤šä¸ªå·ç§¯æ ¸è¿›è¡Œå·ç§¯ï¼Œå¹¶ä¸”æ¯ä¸ªå·ç§¯æ ¸éƒ½æœ‰ä¸‰é€šé“ï¼Œåˆ†åˆ«å¯¹è¿™å¼ è¾“å…¥å›¾ç‰‡çš„ä¸‰é€šé“è¿›è¡Œå·ç§¯æ“ä½œã€‚æ¯ä¸ªå·ç§¯æ ¸ï¼Œåˆ†åˆ«è¾“å‡ºä¸‰ä¸ªé€šé“ï¼Œè¿™ä¸‰ä¸ªé€šé“è¿›è¡Œæ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ªfeaturemapï¼Œæœ‰å¤šå°‘ä¸ªå·ç§¯æ ¸ï¼Œå°±æœ‰å¤šå°‘ä¸ªfeaturemap</p>
<br>
<h3 id="RNN-LSTM">RNN&amp;LSTM</h3>
<h4 id="RNN">RNN</h4>
<img src="/2025/03/19/LLM-Rela/e38fac064524158e493a66adb2caed6e.png" class="" title="RNN">
<br>
<h4 id="LSTM">LSTM</h4>
<p><strong>è¾“å‡º</strong></p>
<p>çŸ­æœŸè®°å¿† $h_t$ï¼Œé•¿æœŸè®°å¿† $c_t$ï¼Œinput $x_t$<br>
$$<br>
o_t = \sigma(W_o \cdot [h_{t-1}, x_t] + b_o)<br>
$$</p>
<p>$$<br>
h_t = o_t \odot \tanh(c_t)<br>
$$</p>
<p><strong>é—å¿˜é—¨(è“è‰²)</strong><br>
$$<br>
f_t = \sigma(W_f \cdot [h_{t-1}, x_t] + b_f)<br>
$$</p>
<p><strong>è¾“å…¥é—¨å’Œå€™é€‰è®°å¿†</strong></p>
<ul>
<li>è¾“å…¥é—¨æ§åˆ¶å½“å‰è¾“å…¥ä¿¡æ¯ $x_t$ çš„å†™å…¥ç¨‹åº¦ï¼š</li>
</ul>
<p>$$<br>
i_t = \sigma(W_i \cdot [h_{t-1}, x_t] + b_i)<br>
$$</p>
<ul>
<li>å€™é€‰è®°å¿†ç”Ÿæˆæ–°çš„å€™é€‰ä¿¡æ¯ $\tilde{c}_t$ï¼š</li>
</ul>
<p>$$<br>
\tilde{c}<em>t = \tanh(W_c \cdot [h</em>{t-1}, x_t] + b_c)<br>
$$</p>
<br>
<p><strong>çŸ­æœŸè®°å¿†æ›´æ–°</strong></p>
<p>ç»“åˆé—å¿˜é—¨å’Œè¾“å…¥é—¨çš„ç»“æœæ›´æ–°çŸ­æœŸè®°å¿† $c_t$ï¼š<br>
$$<br>
c_t = f_t \odot c_{t-1} + i_t \odot \tilde{c}_t<br>
$$</p>
<ul>
<li>$\odot$ è¡¨ç¤ºé€å…ƒç´ ç›¸ä¹˜ã€‚</li>
<li>ç¬¬ä¸€é¡¹ $f_t \odot c_{t-1}$ ä¿ç•™å†å²ä¿¡æ¯ï¼Œç¬¬äºŒé¡¹ $i_t \odot \tilde{c}_t$ æ·»åŠ æ–°ä¿¡æ¯ã€‚</li>
</ul>
<img src="/2025/03/19/LLM-Rela/image-20250402161828313.png" class="" title="image-20250402161828313">
<br>
<p><strong>LSTM Process</strong></p>
<img src="/2025/03/19/LLM-Rela/image-20250402162106999.png" class="" title="image-20250402162106999">
<br>
<h2 id="LLM-struc">LLM-struc</h2>
<p>å¤§æ¨¡å‹ä»æ¨¡å‹æ¶æ„ä¸Šä¸»è¦åˆ†ä¸ºä¸‰ç§ï¼šOnly-encoder, Only-Decoder, Encoder-Decoderä¸‰ç§æ¨¡å‹æ¶æ„</p>
<ul>
<li>Only-encoderï¼šä¾‹å¦‚BERTï¼Œé€šè¿‡åœ¨å¤§è§„æ¨¡æ— æ ‡ç­¾æ–‡æœ¬ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œç„¶ååœ¨ä¸‹æ¸¸ä»»åŠ¡ä¸Šè¿›è¡Œå¾®è°ƒï¼Œå…·æœ‰å¼ºå¤§çš„è¯­è¨€ç†è§£èƒ½åŠ›å’Œè¡¨å¾èƒ½åŠ›ã€‚</li>
<li>Only-Decoder: ä¾‹å¦‚GPTï¼Œé€šè¿‡åœ¨å¤§è§„æ¨¡æ— æ ‡ç­¾æ–‡æœ¬ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œç„¶ååœ¨ç‰¹å®šä»»åŠ¡ä¸Šè¿›è¡Œå¾®è°ƒï¼Œå…·æœ‰å¾ˆå¼ºçš„ç”Ÿæˆèƒ½åŠ›å’Œè¯­è¨€ç†è§£èƒ½åŠ›ã€‚</li>
<li>Encoder-Decoderï¼šä¾‹å¦‚T5ï¼ˆText-to-Text Transfer Transformerï¼‰å¯ä»¥ç”¨äºå¤šç§è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼Œå¦‚æ–‡æœ¬åˆ†ç±»ã€æœºå™¨ç¿»è¯‘ã€é—®ç­”ç­‰ã€‚</li>
</ul>
<img src="/2025/03/19/LLM-Rela/v2-ee9b5d4a0761d2d1d10acb37cebefba3_1440w.jpg" class="" title="img">
<br>
<h3 id="Encoder-Decoder">Encoder&amp;Decoder</h3>
<img src="/2025/03/19/LLM-Rela/image-20250706100412469.png" class="" title="image-20250706100412469">
<p>ref: <a href="https://arxiv.org/abs/1706.03762">Attention is All You Need</a></p>
<br>
<img src="/2025/03/19/LLM-Rela/image-20250325195428329.png" class="" title="image-20250325195428329">
<p>Transformeræ¶æ„ä¸‹çš„å®Œæ•´æµç¨‹</p>
<p>å‡è®¾æˆ‘ä»¬è¦å°†è‹±æ–‡å¥å­ â€œI am a studentâ€ ç¿»è¯‘æˆä¸­æ–‡ â€œæˆ‘ æ˜¯ ä¸€å å­¦ç”Ÿâ€ã€‚</p>
<ul>
<li><strong>æºåºåˆ—</strong>: â€œI am a studentâ€ -&gt; <code>L_source = 4</code></li>
<li><strong>æ¨¡å‹ç»´åº¦</strong>: <code>d_model = 512</code> (ä¸ºäº†ä¸¾ä¾‹æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¿½ç•¥å¤šå¤´å’Œç»´åº¦<code>d_k</code>çš„åˆ‡åˆ†ï¼Œå‡è®¾<code>d_k = d_model</code>)</li>
</ul>
<p><strong>ç¬¬0æ­¥ï¼šç¼–ç å™¨å¤„ç†</strong></p>
<ol>
<li>è¾“å…¥ â€œI am a studentâ€ è¿›å…¥ç¼–ç å™¨ã€‚</li>
<li>ç»è¿‡å¤šå±‚è‡ªæ³¨æ„åŠ›å’Œå‰é¦ˆç½‘ç»œåï¼Œç¼–ç å™¨è¾“å‡ºä¸€ä¸ªä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å‘é‡åºåˆ—ã€‚</li>
<li>è¿™ä¸ªè¾“å‡ºçš„å½¢çŠ¶æ˜¯ <code>(batch_size=1, L_source=4, d_model=512)</code>ã€‚</li>
<li>è¿™ä¸ªè¾“å‡ºå°†ä½œä¸º<strong>å›ºå®šä¸å˜</strong>çš„ <code>K</code> å’Œ <code>V</code> æä¾›ç»™è§£ç å™¨çš„æ¯ä¸€ä¸ªæ—¶é—´æ­¥ã€‚æˆ‘ä»¬ç§°å®ƒä»¬ä¸º <code>K_encoder</code> å’Œ <code>V_encoder</code>ã€‚</li>
</ol>
<p><code>K_encoder</code> å½¢çŠ¶: <code>(1, 4, 512)</code><br>
<code>V_encoder</code> å½¢çŠ¶: <code>(1, 4, 512)</code></p>
<p><strong>ç¬¬1æ­¥ï¼šè§£ç å™¨ç”Ÿæˆç¬¬ä¸€ä¸ªtoken â€œæˆ‘â€</strong></p>
<ol>
<li>è§£ç å™¨çš„è¾“å…¥åªæœ‰ä¸€ä¸ªèµ·å§‹ç¬¦ <code>&lt;start&gt;</code>ã€‚</li>
<li>ç»è¿‡åµŒå…¥å’Œä½ç½®ç¼–ç åï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå‘é‡ï¼Œå½¢çŠ¶ä¸º <code>(1, 1, 512)</code>ã€‚</li>
<li>è¿™ä¸ªå‘é‡é¦–å…ˆé€šè¿‡<strong>å¸¦æ©ç çš„è‡ªæ³¨æ„åŠ›</strong>ï¼ˆåœ¨è¿™ä¸€æ­¥æ²¡ä»€ä¹ˆå¯æ³¨æ„çš„ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªtokenï¼‰ã€‚</li>
<li>ç„¶åï¼Œå®ƒçš„è¾“å‡ºä½œä¸º <code>Q</code> è¿›å…¥<strong>äº¤å‰æ³¨æ„åŠ›</strong>å±‚ã€‚
<ul>
<li><code>Q</code> å½¢çŠ¶: <code>(1, L_q=1, 512)</code></li>
<li><code>K</code> (æ¥è‡ªç¼–ç å™¨): <code>(1, L_k=4, 512)</code></li>
</ul>
</li>
<li>è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° <code>Q @ K^T</code>:
<ul>
<li><code>(1, 1, 512) @ (1, 512, 4)</code> -&gt; ç»“æœå½¢çŠ¶ <code>(1, 1, 4)</code></li>
<li>è¿™ä¸ª <code>(1, 1, 4)</code> çš„å‘é‡è¡¨ç¤º <code>&lt;start&gt;</code> ç¬¦ä¸ºäº†ç”Ÿæˆä¸‹ä¸€ä¸ªtokenï¼Œåº”è¯¥å¯¹ â€œIâ€, â€œamâ€, â€œaâ€, â€œstudentâ€ åˆ†åˆ«èµ‹äºˆå¤šå¤§çš„æ³¨æ„åŠ›ã€‚</li>
</ul>
</li>
<li>ç”¨è¿™ä¸ªåˆ†æ•°åŠ æƒ <code>V_encoder</code>ï¼Œç„¶åé€šè¿‡å‰é¦ˆç½‘ç»œï¼Œæœ€ç»ˆé¢„æµ‹å‡ºç¬¬ä¸€ä¸ªç›®æ ‡token â€œæˆ‘â€ã€‚</li>
</ol>
<p><strong>ç¬¬2æ­¥ï¼šè§£ç å™¨ç”Ÿæˆç¬¬äºŒä¸ªtoken â€œæ˜¯â€</strong></p>
<ol>
<li>ç°åœ¨è§£ç å™¨çš„è¾“å…¥æ˜¯ <code>&lt;start&gt; æˆ‘</code>ã€‚</li>
<li>ç»è¿‡åµŒå…¥å’Œä½ç½®ç¼–ç ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå‘é‡åºåˆ—ï¼Œå½¢çŠ¶ä¸º <code>(1, 2, 512)</code>ã€‚</li>
<li>è¿™ä¸ªåºåˆ—é€šè¿‡<strong>å¸¦æ©ç çš„è‡ªæ³¨æ„åŠ›</strong>ï¼ˆ&quot;æˆ‘&quot;ä¼šæ³¨æ„åˆ°<code>&lt;start&gt;</code>ï¼Œä½†åä¹‹ä¸è¡Œï¼Œå› ä¸ºæœ‰æ©ç ï¼‰ã€‚</li>
<li>å…¶è¾“å‡ºä½œä¸º <code>Q</code> è¿›å…¥<strong>äº¤å‰æ³¨æ„åŠ›</strong>å±‚ã€‚
<ul>
<li><code>Q</code> å½¢çŠ¶: <code>(1, L_q=2, 512)</code>  &lt;-- <strong>çœ‹ï¼ŒQçš„åºåˆ—é•¿åº¦ç»´åº¦å˜åŒ–äº†ï¼</strong></li>
<li><code>K</code> (æ¥è‡ªç¼–ç å™¨): <code>(1, L_k=4, 512)</code> &lt;-- <strong>Kä¿æŒä¸å˜ï¼</strong></li>
</ul>
</li>
<li>è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° <code>Q @ K^T</code>:
<ul>
<li><code>(1, 2, 512) @ (1, 512, 4)</code> -&gt; ç»“æœå½¢çŠ¶ <code>(1, 2, 4)</code></li>
<li>è¿™ä¸ª <code>(1, 2, 4)</code> çš„çŸ©é˜µåŒ…å«äº†ä¸¤è¡Œä¿¡æ¯ï¼š
<ul>
<li>ç¬¬ä¸€è¡Œï¼š<code>&lt;start&gt;</code> å¯¹æºåºåˆ—çš„æ³¨æ„åŠ›ï¼ˆé€šå¸¸åœ¨åç»­æ­¥éª¤ä¸­è¢«å¿½ç•¥ï¼Œå› ä¸ºæˆ‘ä»¬åªå…³å¿ƒæœ€åä¸€ä¸ªtokençš„é¢„æµ‹ï¼‰ã€‚</li>
<li>ç¬¬äºŒè¡Œï¼štoken â€œæˆ‘â€ ä¸ºäº†ç”Ÿæˆä¸‹ä¸€ä¸ªtokenï¼Œå¯¹ â€œIâ€, â€œamâ€, â€œaâ€, â€œstudentâ€ çš„æ³¨æ„åŠ›ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>è§£ç å™¨ä½¿ç”¨è¿™ä¸ªä¿¡æ¯ï¼ˆç‰¹åˆ«æ˜¯ä¸ â€œæˆ‘â€ ç›¸å…³çš„éƒ¨åˆ†ï¼‰æ¥é¢„æµ‹å‡ºç¬¬äºŒä¸ªtoken â€œæ˜¯â€ã€‚</li>
</ol>
<p><strong>ç¬¬3æ­¥åŠä»¥å</strong></p>
<p>è¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´é‡å¤ã€‚åœ¨ç”Ÿæˆç¬¬ <code>t</code> ä¸ªtokenæ—¶ï¼š</p>
<ul>
<li>è§£ç å™¨çš„è¾“å…¥æ˜¯ <code>&lt;start&gt;</code> åŠ ä¸Šå‰ <code>t-1</code> ä¸ªå·²ç”Ÿæˆçš„tokenã€‚</li>
<li>äº¤å‰æ³¨æ„åŠ›ä¸­çš„ <code>Q</code> çš„å½¢çŠ¶æ˜¯ <code>(1, L_q=t, 512)</code>ã€‚</li>
<li>äº¤å‰æ³¨æ„åŠ›ä¸­çš„ <code>K</code> å’Œ <code>V</code> çš„å½¢çŠ¶<strong>å§‹ç»ˆ</strong>æ˜¯ <code>(1, L_k=4, 512)</code>ã€‚</li>
<li>æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µçš„å½¢çŠ¶æ˜¯ <code>(1, t, 4)</code>ã€‚</li>
</ul>
<p>è¿™ä¸ªè¿‡ç¨‹ä¸€ç›´æŒç»­ï¼Œç›´åˆ°è§£ç å™¨ç”Ÿæˆä¸€ä¸ªç»“æŸç¬¦ <code>&lt;end&gt;</code>ã€‚</p>
<br>
<h3 id="Encoder-Only">Encoder Only</h3>
<img src="/2025/03/19/LLM-Rela/image-20250706105452257.png" class="" title="image-20250706105452257">
<p>ref: <a href="https://arxiv.org/abs/1810.04805">BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding</a></p>
<h3 id="Decoder-Only">Decoder Only</h3>
<img src="/2025/03/19/LLM-Rela/LLM-structure.png" class="" title="structure">
<img src="/2025/03/19/LLM-Rela/LLM-structure-moe.png" class="" title="structure-moe">
<p>ref: <a href="https://github.com/jingyaogong/minimind">minimind</a></p>
<p>decoder-only GPTæµç¨‹</p>
<p><strong>åŸºæœ¬ç»´åº¦è®¾å®šï¼š</strong></p>
<ul>
<li><code>batch_size</code> (B): ä¸€æ¬¡å¹¶è¡Œå¤„ç†çš„åºåˆ—æ•°é‡ã€‚</li>
<li><code>sequence_length</code> (L): è¾“å…¥åºåˆ—çš„é•¿åº¦ï¼ˆæˆ–æœ€å¤§ä¸Šä¸‹æ–‡çª—å£ï¼‰ã€‚</li>
<li><code>d_model</code> (D): æ¨¡å‹ç»´åº¦ï¼Œä¹Ÿæ˜¯æ¯ä¸ªtokenç»è¿‡Transformerå±‚åçš„éšè—çŠ¶æ€ç»´åº¦ã€‚</li>
<li><code>vocab_size</code> (V): è¯æ±‡è¡¨çš„å¤§å°ï¼Œå³æ¨¡å‹èƒ½ç”Ÿæˆæˆ–è¯†åˆ«çš„å”¯ä¸€è¯æ±‡çš„æ•°é‡ã€‚</li>
</ul>
<br>
<p><strong>Transformer Decoder Block å†…éƒ¨çš„è¾“å‡º (ç»è¿‡ Layer Norm ä¹‹å‰çš„ Feed Forward è¾“å‡ºï¼Œä»¥åŠæœ€ç»ˆ Layer Norm ä¹‹åçš„è¾“å‡º)</strong></p>
<p>åœ¨æ¯ä¸ª Transformer Decoder Block å†…éƒ¨ï¼Œ<code>Masked Multi Self Attention</code> å’Œ <code>Feed Forward</code> éƒ½ä¼šå¤„ç†è¾“å…¥ï¼Œå¹¶è¾“å‡ºä¸è¾“å…¥ç»´åº¦ç›¸åŒçš„å¼ é‡ã€‚</p>
<ul>
<li><strong>è¾“å…¥ <code>Text &amp; Position Embed</code> åçš„å¼ é‡ç»´åº¦ï¼š</strong> <code>(B, L, D)</code></li>
<li><strong>ç»è¿‡ <code>Masked Multi Self Attention</code> åçš„å¼ é‡ç»´åº¦ï¼š</strong> <code>(B, L, D)</code></li>
<li><strong>ç»è¿‡ç¬¬ä¸€ä¸ª <code>Layer Norm</code> åçš„å¼ é‡ç»´åº¦ï¼š</strong> <code>(B, L, D)</code></li>
<li><strong>ç»è¿‡ <code>Feed Forward</code> åçš„å¼ é‡ç»´åº¦ï¼š</strong> <code>(B, L, D)</code></li>
<li><strong>ç»è¿‡ç¬¬äºŒä¸ª <code>Layer Norm</code> åçš„å¼ é‡ç»´åº¦ï¼š</strong> <code>(B, L, D)</code></li>
</ul>
<p>è¿™ä¸ª <code>(B, L, D)</code> çš„å¼ é‡ä»£è¡¨äº†è¾“å…¥åºåˆ—ä¸­æ¯ä¸ªtokenåœ¨å½“å‰å±‚ç»è¿‡å¤„ç†åï¼Œæ‰€è·å¾—çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„éšè—çŠ¶æ€ï¼ˆæˆ–ç‰¹å¾å‘é‡ï¼‰ã€‚GPTæ¨¡å‹é€šå¸¸æœ‰å¤šä¸ªè¿™æ ·çš„Decoder Blockï¼ˆä¾‹å¦‚GPT-2æœ‰12å±‚ï¼ŒGPT-3æœ‰96å±‚ï¼‰ï¼Œæ¯ä¸€å±‚éƒ½ä¼šæ¥æ”¶ <code>(B, L, D)</code> çš„è¾“å…¥ï¼Œå¹¶è¾“å‡ºåŒæ ·ç»´åº¦çš„å¼ é‡ï¼Œä½œä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥ã€‚</p>
<br>
<p><strong>æ•´ä¸ªGPTæ¨¡å‹æœ€ç»ˆçš„è¾“å‡º (ç”¨äºæ–‡æœ¬é¢„æµ‹)</strong></p>
<p>å½“æ‰€æœ‰ <code>12x</code> ï¼ˆæˆ–æ›´å¤šï¼‰çš„Decoder Block å¤„ç†å®Œæˆåï¼Œæœ€åä¸€ä¸ªDecoder Block çš„è¾“å‡ºä¾ç„¶æ˜¯ <code>(B, L, D)</code>ã€‚</p>
<p>è¿™ä¸ª <code>(B, L, D)</code> å¼ é‡ï¼Œç°åœ¨åŒ…å«äº†æ¯ä¸ªtokenåœ¨<strong>æ‰€æœ‰å±‚</strong>å¤„ç†åã€å……åˆ†èåˆäº†ä¸Šä¸‹æ–‡ä¿¡æ¯çš„è¡¨ç¤ºã€‚</p>
<p>ä¸ºäº†é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼ŒGPTé€šå¸¸ä¼šåšä»¥ä¸‹å¤„ç†ï¼š</p>
<ol>
<li>
<p><strong>å–æœ€åä¸€ä¸ª token çš„éšè—çŠ¶æ€ï¼ˆç”¨äºç”Ÿæˆï¼‰ï¼š</strong></p>
<ul>
<li>åœ¨è‡ªå›å½’ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸åªå…³å¿ƒé¢„æµ‹åºåˆ—ä¸­<strong>ä¸‹ä¸€ä¸ªè¯</strong>ã€‚è¿™ä¸ªé¢„æµ‹æ˜¯åŸºäº<strong>å½“å‰è¾“å…¥åºåˆ—çš„å®Œæ•´ä¸Šä¸‹æ–‡</strong>ã€‚</li>
<li>è€Œæ ¹æ®æ©ç è‡ªæ³¨æ„åŠ›çš„åŸç†ï¼Œè¾“å…¥åºåˆ—ä¸­<strong>æœ€åä¸€ä¸ª token çš„éšè—çŠ¶æ€</strong>(<code>L-1</code> ç´¢å¼•ä½ç½®çš„ token) å·²ç»åŒ…å«äº†æ•´ä¸ªè¾“å…¥åºåˆ—ï¼ˆä»ç¬¬ä¸€ä¸ª token åˆ°æœ€åä¸€ä¸ª tokenï¼‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li>
<li>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šä» <code>(B, L, D)</code> è¿™ä¸ªå¼ é‡ä¸­ï¼Œå–å‡º**æœ€åä¸€ä¸ªæ—¶é—´æ­¥ï¼ˆ<code>L-1</code> ç´¢å¼•ï¼‰**çš„éšè—çŠ¶æ€ã€‚</li>
<li>è¿™ä¸ªæ“ä½œä¼šå¾—åˆ°ä¸€ä¸ªç»´åº¦ä¸º <code>(B, D)</code> çš„å¼ é‡ã€‚</li>
</ul>
</li>
<li>
<p><strong>çº¿æ€§æŠ•å½±åˆ°è¯æ±‡è¡¨å¤§å°ï¼š</strong></p>
<ul>
<li>è¿™ä¸ª <code>(B, D)</code> çš„å¼ é‡ä¼šè¢«é€å…¥ä¸€ä¸ª<strong>çº¿æ€§å±‚ï¼ˆLinear Layerï¼‰</strong>ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¸ºâ€œè¯­è¨€æ¨¡å‹å¤´ï¼ˆLanguage Model Headï¼‰â€æˆ–â€œæ–‡æœ¬é¢„æµ‹å¤´ï¼ˆText Prediction Headï¼‰â€ã€‚</li>
<li>è¿™ä¸ªçº¿æ€§å±‚çš„æƒé‡çŸ©é˜µç»´åº¦æ˜¯ <code>(D, V)</code>ã€‚</li>
<li>çº¿æ€§å±‚è¿›è¡ŒçŸ©é˜µä¹˜æ³•ï¼š<code>(B, D) @ (D, V) = (B, V)</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>æœ€ç»ˆè¾“å‡ºç»´åº¦ï¼š</strong></p>
<ul>
<li>æ‰€ä»¥ï¼Œç”¨äºé¢„æµ‹ä¸‹ä¸€ä¸ªè¯çš„**åŸå§‹é€»è¾‘å€¼ï¼ˆlogitsï¼‰**çš„å¼ é‡ç»´åº¦æ˜¯ <code>(B, V)</code>ã€‚</li>
<li>æ¯ä¸€è¡Œï¼ˆç»´åº¦ä¸º <code>V</code>ï¼‰ä»£è¡¨äº†è¯¥æ‰¹æ¬¡ä¸­ä¸€ä¸ªåºåˆ—çš„ä¸‹ä¸€ä¸ªè¯åœ¨è¯æ±‡è¡¨ä¸Šçš„æ¦‚ç‡åˆ†å¸ƒï¼ˆåœ¨ç»è¿‡ Softmax æ¿€æ´»å‡½æ•°ä¹‹å‰ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p>GPTåœ¨è®­ç»ƒé˜¶æ®µï¼ˆæˆ–æ ‡å‡†çš„è‡ªå›å½’ç”Ÿæˆæ—¶ï¼‰ï¼Œæœ€åä»Decoderå±‚è¾“å‡ºçš„å¼ é‡ç»´åº¦é€šå¸¸æ˜¯ <code>(batch_size, sequence_length, d_model)</code>ã€‚ä½†æ˜¯ï¼Œä¸ºäº†è¿›è¡Œä¸‹ä¸€ä¸ªè¯çš„é¢„æµ‹ï¼Œå®ƒä¼šä¸“é—¨<strong>æå–æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¡¨ç¤º</strong>ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚å°†å…¶æŠ•å½±åˆ°è¯æ±‡è¡¨å¤§å°çš„ç»´åº¦ï¼Œæœ€ç»ˆå¾—åˆ° <code>(batch_size, vocab_size)</code> çš„ logits å¼ é‡ã€‚</p>
<br>
<h3 id="Tokenizer">Tokenizer</h3>
<p>åˆ†è¯è¡¨</p>
<p>æ¡ˆä¾‹ï¼šBPE (Byte Pair Encoding)  ref: <a href="https://arxiv.org/pdf/2309.16609">QWEN TECHNICAL REPORT</a></p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹éå¸¸å°çš„æ–‡æœ¬è¯­æ–™åº“ï¼š</p>
<p><code>&quot;low low low low low low low low low low&quot;</code><br>
<code>&quot;lower lower lower lower lower lower lower lower&quot;</code><br>
<code>&quot;newest newest newest newest&quot;</code><br>
<code>&quot;widest widest widest widest&quot;</code></p>
<p>å¹¶ä¸”æˆ‘ä»¬å¸Œæœ›é€šè¿‡ BPE æ¥æ„å»ºä¸€ä¸ªè¯æ±‡è¡¨ã€‚æœ€åˆï¼Œæˆ‘ä»¬çš„â€œè¯æ±‡è¡¨â€å¯èƒ½åªåŒ…å«æ‰€æœ‰çš„ç‹¬ç«‹å­—ç¬¦ã€‚</p>
<p><strong>åˆå§‹çŠ¶æ€ï¼š</strong></p>
<ul>
<li><strong>è¯­æ–™ä¸­çš„ç‹¬ç«‹å­—ç¬¦ï¼ˆåˆå§‹tokenï¼‰ï¼š</strong> <code>l, o, w, e, r, n, s, t, i, d</code> (ä»¥åŠä¸€ä¸ªç©ºæ ¼å­—ç¬¦ï¼Œæˆ‘ä»¬è¿™é‡Œä¸ºäº†ç®€åŒ–æš‚æ—¶å¿½ç•¥å®ƒï¼Œä½†å®é™…BPEä¼šå¤„ç†æ‰€æœ‰å­—èŠ‚)</li>
<li><strong>å½“å‰è¯æ±‡è¡¨ï¼š</strong> <code>[l, o, w, e, r, n, s, t, i, d]</code></li>
</ul>
<p><strong>BPE æ­¥éª¤ï¼š</strong></p>
<p>BPE çš„æ ¸å¿ƒæ˜¯<strong>è¿­ä»£åœ°å¯»æ‰¾è¯­æ–™ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„â€œå­—èŠ‚å¯¹â€ï¼ˆæˆ–å­—ç¬¦å¯¹ï¼‰å¹¶å°†å…¶åˆå¹¶æˆä¸€ä¸ªæ–°çš„å•å…ƒã€‚</strong></p>
<p><strong>ç¬¬ä¸€æ¬¡è¿­ä»£ï¼š</strong></p>
<ol>
<li>
<p><strong>ç»Ÿè®¡å­—ç¬¦å¯¹é¢‘ç‡ï¼š</strong></p>
<ul>
<li><code>lo</code>: å‡ºç°å¾ˆå¤šæ¬¡ï¼ˆæ¥è‡ª â€œlowâ€, â€œlowerâ€ï¼‰</li>
<li><code>ow</code>: å‡ºç°å¾ˆå¤šæ¬¡ï¼ˆæ¥è‡ª â€œlowâ€, â€œlowerâ€ï¼‰</li>
<li><code>er</code>: å‡ºç°å¾ˆå¤šæ¬¡ï¼ˆæ¥è‡ª â€œlowerâ€ï¼‰</li>
<li><code>ne</code>: å‡ºç°å¤šæ¬¡ï¼ˆæ¥è‡ª â€œnewestâ€ï¼‰</li>
<li><code>es</code>: å‡ºç°å¤šæ¬¡ï¼ˆæ¥è‡ª â€œnewestâ€ï¼‰</li>
<li><code>st</code>: å‡ºç°å¤šæ¬¡ï¼ˆæ¥è‡ª â€œnewestâ€, â€œwidestâ€ï¼‰</li>
<li><code>wi</code>: å‡ºç°å¤šæ¬¡ï¼ˆæ¥è‡ª â€œwidestâ€ï¼‰</li>
<li><code>id</code>: å‡ºç°å¤šæ¬¡ï¼ˆæ¥è‡ª â€œwidestâ€ï¼‰</li>
<li><code>de</code>: å‡ºç°å¤šæ¬¡ï¼ˆæ¥è‡ª â€œwidestâ€ï¼‰</li>
</ul>
</li>
<li>
<p><strong>æ‰¾åˆ°é¢‘ç‡æœ€é«˜çš„å¯¹ï¼š</strong> å‡è®¾ <code>(l, o)</code> å’Œ <code>(o, w)</code> çš„é¢‘ç‡éå¸¸é«˜ï¼ˆå› ä¸º â€œlowâ€ å’Œ â€œlowerâ€ éƒ½åŒ…å«å®ƒä»¬ï¼‰ã€‚<br>
æˆ‘ä»¬é€‰æ‹© <code>(l, o)</code> å’Œ <code>(o, w)</code> è¿›è¡Œåˆå¹¶ã€‚ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å…ˆåˆå¹¶ <code>(l, o)</code>ã€‚</p>
</li>
<li>
<p><strong>åˆå¹¶ <code>lo</code>ï¼š</strong> å°†æ‰€æœ‰ <code>l o</code> æ›¿æ¢ä¸ºæ–°çš„ token <code>lo</code>ã€‚</p>
<ul>
<li><code>&quot;low low ...&quot;</code> å˜æˆ <code>&quot;low low ...&quot;</code> (lo ä¾ç„¶æ˜¯ loï¼Œä½†ç°åœ¨æ˜¯ä¸€ä¸ªæ•´ä½“token)</li>
<li><code>&quot;lower lower ...&quot;</code> å˜æˆ <code>&quot;lower lower ...&quot;</code></li>
<li><strong>æ–°çš„è¯æ±‡è¡¨ï¼š</strong> <code>[l, o, w, e, r, n, s, t, i, d, lo]</code></li>
</ul>
</li>
</ol>
<p><strong>ç¬¬äºŒæ¬¡è¿­ä»£ï¼š</strong></p>
<ol>
<li>
<p><strong>ç»Ÿè®¡æ–°çš„å­—ç¬¦/token å¯¹é¢‘ç‡ï¼š</strong></p>
<ul>
<li>ç°åœ¨ <code>(lo, w)</code> å‡ºç°çš„é¢‘ç‡å¾ˆé«˜ï¼ˆæ¥è‡ª â€œlowâ€, â€œlowerâ€ï¼‰</li>
<li><code>(e, r)</code> é¢‘ç‡å¾ˆé«˜</li>
<li><code>(n, e)</code> é¢‘ç‡å¾ˆé«˜</li>
<li><code>(e, s)</code> é¢‘ç‡å¾ˆé«˜</li>
<li><code>(s, t)</code> é¢‘ç‡å¾ˆé«˜</li>
</ul>
</li>
<li>
<p><strong>æ‰¾åˆ°é¢‘ç‡æœ€é«˜çš„å¯¹ï¼š</strong> å‡è®¾ <code>(lo, w)</code> æ˜¯é¢‘ç‡æœ€é«˜çš„å¯¹ã€‚</p>
</li>
<li>
<p><strong>åˆå¹¶ <code>low</code>ï¼š</strong> å°†æ‰€æœ‰ <code>lo w</code> æ›¿æ¢ä¸ºæ–°çš„ token <code>low</code>ã€‚</p>
<ul>
<li><code>&quot;low low ...&quot;</code> å˜æˆ <code>&quot;low low ...&quot;</code> (ç°åœ¨ <code>low</code> æ˜¯ä¸€ä¸ªæ•´ä½“ token)</li>
<li><code>&quot;lower lower ...&quot;</code> ä¸­çš„ <code>low</code> ä¹Ÿå˜æˆä¸€ä¸ªæ•´ä½“ tokenã€‚</li>
<li><strong>æ–°çš„è¯æ±‡è¡¨ï¼š</strong> <code>[l, o, w, e, r, n, s, t, i, d, lo, low]</code></li>
</ul>
</li>
</ol>
<p><strong>ç¬¬ä¸‰æ¬¡è¿­ä»£ï¼š</strong></p>
<ol>
<li>
<p><strong>ç»Ÿè®¡æ–°çš„å­—ç¬¦/token å¯¹é¢‘ç‡ï¼š</strong></p>
<ul>
<li><code>(low, er)</code> å‡ºç°é¢‘ç‡å¾ˆé«˜ï¼ˆæ¥è‡ª â€œlowerâ€ï¼‰</li>
<li><code>(n, ew)</code> (å¦‚æœ <code>ew</code> è¢«åˆå¹¶äº†)</li>
<li><code>(ne, st)</code></li>
<li><code>(wi, de)</code> (å¦‚æœ <code>de</code> è¢«åˆå¹¶äº†)</li>
</ul>
</li>
<li>
<p><strong>æ‰¾åˆ°é¢‘ç‡æœ€é«˜çš„å¯¹ï¼š</strong> å‡è®¾ <code>(low, er)</code> æ˜¯é¢‘ç‡æœ€é«˜çš„å¯¹ã€‚</p>
</li>
<li>
<p><strong>åˆå¹¶ <code>lower</code>ï¼š</strong> å°†æ‰€æœ‰ <code>low er</code> æ›¿æ¢ä¸ºæ–°çš„ token <code>lower</code>ã€‚</p>
<ul>
<li><code>&quot;lower lower ...&quot;</code> å˜æˆ <code>&quot;lower lower ...&quot;</code> (ç°åœ¨ <code>lower</code> æ˜¯ä¸€ä¸ªæ•´ä½“ token)</li>
<li><strong>æ–°çš„è¯æ±‡è¡¨ï¼š</strong> <code>[l, o, w, e, r, n, s, t, i, d, lo, low, lower]</code></li>
</ul>
</li>
</ol>
<p><strong>ç»§ç»­è¿­ä»£â€¦</strong></p>
<p>è¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´é‡å¤ï¼š</p>
<ul>
<li>ç»Ÿè®¡å½“å‰æ‰€æœ‰ token åºåˆ—ä¸­<strong>ç›¸é‚» token å¯¹</strong>çš„é¢‘ç‡ã€‚</li>
<li>é€‰æ‹©é¢‘ç‡æœ€é«˜çš„å¯¹ã€‚</li>
<li>å°†è¯¥å¯¹åˆå¹¶æˆä¸€ä¸ªæ–°çš„ã€æ›´é•¿çš„ tokenã€‚</li>
<li>å°†æ–° token åŠ å…¥è¯æ±‡è¡¨ã€‚</li>
<li>æ›´æ–°è¯­æ–™ä¸­çš„è¡¨ç¤ºï¼ˆå°†æ—§çš„å¯¹æ›¿æ¢ä¸ºæ–°çš„ tokenï¼‰ã€‚</li>
</ul>
<br>
<p>å¯¹åº”äºé¡¹ç›®ä¸­çš„ <code>tokenizer.json</code> æ–‡ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„ç»„ä»¶ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯å°†äººç±»å¯è¯»çš„æ–‡æœ¬è½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„æ•°å­— ID åºåˆ—ã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºæ¨¡å‹çš„â€œå­—å…¸â€æˆ–â€œç¼–ç å™¨â€ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œ<code>tokenizer.json</code> æ–‡ä»¶ä¸­åŒ…å«äº†ï¼š</p>
<ol>
<li><strong>è¯è¡¨ï¼ˆVocabularyï¼‰</strong>ï¼šè¿™æ˜¯æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå®ƒåˆ—å‡ºäº†åˆ†è¯å™¨è¯†åˆ«çš„æ‰€æœ‰è¯å…ƒï¼ˆtokensï¼‰ï¼Œæ¯ä¸ªè¯å…ƒéƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„æ•°å­— IDã€‚è¿™äº›è¯å…ƒå¯ä»¥æ˜¯å•ä¸ªå­—ç¬¦ã€å¸¸ç”¨å•è¯ã€è¯æ ¹ã€è¯ç¼€ç”šè‡³æ˜¯ä¸è§„åˆ™çš„å­è¯å•å…ƒï¼ˆsubword unitsï¼‰ï¼Œä¾‹å¦‚é€šè¿‡BPEï¼ˆByte Pair Encodingï¼‰æˆ–WordPieceç­‰ç®—æ³•ç”Ÿæˆçš„ã€‚</li>
<li><strong>åˆ†è¯è§„åˆ™ï¼ˆTokenization Rulesï¼‰</strong>ï¼šé™¤äº†è¯è¡¨æœ¬èº«ï¼Œ<code>tokenizer.json</code> è¿˜å®šä¹‰äº†å¦‚ä½•å°†åŸå§‹æ–‡æœ¬æ‹†åˆ†æˆè¿™äº›è¯å…ƒåºåˆ—çš„è§„åˆ™ã€‚è¿™åŒ…æ‹¬é¢„å¤„ç†æ­¥éª¤ï¼ˆå¦‚å¤§å°å†™è½¬æ¢ã€æ ‡ç‚¹ç¬¦å·å¤„ç†ï¼‰ã€åˆ†è¯ç®—æ³•çš„é…ç½®ä»¥åŠå¦‚ä½•å¤„ç†æœªçŸ¥è¯å…ƒï¼ˆOut-Of-Vocabulary, OOVï¼‰ç­‰ã€‚</li>
</ol>
<p><strong>è¯è¡¨å¤§å°ï¼ˆVocabulary Sizeï¼‰</strong> æŒ‡çš„æ˜¯ <strong><code>tokenizer.json</code> ä¸­å®šä¹‰çš„è¯å…ƒæ•°é‡</strong>ï¼ˆå³è¯è¡¨ä¸­è¯å…ƒIDçš„æœ€å¤§å€¼åŠ ä¸€ï¼‰ï¼Œå†åŠ ä¸Š <strong>æ¨¡å‹æˆ–åˆ†è¯å™¨é¢„è®¾çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆSpecial Tokensï¼‰çš„æ•°é‡</strong>ã€‚</p>
<p><strong>ç‰¹æ®Šå­—ç¬¦</strong>é€šå¸¸åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong><code>[CLS]</code> (Classification Token)</strong>ï¼šåœ¨BERTç­‰æ¨¡å‹ä¸­ç”¨äºè¡¨ç¤ºå¥å­çš„å¼€å¤´ï¼Œå…¶è¾“å‡ºå¸¸ç”¨äºåˆ†ç±»ä»»åŠ¡ã€‚</li>
<li><strong><code>[SEP]</code> (Separation Token)</strong>ï¼šç”¨äºåˆ†éš”ä¸åŒçš„å¥å­æˆ–æ–‡æœ¬ç‰‡æ®µã€‚</li>
<li><strong><code>[PAD]</code> (Padding Token)</strong>ï¼šç”¨äºå°†ä¸åŒé•¿åº¦çš„åºåˆ—å¡«å……åˆ°ç›¸åŒçš„é•¿åº¦ï¼Œä»¥ä¾¿äºæ‰¹å¤„ç†ã€‚</li>
<li><strong><code>[UNK]</code> (Unknown Token)</strong>ï¼šå½“åˆ†è¯å™¨é‡åˆ°ä¸åœ¨è¯è¡¨ä¸­çš„è¯å…ƒæ—¶ï¼Œä¼šç”¨æ­¤æ ‡è®°æ›¿ä»£ã€‚</li>
<li><strong><code>[MASK]</code> (Mask Token)</strong>ï¼šåœ¨é¢„è®­ç»ƒä»»åŠ¡ï¼ˆå¦‚æ©ç è¯­è¨€æ¨¡å‹ï¼‰ä¸­ç”¨äºæ›¿æ¢è¢«é®è”½çš„è¯å…ƒã€‚</li>
</ul>
<p>å› æ­¤ï¼Œ<strong>è¯è¡¨å¤§å° = <code>tokenizer.json</code> ä¸­å”¯ä¸€è¯å…ƒçš„æ•°é‡ + ç‰¹æ®Šå­—ç¬¦çš„æ•°é‡</strong>ã€‚è¿™ä¸ªå¤§å°ç›´æ¥å†³å®šäº†æ¨¡å‹èƒ½å¤Ÿç†è§£å’Œè¡¨ç¤ºçš„è¯å…ƒç§ç±»ï¼Œä¹Ÿå½±å“ç€æ¨¡å‹çš„å‚æ•°é‡å’Œæ€§èƒ½ã€‚</p>
<br>
<h3 id="Embedding">Embedding</h3>
<p>å°† <strong>token ID åºåˆ—</strong> è½¬æ¢ä¸º <strong>è¿ç»­çš„ã€ç¨ å¯†çš„å‘é‡è¡¨ç¤º</strong></p>
<p>ä¾‹å¦‚ï¼Œ</p>
<ol>
<li>
<p><strong>åŸå§‹æ–‡æœ¬:</strong> â€œThe cat sat on the mat.â€</p>
</li>
<li>
<p><strong>åˆ†è¯å™¨ (Tokenizer):</strong></p>
<ul>
<li>å°†åŸå§‹æ–‡æœ¬åˆ†è§£æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„å•å…ƒï¼Œé€šå¸¸æ˜¯è¯ï¼ˆwordï¼‰æˆ–å­è¯ï¼ˆsubwordï¼‰ã€‚</li>
<li>ä¾‹å¦‚ï¼š<code>[&quot;The&quot;, &quot;cat&quot;, &quot;sat&quot;, &quot;on&quot;, &quot;the&quot;, &quot;mat&quot;, &quot;.&quot;]</code></li>
<li>åˆ†è¯å™¨è¿˜ä¼šå°†è¿™äº›è¯/å­è¯æ˜ å°„åˆ°å®ƒä»¬å¯¹åº”çš„<strong>æ•´æ•°ID (Integer ID)</strong>ã€‚</li>
<li>ä¾‹å¦‚ï¼š<code>[101, 234, 567, 890, 101, 321, 999]</code> (è¿™åªæ˜¯ç¤ºä¾‹ID)</li>
</ul>
</li>
<li>
<p><strong>Embedding å±‚:</strong></p>
<ul>
<li>æ¨¡å‹æ¥æ”¶çš„è¾“å…¥æ˜¯è¿™äº›<strong>æ•´æ•°IDåºåˆ—</strong>ã€‚</li>
<li>Embeddingå±‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>æŸ¥æ‰¾è¡¨ï¼ˆlookup tableï¼‰</strong>ã€‚</li>
<li>å½“æ¥æ”¶åˆ°ä¸€ä¸ªæ•´æ•°IDæ—¶ï¼Œå®ƒä¼šå»è¿™ä¸ªæŸ¥æ‰¾è¡¨ä¸­æ‰¾åˆ°è¯¥IDå¯¹åº”çš„<strong>é¢„è®­ç»ƒå¥½çš„ï¼ˆæˆ–éšæœºåˆå§‹åŒ–ååœ¨è®­ç»ƒä¸­å­¦ä¹ åˆ°çš„ï¼‰ä½ç»´ã€ç¨ å¯†çš„æµ®ç‚¹æ•°å‘é‡</strong>ã€‚</li>
<li>ä¾‹å¦‚ï¼ŒID <code>234</code> (å¯¹åº”â€œcatâ€) å¯èƒ½è¢«æŸ¥æ‰¾åˆ°ä¸€ä¸ªåƒ <code>[0.1, -0.3, 0.8, ..., 0.5]</code> è¿™æ ·çš„512ç»´å‘é‡ã€‚</li>
<li>è¿™äº›å‘é‡å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„<strong>è¯å‘é‡ï¼ˆWord Embeddingsï¼‰<strong>æˆ–</strong>è¯åµŒå…¥</strong>ã€‚</li>
<li>è¿™äº›è¯å‘é‡çš„ç‰¹ç‚¹æ˜¯ï¼š
<ul>
<li><strong>ä½ç»´ï¼š</strong> ç›¸æ¯”ç‹¬çƒ­ç¼–ç çš„è¯æ±‡è¡¨å¤§å°ï¼Œè¯å‘é‡çš„ç»´åº¦é€šå¸¸æ˜¯å‡ ååˆ°å‡ ç™¾ï¼ˆä¾‹å¦‚ï¼Œ50, 100, 300, 512, 768ç­‰ï¼‰ã€‚</li>
<li><strong>ç¨ å¯†ï¼š</strong> å‘é‡ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªéé›¶çš„æµ®ç‚¹æ•°ã€‚</li>
<li><strong>è¯­ä¹‰ä¿¡æ¯ï¼š</strong> é€šè¿‡å¤§é‡çš„è¯­æ–™åº“è®­ç»ƒï¼Œè¿™äº›å‘é‡èƒ½å¤Ÿæ•æ‰è¯è¯­çš„è¯­ä¹‰å’Œè¯­æ³•ä¿¡æ¯ï¼Œä½¿å¾—è¯­ä¹‰ç›¸ä¼¼çš„è¯åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<br>
<p>æ¡ˆä¾‹ï¼šWord2Vecè®­ç»ƒæ–¹æ³•</p>
<p>Word2Vecçš„CBOWï¼ˆContinuous Bag of Wordsï¼‰æ¨¡å‹æ˜¯ä¸€ç§é€šè¿‡ä¸Šä¸‹æ–‡è¯é¢„æµ‹ç›®æ ‡è¯çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚ä»¥ä¸‹æ˜¯å…¶è®­ç»ƒæµç¨‹çš„è¯¦ç»†è¯´æ˜ï¼Œå¹¶ç»“åˆå…·ä½“ä¾‹å­è¿›è¡Œè§£é‡Šï¼š</p>
<ol>
<li>æ•°æ®å‡†å¤‡</li>
</ol>
<p>é¦–å…ˆï¼Œéœ€è¦å‡†å¤‡è®­ç»ƒæ•°æ®ï¼Œé€šå¸¸æ˜¯å¤§é‡çš„æ–‡æœ¬è¯­æ–™ã€‚æ–‡æœ¬æ•°æ®éœ€è¦è¿›è¡Œåˆ†è¯ç­‰é¢„å¤„ç†ï¼Œå°†æ–‡æœ¬è½¬æ¢ä¸ºè¯è¯­åºåˆ—ã€‚ä¾‹å¦‚ï¼Œå¥å­â€œI learn NLP everydayâ€ä¼šè¢«åˆ†è¯ä¸º<code>[&quot;I&quot;, &quot;learn&quot;, &quot;NLP&quot;, &quot;everyday&quot;]</code>ã€‚</p>
<ol>
<li>
<p>åˆ›å»ºä¸Šä¸‹æ–‡çª—å£</p>
<p>å¯¹äºæ¯ä¸ªç›®æ ‡è¯ï¼ŒCBOWæ¨¡å‹å®šä¹‰äº†ä¸€ä¸ªä¸Šä¸‹æ–‡çª—å£ã€‚çª—å£å¤§å°ç”±è¶…å‚æ•°<code>window</code>æŒ‡å®šï¼Œè¡¨ç¤ºç›®æ ‡è¯å·¦å³ä¸¤ä¾§çš„è¯è¯­æ•°ç›®ã€‚ä¾‹å¦‚ï¼Œçª—å£å¤§å°ä¸º2æ—¶ï¼Œç›®æ ‡è¯â€œNLPâ€çš„ä¸Šä¸‹æ–‡è¯ä¸º<code>[&quot;I&quot;, &quot;learn&quot;, &quot;everyday&quot;]</code>ã€‚</p>
</li>
<li>
<p>æ„å»ºè®­ç»ƒæ ·æœ¬</p>
<p>å¯¹äºæ¯ä¸ªç›®æ ‡è¯ï¼ŒCBOWæ¨¡å‹ä»å…¶ä¸Šä¸‹æ–‡çª—å£ä¸­æ”¶é›†ä¸Šä¸‹æ–‡è¯ã€‚æ¯ä¸ªè®­ç»ƒæ ·æœ¬ç”±ä¸Šä¸‹æ–‡è¯æ„æˆï¼Œç›®æ ‡æ˜¯é¢„æµ‹ç›®æ ‡è¯ã€‚ä¾‹å¦‚ï¼Œç›®æ ‡è¯â€œNLPâ€çš„è®­ç»ƒæ ·æœ¬ä¸º<code>&#123;&quot;context&quot;: [&quot;I&quot;, &quot;learn&quot;, &quot;everyday&quot;], &quot;target&quot;: &quot;NLP&quot;&#125;</code>ã€‚</p>
</li>
<li>
<p>æ¨¡å‹ç»“æ„</p>
<p>CBOWæ¨¡å‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¸‰å±‚ç¥ç»ç½‘ç»œï¼ŒåŒ…æ‹¬è¾“å…¥å±‚ã€éšè—å±‚å’Œè¾“å‡ºå±‚ï¼š - <strong>è¾“å…¥å±‚</strong>ï¼šä¸Šä¸‹æ–‡è¯ç”¨one-hotå‘é‡è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œè¯æ±‡è¡¨å¤§å°ä¸º10,000ï¼Œå•è¯â€œIâ€å¯èƒ½è¡¨ç¤ºä¸º<code>[1, 0, 0, ..., 0]</code>ã€‚ - <strong>éšè—å±‚</strong>ï¼šé€šè¿‡è¯å‘é‡çŸ©é˜µï¼ˆEmbedding Matrixï¼‰å°†è¾“å…¥çš„one-hotå‘é‡è½¬æ¢ä¸ºä½ç»´è¯å‘é‡ï¼ˆé€šå¸¸æ˜¯100ï½300ç»´ï¼‰ã€‚ç„¶åå°†æ‰€æœ‰ä¸Šä¸‹æ–‡è¯çš„è¯å‘é‡ç›¸åŠ å–å¹³å‡ï¼Œä½œä¸ºéšè—å±‚å‘é‡ã€‚ - <strong>è¾“å‡ºå±‚</strong>ï¼šéšè—å±‚å‘é‡ä¹˜ä»¥è¾“å‡ºæƒé‡çŸ©é˜µï¼Œå¾—åˆ°è¾“å‡ºå‘é‡ã€‚ä½¿ç”¨Softmaxå‡½æ•°è®¡ç®—ç›®æ ‡è¯çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p>
</li>
<li>
<p>è®­ç»ƒç›®æ ‡</p>
<p>CBOWæ¨¡å‹çš„è®­ç»ƒç›®æ ‡æ˜¯æœ€å¤§åŒ–ç»™å®šä¸Šä¸‹æ–‡è¯æ—¶ç›®æ ‡è¯çš„æ¡ä»¶æ¦‚ç‡ï¼Œå³æœ€å¤§åŒ–$P(w_t | w_{t-c}, w_{t-c+1}, â€¦, w_{t+c})$ï¼Œå…¶ä¸­$w_t$æ˜¯ç›®æ ‡è¯ï¼Œ$w_{t-c}$åˆ°$w_{t+c}$æ˜¯ä¸Šä¸‹æ–‡è¯ã€‚</p>
</li>
<li>
<p>æ¢¯åº¦ä¸‹é™</p>
<p>ä½¿ç”¨æ¢¯åº¦ä¸‹é™æˆ–å…¶å˜ç§ï¼Œé€šè¿‡åå‘ä¼ æ’­ç®—æ³•è°ƒæ•´åµŒå…¥å±‚çš„æƒé‡ï¼Œä½¿å¾—æ¨¡å‹çš„é¢„æµ‹æ›´æ¥è¿‘å®é™…çš„ç›®æ ‡è¯ã€‚</p>
</li>
<li>
<p>é‡å¤è¿­ä»£</p>
<p>é‡å¤ä»¥ä¸Šæ­¥éª¤å¤šæ¬¡ï¼Œç›´åˆ°æ¨¡å‹æ”¶æ•›åˆ°ä¸€ä¸ªåˆé€‚çš„çŠ¶æ€ã€‚æ¯ä¸€è½®è¿­ä»£éƒ½éå†æ•´ä¸ªè®­ç»ƒæ•°æ®ã€‚</p>
</li>
</ol>
<br>
<p>ä¾‹å­</p>
<p>å‡è®¾è¯­æ–™ä¸ºâ€œI learn NLP everydayâ€ï¼Œç›®æ ‡è¯ä¸ºâ€œNLPâ€ï¼Œä¸Šä¸‹æ–‡è¯ä¸º<code>[&quot;I&quot;, &quot;learn&quot;, &quot;everyday&quot;]</code>ï¼š</p>
<ol>
<li>å°†ä¸Šä¸‹æ–‡è¯è½¬æ¢ä¸ºone-hotå‘é‡ã€‚</li>
<li>å°†one-hotå‘é‡ä¹˜ä»¥è¾“å…¥æƒé‡çŸ©é˜µï¼Œå¾—åˆ°è¯å‘é‡ã€‚</li>
<li>å°†æ‰€æœ‰ä¸Šä¸‹æ–‡è¯çš„è¯å‘é‡ç›¸åŠ å–å¹³å‡ï¼Œå¾—åˆ°éšè—å±‚å‘é‡ã€‚</li>
<li>å°†éšè—å±‚å‘é‡ä¹˜ä»¥è¾“å‡ºæƒé‡çŸ©é˜µï¼Œå¾—åˆ°è¾“å‡ºå‘é‡ã€‚</li>
<li>ä½¿ç”¨Softmaxå‡½æ•°è®¡ç®—ç›®æ ‡è¯â€œNLPâ€çš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li>é€šè¿‡æŸå¤±å‡½æ•°ï¼ˆå¦‚è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼‰è®¡ç®—é¢„æµ‹è¯¯å·®ï¼Œå¹¶ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ›´æ–°æ¨¡å‹å‚æ•°ã€‚</li>
</ol>
<p>ä»¥ä¸Šä¾¿æ˜¯CBOWæ¨¡å‹çš„å®Œæ•´è®­ç»ƒæµç¨‹ã€‚</p>
<br>
<h3 id="Positional-Encoding">Positional Encoding</h3>
<p>è¯å‘é‡ â†’ å«ä½ç½®ä¿¡æ¯è¯å‘é‡ï¼ŒåŠ å…¥ä½ç½®ä¿¡æ¯ï¼ˆå¤šä¸ªæ­£å¼¦å‡½æ•°ï¼‰åˆ°è¯å‘é‡</p>
<h4 id="Base">Base</h4>
<p>$$<br>
PE_{(pos,2i)}=sin(pos/10000^{2i/d_{model}})<br>
$$</p>
<p>$$<br>
PE_{(pos,2i+1)}=cos(pos/10000^{2i/d_{model}})<br>
$$</p>
<p>å…¶ä¸­ï¼Œ$pos$ è¡¨ç¤ºè¯¥tokenåœ¨tokenåºåˆ—ä¸­çš„ä½ç½®ï¼Œ$i$ è¡¨ç¤º $d_{model}$ ä¸­çš„ç¬¬ $i$ ä¸ªç»´åº¦</p>
<p>ref: <a href="https://arxiv.org/abs/1706.03762">Attention is All You Need</a></p>
<br>
<h4 id="RoPE">RoPE</h4>
<br>
<h3 id="Attention">Attention</h3>
<p>Transformeræ¨¡å‹ä¸­éšè—å±‚ï¼ˆhidden layerï¼‰çš„ç»´åº¦å¤§å°ï¼Œä¹Ÿå°±æ˜¯æ¨¡å‹å®½åº¦ï¼ˆmodel widthï¼‰</p>
<p>åœ¨Transformeræ¶æ„ä¸­ï¼Œè¿™é€šå¸¸å¯¹åº”äºï¼š</p>
<ul>
<li>æ¯ä¸ªTransformerå±‚çš„è¾“å…¥/è¾“å‡ºç»´åº¦ï¼ˆå³éšè—çŠ¶æ€çš„ç»´åº¦d_modelï¼‰</li>
<li>æ³¨æ„åŠ›æœºåˆ¶ä¸­Q/K/Vå‘é‡çš„è¡Œç»´åº¦ï¼ˆå½“ä½¿ç”¨æ ‡å‡†å®ç°æ—¶ï¼‰</li>
<li>å‰é¦ˆç½‘ç»œå±‚çš„è¾“å…¥/è¾“å‡ºç»´åº¦</li>
</ul>
<h4 id="æ³¨æ„åŠ›">æ³¨æ„åŠ›</h4>
<h5 id="è‡ªæ³¨æ„åŠ›-decoder">è‡ªæ³¨æ„åŠ› - decoder</h5>
<img src="/2025/03/19/LLM-Rela/image-20250404192612286.png" class="" title="image-20250404192612286">
<img src="/2025/03/19/LLM-Rela/image-20250325195443397.png" class="" title="image-20250325195443397">
<p>ref: <a href="https://www.bilibili.com/video/BV1XH4y1T76e/">ä»ç¼–è§£ç å’Œè¯åµŒå…¥å¼€å§‹ï¼Œä¸€æ­¥ä¸€æ­¥ç†è§£Transformerï¼Œæ³¨æ„åŠ›æœºåˆ¶(Attention)çš„æœ¬è´¨æ˜¯å·ç§¯ç¥ç»ç½‘ç»œ(CNN)</a><br>
$$<br>
\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^{\top}}{\sqrt{d}}\right)V<br>
$$<br>
$QK^T$ ç›¸å½“äºè®¡ç®— $token_i$ ä¸ $token_j$ å¯¹åº”è¯å‘é‡çš„ç›¸ä¼¼åº¦</p>
<img src="/2025/03/19/LLM-Rela/%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%E7%9F%A9%E9%98%B5%E5%9B%BE.jpg" class="" title="img">
<p>softmax <strong>æ˜¯æŒ‰è¡Œï¼ˆrow-wiseï¼‰è¿›è¡Œçš„</strong></p>
<p>Attentionæ˜¯å¯¹æ¯ä¸ªtoken <strong>valueåŒ–çš„è¯å‘é‡çŸ©é˜µ</strong> è¿›è¡Œç›¸å…³æ€§ä¿®æ­£ï¼Œå¾—åˆ°æ³¨æ„åŠ›çŸ©é˜µï¼›</p>
<p>å…¶ä¸­ï¼Œæ¯è¡Œ<strong>æ¯ä¸ªä¿®æ­£åè¯å‘é‡</strong>åŒ…å«å…¶ä»–ç›¸ä¼¼è¯è¯å‘é‡çš„åŠ å’Œ</p>
<blockquote>
<p>ç»´åº¦å˜åŒ–</p>
<p>å‡è®¾ $W_Q$ çš„ç»´åº¦ä¸º ($d_{model}$, $d_k$)ï¼Œè¾“å…¥å½¢çŠ¶ä¸º (batch_size, $L_{actual}$, $d_{model}$)ï¼Œè¿™é‡Œçš„ $L_{actual}$ ä¸ºè¾“å…¥tokenåºåˆ—é•¿åº¦ï¼Œåˆ™ $QK^{\top}$ çš„ç»´åº¦ä¸º (batch_size, $L_{actual}$, $L_{actual}$)ï¼ŒVçš„ç»´åº¦ä¸º(batch_size, $L_{actual}$, $d_v$)</p>
</blockquote>
<br>
<h5 id="äº¤å‰æ³¨æ„åŠ›-encoder">äº¤å‰æ³¨æ„åŠ› - encoder</h5>
<img src="/2025/03/19/LLM-Rela/image-20250325195459862.png" class="" title="image-20250325195459862">
<br>
<h4 id="å¤šå¤´æ³¨æ„åŠ›">å¤šå¤´æ³¨æ„åŠ›</h4>
<img src="/2025/03/19/LLM-Rela/multi-head-%E6%8B%BC%E6%8E%A5.jpg" class="" title="img">
<blockquote>
<p>å°† $W_K, W_Q, W_V$ ç«–ç€åˆ‡åˆ†ä¸º N ä¸ªï¼Œè¿™æ„å‘³ç€é•¿åº¦ä¸º  $L_{actual}$çš„tokenåºåˆ—è¦ä¸æ¯ä¸ªå¤´è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ï¼Œå¾—åˆ° ($L_{actual}$, $d_h$) çš„çŸ©é˜µï¼Œç„¶åæ‹¼æ¥å¾—åˆ° ($L_{actual}$, $d_K$) çš„çŸ©é˜µï¼Œ è¿›å…¥(å¯é€‰) æœ€ç»ˆçº¿æ€§æŠ•å½± $W_O$ï¼Œsize ä¸º $\mathbb{R}^{d_K \times d_{model}}$</p>
</blockquote>
<p>1.æ‹†åˆ†</p>
<p>åŸå§‹çš„å•å¤´æ³¨æ„åŠ›ä¸­ï¼Œ$W_K, W_Q, W_V \in \mathbb{R}^{d_{model} \times d_K}$<br>
åœ¨å¤šå¤´æœºåˆ¶ä¸­ï¼Œæ¯ä¸ªå¤´çš„å‚æ•°çŸ©é˜µè¢«æ°´å¹³æ‹†åˆ†ä¸ºæ›´å°çš„çŸ©é˜µï¼š</p>
<ul>
<li>
<p><strong>ç¬¬ $h$ ä¸ªå¤´çš„å‚æ•°</strong>ï¼š</p>
<p>$W_K^{(h)}, W_Q^{(h)}, W_V^{(h)} \in \mathbb{R}^{d_{model} \times d_h}$ï¼Œå…¶ä¸­ $d_h = d_K/N_h$ã€‚ä¾‹å¦‚ï¼Œè‹¥æ€»ç»´åº¦ $d_K=512$ï¼Œå¤´æ•° $N_h=8$ï¼Œåˆ™æ¯ä¸ªå¤´çš„ç»´åº¦ $d_h=64$ã€‚</p>
</li>
</ul>
<p><strong>æ‹†åˆ†æ–¹å¼</strong>ï¼š</p>
<ul>
<li><strong>æ°´å¹³æ‹†åˆ†</strong>ï¼šå°†åŸå§‹çŸ©é˜µæŒ‰åˆ—åˆ‡åˆ†ï¼ˆå¦‚ $W_K$ è¢«æ‹†ä¸º $[W_K^{(1)}, W_K^{(2)}, â€¦, W_K^{(N_h)}]$ï¼‰ï¼Œæ¯ä¸ªå­çŸ©é˜µå¯¹åº”ä¸€ä¸ªå¤´çš„å‚æ•°ã€‚</li>
</ul>
<p>2.ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›</p>
<p>æ¯ä¸ªå¤´ $h$ ä½¿ç”¨è‡ªå·±çš„å‚æ•°çŸ©é˜µç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›ï¼š</p>
<ul>
<li>
<p><strong>è¾“å…¥ $x$ é€šè¿‡ç¬¬ $h$ ä¸ªå¤´</strong>ï¼š</p>
<p>$K^{(h)} = x W_K^{(h)}$ï¼Œ</p>
<p>$Q^{(h)} = x W_Q^{(h)}$ï¼Œ</p>
<p>$V^{(h)} = x W_V^{(h)}$ã€‚</p>
<p>æ³¨æ„ï¼Œå½“å‰æ­¥å¾—åˆ°çš„ $K^{(h)}, Q^{(h)}, V^{(h)}$ ç­‰ä»·äºç›´æ¥ä»åŸå§‹ $K, Q, V$ ä¸­æ‹†åˆ†</p>
</li>
<li>
<p><strong>è®¡ç®—æ³¨æ„åŠ›è¾“å‡º</strong>ï¼š<br>
$\text{Attn}_h(x) = \text{softmax}\left(\frac{Q^{(h)} K^{(h)\top}}{\sqrt{d_h}}\right) V^{(h)}$ã€‚</p>
</li>
</ul>
<blockquote>
<p>$K^{(h)}Q^{(h)}$ size ä¸º (L_actual, L_actual), $V^{(h)}$ size ä¸º (L_actual, d_h)</p>
</blockquote>
<p>3.æ•´åˆ</p>
<p>æ‰€æœ‰å¤´çš„è¾“å‡ºé€šè¿‡**æ‹¼æ¥ï¼ˆConcatenateï¼‰**æ•´åˆï¼š</p>
<ul>
<li>
<p><strong>æ‹¼æ¥ï¼ˆæ ‡å‡†Transformerï¼‰</strong>ï¼š</p>
<p>$\text{MHA}(x) = Concat(\text{Attn}<em>1(x), \text{Attn}<em>2(x), â€¦, \text{Attn}</em>{N_h}(x)) W_O$ï¼Œå…¶ä¸­ $W_O \in \mathbb{R}^{d</em>{K} \times d_{model}}$ æ˜¯è¾“å‡ºæŠ•å½±çŸ©é˜µã€‚</p>
</li>
</ul>
<br>
<p>æµ‹è¯•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Wq = Wk = Wv = np.array([</span><br><span class="line">    [1, 0, 0, 0],</span><br><span class="line">    [0, 2, 0, 0],</span><br><span class="line">    [0, 0, 3, 0],</span><br><span class="line">    [0, 0, 0, 4]</span><br><span class="line">]) </span><br><span class="line"></span><br><span class="line">è¾“å…¥ X:</span><br><span class="line"> [[1 0 1 0]</span><br><span class="line"> [0 2 0 2]]</span><br><span class="line"></span><br><span class="line">--- å•å¤´ Attention ---</span><br><span class="line">QK^T / sqrt(dk):</span><br><span class="line"> [[ 5.  0.]</span><br><span class="line"> [ 0. 40.]]</span><br><span class="line">Attention Weights:</span><br><span class="line"> [[9.93307149e-01 6.69285092e-03]</span><br><span class="line"> [4.24835426e-18 1.00000000e+00]]</span><br><span class="line">Single-Head Output:</span><br><span class="line"> [[9.93307149e-01 2.67714037e-02 2.97992145e+00 5.35428074e-02]</span><br><span class="line"> [4.24835426e-18 4.00000000e+00 1.27450628e-17 8.00000000e+00]]</span><br><span class="line"></span><br><span class="line">--- å¤šå¤´ Attentionï¼ˆHead 1ï¼‰---</span><br><span class="line">Q1K1^T / sqrt(dk):</span><br><span class="line"> [[ 0.70710678  0.        ]</span><br><span class="line"> [ 0.         11.3137085 ]]</span><br><span class="line">Attention Weights Head 1:</span><br><span class="line"> [[6.69761549e-01 3.30238451e-01]</span><br><span class="line"> [1.22043184e-05 9.99987796e-01]]</span><br><span class="line">Head 1 Output:</span><br><span class="line"> [[6.69761549e-01 1.32095380e+00]</span><br><span class="line"> [1.22043184e-05 3.99995118e+00]]</span><br><span class="line"></span><br><span class="line">--- å¤šå¤´ Attentionï¼ˆHead 2ï¼‰---</span><br><span class="line">Q2K2^T / sqrt(dk):</span><br><span class="line"> [[ 6.36396103  0.        ]</span><br><span class="line"> [ 0.         45.254834  ]]</span><br><span class="line">Attention Weights Head 2:</span><br><span class="line"> [[9.98280432e-01 1.71956818e-03]</span><br><span class="line"> [2.21858114e-20 1.00000000e+00]]</span><br><span class="line">Head 2 Output:</span><br><span class="line"> [[2.99484130e+00 1.37565454e-02]</span><br><span class="line"> [6.65574341e-20 8.00000000e+00]]</span><br><span class="line"></span><br><span class="line">Multi-Head Output:</span><br><span class="line"> [[6.69761549e-01 1.32095380e+00 2.99484130e+00 1.37565454e-02]</span><br><span class="line"> [1.22043184e-05 3.99995118e+00 6.65574341e-20 8.00000000e+00]]</span><br></pre></td></tr></table></figure>
<br>
<h4 id="æ©ç æ³¨æ„åŠ›-decoder">æ©ç æ³¨æ„åŠ› - decoder</h4>
<img src="/2025/03/19/LLM-Rela/mask-attention-map.jpg" class="" title="img">
<p><strong>æ©ç ï¼ˆMaskingï¼‰åœ¨è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼ˆAttention Weightsï¼‰æ—¶ç”Ÿæ•ˆï¼Œæ³¨æ„åŠ›æƒé‡æ˜¯é€šè¿‡Qï¼ˆQueryï¼‰å’ŒKï¼ˆKeyï¼‰çš„ç‚¹ç§¯è®¡ç®—å¾—å‡ºçš„ã€‚</strong> Valueï¼ˆVï¼‰æ˜¯æ ¹æ®è¿™äº›æƒé‡åŠ æƒæ±‚å’Œçš„ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œæ©ç ä¸æ˜¯ç›´æ¥ä½œç”¨åœ¨Qã€Kã€Vçš„åŸå§‹æ•°å€¼ä¸Šï¼Œè€Œæ˜¯ä½œç”¨åœ¨<strong>Qå’ŒKè®¡ç®—å¾—åˆ°çš„æ³¨æ„åŠ›åˆ†æ•°ï¼ˆlogitsï¼‰ä¸Š</strong>ï¼Œä»¥æ­¤æ¥å†³å®šå“ªäº›Kä¸èƒ½è¢«Qå…³æ³¨åˆ°ã€‚</p>
<blockquote>
<p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ©ç é€šè¿‡ä½œç”¨äº $QK^T$ ï¼Œä½¿å¾—ä½ç½®é å‰çš„token åœ¨ $softmax(\frac{QK^T}{\sqrt{d}})$ åï¼Œå…¶æ³¨æ„åŠ›æƒé‡å‘é‡ï¼ˆè¡Œå‘é‡ï¼‰ä»ç»“æœä¸Šæ¥è¯´åä½å‡ä¸º0ï¼Œå› æ­¤å¾—åˆ°çš„ä¿®æ­£è¯å‘é‡ï¼ˆæ³¨æ„åŠ›çŸ©é˜µçš„æ¯è¡Œï¼‰ï¼Œåœ¨åŸtokenåºåˆ—è¶Šé å‰çš„ï¼Œå…¶è¯å‘é‡å˜åŒ–è¶Šå°ï¼ˆ<strong>èå…¥çš„ä¸Šæ–‡ä¿¡æ¯é‡</strong>è¶Šå°‘ï¼‰ï¼Œè¶Šé åçš„ï¼Œåœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸‹å˜åŒ–è¶Šå¤§ï¼ˆèå…¥çš„ä¸Šæ–‡ä¿¡æ¯é‡è¶Šå¤§ï¼‰</p>
</blockquote>
<br>
<h4 id="MHAã€MQAã€GQA-MLA">MHAã€MQAã€GQA&amp;MLA</h4>
<p>ref: <a href="https://zhuanlan.zhihu.com/p/21151178690">https://zhuanlan.zhihu.com/p/21151178690</a></p>
<img src="/2025/03/19/LLM-Rela/v2-b257d8660af7678f9c9bdc14d095b6d3_1440w.jpg" class="" title="img">
<p>MQA(<strong>M</strong>ulti-<strong>Q</strong>uery <strong>A</strong>ttention): æ¯ä¸ª head çš„ Query å…±äº«Kå’ŒVçŸ©é˜µï¼ŒKV cacheçš„å†…å­˜å ç”¨é™ä¸º $\frac{1}{n}$</p>
<p>GQA(<strong>G</strong>rouped-<strong>Q</strong>uery <strong>A</strong>ttention): æ¯ä¸ª head çš„ Query æŒ‰ç»„åŒºåˆ†ï¼Œå…±äº«Kå’ŒVçŸ©é˜µï¼Œ$g = 1$ ä¸ºMQAï¼Œ$g = n$ ä¸ºMHA</p>
<blockquote>
<p>GQA ç›¸å¯¹äº MHA</p>
<p>MHAæ˜¯å¯¹ $W_Q$ $W_K$ $W_V $æŒ‰åˆ—åˆ’åˆ†ä¸º num_heads ä¸ªå¤´ï¼Œæ¯ä¸ªå¤´çš„ç»´åº¦ä¸º $d_{head}$</p>
<p>GQA  æ˜¯å¯¹ $W_Q$ æŒ‰åˆ—åˆ’åˆ†ä¸º num_heads ä¸ªå¤´ï¼Œ$W_K$ $W_V$ æŒ‰åˆ—åˆ’åˆ†ä¸º num_heads / g ä¸ªå¤´ï¼Œæ¯ä¸ªå¤´çš„ç»´åº¦ä¸º $d_{head}$ï¼Œå¤´çš„ç»´åº¦ä¸€è‡´</p>
<p>ï¼ˆæ‹¼èµ·æ¥çš„è¯Kå¤´å’ŒVå¤´å¤§å°å°äºQå¤´</p>
</blockquote>
<p>MLA(<strong>M</strong>ulti-head <strong>L</strong>atent <strong>A</strong>ttention):</p>
<img src="/2025/03/19/LLM-Rela/v2-1eda59791cb4a0a09f9ebce4fbb23865_1440w.jpg" class="" title="img">
<br>
<h3 id="Layer-Norm-Residual-Network">Layer Norm &amp; Residual Network</h3>
<p>Batch Normalization æ˜¯å¯¹ <strong>æ‰€æœ‰æ ·æœ¬çš„åŒä¸€ç‰¹å¾ç»´åº¦</strong> åˆ†åˆ«åšå½’ä¸€åŒ–ï¼ˆæŒ‰åˆ—æ“ä½œï¼‰</p>
<p>Layer Normalization æ˜¯å¯¹ <strong>å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾ç»´åº¦</strong> åšå½’ä¸€åŒ–ï¼ˆæŒ‰è¡Œæ“ä½œï¼‰</p>
<p>ä¾‹å¦‚ï¼šBNæ˜¯å¯¹ç‰¹å¾ $i$ è¿›è¡Œå½’ä¸€ï¼ŒLNæ˜¯å¯¹æ ·æœ¬ $x_i$ è¿›è¡Œå½’ä¸€</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ ·æœ¬</th>
<th style="text-align:center">ç‰¹å¾1</th>
<th style="text-align:center">ç‰¹å¾2</th>
<th style="text-align:center">ç‰¹å¾3</th>
<th style="text-align:center">ç‰¹å¾4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>xâ‚</strong></td>
<td style="text-align:center">1.0</td>
<td style="text-align:center">2.0</td>
<td style="text-align:center">3.0</td>
<td style="text-align:center">4.0</td>
</tr>
<tr>
<td style="text-align:center"><strong>xâ‚‚</strong></td>
<td style="text-align:center">5.0</td>
<td style="text-align:center">6.0</td>
<td style="text-align:center">7.0</td>
<td style="text-align:center">8.0</td>
</tr>
<tr>
<td style="text-align:center"><strong>xâ‚ƒ</strong></td>
<td style="text-align:center">9.0</td>
<td style="text-align:center">10.0</td>
<td style="text-align:center">11.0</td>
<td style="text-align:center">12.0</td>
</tr>
</tbody>
</table>
<br>
<h3 id="MLP-FFN">MLP&amp;FFN</h3>
<p>åœ¨Transformerçš„æ¯ä¸ªç¼–ç å™¨å’Œè§£ç å™¨å±‚ä¸­ï¼ŒMLPï¼ˆä¹Ÿç§°ä¸º<strong>Feed Forward Network, FFN</strong>ï¼‰ç”¨äºå¯¹è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢å’Œç‰¹å¾æ˜ å°„ã€‚</p>
<p>MLP (Multi-Layer Perceptron) æ˜¯ Transformer ç¼–ç å™¨ä¸­æ¯ä¸ªè‡ªæ³¨æ„åŠ›å±‚ä¹‹åçš„ä¸€ä¸ªå‰é¦ˆç½‘ç»œæ¨¡å—ã€‚è¿™ä¸ª MLP é€šå¸¸åŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚ï¼Œä¸­é—´æœ‰ä¸€ä¸ªéçº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ GELUï¼‰</p>
<br>
$$
FFN(x)=Linear_{2}(Activation(Linear_{1}(x)))
$$
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FeedForwardNetwork</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_model: <span class="built_in">int</span>, d_ff: <span class="built_in">int</span>, activation=<span class="string">&quot;relu&quot;</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.linear1 = nn.Linear(d_model, d_ff)  <span class="comment"># æ‰©å±•å±‚</span></span><br><span class="line">        self.linear2 = nn.Linear(d_ff, d_model)  <span class="comment"># æ”¶ç¼©å±‚</span></span><br><span class="line">        self.activation = nn.ReLU() <span class="keyword">if</span> activation == <span class="string">&quot;relu&quot;</span> <span class="keyword">else</span> nn.GELU()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="comment"># x shape: [batch_size, seq_len, d_model]</span></span><br><span class="line">        x = self.linear1(x)</span><br><span class="line">        x = self.activation(x)</span><br><span class="line">        x = self.linear2(x)</span><br><span class="line">        <span class="keyword">return</span> x  <span class="comment"># è¾“å‡ºç»´åº¦ä¿æŒ [batch_size, seq_len, d_model]</span></span><br></pre></td></tr></table></figure>
<br>
<p><strong>å…³äº MLP size</strong></p>
<p>â€œMLP sizeâ€ æŒ‡çš„æ˜¯<strong>è¿™ä¸¤ä¸ªçº¿æ€§å±‚ä¸­é—´çš„éšè—ç»´åº¦</strong>ã€‚</p>
<ul>
<li><strong>åœ¨ ViT ä¸­çš„ä½“ç°:</strong>
<ul>
<li>ç»“æ„: <code>Linear(D -&gt; MLP_Size) -&gt; GELU -&gt; Linear(MLP_Size -&gt; D)</code></li>
<li>å®ƒæ˜¯ä¸€ä¸ªâ€œç“¶é¢ˆâ€ç»“æ„ï¼Œå°† $D$ ç»´çš„è¾“å…¥å…ˆæ‰©å±•åˆ°ä¸€ä¸ªæ›´å¤§çš„ç»´åº¦ <code>MLP_Size</code>ï¼Œå†å‹ç¼©å› $D$ ç»´ã€‚</li>
</ul>
</li>
<li><strong>ä½œç”¨:</strong>
<ul>
<li><strong>å¢åŠ éçº¿æ€§è¡¨è¾¾èƒ½åŠ›:</strong> MLP å±‚æ˜¯ Transformer ç¼–ç å™¨ä¸­å¼•å…¥éçº¿æ€§çš„ä¸»è¦æ–¹å¼ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ æ›´å¤æ‚çš„å‡½æ•°å…³ç³»ã€‚</li>
<li><strong>æä¾›â€œæ€è€ƒç©ºé—´â€:</strong> æ‰©å±•åˆ°æ›´å¤§çš„ç»´åº¦ï¼ˆMLP Sizeï¼‰å¯ä»¥è¢«è®¤ä¸ºæ˜¯ç»™æ¨¡å‹æ›´å¤šçš„â€œæ€è€ƒç©ºé—´â€æ¥å¤„ç†ç‰¹å¾ã€‚</li>
<li><strong>å½±å“è®¡ç®—é‡å’Œå‚æ•°é‡:</strong> MLP size è¶Šå¤§ï¼Œè¿™éƒ¨åˆ†çš„è®¡ç®—é‡å’Œå‚æ•°é‡ä¹Ÿä¼šè¶Šå¤§ã€‚</li>
</ul>
</li>
<li><strong>ä¸ Hidden Size çš„å…³ç³»:</strong> MLP size é€šå¸¸æ˜¯ Hidden size $D$ çš„ä¸€ä¸ªå€æ•°ï¼Œä¾‹å¦‚ <strong>4 å€</strong>ã€‚</li>
<li><strong>ç¤ºä¾‹:</strong> åœ¨ ViT-Base æ¨¡å‹ä¸­ï¼Œå¦‚æœ $D = 768$ï¼Œé‚£ä¹ˆ MLP size é€šå¸¸æ˜¯ $768 \times 4 = 3072$ã€‚</li>
</ul>
<br>
<h3 id="ç›¸å…³é—®é¢˜">ç›¸å…³é—®é¢˜</h3>
<ol>
<li>
<p>ä¸ºä»€ä¹ˆAttenionå…¬å¼ä¸­è¦é™¤ä»¥ $\sqrt d$ï¼ˆdä¸ºQ, KçŸ©é˜µçš„è¾“å‡ºç»´åº¦ï¼‰ï¼Ÿ</p>
<ul>
<li>å½“å‘é‡ç»´åº¦å˜å¤§çš„æ—¶å€™ï¼Œdå˜å¤§ï¼Œ q å’Œ k çš„ç‚¹ç§¯çš„æ–¹å·®å˜å¤§</li>
<li>ç”±äºè¦å¯¹ q å’Œ k çš„ç‚¹ç§¯çš„æ¯ä¸€è¡Œè¿›è¡Œsoftmaxï¼Œè¿‡å¤§çš„æ–¹å·®å°†å¯¼è‡´softmaxæç«¯åŒ–ï¼Œå¾—åˆ°ç±»ä¼¼äº $[1,0,0,â€¦]$ çš„one-hotåˆ†å¸ƒ</li>
<li>å½“è¾“å‡ºæ¥è¿‘one-hotæ—¶ï¼Œéæœ€å¤§å€¼çš„æ¢¯åº¦è¶‹è¿‘äº0ï¼Œåå‘ä¼ æ’­æ—¶ï¼Œè¿™äº›ä½ç½®çš„å‚æ•°æ— æ³•å¾—åˆ°æ›´æ–°</li>
<li>å› æ­¤ï¼Œè®¾ç½® softmax çš„ temperature æ¥ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œ temperature è¢«è®¾ç½®ä¸ºäº† $\sqrt d$ .</li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡è®¾éšæœºå‘é‡ $X$ æ»¡è¶³å‡å€¼ä¸º 0ï¼Œåæ–¹å·®çŸ©é˜µä¸ºå•ä½çŸ©é˜µï¼ˆå³å„å˜é‡ç‹¬ç«‹ä¸”æ–¹å·®ä¸º 1ï¼‰çš„<strong>å¤šå…ƒæ ‡å‡†æ­£æ€åˆ†å¸ƒ</strong>ï¼Œå¯è®¡ç®—å¾—åˆ° $XY^T$ æ»¡è¶³å‡å€¼ä¸º 0ï¼Œåæ–¹å·®çŸ©é˜µä¸º $D_{out} I$ çš„<strong>å¤šå…ƒæ­£æ€åˆ†å¸ƒ</strong>ï¼Œé€šè¿‡é™¤ä»¥ $\sqrt d$ å°† $XY^T$ çš„æ–¹å·®ç¼©æ”¾ä¸º1</p>
</li>
</ol>
<img src="/2025/03/19/LLM-Rela/image-20250404100511037.png" class="" title="image-20250404100511037">
<ol start="2">
<li>
<p>ä¸ºä»€ä¹ˆé€‰æ‹©å¤šå¤´æ³¨æ„åŠ›ï¼Ÿ</p>
<p>æœ‰è¯´æ³•è®¤ä¸ºï¼Œå…‹æœ**ã€Œæ¨¡å‹åœ¨å¯¹å½“å‰ä½ç½®çš„ä¿¡æ¯è¿›è¡Œç¼–ç æ—¶ï¼Œä¼šè¿‡åº¦çš„å°†æ³¨æ„åŠ›é›†ä¸­äºè‡ªèº«çš„ä½ç½®ã€<strong>ï¼Œæˆ–è€…</strong>è¡¨è¾¾èƒ½åŠ›æå‡**ï¼šå¤šä¸ªä½ç§©æ³¨æ„åŠ›å¤´ï¼ˆ$d_h &lt; d$ï¼‰çš„é›†æˆï¼Œèƒ½æ•æ‰æ›´å¤æ‚çš„äº¤äº’æ¨¡å¼ï¼›</p>
<p>ä½†æ˜¯ä»æœ‰ç›¸æ‚–è§‚ç‚¹è®¤ä¸ºå¹¶éå¦‚æ­¤</p>
<p>ref: <a href="https://arxiv.org/pdf/1905.10650">https://arxiv.org/pdf/1905.10650</a></p>
<img src="/2025/03/19/LLM-Rela/image-20250405101512560.png" class="" title="image-20250405101512560">
</li>
<li>
<p>Qï¼ŒKï¼ŒVä¸ºä»€ä¹ˆåä¸ºQueryï¼ŒKeyï¼ŒValueï¼Ÿæ³¨æ„åŠ›æœºåˆ¶çš„æ³¨æ„åŠ›ä½“ç°åœ¨å“ªé‡Œï¼Ÿ</p>
<p>åœ¨äº¤å‰æ³¨æ„åŠ›åœºæ™¯ä¸­ï¼Œ</p>
<ol>
<li>
<p><strong>è§£ç å™¨çš„ä»»åŠ¡ï¼š</strong> è§£ç å™¨çš„ç›®æ ‡æ˜¯æ ¹æ®ç¼–ç å™¨è¾“å‡ºçš„æºè¯­å¥ä¿¡æ¯ï¼Œå¹¶ç»“åˆå·²ç»ç”Ÿæˆçš„è¯ï¼Œæ¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ã€‚</p>
</li>
<li>
<p><strong>ç¼–ç å™¨çš„è¾“å‡ºï¼š</strong> ç¼–ç å™¨å¤„ç†å®Œæºè¯­å¥åï¼Œä¼šè¾“å‡ºä¸€ç³»åˆ—çš„å‘é‡è¡¨ç¤ºã€‚è¿™äº›å‘é‡æ•è·äº†æºè¯­å¥ä¸­æ¯ä¸ªè¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨ Transformer çš„åŸå§‹è®¾è®¡ä¸­ï¼Œè¿™äº›è¾“å‡ºå‘é‡å°±æ˜¯è§£ç å™¨äº¤å‰æ³¨æ„åŠ›çš„ K å’Œ Vã€‚</p>
</li>
<li>
<p><strong>Q æ¥æºè§£ç å™¨ï¼š</strong> è§£ç å™¨åœ¨ç”Ÿæˆç¬¬ t ä¸ªè¯æ—¶ï¼Œå®ƒå·²ç»ç”Ÿæˆäº† t-1 ä¸ªè¯ï¼ˆæˆ–è€…è¯´ï¼Œå®ƒçŸ¥é“è¦ç”Ÿæˆå“ªä¸ªä½ç½®çš„è¯ï¼‰ã€‚è§£ç å™¨ä½¿ç”¨å®ƒè‡ªå·±å½“å‰çš„è¾“å…¥ï¼ˆé€šå¸¸æ˜¯å‰ä¸€ä¸ªç”Ÿæˆçš„è¯çš„åµŒå…¥ï¼Œæˆ–è€…ä¸€ä¸ªç‰¹æ®Šçš„è¡¨ç¤ºå½“å‰ä½ç½®çš„å‘é‡ï¼‰æ¥ç”Ÿæˆ <strong>æŸ¥è¯¢å‘é‡ Q</strong>ã€‚è¿™ä¸ª Q ä»£è¡¨äº†â€œæˆ‘ï¼ˆè§£ç å™¨ï¼‰ç°åœ¨æƒ³çŸ¥é“ä»€ä¹ˆï¼Ÿæˆ‘éœ€è¦å“ªäº›ä¿¡æ¯æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªè¯ï¼Ÿâ€</p>
</li>
<li>
<p><strong>Kï¼ŒV æ¥æºäºç¼–ç å™¨ï¼š</strong> ç¼–ç å™¨å¤„ç†å®Œæ•´ä¸ªæºè¯­å¥åï¼Œä¼šè¾“å‡ºä¸€ç³»åˆ—ä¸Šä¸‹æ–‡å‘é‡ã€‚è¿™äº›å‘é‡è¢«ç”¨ä½œ <strong>é”®å‘é‡ K</strong> å’Œ <strong>å€¼å‘é‡ V</strong>ã€‚</p>
<ul>
<li><strong>Kï¼ˆé”®ï¼‰</strong>ï¼šä»£è¡¨äº†æºè¯­å¥ä¸­æ¯ä¸ªè¯çš„â€œèº«ä»½â€æˆ–â€œç‰¹å¾â€ã€‚å½“è§£ç å™¨çš„ Q å»æŸ¥è¯¢æ—¶ï¼Œå®ƒä¼šä¸è¿™äº› K è¿›è¡ŒåŒ¹é…ï¼Œä»¥åˆ¤æ–­æºè¯­å¥ä¸­å“ªäº›è¯ä¸å½“å‰çš„ Q æ›´ç›¸å…³ã€‚</li>
<li><strong>Vï¼ˆå€¼ï¼‰</strong>ï¼šåŒ…å«äº†æºè¯­å¥ä¸­æ¯ä¸ªè¯çš„å®é™…â€œå†…å®¹â€æˆ–â€œä¿¡æ¯â€ã€‚ä¸€æ—¦ Q å’Œ K ç¡®å®šäº†ç›¸å…³æ€§ï¼ŒV å°±ä¼šæä¾›è¿™äº›ç›¸å…³è¯çš„å®é™…ä¿¡æ¯ï¼Œä¾›è§£ç å™¨ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li>
<p><strong>äº¤å‰æ³¨æ„åŠ›çš„è¿‡ç¨‹ï¼š</strong></p>
<ul>
<li>è§£ç å™¨çš„ Qï¼ˆæ¥è‡ªå½“å‰ç”Ÿæˆè¯çš„è¡¨ç¤ºï¼‰ä¸ç¼–ç å™¨çš„ K çŸ©é˜µè¿›è¡Œç‚¹ç§¯ï¼Œå¹¶é€šè¿‡ softmax å¾—åˆ°æ³¨æ„åŠ›æƒé‡ã€‚è¿™äº›æƒé‡è¡¨æ˜äº†å½“å‰è§£ç å™¨å…³æ³¨ç‚¹åœ¨æºè¯­å¥ä¸­å„ä¸ªè¯ä¸Šçš„åˆ†å¸ƒã€‚</li>
<li>å°†è¿™äº›æƒé‡åº”ç”¨äºç¼–ç å™¨çš„ V çŸ©é˜µï¼Œè¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ª <strong>ä¸Šä¸‹æ–‡å‘é‡</strong>ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡å‘é‡æµ“ç¼©äº†æºè¯­å¥ä¸­å¯¹å½“å‰ç”Ÿæˆè¯æœ€é‡è¦çš„ä¿¡æ¯ã€‚</li>
<li>è§£ç å™¨å°†è¿™ä¸ªä¸Šä¸‹æ–‡å‘é‡ä¸è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡è‡ªæ³¨æ„åŠ›è·å¾—çš„å·²ç”Ÿæˆè¯çš„ä¿¡æ¯ï¼‰ç»“åˆèµ·æ¥ï¼Œç”¨äºé¢„æµ‹ä¸‹ä¸€ä¸ªè¯ã€‚</li>
</ul>
<p>â€œé€šè¿‡å·²ç»ç”Ÿæˆçš„è¯å’Œæºè¯­å¥åšè‡ªæ³¨æ„åŠ›ï¼Œå°±æ˜¯ç¡®å®šæºè¯­å¥ä¸­å“ªäº›è¯å¯¹æ¥ä¸‹æ¥çš„è¯çš„ç”Ÿæˆæ›´æœ‰ä½œç”¨â€æ­£æ˜¯ <strong>äº¤å‰æ³¨æ„åŠ›</strong> çš„åŠŸèƒ½ã€‚è§£ç å™¨çš„ Qï¼ˆä»£è¡¨å½“å‰ç”Ÿæˆè¯çš„æ„å›¾ï¼‰å»æŸ¥è¯¢ç¼–ç å™¨çš„ K/Vï¼ˆæºè¯­å¥ä¿¡æ¯ï¼‰ï¼Œæ‰¾åˆ°æºè¯­å¥ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ã€‚</p>
</li>
</ol>
<p>å¯¹æ¯”ï¼š</p>
<ul>
<li><strong>LSTM Seq2Seq çš„é—®é¢˜ï¼š</strong>
<ul>
<li><strong>ä¿¡æ¯ç“¶é¢ˆï¼ˆInformation Bottleneckï¼‰</strong>ï¼šåœ¨ä¼ ç»Ÿçš„ LSTM Encoder-Decoder æ¶æ„ä¸­ï¼Œç¼–ç å™¨ä¼šå°†æ•´ä¸ªæºåºåˆ—å‹ç¼©æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„ <strong>ä¸Šä¸‹æ–‡å‘é‡ C</strong>ã€‚æ— è®ºæºåºåˆ—å¤šé•¿ï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½å¿…é¡»æŒ¤è¿›è¿™ä¸ª Cã€‚è¿™å¯¼è‡´é•¿åºåˆ—çš„ä¿¡æ¯ä¸¢å¤±ï¼Œå°¤å…¶åœ¨è§£ç å™¨ç”ŸæˆååŠæ®µåºåˆ—æ—¶ï¼ŒC ä¸­å…³äºæºåºåˆ—å‰åŠæ®µçš„ä¿¡æ¯å¯èƒ½å·²ç»éå¸¸ç¨€é‡Šã€‚</li>
<li><strong>â€œæ¯ä¸€æ¬¡ç”Ÿæˆè¯ï¼Œéƒ½æ˜¯é€šè¿‡ C çš„å…¨éƒ¨ä¿¡æ¯å»ç”Ÿæˆâ€</strong>ï¼šè§£ç å™¨åœ¨æ¯ä¸€æ­¥éƒ½ä¾èµ–äºè¿™ä¸ªå›ºå®šçš„ Cã€‚è¿™ä½¿å¾—æ¨¡å‹éš¾ä»¥åŠ¨æ€åœ°å…³æ³¨æºåºåˆ—ä¸­ä¸å½“å‰ç”Ÿæˆè¯æœ€ç›¸å…³çš„éƒ¨åˆ†ã€‚</li>
<li><strong>â€œå¾ˆå¤šä¿¡æ¯å¯¹äºå½“å‰ç”Ÿæˆè¯è€Œè¨€éƒ½æ˜¯æ²¡æœ‰æ„ä¹‰çš„â€</strong>ï¼šæ²¡é”™ï¼Œå¯¹äºç”ŸæˆæŸä¸ªç‰¹å®šè¯ï¼Œæºåºåˆ—ä¸­å¯èƒ½åªæœ‰ä¸€ä¸¤ä¸ªè¯æ˜¯çœŸæ­£ç›¸å…³çš„ã€‚LSTM çš„ C å´åŒ…å«äº†æ‰€æœ‰ä¿¡æ¯ï¼Œæ— æ³•åšåˆ°â€œæŒ‰éœ€æå–â€ã€‚</li>
</ul>
</li>
<li><strong>Transformer æ³¨æ„åŠ›æœºåˆ¶çš„è§£å†³æ–¹æ¡ˆï¼š</strong>
<ul>
<li><strong>åŠ¨æ€èšç„¦ï¼š</strong> é€šè¿‡äº¤å‰æ³¨æ„åŠ›ï¼Œè§£ç å™¨åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªè¯æ—¶ï¼Œéƒ½èƒ½åŠ¨æ€åœ°è®¡ç®—æºåºåˆ—ä¸­ä¸åŒè¯çš„æ³¨æ„åŠ›æƒé‡ã€‚è¿™æ„å‘³ç€å®ƒèƒ½æ ¹æ®å½“å‰ç”Ÿæˆè¯çš„éœ€è¦ï¼Œ<strong>â€œæŒ‰éœ€â€åœ°ä»ç¼–ç å™¨è¾“å‡ºä¸­æå–æœ€ç›¸å…³çš„ä¿¡æ¯</strong>ã€‚</li>
<li><strong>é¿å…ä¿¡æ¯ç“¶é¢ˆï¼š</strong> ç¼–ç å™¨ä¸å†éœ€è¦å°†æ‰€æœ‰ä¿¡æ¯å‹ç¼©æˆä¸€ä¸ªå•ä¸€å‘é‡ã€‚å®ƒè¾“å‡ºçš„æ˜¯ä¸€ç³»åˆ—çš„ä¸Šä¸‹æ–‡å‘é‡ï¼ˆæ¯ä¸ªå¯¹åº”æºåºåˆ—ä¸­çš„ä¸€ä¸ªè¯ï¼‰ï¼Œè§£ç å™¨å¯ä»¥éšæ—¶é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶è®¿é—®è¿™äº›å‘é‡ã€‚</li>
<li><strong>é•¿è·ç¦»ä¾èµ–ï¼š</strong> æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥ç›´æ¥è¿æ¥æºåºåˆ—ä¸­çš„ä»»æ„ä¸¤ä¸ªè¯ï¼Œæ— è®ºå®ƒä»¬ç›¸è·å¤šè¿œï¼Œæœ‰åŠ©äºæ•æ‰é•¿è·ç¦»ä¾èµ–å…³ç³»ï¼Œè¿™åœ¨ LSTM ä¸­å¾ˆéš¾å®ç°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¸ºä»€ä¹ˆencoderéœ€è¦å¤šä¸ªæ³¨æ„åŠ›å±‚ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠè‡ªæ³¨æ„åŠ›ï¼ˆSelf-Attentionï¼‰çœ‹ä½œæ˜¯ä¸€æ¬¡ä¿¡æ¯äº¤äº’çš„è¿‡ç¨‹ã€‚åœ¨ä¸€ä¸ªæ³¨æ„åŠ›å±‚ä¸­ï¼Œæ¯ä¸ªtokenä¼šâ€œçœ‹â€åˆ°åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–çš„tokenï¼Œå¹¶æ ¹æ®ç›¸å…³æ€§ï¼ˆAttention Scoreï¼‰ä»å®ƒä»¬é‚£é‡Œâ€œå€Ÿâ€ä¸€äº›ä¿¡æ¯æ¥æ›´æ–°è‡ªå·±ã€‚</p>
<ul>
<li><strong>ä¸€å±‚æ³¨æ„åŠ› = ä¸€æ¬¡ç›´æ¥äº¤äº’</strong>ï¼š<br>
åœ¨å¥å­ â€œThe cat that chased the dog was tiredâ€ ä¸­ï¼Œç¬¬ä¸€å±‚æ³¨æ„åŠ›å¯ä»¥è®© â€œtiredâ€ ç›´æ¥å…³è”åˆ° â€œcatâ€ã€‚å®ƒèƒ½å»ºç«‹èµ·ç›´æ¥çš„è¯­æ³•è”ç³»ã€‚<br>
ä½†æ˜¯ï¼Œâ€œtiredâ€ ä¸ â€œdogâ€ çš„å…³ç³»æ˜¯<em>é—´æ¥</em>çš„ï¼ˆâ€œtiredâ€ -&gt; â€œcatâ€ -&gt; â€œchasedâ€ -&gt; â€œdogâ€ï¼‰ã€‚åœ¨ä¸€å±‚æ³¨æ„åŠ›ä¸­ï¼Œâ€œtiredâ€ çœ‹åˆ° â€œdogâ€ ä¸»è¦æ˜¯å› ä¸ºå®ƒä»¬åŒåœ¨ä¸€ä¸ªå¥å­é‡Œï¼Œä½†å®ƒä»¬ä¹‹é—´çš„æ·±å±‚é€»è¾‘å…³ç³»ï¼ˆçŒ«å› ä¸ºè¿½ç‹—è€Œç´¯ï¼‰è¿˜å¾ˆæ¨¡ç³Šã€‚</li>
<li><strong>å¤šå±‚æ³¨æ„åŠ› = å¤šæ¬¡é—´æ¥äº¤äº’</strong>ï¼š
<ul>
<li><strong>ç¬¬ä¸€å±‚</strong>ï¼šæ¯ä¸ªè¯éƒ½ä¸æ‰€æœ‰å…¶ä»–è¯è¿›è¡Œäº†ç›´æ¥çš„ä¿¡æ¯äº¤æ¢ã€‚ç°åœ¨ï¼Œæ¯ä¸ªè¯çš„å‘é‡è¡¨ç¤ºï¼ˆembeddingï¼‰å·²ç»åŒ…å«äº†å®ƒç›´æ¥é‚»å±…çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œâ€œcatâ€ çš„æ–°å‘é‡é‡ŒåŒ…å«äº† â€œchasedâ€ çš„ä¿¡æ¯ã€‚</li>
<li><strong>ç¬¬äºŒå±‚</strong>ï¼šå½“ç¬¬äºŒå±‚æ³¨æ„åŠ›å¼€å§‹å·¥ä½œæ—¶ï¼Œå®ƒçš„è¾“å…¥æ˜¯ç¬¬ä¸€å±‚å¤„ç†è¿‡çš„ã€å·²ç»â€œæ··åˆâ€äº†åˆæ­¥ä¸Šä¸‹æ–‡çš„åºåˆ—ã€‚ç°åœ¨ï¼Œå½“ â€œtiredâ€ å†æ¬¡å®¡è§† â€œcatâ€ æ—¶ï¼Œå®ƒçœ‹åˆ°çš„ â€œcatâ€ å·²ç»ä¸æ˜¯æœ€åˆçš„é‚£ä¸ªäº†ï¼Œè¿™ä¸ª â€œcatâ€ çš„å‘é‡é‡Œå·²ç»å¸¦æœ‰äº† â€œchasedâ€ å’Œ â€œdogâ€ çš„â€œå½±å­â€ã€‚</li>
<li><strong>ä»¥æ­¤ç±»æ¨</strong>ï¼šæ¯ä¸€å±‚éƒ½å»ºç«‹åœ¨å‰ä¸€å±‚çš„åŸºç¡€ä¸Šï¼Œä¿¡æ¯å¯ä»¥åƒæ¶Ÿæ¼ªä¸€æ ·ï¼Œé€šè¿‡ä¸­é—´tokenä¸€è·³ä¸€è·³åœ°ä¼ æ’­åˆ°æ›´è¿œçš„åœ°æ–¹ã€‚ç»è¿‡å¤šå±‚å †å ï¼Œä¸€ä¸ªtokençš„è¡¨ç¤ºå°±èƒ½å¤Ÿèšåˆåˆ°è·¨è¶Šæ•´ä¸ªåºåˆ—çš„ã€éå¸¸å¤æ‚çš„é—´æ¥ä¾èµ–å…³ç³»ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<br>
<h2 id="LLM-Train">LLM-Train</h2>
<h3 id="Base-2">Base</h3>
<img src="/2025/03/19/LLM-Rela/image-20250613213945162.png" class="" title="image-20250613213945162">
<h3 id="Parallelism">Parallelism</h3>
<h4 id="DataParallel">DataParallel</h4>
<blockquote>
<p>è¿™ä¸è”é‚¦å­¦ä¹ å—</p>
</blockquote>
<p>æ•°æ®å¹¶è¡Œ DataParallel (DP) - ç›¸åŒçš„è®¾ç½®è¢«å¤åˆ¶å¤šæ¬¡ï¼Œæ¯æ¬¡éƒ½è¾“å…¥ä¸€éƒ¨åˆ†æ•°æ®ã€‚å¤„ç†æ˜¯å¹¶è¡Œè¿›è¡Œçš„ï¼Œæ‰€æœ‰è®¾ç½®åœ¨æ¯ä¸ªè®­ç»ƒæ­¥éª¤ç»“æŸæ—¶åŒæ­¥ã€‚</p>
<ol>
<li><strong>æ¨¡å‹å¤åˆ¶</strong>ï¼šå°†<strong>ç›¸åŒçš„æ¨¡å‹</strong>ï¼ˆåŒ…æ‹¬å‚æ•°ã€ä¼˜åŒ–å™¨çŠ¶æ€ç­‰ï¼‰å¤åˆ¶åˆ°å¤šä¸ªGPUä¸Šã€‚</li>
<li><strong>æ•°æ®åˆ†ç‰‡</strong>ï¼šå°†è®­ç»ƒæ•°æ®<strong>åˆ’åˆ†ä¸ºå¤šä¸ªå­æ‰¹æ¬¡ï¼ˆmini-batchï¼‰</strong>ï¼Œæ¯ä¸ªGPUå¤„ç†ä¸€ä¸ªå­æ‰¹æ¬¡ã€‚</li>
<li><strong>å¹¶è¡Œè®¡ç®—</strong>ï¼šæ‰€æœ‰GPU<strong>å¹¶è¡Œæ‰§è¡Œå‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­</strong>ï¼Œè®¡ç®—å„è‡ªå­æ‰¹æ¬¡çš„æ¢¯åº¦ã€‚</li>
<li><strong>æ¢¯åº¦åŒæ­¥</strong>ï¼šé€šè¿‡<strong>å…¨å±€é€šä¿¡</strong>ï¼ˆå¦‚AllReduceï¼‰æ”¶é›†æ‰€æœ‰æ¢¯åº¦å¹¶æ±‚å¹³å‡ï¼Œæ›´æ–°ä¸€æ¬¡å…¨å±€æ¨¡å‹å‚æ•°ã€‚</li>
</ol>
<img src="/2025/03/19/LLM-Rela/0.png" class="" title="alt text">
<p>å›¾ä¸­å¯¹æ¯”äº†ä¸åŒæ•°æ®å¹¶è¡Œç­–ç•¥çš„èµ„æºæ¶ˆè€—ï¼ˆä»¥N=64ä¸ªGPUä¸ºä¾‹ï¼‰ï¼š</p>
<p><strong>Baselineï¼ˆçº¯æ•°æ®å¹¶è¡Œï¼‰</strong></p>
<ul>
<li><strong>å†…å­˜æ¶ˆè€—</strong>ï¼š120GBï¼ˆæœ€é«˜ï¼‰
<ul>
<li>åŸå› ï¼šæ¯ä¸ªGPUéœ€å­˜å‚¨å®Œæ•´çš„æ¨¡å‹å‚æ•°ï¼ˆè“è‰²ï¼‰ã€æ¢¯åº¦ï¼ˆæ©™è‰²ï¼‰å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆç»¿è‰²ï¼‰ï¼Œæ— ä»»ä½•åˆ†åŒºä¼˜åŒ–ã€‚</li>
</ul>
</li>
<li><strong>é€šä¿¡é‡</strong>ï¼š1xï¼ˆåŸºå‡†ï¼‰
<ul>
<li>éœ€åŒæ­¥æ‰€æœ‰GPUçš„æ¢¯åº¦ï¼ˆé€šä¿¡é‡éšGPUæ•°é‡çº¿æ€§å¢é•¿ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ä¼˜åŒ–ç­–ç•¥ï¼ˆ$P_{os}ã€P_{os+g}ã€P_{os+g+p}$ï¼‰</strong></p>
<ul>
<li><strong>$P_{os}$</strong>ï¼šä»…å¯¹ä¼˜åŒ–å™¨çŠ¶æ€åˆ†åŒº
<ul>
<li>å†…å­˜é™è‡³16.6GBï¼ˆä¼˜åŒ–å™¨çŠ¶æ€åˆ†åˆ°ä¸åŒGPUï¼‰ã€‚</li>
</ul>
</li>
<li><strong>$P_{os+g}$</strong>ï¼šä¼˜åŒ–å™¨çŠ¶æ€+æ¢¯åº¦åˆ†åŒº
<ul>
<li>å†…å­˜è¿›ä¸€æ­¥é™ä½ï¼ˆæ¢¯åº¦ä¸å†å…¨å­˜å‚¨ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>$P_{os+g+p}$</strong>ï¼šå‚æ•°ã€æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€å…¨åˆ†åŒº
<ul>
<li>å†…å­˜æœ€ä½ï¼ˆ1.9GBï¼‰ï¼Œä½†é€šä¿¡é‡å¢è‡³1.5xï¼ˆéœ€é¢å¤–åŒæ­¥å‚æ•°ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<br>
<h4 id="TensorParallel">TensorParallel</h4>
<p>æ¯ä¸ªå¼ é‡è¢«åˆ†æˆå¤šä¸ªå—ï¼Œå› æ­¤ä¸æ˜¯å°†æ•´ä¸ªå¼ é‡é©»ç•™åœ¨å•ä¸ª gpu ä¸Šï¼Œè€Œæ˜¯å°†å¼ é‡çš„æ¯ä¸ªåˆ†ç‰‡é©»ç•™åœ¨å…¶æŒ‡å®šçš„ gpu ä¸Šã€‚åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªåˆ†ç‰‡åœ¨ä¸åŒçš„ GPU ä¸Šå•ç‹¬å¹¶è¡Œå¤„ç†ï¼Œç»“æœåœ¨æ­¥éª¤ç»“æŸæ—¶åŒæ­¥ã€‚è¿™å°±æ˜¯æ‰€è°“çš„æ°´å¹³å¹¶è¡Œï¼Œå› ä¸ºæ‹†åˆ†å‘ç”Ÿåœ¨æ°´å¹³å±‚é¢ã€‚</p>
<img src="/2025/03/19/LLM-Rela/4.png" class="" title="alt text">
<br>
<h4 id="PipelineParallel">PipelineParallel</h4>
<p>å°†æ¨¡å‹çš„ä¸åŒå±‚åˆ†å¸ƒåœ¨ä¸åŒ GPU ä¸Šï¼Œæ¯å¼  GPU è´Ÿè´£æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œ<strong>è¾“å…¥æ•°æ®æŒ‰ micro-batch æµæ°´å¤„ç†</strong>ã€‚</p>
<p>å‡è®¾æ¨¡å‹æœ‰ 8 å±‚ï¼š</p>
<ul>
<li>GPU0 è´Ÿè´£ç¬¬ 1~4 å±‚</li>
<li>GPU1 è´Ÿè´£ç¬¬ 5~8 å±‚</li>
<li>å°† batch size ä¸º 64 åˆ†ä¸º 4 ä¸ª micro-batchï¼ˆæ¯ä¸ª 16 æ¡æ•°æ®ï¼‰</li>
<li>micro-batch1 æµç» GPU0ï¼ŒGPU1ï¼Œæ¥ç€ micro-batch2 å¼€å§‹å¤„ç†ï¼Œå®ç°æµæ°´çº¿å¹¶è¡Œ</li>
</ul>
<br>
<h3 id="Deepspeed">Deepspeed</h3>
<br>
<h3 id="FSDP">FSDP</h3>
<br>
<h2 id="LLM-Inference">LLM-Inference</h2>
<h3 id="Parameters">Parameters</h3>
<h4 id="Temperature">Temperature</h4>
<p><strong>æ¸©åº¦å‚æ•°æ§åˆ¶è¾“å‡ºéšæœºæ€§ï¼ˆå¤šæ ·æ€§ï¼‰çš„è¶…å‚æ•°ã€‚</strong></p>
<p>å°†æ¨¡å‹è¾“å‡ºçš„ logitsï¼ˆåŸå§‹åˆ†æ•°ï¼‰é™¤ä»¥æ¸©åº¦å€¼ï¼Œç„¶åå†ç»è¿‡ softmaxï¼Œè®¡ç®—å‡ºæ–°çš„æ¦‚ç‡åˆ†å¸ƒï¼š<br>
$$<br>
P_i = \frac{e^{\frac{logit_i}{T}}}{\sum_j e^{\frac{logit_j}{T}}}<br>
$$</p>
<ul>
<li><strong>T &lt; 1</strong> â†’ å¢å¼ºé«˜æ¦‚ç‡è¯ï¼Œå‰Šå¼±ä½æ¦‚ç‡è¯</li>
<li><strong>T &gt; 1</strong> â†’ æ‰å¹³åŒ–åˆ†å¸ƒï¼Œä½æ¦‚ç‡è¯è·å¾—æ›´å¤šæœºä¼š</li>
<li><strong>T = 1</strong> â†’ åŸå§‹ softmax åˆ†å¸ƒ</li>
</ul>
<blockquote>
<p>æ¸©åº¦å¯¹æ¨¡å‹è¾“å‡ºçš„å½±å“ç›¸å½“äºæ”¹è¿›ç‰ˆçš„softmaxå±‚</p>
</blockquote>
<br>
<h4 id="Sampling">Sampling</h4>
<p>Top-K</p>
<p>Top-Kæ§åˆ¶çš„æ˜¯â€œåªåœ¨å‰Kä¸ªæœ€æœ‰å¯èƒ½çš„è¯ä¸­é‡‡æ ·â€ã€‚</p>
<ul>
<li><strong>K=1</strong> â†’ åªé€‰æ¦‚ç‡æœ€å¤§çš„è¯ï¼ˆç­‰åŒäºè´ªå©ªæœç´¢ï¼‰</li>
<li><strong>K=10</strong> â†’ ä»æ¦‚ç‡å‰10çš„è¯ä¸­è¿›è¡Œéšæœºé€‰æ‹©</li>
<li><strong>K=100+</strong> â†’ è¶Šå¤§ï¼Œè¶Šæ¥è¿‘å…¨æ¦‚ç‡åˆ†å¸ƒï¼Œè¾“å‡ºæ›´æœ‰åˆ›é€ æ€§</li>
</ul>
<img src="/2025/03/19/LLM-Rela/6.png" class="" title="alt text">
<br>
<p>Top-p</p>
<p>ä½¿ç”¨éšæœºç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¾“å‡ºï¼Œå€™é€‰é›†ä¸ºæŒ‰æ¦‚ç‡æ’åé å‰çš„è¿ç»­ç»“æœï¼Œä¸”ç´¯ç§¯æ¦‚ç‡&lt;=p</p>
<img src="/2025/03/19/LLM-Rela/6.png" class="" title="alt text">
<br>
<h2 id="Fine-Tuning">Fine-Tuning</h2>
<p>é«˜æ•ˆå¾®è°ƒæŠ€æœ¯åˆ†ç±»ï¼š</p>
<ul>
<li>å¢åŠ é¢å¤–å‚æ•°ï¼ˆAï¼‰
<ul>
<li>ç±»é€‚é…å™¨ï¼ˆAdapter-likeï¼‰æ–¹æ³•</li>
<li>è½¯æç¤ºï¼ˆSoft promptsï¼‰</li>
</ul>
</li>
<li>é€‰å–ä¸€éƒ¨åˆ†å‚æ•°æ›´æ–°ï¼ˆSï¼‰</li>
<li>å¼•å…¥é‡å‚æ•°åŒ–ï¼ˆRï¼‰</li>
</ul>
<img src="/2025/03/19/LLM-Rela/v2-eaaf1c00d0c4ea350cd3a79b47de26d3_1440w.jpg" class="" title="img">
<br>
<h3 id="BitFit-Prefix-Tuning-Prompt-Tuning">BitFit, Prefix Tuning &amp; Prompt Tuning</h3>
<p>BitFitï¼ˆè®ºæ–‡ï¼š<strong>BitFit: Simple Parameter-efficient Fine-tuning or Transformer-based Masked Language-models</strong>ï¼‰æ˜¯ä¸€ç§ç¨€ç–çš„å¾®è°ƒæ–¹æ³•ï¼Œå®ƒè®­ç»ƒæ—¶åªæ›´æ–°biasçš„å‚æ•°æˆ–è€…éƒ¨åˆ†biaså‚æ•°ã€‚</p>
<p>æ¶‰åŠåˆ°çš„biaså‚æ•°æœ‰attentionæ¨¡å—ä¸­è®¡ç®—query,key,valueè·Ÿåˆå¹¶å¤šä¸ªattentionç»“æœæ—¶æ¶‰åŠåˆ°çš„biasï¼ŒMLPå±‚ä¸­çš„biasï¼ŒLayernormalizationå±‚çš„biaså‚æ•°ã€‚</p>
<br>
<p>Prefix Tuningï¼ˆè®ºæ–‡ï¼š<strong>Prefix-Tuning: Optimizing Continuous Prompts for Generation</strong>ï¼‰ï¼Œåœ¨è¾“å…¥tokenä¹‹å‰æ„é€ ä¸€æ®µä»»åŠ¡ç›¸å…³çš„virtual tokensä½œä¸ºPrefixï¼Œç„¶åè®­ç»ƒçš„æ—¶å€™åªæ›´æ–°Prefixéƒ¨åˆ†çš„å‚æ•°ï¼Œè€ŒPLM(Pretrain LM)ä¸­çš„å…¶ä»–éƒ¨åˆ†å‚æ•°å›ºå®šã€‚</p>
<br>
<p>Prompt Tuningï¼ˆè®ºæ–‡ï¼š<strong>The Power of Scale for Parameter-Efficient Prompt Tuning</strong>ï¼‰ï¼Œè¯¥æ–¹æ³•å¯ä»¥çœ‹ä½œæ˜¯Prefix Tuningçš„ç®€åŒ–ç‰ˆæœ¬ï¼Œå®ƒç»™æ¯ä¸ªä»»åŠ¡å®šä¹‰äº†è‡ªå·±çš„Promptï¼Œç„¶åæ‹¼æ¥åˆ°æ•°æ®ä¸Šä½œä¸ºè¾“å…¥ï¼Œä½†<strong>åªåœ¨è¾“å…¥å±‚åŠ å…¥prompt tokens</strong>ï¼Œå¹¶ä¸”ä¸éœ€è¦åŠ å…¥ MLP è¿›è¡Œè°ƒæ•´æ¥è§£å†³éš¾è®­ç»ƒçš„é—®é¢˜ã€‚</p>
<br>
<h3 id="P-Tuning">P-Tuning</h3>
<p>P-Tuningï¼ˆè®ºæ–‡ï¼š<strong>GPT Understands, Too</strong>ï¼‰ï¼Œè¯¥æ–¹æ³•å°†Promptè½¬æ¢ä¸ºå¯ä»¥å­¦ä¹ çš„Embeddingå±‚ï¼Œå¹¶ç”¨MLP+LSTMçš„æ–¹å¼æ¥å¯¹Prompt Embeddingè¿›è¡Œä¸€å±‚å¤„ç†ã€‚</p>
<p>ç›¸æ¯”Prefix Tuningï¼ŒP-TuningåŠ å…¥çš„å¯å¾®çš„virtual tokenï¼Œä½†ä»…é™äºè¾“å…¥å±‚ï¼Œæ²¡æœ‰åœ¨æ¯ä¸€å±‚éƒ½åŠ ï¼›å¦å¤–ï¼Œvirtual tokençš„ä½ç½®ä¹Ÿä¸ä¸€å®šæ˜¯å‰ç¼€ï¼Œæ’å…¥çš„ä½ç½®æ˜¯å¯é€‰çš„ã€‚è¿™é‡Œçš„å‡ºå‘ç‚¹å®é™…æ˜¯æŠŠä¼ ç»Ÿäººå·¥è®¾è®¡æ¨¡ç‰ˆä¸­çš„çœŸå®tokenæ›¿æ¢æˆå¯å¾®çš„virtual tokenã€‚</p>
<p>P-Tuning v2ï¼ˆè®ºæ–‡ï¼š <strong>P-Tuning v2: Prompt Tuning Can Be Comparable to Fine-tuning Universally Across Scales and Tasks</strong>ï¼‰ï¼Œè¯¥æ–¹æ³•åœ¨æ¯ä¸€å±‚éƒ½åŠ å…¥äº†Prompts tokensä½œä¸ºè¾“å…¥ï¼Œè€Œä¸æ˜¯ä»…ä»…åŠ åœ¨è¾“å…¥å±‚</p>
<br>
<h3 id="Adapter-Tuning">Adapter Tuning</h3>
<p>Adapter Tuningï¼ˆè®ºæ–‡ï¼š<strong>Parameter-Efficient Transfer Learning for NLP</strong>ï¼‰ï¼Œè¯¥æ–¹æ³•è®¾è®¡äº†Adapterç»“æ„ï¼Œå¹¶å°†å…¶åµŒå…¥Transformerçš„ç»“æ„é‡Œé¢ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªTransformerå±‚ï¼Œå¢åŠ äº†ä¸¤ä¸ªAdapterç»“æ„(åˆ†åˆ«æ˜¯å¤šå¤´æ³¨æ„åŠ›çš„æŠ•å½±ä¹‹åå’Œç¬¬äºŒä¸ªfeed-forwardå±‚ä¹‹å)ï¼Œåœ¨è®­ç»ƒæ—¶ï¼Œå›ºå®šä½åŸæ¥é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°ä¸å˜ï¼Œåªå¯¹æ–°å¢çš„ Adapter ç»“æ„å’Œ Layer Norm å±‚è¿›è¡Œå¾®è°ƒï¼Œä»è€Œä¿è¯äº†è®­ç»ƒçš„é«˜æ•ˆæ€§ã€‚</p>
<p>Adapter Fusionï¼ˆè®ºæ–‡ï¼š<strong>AdapterFusion:Non-Destructive Task Composition for Transfer Learning</strong>ï¼‰ï¼Œä¸€ç§èåˆå¤šä»»åŠ¡ä¿¡æ¯çš„Adapterçš„å˜ä½“ï¼Œåœ¨ Adapter çš„åŸºç¡€ä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œé€šè¿‡å°†å­¦ä¹ è¿‡ç¨‹åˆ†ä¸ºä¸¤é˜¶æ®µæ¥æå‡ä¸‹æ¸¸ä»»åŠ¡è¡¨ç°ã€‚</p>
<p>AdapterDropï¼ˆè®ºæ–‡ï¼šAdapterDrop: On the Efficiency of Adapters in Transformersï¼‰ï¼Œåœ¨ä¸å½±å“ä»»åŠ¡æ€§èƒ½çš„æƒ…å†µä¸‹ï¼Œå¯¹AdapteråŠ¨æ€é«˜æ•ˆçš„ç§»é™¤ï¼Œå°½å¯èƒ½çš„å‡å°‘æ¨¡å‹çš„å‚æ•°é‡ï¼Œæé«˜æ¨¡å‹åœ¨åå‘ä¼ æ’­ï¼ˆè®­ç»ƒï¼‰å’Œæ­£å‘ä¼ æ’­ï¼ˆæ¨ç†ï¼‰æ—¶çš„æ•ˆç‡ã€‚</p>
<br>
<h3 id="LoRA">LoRA</h3>
<h4 id="å¥‡å¼‚å€¼åˆ†è§£ä¸ä½ç§©åˆ†è§£">å¥‡å¼‚å€¼åˆ†è§£ä¸ä½ç§©åˆ†è§£</h4>
<p><strong>SVD</strong></p>
<p>å¯¹äºä»»æ„ä¸€ä¸ª $m \times n$ çš„å®çŸ©é˜µ $A$ï¼Œå¯ä»¥åˆ†è§£æˆä¸‰ä¸ªçŸ©é˜µçš„ä¹˜ç§¯ï¼š<br>
$$<br>
A = U \Sigma V^T<br>
$$</p>
<ul>
<li>$U$ï¼š$m \times m$ çš„æ­£äº¤çŸ©é˜µï¼ˆå·¦å¥‡å¼‚å‘é‡ï¼‰</li>
<li>$\Sigma$ï¼š$m \times n$ çš„å¯¹è§’çŸ©é˜µï¼Œå¯¹è§’çº¿ä¸Šçš„å€¼æ˜¯å¥‡å¼‚å€¼ï¼ˆéè´Ÿï¼ŒæŒ‰å¤§å°æ’åˆ—ï¼‰</li>
<li>$V^T$ï¼š$n \times n$ çš„æ­£äº¤çŸ©é˜µï¼ˆå³å¥‡å¼‚å‘é‡çš„è½¬ç½®ï¼‰</li>
</ul>
<br>
<p><strong>ä½ç§©åˆ†è§£</strong></p>
<p>ræ˜¯çŸ©é˜µçš„ç§©ï¼Œå†³å®šäº†åˆ†è§£åä¿ç•™çš„ä¿¡æ¯é‡ã€‚å¦‚æœåªä¿ç•™æœ€å¤§çš„å‡ ä¸ªå¥‡å¼‚å€¼ï¼ˆä½ç§©è¿‘ä¼¼ï¼‰ï¼Œå°±èƒ½ç”¨æ›´å°‘çš„å‚æ•°è¿‘ä¼¼åŸçŸ©é˜µ</p>
<p>ä¾‹å¦‚ï¼Œå­˜åœ¨çŸ©é˜µ<br>
$$<br>
S = \begin{bmatrix}<br>
1 &amp; 0 &amp; 0 &amp; 2 &amp; 0 \<br>
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \<br>
0 &amp; 3 &amp; 0 &amp; 0 &amp; 0 \<br>
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \<br>
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \<br>
\end{bmatrix}<br>
$$<br>
åˆ†è§£åçš„ä¸‰ä¸ªçŸ©é˜µï¼š<br>
$$<br>
U \approx \begin{bmatrix}<br>
0.3 &amp; 0 &amp; 0.34 &amp; -0.68 &amp; -0.58 \<br>
-0.22 &amp; 0 &amp; -0.76 &amp; 0.2 &amp; -0.58 \<br>
0 &amp; -1 &amp; 0 &amp; 0 &amp; 0 \<br>
-0.77 &amp; 0 &amp; 0.36 &amp; 0.52 &amp; 0 \<br>
-0.52 &amp; 0 &amp; -0.42 &amp; -0.48 &amp; -0.58 \<br>
\end{bmatrix}, \quad<br>
\Sigma = \begin{bmatrix}<br>
7.03 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \<br>
0 &amp; 3 &amp; 0 &amp; 0 &amp; 0 \<br>
0 &amp; 0 &amp; 2.15 &amp; 0 &amp; 0 \<br>
0 &amp; 0 &amp; 0 &amp; 0.11 &amp; 0 \<br>
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \<br>
\end{bmatrix}, \quad<br>
V \approx \begin{bmatrix}<br>
0.34 &amp; -0.32 &amp; 0 &amp; -0.89 &amp; 0 \<br>
0 &amp; 0 &amp; -1 &amp; 0 &amp; 0 \<br>
0.3 &amp; -0.93 &amp; 0 &amp; 0.22 &amp; 0 \<br>
-0.89 &amp; -0.19 &amp; 0 &amp; 0.41 &amp; 0 \<br>
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \<br>
\end{bmatrix}<br>
$$<br>
é€‰æ‹©æœ€å¤§çš„ä¸‰ä¸ªå¥‡å¼‚å€¼é‡æ„ï¼Œä¿ç•™ $\sigma_{1} \approx 7.03$, $\sigma_{2} = 3$, $\sigma_{3}=2.15$ï¼Œé‡æ„çŸ©é˜µå¦‚ä¸‹ï¼š</p>
<p>ä¿ç•™å‰ä¸‰åˆ—ï¼š</p>
<p>$$<br>
U_{\text{trunc}} \approx<br>
\begin{bmatrix}<br>
0.3 &amp; 0 &amp; 0.34 \<br>
-0.22 &amp; 0 &amp; -0.76 \<br>
0 &amp; -1 &amp; 0 \<br>
-0.77 &amp; 0 &amp; 0.36 \<br>
-0.52 &amp; 0 &amp; -0.428<br>
\end{bmatrix}<br>
$$<br>
ä¿ç•™å‰ä¸‰è¡Œå’Œå‰ä¸‰åˆ—ï¼š</p>
<p>$$<br>
\Sigma_{\text{trunc}} =<br>
\begin{bmatrix}<br>
7.03 &amp; 0 &amp; 0 \<br>
0 &amp; 3 &amp; 0 \<br>
0 &amp; 0 &amp; 2.15<br>
\end{bmatrix}<br>
$$<br>
ä¿ç•™å‰ä¸‰è¡Œï¼š</p>
<p>$$<br>
V_{\text{trunc}} \approx<br>
\begin{bmatrix}<br>
0.34 &amp; -0.32 &amp; 0 &amp; -0.89 &amp; 0 \<br>
0 &amp; 0 &amp; -1 &amp; 0 &amp; 0 \<br>
0.3 &amp; -0.93 &amp; 0 &amp; 0.22 &amp; 0<br>
\end{bmatrix}<br>
$$<br>
æ ¹æ®ï¼Œ$Sâ€™ = U_{\text{trunc}} \times \Sigma_{\text{trunc}} \times V_{\text{trunc}}^T$ï¼Œè®¡ç®—å¾—åˆ°é‡æ„åï¼š</p>
<p>$$<br>
Sâ€™ =<br>
\begin{bmatrix}<br>
0.93 &amp; -0.01 &amp; 0 &amp; 2.03 &amp; 0 \<br>
0.02 &amp; 2 &amp; 0 &amp; 0.99 &amp; 0 \<br>
0 &amp; 0 &amp; 3 &amp; 0 &amp; 0 \<br>
2.05 &amp; 1.01 &amp; 0 &amp; 4.98 &amp; 0 \<br>
0.95 &amp; 1.99 &amp; 0 &amp; 3.02 &amp; 0<br>
\end{bmatrix}<br>
$$<br>
ç»“æœå¯¹æ¯”åŸå§‹çŸ©é˜µå’Œé‡æ„çŸ©é˜µï¼Œç›´è§‚åœ°çœ‹ï¼ŒåŸºæœ¬ä¿æŒä¸€è‡´ã€‚</p>
<p>äº‹å®ä¸Šä¸Šé¢çš„ç»“è®ºï¼šå¦‚æœåªä¿ç•™æœ€å¤§çš„å‡ ä¸ªå¥‡å¼‚å€¼ï¼ˆä½ç§©è¿‘ä¼¼ï¼‰ï¼Œå°±èƒ½ç”¨æ›´å°‘çš„å‚æ•°è¿‘ä¼¼ $W$ã€‚<br>
$$<br>
S =<br>
\begin{bmatrix}<br>
1 &amp; 0 &amp; 0 &amp; 2 &amp; 0 \<br>
0 &amp; 2 &amp; 0 &amp; 1 &amp; 0 \<br>
0 &amp; 0 &amp; 3 &amp; 0 &amp; 0 \<br>
2 &amp; 1 &amp; 0 &amp; 5 &amp; 0 \<br>
1 &amp; 2 &amp; 0 &amp; 3 &amp; 0<br>
\end{bmatrix}<br>
\quad<br>
Sâ€™ =<br>
\begin{bmatrix}<br>
0.93 &amp; -0.01 &amp; 0 &amp; 2.03 &amp; 0 \<br>
0.02 &amp; 2 &amp; 0 &amp; 0.99 &amp; 0 \<br>
0 &amp; 0 &amp; 3 &amp; 0 &amp; 0 \<br>
2.05 &amp; 1.01 &amp; 0 &amp; 4.98 &amp; 0 \<br>
0.95 &amp; 1.99 &amp; 0 &amp; 3.02 &amp; 0<br>
\end{bmatrix}<br>
$$<br>
å®é™…ä¸Šï¼Œå¯ä»¥é€šè¿‡ä¿ç•™çš„å¥‡å¼‚å€¼ï¼Œè®¡ç®—é‡æ„åçš„çŸ©é˜µï¼Œä¿ç•™äº†å¤šå°‘ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p>
<p>$$<br>
|A|_F^2 = 7.03^2 + 3^2 + 2.15^2 + 0.11^2 + 0^2 \approx 63.06<br>
\quad<br>
|Aâ€™|_F^2 = 7.03^2 + 3^2 + 2.15^2 \approx 63.04<br>
$$</p>
<p>$$<br>
\text{ä¿¡æ¯ä¿ç•™æ¯”ä¾‹} = \frac{63.04}{63.06} \approx 99.97%<br>
$$</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆLoRAå¯ä»¥è¿›è¡Œä½ç§©åˆ†è§£ï¼Ÿ</p>
<p>é€šè¿‡å¯¹å¾®è°ƒåçš„æƒé‡å˜åŒ– $\Delta W$ çš„å¥‡å¼‚å€¼åˆ†è§£å‘ç°ï¼Œå¤§éƒ¨åˆ†ä¿¡æ¯é›†ä¸­åœ¨å°‘æ•°å‡ ä¸ªå¥‡å¼‚å€¼ä¸Šï¼›åœ¨GPT-3ä¸Šæµ‹è¯•æ—¶å‘ç°ï¼Œ$\Delta W$ çš„å‰ 10 - 20 ä¸ªå¥‡å¼‚å€¼å æ®äº† 90% çš„ä¿¡æ¯</p>
<p>å¯ä»¥å¯¹åŸå§‹æƒé‡ $W$ è¿›è¡Œåˆ†è§£å—ï¼Ÿ</p>
<p>ä¸å¯ä»¥ï¼Œ$W$ æ¥è¿‘æ»¡ç§©</p>
</blockquote>
<p>å‡è®¾å¯¹ä¸€ä¸ª $512 \times 512$ çš„æƒé‡çŸ©é˜µ $W$ è¿›è¡Œå¾®è°ƒ</p>
<ul>
<li>å…¨å¾®è°ƒï¼šå¯èƒ½éœ€è¦è°ƒæ•´ 262144 ä¸ªå‚æ•°</li>
<li>LoRAï¼šå‡è®¾ r = 8ï¼Œåªéœ€è¦è°ƒæ•´ $A(512 \times 8)$ å’Œ $B(8 \times 512)$ï¼Œå…± 8192 ä¸ªå‚æ•°</li>
</ul>
<br>
<h4 id="LoRAåº”ç”¨ä½ç½®">LoRAåº”ç”¨ä½ç½®</h4>
<p><strong>æ³¨æ„åŠ›å±‚</strong></p>
<p>å¤šåº”ç”¨ä¸ $W_q$ å’Œ $W_v$ ä¸Š</p>
<p><strong>FFNå±‚</strong></p>
<p>$W_1$ (å‡ç»´)å’Œ $W_2$ (é™ç»´)</p>
<br>
<h4 id="LoRAæ”¹è¿›">LoRAæ”¹è¿›</h4>
<h5 id="LoRA-2">LoRA+</h5>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå¯¹ä½ç§©çŸ©é˜µ $A$ å’Œ $B$ è®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡ï¼Œä»¥å¢å¼ºè®­ç»ƒåŠ¨æ€æ€§ã€‚</p>
<p>åœ¨æ ‡å‡† LoRA ä¸­ï¼Œæƒé‡æ›´æ–°ä¸ºï¼š</p>
<p>$$<br>
\Delta W = A B, \quad A \in \mathbb{R}^{d \times r}, ; B \in \mathbb{R}^{r \times d}<br>
$$</p>
<p>LoRA+ è®¾ç½®ç‹¬ç«‹çš„å­¦ä¹ ç‡ï¼š</p>
<p>$$<br>
A \leftarrow A - \eta_A \cdot \nabla_A \mathcal{L}, \quad B \leftarrow B - \eta_B \cdot \nabla_B \mathcal{L}<br>
$$</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>$\eta_A$ï¼šA çš„å­¦ä¹ ç‡</li>
<li>$\eta_B$ï¼šB çš„å­¦ä¹ ç‡</li>
<li>é€šå¸¸è®¾ç½® $\eta_B = \lambda \cdot \eta_A$ï¼Œ$\lambda \in [4, 16]$</li>
</ul>
<br>
<h5 id="DoRA">DoRA</h5>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå¼•å…¥å¯¹æ®‹å·®ç»“æ„çš„é‡æ„æœºåˆ¶ï¼Œæ›´æœ‰æ•ˆåœ°åˆ©ç”¨å‚æ•°ç©ºé—´ã€‚</p>
<p>æ ‡å‡† LoRA æ›´æ–°ä¸ºï¼š<br>
$$<br>
W = W_0 + \Delta W = W_0 + A B<br>
$$<br>
è€Œ DoRA å°†æ®‹å·®éƒ¨åˆ†è¿›ä¸€æ­¥åˆ†è§£ä¸ºï¼š</p>
<p>$$<br>
W = U \cdot S \cdot V^T<br>
$$</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>ä¸ºä½ç§©åŸº</li>
<li>ä¸ºå¯å­¦ä¹ çš„å¯¹è§’çŸ©é˜µæˆ–å…¨è¿æ¥çŸ©é˜µï¼ˆå¢å¼ºè¡¨è¾¾èƒ½åŠ›ï¼‰</li>
</ul>
<p>è‹¥å¼•å…¥æ­£åˆ™é¡¹ï¼Œåˆ™å®Œæ•´ç›®æ ‡å‡½æ•°ä¸ºï¼š<br>
$$<br>
\mathcal{L}<em>{\text{total}} = \mathcal{L}</em>{\text{task}} + \lambda |S|_F^2<br>
$$</p>
<br>
<h5 id="rsLoRA">rsLoRA</h5>
<p>rsLoRA é’ˆå¯¹ä¸åŒå±‚è®¾ç½®ä¸åŒçš„ç§©ï¼ˆrankï¼‰ï¼Œä»¥ä¾¿æ›´çµæ´»åœ°åˆ†é…å‚æ•°é‡ã€‚<br>
<strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šä¸ºæ¯ä¸€å±‚è®¾ç½®ä¸åŒçš„ç§© $r^{(l)}$ï¼Œæé«˜å‚æ•°ä½¿ç”¨æ•ˆç‡ã€‚</p>
<p>å¯¹äºç¬¬ $l$ å±‚ï¼Œæœ‰ï¼š<br>
$$<br>
\Delta W^{(l)} = A^{(l)} B^{(l)}, \quad A^{(l)} \in \mathbb{R}^{d \times r^{(l)}}, ; B^{(l)} \in \mathbb{R}^{r^{(l)} \times d}<br>
$$<br>
è®­ç»ƒè¿‡ç¨‹ä¸­å¯ä»¥æ‰‹åŠ¨è®¾å®š rank æˆ–ä½¿ç”¨å¯å‘å¼å‡½æ•°è‡ªåŠ¨é€‰æ‹©ï¼š<br>
$$<br>
r^{(l)} = f\left( |W^{(l)}|, \sigma^{(l)} \right)<br>
$$<br>
å…¶ä¸­ $\sigma^{(l)}$ å¯ä¸ºç‰¹å¾è°±æˆ–æ¢¯åº¦èŒƒæ•°ã€‚</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>æé«˜è®¡ç®—æ•ˆç‡ï¼›</li>
<li>ä¿æŒæ€§èƒ½çš„åŒæ—¶å‡å°‘å†—ä½™å‚æ•°ã€‚</li>
</ul>
<br>
<h5 id="PiSSA">PiSSA</h5>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šç”¨å¥‡å¼‚å€¼åˆ†è§£ï¼ˆSVDï¼‰åˆå§‹åŒ– $A$ å’Œ $B$ï¼Œæ›´å¥½åœ°ä¿æŒåŸå§‹æƒé‡ç»“æ„ã€‚</p>
<p>å°†åŸå§‹çŸ©é˜µ $W$ åˆ†è§£ä¸ºï¼š<br>
$$<br>
W \approx U_r \Sigma_r V_r^T<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li>$U_r \in \mathbb{R}^{d \times r}, ; \Sigma_r \in \mathbb{R}^{r \times r}, ; V_r \in \mathbb{R}^{d \times r}$</li>
<li>ä¿ç•™å‰ $r$ ä¸ªå¥‡å¼‚å€¼ï¼ˆæˆªæ–­ SVDï¼‰</li>
</ul>
<p>åˆå§‹åŒ–ä¸ºï¼š<br>
$$<br>
A = U_r \cdot \sqrt{\Sigma_r}, \quad B = \sqrt{\Sigma_r} \cdot V_r^T<br>
$$<br>
å› æ­¤ï¼š<br>
$$<br>
\Delta W = A B = U_r \Sigma_r V_r^T \approx W_r<br>
$$<br>
<strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>æ›´æ¥è¿‘åŸå§‹å‚æ•°ç©ºé—´ï¼›</li>
<li>é¿å…éšæœºåˆå§‹åŒ–å¸¦æ¥çš„ä¸ç¨³å®šæ€§ï¼›</li>
<li>æå‡åˆæœŸè®­ç»ƒæ”¶æ•›é€Ÿåº¦ã€‚</li>
</ul>
<h4 id="LoRAç›¸å…³è®ºæ–‡">LoRAç›¸å…³è®ºæ–‡</h4>
<p>LoRAï¼ˆè®ºæ–‡ï¼š<strong>LoRA: LOW-RANK ADAPTATION OF LARGE LANGUAGE MODELS</strong>ï¼‰ï¼Œè¯¥æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯é€šè¿‡ä½ç§©åˆ†è§£æ¥æ¨¡æ‹Ÿå‚æ•°çš„æ”¹å˜é‡ï¼Œä»è€Œä»¥æå°çš„å‚æ•°é‡æ¥å®ç°å¤§æ¨¡å‹çš„é—´æ¥è®­ç»ƒã€‚</p>
<br>
<p>AdaLoRAï¼ˆè®ºæ–‡ï¼š<strong>ADAPTIVE BUDGET ALLOCATION FOR PARAMETEREFFICIENT FINE-TUNING</strong>ï¼‰ï¼Œæ˜¯å¯¹LoRAçš„ä¸€ç§æ”¹è¿›ï¼Œå®ƒæ ¹æ®é‡è¦æ€§è¯„åˆ†åŠ¨æ€åˆ†é…å‚æ•°é¢„ç®—ç»™æƒé‡çŸ©é˜µã€‚</p>
<br>
<p>QLoRAï¼ˆè®ºæ–‡ï¼š <strong>QLORA: Efficient Finetuning of Quantized LLMs</strong>ï¼‰ï¼Œä½¿ç”¨ä¸€ç§æ–°é¢–çš„é«˜ç²¾åº¦æŠ€æœ¯å°†é¢„è®­ç»ƒæ¨¡å‹é‡åŒ–ä¸º 4 bitï¼Œç„¶åæ·»åŠ ä¸€å°ç»„å¯å­¦ä¹ çš„ä½ç§©é€‚é…å™¨æƒé‡ï¼Œè¿™äº›æƒé‡é€šè¿‡é‡åŒ–æƒé‡çš„åå‘ä¼ æ’­æ¢¯åº¦è¿›è¡Œå¾®è°ƒã€‚QLORA æœ‰ä¸€ç§ä½ç²¾åº¦å­˜å‚¨æ•°æ®ç±»å‹ï¼ˆ4 bitï¼‰ï¼Œè¿˜æœ‰ä¸€ç§è®¡ç®—æ•°æ®ç±»å‹ï¼ˆBFloat16ï¼‰ã€‚å®é™…ä¸Šï¼Œè¿™æ„å‘³ç€æ— è®ºä½•æ—¶ä½¿ç”¨ QLoRA æƒé‡å¼ é‡ï¼Œæˆ‘ä»¬éƒ½ä¼šå°†å¼ é‡åé‡åŒ–ä¸º BFloat16ï¼Œç„¶åæ‰§è¡Œ 16 ä½çŸ©é˜µä¹˜æ³•ã€‚QLoRAæå‡ºäº†ä¸¤ç§æŠ€æœ¯å®ç°é«˜ä¿çœŸ 4 bitå¾®è°ƒâ€”â€”4 bit NormalFloat(NF4) é‡åŒ–å’ŒåŒé‡åŒ–ã€‚æ­¤å¤–ï¼Œè¿˜å¼•å…¥äº†åˆ†é¡µä¼˜åŒ–å™¨ï¼Œä»¥é˜²æ­¢æ¢¯åº¦æ£€æŸ¥ç‚¹æœŸé—´çš„å†…å­˜å³°å€¼ï¼Œä»è€Œå¯¼è‡´å†…å­˜ä¸è¶³çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯åœ¨è¿‡å»ä½¿å¾—å¤§å‹æ¨¡å‹éš¾ä»¥åœ¨å•å°æœºå™¨ä¸Šè¿›è¡Œå¾®è°ƒã€‚</p>
<br>
<h4 id="è°ƒå‚æŠ€å·§">è°ƒå‚æŠ€å·§</h4>
<ul>
<li>ä»ä½ç§©å¼€å§‹ï¼šå¯¹äºç»å¤§å¤šæ•°ä»»åŠ¡ï¼Œå¯ä»¥ä» $r=8$ å’Œ $r = 16$ å¼€å§‹è°ƒæ•´ï¼Œè¯„ä¼°æ€§èƒ½åå†å†³å®šæ˜¯å¦éœ€è¦æ›´é«˜çš„ç§©</li>
<li>æ•°æ®é›†å¤§å°ä¸ç§©çš„å…³ç³»ï¼šå°æ•°æ®é›†ï¼ˆ&lt;5k æ ·æœ¬ï¼‰ç”¨ä½ç§©ï¼ˆ$r=8$ï¼‰ï¼›å¤§æ•°æ®é›†ï¼ˆ&gt;50kæ ·æœ¬ï¼‰å¯ä»¥å°è¯•æ›´å¤§ç§©ï¼ˆr=32+ï¼‰</li>
<li>å¤æ‚ä»»åŠ¡ç­–ç•¥ï¼šå¯¹äºå¤æ‚æ¨ç†ä»»åŠ¡ï¼Œå¯ä»¥ç»“åˆä½¿ç”¨ï¼šï¼ˆ1ï¼‰å¢å¤§råˆ°32æˆ–64ï¼›ï¼ˆ2ï¼‰å¯ç”¨rsLoRAï¼›ï¼ˆ3ï¼‰æ·»åŠ æ›´å¤šç›®æ ‡å±‚ï¼›</li>
</ul>
<br>
<h3 id="MAM-Adapter-UniPELT">MAM Adapter &amp; UniPELT</h3>
<p>MAM Adapterï¼ˆè®ºæ–‡ï¼šTOWARDS A UNIFIED VIEW OF PARAMETER-EFFICIENT TRANSFER LEARNINGï¼‰ï¼Œä¸€ä¸ªåœ¨Adapterã€Prefix Tuningå’ŒLoRAä¹‹é—´å»ºç«‹è”ç³»çš„ç»Ÿä¸€æ–¹æ³•ã€‚</p>
<br>
<p>UniPELTï¼ˆè®ºæ–‡ï¼š UNIPELT: A Unified Framework for Parameter-Efficient Language Model Tuningï¼‰æ˜¯ LoRAã€Prefix Tuningå’ŒAdapterçš„é—¨æ§ç»„åˆã€‚</p>
<br>
<h2 id="Reinforce-Learning-on-LLM">Reinforce Learning on LLM</h2>
<h3 id="LLM-DPO">LLM-DPO</h3>
<p>Direct Preference Optimization</p>
<p>DPOçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>è·³è¿‡æ˜¾å¼å¥–åŠ±å»ºæ¨¡å’Œå¤æ‚çš„å¼ºåŒ–å­¦ä¹ æ­¥éª¤ï¼Œç›´æ¥é€šè¿‡ä¸€ä¸ªç®€å•çš„åˆ†ç±»æŸå¤±å‡½æ•°æ¥ä¼˜åŒ–è¯­è¨€æ¨¡å‹ï¼Œä½¿å…¶ç¬¦åˆäººç±»åå¥½ã€‚</strong></p>
<p>å®ƒå°†â€œè®©æ¨¡å‹ç”Ÿæˆé«˜å¥–åŠ±çš„å›ç­”â€è¿™ä¸ªç›®æ ‡ï¼Œç­‰ä»·åœ°è½¬æ¢ä¸ºäº†â€œç›´æ¥å¢å¤§æ¨¡å‹å¯¹â€˜æ›´ä¼˜å›ç­”â€™çš„ç”Ÿæˆæ¦‚ç‡ï¼ŒåŒæ—¶å‡å°å¯¹â€˜è¾ƒå·®å›ç­”â€™çš„ç”Ÿæˆæ¦‚ç‡â€ã€‚</p>
<p>æ•´ä¸ªè®­ç»ƒæµç¨‹æ¯”PPOæ›´ç®€æ´ï¼Œé€šå¸¸åªæœ‰ä¸¤æ­¥ï¼š</p>
<ol>
<li><strong>ç›‘ç£å¼å¾®è°ƒï¼ˆSFTï¼‰ï¼š</strong> ä¸PPOçš„ç¬¬ä¸€æ­¥å®Œå…¨ç›¸åŒã€‚è®­ç»ƒä¸€ä¸ªåŸºç¡€æ¨¡å‹æ¥ç†è§£æŒ‡ä»¤å’Œç”ŸæˆåŸºæœ¬å›ç­”ã€‚</li>
<li><strong>ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰ï¼š</strong> è¿™ä¸€æ­¥ç›´æ¥å–ä»£äº†PPOæµç¨‹ä¸­çš„â€œå¥–åŠ±æ¨¡å‹è®­ç»ƒâ€å’Œâ€œPPOå¼ºåŒ–å­¦ä¹ â€ä¸¤ä¸ªé˜¶æ®µã€‚</li>
</ol>
<hr>
<h4 id="æµç¨‹"><strong>æµç¨‹</strong></h4>
<p>åœ¨DPOé˜¶æ®µï¼Œæˆ‘ä»¬ä¸å†éœ€è¦Criticæ¨¡å‹ï¼Œä¹Ÿä¸éœ€è¦åœ¨çº¿é‡‡æ ·ç”Ÿæˆæ•°æ®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª<strong>é™æ€çš„åå¥½æ•°æ®é›†</strong>ã€‚</p>
<h5 id="ç¬¬ä¸€é˜¶æ®µï¼šå®šä¹‰å‚ä¸è€…ï¼ˆä¸¤å¤§æ¨¡å‹ï¼‰"><strong>ç¬¬ä¸€é˜¶æ®µï¼šå®šä¹‰å‚ä¸è€…ï¼ˆä¸¤å¤§æ¨¡å‹ï¼‰</strong></h5>
<p>åœ¨DPOè®­ç»ƒå¼€å§‹å‰ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸¤ä¸ªæ¨¡å‹ï¼š</p>
<ol>
<li>
<p><strong>ç­–ç•¥æ¨¡å‹ï¼ˆPolicy Model, <code>Ï€_Î¸</code>ï¼‰ï¼š</strong></p>
<ul>
<li><strong>è§’è‰²:</strong> ä¸»è§’ï¼Œå³æˆ‘ä»¬æ­£åœ¨å¾®è°ƒçš„è¯­è¨€æ¨¡å‹ã€‚</li>
<li><strong>æ¥æº:</strong> ç»è¿‡ç¬¬ä¸€æ­¥SFTè®­ç»ƒåçš„æ¨¡å‹å‰¯æœ¬ã€‚</li>
<li><strong>ä»»åŠ¡:</strong> åœ¨DPOè®­ç»ƒä¸­ï¼Œå®ƒçš„å‚æ•°<code>Î¸</code>ä¼šè¢«æ›´æ–°ã€‚</li>
</ul>
</li>
<li>
<p><strong>å‚è€ƒæ¨¡å‹ï¼ˆReference Model, <code>Ï€_ref</code>ï¼‰ï¼š</strong></p>
<ul>
<li><strong>è§’è‰²:</strong> â€œé”šç‚¹â€æˆ–â€œåŸºå‡†â€ã€‚</li>
<li><strong>æ¥æº:</strong> åŒæ ·æ˜¯ç¬¬ä¸€æ­¥SFTæ¨¡å‹çš„<strong>ä¸€ä¸ªå›ºå®šã€ä¸æ›´æ–°çš„å‰¯æœ¬</strong>ã€‚</li>
<li><strong>ä»»åŠ¡:</strong> æä¾›ä¸€ä¸ªåŸºå‡†æ¦‚ç‡ã€‚å®ƒçš„ä½œç”¨ä¸PPOä¸­çš„å‚è€ƒæ¨¡å‹å®Œå…¨ç›¸åŒï¼šé˜²æ­¢ç­–ç•¥æ¨¡å‹<code>Ï€_Î¸</code>ä¸ºäº†è¿åˆåå¥½æ•°æ®è€Œåç¦»å…¶åŸå§‹çš„è¯­è¨€èƒ½åŠ›å¤ªè¿œï¼Œè¿™æ˜¯ä¸€ç§éšå¼çš„KLæ•£åº¦çº¦æŸã€‚</li>
</ul>
</li>
</ol>
<h5 id="ç¬¬äºŒé˜¶æ®µï¼šå‡†å¤‡æ•°æ®é›†"><strong>ç¬¬äºŒé˜¶æ®µï¼šå‡†å¤‡æ•°æ®é›†</strong></h5>
<p>DPOä½¿ç”¨çš„æ•°æ®é›†æ ¼å¼éå¸¸å…³é”®ã€‚å®ƒä¸æ˜¯å•ä¸ªçš„â€œå¥½å›ç­”â€ï¼Œè€Œæ˜¯ä¸€ä¸ªåå¥½å¯¹çš„é›†åˆã€‚æ¯ä¸€æ¡æ•°æ®åŒ…å«ï¼š</p>
<ul>
<li><strong>æç¤ºï¼ˆPrompt, <code>x</code>ï¼‰</strong></li>
<li><strong>æ›´ä¼˜çš„å›ç­”ï¼ˆChosen Response, <code>y_w</code>ï¼‰</strong></li>
<li><strong>è¾ƒå·®çš„å›ç­”ï¼ˆRejected Response, <code>y_l</code>ï¼‰</strong></li>
</ul>
<p>è¿™ä¸ªæ•°æ®é›† <code>D = &#123; (x, y_w, y_l) &#125;</code> é€šå¸¸å°±æ˜¯ç”¨æ¥è®­ç»ƒPPOæµç¨‹ä¸­å¥–åŠ±æ¨¡å‹çš„é‚£ä¸ªæ•°æ®é›†ã€‚</p>
<h5 id="ç¬¬ä¸‰é˜¶æ®µï¼šDPOè®­ç»ƒå¾ªç¯"><strong>ç¬¬ä¸‰é˜¶æ®µï¼šDPOè®­ç»ƒå¾ªç¯</strong></h5>
<p>DPOçš„è®­ç»ƒè¿‡ç¨‹æ›´åƒä¸€ä¸ªæ ‡å‡†çš„ç›‘ç£å­¦ä¹ å¾ªç¯ï¼Œè€Œä¸æ˜¯RLçš„â€œç”Ÿæˆ-è¯„ä¼°-æ›´æ–°â€å¾ªç¯ã€‚</p>
<p>å¯¹äºä»åå¥½æ•°æ®é›†ä¸­é‡‡æ ·çš„æ¯ä¸€ä¸ª<code>(x, y_w, y_l)</code>ä¸‰å…ƒç»„ï¼š</p>
<ol>
<li>
<p><strong>è®¡ç®—ç­–ç•¥æ¨¡å‹æ¦‚ç‡ï¼š</strong></p>
<ul>
<li>å°† <code>(x, y_w)</code> è¾“å…¥åˆ°<strong>ç­–ç•¥æ¨¡å‹ <code>Ï€_Î¸</code></strong> ä¸­ï¼Œè®¡ç®—æ¨¡å‹ç”Ÿæˆ <code>y_w</code> çš„æ€»å¯¹æ•°æ¦‚ç‡ï¼š<code>log Ï€_Î¸(y_w | x)</code>ã€‚</li>
<li>å°† <code>(x, y_l)</code> è¾“å…¥åˆ°<strong>ç­–ç•¥æ¨¡å‹ <code>Ï€_Î¸</code></strong> ä¸­ï¼Œè®¡ç®—æ¨¡å‹ç”Ÿæˆ <code>y_l</code> çš„æ€»å¯¹æ•°æ¦‚ç‡ï¼š<code>log Ï€_Î¸(y_l | x)</code>ã€‚</li>
<li><em>ï¼ˆè¿™æ˜¯é€šè¿‡å¯¹å›ç­”ä¸­çš„æ¯ä¸ªtokençš„æ¡ä»¶æ¦‚ç‡å–å¯¹æ•°å†æ±‚å’Œå¾—åˆ°çš„ï¼‰</em></li>
</ul>
</li>
<li>
<p><strong>è®¡ç®—å‚è€ƒæ¨¡å‹æ¦‚ç‡ï¼š</strong></p>
<ul>
<li>å°† <code>(x, y_w)</code> è¾“å…¥åˆ°<strong>å›ºå®šçš„å‚è€ƒæ¨¡å‹ <code>Ï€_ref</code></strong> ä¸­ï¼Œè®¡ç®—å…¶ç”Ÿæˆ <code>y_w</code> çš„æ€»å¯¹æ•°æ¦‚ç‡ï¼š<code>log Ï€_ref(y_w | x)</code>ã€‚</li>
<li>å°† <code>(x, y_l)</code> è¾“å…¥åˆ°<strong>å›ºå®šçš„å‚è€ƒæ¨¡å‹ <code>Ï€_ref</code></strong> ä¸­ï¼Œè®¡ç®—å…¶ç”Ÿæˆ <code>y_l</code> çš„æ€»å¯¹æ•°æ¦‚ç‡ï¼š<code>log Ï€_ref(y_l | x)</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>è®¡ç®—éšå¼å¥–åŠ±çš„å·®å¼‚ï¼š</strong></p>
<ul>
<li>DPOç†è®ºè¯æ˜ï¼Œæ¨¡å‹çš„å¯¹æ•°æ¦‚ç‡ä¸å‚è€ƒæ¨¡å‹çš„å¯¹æ•°æ¦‚ç‡ä¹‹å·®ï¼Œæ­£æ¯”äºä¸€ä¸ªéšå¼çš„å¥–åŠ±å‡½æ•°ã€‚</li>
<li>è®¡ç®—<code>y_w</code>çš„éšå¼å¥–åŠ±ï¼ˆæˆ–ç§°ä¸ºâ€œåå¥½å¾—åˆ†â€ï¼‰:<br>
<code>r_Î¸(x, y_w) = Î² * (log Ï€_Î¸(y_w | x) - log Ï€_ref(y_w | x))</code></li>
<li>è®¡ç®—<code>y_l</code>çš„éšå¼å¥–åŠ±:<br>
<code>r_Î¸(x, y_l) = Î² * (log Ï€_Î¸(y_l | x) - log Ï€_ref(y_l | x))</code></li>
<li><code>Î²</code> æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œé€šå¸¸è®¾ä¸º0.1åˆ°0.5ä¹‹é—´ï¼Œå®ƒæ§åˆ¶ç€æ¨¡å‹å¯¹å‚è€ƒæ¨¡å‹çš„åç¦»ç¨‹åº¦ã€‚</li>
</ul>
</li>
<li>
<p><strong>è®¡ç®—DPOæŸå¤±å‡½æ•°ï¼š</strong></p>
<ul>
<li>DPOçš„ç›®æ ‡æ˜¯è®© <code>y_w</code> çš„å¥–åŠ±è¿œé«˜äº <code>y_l</code> çš„å¥–åŠ±ã€‚å®ƒä½¿ç”¨ä¸€ä¸ªç±»ä¼¼äº<strong>äºŒå…ƒåˆ†ç±»çš„é€»è¾‘æŸå¤±ï¼ˆLogistic Lossï¼‰</strong> æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚</li>
<li><code>Loss_DPO = -log(Ïƒ(r_Î¸(x, y_w) - r_Î¸(x, y_l)))</code></li>
<li>å…¶ä¸­ <code>Ïƒ</code> æ˜¯ Sigmoid å‡½æ•°ã€‚</li>
<li><strong>ç›´è§‚ç†è§£ï¼š</strong> è¿™ä¸ªæŸå¤±å‡½æ•°çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ– <code>r_Î¸(x, y_w)</code> å’Œ <code>r_Î¸(x, y_l)</code> ä¹‹é—´çš„å·®å€¼ã€‚å½“ç­–ç•¥æ¨¡å‹èµ‹äºˆ<code>y_w</code>çš„ç›¸å¯¹æ¦‚ç‡ï¼ˆç›¸å¯¹äºå‚è€ƒæ¨¡å‹ï¼‰è¿œé«˜äº<code>y_l</code>æ—¶ï¼ŒæŸå¤±å°±ä¼šå˜å°ã€‚</li>
</ul>
</li>
<li>
<p><strong>åå‘ä¼ æ’­ä¸ä¼˜åŒ–ï¼š</strong></p>
<ul>
<li>è®¡ç®— <code>Loss_DPO</code> ç›¸å¯¹äº<strong>ç­–ç•¥æ¨¡å‹ <code>Ï€_Î¸</code></strong> å‚æ•°çš„æ¢¯åº¦ã€‚</li>
<li>ä½¿ç”¨AdamWç­‰ä¼˜åŒ–å™¨æ›´æ–°<strong>ç­–ç•¥æ¨¡å‹ <code>Ï€_Î¸</code></strong> çš„å‚æ•°ã€‚</li>
<li><strong>æ³¨æ„ï¼šå‚è€ƒæ¨¡å‹ <code>Ï€_ref</code> çš„å‚æ•°å§‹ç»ˆä¸æ›´æ–°ã€‚</strong></li>
</ul>
</li>
</ol>
<p>é€šè¿‡åœ¨æ•´ä¸ªåå¥½æ•°æ®é›†ä¸Šé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç­–ç•¥æ¨¡å‹ <code>Ï€_Î¸</code> ä¼šè¢«ç›´æ¥ä¼˜åŒ–ï¼Œä½¿å…¶å€¾å‘äºç”Ÿæˆæ›´ç¬¦åˆäººç±»åå¥½çš„å›ç­”ã€‚</p>
<br>
<h3 id="LLM-PPO">LLM-PPO</h3>
<p><a href="https://arxiv.org/abs/2203.02155">https://arxiv.org/abs/2203.02155</a></p>
<img src="/2025/03/19/LLM-Rela/image-20250325131654259.png" class="" title="image-20250325131654259">
<br>
<h4 id="æµç¨‹-2"><strong>æµç¨‹</strong></h4>
<p>æˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªæµç¨‹æ›´æ¸…æ™°åœ°åˆ’åˆ†ä¸º**â€œè§’è‰²å®šä¹‰â€<strong>ã€</strong>â€œæ•°æ®ç”Ÿæˆï¼ˆRolloutï¼‰â€<strong>å’Œ</strong>â€œæ¨¡å‹å­¦ä¹ ï¼ˆLearningï¼‰â€**ä¸‰ä¸ªé˜¶æ®µã€‚</p>
<h5 id="ç¬¬ä¸€é˜¶æ®µï¼šå®šä¹‰å‚ä¸è€…ï¼ˆå››å¤§æ¨¡å‹ï¼‰"><strong>ç¬¬ä¸€é˜¶æ®µï¼šå®šä¹‰å‚ä¸è€…ï¼ˆå››å¤§æ¨¡å‹ï¼‰</strong></h5>
<p>åœ¨PPOè®­ç»ƒå¾ªç¯å¼€å§‹å‰ï¼Œæˆ‘ä»¬æœ‰å››ä¸ªå…³é”®çš„æ¨¡å‹ï¼Œå…¶ä¸­ä¸‰ä¸ªæ˜¯ç¥ç»ç½‘ç»œï¼š</p>
<ol>
<li>
<p><strong>Actor (ç­–ç•¥æ¨¡å‹ / Policy):</strong></p>
<ul>
<li><strong>è§’è‰²:</strong> ä¸»è§’ï¼Œå³æˆ‘ä»¬æ­£åœ¨å¾®è°ƒçš„è¯­è¨€æ¨¡å‹ã€‚</li>
<li><strong>æ¥æº:</strong> ç»è¿‡ç¬¬ä¸€æ­¥SFTï¼ˆç›‘ç£å¼å¾®è°ƒï¼‰è®­ç»ƒåçš„æ¨¡å‹å‰¯æœ¬ã€‚</li>
<li><strong>ä»»åŠ¡:</strong> æ ¹æ®å½“å‰çŠ¶æ€ <code>s_t</code>ï¼ˆå·²ç”Ÿæˆçš„æ–‡æœ¬ï¼‰ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªtoken <code>a_t</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>Reference Model (å‚è€ƒæ¨¡å‹):</strong></p>
<ul>
<li><strong>è§’è‰²:</strong> â€œé”šç‚¹â€æˆ–â€œçº¦æŸå™¨â€ã€‚</li>
<li><strong>æ¥æº:</strong> åŒæ ·æ˜¯ç¬¬ä¸€æ­¥SFTæ¨¡å‹çš„<strong>ä¸€ä¸ªå›ºå®šã€ä¸æ›´æ–°çš„å‰¯æœ¬</strong>ã€‚</li>
<li><strong>ä»»åŠ¡:</strong> æä¾›ä¸€ä¸ªåŸºå‡†çš„æ¦‚ç‡åˆ†å¸ƒ <code>Ï€_ref(a|s_t)</code>ï¼Œç”¨äºè®¡ç®—KLæ•£åº¦ï¼Œé˜²æ­¢Actorä¸ºäº†è¿½æ±‚å¥–åŠ±è€Œâ€œèµ°ç«å…¥é­”â€ï¼Œç”Ÿæˆä¸è‡ªç„¶æˆ–è¯­æ³•æ··ä¹±çš„æ–‡æœ¬ã€‚</li>
</ul>
</li>
<li>
<p><strong>Critic (ä»·å€¼æ¨¡å‹ / Value Network):</strong></p>
<ul>
<li><strong>è§’è‰²:</strong> â€œè¯„ä¼°å‘˜â€æˆ–â€œè£åˆ¤â€ã€‚</li>
<li><strong>æ¥æº:</strong> é€šå¸¸ç”¨RMçš„å¤´éƒ¨æˆ–SFTæ¨¡å‹çš„å¤´éƒ¨åˆå§‹åŒ–ï¼Œç„¶åä¸Actorä¸€èµ·åœ¨PPOé˜¶æ®µè®­ç»ƒã€‚</li>
<li><strong>ä»»åŠ¡:</strong> è¯„ä¼°å½“å‰çŠ¶æ€ <code>s_t</code> çš„<strong>æ½œåœ¨ä»·å€¼</strong> <code>V(s_t)</code>ï¼Œå³ä»è¿™ä¸ªçŠ¶æ€å¼€å§‹ï¼Œé¢„æœŸæœªæ¥èƒ½è·å¾—å¤šå°‘æ€»å¥–åŠ±ã€‚å®ƒçš„å­˜åœ¨æ˜¯ä¸ºäº†å‡å°‘ç­–ç•¥æ¢¯åº¦æ›´æ–°çš„æ–¹å·®ï¼ˆé€šè¿‡è®¡ç®—ä¼˜åŠ¿å‡½æ•°ï¼‰ã€‚</li>
</ul>
</li>
<li>
<p><strong>Reward Model (å¥–åŠ±æ¨¡å‹ / RM):</strong></p>
<ul>
<li><strong>è§’è‰²:</strong> â€œæœ€ç»ˆè£åˆ¤â€ï¼Œå®šä¹‰äº†ä¼˜åŒ–çš„æœ€ç»ˆç›®æ ‡ã€‚</li>
<li><strong>æ¥æº:</strong> ç¬¬äºŒæ­¥è®­ç»ƒå¥½çš„äººç±»åå¥½æ¨¡å‹ï¼Œåœ¨PPOé˜¶æ®µ<strong>ä¿æŒå›ºå®šï¼Œä¸æ›´æ–°</strong>ã€‚</li>
<li><strong>ä»»åŠ¡:</strong> å¯¹ä¸€ä¸ª<strong>å®Œæ•´çš„</strong>ç”Ÿæˆåºåˆ—ï¼ˆprompt + responseï¼‰ç»™å‡ºä¸€ä¸ªæ ‡é‡åˆ†æ•° <code>R_final</code>ï¼Œä»£è¡¨äººç±»å¯¹è¿™ä¸ªå›ç­”çš„åå¥½ç¨‹åº¦ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h5 id="ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®ç”Ÿæˆï¼ˆRollout-Phaseï¼‰"><strong>ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®ç”Ÿæˆï¼ˆRollout Phaseï¼‰</strong></h5>
<p>å¯¹äºä¸€ä¸ªä»æ•°æ®é›†ä¸­é‡‡æ ·çš„ <code>prompt</code>ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„åºåˆ—ç”Ÿæˆæ¥æ”¶é›†è®­ç»ƒæ•°æ®ã€‚</p>
<ol>
<li>
<p><strong>åˆå§‹åŒ–:</strong> ä»ä¸€ä¸ª <code>prompt</code> å¼€å§‹ï¼Œå¾—åˆ°åˆå§‹çŠ¶æ€ <code>s_0</code>ã€‚</p>
</li>
<li>
<p><strong>é€Tokenç”Ÿæˆå¾ªç¯ (For t = 0, 1, â€¦, T-1):</strong></p>
<ul>
<li><strong>åŠ¨ä½œ (Action):</strong> Actoræ¨¡å‹æ¥æ”¶å½“å‰çŠ¶æ€ <code>s_t</code>ï¼Œè¾“å‡ºæ¦‚ç‡åˆ†å¸ƒ <code>Ï€_actor(Â·|s_t)</code>ï¼Œå¹¶ä»ä¸­<strong>é‡‡æ ·</strong>ä¸€ä¸ªtoken <code>a_t</code>ã€‚</li>
<li><strong>è®°å½• (Log):</strong> è®°å½•Actorè¾“å‡ºè¯¥tokençš„å¯¹æ•°æ¦‚ç‡ <code>log Ï€_actor(a_t|s_t)</code>ã€‚</li>
<li><strong>ä»·å€¼è¯„ä¼° (Value Estimation):</strong> Criticæ¨¡å‹è¯„ä¼°å½“å‰çŠ¶æ€çš„ä»·å€¼ <code>V(s_t)</code>ã€‚</li>
<li><strong>è®¡ç®—å³æ—¶å¥–åŠ± (Immediate Reward):</strong> è¿™é‡Œçš„å¥–åŠ±<strong>ä¸»è¦ä¸æ˜¯æ¥è‡ªRM</strong>ã€‚
<ul>
<li><strong>KLæƒ©ç½š:</strong> è®¡ç®—Actorç­–ç•¥ä¸Referenceç­–ç•¥åœ¨å½“å‰æ­¥çš„KLæ•£åº¦ï¼Œä½œä¸ºæƒ©ç½šé¡¹ã€‚<br>
<code>r_t = -Î² * log(Ï€_actor(a_t|s_t) / Ï€_ref(a_t|s_t))</code></li>
<li><code>Î²</code> æ˜¯ä¸€ä¸ªæ§åˆ¶KLæƒ©ç½šåŠ›åº¦çš„è¶…å‚æ•°ã€‚è¿™ä¸ª <code>r_t</code> æ˜¯æ¯ä¸€æ­¥éƒ½ä¼šè®¡ç®—çš„ã€‚</li>
</ul>
</li>
<li><strong>çŠ¶æ€è½¬ç§»:</strong> å°†æ–°ç”Ÿæˆçš„token <code>a_t</code> æ·»åŠ åˆ°åºåˆ—ä¸­ï¼Œå¾—åˆ°æ–°çŠ¶æ€ <code>s_&#123;t+1&#125;</code>ã€‚</li>
<li><strong>å­˜å‚¨ç»éªŒ:</strong> å°†å…ƒç»„ <code>(s_t, a_t, r_t, V(s_t), log Ï€_actor(a_t|s_t))</code> å­˜å‚¨èµ·æ¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>æœ€ç»ˆå¥–åŠ±è®¡ç®— (Final Reward):</strong></p>
<ul>
<li>å½“ç”Ÿæˆç»“æŸï¼ˆä¾‹å¦‚é‡åˆ°EOS tokenæˆ–è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼‰æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„å›ç­”ã€‚</li>
<li>å°†å®Œæ•´çš„ï¼ˆ<code>prompt</code>, <code>response</code>ï¼‰è¾“å…¥åˆ°<strong>Reward Model (RM)</strong> ä¸­ï¼Œè·å¾—æœ€ç»ˆçš„æ ‡é‡å¥–åŠ± <code>R_final</code>ã€‚</li>
<li>å°†è¿™ä¸ªæœ€ç»ˆå¥–åŠ± <strong>åŠ åˆ°æœ€åä¸€æ­¥çš„å³æ—¶å¥–åŠ± <code>r_T</code> ä¸Š</strong>ã€‚æ‰€ä»¥ï¼Œ<code>r_T</code> å˜ä¸º <code>r_T (KLæƒ©ç½š) + R_final</code>ã€‚</li>
<li><strong>å…³é”®ç‚¹:</strong> åªæœ‰åœ¨åºåˆ—ç»“æŸæ—¶ï¼ŒRMæ‰æä¾›ä¸€æ¬¡æ€§çš„ã€æ•´ä½“çš„å¥–åŠ±ä¿¡å·ã€‚è€ŒKLæƒ©ç½šæ˜¯è´¯ç©¿äºæ¯ä¸€æ­¥çš„ã€‚</li>
</ul>
</li>
</ol>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ”¶é›†åˆ°äº†ä¸€æ¡å®Œæ•´çš„è½¨è¿¹ï¼ˆtrajectoryï¼‰ã€‚</p>
<hr>
<h5 id="ç¬¬ä¸‰é˜¶æ®µï¼šæ¨¡å‹å­¦ä¹ ï¼ˆLearning-Phaseï¼‰"><strong>ç¬¬ä¸‰é˜¶æ®µï¼šæ¨¡å‹å­¦ä¹ ï¼ˆLearning Phaseï¼‰</strong></h5>
<p>åˆ©ç”¨æ”¶é›†åˆ°çš„è½¨è¿¹æ•°æ®ï¼Œæˆ‘ä»¬æ¥æ›´æ–°Actorå’ŒCriticæ¨¡å‹ã€‚</p>
<ol>
<li>
<p><strong>è®¡ç®—ä¼˜åŠ¿å‡½æ•° (Advantage Estimation):</strong></p>
<ul>
<li>ä½¿ç”¨æ”¶é›†åˆ°çš„å¥–åŠ± <code>r_t</code> å’Œä»·å€¼ä¼°è®¡ <code>V(s_t)</code>ï¼Œé€šè¿‡**å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ï¼ˆGAEï¼‰**ç®—æ³•è®¡ç®—æ¯ä¸€æ­¥çš„ä¼˜åŠ¿ <code>A_t</code>ã€‚</li>
<li>GAEèƒ½æœ‰æ•ˆå¹³è¡¡åå·®å’Œæ–¹å·®ï¼Œç¨³å®šè®­ç»ƒè¿‡ç¨‹ã€‚<code>A_t</code> ç›´è§‚åœ°è¡¨ç¤ºäº†åœ¨çŠ¶æ€ <code>s_t</code> é€‰æ‹©åŠ¨ä½œ <code>a_t</code> ç›¸å¯¹äºå¹³å‡æ°´å¹³æœ‰å¤šå¥½ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ›´æ–°Actor (ç­–ç•¥æ¨¡å‹):</strong></p>
<ul>
<li>ä½¿ç”¨è®¡ç®—å‡ºçš„ä¼˜åŠ¿ <code>A_t</code> å’Œä¹‹å‰è®°å½•çš„ <code>log Ï€_actor(a_t|s_t)</code>ï¼Œæ„é€ PPOçš„<strong>è£å‰ªä»£ç†ç›®æ ‡å‡½æ•°ï¼ˆClipped Surrogate Objectiveï¼‰</strong>ã€‚</li>
<li>é€šè¿‡æ¢¯åº¦ä¸Šå‡ï¼ˆæœ€å¤§åŒ–ç›®æ ‡å‡½æ•°ï¼‰æ¥æ›´æ–°Actoræ¨¡å‹çš„å‚æ•°ã€‚PPOçš„è£å‰ªæœºåˆ¶ç¡®ä¿äº†æ¯æ¬¡æ›´æ–°çš„æ­¥å­ä¸ä¼šå¤ªå¤§ï¼Œä»è€Œä¿è¯äº†è®­ç»ƒçš„ç¨³å®šæ€§ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ›´æ–°Critic (ä»·å€¼æ¨¡å‹):</strong></p>
<ul>
<li>Criticçš„ç›®æ ‡æ˜¯æ›´å‡†ç¡®åœ°é¢„æµ‹æœªæ¥çš„å›æŠ¥ã€‚</li>
<li>æ„é€ ä¸€ä¸ªæŸå¤±å‡½æ•°ï¼Œé€šå¸¸æ˜¯<strong>å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰</strong>ï¼Œä½¿å…¶é¢„æµ‹çš„ä»·å€¼ <code>V(s_t)</code> å°½å¯èƒ½æ¥è¿‘äºåœ¨è¯¥æ­¥ä¹‹åå®é™…è§‚å¯Ÿåˆ°çš„ç´¯ç§¯å›æŠ¥ï¼ˆä¹Ÿç§°ä¸ºReturnsï¼‰ã€‚</li>
<li>é€šè¿‡æ¢¯åº¦ä¸‹é™æ¥æ›´æ–°Criticæ¨¡å‹çš„å‚æ•°ã€‚</li>
</ul>
</li>
</ol>
<br>
<h4 id="ç›¸å…³å†…å®¹">ç›¸å…³å†…å®¹</h4>
<p><strong>SFT LLM</strong></p>
<p>train Reward Model</p>
<img src="/2025/03/19/LLM-Rela/image-20250325151928459.png" class="" title="image-20250325151928459">
<p>use LLM_sft to be the Actor(reference model)</p>
<img src="/2025/03/19/LLM-Rela/image-20250325153214542.png" class="" title="image-20250325153214542">
<img src="/2025/03/19/LLM-Rela/image-20250325153304648.png" class="" title="image-20250325153304648">
<br>
<p><strong>PPOæ¶æ„</strong></p>
<img src="/2025/03/19/LLM-Rela/image-20250325153337812.png" class="" title="image-20250325153337812">
<blockquote>
<p>å¹¿ä¹‰ä¼˜åŠ¿GAEä¸ºå¤šæ­¥æ—¶åºå·®åˆ†çš„æŒ‡æ•°åŠ æƒå¹³å‡ï¼Œè¯¦è§reinforce-learning-recordï¼Œå‚æ•°å«Valueå€¼å’ŒRewardå€¼</p>
</blockquote>
<p><strong>ä¸ºä»€ä¹ˆå¼•å…¥KLæ•£åº¦é¡¹ï¼Ÿ</strong></p>
<p>è¿™ä¸ªKLé¡¹æœ‰ä¸¤ä¸ªä½œç”¨ã€‚é¦–å…ˆï¼Œå®ƒä½œä¸ºä¸€ç§ç†µå¥–åŠ±ï¼Œé¼“åŠ±ç­–ç•¥è¿›è¡Œæ¢ç´¢ï¼Œé˜²æ­¢å…¶åç¼©åˆ°å•ä¸€æ¨¡å¼ã€‚å…¶æ¬¡ï¼Œå®ƒç¡®ä¿ç­–ç•¥ä¸ä¼šå­¦ä¹ ç”Ÿæˆä¸å¥–åŠ±æ¨¡å‹åœ¨è®­ç»ƒæœŸé—´è§è¿‡çš„è¾“å‡ºå·®å¼‚è¿‡å¤§çš„ç»“æœã€‚</p>
<ul>
<li>åœ¨ RLHF ä¸­ï¼ŒPPO ç­–ç•¥åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­å¯èƒ½ä¼šåç¦»åˆå§‹ SFT æ¨¡å‹å¤ªè¿œï¼Œå¯¼è‡´â€œç¾éš¾æ€§é—å¿˜â€ (catastrophic forgetting)ï¼Œå³æ¨¡å‹å¿˜è®°äº† SFT é˜¶æ®µå­¦åˆ°çš„é€šç”¨è¯­è¨€èƒ½åŠ›æˆ–æŒ‡ä»¤éµå¾ªèƒ½åŠ›ï¼Œè¿‡åº¦è¿½æ±‚å¥–åŠ±ä¿¡å·ã€‚PPO é€šå¸¸ä¼šåŠ å…¥ä¸€ä¸ª KL æ•£åº¦æƒ©ç½šé¡¹æ¥çº¦æŸå½“å‰ç­–ç•¥ä¸ SFT æ¨¡å‹çš„è·ç¦»ã€‚</li>
</ul>
<br>
<h3 id="LLM-GRPO">LLM-GRPO</h3>
<p>Group Relative Policy Optimization</p>
<ul>
<li>
<p>ä¸€ä¸ªé—®é¢˜ï¼Œå¤šä¸ªå›ç­”</p>
</li>
<li>
<p>reward = Model + Rules -&gt; reward (ä»ç„¶æ˜¯å¯¹æ¯å¥è¯ç»™å‡º)</p>
</li>
<li>
<p>advantage = $\frac{r - mean}{std}$</p>
</li>
<li>
<p>ä¼˜åŒ–å…¬å¼å˜åŒ–</p>
</li>
</ul>
<br>
<h4 id="ç›¸å…³å†…å®¹-2">ç›¸å…³å†…å®¹</h4>
<img src="/2025/03/19/LLM-Rela/image-20250325195333997.png" class="" title="image-20250325195333997">
<p>ç”±äºPPOç®—æ³•ä¸­ä½¿ç”¨çš„ä»·å€¼å‡½æ•°é€šå¸¸æ˜¯ä¸ç­–ç•¥æ¨¡å‹è§„æ¨¡ç›¸å½“çš„å¦ä¸€ä¸ªæ¨¡å‹ï¼Œè¿™ä¼šå¸¦æ¥å·¨å¤§çš„å†…å­˜å’Œè®¡ç®—è´Ÿæ‹…ã€‚æ­¤å¤–ï¼Œåœ¨å¼ºåŒ–å­¦ä¹ è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä»·å€¼å‡½æ•°è¢«ä½œä¸ºè®¡ç®—ä¼˜åŠ¿å‡½æ•°ï¼ˆadvantageï¼‰çš„åŸºçº¿ä»¥å®ç°æ–¹å·®ç¼©å‡ã€‚ç„¶è€Œåœ¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœºæ™¯ä¸­ï¼Œé€šå¸¸åªæœ‰æœ€åä¸€ä¸ªtokenä¼šè¢«å¥–åŠ±æ¨¡å‹åˆ†é…å¥–åŠ±åˆ†æ•°ï¼Œè¿™å¯èƒ½å¯¼è‡´å¯¹æ¯ä¸ªtokenéƒ½ç²¾ç¡®å»ºæ¨¡ä»·å€¼å‡½æ•°çš„è®­ç»ƒå˜å¾—å¤æ‚ã€‚ä¸ºè§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¦‚å›¾4æ‰€ç¤ºï¼Œæˆ‘ä»¬æå‡ºäº†ç»„ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–ï¼ˆGroup Relative Policy Optimization, GRPOï¼‰</p>
<p>æ¯ä¸€ä¸ª $o_g $ä¸ºç­–ç•¥æ¨¡å‹å¯¹äºè¾“å…¥ $q$ çš„è¾“å‡ºï¼Œæ¯ä¸€ä¸ª $r_g$ ä¸º RM å¯¹ æ¯ä¸€ä¸ª $o_g$ çš„è¯„åˆ†</p>
<img src="/2025/03/19/LLM-Rela/image-20250325201341810.png" class="" title="image-20250325201341810">
<p>ä¸åŒç‚¹ï¼š</p>
<ol>
<li>
<p>ä¼˜åŠ¿å‡½æ•°ï¼šè¿‡ç¨‹ç›‘ç£ä¸ç»“æœç›‘ç£</p>
<img src="/2025/03/19/LLM-Rela/image-20250325202638658.png" class="" title="image-20250325202638658">
</li>
<li>
<p>è¶…å‚æ•°Îµæ§åˆ¶ç­–ç•¥æ›´æ–°å¹…åº¦ï¼ŒÎ²è°ƒèŠ‚KLæ•£åº¦çº¦æŸ</p>
</li>
</ol>
<img src="/2025/03/19/LLM-Rela/image-20250325201533207.png" class="" title="image-20250325201533207">
<br>
<h2 id="Sparse-Dense-Model">Sparse &amp; Dense Model</h2>
<p>pic ref: <a href="https://github.com/jingyaogong/minimind">https://github.com/jingyaogong/minimind</a></p>
<img src="/2025/03/19/LLM-Rela/LLM-structure.png" class="" title="structure">
<img src="/2025/03/19/LLM-Rela/LLM-structure-moe.png" class="" title="structure-moe">
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>Python, Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty</title>
    <url>/2025/03/28/Netty/</url>
    <content><![CDATA[<p>Netty</p>
<span id="more"></span>
<h1>Netty&amp;Rela</h1>
<h2 id="Proactor-Reactor">Proactor &amp; Reactor</h2>
<h3 id="Proactor">Proactor</h3>
<p>ä¸»åŠ¨æ‰§è¡Œè€…</p>
<ol>
<li><strong>å¼‚æ­¥æ“ä½œ</strong>ï¼šåº”ç”¨ç¨‹åºå‘èµ·I/Oæ“ä½œåç«‹å³è¿”å›ï¼Œä¸é˜»å¡</li>
<li><strong>å®Œæˆé€šçŸ¥</strong>ï¼šå½“I/Oæ“ä½œå®Œæˆåï¼Œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åº</li>
<li><strong>äº‹ä»¶åˆ†ç¦»</strong>ï¼šç”±ä¸“é—¨çš„ç»„ä»¶ï¼ˆå¦‚äº‹ä»¶å¾ªç¯ï¼‰è´Ÿè´£åˆ†å‘å®Œæˆäº‹ä»¶</li>
<li><strong>å›è°ƒå¤„ç†</strong>ï¼šé¢„å…ˆæ³¨å†Œçš„å›è°ƒå‡½æ•°å¤„ç†å®Œæˆäº‹ä»¶</li>
</ol>
<h3 id="Reactor">Reactor</h3>
<p>ååº”å™¨</p>
<ol>
<li><strong>äº‹ä»¶é©±åŠ¨</strong>ï¼šåº”ç”¨ç¨‹åºæ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼ˆå¦‚å¯è¯»ã€å¯å†™ï¼‰</li>
<li><strong>åŒæ­¥éé˜»å¡</strong>ï¼šä½¿ç”¨éé˜»å¡I/Oï¼Œä½†åŒæ­¥ç­‰å¾…äº‹ä»¶å°±ç»ª</li>
<li><strong>äº‹ä»¶åˆ†ç¦»</strong>ï¼šç”±ä¸“é—¨çš„ç»„ä»¶ï¼ˆå¦‚äº‹ä»¶å¾ªç¯ï¼‰è´Ÿè´£æ£€æµ‹å’Œåˆ†å‘äº‹ä»¶</li>
<li><strong>å›è°ƒå¤„ç†</strong>ï¼šé¢„å…ˆæ³¨å†Œçš„äº‹ä»¶å¤„ç†å™¨å¤„ç†å°±ç»ªäº‹ä»¶</li>
</ol>
<h3 id="Diff">Diff</h3>
<ul>
<li><strong>Reactor</strong>ï¼šåŒæ­¥éé˜»å¡æ¨¡å¼ï¼Œå…³æ³¨&quot;ä½•æ—¶å¯è¯»/å¯å†™&quot;, éé˜»å¡I/O, åº”ç”¨ç¨‹åºä¸»åŠ¨è¯»å–/å†™å…¥æ•°æ®</li>
<li><strong>Proactor</strong>ï¼šå¼‚æ­¥æ¨¡å¼ï¼Œå…³æ³¨&quot;è¯»/å†™å·²å®Œæˆ&quot;,  å¼‚æ­¥I/O, æ“ä½œç³»ç»Ÿå®ŒæˆI/Oåé€šçŸ¥åº”ç”¨ç¨‹åº</li>
</ul>
<p><code>JDK7</code> å¼•å…¥äº† <code>AsynchronousI/O</code>ï¼Œå³ <code>AIO</code>ã€‚åœ¨è¿›è¡Œ <code>I/O</code> ç¼–ç¨‹ä¸­ï¼Œå¸¸ç”¨åˆ°ä¸¤ç§æ¨¡å¼ï¼š<code>Reactor</code> å’Œ <code>Proactor</code>ã€‚<code>Java</code> çš„ <code>NIO</code> å°±æ˜¯ <code>Reactor</code>ï¼Œå½“æœ‰äº‹ä»¶è§¦å‘æ—¶ï¼ŒæœåŠ¡å™¨ç«¯å¾—åˆ°é€šçŸ¥ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†</p>
<p><code>AIO</code> å³ <code>NIO2.0</code>ï¼Œå«åšå¼‚æ­¥ä¸é˜»å¡çš„ <code>IO</code>ã€‚<code>AIO</code> å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† <code>Proactor</code> æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å»å¤„ç†ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨</p>
<h2 id="Java-IO">Java IO</h2>
<p>é€‚ç”¨åœºæ™¯åŒºåˆ«</p>
<ol>
<li><code>BIO</code> æ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œ<code>JDK1.4</code> ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ï¼Œä½†ç¨‹åºç®€å•æ˜“ç†è§£ã€‚</li>
<li><code>NIO</code> æ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¼¹å¹•ç³»ç»Ÿï¼ŒæœåŠ¡å™¨é—´é€šè®¯ç­‰ã€‚ç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œ<code>JDK1.4</code> å¼€å§‹æ”¯æŒã€‚</li>
<li><code>AIO</code> æ–¹å¼ä½¿ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ†è°ƒç”¨ <code>OS</code> å‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œ<code>JDK7</code> å¼€å§‹æ”¯æŒã€‚</li>
</ol>
<h3 id="BIO">BIO</h3>
<img src="/2025/03/28/Netty/chapter02_01.png" class="" title="img">
<p>åœ¨Javaçš„BIOï¼ˆBlocking I/Oï¼‰æ¨¡å‹ä¸­ï¼Œå½“ç”¨æˆ·å‘é€æ•°æ®åˆ°æœåŠ¡å™¨çš„socketå†…æ ¸ç¼“å†²åŒºåï¼Œç”¨æˆ·è¿›ç¨‹æ˜¯é€šè¿‡<strong>é˜»å¡å¼ç³»ç»Ÿè°ƒç”¨</strong>çš„æ–¹å¼ä»å†…æ ¸ç¼“å†²åŒºè¯»å–æ•°æ®çš„ã€‚å…·ä½“åˆ°ä»£ç ï¼š</p>
<ol>
<li><strong>å…³é”®ç‚¹åˆ†æ</strong>ï¼š<br>
â€¢ <code>inputStream.read(bytes)</code> æ˜¯ä¸€ä¸ª<strong>é˜»å¡è°ƒç”¨</strong>ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºä¸­æœ‰æ•°æ®åˆ°è¾¾ï¼ˆæˆ–è¿æ¥å…³é—­ï¼‰ã€‚<br>
â€¢ å½“å®¢æˆ·ç«¯å‘é€æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šå…ˆè¢«å†…æ ¸æ¥æ”¶å¹¶å­˜å…¥socketçš„æ¥æ”¶ç¼“å†²åŒºï¼Œç„¶åå†…æ ¸ä¼šå”¤é†’è¢«é˜»å¡çš„<code>read()</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆå³ä½ çš„<code>bytes</code>æ•°ç»„ï¼‰ã€‚</li>
<li><strong>è¯¦ç»†æµç¨‹</strong>ï¼š<br>
â€¢ <strong>æ•°æ®åˆ°è¾¾</strong>ï¼šå®¢æˆ·ç«¯å‘é€çš„æ•°æ®é€šè¿‡TCPåè®®æ ˆåˆ°è¾¾æœåŠ¡å™¨çš„ç½‘å¡ï¼Œå†…æ ¸å°†æ•°æ®å­˜å…¥è¯¥socketå¯¹åº”çš„æ¥æ”¶ç¼“å†²åŒºã€‚<br>
â€¢ <strong>å”¤é†’è¿›ç¨‹</strong>ï¼šå†…æ ¸ä¼šé€šçŸ¥ï¼ˆå”¤é†’ï¼‰æ­£åœ¨é˜»å¡ç­‰å¾…<code>read()</code>çš„çº¿ç¨‹ï¼Œæ­¤æ—¶<code>read()</code>ä¼šè¿”å›å¯è¯»çš„å­—èŠ‚æ•°ï¼ˆ<code>read &gt; 0</code>ï¼‰ã€‚<br>
â€¢ <strong>æ•°æ®æ‹·è´</strong>ï¼š<code>read()</code>å†…éƒ¨ä¼šè§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚Linuxçš„<code>recv()</code>ï¼‰ï¼Œå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°Javaè¿›ç¨‹çš„<code>bytes</code>æ•°ç»„ä¸­ã€‚</li>
<li><strong>BIOçš„ç‰¹ç‚¹</strong>ï¼š<br>
â€¢ æ¯ä¸ªè¿æ¥éœ€è¦ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹å¤„ç†ï¼Œ<code>read()</code>ä¼šé˜»å¡çº¿ç¨‹ç›´åˆ°æ•°æ®å°±ç»ªã€‚<br>
â€¢ å†…æ ¸ç¼“å†²åŒºçš„å­˜åœ¨ä½¿å¾—å³ä½¿è¿›ç¨‹æ²¡æœ‰åŠæ—¶è°ƒç”¨<code>read()</code>ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ï¼ˆç¼“å†²åŒºæœªæ»¡æ—¶ï¼‰ã€‚</li>
</ol>
<p><strong><code>serverSocket.accept()</code> çš„è¡Œä¸º</strong></p>
<ul>
<li><strong>ä½œç”¨</strong>ï¼šç›‘å¬æŒ‡å®šçš„ç«¯å£ï¼ˆè¿™é‡Œæ˜¯6666ï¼‰ï¼Œç­‰å¾…å®¢æˆ·ç«¯å‘èµ·TCPè¿æ¥è¯·æ±‚ã€‚</li>
<li><strong>é˜»å¡æ€§</strong>ï¼šè¿™æ˜¯ä¸€ä¸ª<strong>é˜»å¡è°ƒç”¨</strong>ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œçº¿ç¨‹ä¼šä¸€ç›´å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æœ‰æ–°çš„è¿æ¥åˆ°è¾¾ã€‚</li>
<li>è¿æ¥å»ºç«‹ï¼šå½“å®¢æˆ·ç«¯ï¼ˆå¦‚Socketæˆ–telnetï¼‰å‘èµ·è¿æ¥æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šå®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œç„¶åå°†è¿™ä¸ªæ–°è¿æ¥äº¤ç»™accept()æ–¹æ³•ã€‚
<ul>
<li>æ­¤æ—¶ï¼Œ<code>accept()</code>ä¼šè¿”å›ä¸€ä¸ªæ–°çš„<code>Socket</code>å¯¹è±¡ï¼ˆå³ä»£ç ä¸­çš„<code>socket</code>ï¼‰ï¼Œä»£è¡¨ä¸å®¢æˆ·ç«¯çš„ç‹¬ç«‹è¿æ¥ã€‚</li>
<li><strong>æ³¨æ„</strong>ï¼šæ­¤æ—¶è¿æ¥å·²å»ºç«‹ï¼ˆTCPæ¡æ‰‹å®Œæˆï¼‰ï¼Œä½†å®¢æˆ·ç«¯å¯èƒ½è¿˜æ²¡æœ‰å‘é€ä»»ä½•æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<p><strong><code>inputStream.read()</code> çš„è¡Œä¸º</strong></p>
<ul>
<li><strong>ä½œç”¨</strong>ï¼šä»å·²å»ºç«‹çš„è¿æ¥ä¸­è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ã€‚</li>
<li>é˜»å¡æ€§ï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å‘é€æ•°æ®ï¼Œçº¿ç¨‹ä¼šå¡åœ¨read()æ–¹æ³•ï¼Œç›´åˆ°ï¼š
<ol>
<li>å®¢æˆ·ç«¯å‘é€æ•°æ® â†’ æ•°æ®åˆ°è¾¾å†…æ ¸ç¼“å†²åŒº â†’ <code>read()</code>è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼ˆ<code>read &gt; 0</code>ï¼‰ã€‚</li>
<li>å®¢æˆ·ç«¯å…³é—­è¿æ¥ â†’ <code>read()</code>è¿”å›<code>-1</code>ï¼ˆè¡¨ç¤ºEOFï¼‰ã€‚</li>
<li>å‘ç”Ÿå¼‚å¸¸ï¼ˆå¦‚è¿æ¥é‡ç½®ï¼‰ã€‚</li>
</ol>
</li>
</ul>
<p>ä¸»çº¿ç¨‹ç›‘å¬æ˜¯å¦æœ‰è¿æ¥è¯·æ±‚ï¼Œæ¥æ”¶è¿æ¥åå°†ä»»åŠ¡äº¤ç”±çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¤„ç†</p>
<p>ä»»åŠ¡çº¿ç¨‹è´Ÿè´£å¯¹è¿æ¥è¿›è¡Œå¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIOServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//çº¿ç¨‹æ± æœºåˆ¶</span></span><br><span class="line">        <span class="comment">//æ€è·¯</span></span><br><span class="line">        <span class="comment">//1. åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± </span></span><br><span class="line">        <span class="comment">//2. å¦‚æœæœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯(å•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•)</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">newCachedThreadPool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//åˆ›å»ºServerSocket</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6666</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨å¯åŠ¨äº†&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹ä¿¡æ¯id = &quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;åå­— = &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="comment">//ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…è¿æ¥....&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯&quot;</span>);</span><br><span class="line">            <span class="comment">//å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯(å•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•)</span></span><br><span class="line">            newCachedThreadPool.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;<span class="comment">//æˆ‘ä»¬é‡å†™</span></span><br><span class="line">                    <span class="comment">//å¯ä»¥å’Œå®¢æˆ·ç«¯é€šè®¯</span></span><br><span class="line">                    handler(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼–å†™ä¸€ä¸ªhandleræ–¹æ³•ï¼Œå’Œå®¢æˆ·ç«¯é€šè®¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹ä¿¡æ¯id = &quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;åå­— = &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="comment">//é€šè¿‡socketè·å–è¾“å…¥æµ</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">            <span class="comment">//å¾ªç¯çš„è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¿¡æ¯id = &quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;åå­— = &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                System.out.println(<span class="string">&quot;read....&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> inputStream.read(bytes);</span><br><span class="line">                <span class="keyword">if</span> (read != -<span class="number">1</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, read));<span class="comment">//è¾“å‡ºå®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å…³é—­å’Œclientçš„è¿æ¥&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NIO">NIO</h3>
<img src="/2025/03/28/Netty/chapter02_02.png" class="" title="img">
<img src="/2025/03/28/Netty/chapter03_01.png" class="" title="img">
<p>ç‰¹æ€§</p>
<ol>
<li>æ¯ä¸ª <code>Channel</code> éƒ½ä¼šå¯¹åº”ä¸€ä¸ª <code>Buffer</code>ã€‚</li>
<li><code>Selector</code> å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ª <code>Channel</code>ï¼ˆè¿æ¥ï¼‰ã€‚</li>
<li>è¯¥å›¾ååº”äº†æœ‰ä¸‰ä¸ª <code>Channel</code> æ³¨å†Œåˆ°è¯¥ <code>Selector</code> //ç¨‹åº</li>
<li>ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª <code>Channel</code> æ˜¯ç”±äº‹ä»¶å†³å®šçš„ï¼Œ<code>Event</code> å°±æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚</li>
<li><code>Selector</code> ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨å„ä¸ªé€šé“ä¸Šåˆ‡æ¢ã€‚</li>
<li><code>Buffer</code> å°±æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œåº•å±‚æ˜¯æœ‰ä¸€ä¸ªæ•°ç»„ã€‚</li>
<li>æ•°æ®çš„è¯»å–å†™å…¥æ˜¯é€šè¿‡ <code>Buffer</code>ï¼Œè¿™ä¸ªå’Œ <code>BIO</code>ï¼Œ<code>BIO</code> ä¸­è¦ä¹ˆæ˜¯è¾“å…¥æµï¼Œæˆ–è€…æ˜¯è¾“å‡ºæµï¼Œä¸èƒ½åŒå‘ï¼Œä½†æ˜¯ <code>NIO</code> çš„ <code>Buffer</code> æ˜¯å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œéœ€è¦ <code>flip</code> æ–¹æ³•åˆ‡æ¢ <code>Channel</code> æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¿”å›åº•å±‚æ“ä½œç³»ç»Ÿçš„æƒ…å†µï¼Œæ¯”å¦‚ <code>Linux</code>ï¼Œåº•å±‚çš„æ“ä½œç³»ç»Ÿé€šé“å°±æ˜¯åŒå‘çš„ã€‚</li>
</ol>
<h4 id="Selector">Selector</h4>
<p>æ¦‚è¿°</p>
<ol>
<li><code>Java</code> çš„ <code>NIO</code>ï¼Œç”¨éé˜»å¡çš„ <code>IO</code> æ–¹å¼ã€‚å¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±ä¼šä½¿ç”¨åˆ° <code>Selector</code>ï¼ˆé€‰æ‹©å™¨ï¼‰ã€‚</li>
<li><code>Selector</code> èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆæ³¨æ„ï¼šå¤šä¸ª <code>Channel</code> ä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ª <code>Selector</code>ï¼‰ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¾¿è·å–äº‹ä»¶ç„¶åé’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥å’Œè¯·æ±‚ã€‚</li>
<li>åªæœ‰åœ¨è¿æ¥/é€šé“çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç”¨å»ç»´æŠ¤å¤šä¸ªçº¿ç¨‹ã€‚</li>
</ol>
<p>æœºåˆ¶</p>
<ul>
<li><strong>åº•å±‚ä¾èµ–æ“ä½œç³»ç»Ÿçš„ I/O å¤šè·¯å¤ç”¨</strong>ï¼ˆå¦‚ Linux çš„ <code>epoll</code>ã€Windows çš„ <code>IOCP</code>ã€macOS çš„ <code>kqueue</code>ï¼‰ã€‚
<ul>
<li>å½“è°ƒç”¨ <code>selector.select()</code> æ—¶ï¼ŒJVM ä¼šé€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„æœºåˆ¶<strong>é˜»å¡ç­‰å¾…</strong>ï¼Œç›´åˆ°è‡³å°‘ä¸€ä¸ª Channel æœ‰å°±ç»ªäº‹ä»¶ï¼ˆå¦‚å¯è¯»ã€å¯å†™ã€è¿æ¥å®Œæˆç­‰ï¼‰ï¼Œè€Œä¸æ˜¯ä¸»åŠ¨è½®è¯¢æ‰€æœ‰ Channelã€‚</li>
<li>è¿™ç§é˜»å¡æ˜¯é«˜æ•ˆçš„ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šç›´æ¥é€šçŸ¥å“ªäº› Channel å°±ç»ªï¼Œé¿å…äº†ç”¨æˆ·æ€çš„æ— è°“å¾ªç¯ã€‚</li>
</ul>
</li>
<li><strong>è¿”å›å°±ç»ªäº‹ä»¶å</strong>ï¼ŒSelector ä¼šé€šè¿‡ <code>selectedKeys()</code> è¿”å›ä¸€ä¸ªé›†åˆï¼Œå¼€å‘è€…éœ€è¦<strong>æ‰‹åŠ¨éå†å¤„ç†è¿™äº›äº‹ä»¶</strong>ï¼ˆè¿™ä¸€æ­¥æ˜¯ç”¨æˆ·æ€çš„è½®è¯¢ï¼‰ã€‚</li>
</ul>
<p><code>NIO</code> ä¸­çš„ <code>ServerSocketChannel</code> åŠŸèƒ½ç±»ä¼¼ <code>ServerSocket</code>ã€<code>SocketChannel</code> åŠŸèƒ½ç±»ä¼¼ <code>Socket</code>ã€‚</p>
<p>SelectionKey</p>
<p>SelectionKey è¡¨ç¤º Selector å’Œç½‘ç»œé€šé“çš„æ³¨å†Œå…³ç³»ï¼Œå…±å››ç§ï¼š</p>
<ul>
<li><code>int OP_ACCEPT</code>ï¼šæœ‰æ–°çš„ç½‘ç»œè¿æ¥å¯ä»¥ <code>accept</code>ï¼Œå€¼ä¸º <code>16</code></li>
<li><code>int OP_CONNECT</code>ï¼šä»£è¡¨è¿æ¥å·²ç»å»ºç«‹ï¼Œå€¼ä¸º <code>8</code></li>
<li><code>int OP_READ</code>ï¼šä»£è¡¨è¯»æ“ä½œï¼Œå€¼ä¸º <code>1</code></li>
<li><code>int OP_WRITE</code>ï¼šä»£è¡¨å†™æ“ä½œï¼Œå€¼ä¸º <code>4</code></li>
</ul>
<img src="/2025/03/28/Netty/chapter03_15.png" class="" title="img">
<ol>
<li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡ <code>ServerSocketChannel</code> å¾—åˆ° <code>SocketChannel</code>ã€‚</li>
<li><code>Selector</code> è¿›è¡Œç›‘å¬ <code>select</code> æ–¹æ³•ï¼Œè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°ã€‚</li>
<li>å°† <code>socketChannel</code> æ³¨å†Œåˆ° <code>Selector</code> ä¸Šï¼Œ<code>register(Selector sel, int ops)</code>ï¼Œä¸€ä¸ª <code>Selector</code> ä¸Šå¯ä»¥æ³¨å†Œå¤šä¸ª <code>SocketChannel</code>ã€‚</li>
<li>æ³¨å†Œåè¿”å›ä¸€ä¸ª <code>SelectionKey</code>ï¼Œä¼šå’Œè¯¥ <code>Selector</code> å…³è”ï¼ˆé›†åˆï¼‰ã€‚</li>
<li>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª <code>SelectionKey</code>ï¼ˆæœ‰äº‹ä»¶å‘ç”Ÿï¼‰ã€‚</li>
<li>åœ¨é€šè¿‡ <code>SelectionKey</code> åå‘è·å– <code>SocketChannel</code>ï¼Œæ–¹æ³• <code>channel()</code>ã€‚</li>
<li>å¯ä»¥é€šè¿‡å¾—åˆ°çš„ <code>channel</code>ï¼Œå®Œæˆä¸šåŠ¡å¤„ç†ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡ç«¯ï¼šå•çº¿ç¨‹Reactorï¼Œæ‰€æœ‰æ“ä½œï¼ˆI/O + ä¸šåŠ¡å¤„ç†ï¼‰å‡åœ¨Reactorçº¿ç¨‹å®Œæˆã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel listenChannel;</span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯ç”¨äºç›‘å¬å®¢æˆ·ç«¯è¿æ¥çš„é€šé“ï¼Œå®ƒä¸ç›´æ¥ä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œè€Œæ˜¯æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">6667</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ å™¨</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupChatServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¾—åˆ°é€‰æ‹©å™¨</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">//ServerSocketChannel</span></span><br><span class="line">            listenChannel = ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">//ç»‘å®šç«¯å£</span></span><br><span class="line">            listenChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(PORT));</span><br><span class="line">            <span class="comment">//è®¾ç½®éé˜»å¡æ¨¡å¼</span></span><br><span class="line">            listenChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//å°†è¯¥ listenChannel æ³¨å†Œåˆ° selectorï¼Œç›‘å¬äº‹ä»¶ï¼šæœ‰æ–°çš„ç½‘ç»œè¿æ¥å¯ä»¥æ¥æ”¶</span></span><br><span class="line">            listenChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¾ªç¯å¤„ç†</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();  <span class="comment">// çº¿ç¨‹é˜»å¡åœ¨ select æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123; <span class="comment">//æœ‰äº‹ä»¶å¤„ç†</span></span><br><span class="line">                    <span class="comment">// éå†å¾—åˆ° selectionKey é›†åˆ</span></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                        <span class="comment">//å–å‡º selectionkey</span></span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                        <span class="comment">//ç›‘å¬åˆ° accept</span></span><br><span class="line">                        <span class="keyword">if</span> (key.isAcceptable()) &#123;<span class="comment">//å»ºç«‹è¿æ¥</span></span><br><span class="line">                            <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> listenChannel.accept();</span><br><span class="line">                            <span class="comment">// scå®ä¾‹ç›´æ¥ä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œç”¨äºè¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆ–å‘å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯</span></span><br><span class="line">                            sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                            <span class="comment">//å°†è¯¥ sc æ³¨å†Œåˆ° seletorï¼Œç›‘å¬äº‹ä»¶ï¼šå®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">                            sc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                            System.out.println(sc.getRemoteAddress() + <span class="string">&quot; ä¸Šçº¿ &quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (key.isReadable()) &#123;<span class="comment">//é€šé“å‘é€readäº‹ä»¶ï¼Œå³é€šé“æ˜¯å¯è¯»çš„çŠ¶æ€</span></span><br><span class="line">                            <span class="comment">// å¤„ç†è¯»(ä¸“é—¨å†™æ–¹æ³•..)</span></span><br><span class="line">                            readData(key);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//å½“å‰çš„ key åˆ é™¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†</span></span><br><span class="line">                        iterator.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;ç­‰å¾…....&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//å‘ç”Ÿå¼‚å¸¸å¤„ç†....</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readData</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¾—åˆ° channel</span></span><br><span class="line">            channel = (SocketChannel) key.channel();</span><br><span class="line">            <span class="comment">//åˆ›å»º buffer</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> channel.read(buffer); <span class="comment">//  æ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€å †å†…å­˜</span></span><br><span class="line">            <span class="comment">//æ ¹æ® count çš„å€¼åšå¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//æŠŠç¼“å­˜åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array());</span><br><span class="line">                <span class="comment">//è¾“å‡ºè¯¥æ¶ˆæ¯</span></span><br><span class="line">                System.out.println(<span class="string">&quot;formå®¢æˆ·ç«¯:&quot;</span> + msg);</span><br><span class="line">                <span class="comment">//å‘å…¶å®ƒçš„å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯(å»æ‰è‡ªå·±),ä¸“é—¨å†™ä¸€ä¸ªæ–¹æ³•æ¥å¤„ç†</span></span><br><span class="line">                sendInfoToOtherClients(msg, channel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(channel.getRemoteAddress() + <span class="string">&quot;ç¦»çº¿äº†..&quot;</span>);</span><br><span class="line">                <span class="comment">//å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">                key.cancel();</span><br><span class="line">                <span class="comment">//å…³é—­é€šé“</span></span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è½¬å‘æ¶ˆæ¯ç»™å…¶å®ƒå®¢æˆ·(é€šé“)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendInfoToOtherClients</span><span class="params">(String msg, SocketChannel self)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯ä¸­...&quot;</span>);</span><br><span class="line">        <span class="comment">//éå†æ‰€æœ‰æ³¨å†Œåˆ° selector ä¸Šçš„ SocketChannel,å¹¶æ’é™¤ self</span></span><br><span class="line">        <span class="keyword">for</span> (SelectionKey key : selector.keys()) &#123;</span><br><span class="line">            <span class="comment">//é€šè¿‡ key å–å‡ºå¯¹åº”çš„ SocketChannel</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">targetChannel</span> <span class="operator">=</span> key.channel();</span><br><span class="line">            <span class="comment">//æ’é™¤è‡ªå·±</span></span><br><span class="line">            <span class="keyword">if</span> (targetChannel <span class="keyword">instanceof</span> SocketChannel &amp;&amp; targetChannel != self) &#123;</span><br><span class="line">                <span class="comment">//è½¬å‹</span></span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">dest</span> <span class="operator">=</span> (SocketChannel) targetChannel;</span><br><span class="line">                <span class="comment">//å°† msg å­˜å‚¨åˆ° buffer</span></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(msg.getBytes());</span><br><span class="line">                <span class="comment">//å°† buffer çš„æ•°æ®å†™å…¥é€šé“</span></span><br><span class="line">                dest.write(buffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡</span></span><br><span class="line">        <span class="type">GroupChatServer</span> <span class="variable">groupChatServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupChatServer</span>();</span><br><span class="line">        groupChatServer.listen();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®¢æˆ·ç«¯ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ç›¸å…³çš„å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;<span class="comment">//æœåŠ¡å™¨çš„ip</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">6667</span>;<span class="comment">//æœåŠ¡å™¨ç«¯å£</span></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> SocketChannel socketChannel;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ å™¨,å®Œæˆåˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupChatClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        </span><br><span class="line">        selector = Selector.open();</span><br><span class="line">        <span class="comment">//è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">        socketChannel = SocketChannel.open(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(HOST, PORT));</span><br><span class="line">        <span class="comment">//è®¾ç½®éé˜»å¡</span></span><br><span class="line">        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//å°† channel æ³¨å†Œåˆ°selector</span></span><br><span class="line">        socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        <span class="comment">//å¾—åˆ° username</span></span><br><span class="line">        username = socketChannel.getLocalAddress().toString().substring(<span class="number">1</span>);</span><br><span class="line">        System.out.println(username + <span class="string">&quot; is ok...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendInfo</span><span class="params">(String info)</span> &#123;</span><br><span class="line">        info = username + <span class="string">&quot; è¯´ï¼š&quot;</span> + info;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel.write(ByteBuffer.wrap(info.getBytes()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–ä»æœåŠ¡å™¨ç«¯å›å¤çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">readChannels</span> <span class="operator">=</span> selector.select();</span><br><span class="line">            <span class="keyword">if</span> (readChannels &gt; <span class="number">0</span>) &#123;<span class="comment">//æœ‰å¯ä»¥ç”¨çš„é€šé“</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="comment">//å¾—åˆ°ç›¸å…³çš„é€šé“</span></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                        <span class="comment">//å¾—åˆ°ä¸€ä¸ª Buffer</span></span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                        <span class="comment">//è¯»å–</span></span><br><span class="line">                        sc.read(buffer);</span><br><span class="line">                        <span class="comment">//æŠŠè¯»åˆ°çš„ç¼“å†²åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array());</span><br><span class="line">                        System.out.println(msg.trim());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                iterator.remove(); <span class="comment">//åˆ é™¤å½“å‰çš„ selectionKey,é˜²æ­¢é‡å¤æ“ä½œ</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//System.out.println(&quot;æ²¡æœ‰å¯ä»¥ç”¨çš„é€šé“...&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¯åŠ¨å®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="type">GroupChatClient</span> <span class="variable">chatClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupChatClient</span>();</span><br><span class="line">        <span class="comment">//å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹,æ¯ä¸ª 3 ç§’ï¼Œè¯»å–ä»æœåŠ¡å™¨å‘é€çš„æ•°æ®</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    chatClient.readInfo();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.currentThread().sleep(<span class="number">3000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‘é€æ•°æ®ç»™æœåŠ¡å™¨ç«¯</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">            chatClient.sendInfo(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Channel">Channel</h4>
<ol>
<li>NIO çš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«å¦‚ä¸‹ï¼š
<ul>
<li>é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™</li>
<li>é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ®</li>
<li>é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†²:</li>
</ul>
</li>
<li><code>BIO</code> ä¸­çš„ <code>Stream</code> æ˜¯å•å‘çš„ï¼Œä¾‹å¦‚ <code>FileInputStream</code> å¯¹è±¡åªèƒ½è¿›è¡Œè¯»å–æ•°æ®çš„æ“ä½œï¼Œè€Œ <code>NIO</code> ä¸­çš„é€šé“ï¼ˆ<code>Channel</code>ï¼‰æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¯»æ“ä½œï¼Œä¹Ÿå¯ä»¥å†™æ“ä½œã€‚</li>
<li><code>Channel</code> åœ¨ <code>NIO</code> ä¸­æ˜¯ä¸€ä¸ªæ¥å£ <code>public interface Channel extends Closeable&#123;&#125;</code></li>
<li>å¸¸ç”¨çš„ <code>Channel</code> ç±»æœ‰: <strong><code>FileChannel</code>ã€<code>DatagramChannel</code>ã€<code>ServerSocketChannel</code> å’Œ <code>SocketChannel</code></strong> ã€‚ã€<code>ServerSocketChanne</code> ç±»ä¼¼ <code>ServerSocket</code>ã€<code>SocketChannel</code> ç±»ä¼¼ <code>Socket</code>ã€‘</li>
<li><code>FileChannel</code> ç”¨äºæ–‡ä»¶çš„æ•°æ®è¯»å†™ï¼Œ<code>DatagramChannel</code> ç”¨äº <code>UDP</code> çš„æ•°æ®è¯»å†™ï¼Œ<code>ServerSocketChannel</code> å’Œ <code>SocketChannel</code> ç”¨äº <code>TCP</code> çš„æ•°æ®è¯»å†™ã€‚</li>
</ol>
<blockquote>
<p>åŒå‘æ€§ä½“ç°ï¼šFileInputStream å’Œ FileOutputStream ä¸ºä¸¤ä¸ªä¸åŒçš„ç±»ï¼ŒFileChannel ä¸ºä¸€ä¸ªç±»ï¼Œå¯å®ç°readå’Œwrite</p>
<p>å®é™…ä½¿ç”¨çš„æ—¶å€™è¿˜æ˜¯éœ€è¦ä»FileInputStream å’Œ FileOutputStream è·å– FileChannel</p>
</blockquote>
<p>ä»Streamè·å–Channel</p>
<p>Buffer çš„åŒå‘è¯»å†™ä½“ç°</p>
<ul>
<li><strong>è¯»å–é˜¶æ®µ</strong>ï¼š<code>fileChannel01.read(byteBuffer)</code> å°†æ•°æ®ä»é€šé“å†™å…¥ Bufferï¼ˆæ­¤æ—¶ Buffer å¤„äºå†™æ¨¡å¼ï¼‰</li>
<li><strong>å†™å…¥é˜¶æ®µ</strong>ï¼š<code>fileChannel02.write(byteBuffer)</code> å°†æ•°æ®ä» Buffer è¯»å–åˆ°é€šé“ï¼ˆéœ€è¦å…ˆè°ƒç”¨ <code>flip()</code> åˆ‡æ¢ä¸ºè¯»æ¨¡å¼ï¼‰</li>
</ul>
<p>å…³é”®ç‚¹åœ¨äºåŒä¸€ä¸ª <code>ByteBuffer</code> å¯¹è±¡å…ˆè¢«ç”¨äºæ¥æ”¶æ•°æ®ï¼ˆå†™æ“ä½œï¼‰ï¼Œç„¶åè¢«ç¿»è½¬åç”¨äºæä¾›æ•°æ®ï¼ˆè¯»æ“ä½œï¼‰ï¼Œè¿™ä½“ç°äº† Buffer çš„åŒå‘æ€§ã€‚</p>
<h4 id="Buffer">Buffer</h4>
<img src="/2025/03/28/Netty/chapter03_05.png" class="" title="img">
<p><code>byteBuffer.flip()</code></p>
<ol>
<li><strong>æ¨¡å¼åˆ‡æ¢</strong>ï¼šå°†ç¼“å†²åŒºä»å†™æ¨¡å¼åˆ‡æ¢åˆ°è¯»æ¨¡å¼</li>
<li>é‡ç½®æŒ‡é’ˆï¼š
<ul>
<li>å°† <code>limit</code> è®¾ç½®ä¸ºå½“å‰ <code>position</code> å€¼ï¼ˆå³å†™å…¥çš„æœ€åä¸€ä¸ªä½ç½®ï¼‰</li>
<li>å°† <code>position</code> é‡ç½®ä¸º 0ï¼ˆå‡†å¤‡ä»å¤´å¼€å§‹è¯»å–ï¼‰</li>
<li><code>mark</code> è¢«ä¸¢å¼ƒï¼ˆå¦‚æœä¹‹å‰è®¾ç½®äº†ï¼‰</li>
</ul>
</li>
</ol>
<p><code>byteBuffer.clear()</code></p>
<p>å°†ç¼“å†²åŒºä»è¯»æ¨¡å¼åˆ‡æ¢ä¸ºå†™æ¨¡å¼ï¼Œå¹¶é‡ç½®</p>
<p><strong>å…³é”®æ–¹æ³•å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">æ–¹æ³•</th>
<th style="text-align:center">ä½œç”¨</th>
<th style="text-align:center">position</th>
<th style="text-align:center">limit</th>
<th style="text-align:center">mark</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">allocate</td>
<td style="text-align:center">åˆ›å»ºæ–°ç¼“å†²åŒº</td>
<td style="text-align:center">0</td>
<td style="text-align:center">= capacity</td>
<td style="text-align:center">undefined</td>
</tr>
<tr>
<td style="text-align:center">put()</td>
<td style="text-align:center">å†™å…¥æ•°æ®</td>
<td style="text-align:center">å¢åŠ </td>
<td style="text-align:center">ä¸å˜</td>
<td style="text-align:center">å¯èƒ½æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align:center">flip()</td>
<td style="text-align:center">å†™â†’è¯»åˆ‡æ¢</td>
<td style="text-align:center">0</td>
<td style="text-align:center">=åŸposition</td>
<td style="text-align:center">æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align:center">get()</td>
<td style="text-align:center">è¯»å–æ•°æ®</td>
<td style="text-align:center">å¢åŠ </td>
<td style="text-align:center">ä¸å˜</td>
<td style="text-align:center">å¯èƒ½æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align:center">clear()</td>
<td style="text-align:center">è¯»â†’å†™åˆ‡æ¢(é‡ç½®)</td>
<td style="text-align:center">0</td>
<td style="text-align:center">= capacity</td>
<td style="text-align:center">æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align:center">rewind()</td>
<td style="text-align:center">é‡æ–°è¯»å–(ä¸æ”¹å˜limit)</td>
<td style="text-align:center">0</td>
<td style="text-align:center">ä¸å˜</td>
<td style="text-align:center">æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align:center">compact()</td>
<td style="text-align:center">å‹ç¼©ç¼“å†²åŒº(ä¿ç•™æœªè¯»æ•°æ®)</td>
<td style="text-align:center">=å‰©ä½™æ•°æ®æ•°</td>
<td style="text-align:center">= capacity</td>
<td style="text-align:center">æ¸…é™¤</td>
</tr>
</tbody>
</table>
<h3 id="NIOä¸é›¶æ‹·è´">NIOä¸é›¶æ‹·è´</h3>
<p>é›¶æ‹·è´æ˜¯ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦æ¥è¯´çš„</p>
<p>æ™®é€šæ–¹å¼</p>
<img src="/2025/03/28/Netty/chapter03_17.png" class="" title="img">
<p>mmap</p>
<p><strong>mmap çš„æ ¸å¿ƒæœºåˆ¶æ˜¯é€šè¿‡ä¿®æ”¹é¡µè¡¨ï¼Œå°†è¿›ç¨‹ç”¨æˆ·æ€åœ°å€ç©ºé—´çš„ä¸€é¡µå’Œå†…æ ¸æ€åœ°å€ç©ºé—´çš„ä¸€é¡µæ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†å†…å­˜å—ï¼ˆé¡µç¼“å­˜ï¼‰æ¥å®ç°çš„</strong></p>
<p>ä»éœ€è¦ä¸€æ¬¡ä»kernel bufferå¤åˆ¶åˆ°socket bufferçš„è¿‡ç¨‹</p>
<img src="/2025/03/28/Netty/chapter03_18.png" class="" title="img">
<p>sendFile</p>
<p><code>Linux2.1</code> ç‰ˆæœ¬æä¾›äº† <code>sendFile</code> å‡½æ•°ï¼Œå…¶åŸºæœ¬åŸç†å¦‚ä¸‹ï¼šæ•°æ®æ ¹æœ¬ä¸ç»è¿‡ç”¨æˆ·æ€ï¼Œç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºè¿›å…¥åˆ° <code>SocketBuffer</code>ï¼ŒåŒæ—¶ï¼Œç”±äºå’Œç”¨æˆ·æ€å®Œå…¨æ— å…³ï¼Œå°±å‡å°‘äº†ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
<img src="/2025/03/28/Netty/chapter03_19.png" class="" title="img">
<p>sendFileä¼˜åŒ–</p>
<p><code>Linuxåœ¨2.4</code> ç‰ˆæœ¬ä¸­ï¼Œåšäº†ä¸€äº›ä¿®æ”¹ï¼Œé¿å…äº†ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° <code>Socketbuffer</code> çš„æ“ä½œï¼Œç›´æ¥æ‹·è´åˆ°åè®®æ ˆï¼Œä»è€Œå†ä¸€æ¬¡å‡å°‘äº†æ•°æ®æ‹·è´ã€‚å…·ä½“å¦‚ä¸‹å›¾å’Œå°ç»“ï¼š</p>
<img src="/2025/03/28/Netty/chapter03_20.png" class="" title="img">
<h3 id="AIO">AIO</h3>
<h2 id="Netty">Netty</h2>
<h3 id="çº¿ç¨‹æ¨¡å‹">çº¿ç¨‹æ¨¡å‹</h3>
<p>ä¼ ç»Ÿé˜»å¡ I/O æ¨¡å‹ï¼Œè“æ¡†çº¿ç¨‹ï¼Œé»„æ¡†å¯¹è±¡ï¼Œç™½æ¡†æ–¹æ³•</p>
<img src="/2025/03/28/Netty/chapter05_01.png" class="" title="img">
<p>Reactor æ¨¡å¼ï¼Œè“æ¡†çº¿ç¨‹ï¼Œé»„æ¡†å¯¹è±¡ï¼Œç™½æ¡†æ–¹æ³•</p>
<img src="/2025/03/28/Netty/chapter05_03.png" class="" title="img">
<ul>
<li>
<p><strong>å•çº¿ç¨‹Reactor</strong>ï¼š</p>
<p><img src="https://dongzl.github.io/netty-handbook/_media/chapter05/chapter05_04.png" alt="img"></p>
<ul>
<li><strong>æ‰€æœ‰æ“ä½œ</strong>ï¼ˆI/O + ä¸šåŠ¡å¤„ç†ï¼‰å‡åœ¨Reactorçº¿ç¨‹å®Œæˆã€‚</li>
<li>ç¼ºç‚¹ï¼šä¸šåŠ¡å¤„ç†é˜»å¡äº‹ä»¶å¾ªç¯ï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ï¼‰ã€‚</li>
<li>ç¤ºä¾‹ï¼šRedisçš„å•çº¿ç¨‹æ¨¡å‹ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¤šçº¿ç¨‹Reactor</strong>ï¼š</p>
<img src="/2025/03/28/Netty/chapter05_05.png" class="" title="img">
<ul>
<li><strong>ä¸»çº¿ç¨‹ä»…å¤„ç†I/O</strong>ï¼ˆæ¥æ”¶è¿æ¥ã€è¯»å†™æ•°æ®ï¼‰ï¼Œ<strong>ä¸šåŠ¡é€»è¾‘äº¤ç»™çº¿ç¨‹æ± </strong>ã€‚</li>
<li>å­çº¿ç¨‹å¤„ç†å®Œæˆåï¼Œé€šå¸¸é€šè¿‡å›è°ƒæˆ–é˜Ÿåˆ—é€šçŸ¥Reactorçº¿ç¨‹ç»§ç»­I/Oæ“ä½œã€‚</li>
<li>ç¤ºä¾‹ï¼šNettyçš„é»˜è®¤æ¨¡å¼ã€Java NIOçš„å¸¸è§å®è·µã€‚</li>
</ul>
</li>
<li>
<p><strong>å¤šReactorçº¿ç¨‹</strong>ï¼š</p>
<img src="/2025/03/28/Netty/chapter05_06.png" class="" title="img">
<ul>
<li><strong>ä¸»Reactor</strong>è´Ÿè´£æ¥æ”¶è¿æ¥ï¼Œ<strong>å­Reactorçº¿ç¨‹</strong>ï¼ˆå¤šä¸ªï¼‰è´Ÿè´£å·²è¿æ¥å¥—æ¥å­—çš„I/Oå’Œä¸šåŠ¡ã€‚</li>
<li>ç¤ºä¾‹ï¼šNettyçš„<code>NioEventLoopGroup</code>ã€Linuxä¸‹çš„<code>SO_REUSEPORT</code></li>
</ul>
</li>
</ul>
<h3 id="Nettyçº¿ç¨‹æ¨¡å‹">Nettyçº¿ç¨‹æ¨¡å‹</h3>
<p>è“æ¡†çº¿ç¨‹ï¼Œé»„æ¡†å¯¹è±¡ï¼Œç™½æ¡†æ–¹æ³•</p>
<img src="/2025/03/28/Netty/D693697CEDCDC16AC09A5CF4747129CE.png" class="" title="D693697CEDCDC16AC09A5CF4747129CE">
<p><code>NioEventLoopGroup</code> å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª <strong>çº¿ç¨‹æ± </strong>ï¼Œä½†å®ƒä¸ä»…ä»…æ˜¯æ™®é€šçš„çº¿ç¨‹æ± ï¼Œè€Œæ˜¯ä¸“é—¨ä¸º Netty çš„å¼‚æ­¥ I/O æ¨¡å‹ä¼˜åŒ–çš„ <strong>äº‹ä»¶å¾ªç¯ç»„</strong>ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>åŒ…å«å¤šä¸ª <code>NioEventLoop</code>ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰</strong>ï¼š
<ul>
<li>æ¯ä¸ª <code>NioEventLoop</code> æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œè´Ÿè´£å¤„ç† I/O äº‹ä»¶ã€ä»»åŠ¡é˜Ÿåˆ—å’Œå®šæ—¶ä»»åŠ¡ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>NioEventLoopGroup</code> çš„çº¿ç¨‹æ•° = <code>CPU æ ¸å¿ƒæ•° Ã— 2</code>ï¼ˆä½†å¯ä»¥æ‰‹åŠ¨æŒ‡å®šï¼‰ã€‚</li>
</ul>
</li>
<li><strong>èŒè´£</strong>ï¼š
<ul>
<li><strong>BossGroup</strong>ï¼ˆç”¨äºæœåŠ¡ç«¯ï¼‰ï¼šè´Ÿè´£ç›‘å¬å’Œæ¥å—æ–°è¿æ¥ï¼ˆ<code>ServerSocketChannel</code>ï¼‰ã€‚</li>
<li><strong>WorkerGroup</strong>ï¼ˆç”¨äºæœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼‰ï¼šè´Ÿè´£å¤„ç†å·²å»ºç«‹è¿æ¥çš„ I/O è¯»å†™ï¼ˆ<code>SocketChannel</code>ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>æ¯ä¸ª <code>NioEventLoop</code> æ˜¯ä¸€ä¸ª <strong>å•çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯</strong>ï¼Œå®ƒè´Ÿè´£ï¼š</p>
<ol>
<li><strong>ç›‘å¬ I/O äº‹ä»¶</strong>ï¼ˆå¦‚ <code>OP_ACCEPT</code>ã€<code>OP_READ</code>ã€<code>OP_WRITE</code>ï¼‰ï¼Œä¸ºå›¾ä¸­çš„ <code>selector.select()</code> <code>processSelectedKeys()</code>ï¼Œ<code>processSelectedKeys()</code> æ ¹æ® <code>selectedKeys</code> çš„ä¸åŒï¼Œè§¦å‘ <code>ChannelPipeline</code> ä¸­çš„ä¸åŒæ–¹æ³•</li>
<li><strong>æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</strong>ï¼ˆå¦‚ç”¨æˆ·æäº¤çš„ <code>Runnable</code>ï¼‰ï¼Œä¸ºå›¾ä¸­çš„ <code>runAllTasks()</code></li>
<li><strong>å¤„ç†å®šæ—¶ä»»åŠ¡</strong>ï¼ˆå¦‚ <code>schedule()</code> æäº¤çš„å»¶è¿Ÿä»»åŠ¡ï¼‰ï¼Œä¸ºå›¾ä¸­çš„ <code>runAllTasks()</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EventLoop Thread</span><br><span class="line">â”œâ”€â”€ selector.select()          // è½®è¯¢ I/O äº‹ä»¶</span><br><span class="line">â”œâ”€â”€ processSelectedKeys()      // å¤„ç† I/O äº‹ä»¶ï¼ˆå¦‚è¯»ã€å†™ã€è¿æ¥æ¥å—ç­‰ï¼‰,è§¦å‘å¤„ç†å™¨é“¾</span><br><span class="line">â”‚   â”œâ”€â”€ channelRead()          // ä¾‹å¦‚å¤„ç†è¯»äº‹ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ channelActive()        // ä¾‹å¦‚å¤„ç†è¿æ¥äº‹ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ handlerAdded()</span><br><span class="line">â”‚   â””â”€â”€ handlerRemoved()</span><br><span class="line">â””â”€â”€ runAllTasks()              // æ‰§è¡Œç”¨æˆ·æäº¤çš„ä»»åŠ¡ï¼ˆRunnableï¼‰</span><br></pre></td></tr></table></figure>
<p>Handler</p>
<ul>
<li><code>handler()</code>ï¼šç”¨äºå¤„ç†<strong>æœåŠ¡ç«¯Channelæœ¬èº«</strong>çš„äº‹ä»¶ï¼ˆè¿™é‡Œæ˜¯NioServerSocketChannelï¼‰</li>
<li><code>childHandler()</code>ï¼šç”¨äºå¤„ç†<strong>è¢«æ¥å—çš„å®¢æˆ·ç«¯è¿æ¥</strong>ï¼ˆè¿™é‡Œæ˜¯SocketChannelï¼‰</li>
</ul>
<p><code>processSelectedKeys()</code> æ–¹æ³•</p>
<p><strong>ä½œç”¨</strong>ï¼š</p>
<ul>
<li>å¤„ç† <strong>I/O äº‹ä»¶</strong>ï¼ˆå¦‚è¯»ã€å†™ã€è¿æ¥æ¥å—ç­‰ï¼‰ï¼Œè§¦å‘ <strong>ChannelPipeline ä¸­çš„å¤„ç†å™¨é“¾</strong>ã€‚</li>
<li>å½“Selectoræ£€æµ‹åˆ°Channelæœ‰å°±ç»ªçš„I/Oäº‹ä»¶æ—¶ï¼Œ<code>NioEventLoop</code>ä¼šè°ƒç”¨æ­¤æ–¹æ³•å¤„ç†è¿™äº›äº‹ä»¶ã€‚</li>
</ul>
<p><strong>ä¸å¤„ç†å™¨é“¾çš„å…³ç³»</strong>ï¼š</p>
<ul>
<li>å¯¹äºæ¯ä¸ªå°±ç»ªçš„Channeläº‹ä»¶ï¼ˆå¦‚ OP_READï¼‰ï¼ŒNettyä¼šè°ƒç”¨è¯¥Channelçš„ ChannelPipeline ä¸­çš„å¤„ç†å™¨é“¾ã€‚
<ul>
<li>ä¾‹å¦‚ï¼šæ•°æ®è¯»å– â†’ è§¦å‘<code>ChannelInboundHandler.channelRead()</code>ï¼›</li>
<li>è¿æ¥å»ºç«‹ â†’ è§¦å‘<code>ChannelInboundHandler.channelActive()</code>ã€‚</li>
</ul>
</li>
<li><strong>ç©ºé—²æ£€æµ‹</strong>ï¼ˆå¦‚<code>IdleStateHandler</code>ï¼‰ä¹Ÿæ˜¯é€šè¿‡<code>processSelectedKeys()</code>è§¦å‘çš„ï¼Œå®ƒä¼šæ£€æŸ¥Channelçš„è¯»å†™ç©ºé—²çŠ¶æ€ï¼Œå¹¶è§¦å‘<code>IdleStateEvent</code>äº‹ä»¶ã€‚</li>
</ul>
<p><code>runAllTasks()</code> æ–¹æ³•</p>
<p><strong>ä½œç”¨</strong>ï¼š</p>
<ul>
<li>æ‰§è¡Œ <strong>éI/Oçš„å¼‚æ­¥ä»»åŠ¡</strong>ï¼ˆå¦‚ç”¨æˆ·æäº¤çš„<code>Runnable</code>ã€å®šæ—¶ä»»åŠ¡ã€ChannelFutureçš„å›è°ƒç­‰ï¼‰ã€‚</li>
<li>è¿™äº›ä»»åŠ¡å¯èƒ½æ˜¯ï¼š
<ul>
<li>ç”¨æˆ·é€šè¿‡<code>eventLoop.execute(task)</code>æäº¤çš„ä»»åŠ¡ã€‚</li>
<li>Nettyå†…éƒ¨ä»»åŠ¡ï¼ˆå¦‚Channelå…³é—­åçš„æ¸…ç†ã€å†™åˆ·æ–°ç­‰ï¼‰ã€‚</li>
<li>å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚<code>schedule()</code>æäº¤çš„å»¶è¿Ÿä»»åŠ¡ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ä¸ <code>processSelectedKeys()</code> çš„å…³ç³»</strong>ï¼š</p>
<ul>
<li>NioEventLoop æ˜¯å•çº¿ç¨‹çš„ï¼Œ<code>runAllTasks()</code> å’Œ <code>processSelectedKeys()</code> ä¸¤è€…äº¤æ›¿æ‰§è¡Œï¼Œä½†Nettyä¼š<strong>ä¼˜å…ˆä¿è¯I/Oå¤„ç†</strong>ï¼Œé™åˆ¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼ˆé»˜è®¤ä¸è¶…è¿‡<code>ioRatio</code>æ¯”ä¾‹ï¼‰ã€‚</li>
</ul>
<p>æµç¨‹ï¼š</p>
<ol>
<li>bossGroupçš„NioEventLoopæ¥æ”¶æ–°è¿æ¥ï¼Œåˆ›å»ºSocketChannel</li>
<li>å°†è¯¥SocketChannelæ³¨å†Œåˆ°workerGroupçš„ä¸€ä¸ªNioEventLoopçš„Selectorä¸Š</li>
<li>å½“è¯¥NioEventLoopå¤„ç†I/Oäº‹ä»¶(<code>processSelectedKeys()</code>æ–¹æ³•)æ—¶ï¼Œä¼šè°ƒç”¨pipelineä¸­çš„å¤„ç†å™¨é“¾</li>
</ol>
<p>æ¡ˆä¾‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 1. å®šä¹‰çº¿ç¨‹ç»„</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>); <span class="comment">// æ¥æ”¶è¿æ¥</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(); <span class="comment">// å¤„ç†I/O</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. é…ç½®æœåŠ¡ç«¯</span></span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            bootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>) <span class="comment">// è¿æ¥é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO)) <span class="comment">// BossGroupçš„Handler</span></span><br><span class="line">                    .childHandler(</span><br><span class="line">                <span class="comment">// Channelæ³¨å†Œåˆ°EventLoopå	è§¦å‘ChannelInitializer.initChannel()</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            <span class="comment">// 3. æ·»åŠ ç¼–è§£ç å™¨</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                            <span class="comment">// 4. ç©ºé—²æ£€æµ‹ï¼ˆ5ç§’æ— è¯»è§¦å‘ï¼‰</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, TimeUnit.SECONDS));</span><br><span class="line">                            <span class="comment">// 5. è‡ªå®šä¹‰å¤„ç†å™¨</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// æ–¹æ³•æ‰§è¡Œå®Œæ¯•ChannelInitializerè‡ªåŠ¨ä»Pipelineä¸­ç§»é™¤ï¼Œä»…ä¿ç•™æ·»åŠ çš„å¤„ç†å™¨</span></span><br><span class="line">            <span class="comment">// 6. ç»‘å®šç«¯å£</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.bind(<span class="number">8080</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Server started on port 8080&quot;</span>);</span><br><span class="line">            <span class="comment">// 7. å…³é—­</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æœåŠ¡ç«¯å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Received: &quot;</span> + msg);</span><br><span class="line">        <span class="comment">// å¼‚æ­¥ä»»åŠ¡ç¤ºä¾‹</span></span><br><span class="line">        ctx.channel().eventLoop().execute(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Async task processed&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        ctx.writeAndFlush(<span class="string">&quot;Response: &quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†ç©ºé—²äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Channel idle, closing...&quot;</span>);</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nettyæ¨¡å—">Nettyæ¨¡å—</h3>
<h4 id="ChannelFuture">ChannelFuture</h4>
<p>ChannelFutureç›´æ¥ç»§æ‰¿è‡ª<code>Future&lt;V&gt;</code>æ¥å£</p>
<ul>
<li><code>addListener(GenericFutureListener)</code> - æ·»åŠ ç›‘å¬å™¨</li>
<li><code>channel()</code> - è·å–å…³è”çš„Channel</li>
<li><code>sync()</code> - ç­‰å¾…æ“ä½œå®Œæˆï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</li>
<li><code>await()</code> - ç­‰å¾…æ“ä½œå®Œæˆï¼Œä¸æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<h4 id="Channel-2">Channel</h4>
<p>è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª <code>ChannelFuture</code> å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° <code>ChannelFuture</code> ä¸Šï¼Œå¯ä»¥ <code>I/O</code> æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹</p>
<p>Channelçš„æ‰€æœ‰è¡Œä¸ºéƒ½ä¼šè§¦å‘äº‹ä»¶ï¼Œç”±<code>ChannelPipeline</code>ä¸­çš„å¤„ç†å™¨é“¾å¤„ç†ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>äº‹ä»¶ç±»å‹</strong></th>
<th style="text-align:center"><strong>è§¦å‘åœºæ™¯</strong></th>
<th style="text-align:center"><strong>å¯¹åº”æ–¹æ³•</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>channelRegistered</code></td>
<td style="text-align:center">Channelæ³¨å†Œåˆ°EventLoopæ—¶</td>
<td style="text-align:center"><code>handlerAdded()</code></td>
</tr>
<tr>
<td style="text-align:center"><code>channelActive</code></td>
<td style="text-align:center">Channelè¿æ¥å»ºç«‹/ç»‘å®šå®Œæˆ</td>
<td style="text-align:center"><code>channelActive()</code></td>
</tr>
<tr>
<td style="text-align:center"><code>channelRead</code></td>
<td style="text-align:center">æ•°æ®å¯è¯»æ—¶</td>
<td style="text-align:center"><code>channelRead()</code></td>
</tr>
<tr>
<td style="text-align:center"><code>channelInactive</code></td>
<td style="text-align:center">Channelæ–­å¼€è¿æ¥</td>
<td style="text-align:center"><code>channelInactive()</code></td>
</tr>
<tr>
<td style="text-align:center"><code>exceptionCaught</code></td>
<td style="text-align:center">å‘ç”Ÿå¼‚å¸¸æ—¶</td>
<td style="text-align:center"><code>exceptionCaught()</code></td>
</tr>
</tbody>
</table>
<p><strong>å†…å­˜ç®¡ç†</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥å†…å­˜åˆ†é…ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ï¼‰</span></span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">directBuf</span> <span class="operator">=</span> channel.alloc().directBuffer();</span><br></pre></td></tr></table></figure>
<ul>
<li>Channelå†…ç½®<code>ByteBufAllocator</code>ï¼Œæ”¯æŒå †å†…/å †å¤–å†…å­˜åˆ†é…ã€‚</li>
</ul>
<h4 id="ChannelPipeline">ChannelPipeline</h4>
<p>åœ¨ <code>Netty</code> ä¸­æ¯ä¸ª <code>Channel</code> éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª <code>ChannelPipeline</code> ä¸ä¹‹å¯¹åº”</p>
<img src="/2025/03/28/Netty/chapter06_03.png" class="" title="img">
<p><strong>å¦‚ä½•è§¦å‘ ChannelPipelineï¼Ÿ</strong></p>
<p>ä¸åŒäº‹ä»¶ç±»å‹ä¼šè§¦å‘ <code>ChannelPipeline</code> ä¸­çš„ä¸åŒæ–¹æ³•ï¼š</p>
<p><strong>ACCEPT äº‹ä»¶</strong>ï¼ˆæœåŠ¡ç«¯ï¼‰</p>
<ul>
<li>
<p>è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">processSelectedKeys() </span><br><span class="line">  â†’ NioMessageUnsafe.read() </span><br><span class="line">    â†’ ServerSocketChannel.accept() </span><br><span class="line">    â†’ pipeline.fireChannelRead() <span class="comment">// è§¦å‘ChannelReadäº‹ä»¶</span></span><br><span class="line">      â†’ ServerBootstrapAcceptor.channelRead() <span class="comment">// é»˜è®¤å¤„ç†å™¨</span></span><br><span class="line">        â†’ åˆå§‹åŒ–å®¢æˆ·ç«¯Channelå¹¶æ³¨å†Œåˆ°WorkerGroup</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Pipeline è§¦å‘ç‚¹ï¼š</p>
<ul>
<li><code>fireChannelRead()</code>ï¼šé€šçŸ¥å¤„ç†å™¨æœ‰æ–°è¿æ¥æ¥å…¥</li>
<li><strong>ä¸ç›´æ¥è§¦å‘ä¸šåŠ¡å¤„ç†å™¨</strong>ï¼Œè€Œæ˜¯é€šè¿‡ <code>ServerBootstrapAcceptor</code> å¤„ç†è¿æ¥</li>
</ul>
</li>
</ul>
<p><strong>READ äº‹ä»¶</strong>ï¼ˆå®¢æˆ·ç«¯ï¼‰</p>
<ul>
<li>
<p>è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">processSelectedKeys() </span><br><span class="line">  â†’ NioByteUnsafe.read() </span><br><span class="line">    â†’ SocketChannel.read(ByteBuf) </span><br><span class="line">    â†’ pipeline.fireChannelRead(ByteBuf) <span class="comment">// è§¦å‘æ•°æ®è¯»å–äº‹ä»¶</span></span><br><span class="line">      â†’ StringDecoder.channelRead()    <span class="comment">// è§£ç å™¨å¤„ç†</span></span><br><span class="line">      â†’ MyHandler.channelRead()        <span class="comment">// ä¸šåŠ¡å¤„ç†å™¨</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Pipeline è§¦å‘ç‚¹ï¼š</p>
<ul>
<li><code>fireChannelRead()</code>ï¼šå°†æ•°æ®ä¼ é€’ç»™ç¬¬ä¸€ä¸ª <code>ChannelInboundHandler</code></li>
<li>æ•°æ®ä¼šä¾æ¬¡é€šè¿‡æ‰€æœ‰å…¥ç«™å¤„ç†å™¨ï¼ˆå¦‚è§£ç å™¨ã€ä¸šåŠ¡é€»è¾‘ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>WRITE äº‹ä»¶</strong></p>
<ul>
<li>
<p>è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">processSelectedKeys() </span><br><span class="line">  â†’ AbstractChannel$AbstractUnsafe.forceFlush()</span><br><span class="line">    â†’ pipeline.fireChannelWritabilityChanged() <span class="comment">// è§¦å‘å¯å†™çŠ¶æ€å˜åŒ–</span></span><br><span class="line">    â†’ outboundBuffer.removeBytes(writtenBytes) <span class="comment">// æ›´æ–°å†™æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Pipeline è§¦å‘ç‚¹ï¼š</p>
<ul>
<li><code>fireChannelWritabilityChanged()</code>ï¼šé€šçŸ¥å¤„ç†å™¨å†™çŠ¶æ€å˜åŒ–</li>
<li>é€šå¸¸ç”¨äºæµé‡æ§åˆ¶ï¼ˆå¦‚åœæ­¢å†™å…¥é¿å…OOMï¼‰</li>
</ul>
</li>
</ul>
<hr>
<p><strong>å…³é”®ç»“è®º</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>äº‹ä»¶ç±»å‹</strong></th>
<th style="text-align:center"><strong>æ˜¯å¦è§¦å‘ Pipeline</strong></th>
<th style="text-align:center"><strong>è§¦å‘çš„å¤„ç†å™¨æ–¹æ³•</strong></th>
<th style="text-align:center"><strong>å…¸å‹å¤„ç†å™¨</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ACCEPT</td>
<td style="text-align:center">æ˜¯ï¼ˆä½†ä»…é™æœåŠ¡ç«¯ç‰¹æ®Šå¤„ç†å™¨ï¼‰</td>
<td style="text-align:center"><code>channelRead()</code></td>
<td style="text-align:center"><code>ServerBootstrapAcceptor</code></td>
</tr>
<tr>
<td style="text-align:center">READ</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center"><code>channelRead()</code></td>
<td style="text-align:center"><code>StringDecoder</code>/<code>MyHandler</code></td>
</tr>
<tr>
<td style="text-align:center">WRITE</td>
<td style="text-align:center">æ˜¯ï¼ˆä»…è§¦å‘å†™çŠ¶æ€å˜æ›´ï¼‰</td>
<td style="text-align:center"><code>channelWritabilityChanged()</code></td>
<td style="text-align:center">æµé‡æ§åˆ¶å¤„ç†å™¨</td>
</tr>
<tr>
<td style="text-align:center">CONNECT</td>
<td style="text-align:center">æ˜¯ï¼ˆå®¢æˆ·ç«¯è¿æ¥å®Œæˆæ—¶ï¼‰</td>
<td style="text-align:center"><code>channelActive()</code></td>
<td style="text-align:center">æ—¥å¿—å¤„ç†å™¨/åˆå§‹åŒ–å¤„ç†å™¨</td>
</tr>
</tbody>
</table>
<h4 id="ChannelHandler">ChannelHandler</h4>
<p>é€‚é…å™¨ç±»åœ¨<strong>æ¥å£ï¼ˆHandlerï¼‰å’Œç”¨æˆ·å®ç°ç±»</strong>ä¹‹é—´æ¶è®¾äº†ä¸€å±‚ç¼“å†²ï¼Œå°†â€œå¿…é¡»å®ç°æ‰€æœ‰æ–¹æ³•â€çš„ä¸¥æ ¼æ¥å£é€‚é…ä¸ºâ€œæŒ‰éœ€å®ç°â€çš„çµæ´»æ–¹å¼ã€‚</p>
<img src="/2025/03/28/Netty/chapter06_01.png" class="" title="img">
<p>é€šè¿‡ç»§æ‰¿ <code>ChannelInboundHandlerAdapter</code>é‡å†™ç›¸åº”æ–¹æ³•å®ç°ä¸šåŠ¡é€»è¾‘</p>
<img src="/2025/03/28/Netty/chapter06_02.png" class="" title="img">
<h3 id="Nettyé›¶æ‹·è´">Nettyé›¶æ‹·è´</h3>
<ol>
<li><strong>ç›´æ¥å°è£… JDK Channel</strong>ï¼šé¿å…æŠ½è±¡å±‚å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚</li>
<li><strong>å¼ºåˆ¶ä½¿ç”¨ Direct Buffer</strong>ï¼šå‡å°‘å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„å†…å­˜æ‹·è´ã€‚</li>
<li><strong>æ–‡ä»¶ä¼ è¾“é›¶æ‹·è´</strong>ï¼šåˆ©ç”¨ <code>sendfile</code> ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li><strong>å†…å­˜æ± åŒ–æŠ€æœ¯</strong>ï¼šé‡ç”¨å·²åˆ†é…çš„å †å¤–å†…å­˜ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Java, Design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>Computer-Network</title>
    <url>/2025/02/19/Computer-Network/</url>
    <content><![CDATA[<p>computer network</p>
<span id="more"></span>
<h1>Computer Network</h1>
<h2 id="UDP">UDP</h2>
<h3 id="QUIC">QUIC</h3>
<p><strong>é‡ä¼ ï¼š</strong></p>
<ul>
<li>
<p>QUICä¸‹çš„æ¯ä¸ªæ•°æ®åŒ…çš„Packet Numberå”¯ä¸€ï¼Œä¸¢åŒ…é‡ä¼ åŒ…çš„Packet Numberä¸åŸå§‹åŒ…ä¸ä¸€æ ·ï¼›</p>
</li>
<li>
<p>å…è®¸ä¹±åºç¡®è®¤æ¥æ”¶ï¼›</p>
</li>
</ul>
<p>ä¹±åºæ¥æ”¶åˆ°ACKå³å¯å°†çª—å£å‘å³ç§»åŠ¨è‡³æœ€å¤§ACKå¤„ï¼Œæœ€ç»ˆçª—å£å¡åœ¨æ²¡æœ‰æ”¶åˆ°ACKçš„ä¸¢åŒ…å¤„ï¼Œå‘ç°ä¸¢åŒ…ï¼›</p>
<p><strong>æµé‡æ§åˆ¶ï¼š</strong></p>
<img src="/2025/02/19/Computer-Network/839501cffa7146cbb8d992264594e61d.png" class="" title="Connection æµé‡æ§åˆ¶">
<p>æ¯ä¸ªstreamä¸€ä¸ªæ»‘åŠ¨çª—å£ï¼Œä¸åŒstreamé—´çª—å£ç‹¬ç«‹ï¼Œå®ç°streamå†…æœ‰åºï¼Œstreamé—´ä¹±åº</p>
<p><strong>æ‹¥å¡æ§åˆ¶ï¼š</strong></p>
<p>åº”ç”¨å±‚æ§åˆ¶</p>
<h2 id="TCP">TCP</h2>
<h3 id="ä¸‰æ¬¡æ¡æ‰‹-å››æ¬¡æŒ¥æ‰‹">ä¸‰æ¬¡æ¡æ‰‹&amp;å››æ¬¡æŒ¥æ‰‹</h3>
<p>ä¸‰æ¬¡æ¡æ‰‹</p>
<p><strong>é¦–è¦åŸå› ï¼šé˜²æ­¢ã€Œå†å²è¿æ¥ã€åˆå§‹åŒ–äº†è¿æ¥</strong></p>
<p>è€ƒè™‘åœºæ™¯ï¼šæœåŠ¡å™¨ä¸æ—§çš„SYNè¯·æ±‚å»ºç«‹è¿æ¥</p>
<img src="/2025/02/19/Computer-Network/fe898053d2e93abac950b1637645943f.png" class="" title="ä¸¤æ¬¡æ¡æ‰‹æ— æ³•é˜»æ­¢å†å²è¿æ¥">
<p><strong>æ¬¡è¦åŸå› ï¼šåŒæ­¥åŒæ–¹åˆå§‹åºåˆ—å·</strong></p>
<p>ä¸¤æ¬¡æ¡æ‰‹åªä¿è¯äº†ä¸€æ–¹çš„åˆå§‹åºåˆ—å·èƒ½è¢«å¯¹æ–¹æˆåŠŸæ¥æ”¶ï¼Œæ²¡åŠæ³•ä¿è¯åŒæ–¹çš„åˆå§‹åºåˆ—å·éƒ½èƒ½è¢«ç¡®è®¤æ¥æ”¶ã€‚</p>
<p><strong>æ¬¡è¦åŸå› ï¼šèµ„æºæµªè´¹</strong></p>
<p>ä¸¤æ¬¡æ¡æ‰‹ä¸­ï¼ŒæœåŠ¡ç«¯ä¸çŸ¥é“å®¢æˆ·ç«¯æ˜¯å¦æ”¶åˆ°äº†è‡ªå·±å‘é€çš„ACKæŠ¥æ–‡ï¼Œå¿…é¡»å‡è®¾å…¶æ”¶åˆ°äº†å¹¶å»ºç«‹è¿æ¥</p>
<p>å››æ¬¡æŒ¥æ‰‹ï¼šåŒæ–¹å„ä¸€ä¸ª FIN + ACK</p>
<p><img src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230614791.png" alt="å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ â€”â€” TCP å››æ¬¡æŒ¥æ‰‹"></p>
<p>å®¢æˆ·ç«¯å‘é€FINåŒ…è¡¨ç¤ºä¸å†å‘é€æ•°æ®ï¼Œä½†ä»å¯æ¥æ”¶</p>
<p>æœåŠ¡ç«¯å‘é€ACKåŒ…è¡¨ç¤ºæ”¶åˆ°</p>
<p>æœåŠ¡ç«¯å‘é€FINåŒ…è¡¨ç¤ºè‡ªå·±ä¾§æ•°æ®å·²å®Œæˆå¤„ç†ï¼Œå¼€å§‹å…³é—­</p>
<p>å®¢æˆ·ç«¯å‘é€ACKè¡¨ç¤ºæ”¶åˆ°ï¼Œè‡ªå·±å»¶æ—¶å…³é—­ï¼›</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸æ˜¯ä¸‰æ¬¡ï¼Ÿ</p>
<p>å› ä¸ºæœåŠ¡ç«¯åœ¨æ”¶åˆ°å®¢æˆ·ç«¯æƒ³è¦å…³é—­çš„è¯·æ±‚æ—¶ï¼Œè‡ªå·±å¯èƒ½ä»åœ¨å¤„ç†æ•°æ®ï¼Œæ²¡åŠæ³•ç«‹åˆ»å…³é—­</p>
<p>å¦‚æœæœåŠ¡ç«¯å¯ä»¥ç«‹å³å…³é—­ï¼Œåˆ™å¯ä»¥å½“åœºå›å¤FIN+ACKï¼Œå®ç°ä¸‰æ¬¡æŒ¥æ‰‹å…³é—­è¿æ¥</p>
</blockquote>
<h3 id="å¯é ä¼ è¾“">å¯é ä¼ è¾“</h3>
<p>TCP é‡ä¼ ã€æ»‘åŠ¨çª—å£æµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶</p>
<h4 id="é‡ä¼ ">é‡ä¼ </h4>
<p>æœåŠ¡ç«¯è¿”å›ACK = xï¼Œxä¸ºæœåŠ¡ç«¯å¸Œæœ›æ”¶åˆ°çš„æœ€æ–°åŒ…</p>
<blockquote>
<p>ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯ä¸€æ¬¡å‘é€idèŒƒå›´ä¸º(100, 500)çš„æ•°æ®åŒ…ï¼ŒæœåŠ¡ç«¯è¿”å›ACK = 501</p>
</blockquote>
<p><strong>è¶…æ—¶é‡ä¼ </strong></p>
<p><code>RTO(ReTransmission Timeout)</code>  &gt; <code>RTT(Round-Trip Time)</code></p>
<ul>
<li>æ•°æ®åŒ…ä¸¢å¤±ï¼Œå®¢æˆ·ç«¯å‘é€ä¸¢å¤±</li>
<li>ç¡®è®¤åº”ç­”ä¸¢å¤±ï¼ŒæœåŠ¡ç«¯å‘é€ä¸¢å¤±</li>
</ul>
<p><strong>å¿«é€Ÿé‡ä¼ </strong></p>
<p>è¿ç»­æ”¶åˆ°3ä¸ªç›¸åŒidçš„ACKï¼Œç«‹åˆ»é‡ä¼ è¯¥idå¯¹åº”æ•°æ®åŒ…</p>
<p><strong>SACK(Selective Acknowledge)é‡ä¼ </strong></p>
<p>é¢å¤–ä¸ºTCPå¤´éƒ¨é™„åŠ SACKå­—æ®µ</p>
<p>SACKå­—æ®µæŒ‡å‡ºå¤§äºACKçš„ï¼Œå·²ç»æ”¶åˆ°çš„åŒ…çš„èŒƒå›´</p>
<h4 id="æ»‘åŠ¨çª—å£ä¸æµé‡æ§åˆ¶">æ»‘åŠ¨çª—å£ä¸æµé‡æ§åˆ¶</h4>
<p>TCPæ‰€æœ‰åŒ…å¿…é¡»é¡ºåºç¡®è®¤ï¼Œä¸¢åŒ…å°†å¯¼è‡´çª—å£ä¸æ»‘åŠ¨ï¼›</p>
<p><strong>å‘é€æ–¹çª—å£</strong></p>
<p>å¤„äºçª—å£å†…çš„æ•°æ®ç›´æ¥å‘é€ï¼Œç­‰å¾…ACKï¼›</p>
<p>æ¥æ”¶åˆ°æœ€å¤§ACKåï¼Œç§»åŠ¨çª—å£å·¦ç«¯åˆ°æœ€å¤§ACKå€¼å¤„</p>
<img src="/2025/02/19/Computer-Network/19.jpg" class="" title="SND.WNDã€SND.UNã€SND.NXT">
<p><strong>æ¥æ”¶æ–¹çª—å£</strong></p>
<img src="/2025/02/19/Computer-Network/20.jpg" class="" title="æ¥æ”¶çª—å£">
<p>é€šè¿‡æ¥æ”¶ç«¯/å‘é€ç«¯çª—å£å¤§å°å˜åŒ–å®ç°æµé‡æ§åˆ¶</p>
<h4 id="æ‹¥å¡æ§åˆ¶">æ‹¥å¡æ§åˆ¶</h4>
<img src="/2025/02/19/Computer-Network/%E6%8B%A5%E5%A1%9E%E5%8F%91%E7%94%9F-%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0.drawio.png" class="" title="å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤">
<p><strong>æ…¢å¯åŠ¨</strong></p>
<p><strong>æ‹¥å¡é¿å…</strong></p>
<p><strong>å¿«é‡ä¼ </strong></p>
<p><strong>å¿«é€Ÿæ¢å¤</strong></p>
<h3 id="å…¶ä»–">å…¶ä»–</h3>
<h4 id="TCPæ²¾åŒ…">TCPæ²¾åŒ…</h4>
<p>æ²¾åŒ…ï¼šå¤šä¸ªæ•°æ®åŒ…å¤„äºä¸€ä¸ªæ»‘åŠ¨çª—å£å†…ï¼Œè¢«ä¸€åŒå‘é€ï¼Œå¯¼è‡´æ— æ³•åŒºåˆ†åŒ…çš„å¼€å§‹/ç»“æŸï¼›</p>
<p>æ‹†åŒ…ï¼šå•ä¸ªæ•°æ®åŒ…å¤§äºä¸€ä¸ªæ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œè¢«æ‹†æˆå¤šä¸ªå‘é€ï¼›</p>
<blockquote>
<p>UDPåŒ…çš„æ¶ˆæ¯å¤´åŒ…å«äº†UDPé•¿åº¦</p>
</blockquote>
<p>è§£å†³æ–¹æ³•</p>
<ul>
<li>å¼ºåˆ¶ä¸ºæ¯ä¸ªåŒ…è¡¥é½çª—å£é•¿åº¦</li>
<li>åœ¨åŒ…çš„æœ«å°¾æ‰‹åŠ¨æ·»åŠ åˆ†éš”ç¬¦</li>
<li>åœ¨åŒ…çš„å¤´éƒ¨æ‰‹åŠ¨æ·»åŠ é•¿åº¦æŒ‡ç¤ºä¿¡æ¯</li>
</ul>
<p>httpè§£å†³æ²¾åŒ…é—®é¢˜</p>
<p>ä½¿ç”¨Content-Lengthæ¥æ ‡è¯†bodyçš„é•¿åº¦</p>
<p>ä½¿ç”¨Transfer-Encoding: chunkedï¼ŒæŒ‰ç…§chunkedåè®®åˆ†æ‰¹è¯»å–æ•°æ®</p>
<p>httpè¯·æ±‚æŠ¥æ–‡æ ¼å¼</p>
<p>1ï¼‰è¯·æ±‚è¡Œï¼šä»¥\r\nç»“æŸï¼›<br>
2ï¼‰è¯·æ±‚å¤´ï¼šä»¥\r\nç»“æŸï¼›<br>
3ï¼‰\r\nï¼›<br>
3ï¼‰æ•°æ®ï¼›</p>
<p>httpå“åº”æŠ¥æ–‡æ ¼å¼<br>
1ï¼‰å“åº”è¡Œï¼šä»¥\r\nç»“æŸï¼›<br>
2ï¼‰å“åº”å¤´ï¼šä»¥\r\nç»“æŸï¼›<br>
3ï¼‰\r\nï¼›<br>
4ï¼‰æ•°æ®ï¼›</p>
<h2 id="HTTP">HTTP</h2>
<h3 id="HTTP1-1">HTTP1.1</h3>
<p><strong>é•¿è¿æ¥</strong></p>
<p>å»ºç«‹TCPè¿æ¥åä¿æŒ</p>
<p><strong>ç®¡é“ç½‘ç»œä¼ è¾“</strong></p>
<p>åœ¨åŒä¸€ä¸ªTCPè¿æ¥ä¸‹ï¼Œè¿ç»­å‘é€å¤šä¸ªHTTPè¯·æ±‚ï¼›è¦æ±‚å¯¹æ¯ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå›åº”ï¼›</p>
<p>å¦‚æœæœåŠ¡ç«¯åœ¨å¤„ç† A è¯·æ±‚æ—¶è€—æ—¶æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚çš„å¤„ç†éƒ½ä¼šè¢«é˜»å¡ä½ï¼Œè¿™ç§°ä¸ºã€Œé˜Ÿå¤´å µå¡ã€ã€‚</p>
<blockquote>
<p>HTTP/1.1 ç®¡é“è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³å“åº”çš„é˜Ÿå¤´é˜»å¡ï¼›è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡æ˜¯æŒ‡ï¼Œè¯·æ±‚åå¿…é¡»ç­‰å¾…æ”¶åˆ°å“åº”æ‰èƒ½å‘é€æ–°è¯·æ±‚ï¼›</p>
<p>å®é™…ä¸Šï¼ŒHTTP ç®¡é“åŒ–æŠ€æœ¯ä¸æ˜¯é»˜è®¤å¼€å¯ï¼Œåç»­å¯¹HTTP 1.1 çš„è®¨è®ºåŸºäºç®¡é“åŒ–æŠ€æœ¯æ²¡æœ‰å¼€å¯</p>
</blockquote>
<p><strong>Hostå­—æ®µ</strong></p>
<p>åœ¨HTTP1.0ä¸­è®¤ä¸ºæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œå› æ­¤ï¼Œè¯·æ±‚æ¶ˆæ¯ä¸­çš„URLå¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåï¼Œä½†éšç€è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¹¶ä¸”å®ƒä»¬å…±äº«ä¸€ä¸ªIPåœ°å€ã€‚</p>
<p>HTTP1.1çš„è¯·æ±‚æ¶ˆæ¯å’Œå“åº”æ¶ˆæ¯éƒ½åº”æ”¯æŒHostå¤´åŸŸï¼Œä¸”è¯·æ±‚æ¶ˆæ¯ä¸­å¦‚æœæ²¡æœ‰Hostå¤´åŸŸä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼ˆ400 Bad Requestï¼‰ã€‚</p>
<p>æ­¤å¤–ï¼ŒæœåŠ¡å™¨åº”è¯¥æ¥å—ä»¥ç»å¯¹è·¯å¾„æ ‡è®°çš„èµ„æºè¯·æ±‚ã€‚</p>
<p><strong>Chunked Transfer Coding</strong></p>
<p>HTTP/1.1å°†å‘é€æ–¹å°†æ¶ˆæ¯åˆ†å‰²æˆè‹¥å¹²ä¸ªä»»æ„å¤§å°çš„æ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—åœ¨å‘é€æ—¶éƒ½ä¼šé™„ä¸Šå—çš„é•¿åº¦ï¼Œæœ€åç”¨ä¸€ä¸ªé›¶é•¿åº¦çš„å—ä½œä¸ºæ¶ˆæ¯ç»“æŸçš„æ ‡å¿—ã€‚</p>
<p>è¿™ç§æ–¹æ³•å…è®¸å‘é€æ–¹åªç¼“å†²æ¶ˆæ¯çš„ä¸€ä¸ªç‰‡æ®µï¼Œé¿å…ç¼“å†²æ•´ä¸ªæ¶ˆæ¯å¸¦æ¥çš„è¿‡è½½ã€‚</p>
<p><strong>Cache</strong></p>
<p>HTTP/1.1åœ¨1.0çš„åŸºç¡€ä¸ŠåŠ å…¥äº†ä¸€äº›Cacheçš„æ–°ç‰¹æ€§ï¼Œå½“ç¼“å­˜å¯¹è±¡çš„Ageè¶…è¿‡Expireæ—¶å˜ä¸ºStableå¯¹è±¡ï¼ŒCacheä¸éœ€è¦ç›´æ¥æŠ›å¼ƒStableå¯¹è±¡ï¼Œè€Œæ˜¯ä¸æºæœåŠ¡å™¨è¿›è¡Œé‡æ–°æ¿€æ´»ã€‚</p>
<h3 id="HTTP2-0">HTTP2.0</h3>
<img src="/2025/02/19/Computer-Network/25-HTTP2.png" class="" title="HTT&#x2F;1 ~ HTTP&#x2F;2">
<p><strong>HTTP2.0å’ŒHTTP1.Xç›¸æ¯”çš„æ–°ç‰¹æ€§</strong></p>
<ul>
<li><strong>äºŒè¿›åˆ¶å¸§</strong>ï¼Œ<code>HTTP1.x</code>çš„è§£ææ˜¯åŸºäºæ–‡æœ¬æ ¼å¼</li>
<li><strong>å¹¶å‘ä¼ è¾“</strong>ï¼Œä¸€ä¸ª TCP è¿æ¥åŒ…å« å¤šä¸ª streamï¼Œæ¯ä¸ª stream åŒ…å«å¤šä¸ª Messageï¼Œæ¯ä¸ª Message åŒ…å«å¤šä¸ª Frame</li>
<li><strong>å¤´éƒ¨å‹ç¼©</strong>ï¼ŒHPACK ç®—æ³•å‹ç¼©å¤´éƒ¨</li>
<li><strong>æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€</strong></li>
</ul>
<img src="/2025/02/19/Computer-Network/http2%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.jpeg" class="" title="img">
<p><strong>æ•°æ®æµ</strong></p>
<p>HTTP/2 çš„æ•°æ®åŒ…ä¸æ˜¯æŒ‰é¡ºåºå‘é€çš„ï¼ŒåŒä¸€ä¸ªè¿æ¥é‡Œé¢è¿ç»­çš„æ•°æ®åŒ…ï¼Œå¯èƒ½å±äºä¸åŒçš„å›åº”ã€‚</p>
<p>å› æ­¤ï¼Œå¿…é¡»è¦å¯¹æ•°æ®åŒ…åšæ ‡è®°ï¼ŒæŒ‡å‡ºå®ƒå±äºå“ªä¸ªå›åº”ã€‚</p>
<p>æ¯ä¸ªè¯·æ±‚æˆ–å›åº”çš„æ‰€æœ‰æ•°æ®åŒ…ï¼Œç§°ä¸ºä¸€ä¸ªæ•°æ®æµï¼ˆStreamï¼‰ã€‚</p>
<p>æ¯ä¸ªæ•°æ®æµéƒ½æ ‡è®°ç€ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç¼–å·ï¼Œå…¶ä¸­è§„å®šå®¢æˆ·ç«¯å‘å‡ºçš„æ•°æ®æµç¼–å·ä¸ºå¥‡æ•°ï¼Œ æœåŠ¡å™¨å‘å‡ºçš„æ•°æ®æµç¼–å·ä¸ºå¶æ•°</p>
<p>å®¢æˆ·ç«¯è¿˜å¯ä»¥<strong>æŒ‡å®šæ•°æ®æµçš„ä¼˜å…ˆçº§</strong>ã€‚ä¼˜å…ˆçº§é«˜çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨å°±å…ˆå“åº”è¯¥è¯·æ±‚ã€‚</p>
<p>åŒä¸€ä¸ªstreamä¸Šçš„å¸§å¯ä»¥ä¿è¯é¡ºåºæ€§ï¼Œå°†httpæŠ¥æ–‡æ‹†æˆå¸§åè€ƒè™‘åœ¨åŒä¸€ä¸ªstreamä¸Šä¼ è¾“ï¼Ÿ</p>
<p><strong>HTTP2.0çš„å¤šè·¯å¤ç”¨å’ŒHTTP1.Xä¸­çš„é•¿è¿æ¥å¤ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«</strong></p>
<ul>
<li>HTTP/1.1çš„Pipelingä¸ºè‹¥å¹²ä¸ªè¯·æ±‚æ’é˜Ÿä¸²è¡ŒåŒ–å•çº¿ç¨‹å¤„ç†ï¼Œåé¢çš„è¯·æ±‚ç­‰å¾…å‰é¢è¯·æ±‚çš„è¿”å›æ‰èƒ½è·å¾—æ‰§è¡Œæœºä¼šï¼Œä¸€æ—¦æœ‰æŸè¯·æ±‚è¶…æ—¶ç­‰ï¼Œåç»­è¯·æ±‚åªèƒ½è¢«é˜»å¡ï¼Œæ¯«æ— åŠæ³•ï¼›</li>
<li>HTTP2.0å¤šä¸ªè¯·æ±‚å¯åŒæ—¶åœ¨ä¸€ä¸ªè¿æ¥ä¸Šå¹¶è¡Œæ‰§è¡Œï¼ŒæŸä¸ªè¯·æ±‚ä»»åŠ¡è€—æ—¶ä¸¥é‡ï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒè¿æ¥çš„æ­£å¸¸æ‰§è¡Œ</li>
</ul>
<p>å­˜åœ¨é—®é¢˜ï¼štcpé“¾æ¥äº§ç”Ÿçš„é˜»å¡</p>
<img src="/2025/02/19/Computer-Network/http2%E9%98%BB%E5%A1%9E.jpeg" class="" title="img">
<h3 id="HTTP3-0">HTTP3.0</h3>
<img src="/2025/02/19/Computer-Network/fh5fm7pgm2.png" class="" title="img">
<p><strong>ä½¿ç”¨UDPåè®®</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc8e97afd2124bddb52ee4f1911fa2da~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p>
<p>HTTP/2 ä¸»è¦çš„é—®é¢˜åœ¨äºï¼šå¤šä¸ª HTTP è¯·æ±‚åœ¨å¤ç”¨ä¸€ä¸ª TCP è¿æ¥ï¼Œä¸‹å±‚çš„ TCP åè®®æ˜¯ä¸çŸ¥é“æœ‰å¤šå°‘ä¸ª HTTP è¯·æ±‚çš„ã€‚</p>
<p>æ‰€ä»¥ä¸€æ—¦å‘ç”Ÿäº†ä¸¢åŒ…ç°è±¡ï¼Œå°±ä¼šè§¦å‘ TCP çš„é‡ä¼ æœºåˆ¶ï¼Œè¿™æ ·åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸­çš„<strong>æ‰€æœ‰çš„ HTTP è¯·æ±‚éƒ½å¿…é¡»ç­‰å¾…è¿™ä¸ªä¸¢äº†çš„åŒ…è¢«é‡ä¼ å›æ¥</strong>ã€‚</p>
<ul>
<li>HTTP/1.1 ä¸­çš„ç®¡é“ä¼ è¾“ä¸­å¦‚æœæœ‰ä¸€ä¸ªè¯·æ±‚é˜»å¡äº†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—åè¯·æ±‚ä¹Ÿç»Ÿç»Ÿè¢«é˜»å¡ä½äº†</li>
<li>HTTP/2 å¤šè¯·æ±‚å¤ç”¨ä¸€ä¸ªTCPè¿æ¥ï¼Œä¸€æ—¦å‘ç”Ÿä¸¢åŒ…ï¼Œå°±ä¼šé˜»å¡ä½æ‰€æœ‰çš„ HTTP è¯·æ±‚ã€‚</li>
</ul>
<p>è¿™éƒ½æ˜¯åŸºäº TCP ä¼ è¾“å±‚çš„é—®é¢˜ï¼Œæ‰€ä»¥ <strong>HTTP/3 æŠŠ HTTP ä¸‹å±‚çš„ TCP åè®®æ”¹æˆäº† UDPï¼</strong></p>
<p>QUICåè®®-åŸºäºUDPçš„å¯é ä¼ è¾“åè®®</p>
<ul>
<li>
<p>æ— é˜Ÿå¤´é˜»å¡ï¼›</p>
<img src="/2025/02/19/Computer-Network/quic%E6%97%A0%E9%98%BB%E5%A1%9E.jpeg" class="" title="img">
</li>
<li>
<p>æ›´å¿«çš„è¿æ¥å»ºç«‹ï¼›</p>
<img src="/2025/02/19/Computer-Network/28-HTTP3%E4%BA%A4%E4%BA%92%E6%AC%A1%E6%95%B0.png" class="" title="TCP HTTPSï¼ˆTLS&#x2F;1.3ï¼‰ å’Œ QUIC HTTPS">
</li>
<li>
<p>è¿æ¥è¿ç§»ï¼›</p>
</li>
</ul>
<h2 id="HTTPS">HTTPS</h2>
<p>æœåŠ¡ç«¯è¿”å›å®¢æˆ·ç«¯çš„è®¤è¯å†…å®¹ä¸º</p>
<p>æœåŠ¡å™¨å…¬é’¥ + ç­¾åï¼ˆCAä½¿ç”¨CAçš„ç§é’¥å¯¹æœåŠ¡å™¨å…¬é’¥è¿›è¡Œçš„è®¡ç®—çš„ç»“æœï¼‰</p>
<p>å®¢æˆ·ç«¯ä½¿ç”¨é¢„å…ˆä¿å­˜çš„CAçš„å…¬é’¥å¯¹ç­¾åè¿›è¡Œè§£å¯†ï¼Œå¯¹æ¯”è§£å¯†ç»“æœä¸å…¬é’¥æ˜¯å¦ä¸€è‡´</p>
<img src="/2025/02/19/Computer-Network/wangluo-45917c49-bb08-4f88-84d2-5e8ae53acc7c.png" class="" title="img">
<p><strong>HTTPSæµç¨‹</strong></p>
<p>TCP(3) + TLS(4)</p>
<img src="/2025/02/19/Computer-Network/23-HTTPS%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" class="" title="HTTPS è¿æ¥å»ºç«‹è¿‡ç¨‹">
<ul>
<li>Clientå‘èµ·ä¸€ä¸ªHTTPSçš„è¯·æ±‚</li>
<li>ServeræŠŠäº‹å…ˆé…ç½®å¥½çš„å…¬é’¥è¯ä¹¦è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>ClientéªŒè¯å…¬é’¥è¯ä¹¦ï¼šæ¯”å¦‚æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼Œè¯ä¹¦çš„ç”¨é€”æ˜¯ä¸æ˜¯åŒ¹é…Clientè¯·æ±‚çš„ç«™ç‚¹ï¼Œæ˜¯ä¸æ˜¯åœ¨CRLåŠé”€åˆ—è¡¨é‡Œé¢ï¼Œå®ƒçš„ä¸Šä¸€çº§è¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œç›´åˆ°éªŒè¯åˆ°æ ¹è¯ä¹¦ï¼ˆæ“ä½œç³»ç»Ÿå†…ç½®çš„Rootè¯ä¹¦æˆ–è€…Clientå†…ç½®çš„Rootè¯ä¹¦ï¼‰ï¼Œå¦‚æœéªŒè¯é€šè¿‡åˆ™ç»§ç»­ï¼Œä¸é€šè¿‡åˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ã€‚</li>
<li>Clientä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ç”ŸæˆåŠ å¯†æ‰€ä½¿ç”¨çš„å¯¹ç§°å¯†é’¥ï¼Œç„¶åç”¨è¯ä¹¦çš„å…¬é’¥åŠ å¯†è¿™ä¸ªå¯¹ç§°å¯†é’¥ï¼Œå‘ç»™Serverã€‚</li>
<li>Serverä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†è¿™ä¸ªæ¶ˆæ¯ï¼Œå¾—åˆ°å¯¹ç§°å¯†é’¥ã€‚è‡³æ­¤ï¼ŒClientå’ŒServeråŒæ–¹éƒ½æŒæœ‰äº†ç›¸åŒçš„å¯¹ç§°å¯†é’¥ã€‚</li>
<li>Serverä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†æ˜æ–‡å†…å®¹Aï¼Œå‘é€ç»™Clientã€‚</li>
<li>Clientä½¿ç”¨å¯¹ç§°å¯†é’¥è§£å¯†å“åº”çš„å¯†æ–‡ï¼Œå¾—åˆ°æ˜æ–‡å†…å®¹Aã€‚</li>
<li>Clientå†æ¬¡å‘èµ·HTTPSçš„è¯·æ±‚ï¼Œä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†è¯·æ±‚çš„æ˜æ–‡å†…å®¹Bï¼Œç„¶åServerä½¿ç”¨å¯¹ç§°å¯†é’¥è§£å¯†å¯†æ–‡ï¼Œå¾—åˆ°æ˜æ–‡å†…å®¹Bã€‚</li>
</ul>
<h2 id="DNS">DNS</h2>
<p>æµç¨‹</p>
<ol>
<li>
<p><strong>æœ¬åœ°ä¸»æœºæŸ¥è¯¢ (Local Host File Check):</strong> é¦–å…ˆä¼šæ£€æŸ¥æœ¬åœ°çš„ hosts æ–‡ä»¶ (ä½äºä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„ä¸åŒä½ç½®ï¼Œä¾‹å¦‚ Windows çš„ C:\Windows\System32\drivers\etc\hosts æˆ– Linux/macOS çš„ /etc/hosts) æ˜¯å¦åŒ…å« <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ã€‚ å¦‚æœæ‰¾åˆ°ï¼Œåˆ™è·³è¿‡åé¢çš„æ­¥éª¤ï¼Œç›´æ¥ä½¿ç”¨è¯¥ IP åœ°å€ã€‚ è¿™æ˜¯ä¸€ä¸ªä¼˜å…ˆäº DNS æŸ¥è¯¢çš„ä¼˜åŒ–æœºåˆ¶ã€‚</p>
</li>
<li>
<p><strong>é€’å½’æŸ¥è¯¢æœ¬åœ° DNS æœåŠ¡å™¨ (Recursive Query to Local DNS Resolver):</strong> å¦‚æœ hosts æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œä¼šå‘é…ç½®å¥½çš„ <strong>æœ¬åœ° DNS æœåŠ¡å™¨ (Local DNS Resolver)</strong> å‘é€ä¸€ä¸ª <strong>é€’å½’æŸ¥è¯¢ (Recursive Query)</strong>ã€‚ æœ¬åœ° DNS æœåŠ¡å™¨é€šå¸¸ç”± ISP (äº’è”ç½‘æœåŠ¡æä¾›å•†) æä¾›ï¼Œä¹Ÿå¯èƒ½æ˜¯æ‰‹åŠ¨é…ç½®çš„ (ä¾‹å¦‚ï¼ŒGoogle Public DNS æˆ– Cloudflare DNS)ã€‚ â€œé€’å½’â€æ„å‘³ç€æœ¬åœ° DNS æœåŠ¡å™¨å°†è´Ÿè´£å®Œæˆæ•´ä¸ªè§£æè¿‡ç¨‹ï¼Œå¹¶æœ€ç»ˆè¿”å› IP åœ°å€ã€‚</p>
</li>
<li>
<p><strong>é€’å½’æŸ¥è¯¢æ ¹ DNS æœåŠ¡å™¨ (Recursive Query to Root DNS Servers):</strong> å¦‚æœæœ¬åœ° DNS æœåŠ¡å™¨ä¸çŸ¥é“ <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ï¼Œå®ƒä¼šè”ç³»å…¶ä¸­ä¸€ä¸ª <strong>æ ¹ DNS æœåŠ¡å™¨ (Root DNS Servers)</strong>ã€‚ æ ¹ DNS æœåŠ¡å™¨çŸ¥é“æ‰€æœ‰é¡¶çº§åŸŸå (TLD) æœåŠ¡å™¨çš„åœ°å€ã€‚ å…¨çƒå…±æœ‰ 13 ç»„æ ¹ DNS æœåŠ¡å™¨ï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„ç‰©ç†ä½ç½®ï¼Œå¹¶ä½¿ç”¨ä»»æ’­ (Anycast) æŠ€æœ¯ä»¥æé«˜å¯ç”¨æ€§å’Œæ•ˆç‡ã€‚ æœ¬åœ° DNS æœåŠ¡å™¨ä¼šè¯¢é—®æ ¹æœåŠ¡å™¨ <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ã€‚ æ ¹æœåŠ¡å™¨<strong>ä¸ä¼šç›´æ¥è¿”å› IP åœ°å€</strong>ï¼Œè€Œæ˜¯è¿”å›è´Ÿè´£ .com åŸŸçš„ <strong>TLD DNS æœåŠ¡å™¨</strong>çš„åœ°å€ã€‚</p>
</li>
<li>
<p><strong>é€’å½’æŸ¥è¯¢ TLD DNS æœåŠ¡å™¨ (Recursive Query to TLD DNS Servers):</strong> æœ¬åœ° DNS æœåŠ¡å™¨æ”¶åˆ° .com TLD æœåŠ¡å™¨çš„åœ°å€åï¼Œä¼šè”ç³»è¯¥ TLD æœåŠ¡å™¨ï¼Œè¯¢é—® <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ã€‚ .com TLD æœåŠ¡å™¨<strong>ä¹Ÿä¸ä¼šç›´æ¥è¿”å› IP åœ°å€</strong>ï¼Œè€Œæ˜¯è¿”å›è´Ÿè´£ <a href="http://example.com">example.com</a> åŸŸçš„ <strong>æƒå¨ DNS æœåŠ¡å™¨ (Authoritative DNS Servers)</strong> çš„åœ°å€ã€‚</p>
</li>
<li>
<p><strong>é€’å½’æŸ¥è¯¢æƒå¨ DNS æœåŠ¡å™¨ (Recursive Query to Authoritative DNS Servers):</strong> æœ¬åœ° DNS æœåŠ¡å™¨æ”¶åˆ° <a href="http://example.com">example.com</a> åŸŸçš„æƒå¨ DNS æœåŠ¡å™¨åœ°å€åï¼Œä¼šè”ç³»è¿™äº›æƒå¨ DNS æœåŠ¡å™¨ï¼Œè¯¢é—® <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ã€‚ <strong>æƒå¨ DNS æœåŠ¡å™¨æ‹¥æœ‰ <a href="http://example.com">example.com</a> åŸŸçš„ DNS è®°å½•</strong>ï¼Œå¹¶çŸ¥é“ <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ã€‚ å®ƒä¼šå°†è¿™ä¸ª IP åœ°å€è¿”å›ç»™æœ¬åœ° DNS æœåŠ¡å™¨ã€‚</p>
<blockquote>
<p>ä¾‹å¦‚ï¼Œå‡è®¾ <a href="http://example.com">example.com</a> çš„æƒå¨ DNS æœåŠ¡å™¨æœ‰ä»¥ä¸‹ DNS è®°å½•ï¼š</p>
<ul>
<li><strong><a href="http://example.com">example.com</a></strong> -&gt; 192.0.2.1</li>
<li><strong><a href="http://bbb.example.com">bbb.example.com</a></strong> -&gt; 192.0.2.2</li>
<li><strong><a href="http://aaa.example.com">aaa.example.com</a></strong> -&gt; 192.0.2.3</li>
</ul>
<p>å½“æœ¬åœ° DNS æœåŠ¡å™¨æŸ¥è¯¢ <a href="http://bbb.example.com">bbb.example.com</a> æ—¶ï¼Œæƒå¨ DNS æœåŠ¡å™¨ä¼šè¿”å› 192.0.2.2ã€‚åŒæ ·ï¼Œå½“æŸ¥è¯¢ <a href="http://aaa.example.com">aaa.example.com</a> æ—¶ï¼Œæƒå¨ DNS æœåŠ¡å™¨ä¼šè¿”å› 192.0.2.3ã€‚</p>
</blockquote>
</li>
<li>
<p><strong>ç¼“å­˜ä¸è¿”å› (Caching and Return):</strong> æœ¬åœ° DNS æœåŠ¡å™¨å°†æ”¶åˆ°çš„ IP åœ°å€ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿ä¸‹æ¬¡æœ‰äººè¯·æ±‚ <a href="http://www.example.com">www.example.com</a> æ—¶ï¼Œå®ƒå¯ä»¥ç›´æ¥è¿”å›è¯¥ IP åœ°å€ï¼Œè€Œæ— éœ€å†æ¬¡æ‰§è¡Œä¸Šè¿°æ­¥éª¤ã€‚ ç¼“å­˜æ—¶é—´ç”± DNS è®°å½•çš„ <strong>TTL (Time To Live)</strong> å€¼å†³å®šã€‚ æœ€åï¼Œæœ¬åœ° DNS æœåŠ¡å™¨å°† IP åœ°å€è¿”å›ç»™ä½ çš„ç”µè„‘ã€‚</p>
</li>
<li>
<p><strong>è¿æ¥æœåŠ¡å™¨ (Connect to Server):</strong> ä½ çš„ç”µè„‘ç°åœ¨æœ‰äº† <a href="http://www.example.com">www.example.com</a> çš„ IP åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨è¯¥ IP åœ°å€è¿æ¥åˆ°ç½‘ç«™æœåŠ¡å™¨ï¼Œå¹¶è·å–ç½‘é¡µå†…å®¹ã€‚</p>
</li>
</ol>
<h2 id="Cookie-Session-Token">Cookie &amp; Session &amp; Token</h2>
<p><strong>Cookie</strong></p>
<p>HTTP 1.1 å‡ºç°</p>
<p>Cookieæ˜¯æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶ä¿å­˜åœ¨ç”¨æˆ·æµè§ˆå™¨çš„æ•°æ®(æœåŠ¡ç«¯ç”Ÿæˆåä¸ä¿å­˜)</p>
<p>åç»­ç”¨æˆ·åœ¨è®¿é—®åŒä¸€æœåŠ¡å™¨æ—¶ï¼Œä¼šåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ Cookie</p>
<p><strong>æœåŠ¡å™¨è¿”å›æŠ¥æ–‡</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Content-type: text/html</span><br><span class="line">Set-Cookie: yummy_cookie=choco</span><br><span class="line">Set-Cookie: tasty_cookie=strawberry</span><br><span class="line"></span><br><span class="line">[page content]</span><br></pre></td></tr></table></figure>
<p><strong>å®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">GET /sample_page.html HTTP/1.1</span><br><span class="line">Host: www.example.org</span><br><span class="line">Cookie: yummy_cookie=choco; tasty_cookie=strawberry</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®é™…ä¸Šï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¿®æ”¹ä¿å­˜åœ¨æœ¬åœ°çš„ Cookieï¼Œå› æ­¤æœåŠ¡å™¨éœ€è¦é‡‡å–ä¸€äº›æªæ–½æ¥ç¡®ä¿ Cookie çš„æœ‰æ•ˆæ€§å’Œå®‰å…¨æ€§ã€‚</p>
</blockquote>
<p><strong>Session</strong></p>
<p>Sessionå­˜å‚¨äºæœåŠ¡ç«¯ï¼Œå¯ä»¥ä½¿ç”¨æ–‡ä»¶ï¼Œæ•°æ®åº“ï¼Œå†…å­˜ä¿å­˜ï¼›</p>
<p>æµç¨‹</p>
<ul>
<li>ç”¨æˆ·ç™»å½•åï¼ŒæœåŠ¡å™¨ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆä¸€ä¸ªSession IDï¼Œä¿å­˜åœ¨æœåŠ¡å™¨ï¼›</li>
<li>æœåŠ¡å™¨å‘é€è¿”å›æŠ¥æ–‡ï¼ŒSet-Cookie: Session ID;</li>
<li>ç”¨æˆ·åœ¨åç»­è¯·æ±‚ä¸­æºå¸¦Cookieï¼ˆå€¼ä¸ºSession IDï¼‰å‘ç”Ÿè‡³æœåŠ¡å™¨</li>
<li>æœåŠ¡å™¨å–å‡ºæŠ¥æ–‡ä¸­çš„Cookieå­—æ®µï¼Œå¹¶æ£€æŸ¥ä¿å­˜Session IDçš„æ•°æ®åº“è¿›è¡Œå¯¹æ¯”ï¼Œç¡®å®šç”¨æˆ·èº«ä»½</li>
</ul>
<p><strong>Token</strong></p>
<p>Tokenä¸ºæœåŠ¡å™¨åœ¨éªŒè¯ç”¨æˆ·èº«ä»½åï¼Œç”Ÿæˆå¹¶é€šè¿‡<strong>æŠ¥æ–‡ä½“</strong>æºå¸¦è¿”å›ç»™ç”¨æˆ·çš„æ•°æ®ï¼›</p>
<p>å®¢æˆ·ç«¯åœ¨åç»­çš„è®¿é—®ä¸­ï¼Œé€šè¿‡åœ¨è¯·æ±‚å¤´æ·»åŠ  <strong>Authorization</strong> å­—æ®µæºå¸¦ Token ä¿¡æ¯;</p>
<p><strong>ï¼ï¼ï¼æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ Session æ•°æ®ï¼ï¼ï¼</strong></p>
<p><strong>æ‰€æœ‰ä¿¡æ¯éƒ½åŒ…å«åœ¨ Token ä¸­ï¼ŒToken ä¸­åŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ã€‚å› æ­¤ï¼ŒJWT ä¸€æ—¦ç­¾å‘ï¼Œæ— æ³•ç›´æ¥æ’¤é”€ï¼Œé™¤éä½¿ç”¨é»‘åå•æœºåˆ¶æˆ–è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ã€‚</strong></p>
<p><strong>æœåŠ¡å™¨è¿”å›æŠ¥æ–‡</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">GET /protected-resource HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure>
<blockquote>
<p>JWT</p>
<p>JWT**ï¼ˆJSON Web Tokenï¼‰** æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨ç½‘ç»œåº”ç”¨é—´å®‰å…¨åœ°ä¼ é€’ä¿¡æ¯ã€‚JWT æ˜¯ä¸€ä¸ªè‡ªåŒ…å«çš„ Tokenï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯ã€ç­¾åå’Œå¯é€‰çš„å…¶ä»–å…ƒæ•°æ®ã€‚</p>
<p>JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨ <code>.</code> åˆ†éš”ï¼š</p>
<ul>
<li>
<p>Headerï¼šåŒ…å« Token çš„ç±»å‹ï¼ˆJWTï¼‰å’Œç­¾åç®—æ³•ï¼ˆå¦‚ HMAC SHA256 æˆ– RSAï¼‰ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Payloadï¼šåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ· IDã€è§’è‰²ï¼‰å’Œå…¶ä»–æ•°æ®ï¼ˆå¦‚è¿‡æœŸæ—¶é—´ï¼‰ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doe&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1516239022</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1516242622</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Signature</strong>ï¼šå¯¹ Header å’Œ Payload çš„ç­¾åï¼Œç”¨äºéªŒè¯ Token çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚</p>
</li>
</ul>
<p>æœ€ç»ˆçš„ JWT æ˜¯ä¸€ä¸ª Base64Url ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><code>Header.Payload.Signature</code></p>
<p>æ³¨æ„ï¼ŒJWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<strong>Header</strong>ã€<strong>Payload</strong> å’Œ <strong>Signature</strong>ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li><strong>Header</strong> å’Œ <strong>Payload</strong> æ˜¯ <strong>Base64Url ç¼–ç çš„æ˜æ–‡</strong>ï¼Œå¯ä»¥è¢«ä»»ä½•äººè§£ç æŸ¥çœ‹ã€‚</li>
<li><strong>Signature</strong> æ˜¯å¯¹ Header å’Œ Payload çš„ç­¾åï¼Œç”¨äºéªŒè¯æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚</li>
</ul>
<p>ç”±äºç­¾åæ‰€ä½¿ç”¨çš„å¯†é’¥ä»…æœåŠ¡å™¨æŒæœ‰ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥å¯†é’¥ç¡®å®šç­¾åçš„çœŸå®æ€§</p>
</blockquote>
<h2 id="IO">IO</h2>
<h3 id="åŒæ­¥IO">åŒæ­¥IO</h3>
<p><strong>åŒæ­¥é˜»å¡IO</strong></p>
<p>åº”ç”¨è¿›ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°æ•°æ®å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºä¸­æ‰è¿”å›ã€‚</p>
<p><strong>åŒæ­¥éé˜»å¡IO</strong></p>
<p>åº”ç”¨è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†…æ ¸è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚åº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä½†æ˜¯éœ€è¦ä¸æ–­çš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ¥è·çŸ¥ I/O æ˜¯å¦å®Œæˆï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºè½®è¯¢(polling)ã€‚</p>
<p><strong>åŒæ­¥å¤šè·¯å¤ç”¨IO</strong></p>
<p>å¤šä¸ªåŒæ­¥é˜»å¡IOï¼Œä»»ä¸€å°±ç»ª-è¿”å›</p>
<p>æµç¨‹çš„å¤šè·¯å¤ç”¨IOå®ç°ä¸»è¦åŒ…æ‹¬å››ç§: <code>select</code>ã€<code>poll</code>ã€<code>kqueue</code></p>
<p><code>epoll</code></p>
<h3 id="å¼‚æ­¥IO">å¼‚æ­¥IO</h3>
<p>ç›¸å¯¹äºåŒæ­¥IOï¼Œå¼‚æ­¥IOä¸æ˜¯é¡ºåºæ‰§è¡Œã€‚ç”¨æˆ·è¿›ç¨‹è¿›è¡Œaio_readç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæ— è®ºå†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œéƒ½ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ï¼Œç„¶åç”¨æˆ·æ€è¿›ç¨‹å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚ç­‰åˆ°socketæ•°æ®å‡†å¤‡å¥½äº†ï¼Œå†…æ ¸ç›´æ¥å¤åˆ¶æ•°æ®ç»™è¿›ç¨‹ï¼Œç„¶åä»å†…æ ¸å‘è¿›ç¨‹å‘é€é€šçŸ¥ã€‚IOä¸¤ä¸ªé˜¶æ®µï¼Œè¿›ç¨‹éƒ½æ˜¯éé˜»å¡çš„ã€‚</p>
<p><strong>å¼‚æ­¥å¤šè·¯å¤ç”¨IO</strong></p>
<h3 id="select-poll-epoll">select, poll &amp; epoll</h3>
<p><code>select</code></p>
<p>ä½å›¾+è½®è¯¢ ç›‘æ§ æ–‡ä»¶æè¿°ç¬¦ é›†åˆ</p>
<p><code>select</code> æ˜¯ä¸€ç§ç»å…¸çš„ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ƒå…è®¸ç¨‹åºç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰ï¼Œå¹¶åœ¨è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿ I/O æ“ä½œæ—¶å¾—åˆ°é€šçŸ¥ã€‚å®ƒçš„å·¥ä½œåŸç†å’Œå®ç°å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p><strong>å·¥ä½œæ–¹å¼</strong>ï¼š<code>select</code> ä½¿ç”¨ä¸€ä¸ªå›ºå®šå¤§å°çš„ä½å›¾ï¼ˆbitmapï¼‰ï¼Œæ ‡è®°å“ªäº›æ–‡ä»¶æè¿°ç¬¦éœ€è¦æ£€æŸ¥ã€‚ç¨‹åºé€šè¿‡ <code>select()</code> ç³»ç»Ÿè°ƒç”¨æ¥ç›‘è§†è¿™äº›æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å˜åŒ–ï¼ˆå¦‚æ˜¯å¦å¯è¯»ã€æ˜¯å¦å¯å†™ï¼‰ã€‚</p>
</li>
<li>
<p><strong>é˜»å¡/éé˜»å¡</strong>ï¼š<code>select</code> å¯ä»¥è®¾ç½®ä¸ºé˜»å¡æ¨¡å¼ï¼ˆä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰æ•°æ®å¯ç”¨ï¼‰æˆ–éé˜»å¡æ¨¡å¼ï¼ˆå³ä¸é˜»å¡ï¼Œç«‹å³è¿”å›ï¼‰ã€‚</p>
</li>
<li>
<p><strong>æ–‡ä»¶æè¿°ç¬¦ä¸Šé™</strong>ï¼š<code>select</code> åœ¨æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œéƒ½éœ€è¦ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚ç”±äºå®ƒä½¿ç”¨ä¸€ä¸ªä½å›¾æ¥è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤å…¶æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å—åˆ°æ“ä½œç³»ç»Ÿçš„é™åˆ¶ï¼Œé€šå¸¸ä¸º 1024ï¼ˆå¯ä»¥é€šè¿‡ä¿®æ”¹ç³»ç»Ÿé…ç½®å¢å¤§ï¼Œä½†é€šå¸¸ä»æœ‰é™åˆ¶ï¼‰ã€‚</p>
</li>
<li>
<p>é€‚ç”¨äºå°è§„æ¨¡çš„æ–‡ä»¶æè¿°ç¬¦ç®¡ç†ï¼Œå®¹æ˜“å®ç°ï¼Œä½†ç”±äºå®ƒä½¿ç”¨ä½å›¾ï¼Œæ–‡ä»¶æè¿°ç¬¦æ•°ç›®è¿‡å¤šæ—¶ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>
</li>
<li>
<p>ç”±äºæ¯æ¬¡éƒ½éœ€è¦éå†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒçš„æ€§èƒ½åœ¨å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶å¯èƒ½éå¸¸ä½æ•ˆã€‚</p>
</li>
</ul>
<p><code>poll</code></p>
<p>é“¾è¡¨+è½®è¯¢ ç›‘æ§ æ–‡ä»¶æè¿°ç¬¦ é›†åˆ</p>
<p><code>poll</code> æ˜¯å¯¹ <code>select</code> çš„æ”¹è¿›ï¼Œè§£å†³äº† <code>select</code> å­˜åœ¨çš„ä¸€äº›ç¼ºç‚¹ï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šé™å’Œçµæ´»æ€§æ–¹é¢ã€‚</p>
<ul>
<li>
<p><strong>å·¥ä½œæ–¹å¼</strong>ï¼š<code>poll</code> ä¹Ÿç”¨æ¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯å®ƒä¸åƒ <code>select</code> ä½¿ç”¨ä½å›¾ï¼Œè€Œæ˜¯ä½¿ç”¨é“¾è¡¨ï¼ˆæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸€ä¸ª <code>pollfd</code> ç»“æ„ä½“ï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ åŒ…å«æ–‡ä»¶æè¿°ç¬¦å’Œè¯¥æè¿°ç¬¦çš„çŠ¶æ€ä¿¡æ¯ï¼ˆå¦‚æ˜¯å¦å¯è¯»ã€æ˜¯å¦å¯å†™ç­‰ï¼‰ã€‚</p>
</li>
<li>
<p><strong>æ²¡æœ‰ä¸Šé™é™åˆ¶</strong>ï¼šä¸ <code>select</code> çš„ 1024 æ–‡ä»¶æè¿°ç¬¦çš„é™åˆ¶ä¸åŒï¼Œ<code>poll</code> çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç›®ä¸å—å›ºå®šä¸Šé™çš„é™åˆ¶ï¼Œå®é™…ä¸Šåªå—ç³»ç»Ÿå†…å­˜é™åˆ¶ã€‚</p>
</li>
<li>
<p><strong>æ€§èƒ½é—®é¢˜</strong>ï¼šè™½ç„¶ <code>poll</code> æé«˜äº†çµæ´»æ€§ï¼Œè§£å†³äº†æ–‡ä»¶æè¿°ç¬¦ä¸Šé™çš„é—®é¢˜ï¼Œä½†å®ƒä»ç„¶éœ€è¦éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œæ€§èƒ½åœ¨å¤§è§„æ¨¡åº”ç”¨æ—¶ä¾ç„¶è¾ƒå·®ã€‚</p>
</li>
<li>
<p>ç›¸å¯¹äº <code>select</code>ï¼Œ<code>poll</code> æ›´åŠ çµæ´»ï¼Œæ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡é™åˆ¶ï¼Œä½†ä»ç„¶æ˜¯çº¿æ€§æ‰«æçš„æ–¹å¼ï¼Œæ€§èƒ½åœ¨å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶ä¾ç„¶ä¸ä½³ã€‚</p>
</li>
</ul>
<p><code>epoll</code></p>
<p>é“¾è¡¨+äº‹ä»¶å›è°ƒ ç›‘æ§ æ–‡ä»¶æè¿°ç¬¦ é›†åˆ</p>
<p><code>epoll</code> æ˜¯ Linux ä¸‹ç‰¹æœ‰çš„ä¸€ç§é«˜æ•ˆçš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå®ƒæ¯” <code>select</code> å’Œ <code>poll</code> åœ¨å¤„ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶å…·æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚</p>
<ul>
<li>
<p><strong>å·¥ä½œæ–¹å¼</strong>ï¼š<code>epoll</code> æä¾›äº†ä¸€ç§äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œæ³¨å†Œæ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº‹ä»¶æ—¶ï¼Œ<code>epoll</code> é€šè¿‡å›è°ƒå‡½æ•°é€šçŸ¥åº”ç”¨ç¨‹åºã€‚è¿™ä½¿å¾—å®ƒé¿å…äº†æ¯æ¬¡éƒ½éœ€è¦éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„ä½æ•ˆé—®é¢˜ã€‚</p>
</li>
<li>
<p><strong>äº‹ä»¶é©±åŠ¨</strong>ï¼š<code>epoll</code> ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œåªå…³å¿ƒå‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå†…æ ¸ä¼šå°†æ–‡ä»¶æè¿°ç¬¦åŠ å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ <code>epoll_wait</code> å‡½æ•°è·å–æ‰€æœ‰å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…äº†åƒ <code>select</code> å’Œ <code>poll</code> ä¸€æ ·æ¯æ¬¡éƒ½éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
</li>
<li>
<p><strong>æ€§èƒ½</strong>ï¼š<code>epoll</code> åœ¨å¤„ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶å…·æœ‰æ˜¾è‘—çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå› ä¸ºå®ƒé‡‡ç”¨äº†åŸºäºå†…å­˜çš„äº‹ä»¶å›è°ƒæœºåˆ¶ï¼Œå¯ä»¥æ›´é«˜æ•ˆåœ°é€šçŸ¥åº”ç”¨ç¨‹åºå“ªäº›æ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œã€‚</p>
</li>
<li>
<p><strong>æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼ˆEdge Triggeredï¼‰å’Œæ°´å¹³è§¦å‘ï¼ˆLevel Triggeredï¼‰</strong>ï¼š<code>epoll</code> æä¾›äº†ä¸¤ç§è§¦å‘æ¨¡å¼ï¼Œè¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘ï¼Œæä¾›æ›´å¤šçš„çµæ´»æ€§å’Œæ§åˆ¶ã€‚</p>
</li>
<li>
<p><code>epoll</code> æ˜¯åœ¨å¤„ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œæ€§èƒ½æœ€ä¼˜çš„ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ã€‚å®ƒåŸºäºäº‹ä»¶é©±åŠ¨ï¼Œé¿å…äº†æ¯æ¬¡éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„ä½æ•ˆæ“ä½œï¼Œå¹¶æä¾›äº†é«˜æ•ˆçš„é€šçŸ¥æœºåˆ¶ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Computer Network</category>
      </categories>
      <tags>
        <tag>udp, tcp, http</tag>
      </tags>
  </entry>
  <entry>
    <title>Machine-Learning</title>
    <url>/2025/04/22/Machine-Learning/</url>
    <content><![CDATA[<p>Machine Learning</p>
<p>æ–½å·¥ä¸­â€¦</p>
<span id="more"></span>
<h1>Machine-Learning</h1>
<p>ref: <a href="https://ailearning.apachecn.org/">https://ailearning.apachecn.org/</a></p>
<p>ref: <a href="https://developers.google.com/machine-learning">https://developers.google.com/machine-learning</a></p>
<h2 id="æœºå™¨å­¦ä¹ åŸºæœ¬æ¦‚å¿µ">æœºå™¨å­¦ä¹ åŸºæœ¬æ¦‚å¿µ</h2>
<h3 id="ç›‘ç£å­¦ä¹ ">ç›‘ç£å­¦ä¹ </h3>
<p><strong>åˆ†ç±»ç®—æ³•ï¼ˆClassification Algorithmsï¼‰</strong></p>
<ul>
<li><strong>ä»»åŠ¡ç›®æ ‡</strong>ï¼šé¢„æµ‹ä¸€ä¸ª<strong>ç¦»æ•£çš„ç±»åˆ«æ ‡ç­¾</strong>ï¼ˆå¦‚æ˜¯å¦æ‚£ç—…ã€é‚®ä»¶æ˜¯å¦æ˜¯åƒåœ¾é‚®ä»¶ï¼‰</li>
<li><strong>å¸¸è§ç®—æ³•åŒ…æ‹¬</strong>ï¼š
<ul>
<li>é€»è¾‘å›å½’ï¼ˆLogistic Regressionï¼‰</li>
<li>Kè¿‘é‚»ï¼ˆK-Nearest Neighborsï¼‰</li>
<li>å†³ç­–æ ‘ï¼ˆDecision Treeï¼‰</li>
<li>éšæœºæ£®æ—ï¼ˆRandom Forestï¼‰</li>
<li>æ”¯æŒå‘é‡æœºï¼ˆSVMï¼‰</li>
<li>æ¢¯åº¦æå‡æ ‘ï¼ˆXGBoost, LightGBMï¼‰</li>
<li>ç¥ç»ç½‘ç»œï¼ˆç”¨äºå›¾åƒåˆ†ç±»ã€æ–‡æœ¬åˆ†ç±»ç­‰ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>å›å½’ç®—æ³•ï¼ˆRegression Algorithmsï¼‰</strong></p>
<ul>
<li><strong>ä»»åŠ¡ç›®æ ‡</strong>ï¼šé¢„æµ‹ä¸€ä¸ª<strong>è¿ç»­å€¼</strong>ï¼ˆå¦‚æˆ¿ä»·ã€è‚¡ç¥¨ä»·æ ¼ã€æ¸©åº¦ï¼‰</li>
<li><strong>å¸¸è§ç®—æ³•åŒ…æ‹¬</strong>ï¼š
<ul>
<li>çº¿æ€§å›å½’ï¼ˆLinear Regressionï¼‰</li>
<li>å²­å›å½’ / å¥—ç´¢å›å½’ï¼ˆRidge / Lassoï¼‰</li>
<li>å†³ç­–æ ‘å›å½’ï¼ˆDecision Tree Regressionï¼‰</li>
<li>éšæœºæ£®æ—å›å½’ï¼ˆRandom Forest Regressorï¼‰</li>
<li>æ”¯æŒå‘é‡å›å½’ï¼ˆSVRï¼‰</li>
<li>ç¥ç»ç½‘ç»œï¼ˆç”¨äºéçº¿æ€§å›å½’ä»»åŠ¡ï¼‰</li>
</ul>
</li>
</ul>
<br>
<h3 id="éç›‘ç£å­¦ä¹ ">éç›‘ç£å­¦ä¹ </h3>
<ul>
<li>
<p>æ— æ ‡ç­¾æ•°æ®ï¼Œç›®æ ‡æ˜¯å‘ç°æ•°æ®çš„ç»“æ„ã€è§„å¾‹ã€åˆ†å¸ƒ</p>
</li>
<li>
<p><strong>å¸¸è§ç®—æ³•åŒ…æ‹¬</strong>ï¼š</p>
<p><strong>èšç±»ï¼ˆClusteringï¼‰</strong></p>
<ul>
<li>K-Means, DBSCAN, å±‚æ¬¡èšç±»</li>
<li>ä¾‹å­ï¼šå®¢æˆ·ç”»åƒã€æ–‡æ¡£èšç±»</li>
</ul>
<p><strong>é™ç»´ï¼ˆDimensionality Reductionï¼‰</strong></p>
<ul>
<li>PCA, t-SNE, UMAP</li>
<li>ä¾‹å­ï¼šå¯è§†åŒ–é«˜ç»´æ•°æ®ã€æ•°æ®å‹ç¼©</li>
</ul>
<p><strong>å¼‚å¸¸æ£€æµ‹ï¼ˆAnomaly Detectionï¼‰</strong></p>
<ul>
<li>Isolation Forest, ä¸€ç±»SVM</li>
<li>ä¾‹å­ï¼šä¿¡ç”¨å¡æ¬ºè¯ˆæ£€æµ‹ã€å·¥ä¸šè®¾å¤‡æ•…éšœ</li>
</ul>
</li>
</ul>
<br>
<h3 id="å¼ºåŒ–å­¦ä¹ ">å¼ºåŒ–å­¦ä¹ </h3>
<p>Q-Learning, SARSAï¼ˆåŸºäºå€¼ï¼‰</p>
<p>Policy Gradient, Actor-Criticï¼ˆåŸºäºç­–ç•¥ï¼‰</p>
<br>
<h3 id="è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•é›†">è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•é›†</h3>
<br>
<h3 id="è¿‡æ‹Ÿåˆä¸æ¬ æ‹Ÿåˆ">è¿‡æ‹Ÿåˆä¸æ¬ æ‹Ÿåˆ</h3>
<br>
<h3 id="æ¨¡å‹è¯„ä¼°æŒ‡æ ‡">æ¨¡å‹è¯„ä¼°æŒ‡æ ‡</h3>
<p>ç²¾åº¦ã€å¬å›ç‡ã€F1ã€AUCç­‰</p>
<br>
<br>
<h2 id="å¸¸ç”¨ç®—æ³•">å¸¸ç”¨ç®—æ³•</h2>
<h3 id="ç›‘ç£å­¦ä¹ -2">ç›‘ç£å­¦ä¹ </h3>
<h4 id="çº¿æ€§å›å½’">çº¿æ€§å›å½’</h4>
<p><strong>å›å½’</strong></p>
<p>é€šè¿‡ ï¼ˆFeatureï¼ŒLabelï¼‰è®­ç»ƒå‡½æ•°ï¼Œé€šè¿‡ç‰¹å¾è¾“å…¥é¢„æµ‹æ ‡ç­¾</p>
<p>ä¸€èˆ¬çš„ï¼Œçº¿æ€§å›å½’æ¨¡å‹çš„æ–¹ç¨‹ä¸º<br>
$$<br>
yâ€™ = b + w_1x_1<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li>yâ€² æ˜¯é¢„æµ‹çš„æ ‡ç­¾ï¼Œå³è¾“å‡ºã€‚</li>
<li>b æ˜¯æ¨¡å‹çš„åå·®ã€‚åå·®ä¸çº¿æ€§ä»£æ•°æ–¹ç¨‹ä¸­çš„ y æˆªè·çš„æ¦‚å¿µç›¸åŒã€‚åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œåå·®æœ‰æ—¶ç§°ä¸º w0ã€‚åå·®æ˜¯æ¨¡å‹çš„å‚æ•°ï¼Œåœ¨è®­ç»ƒæœŸé—´è®¡ç®—å¾—å‡ºã€‚</li>
<li>w1 æ˜¯ç‰¹å¾çš„æƒé‡ã€‚æƒé‡ä¸çº¿æ€§ä»£æ•°æ–¹ç¨‹ä¸­çš„æ–œç‡ m çš„æ¦‚å¿µç›¸åŒã€‚æƒé‡æ˜¯æ¨¡å‹çš„å‚æ•°ï¼Œåœ¨è®­ç»ƒæœŸé—´è®¡ç®—å¾—å‡ºã€‚</li>
<li>x1 æ˜¯ç‰¹å¾ï¼Œå³è¾“å…¥ã€‚</li>
</ul>
<p>å¤šé¡¹å¼å›å½’æ¨¡å‹çš„æ–¹ç¨‹ä¸º<br>
$$<br>
yâ€™ = b + \sum_i w_i x_i<br>
$$<br>
ç¬¦å·å«ä¹‰ç›¸ä¼¼ã€‚</p>
<br>
<p>æŸå¤±å‡½æ•°é€‰æ‹©å¹³æ–¹æŸå¤±å‡½æ•°ï¼ˆä¹Ÿç§°ä¸º L2 æŸå¤±å‡½æ•°ï¼‰ï¼Œè¡¨ç¤ºä¸º<br>
$$<br>
Loss = \sum_{(x,y) \in D} (y - yâ€™)^2<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li>$(x,y) \in D$ æ˜¯åŒ…å«å¤šä¸ªæœ‰æ ‡ç­¾æ ·æœ¬çš„æ•°æ®é›†ï¼Œè¿™äº›æ ·æœ¬ä¸º $(x,y)$ å¯¹ã€‚</li>
</ul>
<p>ä¸€èˆ¬çš„ï¼Œæœ‰å››ç§ä¸»è¦çš„æŸå¤±å‡½æ•°ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">æŸå¤±ç±»å‹</th>
<th style="text-align:left">å®šä¹‰</th>
<th style="text-align:left">å…¬å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">L1 æŸå¤±</td>
<td style="text-align:left">é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´å·®å¼‚çš„ç»å¯¹å€¼çš„æ€»å’Œã€‚</td>
<td style="text-align:left">$\sum</td>
</tr>
<tr>
<td style="text-align:left">å¹³å‡ç»å¯¹è¯¯å·® (MAE)</td>
<td style="text-align:left">ä¸€ç»„ç¤ºä¾‹çš„ L1 æŸå¤±çš„å¹³å‡å€¼ã€‚</td>
<td style="text-align:left">$\frac{1}{N} \sum</td>
</tr>
<tr>
<td style="text-align:left">L2 æŸå¤±</td>
<td style="text-align:left">é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´çš„å¹³æ–¹å·®çš„æ€»å’Œã€‚</td>
<td style="text-align:left">$\sum(y âˆ’ yâ€™)^2$</td>
</tr>
<tr>
<td style="text-align:left">å‡æ–¹è¯¯å·® (MSE)</td>
<td style="text-align:left">ä¸€ç»„ç¤ºä¾‹çš„ L2 æŸå¤±çš„å¹³å‡å€¼ã€‚</td>
<td style="text-align:left">$\frac{1}{N} \sum(y âˆ’ yâ€™)^2$</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­ï¼Œ$y$ ä¸ºçœŸå®æ•°æ®ï¼ˆç›‘ç£å­¦ä¹ ä¸­çš„è®­ç»ƒé›†æ•°æ®ï¼‰ï¼Œ $yâ€™$ ä¸ºæ¨¡å‹é¢„æµ‹å€¼</p>
<p>L1 æŸå¤±å‡½æ•°å’Œ L2 æŸå¤±å‡½æ•°ï¼ˆæˆ– MAE å’Œ MSEï¼‰ä¹‹é—´çš„åŠŸèƒ½å·®å¼‚åœ¨äºå¹³æ–¹ã€‚å½“é¢„æµ‹å€¼ä¸æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚è¾ƒå¤§æ—¶ï¼Œå¹³æ–¹ä¼šä½¿æŸå¤±å˜å¾—æ›´å¤§ã€‚å½“å·®å¼‚å¾ˆå°ï¼ˆå°äº 1ï¼‰æ—¶ï¼Œå¹³æ–¹ä¼šä½¿æŸå¤±æ›´å°ã€‚</p>
<br>
<h4 id="é€»è¾‘å›å½’">é€»è¾‘å›å½’</h4>
<p><strong>åˆ†ç±»</strong></p>
<p>é€»è¾‘å›å½’çš„æ–¹ç¨‹ä¸º<br>
$$<br>
yâ€™ = \frac{1}{1 + e^{-z}}<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li><em>z</em> æ˜¯çº¿æ€§æ–¹ç¨‹çš„è¾“å‡º</li>
</ul>
<p>é€»è¾‘å›å½’æ¨¡å‹çš„çº¿æ€§ç»„ä»¶è¡¨ç¤ºä¸ºï¼š<br>
$$<br>
z = b + \sum_i w_i x_i<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li><em>z</em> æ˜¯çº¿æ€§æ–¹ç¨‹çš„è¾“å‡ºï¼ˆä¹Ÿç§°ä¸º å¯¹æ•°å‡ ç‡ã€‚</li>
<li><em>b</em> æ˜¯åå·®ã€‚</li>
<li>w çš„å€¼æ˜¯æ¨¡å‹å­¦ä¹ çš„æƒé‡ã€‚</li>
<li>x çš„å€¼æ˜¯ç‰¹å®šæ ·æœ¬çš„ç‰¹å¾å€¼ã€‚</li>
</ul>
<br>
<p>é€»è¾‘å›å½’çš„æŸå¤±å‡½æ•°æ˜¯ å¯¹æ•°æŸå¤±å‡½æ•°ã€‚é€šè¿‡ å¯¹æ•°æŸå¤±æ–¹ç¨‹å¼ä¼šè¿”å›å˜åŒ–å¹…åº¦çš„å¯¹æ•°ï¼Œ è€Œä¸åªæ˜¯ä»æ•°æ®åˆ°é¢„æµ‹çš„è·ç¦»ã€‚å¯¹æ•°æŸå¤±çš„è®¡ç®—å…¬å¼ä¸º å¦‚ä¸‹ï¼š<br>
$$<br>
Loss = \sum_{(x,y) \in D} -y\log(yâ€™) - (1-y)\log(1-yâ€™)<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li>$(x,y) \in D$ æ˜¯åŒ…å«å¤šä¸ªæœ‰æ ‡ç­¾æ ·æœ¬çš„æ•°æ®é›†ï¼Œè¿™äº›æ ·æœ¬ä¸º $(x,y)$ å¯¹ã€‚</li>
<li>$y$ æ˜¯æœ‰æ ‡ç­¾æ ·æœ¬ä¸­çš„æ ‡ç­¾ã€‚ç”±äºè¿™æ˜¯é€»è¾‘å›å½’ï¼Œ $y$ çš„æ¯ä¸ªå€¼éƒ½å¿…é¡»ä¸º 0 æˆ– 1ã€‚</li>
<li>$yâ€²$ æ˜¯æ¨¡å‹çš„é¢„æµ‹ç»“æœï¼ˆä»‹äº 0 å’Œ 1 ä¹‹é—´ï¼‰ï¼Œç»™å®šé›†åˆ $x$ ä¸­çš„åŠŸèƒ½ã€‚</li>
</ul>
<br>
<p>è¡¥å……</p>
<hr>
<p><strong>é€»è¾‘å›å½’æ¨¡å‹çš„æœ¬è´¨</strong>å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p>
<p>é€»è¾‘å›å½’å‡è®¾çš„æ˜¯å› å˜é‡çš„â€œå¯¹æ•°å‡ ç‡ï¼ˆlog oddsï¼‰â€ä¸è‡ªå˜é‡ä¹‹é—´å­˜åœ¨çº¿æ€§å…³ç³»ã€‚</p>
<hr>
<p><strong>é€»è¾‘å›å½’è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p>
<p>é€»è¾‘å›å½’ä¸»è¦ç”¨äº<strong>åˆ†ç±»é—®é¢˜</strong>ï¼Œç‰¹åˆ«æ˜¯<strong>äºŒåˆ†ç±»é—®é¢˜</strong>ï¼Œæ¯”å¦‚é¢„æµ‹æŸäººæ˜¯å¦æ‚£ç—…ã€æŸå°é‚®ä»¶æ˜¯å¦æ˜¯åƒåœ¾é‚®ä»¶ç­‰ã€‚</p>
<ul>
<li>å› å˜é‡ $y$ åªèƒ½å–ä¸¤ä¸ªå€¼ï¼Œé€šå¸¸è®¾ä¸º 0 å’Œ 1ã€‚</li>
<li>è¾“å…¥çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå˜é‡ï¼ˆç‰¹å¾ï¼‰ $x_1, x_2, \dots, x_n$ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¸Œæœ›å»ºä¸€ä¸ªæ¨¡å‹ï¼Œè¾“å‡ºï¼š</p>
<p>$P(y = 1 \mid \mathbf{x})$</p>
<p>ä¹Ÿå°±æ˜¯ï¼Œç»™å®šè‡ªå˜é‡ $\mathbf{x}$ï¼Œé¢„æµ‹ $y = 1$ çš„æ¦‚ç‡ã€‚</p>
<hr>
<p><strong>ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨çº¿æ€§æ¨¡å‹ï¼Ÿ</strong></p>
<p>æœ€åˆçš„æƒ³æ³•å¯èƒ½æ˜¯ç”¨çº¿æ€§å›å½’ï¼š</p>
<p>$P(y = 1 \mid \mathbf{x}) = \beta_0 + \beta_1 x_1 + \dots + \beta_n x_n$</p>
<p><strong>ä½†è¿™ä¸åˆç†</strong>ï¼Œå› ä¸ºï¼š</p>
<ul>
<li>æ¦‚ç‡å€¼å¿…é¡»åœ¨ $[0,1]$ åŒºé—´ï¼›</li>
<li>è€Œçº¿æ€§å‡½æ•°çš„å€¼å¯ä»¥ä»»æ„å¤§æˆ–ä»»æ„å°ã€‚</li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§å˜æ¢ï¼Œæ—¢èƒ½å¤„ç†çº¿æ€§ç»„åˆï¼Œåˆèƒ½ä¿è¯è¾“å‡ºè½åœ¨ $[0,1]$ åŒºé—´ã€‚</p>
<p><strong>å¼•å…¥å‡ ç‡ï¼ˆOddsï¼‰å’Œå¯¹æ•°å‡ ç‡ï¼ˆLog Oddsï¼‰</strong></p>
<ul>
<li>
<p>å‡ ç‡å®šä¹‰ä¸ºï¼š</p>
<p>$\text{Odds} = \frac{P(y=1)}{P(y=0)} = \frac{p}{1-p}$</p>
</li>
<li>
<p>å¯¹æ•°å‡ ç‡ï¼ˆlog oddsï¼‰ï¼š</p>
<p>$\log\left(\frac{p}{1-p}\right)$</p>
</li>
</ul>
<p>å¯¹æ•°å‡ ç‡æ˜¯ä»æ¦‚ç‡ç©ºé—´æ˜ å°„åˆ° $(-\infty, +\infty)$ï¼Œé€‚åˆåšçº¿æ€§å»ºæ¨¡ã€‚</p>
<p><strong>é€»è¾‘å›å½’æ¨¡å‹çš„æ ¸å¿ƒå‡è®¾</strong></p>
<p>é€»è¾‘å›å½’çš„æ ¸å¿ƒå‡è®¾æ˜¯ï¼š</p>
<p>$\log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 x_1 + \dots + \beta_n x_n$</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<blockquote>
<p><strong>è‡ªå˜é‡çš„çº¿æ€§ç»„åˆå½±å“çš„æ˜¯â€œå¯¹æ•°å‡ ç‡â€ï¼Œè€Œä¸æ˜¯æ¦‚ç‡æœ¬èº«ã€‚</strong></p>
</blockquote>
<p><strong>é€šè¿‡å˜æ¢å¾—åˆ° Sigmoid å‡½æ•°ï¼ˆé€»è¾‘å‡½æ•°ï¼‰</strong></p>
<p>ä»ä¸Šé¢çš„ç­‰å¼å‡ºå‘ï¼Œè§£å‡º $p$ï¼ˆå³ $P(y=1)$ï¼‰ï¼š</p>
<p>$$\frac{p}{1-p} = e^{\beta_0 + \beta_1 x_1 + \dots + \beta_n x_n} \Rightarrow p = \frac{1}{1 + e^{-(\beta_0 + \beta_1 x_1 + \dots + \beta_n x_n)}}$$</p>
<p>è¿™ä¸ªå½¢å¼å°±æ˜¯è‘—åçš„ <strong>Sigmoid å‡½æ•°</strong>ï¼š</p>
<p>$p = \sigma(z) = \frac{1}{1 + e^{-z}}, \quad z = \beta_0 + \beta_1 x_1 + \dots + \beta_n x_n$</p>
<p>é€»è¾‘å›å½’ä¸æ˜¯å¯¹â€œæ¦‚ç‡â€å»ºæ¨¡ï¼Œè€Œæ˜¯å¯¹â€œå¯¹æ•°å‡ ç‡â€å»ºæ¨¡ã€‚</p>
<ul>
<li>
<p><strong>æœ¬è´¨å‡è®¾ï¼š</strong></p>
<p>$\log\left(\frac{p}{1-p}\right) = \text{çº¿æ€§å‡½æ•°}$</p>
</li>
<li>
<p>è¿™æ ·åšçš„å¥½å¤„ï¼š</p>
<ul>
<li>ä¿è¯æ¦‚ç‡å€¼åœ¨ $[0,1]$</li>
<li>æ¨¡å‹ä¿æŒçº¿æ€§æ¨¡å‹çš„ä¼˜é›…ï¼ˆä¾¿äºè§£é‡Šã€è®­ç»ƒï¼‰</li>
</ul>
</li>
</ul>
<br>
<h4 id="Kè¿‘é‚»">Kè¿‘é‚»</h4>
<p><strong>åˆ†ç±»</strong></p>
<p>k è¿‘é‚»ç®—æ³•çš„è¾“å…¥ä¸ºå®ä¾‹çš„ç‰¹å¾å‘é‡ï¼Œå¯¹åº”äºç‰¹å¾ç©ºé—´çš„ç‚¹ï¼›è¾“å‡ºä¸ºå®ä¾‹çš„ç±»åˆ«ï¼Œå¯ä»¥å–å¤šç±»ã€‚</p>
<p>k è¿‘é‚»ç®—æ³•å‡è®¾ç»™å®šä¸€ä¸ªè®­ç»ƒæ•°æ®é›†ï¼Œå…¶ä¸­çš„å®ä¾‹ç±»åˆ«å·²å®šã€‚åˆ†ç±»æ—¶ï¼Œå¯¹æ–°çš„å®ä¾‹ï¼Œæ ¹æ®å…¶ k ä¸ªæœ€è¿‘é‚»çš„è®­ç»ƒå®ä¾‹çš„ç±»åˆ«ï¼Œé€šè¿‡å¤šæ•°è¡¨å†³ç­‰æ–¹å¼è¿›è¡Œé¢„æµ‹ã€‚å› æ­¤ï¼Œkè¿‘é‚»ç®—æ³•ä¸å…·æœ‰æ˜¾å¼çš„å­¦ä¹ è¿‡ç¨‹ã€‚</p>
<img src="/2025/04/22/Machine-Learning/knn-1-movie.png" class="" title="ç”µå½±è§†é¢‘æ¡ˆä¾‹">
<p>æµç¨‹ï¼š</p>
<ol>
<li>å‡è®¾æœ‰ä¸€ä¸ªå¸¦æœ‰æ ‡ç­¾çš„æ ·æœ¬æ•°æ®é›†ï¼ˆè®­ç»ƒæ ·æœ¬é›†ï¼‰ï¼Œå…¶ä¸­åŒ…å«æ¯æ¡æ•°æ®ä¸æ‰€å±åˆ†ç±»çš„å¯¹åº”å…³ç³»ã€‚</li>
<li>è¾“å…¥æ²¡æœ‰æ ‡ç­¾çš„æ–°æ•°æ®åï¼Œå°†æ–°æ•°æ®çš„æ¯ä¸ªç‰¹å¾ä¸æ ·æœ¬é›†ä¸­æ•°æ®å¯¹åº”çš„ç‰¹å¾è¿›è¡Œæ¯”è¾ƒã€‚
<ol>
<li>è®¡ç®—æ–°æ•°æ®ä¸æ ·æœ¬æ•°æ®é›†ä¸­æ¯æ¡æ•°æ®çš„è·ç¦»ã€‚</li>
<li>å¯¹æ±‚å¾—çš„æ‰€æœ‰è·ç¦»è¿›è¡Œæ’åºï¼ˆä»å°åˆ°å¤§ï¼Œè¶Šå°è¡¨ç¤ºè¶Šç›¸ä¼¼ï¼‰ã€‚</li>
<li>å–å‰ k ï¼ˆk ä¸€èˆ¬å°äºç­‰äº 20 ï¼‰ä¸ªæ ·æœ¬æ•°æ®å¯¹åº”çš„åˆ†ç±»æ ‡ç­¾ã€‚</li>
</ol>
</li>
<li>æ±‚ k ä¸ªæ•°æ®ä¸­å‡ºç°æ¬¡æ•°æœ€å¤šçš„åˆ†ç±»æ ‡ç­¾ä½œä¸ºæ–°æ•°æ®çš„åˆ†ç±»ã€‚</li>
</ol>
<br>
<h4 id="å†³ç­–æ ‘">å†³ç­–æ ‘</h4>
<p><strong>åˆ†ç±»æˆ–å›å½’</strong></p>
<p>å†³ç­–æ ‘æ¨¡å‹å‘ˆæ ‘å½¢ç»“æ„ï¼Œåœ¨åˆ†ç±»é—®é¢˜ä¸­ï¼Œè¡¨ç¤ºåŸºäºç‰¹å¾å¯¹å®ä¾‹è¿›è¡Œåˆ†ç±»çš„è¿‡ç¨‹ã€‚å®ƒå¯ä»¥è®¤ä¸ºæ˜¯ if-then è§„åˆ™çš„é›†åˆï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯å®šä¹‰åœ¨ç‰¹å¾ç©ºé—´ä¸ç±»ç©ºé—´ä¸Šçš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒã€‚<br>
å†³ç­–æ ‘å­¦ä¹ é€šå¸¸åŒ…æ‹¬ 3 ä¸ªæ­¥éª¤: ç‰¹å¾é€‰æ‹©ã€å†³ç­–æ ‘çš„ç”Ÿæˆå’Œå†³ç­–æ ‘çš„ä¿®å‰ªã€‚</p>
<p>æµç¨‹ï¼š</p>
<p>def createBranch():<br>
æ£€æµ‹æ•°æ®é›†ä¸­çš„æ‰€æœ‰æ•°æ®çš„åˆ†ç±»æ ‡ç­¾æ˜¯å¦ç›¸åŒ:<br>
If so return ç±»æ ‡ç­¾<br>
Else:<br>
å¯»æ‰¾åˆ’åˆ†æ•°æ®é›†çš„æœ€å¥½ç‰¹å¾ï¼ˆåˆ’åˆ†ä¹‹åä¿¡æ¯ç†µæœ€å°ï¼Œä¹Ÿå°±æ˜¯ä¿¡æ¯å¢ç›Šæœ€å¤§çš„ç‰¹å¾ï¼‰<br>
åˆ’åˆ†æ•°æ®é›†<br>
åˆ›å»ºåˆ†æ”¯èŠ‚ç‚¹<br>
for æ¯ä¸ªåˆ’åˆ†çš„å­é›†<br>
è°ƒç”¨å‡½æ•° createBranch ï¼ˆåˆ›å»ºåˆ†æ”¯çš„å‡½æ•°ï¼‰å¹¶å¢åŠ è¿”å›ç»“æœåˆ°åˆ†æ”¯èŠ‚ç‚¹ä¸­<br>
return åˆ†æ”¯èŠ‚ç‚¹</p>
<br>
<h4 id="éšæœºæ£®æ—">éšæœºæ£®æ—</h4>
<p><strong>åˆ†ç±»</strong></p>
<p><strong>éšæœºæ£®æ—ï¼ˆRandom Forestï¼‰</strong> æ˜¯é›†æˆå­¦ä¹ æ–¹æ³•çš„ä¸€ç§ï¼Œå®ƒé€šè¿‡æ„å»ºå¤šä¸ªå†³ç­–æ ‘å¹¶è¿›è¡ŒæŠ•ç¥¨ï¼ˆåˆ†ç±»ï¼‰æˆ–å¹³å‡ï¼ˆå›å½’ï¼‰æ¥æå‡æ¨¡å‹çš„å‡†ç¡®ç‡ä¸é²æ£’æ€§ã€‚</p>
<br>
<h4 id="æ”¯æŒå‘é‡æœº">æ”¯æŒå‘é‡æœº</h4>
<p><strong>åˆ†ç±»</strong></p>
<p>æ”¯æŒå‘é‡æœºæ˜¯ä¸€ç§å¼ºå¤§çš„åˆ†ç±»å’Œå›å½’ç®—æ³•ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å¯»æ‰¾ä¸€ä¸ªæœ€ä¼˜çš„è¶…å¹³é¢ï¼Œå°†ä¸åŒç±»åˆ«çš„æ ·æœ¬æœ€å¤§é—´éš”åˆ†å¼€</strong>ã€‚</p>
<ul>
<li>å¯¹äºçº¿æ€§å¯åˆ†é—®é¢˜ï¼ŒSVM é€šè¿‡æœ€å¤§åŒ–è¾¹ç•Œé—´éš”å®ç°åˆ†ç±»ã€‚</li>
<li>å¯¹äºçº¿æ€§ä¸å¯åˆ†é—®é¢˜ï¼ŒSVM ä½¿ç”¨æ ¸å‡½æ•°ï¼ˆå¦‚ RBFã€Polynomialï¼‰å°†æ•°æ®æ˜ å°„åˆ°é«˜ç»´ç©ºé—´ï¼Œåœ¨é«˜ç»´ç©ºé—´ä¸­å®ç°çº¿æ€§å¯åˆ†ã€‚</li>
<li><strong>æ”¯æŒå‘é‡</strong> æ˜¯ä½äºåˆ†ç±»è¾¹ç•Œä¸Šçš„æ ·æœ¬ç‚¹ï¼Œå¯¹æ¨¡å‹çš„å†³ç­–èµ·å…³é”®ä½œç”¨ã€‚</li>
</ul>
<p>SVM çš„æŸå¤±å‡½æ•°é€šå¸¸æ˜¯<strong>åˆé¡µæŸå¤±ï¼ˆHinge Lossï¼‰</strong>ï¼Œå…¶å½¢å¼å¦‚ä¸‹ï¼š</p>
<p>$$<br>
Loss = \sum_{i=1}^N \max(0, 1 - y_i(w^T x_i + b))<br>
$$</p>
<p>å…¶ä¸­ $y_i$ ä¸ºçœŸå®æ ‡ç­¾ï¼ˆå–å€¼ä¸º Â±1ï¼‰ï¼Œ$x_i$ ä¸ºè¾“å…¥ç‰¹å¾ï¼Œ$w$ å’Œ $b$ ä¸ºæ¨¡å‹å‚æ•°ã€‚</p>
<br>
<h3 id="éç›‘ç£å­¦ä¹ -2">éç›‘ç£å­¦ä¹ </h3>
<h4 id="K-means-èšç±»">K-means èšç±»</h4>
<p><strong>èšç±»</strong></p>
<p>æµç¨‹</p>
<ul>
<li>åˆ›å»º k ä¸ªç‚¹ä½œä¸ºèµ·å§‹è´¨å¿ƒï¼ˆé€šå¸¸æ˜¯éšæœºé€‰æ‹©ï¼‰</li>
<li>å½“ä»»æ„ä¸€ä¸ªç‚¹çš„ç°‡åˆ†é…ç»“æœå‘ç”Ÿæ”¹å˜æ—¶ï¼ˆä¸æ”¹å˜æ—¶ç®—æ³•ç»“æŸï¼‰
<ul>
<li>å¯¹æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹
<ul>
<li>å¯¹æ¯ä¸ªè´¨å¿ƒ
<ul>
<li>è®¡ç®—è´¨å¿ƒä¸æ•°æ®ç‚¹ä¹‹é—´çš„è·ç¦»</li>
</ul>
</li>
<li>å°†æ•°æ®ç‚¹åˆ†é…åˆ°è·å…¶æœ€è¿‘çš„ç°‡</li>
</ul>
</li>
<li>å¯¹æ¯ä¸€ä¸ªç°‡, è®¡ç®—ç°‡ä¸­æ‰€æœ‰ç‚¹çš„å‡å€¼å¹¶å°†å‡å€¼ä½œä¸ºè´¨å¿ƒ</li>
</ul>
</li>
</ul>
<br>
<h4 id="SVD">SVD</h4>
<p><strong>é™ç»´</strong></p>
<p>å¥‡å¼‚å€¼åˆ†è§£</p>
<br>
<h4 id="PCA">PCA</h4>
<p><strong>é™ç»´</strong></p>
<p>æµç¨‹</p>
<ol>
<li>æ‰¾å‡ºç¬¬ä¸€ä¸ªä¸»æˆåˆ†çš„æ–¹å‘ï¼Œä¹Ÿå°±æ˜¯æ•°æ® <code>æ–¹å·®æœ€å¤§</code> çš„æ–¹å‘ã€‚</li>
<li>æ‰¾å‡ºç¬¬äºŒä¸ªä¸»æˆåˆ†çš„æ–¹å‘ï¼Œä¹Ÿå°±æ˜¯æ•°æ® <code>æ–¹å·®æ¬¡å¤§</code> çš„æ–¹å‘ï¼Œå¹¶ä¸”è¯¥æ–¹å‘ä¸ç¬¬ä¸€ä¸ªä¸»æˆåˆ†æ–¹å‘ <code>æ­£äº¤(orthogonal å¦‚æœæ˜¯äºŒç»´ç©ºé—´å°±å«å‚ç›´)</code>ã€‚</li>
<li>é€šè¿‡è¿™ç§æ–¹å¼è®¡ç®—å‡ºæ‰€æœ‰çš„ä¸»æˆåˆ†æ–¹å‘ã€‚</li>
<li>é€šè¿‡æ•°æ®é›†çš„åæ–¹å·®çŸ©é˜µåŠå…¶ç‰¹å¾å€¼åˆ†æï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°è¿™äº›ä¸»æˆåˆ†çš„å€¼ã€‚</li>
<li>ä¸€æ—¦å¾—åˆ°äº†åæ–¹å·®çŸ©é˜µçš„ç‰¹å¾å€¼å’Œç‰¹å¾å‘é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿ç•™æœ€å¤§çš„ N ä¸ªç‰¹å¾ã€‚è¿™äº›ç‰¹å¾å‘é‡ä¹Ÿç»™å‡ºäº† N ä¸ªæœ€é‡è¦ç‰¹å¾çš„çœŸå®ç»“æ„ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å°†æ•°æ®ä¹˜ä¸Šè¿™ N ä¸ªç‰¹å¾å‘é‡ ä»è€Œå°†å®ƒè½¬æ¢åˆ°æ–°çš„ç©ºé—´ä¸Šã€‚</li>
</ol>
<br>
<h4 id="Isolation-Forest">Isolation Forest</h4>
<br>
<h3 id="å…¶ä»–">å…¶ä»–</h3>
<p>è´å¶æ–¯åˆ†ç±»å™¨ï¼ˆæœ´ç´ è´å¶æ–¯ç­‰ï¼‰</p>
<br>
<p>å¼‚å¸¸æ£€æµ‹ï¼ˆIsolation Forest, One-Class SVMï¼‰</p>
<br>
]]></content>
      <categories>
        <category>Machine Learning</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Java</title>
    <url>/2025/01/17/Java/</url>
    <content><![CDATA[<p>Java&amp;related</p>
<span id="more"></span>
<h1>Java</h1>
<h2 id="å…³é”®å­—">å…³é”®å­—</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[è®¿é—®ä¿®é¥°ç¬¦] [éè®¿é—®ä¿®é¥°ç¬¦] æ•°æ®ç±»å‹ å˜é‡å [= åˆå§‹å€¼];</span><br><span class="line"></span><br><span class="line">[è®¿é—®ä¿®é¥°ç¬¦] [éè®¿é—®ä¿®é¥°ç¬¦] è¿”å›å€¼ç±»å‹ æ–¹æ³•å(å‚æ•°åˆ—è¡¨) [<span class="keyword">throws</span> å¼‚å¸¸åˆ—è¡¨] &#123;</span><br><span class="line">    <span class="comment">// æ–¹æ³•ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è®¿é—®ä¿®é¥°ç¬¦ (å¯é€‰):</strong></p>
<ul>
<li>publicï¼šä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®ã€‚</li>
<li>protectedï¼šåŒä¸€ä¸ªåŒ…å†…å’Œå­ç±»å¯ä»¥è®¿é—®ã€‚</li>
<li>privateï¼šåªæœ‰åŒä¸€ä¸ªç±»å†…å¯ä»¥è®¿é—®ã€‚</li>
<li>é»˜è®¤ (ä¸å†™)ï¼šåŒä¸€ä¸ªåŒ…å†…å¯ä»¥è®¿é—®ã€‚</li>
</ul>
<p><strong>éè®¿é—®ä¿®é¥°ç¬¦ (å¯é€‰):</strong></p>
<ul>
<li>staticï¼šé™æ€å˜é‡ï¼Œå±äºç±»æœ¬èº«ã€‚</li>
<li>finalï¼šå¸¸é‡ï¼Œå€¼ä¸€æ—¦åˆå§‹åŒ–åä¸å¯æ”¹å˜ã€‚</li>
<li>transientï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«åºåˆ—åŒ–çš„æ—¶å€™ï¼Œtransientå‹å˜é‡çš„å€¼ä¸åŒ…æ‹¬åœ¨åºåˆ—åŒ–çš„ç»“æœä¸­ã€‚</li>
<li>volatileï¼šä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å˜é‡çš„å¯è§æ€§ã€‚</li>
<li>nativeï¼š</li>
</ul>
<p><strong>abstract</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;  <span class="comment">// ä¸C++çš„å«è™šå‡½æ•°çš„ç±»ä¸€æ ·ï¼ŒJavaæŠ½è±¡ç±»ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="comment">// å®ä¾‹å˜é‡ï¼Œæœ‰é»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç±»å˜é‡ï¼Œæœ‰é»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CATEGORY</span> <span class="operator">=</span> <span class="string">&quot;Animal&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ½è±¡æ–¹æ³•  å«æŠ½è±¡æ–¹æ³•çš„ç±»å°±ä¸€å®šä¸èƒ½å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="comment">// åŒæ—¶ï¼ŒAbstract method in non-abstract class æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå³æŠ½è±¡æ–¹æ³•ä¸€å®šå¾—åœ¨æŠ½è±¡ç±»ä¸­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…·ä½“æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot; is eating.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, age); <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„éé»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Woof!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> superDog <span class="keyword">extends</span> <span class="title class_">Dog</span> <span class="keyword">implements</span> <span class="title class_">xxx</span>;  <span class="comment">// å¯ä»¥</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç›¸å¯¹äºç›´æ¥ç»§æ‰¿æ™®é€šç±»ï¼Œç»§æ‰¿æŠ½è±¡ç±»çš„ä¼˜ç‚¹åœ¨äºï¼Ÿ</p>
<p>1.å¯¹äºæ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»ï¼Œç»§æ‰¿æ™®é€šç±»æœ‰ä¸€æ ·çš„æ•ˆæœ</p>
<p>2.å¯¹äºé€šè¿‡ç»§æ‰¿æŠ½è±¡ç±»å®ç°çš„å¤šæ€ï¼Œç»§æ‰¿æ™®é€šç±»è¿›è¡Œoverrideæœ‰ä¸€æ ·çš„æ•ˆæœ</p>
<p><strong>æŠ½è±¡ç±»çš„çœŸæ­£ä¼˜åŠ¿åœ¨äºå¼ºåˆ¶å­ç±»å®ç°æŸäº›æŠ½è±¡çˆ¶ç±»æ–¹æ³•ï¼Œä»¥åŠé€šè¿‡æŠ½è±¡æ–¹æ³•å®šä¹‰ä¸€ç§å¥‘çº¦æˆ–è§„èŒƒã€‚</strong></p>
</blockquote>
<p><strong>static</strong></p>
<ul>
<li>
<p><strong>ç±»é™æ€å˜é‡</strong>ï¼š</p>
</li>
<li>
<p><strong>ç±»é™æ€æ–¹æ³•</strong>ï¼š</p>
</li>
<li>
<p><strong>é™æ€ä»£ç å—</strong>ï¼šé™æ€ä»£ç å—åœ¨ç±»åŠ è½½æ—¶æ‰§è¡Œï¼Œä»…æ‰§è¡Œä¸€æ¬¡ï¼Œå¤šç”¨äºåˆå§‹åŒ–é™æ€å˜é‡ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–èµ„æº</p>
</li>
<li>
<p><strong>é™æ€ç±»</strong>ï¼š</p>
<ul>
<li>
<p><strong>å£°æ˜ä½ç½®:</strong> é™æ€ç±»åªèƒ½åœ¨å¦ä¸€ä¸ªç±»çš„å†…éƒ¨è¿›è¡Œå£°æ˜ï¼Œä½¿ç”¨ static å…³é”®å­—ä¿®é¥°ã€‚</p>
</li>
<li>
<p><strong>ä¸å¤–éƒ¨ç±»çš„å…³ç³»:</strong></p>
<ul>
<li>é™æ€ç±»ä¸æŒæœ‰å¯¹å…¶å¤–éƒ¨ç±»å®ä¾‹çš„å¼•ç”¨ã€‚</li>
<li><strong>é™æ€ç±»çš„å®ä¾‹åŒ–ä¸éœ€è¦ä¾èµ–å¤–éƒ¨ç±»çš„å®ä¾‹ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ OuterClass.StaticNestedClass çš„æ–¹å¼åˆ›å»ºã€‚</strong></li>
</ul>
</li>
<li>
<p><strong>é™æ€å†…éƒ¨ç±»å¯ä»¥æœ‰éé™æ€çš„å˜é‡å’Œæ–¹æ³•</strong>ï¼šé™æ€å†…éƒ¨ç±»æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç±»ï¼Œå®ƒå¯ä»¥æ‹¥æœ‰å®ä¾‹å˜é‡å’Œå®ä¾‹æ–¹æ³•ã€‚è¦è®¿é—®è¿™äº›å®ä¾‹å˜é‡å’Œæ–¹æ³•ï¼Œå¿…é¡»åˆ›å»ºé™æ€å†…éƒ¨ç±»çš„å¯¹è±¡ã€‚</p>
<p><strong>é™æ€å†…éƒ¨ç±»å¯ä»¥æœ‰é™æ€çš„å˜é‡å’Œæ–¹æ³•</strong>ï¼šç”±äºé™æ€å†…éƒ¨ç±»æ˜¯é™æ€çš„ï¼Œå®ƒå¯ä»¥ç›´æ¥åŒ…å«é™æ€å˜é‡å’Œé™æ€æ–¹æ³•ã€‚è¿™äº›é™æ€æˆå‘˜å±äºé™æ€å†…éƒ¨ç±»æœ¬èº«ï¼Œè€Œä¸å±äºå…¶å¤–éƒ¨ç±»çš„å®ä¾‹ã€‚</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>å†…éƒ¨ç±»</strong></p>
<p><strong>å†…éƒ¨ç±»ä¸­ä¸èƒ½ä½¿ç”¨é™æ€çš„å˜é‡å’Œé™æ€çš„æ–¹æ³•ï¼</strong>ï¼ï¼</p>
<p>å†…éƒ¨ç±»çš„å®ä¾‹åŒ–æ˜¯ç”±å¤–éƒ¨ç±»å®ä¾‹åŒ–ä¹‹åæ‰åŠ è½½çš„ï¼Œå¦‚æœå¤–éƒ¨ç±»è¿˜æ²¡æœ‰å®ä¾‹åŒ–ï¼Œè¿™æ—¶å€™è°ƒç”¨å†…éƒ¨ç±»çš„é™æ€æˆå‘˜ï¼Œæ­¤æ—¶å†…éƒ¨ç±»è¿˜æ²¡æœ‰è¢«åŠ è½½ï¼Œå´è¦å¼€å§‹åˆ›å»ºé™æ€æˆå‘˜,æ˜¾ç¤ºæ˜¯ä¸åˆç†çš„,</p>
<p><strong>æ¥å£å¯ç»§æ‰¿æ¥å£</strong></p>
</blockquote>
<p><strong>å®ä¾‹åˆå§‹åŒ–å—ä¸æ„é€ å‡½æ•°</strong></p>
<ul>
<li><strong>å®ä¾‹åˆå§‹åŒ–å—</strong>ï¼š<br>
åœ¨æ¯æ¬¡åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œï¼Œä¸”åœ¨<strong>æ„é€ å‡½æ•°ä¹‹å‰</strong>æ‰§è¡Œã€‚æ— è®ºè°ƒç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œå®ä¾‹åˆå§‹åŒ–å—éƒ½ä¼šæ‰§è¡Œã€‚</li>
<li><strong>æ„é€ å‡½æ•°</strong>ï¼š<br>
åœ¨åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œï¼Œå…·ä½“æ‰§è¡Œå“ªä¸ªæ„é€ å‡½æ•°å–å†³äº<code>new</code>å…³é”®å­—åé¢è°ƒç”¨çš„æ„é€ å‡½æ•°ã€‚</li>
</ul>
<p><strong>å¸¸è§çš„å˜é‡åå‰ç¼€ï¼š</strong></p>
<ul>
<li><strong>mï¼š</strong> è¡¨ç¤º <strong>æˆå‘˜å˜é‡</strong> (member variable)ï¼Œå³ç±»çº§åˆ«çš„å˜é‡ï¼ŒåŒºåˆ«äºå±€éƒ¨å˜é‡ã€‚ä¾‹å¦‚ï¼šprivate int mCount;</li>
<li><strong>sï¼š</strong> è¡¨ç¤º <strong>é™æ€å˜é‡</strong> (static variable)ï¼Œå³å±äºç±»æœ¬èº«çš„å˜é‡ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«ã€‚ä¾‹å¦‚ï¼špublic static String sTag = â€œMyClassâ€;</li>
<li><strong>pï¼š</strong> è¡¨ç¤º <strong>å‚æ•°</strong> (parameter)ï¼Œå³æ–¹æ³•æˆ–æ„é€ å‡½æ•°çš„è¾“å…¥å‚æ•°ã€‚ä¾‹å¦‚ï¼špublic void setName(String pName) { â€¦ }</li>
<li><strong>gï¼š</strong> è¡¨ç¤º <strong>å…¨å±€å˜é‡</strong> (global variable)ï¼Œä¸€èˆ¬ç”¨äº C/C++ ä»£ç ä¸­ã€‚</li>
<li><strong>iï¼š</strong> è¡¨ç¤º <strong>æ¥å£</strong> (interface) æˆ– <strong>æŠ½è±¡ç±»</strong> (abstract class) çš„å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒActivityManagerProxy å®ç°äº† IActivityManager æ¥å£ã€‚</li>
<li><strong>lï¼š</strong> è¡¨ç¤º <strong>å±€éƒ¨å˜é‡</strong> (local variable)ï¼Œå³æ–¹æ³•æˆ–ä»£ç å—å†…éƒ¨å®šä¹‰çš„å˜é‡ã€‚</li>
<li><strong>thisï¼š</strong> è¡¨ç¤ºå½“å‰å¯¹è±¡çš„å¼•ç”¨ã€‚</li>
</ul>
<p><strong>å…¶ä»–çº¦å®šï¼š</strong></p>
<ul>
<li><strong>å¸¸é‡ (Constant)ï¼š</strong> é€šå¸¸ä½¿ç”¨å…¨éƒ¨å¤§å†™å­—æ¯ï¼Œå•è¯ä¹‹é—´ç”¨ä¸‹åˆ’çº¿åˆ†éš”ã€‚ä¾‹å¦‚ï¼špublic static final int MAX_COUNT = 100;</li>
<li><strong>å¸ƒå°”ç±»å‹ (boolean)ï¼š</strong> é€šå¸¸ä»¥ is æˆ– has å¼€å¤´ï¼Œä¾‹å¦‚ï¼šprivate boolean isRunning; æˆ– public boolean hasPermission();</li>
</ul>
<h2 id="String">String</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span> <span class="comment">// String ç±»è¢« final å…³é”®å­—ä¿®é¥°ï¼Œæ‰€ä»¥å®ƒä¸ä¼šæœ‰å­ç±»ï¼Œè¿™å°±æ„å‘³ç€æ²¡æœ‰å­ç±»å¯ä»¥é‡å†™å®ƒçš„æ–¹æ³•ï¼Œæ”¹å˜å®ƒçš„è¡Œä¸ºã€‚</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="meta">@Stable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span>[] value; <span class="comment">// String ç±»çš„æ•°æ®å­˜å‚¨åœ¨ char[] æ•°ç»„ä¸­ï¼Œè€Œè¿™ä¸ªæ•°ç»„ä¹Ÿè¢« final å…³é”®å­—ä¿®é¥°äº†ï¼Œè¿™å°±è¡¨ç¤º String å¯¹è±¡æ˜¯æ²¡æ³•è¢«ä¿®æ”¹çš„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span> coder;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å­—ç¬¦ä¸²å¸¸é‡æ± ä¸å­—ç¬¦ä¸²å¯¹è±¡</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;apple&quot;</span>; <span class="comment">// s æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„ &quot;apple&quot; çš„åœ°å€</span></span><br><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;banana&quot;</span>); <span class="comment">// s1 æŒ‡å‘å †å†…å­˜ä¸­çš„ String å¯¹è±¡ï¼Œè€Œå †å¯¹è±¡å†…éƒ¨çš„å­—ç¬¦å†…å®¹å¼•ç”¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„ &quot;banana&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> s1.intern(); </span><br><span class="line"><span class="comment">// intern() æ–¹æ³•ï¼šæ£€æŸ¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å·²å­˜åœ¨ä¸ s1 å­—ç¬¦å†…å®¹ç›¸åŒçš„å­—ç¬¦ä¸²ï¼š</span></span><br><span class="line"><span class="comment">// å¦‚æœå­˜åœ¨ï¼Œè¿”å›è¯¥å­—ç¬¦ä¸²çš„å¼•ç”¨åœ°å€ï¼ˆæŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„åœ°å€ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œå°† s1 çš„å­—ç¬¦å†…å®¹æ·»åŠ åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›è¯¥åœ°å€ã€‚</span></span><br></pre></td></tr></table></figure>
<p><strong><code>StringBuilder</code> å¯¹è±¡</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¼šåœ¨å †å†…å­˜ä¸­åˆ†é…ä¸€ä¸ª <code>StringBuilder</code> å¯¹è±¡ã€‚</li>
<li>è¯¥å¯¹è±¡å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªåˆå§‹å®¹é‡çš„ <code>char[] value</code> æ•°ç»„ï¼Œå¹¶å°† <code>&quot;hello&quot;</code> çš„å­—ç¬¦å†…å®¹å­˜å‚¨åˆ°è¿™ä¸ªæ•°ç»„ä¸­ï¼Œå­—ç¬¦ä¸² <code>&quot;hello&quot;</code> ä¼šæŒ‰ç…§å­—ç¬¦ä¸€ä¸ªä¸€ä¸ªåœ°å­˜å‚¨åˆ°æ•°ç»„ä¸­ã€‚</li>
<li>ç”±äº<code>StringBuilder</code>å†…éƒ¨é€šè¿‡  <code>char[] value</code>  æ•°ç»„é€ä¸ªå­—ç¬¦çš„ä¿å­˜åŸå§‹å­—ç¬¦ä¸²ï¼Œ<code>StringBuilder</code> ä¸ä¼šæŠŠå†…å®¹å­˜å‚¨åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚</li>
</ul>
<p><strong>è¿½åŠ å­—ç¬¦ä¸²</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sb.append(<span class="string">&quot; world&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>append()</code> æ–¹æ³•ä¼šç›´æ¥åœ¨å†…éƒ¨çš„ <code>char[] value</code> æ•°ç»„ä¸Šä¿®æ”¹ï¼Œæ•ˆç‡è¾ƒé«˜ã€‚</li>
<li>å¦‚æœè¿½åŠ åçš„å†…å®¹è¶…å‡ºäº†å½“å‰æ•°ç»„å®¹é‡ï¼Œ<code>StringBuilder</code> ä¼šåˆ†é…ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼ˆé€šå¸¸æ˜¯æ—§å®¹é‡çš„ä¸¤å€ï¼‰ï¼Œå¹¶å°†åŸæ¥çš„å†…å®¹æ‹·è´åˆ°æ–°æ•°ç»„ä¸­ã€‚</li>
</ul>
<h2 id="æšä¸¾">æšä¸¾</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Weekday</span> &#123;</span><br><span class="line">    SUN, MON, TUE, WED, THU, FRI, SAT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼˜ç‚¹</p>
<ul>
<li><code>enum</code>å¸¸é‡æœ¬èº«å¸¦æœ‰ç±»å‹ä¿¡æ¯ï¼Œå³<code>Weekday.SUN</code>ç±»å‹æ˜¯<code>Weekday</code>ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥å‡ºç±»å‹é”™è¯¯ã€‚</li>
<li>ä¸å¯èƒ½å¼•ç”¨åˆ°éæšä¸¾çš„å€¼ï¼Œå› ä¸ºæ— æ³•é€šè¿‡ç¼–è¯‘ã€‚</li>
<li>ä¸åŒç±»å‹çš„æšä¸¾ä¸èƒ½äº’ç›¸æ¯”è¾ƒæˆ–è€…èµ‹å€¼</li>
</ul>
<p>ç±»å‹æ¯”è¾ƒï¼Œè¦ä½¿ç”¨<code>equals()</code>æ–¹æ³•ï¼Œå¦‚æœä½¿ç”¨<code>==</code>æ¯”è¾ƒï¼Œå®ƒæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¼•ç”¨ç±»å‹çš„å˜é‡æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p><code>enum</code>ç±»å‹çš„<strong>æ¯ä¸ªæšä¸¾å€¼</strong>åœ¨JVMä¸­åªæœ‰ä¸€ä¸ªå”¯ä¸€å®ä¾‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨<code>==</code>æ¯”è¾ƒ</p>
<p><strong><code>enum</code>å®šä¹‰çš„ç±»å‹å°±æ˜¯<code>class</code>, æ¯ä¸ªæšä¸¾å€¼å‡ä¸ºè¯¥æšä¸¾ç±»å‹çš„å®ä¾‹ï¼ï¼ï¼</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Weekday</span> &#123;</span><br><span class="line">    MON(<span class="number">1</span>, <span class="string">&quot;æ˜ŸæœŸä¸€&quot;</span>), TUE(<span class="number">2</span>, <span class="string">&quot;æ˜ŸæœŸäºŒ&quot;</span>), WED(<span class="number">3</span>, <span class="string">&quot;æ˜ŸæœŸä¸‰&quot;</span>), THU(<span class="number">4</span>, <span class="string">&quot;æ˜ŸæœŸå››&quot;</span>), FRI(<span class="number">5</span>, <span class="string">&quot;æ˜ŸæœŸäº”&quot;</span>), SAT(<span class="number">6</span>, <span class="string">&quot;æ˜ŸæœŸå…­&quot;</span>), SUN(<span class="number">0</span>, <span class="string">&quot;æ˜ŸæœŸæ—¥&quot;</span>);</span><br><span class="line">    <span class="comment">// æšä¸¾å€¼åæ¥æ‹¬å· ç›¸å½“äº ä½¿ç”¨äº†æšä¸¾ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> dayValue;  <span class="comment">// å¯ä»¥éfinalï¼Œä¸æ¨è</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String chinese;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Weekday</span><span class="params">(<span class="type">int</span> dayValue, String chinese)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dayValue = dayValue;</span><br><span class="line">        <span class="built_in">this</span>.chinese = chinese;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  <span class="comment">// è¦†å†™toString</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.chinese;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>name()</p>
<p>è¿”å›å¸¸é‡åï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Weekday.SUN.name(); <span class="comment">// &quot;SUN&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹æšä¸¾å¸¸é‡è°ƒç”¨<code>toString()</code>ä¼šè¿”å›å’Œ<code>name()</code>ä¸€æ ·çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯ï¼Œ<code>toString()</code>å¯ä»¥è¢«è¦†å†™ï¼Œè€Œ<code>name()</code>åˆ™ä¸è¡Œã€‚</p>
</blockquote>
<p>ordinal()</p>
<p>è¿”å›å®šä¹‰çš„å¸¸é‡çš„é¡ºåºï¼Œä»0å¼€å§‹è®¡æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> Weekday.MON.ordinal(); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<h2 id="æ•°ç»„ï¼Œå­—ç¬¦ä¸²ï¼Œå®¹å™¨diff">æ•°ç»„ï¼Œå­—ç¬¦ä¸²ï¼Œå®¹å™¨diff</h2>
<p><strong>é•¿åº¦</strong></p>
<p><strong>æ•°ç»„</strong>æ˜¯ Java ä¸­çš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œä½¿ç”¨ <code>length</code> å±æ€§ã€‚</p>
<p><strong>å­—ç¬¦ä¸²</strong>æ˜¯ <code>String</code> ç±»çš„å¯¹è±¡ï¼Œä½¿ç”¨ <code>length()</code> æ–¹æ³•ã€‚</p>
<p><strong>å®¹å™¨</strong>ï¼ˆå¦‚ <code>List</code>ã€<code>Set</code>ã€<code>Map</code> ç­‰ï¼‰æ˜¯é›†åˆæ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œä½¿ç”¨ <code>size()</code> æ–¹æ³•ã€‚</p>
<p><strong>æ’åº</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ’åºåŸºæœ¬ç±»å‹æ•°ç»„</span></span><br><span class="line"><span class="type">int</span>[] intArray = &#123;<span class="number">5</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line">Arrays.sort(intArray);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’åºå¯¹è±¡æ•°ç»„</span></span><br><span class="line">String[] strArray = &#123;<span class="string">&quot;Banana&quot;</span>, <span class="string">&quot;Apple&quot;</span>, <span class="string">&quot;Cherry&quot;</span>&#125;;</span><br><span class="line">Arrays.sort(strArray);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ Collections.sort() æ’åº</span></span><br><span class="line">Collections.sort(list);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ List.sort() æ’åº</span></span><br><span class="line">List.sort()</span><br><span class="line">list.sort((a, b) -&gt; a.compareTo(b)); <span class="comment">// ä½¿ç”¨ Lambda è¡¨è¾¾å¼</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">List&lt;ListNode&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">5</span>));</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">2</span>));</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">9</span>));</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">1</span>));</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">5</span>));</span><br><span class="line"><span class="comment">// ä½¿ç”¨ Collections.sort() å’Œ Comparator æ’åº</span></span><br><span class="line">Collections.sort(list, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;ListNode&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(ListNode o1, ListNode o2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> o1.val - o2.val; <span class="comment">// æŒ‰ val å‡åºæ’åº</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ List.sort() å’Œ Lambda è¡¨è¾¾å¼æ’åº</span></span><br><span class="line">list.sort((o1, o2) -&gt; o1.val - o2.val); <span class="comment">// æŒ‰ val å‡åºæ’åº</span></span><br></pre></td></tr></table></figure>
<h2 id="å¸¸ç”¨å®¹å™¨ä¸åˆå§‹åŒ–">å¸¸ç”¨å®¹å™¨ä¸åˆå§‹åŒ–</h2>
<blockquote>
<p>ç¬¬ä¸€é¡¹è¡¨ç¤º æ•°æ®ç»“æ„ æ•°ç»„/é“¾è¡¨/æ ‘</p>
<p>ç¬¬äºŒé¡¹è¡¨ç¤º é€»è¾‘ç»“æ„ æœ‰åºåºåˆ—/é›†åˆ/é˜Ÿåˆ—/æ•°æ®å¯¹</p>
</blockquote>
<img src="/2025/01/17/Java/gailan-01.png" class="" title="volum">
<p><code>HashMap</code>: Node&lt;K,V&gt;[] table + Nodeé“¾è¡¨/TreeNodeçº¢é»‘æ ‘</p>
<blockquote>
<p>class Node&lt;K, V&gt; å­˜åœ¨å±æ€§ nextï¼Œnextç”¨äºæŒ‡å‘é“¾è¡¨ä¸­ä¸‹ä¸€èŠ‚ç‚¹</p>
</blockquote>
<p><code>LinkedHashMap</code>: Node&lt;K,V&gt;[] table + Nodeé“¾è¡¨/TreeNodeçº¢é»‘æ ‘</p>
<blockquote>
<p>Entry&lt;K,V&gt; extends HashMap.Node&lt;K,V&gt;å­˜åœ¨å±æ€§beforeå’Œafterï¼Œä¼šå‘tableä¸­è£…å…¥Entry&lt;K,V&gt;ç±»å‹èŠ‚ç‚¹ï¼Œè£…å…¥æ—¶ä¿®æ”¹before afterä»¥è®°å½•å†™å…¥é¡ºåº</p>
</blockquote>
<p><code>TreeMap</code>: Entry&lt;K, V&gt;èŠ‚ç‚¹çš„çº¢é»‘æ ‘</p>
<blockquote>
<p>æ‰€æœ‰çš„mapå‡å«æœ‰</p>
<p><strong>entrySet:</strong> è¯¥é›†åˆåŒ…å«äº† Map å¯¹è±¡ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹ (key-value pairs)ï¼Œæ¯ä¸ªé”®å€¼å¯¹éƒ½è¢«å°è£…æˆä¸€ä¸ª Map.Entry å¯¹è±¡</p>
<p><strong>keySet():</strong> è¿”å›ä¸€ä¸ªåŒ…å«äº† Map ä¸­æ‰€æœ‰ key çš„ Set é›†åˆã€‚</p>
<p><strong>values():</strong> è¿”å›ä¸€ä¸ªåŒ…å«äº† Map ä¸­æ‰€æœ‰ value çš„ Collection é›†åˆã€‚</p>
</blockquote>
<p><code>ArrayList</code>: è‡ªæ‰©å®¹æ•°ç»„</p>
<p><code>LinkedList</code>: åŒå‘é“¾è¡¨</p>
<blockquote>
<p>List -&gt; æœ‰åº, é€šè¿‡ç´¢å¼•è®¿é—®å¯¹è±¡</p>
</blockquote>
<p><code>PriorityQue</code>: å°é¡¶å †æ•°ç»„</p>
<p><code>ArrayDeque</code>: åŒç«¯é˜Ÿåˆ—æ•°ç»„</p>
<blockquote>
<p>que -&gt; é˜Ÿåˆ—</p>
</blockquote>
<p><code>HashSet</code>: é€šè¿‡HashMapå®ç°</p>
<p><code>LinkedHashSet</code>:</p>
<p><code>TreeSet</code>: çº¢é»‘æ ‘ï¼Œæ— æ³•é‡å¤å…ƒç´ æ’å…¥</p>
<p>æ•°ç»„ä¸å¯ç”¨è¿­ä»£å™¨ï¼Œ<code>Collection</code> ç±»å‹çš„å¯¹è±¡å¯ç”¨ï¼ˆå¦‚ <code>List</code>ï¼‰</p>
<p><strong>åˆå§‹åŒ–</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„åˆå§‹åŒ–ä¸å­˜åœ¨new xxx()çš„ç”¨æ³•</span></span><br><span class="line"><span class="comment">// ç›´æ¥åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="comment">// new å…³é”®å­—åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line"><span class="comment">// åŠ¨æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨åˆå§‹åŒ–é€šè¿‡newå®ç°ï¼Œä¸å­˜åœ¨new xxx&lt;&gt;&#123;&#125;è¿™æ ·çš„ç”¨æ³•</span></span><br><span class="line"><span class="comment">// ç›´æ¥åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span>[][] arr = &#123;</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// new å…³é”®å­—åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span>[][] arr = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>][<span class="number">3</span>]; <span class="comment">// åˆå§‹åŒ–3x3çš„äºŒç»´æ•°ç»„</span></span><br><span class="line"><span class="comment">// åŠ¨æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span>[][] arr = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>][];</span><br><span class="line">arr[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">arr[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line">arr[<span class="number">2</span>] = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Array.asList</span></span><br><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="comment">// List.of Java 9+</span></span><br><span class="line">List&lt;Integer&gt; list = List.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="comment">// new å…³é”®å­—åˆå§‹åŒ–</span></span><br><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// Arrays.asList è¿”å›çš„æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„åˆ—è¡¨ï¼ˆåŸºäºæ•°ç»„ï¼‰ï¼Œä¸èƒ½æ·»åŠ æˆ–åˆ é™¤å…ƒç´ ï¼Œä½†å¯ä»¥ä¿®æ”¹å…ƒç´ ï¼š</span></span><br><span class="line"><span class="comment">// List.of è¿”å›çš„æ˜¯ä¸€ä¸ªå®Œå…¨ä¸å¯å˜çš„ List</span></span><br><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>);</span><br><span class="line">list.set(<span class="number">0</span>, <span class="string">&quot;grape&quot;</span>); <span class="comment">// å¯ä»¥ä¿®æ”¹</span></span><br><span class="line">list.add(<span class="string">&quot;pear&quot;</span>);     <span class="comment">// æŠ›å‡º UnsupportedOperationException</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäº Arrays.asList åˆ›å»ºå¯å˜ List</span></span><br><span class="line">List&lt;String&gt; mutableList1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>));</span><br><span class="line">mutableList1.add(<span class="string">&quot;pear&quot;</span>); <span class="comment">// å¯ä»¥æ·»åŠ å…ƒç´ </span></span><br><span class="line">System.out.println(<span class="string">&quot;mutableList1: &quot;</span> + mutableList1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäº List.of åˆ›å»ºå¯å˜ List</span></span><br><span class="line">List&lt;String&gt; mutableList2 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(List.of(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>));</span><br><span class="line">mutableList2.add(<span class="string">&quot;pear&quot;</span>); <span class="comment">// å¯ä»¥æ·»åŠ å…ƒç´ </span></span><br><span class="line">System.out.println(<span class="string">&quot;mutableList2: &quot;</span> + mutableList2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ Set.ofã€Map.ofã€List.of åˆå§‹åŒ– Set, Map, List, ç›´æ¥åˆ›å»ºå‡ä¸ºä¸å¯å˜å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Liståˆå§‹åŒ–Set</span></span><br><span class="line">Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>));</span><br><span class="line"><span class="comment">// ä½¿ç”¨Liståˆå§‹åŒ–Queue</span></span><br><span class="line">Queue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„é•¿ä¸ºlengthï¼Œå®¹å™¨é•¿ä¸ºsize()</span></span><br><span class="line">arr.length;</span><br><span class="line">list.size();</span><br><span class="line">set.size();</span><br></pre></td></tr></table></figure>
<p><strong>æ’åº</strong></p>
<p>åœ¨ä¸æŒ‡å®šComparatorçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <strong>è‡ªç„¶æ’åº</strong> (natural ordering)ï¼Œå³é”®çš„å‡åºæ’åˆ—</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="comment">// åŒ¿åå†…éƒ¨ç±»</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(String s1, String s2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(s1.length(), s2.length());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lambdaè¡¨è¾¾å¼</span></span><br><span class="line">(s1, s2) -&gt; Integer.compare(s1.length(), s2.length())</span><br></pre></td></tr></table></figure>
<p><strong>å¯¹æ¯”</strong></p>
<p>peek&amp;&amp;get</p>
<p>peek -&gt; element || NULL</p>
<p>get -&gt; element || throw an exception</p>
<p>poll&amp;&amp;remove</p>
<p>poll -&gt; element || NULL</p>
<p>remove -&gt; element || throw an exception</p>
<p>offer&amp;&amp;add</p>
<blockquote>
<p>default: at the tail of this deque</p>
</blockquote>
<p>offer -&gt; true || false</p>
<p>add -&gt; true || IllegalStateException</p>
<h2 id="this-static-classä¸å†…éƒ¨ç±»">this, static classä¸å†…éƒ¨ç±»</h2>
<blockquote>
<p>Java çš„è¯­è¨€è®¾è®¡ä¸­ï¼Œä¸æ”¯æŒåœ¨é¡¶å±‚å£°æ˜ä¸€ä¸ªé™æ€ç±»ï¼ï¼ï¼</p>
</blockquote>
<p>ä¼˜å…ˆçº§ï¼šæ–¹æ³•å‚æ•° &gt; å½“å‰ç±»å˜é‡ &gt; å¤–éƒ¨ç±»å˜é‡</p>
<p>ä½œç”¨åŸŸï¼š</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å†…éƒ¨ç±»</th>
<th>é™æ€å†…éƒ¨ç±»</th>
</tr>
</thead>
<tbody>
<tr>
<td>è®¿é—®å¤–éƒ¨ç±»å®ä¾‹å˜é‡</td>
<td>å¯ä»¥ç›´æ¥è®¿é—®</td>
<td>ä¸èƒ½ç›´æ¥è®¿é—®</td>
</tr>
<tr>
<td>è®¿é—®å¤–éƒ¨ç±»é™æ€å˜é‡</td>
<td>å¯ä»¥ç›´æ¥è®¿é—®</td>
<td>å¯ä»¥ç›´æ¥è®¿é—®</td>
</tr>
<tr>
<td>æŒæœ‰å¤–éƒ¨ç±»å®ä¾‹å¼•ç”¨</td>
<td>éšå¼æŒæœ‰</td>
<td>ä¸æŒæœ‰</td>
</tr>
<tr>
<td>ä½œç”¨åŸŸå…³ç³»</td>
<td>åµŒå¥—åœ¨å¤–éƒ¨ç±»ä½œç”¨åŸŸå†…</td>
<td>åµŒå¥—åœ¨å¤–éƒ¨ç±»ä½œç”¨åŸŸå†…</td>
</tr>
</tbody>
</table>
<p><code>this</code> refers to the current <strong>instance</strong> of the class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">staticVar</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">StaticTest</span> <span class="operator">=</span> <span class="number">123</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">instanceVar</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">test</span> <span class="operator">=</span> <span class="number">666</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">InnerClass</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">instanceVar</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span> <span class="variable">staticVar</span> <span class="operator">=</span> <span class="number">40</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span> <span class="variable">StaticTest</span> <span class="operator">=</span> <span class="number">501231</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interMethod</span><span class="params">(<span class="type">int</span> <span class="keyword">var</span>)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Local variable: &quot;</span> + <span class="keyword">var</span>); <span class="comment">// å‚æ•° instanceVar</span></span><br><span class="line">            System.out.println(<span class="string">&quot;InnerClass variable: &quot;</span> + <span class="built_in">this</span>.instanceVar); <span class="comment">// InnerClasså®ä¾‹çš„ instanceVar</span></span><br><span class="line">            System.out.println(<span class="string">&quot;priority test: &quot;</span> + instanceVar);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StaticInnerClass</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">instanceVar</span> <span class="operator">=</span> <span class="number">40</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span> <span class="variable">staticVar</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ccc</span> <span class="operator">=</span> <span class="number">12315</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">interMethod</span><span class="params">(<span class="type">int</span> instanceVar)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Parameter variable: &quot;</span> + instanceVar);</span><br><span class="line">            System.out.println(<span class="string">&quot;Outter static variable: &quot;</span> + MyClass.staticVar);</span><br><span class="line">            System.out.println(<span class="string">&quot;Local variable: &quot;</span> + <span class="built_in">this</span>.instanceVar);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">interStaticMethod</span><span class="params">(<span class="type">int</span> instanceVar)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Parameter variable: &quot;</span> + instanceVar);</span><br><span class="line">            System.out.println(<span class="string">&quot;Outter static variable1: &quot;</span> + MyClass.staticVar);</span><br><span class="line">            System.out.println(<span class="string">&quot;Outter static variable2: &quot;</span> + StaticTest);</span><br><span class="line">            System.out.println(<span class="string">&quot;Local static variable: &quot;</span> + staticVar);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myMethod</span><span class="params">(<span class="type">int</span> instanceVar)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Local variable: &quot;</span> + instanceVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;Parameter: &quot;</span> + <span class="built_in">this</span>.instanceVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance variable without this &quot;</span> + test);</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance variable: &quot;</span> + <span class="built_in">this</span>.instanceVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;Static variable (discouraged): &quot;</span> + <span class="built_in">this</span>.staticVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;Static variable (preferred): &quot;</span> + MyClass.staticVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;InnnerClass static variable: &quot;</span> + InnerClass.staticVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;InnnerStaticClass static variable: &quot;</span> + StaticInnerClass.staticVar);</span><br><span class="line"><span class="comment">//        System.out.println(&quot;InnnerClass static variable without classname: &quot; + ccc);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyClass</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line"><span class="comment">//        MyClass.InnerClass interObj = new MyClass.InnerClass(); // é”™è¯¯ï¼šéï¼ˆé™æ€å†…éƒ¨ç±»ï¼‰çš„å®ä¾‹åŒ–å¿…é¡»ä¾èµ–äºå®ä¾‹äº†çš„å¤–éƒ¨ç±»</span></span><br><span class="line">        MyClass.<span class="type">InnerClass</span> <span class="variable">interObj</span> <span class="operator">=</span> obj.<span class="keyword">new</span> <span class="title class_">InnerClass</span>(); <span class="comment">// æ­£ç¡®</span></span><br><span class="line">        interObj.interMethod(<span class="number">40</span>);</span><br><span class="line">        MyClass.StaticInnerClass.interStaticMethod(<span class="number">123</span>);</span><br><span class="line">        MyClass.<span class="type">StaticInnerClass</span> <span class="variable">staticObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>.StaticInnerClass();</span><br><span class="line">        staticObj.interMethod(<span class="number">40</span>);</span><br><span class="line">        obj.myMethod(<span class="number">40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åŒ…">åŒ…</h2>
<p>å¯¹äº<code>com.example.project</code></p>
<p>å…¶ä¸­ï¼Œ <code>com</code> æ˜¯é¡¶å±‚åŒ…, <code>example</code> æ˜¯ <code>com</code> åŒ…çš„å­åŒ…, <code>project</code> æ˜¯ <code>com.example</code> åŒ…çš„å­åŒ…ã€‚</p>
<p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹çš„å±‚æ¬¡ç»“æ„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com/</span><br><span class="line">    example/</span><br><span class="line">        project/</span><br><span class="line">            MyClass.java </span><br></pre></td></tr></table></figure>
<p>å¦‚æœé¡¹ç›®æ ¹ç›®å½•æ˜¯ MyProjectï¼Œé‚£ä¹ˆ <code>com.example.project.MyClass</code> ç±»æ–‡ä»¶åº”è¯¥ä½äº <code>MyProject/src/main/java/com/example/project/MyClass.java</code></p>
<h2 id="Throw">Throw</h2>
<p><strong>Throw</strong></p>
<p>Throw ç”¨äºæŠ›å‡º<strong>ä¸€ä¸ª</strong>å¼‚å¸¸</p>
<p><strong>Throws</strong></p>
<p>æ–¹æ³•ä¸­æŠ›å‡º <strong>å—æ£€å¼‚å¸¸</strong> ï¼Œå¿…é¡»åœ¨æ–¹æ³•ç­¾åå¤„ä½¿ç”¨ Throws å£°æ˜ä¼šæŠ›å‡ºçš„å—æ£€å¼‚å¸¸ï¼›</p>
<p>éå—æ£€å¼‚å¸¸æ— éœ€åœ¨æ–¹æ³•ç­¾åå¤„å£°æ˜ Throws</p>
<blockquote>
<p>å—æ£€å¼‚å¸¸æ˜¯ <code>Exception</code> ç±»çš„å­ç±»ï¼ˆä½†ä¸åŒ…æ‹¬ <code>RuntimeException</code> åŠå…¶å­ç±»ï¼‰ã€‚è¿™äº›å¼‚å¸¸é€šå¸¸è¡¨ç¤ºç¨‹åºå¯ä»¥é¢„æœŸå¹¶å¤„ç†çš„é”™è¯¯æƒ…å†µï¼Œä¾‹å¦‚æ–‡ä»¶ä¸å­˜åœ¨ã€ç½‘ç»œè¿æ¥ä¸­æ–­ç­‰ã€‚</p>
<p>éå—æ£€å¼‚å¸¸æ˜¯ <code>RuntimeException</code> åŠå…¶å­ç±»ã€‚è¿™äº›å¼‚å¸¸é€šå¸¸è¡¨ç¤ºç¨‹åºä¸­çš„é€»è¾‘é”™è¯¯ï¼Œä¾‹å¦‚ç©ºæŒ‡é’ˆã€æ•°ç»„è¶Šç•Œç­‰ã€‚</p>
</blockquote>
<p><strong>å¤šå±‚åµŒå¥—å¼‚å¸¸æŠ›å‡º</strong></p>
<p>å¦‚æœä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦ä¸€ä¸ªå¯èƒ½æŠ›å‡º<strong>å—æ£€å¼‚å¸¸ï¼ˆChecked Exceptionï¼‰<strong>çš„æ–¹æ³•ï¼ˆå³è¢«è°ƒç”¨çš„æ–¹æ³•ç­¾åä¸­ä½¿ç”¨äº† <code>throws</code> å£°æ˜ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨æ–¹æ–¹æ³•</strong>å¿…é¡»</strong>åšä»¥ä¸‹ä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š</p>
<ol>
<li><strong>ä½¿ç”¨ <code>try-catch</code> æ•è·å¹¶å¤„ç†å¼‚å¸¸</strong>ï¼Œæˆ–è€…</li>
<li><strong>åœ¨è‡ªå·±çš„æ–¹æ³•ç­¾åä¸­ä½¿ç”¨ <code>throws</code> å£°æ˜è¯¥å¼‚å¸¸</strong>ï¼Œå°†å¼‚å¸¸ç»§ç»­å‘ä¸ŠæŠ›å‡ºã€‚</li>
</ol>
<p><strong>Try-Catch-Finally</strong></p>
<p>æ‰§è¡Œé€»è¾‘</p>
<p>Tryå—é¡ºåºæ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°Exception</p>
<p>å³ 1.è‹¥æ²¡æœ‰æŠ›å‡ºExceptionï¼Œåˆ™Tryå—å°†é¡ºåºæ‰§è¡Œå®Œæˆ</p>
<p>â€‹	 2.è‹¥æŠ›å‡ºExceptionï¼ŒTryå—æ‰§è¡Œå°†åˆ°æŠ›å‡ºExceptionçš„ä½ç½®æˆªè‡³</p>
<p>Catchå—ä»…åœ¨Tryå—æŠ›å‡ºExceptionæ—¶æ‰§è¡Œ</p>
<p>Finallyå— <strong>ä¸è®º Tryå—/Catchå— çš„æ‰§è¡Œæƒ…å†µï¼Œä¸€å®šä¼šå¾—åˆ°æ‰§è¡Œ</strong></p>
<p>å³ å³ä½¿åœ¨Tryå—/Catchå—ä¸­å­˜åœ¨returnï¼ŒFinallyå—ä¸€å®šä¼šå¾—åˆ°æ‰§è¡Œï¼Œä¸”åœ¨Finallyå—æ‰§è¡Œå®Œæˆåè¿›è¡Œreturnï¼›</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Try block - start&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">10</span> / <span class="number">0</span>; <span class="comment">// æŠ›å‡º ArithmeticException</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Try block - end&quot;</span>); <span class="comment">// ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Catch block: &quot;</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// åœ¨Finallyå—æ‰§è¡Œç»“æŸåè¿”å›</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Finally block - always executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;After try-catch-finally&quot;</span>); <span class="comment">// ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ²¡æœ‰åœ¨Catchå—ä¸­æŠ›å‡ºExceptionï¼Œç¨‹åºä¼šä¸­æ–­å½“å‰æ‰§è¡Œæµç¨‹</p>
</blockquote>
<h2 id="æ³›å‹ä¸é€šé…ç¬¦">æ³›å‹ä¸é€šé…ç¬¦</h2>
<p><code>MyClass&lt;T&gt;</code> æ³›å‹ç±»ï¼Œ<strong>æ³›å‹ç±»çš„æ ¸å¿ƒå°±åœ¨äºå…¶å†…éƒ¨å¯ä»¥ä½¿ç”¨æ³›å‹ç±»å‹å‚æ•°</strong></p>
<p><code>public static &lt;T&gt; void myMethod()</code> æ³›å‹æ–¹æ³•ï¼Œ<strong>æ³›å‹æ–¹æ³•åœ¨äºæ–¹æ³•çš„å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨çš„é€»è¾‘å¯ä»¥ä½¿ç”¨æ³›å‹ç±»å‹å‚æ•°ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IResponse</span>&lt;T&gt; &#123; <span class="comment">//ä½¿ç”¨æ³›å‹</span></span><br><span class="line">	</span><br><span class="line">	T <span class="title function_">getData</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(T t)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringResponse</span> <span class="keyword">implements</span> <span class="title class_">IResponse</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(String t)</span> &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">IResponse</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> T <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(T data)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.data = data;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span>&lt;T <span class="keyword">extends</span> <span class="title class_">BaseData</span>&gt; <span class="keyword">implements</span> <span class="title class_">IResponse</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(data!=<span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> data.getToken();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line"><span class="type">Teacher</span> <span class="variable">teacher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Teacher</span>();</span><br><span class="line"></span><br><span class="line">Person person;	</span><br><span class="line">person = student; <span class="comment">// å¤šæ€</span></span><br><span class="line">person = teacher; <span class="comment">// å¤šæ€</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printList</span><span class="params">(List&lt;?&gt; list)</span> &#123; <span class="comment">//é€šé…ç¬¦</span></span><br><span class="line">    <span class="keyword">for</span> (Object o : list) &#123;</span><br><span class="line">        System.out.println(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// è¯¥æ–¹æ³•å¯ä»¥æ¥æ”¶ä»»ä½•ç±»å‹çš„List,ä¾‹å¦‚ List&lt;String&gt;ã€List&lt;Integer&gt; ç­‰</span></span><br><span class="line"></span><br><span class="line">List&lt;? <span class="keyword">extends</span> <span class="title class_">Person</span>&gt; personList; <span class="comment">//åªæ¥æ”¶Personæˆ–Personå­ç±»</span></span><br><span class="line">List&lt;? <span class="built_in">super</span> Student&gt; personList <span class="comment">//åªæ¥æ”¶Studentæˆ–Studentçˆ¶ç±»</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³›å‹æ“¦é™¤</strong>ï¼šç¼–è¯‘å™¨åœ¨å¯¹æºä»£ç è¿›è¡Œç¼–è¯‘çš„æ—¶å€™å°†æ³›å‹æ¢æˆäº†æ³›å‹æŒ‡å®šçš„ä¸Šé™ç±»&lt;T extends ä¸Šé™ç±»å‹&gt;ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šæ³›å‹çš„ä¸Šé™ï¼Œç¼–è¯‘å™¨åˆ™ä¼šä½¿ç”¨Objectç±»æ›¿ä»£ã€‚ç®€å•çš„è¯´åœ¨ç¼–è¯‘å®Œæˆåçš„å­—èŠ‚ç æ–‡ä»¶ä¸­å…¶å®æ˜¯æ²¡æœ‰æ³›å‹çš„æ¦‚å¿µçš„ï¼Œæºä»£ç ä¸­çš„æ³›å‹è¢«ç¼–è¯‘å™¨ç”¨Objectæˆ–è€…æ³›å‹æŒ‡å®šçš„ç±»ç»™æ›¿æ¢æ‰äº†ã€‚</p>
<p><strong>å°†æ‰€æœ‰æ³›å‹ç±»å‹å‚æ•°æ›¿æ¢ä¸ºå…¶ä¸Šé™ç±»å‹ (Upper Bound)ã€‚</strong></p>
<ul>
<li>ä¾‹å¦‚ï¼ŒList&lt;String&gt; ä¼šè¢«æ›¿æ¢ä¸º List&lt;Object&gt;ï¼Œå› ä¸º Object æ˜¯ String çš„ä¸Šé™ç±»å‹ã€‚</li>
<li>å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šé™ç±»å‹ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ Object ä½œä¸ºä¸Šé™ç±»å‹ã€‚</li>
</ul>
<p><strong>æ’å…¥ç±»å‹è½¬æ¢ä»£ç ï¼Œä»¥ä¿è¯ç±»å‹å®‰å…¨ã€‚</strong></p>
<ul>
<li>ä¾‹å¦‚ï¼Œä» List&lt;Object&gt; ä¸­è·å–å…ƒç´ æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ (String) å¼ºåˆ¶ç±»å‹è½¬æ¢ä»£ç ï¼Œä»¥ç¡®ä¿è·å–åˆ°çš„å…ƒç´ æ˜¯ String ç±»å‹ã€‚</li>
</ul>
<p><strong>ä½œç”¨</strong>ï¼šå£°æ˜äº†ä¸€ä¸ªæ³›å‹ä¸ºStringçš„Listé›†åˆï¼Œå¹¶å‘é›†åˆä¸­æ·»åŠ äº†ä¸€ä¸ªå­—ç¬¦ä¸²â€œabcâ€ï¼Œæ¥ç€é€šè¿‡åå°„å‘é›†åˆlistä¸­æ·»åŠ äº†ä¸€ä¸ªæ•´æ•°ç±»å‹123ï¼Œé€šè¿‡è¾“å‡ºç»“æœå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå€¼éƒ½è¢«æ·»åŠ åˆ°äº†é›†åˆä¸­</p>
</blockquote>
<p><code>Class&lt;T&gt;</code> ä¸­çš„ <code>T</code> <strong>å¹¶é Class ç±»æœ¬èº«çš„æ³›å‹å‚æ•°</strong>ï¼Œè€Œæ˜¯è¡¨ç¤ºè¿™ä¸ª Class å¯¹è±¡æ‰€ä»£è¡¨çš„ç±»å‹çš„æ³›å‹å‚æ•°ã€‚ Class ç±»æœ¬èº«ä¸æ˜¯æ³›å‹ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨æ³›å‹æ–¹æ³•åˆ›å»ºç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createInstance</span><span class="params">(Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> createInstance(String.class);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> createInstance(Integer.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ä½¿ç”¨æ³›å‹æ–¹æ³•åˆ›å»ºç±»ï¼Œéœ€è¦ä½¿ç”¨ç±»å‹è½¬æ¢ï¼Œå¹¶ä¸”å¤±å»ç¼–è¯‘æ—¶çš„ç±»å‹å®‰å…¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">createInstance</span><span class="params">(Class clazz)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> (String) createInstance(String.class); <span class="comment">// éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> (Integer) createInstance(Integer.class); <span class="comment">// éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ½œåœ¨çš„è¿è¡Œæ—¶é”™è¯¯ï¼š</span></span><br><span class="line">    Class&lt;?&gt; unknownClass = Class.forName(<span class="string">&quot;java.lang.Double&quot;</span>); <span class="comment">//å‡è®¾ä¸çŸ¥é“å…·ä½“çš„ç±»å‹</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">wrongType</span> <span class="operator">=</span> (Integer) createInstance(unknownClass); <span class="comment">// è¿è¡Œæ—¶ä¼šæŠ›å‡º ClassCastException</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç±»åŠ è½½">ç±»åŠ è½½</h2>
<h3 id="æ¦‚å¿µ">æ¦‚å¿µ</h3>
<ol>
<li>
<p><strong>åŠ è½½ (Loading)</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ç±»çš„å…¨é™å®šåï¼ˆä¾‹å¦‚ java.lang.Stringï¼‰æŸ¥æ‰¾å¹¶è¯»å–ç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆ.class æ–‡ä»¶ï¼‰ã€‚</li>
<li>å°†ç±»çš„é™æ€ç»“æ„ä¿¡æ¯ï¼ˆä¾‹å¦‚ç±»åã€æ–¹æ³•åã€å­—æ®µåã€è®¿é—®æƒé™ç­‰ï¼‰<strong>å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ Class å¯¹è±¡ï¼Œè¯¥Classå¯¹è±¡å†…ä¿å­˜äº†æŒ‡å‘æ–¹æ³•åŒºä¸­è¿™äº›ç»“æ„ä¿¡æ¯çš„å¼•ç”¨ï¼Œè¯¥å¯¹è±¡å”¯ä¸€ã€‚</strong></li>
<li>åŠ è½½é˜¶æ®µé€šå¸¸ç”±ç±»åŠ è½½å™¨å®Œæˆï¼ŒJava æä¾›ä¸‰ç§å†…ç½®çš„ç±»åŠ è½½å™¨ï¼š
<ul>
<li><strong>Bootstrap ClassLoader</strong>ï¼šè´Ÿè´£åŠ è½½ Java æ ¸å¿ƒç±»åº“ï¼ˆrt.jar ç­‰ï¼‰ã€‚</li>
<li><strong>Extension ClassLoader</strong>ï¼šè´Ÿè´£åŠ è½½ Java æ‰©å±•ç±»åº“ï¼ˆjre/lib/ext ç›®å½•ä¸‹çš„ç±»ï¼‰ã€‚</li>
<li><strong>Application ClassLoader</strong>ï¼šè´Ÿè´£åŠ è½½åº”ç”¨ç¨‹åºç±»è·¯å¾„ï¼ˆCLASSPATHï¼‰ä¸Šçš„ç±»ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>é“¾æ¥ (Linking)</strong>ï¼š</p>
<ul>
<li>
<p><strong>éªŒè¯ (Verification)</strong>ï¼šç¡®ä¿åŠ è½½çš„ç±»æ–‡ä»¶ç¬¦åˆ Java è™šæ‹Ÿæœºè§„èŒƒï¼Œé˜²æ­¢æ¶æ„ä»£ç ç ´å JVMã€‚</p>
</li>
<li>
<p><strong>å‡†å¤‡ (Preparation)</strong>ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶è®¾ç½®é»˜è®¤åˆå§‹å€¼ï¼ˆä¾‹å¦‚ï¼Œint ç±»å‹ä¸º 0ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">123</span>;  <span class="comment">//ä¸ºvalueåˆ†é…å†…å­˜, ä¸”è®¾ç½®å€¼ä¸º0</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="number">123</span>  <span class="comment">//ä¸ºv2åˆ†é…å†…å­˜, ä¸”è®¾ç½®å€¼ä¸º123</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;  <span class="comment">//ä¸ä¼šä¸ºstråˆ†é…å†…å­˜ï¼Œè¯¥å˜é‡ä¸ºå®ä¾‹å˜é‡ï¼Œåˆ›å»ºTestå¯¹è±¡æ—¶åˆ†é…å†…å­˜ï¼›&quot;123&quot;ä¸ºå­—é¢é‡ï¼Œå°†æ”¾å…¥å…¨å±€å­—ç¬¦ä¸²å¸¸é‡æ± ä¿å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>è§£æ (Resolution)</strong>ï¼šå°†ç¬¦å·å¼•ç”¨ï¼ˆä¾‹å¦‚ç±»åã€æ–¹æ³•åï¼‰è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆä¾‹å¦‚å†…å­˜åœ°å€ï¼‰ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>åˆå§‹åŒ– (Initialization)ï¼ˆéå¿…å®šå‘ç”Ÿï¼‰</strong>ï¼š</p>
<ul>
<li>æ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–ä»£ç å—ï¼ˆstatic {}ï¼‰å’Œé™æ€å˜é‡çš„åˆå§‹åŒ–è¯­å¥ã€‚</li>
<li>åˆå§‹åŒ–é˜¶æ®µç±»å˜é‡æ‰ä¼šè¢«èµ‹äºˆæˆ‘ä»¬åœ¨ä»£ç ä¸­å£°æ˜çš„å€¼ã€‚JVMä¼šæ ¹æ®è¯­å¥æ‰§è¡Œé¡ºåºå¯¹ç±»å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ã€‚</li>
<li>åªæœ‰åœ¨ç±»è¢«ä¸»åŠ¨ä½¿ç”¨æ—¶æ‰ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œä¾‹å¦‚ï¼š
<ul>
<li>åˆ›å»ºç±»çš„å®ä¾‹ã€‚</li>
<li><strong>è®¿é—®ç±»çš„é™æ€å˜é‡ã€‚</strong></li>
<li><strong>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ã€‚</strong></li>
<li>åå°„è°ƒç”¨ Test ç±»ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>åˆå§‹åŒ–å‘ç”Ÿæ¡ä»¶ï¼š</p>
<p>â‘  é‡åˆ° newã€getstaticã€putstaticã€invokestatic è¿™å››æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ç”Ÿæˆè¿™4æ¡æŒ‡ä»¤çš„æœ€å¸¸è§çš„Javaä»£ç åœºæ™¯æ˜¯ï¼šä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰çš„æ—¶å€™ï¼Œä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚</p>
<p>â‘¡ ä½¿ç”¨ java.lang.reflect åŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</p>
<p>â‘¢ å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚</p>
<p>â‘£ å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å«main()æ–¹æ³•çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚</p>
<p>â‘¤ å½“ä½¿ç”¨ JDK1.7 åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œå¦‚æœä¸€ä¸ª java.lang.invoke.MethodHandleå®ä¾‹æœ€åçš„è§£æç»“æœ REF_getstatic,REF_putstatic,REF_invokeStatic çš„æ–¹æ³•å¥æŸ„ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•å¥æŸ„æ‰€å¯¹åº”çš„ç±»æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆå‡ºè§¦å‘å…¶åˆå§‹åŒ–ã€‚</p>
<p>â‘¥ å½“ä¸€ä¸ªæ¥å£ä¸­å®šä¹‰äº†JDK8æ–°åŠ å…¥çš„é»˜è®¤æ–¹æ³•ï¼ˆè¢«defaultå…³é”®å­—ä¿®é¥°çš„æ¥å£æ–¹æ³•ï¼‰æ—¶ï¼Œå¦‚æœæœ‰è¿™ä¸ªæ¥å£çš„å®ç°ç±»å‘ç”Ÿäº†åˆå§‹åŒ–ï¼Œé‚£è¯¥æ¥å£è¦åœ¨å…¶ä¹‹å‰è¢«åˆå§‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;</span><br><span class="line">        ++x;</span><br><span class="line">        ++y;</span><br><span class="line">        System.out.println(<span class="string">&quot;Singletonæ„é€ æ–¹æ³•æ‰§è¡Œï¼Œx = &quot;</span> + x +<span class="string">&quot;,y = &quot;</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;singleton.x = &quot;</span> + singleton.x);</span><br><span class="line">        System.out.println(<span class="string">&quot;singleton.x = &quot;</span> + singleton.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ‰§è¡Œé¡ºåºå’Œè¾“å‡ºç»“æœåˆ†æï¼š</strong></p>
<ol>
<li>
<p><strong>ç±»åŠ è½½ï¼š</strong></p>
<ul>
<li>
<p>ä¸»ç±»<code>Singleton</code>çš„åŠ è½½ï¼šè¯»å–<code>Singleton.class</code>æ–‡ä»¶ï¼Œè·å–ç±»çš„ç»“æ„ä¿¡æ¯ï¼Œåœ¨æ–¹æ³•åŒºåˆ›å»º<code>Singleton</code>ç±»çš„ Class å¯¹è±¡</p>
<blockquote>
<p>ä¸»ç±»å³å­˜åœ¨mainæ–¹æ³•çš„ç±»</p>
</blockquote>
</li>
<li>
<p>ä¸»ç±»<code>Singleton</code>çš„é“¾æ¥ï¼šéªŒè¯ï¼Œå‡†å¤‡å’Œè§£æã€‚å‡†å¤‡é˜¶æ®µå°†ä¸ºé™æ€å˜é‡<code>singleton</code>, <code>x</code>, <code>y</code>åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼ã€‚å…¶ä¸­ï¼Œ<code>singleton</code>ï¼šå¼•ç”¨ç±»å‹çš„é»˜è®¤å€¼ä¸º <code>null</code>ã€‚<code>x</code>ï¼š<code>int</code> ç±»å‹çš„é»˜è®¤å€¼ä¸º <code>0</code>ã€‚<code>y</code>ï¼š è™½ç„¶ <code>y</code> è¢«æ˜¾å¼åˆå§‹åŒ–ä¸º <code>0</code>ï¼Œä½†åœ¨å‡†å¤‡é˜¶æ®µï¼Œåªä¼šèµ‹äºˆé»˜è®¤å€¼ï¼Œæ‰€ä»¥ <code>y</code> ä¹Ÿä¼šè¢«åˆå§‹åŒ–ä¸º <code>0</code>ã€‚</p>
<blockquote>
<p>è¿™ä¸‰ä¸ªé™æ€å˜é‡å­˜æ”¾åœ¨æ–¹æ³•åŒºé™æ€å˜é‡åŒºä¸­</p>
</blockquote>
</li>
<li>
<p>ä¸»ç±»<code>Singleton</code>çš„åˆå§‹åŒ–ï¼š</p>
<ul>
<li>é™æ€å˜é‡ <code>singleton</code> åˆå§‹åŒ–ï¼š<code>private static Singleton singleton = new Singleton();</code>
<ul>
<li>è¿™è¡Œä»£ç ä¼šåˆ›å»ºä¸€ä¸ª <code>Singleton</code> å®ä¾‹ï¼Œè¿›è€Œè°ƒç”¨ <code>Singleton</code> çš„æ„é€ æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>æ„é€ æ–¹æ³•æ‰§è¡Œï¼š
<ul>
<li><code>++x;</code>  // æ­¤æ—¶ x è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œæ‰€ä»¥ x å˜ä¸º 1</li>
<li><code>++y;</code>  // y å·²åˆå§‹åŒ–ä¸º 0ï¼Œæ‰€ä»¥ y å˜ä¸º 1</li>
<li><code>System.out.println(&quot;Singletonæ„é€ æ–¹æ³•æ‰§è¡Œï¼Œx = &quot; + x +&quot;,y = &quot; + y);</code></li>
<li>è¾“å‡ºï¼š<code>Singletonæ„é€ æ–¹æ³•æ‰§è¡Œï¼Œx = 1,y = 1</code></li>
</ul>
</li>
<li>é™æ€å˜é‡ <code>x</code> å’Œ <code>y</code> åˆå§‹åŒ–ï¼š
<ul>
<li><code>public static int x;</code>  // æ— åŠ¨ä½œ (æ„é€ æ–¹æ³•ä¸­å·²ç»ä¿®æ”¹)</li>
<li><code>public static int y = 0;</code> // y è¢«èµ‹å€¼ä¸º 0 (è¦†ç›–äº†æ„é€ æ–¹æ³•ä¸­çš„ä¿®æ”¹)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>main æ–¹æ³•æ‰§è¡Œï¼š</strong></p>
<ul>
<li><code>System.out.println(&quot;singleton.x = &quot; + singleton.x);</code>
<ul>
<li>è¾“å‡ºï¼š<code>singleton.x = 1</code></li>
</ul>
</li>
<li><code>System.out.println(&quot;singleton.x = &quot; + singleton.y);</code>
<ul>
<li>è¾“å‡ºï¼š<code>singleton.y = 0</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>æœ€ç»ˆè¾“å‡ºç»“æœï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Singletonæ„é€ æ–¹æ³•æ‰§è¡Œï¼Œx = 1,y = 1</span><br><span class="line">singleton.x = 1</span><br><span class="line">singleton.y = 0</span><br></pre></td></tr></table></figure>
<h3 id="JVMç±»åŠ è½½æœºåˆ¶">JVMç±»åŠ è½½æœºåˆ¶</h3>
<p>ç±»åŠ è½½å™¨</p>
<ul>
<li><strong>å¯åŠ¨ç±»åŠ è½½å™¨</strong>: Bootstrap ClassLoaderï¼Œè´Ÿè´£åŠ è½½å­˜æ”¾åœ¨JDK\jre\lib(JDKä»£è¡¨JDKçš„å®‰è£…ç›®å½•ï¼Œä¸‹åŒ)ä¸‹ï¼Œæˆ–è¢«-Xbootclasspathå‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”èƒ½è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“(å¦‚rt.jarï¼Œæ‰€æœ‰çš„java.*å¼€å¤´çš„ç±»å‡è¢«Bootstrap ClassLoaderåŠ è½½)ã€‚å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯æ— æ³•è¢«Javaç¨‹åºç›´æ¥å¼•ç”¨çš„ã€‚</li>
<li><strong>æ‰©å±•ç±»åŠ è½½å™¨</strong>: Extension ClassLoaderï¼Œè¯¥åŠ è½½å™¨ç”±<code>sun.misc.Launcher$ExtClassLoader</code>å®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½JDK\jre\lib\extç›®å½•ä¸­ï¼Œæˆ–è€…ç”±java.ext.dirsç³»ç»Ÿå˜é‡æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“(å¦‚javax.*å¼€å¤´çš„ç±»)ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚</li>
<li><strong>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨</strong>: Application ClassLoaderï¼Œè¯¥ç±»åŠ è½½å™¨ç”±<code>sun.misc.Launcher$AppClassLoader</code>æ¥å®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„(ClassPath)æ‰€æŒ‡å®šçš„ç±»ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚</li>
<li><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong>: å› ä¸ºJVMè‡ªå¸¦çš„ClassLoaderåªæ˜¯æ‡‚å¾—ä»æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½æ ‡å‡†çš„java classæ–‡ä»¶ï¼Œå› æ­¤å¦‚æœç¼–å†™äº†è‡ªå·±çš„ClassLoaderï¼Œä¾¿å¯ä»¥åšåˆ°å¦‚ä¸‹å‡ ç‚¹:
<ul>
<li>åœ¨æ‰§è¡Œéç½®ä¿¡ä»£ç ä¹‹å‰ï¼Œè‡ªåŠ¨éªŒè¯æ•°å­—ç­¾åã€‚</li>
<li>åŠ¨æ€åœ°åˆ›å»ºç¬¦åˆç”¨æˆ·ç‰¹å®šéœ€è¦çš„å®šåˆ¶åŒ–æ„å»ºç±»ã€‚</li>
<li>ä»ç‰¹å®šçš„åœºæ‰€å–å¾—java classï¼Œä¾‹å¦‚æ•°æ®åº“ä¸­å’Œç½‘ç»œä¸­ã€‚</li>
</ul>
</li>
</ul>
<p>ç±»åŠ è½½ç±»å‹</p>
<ol>
<li><strong>å…¨ç›˜è´Ÿè´£</strong>ï¼Œå½“ä¸€ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½æŸä¸ªClassæ—¶ï¼Œè¯¥Classæ‰€ä¾èµ–çš„å’Œå¼•ç”¨çš„å…¶ä»–Classä¹Ÿå°†ç”±è¯¥ç±»åŠ è½½å™¨è´Ÿè´£è½½å…¥ï¼Œé™¤éæ˜¾ç¤ºä½¿ç”¨å¦å¤–ä¸€ä¸ªç±»åŠ è½½å™¨æ¥è½½å…¥</li>
<li><strong>çˆ¶ç±»å§”æ‰˜</strong>ï¼Œå…ˆè®©çˆ¶ç±»åŠ è½½å™¨è¯•å›¾åŠ è½½è¯¥ç±»ï¼Œåªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶æ‰å°è¯•ä»è‡ªå·±çš„ç±»è·¯å¾„ä¸­åŠ è½½è¯¥ç±»</li>
<li><strong>ç¼“å­˜æœºåˆ¶</strong>ï¼Œç¼“å­˜æœºåˆ¶å°†ä¼šä¿è¯æ‰€æœ‰åŠ è½½è¿‡çš„Classéƒ½ä¼šè¢«ç¼“å­˜ï¼Œå½“ç¨‹åºä¸­éœ€è¦ä½¿ç”¨æŸä¸ªClassæ—¶ï¼Œç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºå¯»æ‰¾è¯¥Classï¼Œåªæœ‰ç¼“å­˜åŒºä¸å­˜åœ¨ï¼Œç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢æˆClasså¯¹è±¡ï¼Œå­˜å…¥ç¼“å­˜åŒºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹äº†Classåï¼Œå¿…é¡»é‡å¯JVMï¼Œç¨‹åºçš„ä¿®æ”¹æ‰ä¼šç”Ÿæ•ˆ</li>
<li><strong>åŒäº²å§”æ´¾æœºåˆ¶</strong>, å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¯·æ±‚å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨å»å®Œæˆï¼Œä¾æ¬¡å‘ä¸Šï¼Œå› æ­¤ï¼Œæ‰€æœ‰çš„ç±»åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥è¢«ä¼ é€’åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åœ¨å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»æ—¶ï¼Œå³æ— æ³•å®Œæˆè¯¥åŠ è½½ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½è¯¥ç±»ã€‚</li>
</ol>
<h3 id="åŒäº²å§”æ´¾æœºåˆ¶è¿‡ç¨‹">åŒäº²å§”æ´¾æœºåˆ¶è¿‡ç¨‹</h3>
<ol>
<li>å½“AppClassLoaderåŠ è½½ä¸€ä¸ªclassæ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ExtClassLoaderå»å®Œæˆã€‚</li>
<li>å½“ExtClassLoaderåŠ è½½ä¸€ä¸ªclassæ—¶ï¼Œå®ƒé¦–å…ˆä¹Ÿä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™BootStrapClassLoaderå»å®Œæˆã€‚</li>
<li>å¦‚æœBootStrapClassLoaderåŠ è½½å¤±è´¥(ä¾‹å¦‚åœ¨$JAVA_HOME/jre/libé‡ŒæœªæŸ¥æ‰¾åˆ°è¯¥class)ï¼Œä¼šä½¿ç”¨ExtClassLoaderæ¥å°è¯•åŠ è½½ï¼›</li>
<li>è‹¥ExtClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šä½¿ç”¨AppClassLoaderæ¥åŠ è½½ï¼Œå¦‚æœAppClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šæŠ¥å‡ºå¼‚å¸¸ClassNotFoundExceptionã€‚</li>
</ol>
<h2 id="åå°„">åå°„</h2>
<p>ç±»çš„Classå¯¹è±¡åœ¨<strong>ç±»åŠ è½½çš„åŠ è½½éƒ¨åˆ†</strong>æ—¶è¢«åˆ›å»ºï¼Œä¿å­˜äº<strong>å †</strong>ã€‚</p>
<p><strong>åå°„çš„æ ¸å¿ƒ API</strong></p>
<p>Java åå°„æœºåˆ¶ä¸»è¦ç”± java.lang.reflect åŒ…ä¸­çš„ç±»å’Œæ¥å£æä¾›æ”¯æŒï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„ç±»åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>Class ç±»:</strong> ä»£è¡¨ä¸€ä¸ªç±»çš„ç±»å‹ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ Class å¯¹è±¡è·å–ç±»çš„æ‰€æœ‰ä¿¡æ¯ã€‚</li>
<li><strong>Field ç±»:</strong> ä»£è¡¨ç±»çš„æˆå‘˜å˜é‡ï¼Œå¯ä»¥é€šè¿‡ Field å¯¹è±¡è·å–å’Œè®¾ç½®å˜é‡çš„å€¼ã€‚</li>
<li><strong>Method ç±»:</strong> ä»£è¡¨ç±»çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ Method å¯¹è±¡è°ƒç”¨æ–¹æ³•ã€‚</li>
<li><strong>Constructor ç±»:</strong> ä»£è¡¨ç±»çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ Constructor å¯¹è±¡åˆ›å»ºç±»çš„å®ä¾‹ã€‚</li>
</ul>
<p><strong>è·å–æ–¹å¼ï¼š</strong></p>
<ol>
<li><strong>é€šè¿‡ç±»åè·å–:</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>é€šè¿‡å¯¹è±¡è·å–:</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">MyClass</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>(); </span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; clazz = obj.getClass();</span><br><span class="line"></span><br><span class="line">Class&lt;Person&gt; personClass=(Class&lt;Person&gt;)person.getClass();</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>é€šè¿‡ç±»å­—é¢é‡è·å–:</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = MyClass.class;</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClass</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + name + <span class="string">&quot;, Age: &quot;</span> + age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectionExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è·å– Class å¯¹è±¡</span></span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ„é€ å‡½æ•°å¹¶åˆ›å»ºå®ä¾‹</span></span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;John Doe&quot;</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æˆå‘˜å˜é‡å¹¶è®¾ç½®å€¼</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>); <span class="comment">// å…è®¸è®¿é—®ç§æœ‰å˜é‡</span></span><br><span class="line">        nameField.set(obj, <span class="string">&quot;Jane Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ–¹æ³•å¹¶è°ƒç”¨</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">printInfoMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;printInfo&quot;</span>);</span><br><span class="line">        printInfoMethod.invoke(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>import ç±»å°†å‘ŠçŸ¥ç¼–è¯‘å™¨è¯¥ç±»çš„ä½ç½®ï¼Œ<strong>ä¸ä¼šè§¦å‘ç±»åŠ è½½</strong></p>
<p><strong>å¯¹äºä¸€ä¸ª Test.java æ–‡ä»¶ï¼š</strong></p>
<ul>
<li><strong>åªæœ‰è¢«ä¸»ç±»ï¼ˆåŒ…å« main() æ–¹æ³•çš„ç±»ï¼‰ç›´æ¥æˆ–é—´æ¥ä½¿ç”¨åˆ°çš„ç±»æ‰ä¼šè¢«åŠ è½½ã€é“¾æ¥(å’Œåˆå§‹åŒ–)ã€‚</strong> ä¸»ç±»å°†é»˜è®¤è¿›è¡ŒåŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–ã€‚</li>
<li><strong>å¦‚æœ Test.java ä¸­çš„å…¶ä»–ç±»æ²¡æœ‰è¢«ä¸»ç±»ç›´æ¥æˆ–é—´æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™äº›ç±»</strong> <strong>ä¸ä¼šè¢«åŠ è½½</strong> <strong>ã€‚</strong></li>
</ul>
<p>è§¦å‘ç±»åŠ è½½çš„æ—¶å€™ä¸€èˆ¬ä¸ºï¼š</p>
<ol>
<li>
<p><strong>åˆ›å»º <code>Test</code> ç±»çš„å®ä¾‹ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Test</span> <span class="variable">myTestObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>(); </span><br></pre></td></tr></table></figure>
<p>å½“æ‰§è¡Œåˆ° <code>new Test()</code> æ—¶ï¼ŒJVM å‘ç° <code>Test</code> ç±»è¿˜æ²¡æœ‰è¢«åŠ è½½ï¼Œå°±ä¼šå¯åŠ¨ç±»åŠ è½½è¿‡ç¨‹ã€‚</p>
<p>è¿™ç§æƒ…å†µä¼šä¸€å£æ°”å®ŒæˆåŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–ä¸‰ä¸ªè¿‡ç¨‹ã€‚</p>
<p>å› ä¸ºåˆ›å»ºå®ä¾‹éœ€è¦ç”¨åˆ°ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬é™æ€å˜é‡çš„åˆå§‹å€¼ã€å®ä¾‹å˜é‡çš„å®šä¹‰ç­‰ï¼Œæ‰€ä»¥å¿…é¡»å®Œæˆåˆå§‹åŒ–ã€‚</p>
</li>
<li>
<p><strong>è®¿é—® <code>Test</code> ç±»çš„é™æ€æˆå‘˜ï¼ˆå˜é‡æˆ–æ–¹æ³•ï¼‰ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> Test.value; <span class="comment">// è®¿é—®é™æ€å˜é‡</span></span><br><span class="line">Test.someStaticMethod(); <span class="comment">// è°ƒç”¨é™æ€æ–¹æ³• (å‡è®¾å­˜åœ¨ someStaticMethod)</span></span><br></pre></td></tr></table></figure>
<p>è®¿é—® <code>Test.value</code> æˆ–è°ƒç”¨ <code>Test.someStaticMethod()</code> æ—¶ï¼Œéœ€è¦ç”¨åˆ° <code>Test</code> ç±»çš„ä¿¡æ¯ï¼Œä¼šè§¦å‘ç±»åŠ è½½ã€‚</p>
<p><strong>å¦‚æœè®¿é—®çš„æ˜¯é™æ€å¸¸é‡ï¼ˆ<code>final static</code>ï¼‰ï¼Œåˆ™åªä¼šè¿›è¡ŒåŠ è½½å’Œé“¾æ¥ï¼Œä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ã€‚</strong></p>
<ul>
<li>å› ä¸ºé™æ€å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²ç»ç¡®å®šäº†å€¼ï¼Œå¹¶å­˜å‚¨åœ¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œä¸éœ€è¦ç­‰åˆ°åˆå§‹åŒ–é˜¶æ®µã€‚</li>
</ul>
<p><strong>å¦‚æœè®¿é—®çš„æ˜¯é™æ€å˜é‡ï¼Œåˆ™ä¼šå®ŒæˆåŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–ä¸‰ä¸ªè¿‡ç¨‹ã€‚</strong></p>
<ul>
<li>å› ä¸ºé™æ€å˜é‡çš„åˆå§‹å€¼å¯èƒ½éœ€è¦åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œä»£ç æ‰èƒ½ç¡®å®šã€‚</li>
</ul>
</li>
<li>
<p><strong>ä½¿ç”¨åå°„æœºåˆ¶æ“ä½œ <code>Test</code> ç±»ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; testClass = Class.forName(<span class="string">&quot;com.example.Test&quot;</span>); <span class="comment">// å‡è®¾ Test ç±»åœ¨ com.example åŒ…ä¸‹</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>Class.forName()</code> è·å– <code>Test</code> ç±»çš„ <code>Class</code> å¯¹è±¡æ—¶ï¼Œä¹Ÿä¼šè§¦å‘ç±»åŠ è½½ã€‚</p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªä¼šè¿›è¡ŒåŠ è½½å’Œé“¾æ¥ï¼Œä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ã€‚</strong></p>
<ul>
<li><code>Class.forName()</code> æ–¹æ³•å¯ä»¥æŒ‡å®šæ˜¯å¦è¿›è¡Œåˆå§‹åŒ–ï¼Œé»˜è®¤æ˜¯ä¸è¿›è¡Œåˆå§‹åŒ–çš„ã€‚</li>
</ul>
<p><strong>å¦‚æœè°ƒç”¨ <code>Class.forName()</code> æ–¹æ³•æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥äº† <code>true</code>ï¼Œåˆ™ä¼šå®ŒæˆåŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–ä¸‰ä¸ªè¿‡ç¨‹ã€‚</strong></p>
<ul>
<li>ä¾‹å¦‚ï¼š<code>Class.forName(&quot;com.example.Test&quot;, true, classLoader);</code></li>
</ul>
</li>
</ol>
</blockquote>
<h2 id="æ³¨è§£ä¸APT">æ³¨è§£ä¸APT</h2>
<p>æ³¨è§£( @interface)æ˜¯ä¸€ç§å®šä¹‰ç±»å‹</p>
<p>@interface æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨äºå®šä¹‰æ³¨è§£ç±»å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AuthRequired &#123;</span><br><span class="line">    String <span class="title function_">role</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;admin&quot;</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…ƒæ³¨è§£</strong></p>
<p>å…ƒæ³¨è§£æ˜¯ç”¨äºæ³¨è§£å…¶ä»–æ³¨è§£çš„æ³¨è§£ï¼ŒJava æä¾›äº†ä»¥ä¸‹å…ƒæ³¨è§£ï¼š</p>
<ul>
<li><strong>@Retention:</strong> æŒ‡å®šæ³¨è§£çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯é€‰å€¼ï¼š
<ul>
<li><code>RetentionPolicy.SOURCE</code>ï¼šä»…ä¿ç•™åœ¨æºä»£ç ä¸­ï¼Œç¼–è¯‘æ—¶ä¼šè¢«ä¸¢å¼ƒã€‚</li>
<li><code>RetentionPolicy.CLASS</code>ï¼šä¿ç•™åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œä½†è¿è¡Œæ—¶ä¸å¯è§ã€‚</li>
<li><code>RetentionPolicy.RUNTIME</code>ï¼šä¿ç•™åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œè¿è¡Œæ—¶å¯è§ï¼Œå¯ä»¥é€šè¿‡åå°„è·å–ã€‚</li>
</ul>
</li>
<li><strong>@Target:</strong> æŒ‡å®šæ³¨è§£å¯ä»¥åº”ç”¨äºå“ªäº›å…ƒç´ ï¼Œå¯é€‰å€¼ï¼š
<ul>
<li><code>ElementType.TYPE</code>ï¼šç±»ã€æ¥å£ã€æšä¸¾</li>
<li><code>ElementType.FIELD</code>ï¼šå­—æ®µ</li>
<li><code>ElementType.METHOD</code>ï¼šæ–¹æ³•</li>
<li><code>ElementType.PARAMETER</code>ï¼šæ–¹æ³•å‚æ•°</li>
<li><code>ElementType.CONSTRUCTOR</code>ï¼šæ„é€ å‡½æ•°</li>
<li><code>ElementType.LOCAL_VARIABLE</code>ï¼šå±€éƒ¨å˜é‡</li>
<li><code>ElementType.ANNOTATION_TYPE</code>ï¼šæ³¨è§£</li>
<li><code>ElementType.PACKAGE</code>ï¼šåŒ…</li>
</ul>
</li>
<li><strong>@Documented:</strong> æŒ‡å®šå°†æ³¨è§£åŒ…å«åœ¨ Javadoc æ–‡æ¡£ä¸­ã€‚</li>
<li><strong>@Inherited:</strong> æŒ‡å®šå­ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»çš„æ³¨è§£ã€‚</li>
</ul>
<p>ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@interface</span> AuthRequired &#123;</span><br><span class="line"> String <span class="title function_">role</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;admin&quot;</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line"> <span class="meta">@AuthRequired(role = &quot;user&quot;)</span> </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨åå°„æœºåˆ¶è·å–æ³¨è§£ä¿¡æ¯</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> MyService.class.getMethod(<span class="string">&quot;doSomething&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (method.isAnnotationPresent(AuthRequired.class)) &#123;</span><br><span class="line"> <span class="type">AuthRequired</span> <span class="variable">auth</span> <span class="operator">=</span> method.getAnnotation(AuthRequired.class);</span><br><span class="line"> <span class="type">String</span> <span class="variable">requiredRole</span> <span class="operator">=</span> auth.role();  <span class="comment">// æ‹¿åˆ°äº†doSomethingæ–¹æ³•çš„æ³¨è§£å†…å®¹</span></span><br><span class="line"> <span class="comment">// ... è¿›è¡Œæƒé™éªŒè¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Factory &#123;</span><br><span class="line"></span><br><span class="line"> Class <span class="title function_">type</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"> String <span class="title function_">id</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Factory(id = &quot;Rectangle&quot;, type = IShape.class)</span>  <span class="comment">// ä¸ºRectangleç±»è´´ä¸Šäº†æ ‡ç­¾ï¼Œè¯´æ˜å…¶idå’Œtype</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rectangle</span> <span class="keyword">implements</span> <span class="title class_">IShape</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Draw a Rectangle&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨è§£åƒæ ‡ç­¾ï¼š</strong> @AuthRequired æ³¨è§£å°±åƒä¸€ä¸ªæ ‡ç­¾ï¼Œè´´åœ¨äº† doSomething å‡½æ•°ä¸Šã€‚</p>
<p><strong>å±æ€§åƒæ ‡ç­¾å†…å®¹ï¼š</strong> role = â€œuserâ€ å°±åƒæ ‡ç­¾ä¸Šçš„æ–‡å­—ï¼Œæè¿°äº†è¿™ä¸ªæ³¨è§£çš„å…·ä½“ä¿¡æ¯ã€‚</p>
<p><strong>å…ƒæ•°æ®ï¼š</strong> æ³¨è§£å’Œå®ƒçš„å±æ€§å€¼ä¸€èµ·æ„æˆäº†å…ƒæ•°æ®ï¼Œè¿™äº›å…ƒæ•°æ®å¹¶ä¸ä¼šæ”¹å˜ doSomething å‡½æ•°æœ¬èº«çš„ä»£ç å’Œè¡Œä¸ºï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå¯ä»¥é€šè¿‡åå°„æœºåˆ¶è¯»å–è¿™äº›å…ƒæ•°æ®ï¼Œä»è€Œå®ç°ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æƒé™éªŒè¯ã€‚</p>
</blockquote>
<p><strong>Java APT (Annotation Processing Tool)</strong></p>
<p>Java APTï¼ˆæ³¨è§£å¤„ç†å™¨ï¼‰æ˜¯ Java ç¼–è¯‘å™¨æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨ç¼–è¯‘æœŸå¤„ç†æ³¨è§£ï¼Œç”Ÿæˆé¢å¤–çš„ä»£ç æˆ–è¿›è¡Œå…¶ä»–æ“ä½œã€‚</p>
<p><strong>APT çš„å·¥ä½œåŸç†</strong></p>
<ol>
<li><strong>æ‰«ææ³¨è§£:</strong> åœ¨ç¼–è¯‘ Java ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ‰«ææºä»£ç ä¸­çš„æ³¨è§£ã€‚</li>
<li><strong>è°ƒç”¨æ³¨è§£å¤„ç†å™¨:</strong> å¦‚æœå‘ç°æœ‰æ³¨è§£å¤„ç†å™¨æ³¨å†Œå¤„ç†äº†æŸä¸ªæ³¨è§£ï¼Œç¼–è¯‘å™¨ä¼šè°ƒç”¨ç›¸åº”çš„æ³¨è§£å¤„ç†å™¨ã€‚</li>
<li><strong>å¤„ç†æ³¨è§£:</strong> æ³¨è§£å¤„ç†å™¨å¯ä»¥è¯»å–ã€åˆ†æå’Œå¤„ç†æ³¨è§£ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆæ–°çš„ä»£ç æ–‡ä»¶æˆ–èµ„æºæ–‡ä»¶ã€‚</li>
<li><strong>ç¼–è¯‘ç”Ÿæˆæœ€ç»ˆçš„ class æ–‡ä»¶:</strong> ç¼–è¯‘å™¨å°†ç”Ÿæˆçš„ä»£ç æˆ–èµ„æºæ–‡ä»¶ä¸æºä»£ç ä¸€èµ·ç¼–è¯‘ï¼Œç”Ÿæˆæœ€ç»ˆçš„ class æ–‡ä»¶ã€‚</li>
</ol>
<p><strong>åˆ›å»ºæ³¨è§£å¤„ç†å™¨</strong></p>
<ol>
<li><strong>å®ç° javax.annotation.processing.Processor æ¥å£:</strong> æ³¨è§£å¤„ç†å™¨éœ€è¦å®ç° Processor æ¥å£ï¼Œå¹¶å®ç°å…¶ä¸­çš„æ–¹æ³•ï¼Œä¾‹å¦‚ process() æ–¹æ³•ã€‚</li>
<li><strong>æ³¨å†Œæ³¨è§£å¤„ç†å™¨:</strong> åœ¨ META-INF/services/javax.annotation.processing.Processor æ–‡ä»¶ä¸­å£°æ˜æ³¨è§£å¤„ç†å™¨çš„å…¨é™å®šåï¼Œä»¥ä¾¿ç¼–è¯‘å™¨å¯ä»¥æ‰¾åˆ°å®ƒã€‚</li>
</ol>
<p><strong>æ³¨è§£å¤„ç†å™¨ API</strong></p>
<p>javax.annotation.processing åŒ…æä¾›äº†ä¸€äº› APIï¼Œç”¨äºåœ¨æ³¨è§£å¤„ç†å™¨ä¸­è®¿é—®å’Œå¤„ç†æ³¨è§£ä¿¡æ¯ï¼š</p>
<ul>
<li><strong>ProcessingEnvironment:</strong> æä¾›è®¿é—®ç¼–è¯‘å™¨ç¯å¢ƒçš„æ–¹æ³•ï¼Œä¾‹å¦‚è·å– Elementsã€Typesã€Filer ç­‰å¯¹è±¡ã€‚</li>
<li><strong>Elements:</strong> è¡¨ç¤ºç¨‹åºå…ƒç´ çš„æ¥å£ï¼Œä¾‹å¦‚åŒ…ã€ç±»ã€æ–¹æ³•ã€å­—æ®µç­‰ã€‚</li>
<li><strong>Types:</strong> æä¾›ç±»å‹ç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚è·å–ç±»å‹çš„çˆ¶ç±»ã€æ¥å£ç­‰ã€‚</li>
<li><strong>Filer:</strong> ç”¨äºåˆ›å»ºæ–°çš„æºæ–‡ä»¶æˆ–èµ„æºæ–‡ä»¶ã€‚</li>
</ul>
<h2 id="åŒ¿åå†…éƒ¨ç±»ä¸Lambdaè¡¨è¾¾å¼">åŒ¿åå†…éƒ¨ç±»ä¸Lambdaè¡¨è¾¾å¼</h2>
<ul>
<li><strong>Lambda è¡¨è¾¾å¼æ²¡æœ‰è‡ªå·±çš„ this æŒ‡é’ˆã€‚</strong> åœ¨ Lambda è¡¨è¾¾å¼å†…éƒ¨ï¼Œthis å…³é”®å­—ä»ç„¶æŒ‡å‘å¤–éƒ¨ç±»å®ä¾‹ã€‚</li>
<li><strong>Lambda è¡¨è¾¾å¼å¯ä»¥éšå¼åœ°è®¿é—®å¤–éƒ¨ç±»çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚</strong></li>
</ul>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<p><strong>å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ã€è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ã€å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ã€è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰</strong></p>
<p><strong>å®Œæ•´ç¤ºä¾‹ï¼šå¯¹æ¯”å››ç§å¼•ç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReferenceExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 1. å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">strongRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>(); </span><br><span class="line">        System.out.println(<span class="string">&quot;å¼ºå¼•ç”¨åˆ›å»º: &quot;</span> + strongRef);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰</span></span><br><span class="line">        SoftReference&lt;Object&gt; softRef = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        System.out.println(<span class="string">&quot;è½¯å¼•ç”¨åˆ›å»º: &quot;</span> + softRef.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰</span></span><br><span class="line">        WeakReference&lt;Object&gt; weakRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼±å¼•ç”¨åˆ›å»º: &quot;</span> + weakRef.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰ï¼Œéœ€è¦ ReferenceQueue</span></span><br><span class="line">        ReferenceQueue&lt;Object&gt; refQueue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">        PhantomReference&lt;Object&gt; phantomRef = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>(), refQueue);</span><br><span class="line">        System.out.println(<span class="string">&quot;è™šå¼•ç”¨åˆ›å»º: &quot;</span> + phantomRef.get()); <span class="comment">// æ°¸è¿œæ˜¯ null</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘ GC</span></span><br><span class="line">        System.gc();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>); <span class="comment">// ç­‰å¾… GC æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å° GC ä¹‹åçš„æƒ…å†µ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;GC åå¼ºå¼•ç”¨: &quot;</span> + strongRef);</span><br><span class="line">        System.out.println(<span class="string">&quot;GC åè½¯å¼•ç”¨: &quot;</span> + softRef.get()); <span class="comment">// å¯èƒ½å­˜åœ¨</span></span><br><span class="line">        System.out.println(<span class="string">&quot;GC åå¼±å¼•ç”¨: &quot;</span> + weakRef.get()); <span class="comment">// ä¸€å®šè¢«å›æ”¶</span></span><br><span class="line">        System.out.println(<span class="string">&quot;GC åè™šå¼•ç”¨: &quot;</span> + phantomRef.get()); <span class="comment">// ä»ç„¶æ˜¯ null</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥ ReferenceQueue é‡Œæ˜¯å¦æœ‰å¯¹è±¡è¢«å›æ”¶</span></span><br><span class="line">        Reference&lt;?&gt; ref = refQueue.poll();</span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è™šå¼•ç”¨å¯¹è±¡å·²è¢« GC å›æ”¶ï¼Œå¹¶åŠ å…¥ ReferenceQueue&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è™šå¼•ç”¨å¯¹è±¡å°šæœªè¢« GC å›æ”¶&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯èƒ½è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å¼ºå¼•ç”¨åˆ›å»º: java.lang.Object@7d4991ad</span><br><span class="line">è½¯å¼•ç”¨åˆ›å»º: java.lang.Object@28d93b30</span><br><span class="line">å¼±å¼•ç”¨åˆ›å»º: java.lang.Object@1b6d3586</span><br><span class="line">è™šå¼•ç”¨åˆ›å»º: null</span><br><span class="line">GC åå¼ºå¼•ç”¨: java.lang.Object@7d4991ad</span><br><span class="line">GC åè½¯å¼•ç”¨: java.lang.Object@28d93b30</span><br><span class="line">GC åå¼±å¼•ç”¨: null</span><br><span class="line">GC åè™šå¼•ç”¨: null</span><br><span class="line">è™šå¼•ç”¨å¯¹è±¡å·²è¢« GC å›æ”¶ï¼Œå¹¶åŠ å…¥ ReferenceQueue</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>è§£æ</strong></p>
<p><strong>1. å¼ºå¼•ç”¨</strong></p>
<ul>
<li>å˜é‡ <code>strongRef</code> ç›´æ¥æŒæœ‰ <code>new Object()</code>ï¼Œæ‰€ä»¥å³ä½¿ GC è¿è¡Œï¼Œå®ƒä»ç„¶ä¸ä¼šè¢«å›æ”¶ã€‚</li>
<li>å¼ºå¼•ç”¨æŒ‡çš„æ˜¯é€šè¿‡ <code>new</code> å¯¹è±¡åˆ›å»ºçš„å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨å³ä½¿æ˜¯å†…å­˜ä¸è¶³ä¹Ÿä¸ä¼šå›æ”¶å¼ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ã€‚</li>
</ul>
<p><strong>2. è½¯å¼•ç”¨</strong></p>
<ul>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒGC å <code>softRef.get()</code> ä»ç„¶ä¸ä¸º <code>null</code>ï¼Œè¯´æ˜å¯¹è±¡æ²¡æœ‰è¢«å›æ”¶ã€‚</li>
<li>è½¯å¼•ç”¨æ˜¯é€šè¿‡ <code>SoftRefrence</code> å®ç°çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ¯”å¼ºå¼•ç”¨çŸ­ï¼Œåœ¨å†…å­˜ä¸è¶³ï¼ŒæŠ›å‡ºOOMä¹‹å‰ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå›æ”¶è½¯å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡ã€‚è½¯å¼•ç”¨å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯å­˜å‚¨ä¸€äº›å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ã€‚</li>
</ul>
<p><strong>3. å¼±å¼•ç”¨</strong></p>
<ul>
<li><code>weakRef</code> åªè¢« <code>WeakReference</code> æŒæœ‰ï¼Œæ²¡æœ‰å¼ºå¼•ç”¨å­˜åœ¨ï¼Œæ‰€ä»¥ <strong>GC è¿è¡Œæ—¶ç«‹å³å›æ”¶</strong>ï¼Œå¯¼è‡´ <code>weakRef.get()</code> å˜æˆ <code>null</code>ã€‚</li>
<li>å¼±å¼•ç”¨æ˜¯é€šè¿‡ <code>WeakRefrence</code> å®ç°çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ¯”è½¯å¼•ç”¨è¿˜çŸ­ï¼ŒGCåªè¦æ‰«æåˆ°å¼±å¼•ç”¨çš„å¯¹è±¡å°±ä¼šå›æ”¶ã€‚å¼±å¼•ç”¨å¸¸è§çš„ä½¿ç”¨åœºæ™¯ä¹Ÿæ˜¯å­˜å‚¨ä¸€äº›å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ã€‚</li>
</ul>
<p><strong>4. è™šå¼•ç”¨</strong></p>
<ul>
<li><code>phantomRef.get()</code> <strong>å§‹ç»ˆè¿”å› <code>null</code></strong>ï¼Œæ‰€ä»¥ç›´æ¥æ‰“å° <code>null</code>ã€‚</li>
<li>ä½†æ˜¯ï¼ŒGC è¿è¡Œæ—¶ï¼Œ<code>phantomRef</code> è¢«æ”¾å…¥ <code>ReferenceQueue</code>ï¼Œè¯´æ˜å¯¹è±¡å·²è¢«é”€æ¯ã€‚</li>
<li>è™šå¼•ç”¨æ˜¯é€šè¿‡ <code>FhantomReference</code> å®ç°çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæœ€çŸ­ï¼Œéšæ—¶å¯èƒ½è¢«å›æ”¶ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åªè¢«è™šå¼•ç”¨å¼•ç”¨ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è®¿é—®è¿™ä¸ªå¯¹è±¡çš„ä»»ä½•å±æ€§å’Œæ–¹æ³•ã€‚å®ƒçš„ä½œç”¨ä»…ä»…æ˜¯ä¿è¯å¯¹è±¡åœ¨finalizeåï¼ŒåšæŸäº›äº‹æƒ…ã€‚è™šå¼•ç”¨å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨ï¼Œå½“ä¸€ä¸ªè™šå¼•ç”¨å…³è”çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ä¹‹å‰ä¼šæ”¶åˆ°ä¸€æ¡ç³»ç»Ÿé€šçŸ¥ã€‚</li>
</ul>
<p><strong>å®é™…åº”ç”¨åœºæ™¯</strong></p>
<p><strong>1. è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šç”¨äºç¼“å­˜</strong></p>
<ul>
<li>é€‚ç”¨äº<strong>å›¾ç‰‡ç¼“å­˜</strong>ï¼Œå¦‚ Android çš„ Bitmap ç¼“å­˜ï¼Œä¿è¯å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SoftReference&lt;<span class="type">byte</span>[]&gt; imageCache = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(loadImage());</span><br></pre></td></tr></table></figure>
<p><strong>2. å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šWeakHashMap</strong></p>
<ul>
<li>é€‚ç”¨äº<strong>å¼±å¼•ç”¨ç¼“å­˜</strong>ï¼Œå¦‚ <code>WeakHashMap</code>ï¼Œå½“æ²¡æœ‰å…¶ä»–å¼ºå¼•ç”¨æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤ç¼“å­˜é¡¹ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">WeakHashMap&lt;String, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">cache.put(<span class="string">&quot;key&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br></pre></td></tr></table></figure>
<p><strong>3. è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šç®¡ç†èµ„æº</strong></p>
<ul>
<li>ç”¨äºè·Ÿè¸ªå¯¹è±¡ä½•æ—¶è¢«å›æ”¶ï¼Œä¾‹å¦‚<strong>å®‰å…¨é‡Šæ”¾æ–‡ä»¶ã€å…³é—­æ•°æ®åº“è¿æ¥ç­‰</strong>ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PhantomReference&lt;Object&gt; phantom = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;&gt;(obj, refQueue);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>å¼ºå¼•ç”¨</strong>ï¼šæ™®é€šå¼•ç”¨ï¼ŒGC ä¸ä¼šå›æ”¶ã€‚</li>
<li><strong>è½¯å¼•ç”¨</strong>ï¼šç”¨äºç¼“å­˜ï¼Œå†…å­˜ä¸è¶³æ—¶å›æ”¶ã€‚</li>
<li><strong>å¼±å¼•ç”¨</strong>ï¼šç”¨äº <code>WeakHashMap</code>ï¼ŒGC å‘ç°å°±å›æ”¶ã€‚</li>
<li><strong>è™šå¼•ç”¨</strong>ï¼šå¯¹è±¡é”€æ¯æ—¶æ‰§è¡Œæ¸…ç†ä»»åŠ¡ã€‚</li>
</ul>
<h2 id="JUC">JUC</h2>
<h3 id="JMM">JMM</h3>
<p>Java Memory Modelï¼ŒJavaå†…å­˜æ¨¡å‹ï¼Œå…³äºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å…±äº«å˜é‡å¯è§æ€§ã€æŒ‡ä»¤é‡æ’ç­‰æ–¹å¼çš„è®¾è®¡</p>
<p>Javaä½¿ç”¨<strong>å…±äº«å†…å­˜å¹¶å‘æ¨¡å‹</strong></p>
<p>åœ¨å…±äº«å†…å­˜å¹¶å‘æ¨¡å‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹å…±äº«åŒä¸€å—å†…å­˜åŒºåŸŸï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è¯»å–å’Œå†™å…¥è¿™äº›å…±äº«å†…å­˜ä¸­çš„æ•°æ®ã€‚ä¸ºäº†ç¡®ä¿å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨é”ï¼ˆå¦‚äº’æ–¥é”ã€è¯»å†™é”ç­‰ï¼‰æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶ã€‚</p>
<blockquote>
<p>å­˜åœ¨å…¶ä»–å¹¶å‘å†…å­˜æ¨¡å‹ï¼šæ¶ˆæ¯ä¼ é€’å¹¶å‘æ¨¡å‹</p>
<p>åœ¨æ¶ˆæ¯ä¼ é€’å¹¶å‘æ¨¡å‹ä¸­ï¼Œçº¿ç¨‹æˆ–è¿›ç¨‹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡ã€‚æ¯ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç§æœ‰å†…å­˜åŒºåŸŸï¼Œä¸èƒ½ç›´æ¥è®¿é—®å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹çš„å†…å­˜ã€‚å½“éœ€è¦äº¤æ¢ä¿¡æ¯æ—¶ï¼Œå®ƒä»¬é€šè¿‡æ¶ˆæ¯ä¼ é€’æœºåˆ¶æ¥è¿›è¡Œã€‚è¿™ç§æ¨¡å‹ä¸æ¶‰åŠå…±äº«å†…å­˜ï¼Œå› æ­¤ä¸éœ€è¦é”ç­‰åŒæ­¥æœºåˆ¶ï¼Œé€šå¸¸æ›´æ˜“äºé¿å…ç«æ€æ¡ä»¶ã€‚</p>
</blockquote>
<p><strong>ç‰¹æ€§</strong></p>
<ul>
<li>å¯è§æ€§ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹ç«‹å³å¯è§ï¼ˆé€šè¿‡ <code>volatile</code> å…³é”®å­—å®ç°ï¼‰</li>
<li>åŸå­æ€§ï¼šæ“ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œä¸ä¼šè¢«å…¶ä»–æ“ä½œæ‰“æ–­ï¼ˆç¦æ­¢å¯¹ <code>volatile</code> å˜é‡çš„æ“ä½œè¿›è¡ŒæŒ‡ä»¤é‡æ’åºï¼‰</li>
<li>æœ‰åºæ€§ï¼šç¨‹åºæ‰§è¡Œé¡ºåºæŒ‰ç…§ä»£ç å…ˆåé¡ºåºæ‰§è¡Œï¼ˆé€šè¿‡å…³é”®å­— <code>synchronized</code> å’Œ <code>volatile</code> å®ç°ï¼‰</li>
</ul>
<blockquote>
<p>volatile ç¦æ­¢æŒ‡ä»¤é‡æ’</p>
<p>volatile ä¿®é¥°å˜é‡è¦ä¹ˆåœ¨å †ï¼Œè¦ä¹ˆåœ¨å…ƒç©ºé—´</p>
<p>å‡†ç¡®æ¥è¯´ä¸æ˜¯ç¦æ­¢äº†æŒ‡ä»¤é‡æ’ï¼Œè€Œæ˜¯ç¡®ä¿volatileå…³é”®å­—ä¿®é¥°çš„å˜é‡çš„å†™å…¥æŒ‡ä»¤ä¹‹å‰çš„æŒ‡ä»¤é‡æ’åä»åœ¨å…¶ä¹‹å‰ï¼Œvolatileå…³é”®å­—ä¿®é¥°çš„å˜é‡çš„è¯»å–æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤é‡æ’åä»åœ¨å…¶ä¹‹å</p>
<ul>
<li>å½“ç¨‹åºæ‰§è¡Œåˆ° volatile å˜é‡çš„è¯»æ“ä½œæˆ–è€…å†™æ“ä½œæ—¶ï¼Œåœ¨å…¶å‰é¢æ“ä½œçš„æ›´æ”¹è‚¯å®šå·²ç»å…¨éƒ¨è¿›è¡Œï¼Œä¸”ç»“æœå¯¹åé¢çš„æ“ä½œå¯è§ï¼›åœ¨å…¶åé¢çš„æ“ä½œè‚¯å®šè¿˜æ²¡æœ‰è¿›è¡Œï¼›</li>
<li>åœ¨è¿›è¡ŒæŒ‡ä»¤ä¼˜åŒ–æ—¶ï¼Œä¸èƒ½å°† volatile å˜é‡çš„è¯­å¥æ”¾åœ¨å…¶åé¢æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½æŠŠ volatile å˜é‡åé¢çš„è¯­å¥æ”¾åˆ°å…¶å‰é¢æ‰§è¡Œã€‚</li>
</ul>
</blockquote>
<p><strong>å†…å­˜</strong></p>
<ul>
<li>ä¸»å†…å­˜ï¼šå †ä¸­å¯¹è±¡å®ä¾‹</li>
<li>å·¥ä½œå†…å­˜ï¼šçº¿ç¨‹æ ˆ</li>
</ul>
<p><strong>Happens-Before å…³ç³»</strong>ï¼š</p>
<ul>
<li><strong>Happens-Before</strong> å…³ç³»æ˜¯ JMM ä¸­å®šä¹‰çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œç¡®ä¿åœ¨æŸäº›æ“ä½œå‘ç”Ÿä¹‹åï¼Œå…¶ä»–æ“ä½œçš„ç»“æœæ˜¯å¯è§çš„ã€‚</li>
<li>æ¯”å¦‚ï¼ŒæŸä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„è¯»æ“ä½œä¹‹å‰å‘ç”Ÿï¼ŒJava ä¿è¯ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„å†™æ“ä½œä¼šåœ¨ç¬¬äºŒä¸ªçº¿ç¨‹çš„è¯»æ“ä½œä¹‹å‰â€œå¯è§â€ã€‚</li>
<li>JMM å®šä¹‰äº†å¤šä¸ªè§„åˆ™æ¥ç¡®å®šæ“ä½œä¹‹é—´çš„ Happens-Before å…³ç³»ï¼Œä¾‹å¦‚ï¼š
<ul>
<li>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ“ä½œæŒ‰ä»£ç é¡ºåºæ‰§è¡Œã€‚</li>
<li>é”è§„åˆ™ï¼šé‡Šæ”¾é”çš„æ“ä½œ happens-before åç»­çš„è·å–é”æ“ä½œã€‚</li>
<li>volatile è§„åˆ™ï¼šå¯¹ä¸€ä¸ª <code>volatile</code> å˜é‡çš„å†™æ“ä½œ happens-before åç»­å¯¹è¯¥å˜é‡çš„è¯»æ“ä½œã€‚</li>
</ul>
</li>
</ul>
<h3 id="ThreadLocal">ThreadLocal</h3>
<p>æ¯ä¸ª<strong>çº¿ç¨‹ç±»</strong>æŒæœ‰ <code>ThreadLocalMap</code> å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Thread ç±»ä¸­çš„å®šä¹‰ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ª ThreadLocalMap å®ä¾‹</span></span><br><span class="line">    ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>ThreadLocalMap</code> ä¸º key-valueç»“æ„</p>
<ul>
<li>
<p>key ä¸º <code>ThreadLocal</code> å¯¹è±¡ï¼Œå¼±å¼•ç”¨</p>
</li>
<li>
<p>value ä¸º é€šè¿‡ <code>threadLocal.set()</code> è®¾ç½®çš„å€¼ï¼Œå¼ºå¼•ç”¨</p>
</li>
</ul>
<p>ç”±äºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹<strong>å¤ç”¨</strong>ï¼Œçº¿ç¨‹ä»»åŠ¡ç»“æŸåï¼Œå¯èƒ½å‡ºç° key çš„ <code>ThreadLocal</code> å¯¹è±¡è¢«å›æ”¶ï¼Œ<code>ThreadLocalMap</code> ä¸­çš„ value ä»ç„¶å­˜åœ¨çš„æƒ…å†µã€‚</p>
<p>ç”±äº key å·²ç»è¢«å›æ”¶ï¼Œ<code>ThreadLocalMap</code> ä¸­çš„ entry ä¼šå˜æˆ <strong>key = null, value = Object</strong> çš„çŠ¶æ€ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>value</code> æ— æ³•è¢«åƒåœ¾å›æ”¶ï¼Œå› ä¸ºçº¿ç¨‹ä»ç„¶æŒæœ‰å¯¹ <code>ThreadLocalMap</code> çš„å¼•ç”¨ï¼Œè€Œ <code>ThreadLocalMap</code> ä»ç„¶å¼•ç”¨ç€ <code>Object</code> å¯¹è±¡ã€‚å¦‚æœ <code>Object</code> å¯¹è±¡å ç”¨è¾ƒå¤§å†…å­˜ï¼ˆå¦‚ <code>byte[] info</code> åˆ†é…äº† 1MBï¼‰ï¼Œåœ¨é•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨ä¸­ï¼Œè¿™ç§å†…å­˜æ³„æ¼ä¼šå¯¼è‡´å†…å­˜ä¸æ–­å¢é•¿ï¼Œæœ€ç»ˆå¼•å‘ <code>OutOfMemoryError</code>ã€‚</p>
<h3 id="é”">é”</h3>
<h4 id="é”åˆ†ç±»">é”åˆ†ç±»</h4>
<p><strong>å…¬å¹³é”ä¸éå…¬å¹³é”</strong></p>
<p><strong>å…¬å¹³é”</strong>æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œçº¿ç¨‹ç›´æ¥è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œé˜Ÿåˆ—ä¸­æœ€å…ˆåˆ°çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚<strong>éå…¬å¹³é”</strong>æ˜¯å¤šä¸ªçº¿ç¨‹åŠ é”æ—¶æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå…ˆå»å°è¯•è·å–é”ï¼Œå¦‚æœåˆšå¥½è·å–åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œç›´æ¥æ‰§è¡Œï¼Œå¦‚æœè·å–ä¸åˆ°é”æ‰ä¼šè¢«åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾ç­‰å¾…æ‰§è¡Œã€‚</p>
<p><strong>æ’ä»–é”ä¸å…±äº«é”</strong></p>
<p><strong>æ’ä»–é”</strong>ä¹Ÿå«ç‹¬å é”ï¼Œæ˜¯æŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¦‚æœçº¿ç¨‹Tå¯¹æ•°æ®AåŠ ä¸Šæ’å®ƒé”åï¼Œåˆ™å…¶ä»–çº¿ç¨‹ä¸èƒ½å†å¯¹AåŠ ä»»ä½•ç±»å‹çš„é”ã€‚è·å¾—æ’å®ƒé”çš„çº¿ç¨‹å³èƒ½è¯»æ•°æ®åˆèƒ½ä¿®æ”¹æ•°æ®ã€‚<strong>å…±äº«é”</strong>æ˜¯æŒ‡è¯¥é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¦‚æœçº¿ç¨‹Tå¯¹æ•°æ®AåŠ ä¸Šå…±äº«é”åï¼Œåˆ™å…¶ä»–çº¿ç¨‹åªèƒ½å¯¹Aå†åŠ å…±äº«é”ï¼Œä¸èƒ½åŠ æ’å®ƒé”ã€‚è·å¾—å…±äº«é”çš„çº¿ç¨‹åªèƒ½è¯»æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹æ•°æ®ã€‚</p>
<p><strong>å¯é‡å…¥é”ä¸éå¯é‡å…¥é”</strong></p>
<p><strong>å¯é‡å…¥é” (ReentrantLock):</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œè€Œä¸ä¼šå¯¼è‡´æ­»é”ã€‚</li>
<li><strong>å®ç°æœºåˆ¶:</strong> å¯é‡å…¥é”é€šå¸¸ä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨æ¥è·Ÿè¸ªçº¿ç¨‹è·å–é”çš„æ¬¡æ•°ã€‚
<ul>
<li>å½“çº¿ç¨‹ç¬¬ä¸€æ¬¡è·å–é”æ—¶ï¼Œè®¡æ•°å™¨åŠ  1ã€‚</li>
<li>å¦‚æœåŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å–è¯¥é”ï¼Œè®¡æ•°å™¨ç»§ç»­åŠ  1ã€‚</li>
<li>å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨å‡ 1ã€‚åªæœ‰å½“è®¡æ•°å™¨å˜ä¸º 0 æ—¶ï¼Œé”æ‰ä¼šçœŸæ­£è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½è·å–ã€‚</li>
</ul>
</li>
<li><strong>Java ä¸­çš„å®ç°:</strong> ReentrantLock ç±»ã€synchronized å…³é”®å­—ï¼ˆéšå¼å®ç°ï¼‰ã€‚</li>
</ul>
<p><strong>éå¯é‡å…¥é” (Non-reentrant Lock):</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»è·å–äº†æŸä¸ªé”ï¼Œåœ¨é‡Šæ”¾è¯¥é”ä¹‹å‰ï¼Œä¸èƒ½å†æ¬¡è·å–è¯¥é”ã€‚</li>
<li><strong>Java ä¸­çš„å®ç°:</strong> Java ä¸­æ²¡æœ‰ç›´æ¥æä¾›éå¯é‡å…¥é”çš„å®ç°ï¼Œéœ€è¦å¼€å‘è€…è‡ªè¡Œå®ç°ã€‚</li>
</ul>
<p><strong>ä¹è§‚é”ä¸æ‚²è§‚é”</strong></p>
<p><strong>ä¹è§‚é” (Optimistic Lock):</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> ä¹è§‚åœ°è®¤ä¸ºå¹¶å‘å†²çªå‘ç”Ÿçš„æ¦‚ç‡è¾ƒä½ï¼Œå› æ­¤ä¸ä¼šä¸€å¼€å§‹å°±åŠ é”ï¼Œè€Œæ˜¯ <strong>åœ¨æ›´æ–°æ•°æ®æ—¶æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å†²çª</strong>ã€‚</li>
<li><strong>å®ç°æœºåˆ¶:</strong> é€šå¸¸ä½¿ç”¨ <strong>ç‰ˆæœ¬å·</strong> æˆ– <strong>æ—¶é—´æˆ³</strong> æ¥æ£€æµ‹å†²çªã€‚
<ul>
<li>åœ¨è¯»å–æ•°æ®æ—¶ï¼Œè·å–æ•°æ®çš„ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ã€‚</li>
<li>åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œæ¯”è¾ƒå½“å‰ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ä¸ä¹‹å‰è·å–çš„æ˜¯å¦ä¸€è‡´ã€‚</li>
<li>å¦‚æœä¸€è‡´ï¼Œåˆ™æ›´æ–°æ•°æ®ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†å†²çªï¼Œéœ€è¦è¿›è¡Œå¤„ç†ï¼ˆä¾‹å¦‚é‡è¯•æˆ–å›æ»šï¼‰ã€‚</li>
</ul>
</li>
<li><strong>Java ä¸­çš„å®ç°:</strong> å¯ä»¥ä½¿ç”¨ AtomicIntegerã€AtomicLong ç­‰åŸå­ç±»å®ç°ä¹è§‚é”ï¼Œæˆ–è€…ä½¿ç”¨ CAS (Compare and Swap) æ“ä½œå®ç°ã€‚</li>
</ul>
<p><strong>æ‚²è§‚é” (Pessimistic Lock):</strong></p>
<ul>
<li><strong>å®šä¹‰:</strong> æ‚²è§‚åœ°è®¤ä¸ºå¹¶å‘å†²çªå‘ç”Ÿçš„æ¦‚ç‡è¾ƒé«˜ï¼Œå› æ­¤ <strong>åœ¨æ“ä½œæ•°æ®æ—¶éƒ½ä¼šå…ˆè·å–é”</strong>ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åŒæ—¶è®¿é—®æˆ–ä¿®æ”¹æ•°æ®ã€‚</li>
<li><strong>å®ç°æœºåˆ¶:</strong> é€šå¸¸ä½¿ç”¨ <strong>äº’æ–¥é”</strong> æ¥å®ç°ï¼Œä¾‹å¦‚ Java ä¸­çš„ synchronized å…³é”®å­—å’Œ ReentrantLock ç±»ã€‚</li>
<li><strong>Java ä¸­çš„å®ç°:</strong> synchronized å…³é”®å­—ã€ReentrantLock ç±»ç­‰ã€‚</li>
</ul>
<p><strong>å¯ä¸­æ–­é”ä¸ä¸å¯ä¸­æ–­é”</strong></p>
<p><strong>å¯ä¸­æ–­é”</strong>ï¼šè·å–é”çš„è¿‡ç¨‹ä¸­å¯ä»¥è¢«ä¸­æ–­ï¼Œä¸éœ€è¦ä¸€ç›´ç­‰åˆ°è·å–é”ä¹‹å æ‰èƒ½è¿›è¡Œå…¶ä»–é€»è¾‘å¤„ç†ã€‚<code>ReentrantLock</code> å°±å±äºæ˜¯å¯ä¸­æ–­é”ã€‚</p>
<p><strong>ä¸å¯ä¸­æ–­é”</strong>ï¼šä¸€æ—¦çº¿ç¨‹ç”³è¯·äº†é”ï¼Œå°±åªèƒ½ç­‰åˆ°æ‹¿åˆ°é”ä»¥åæ‰èƒ½è¿›è¡Œå…¶ä»–çš„é€»è¾‘å¤„ç†ã€‚ <code>synchronized</code> å°±å±äºæ˜¯ä¸å¯ä¸­æ–­é”ã€‚</p>
<h4 id="é”çŠ¶æ€">é”çŠ¶æ€</h4>
<blockquote>
<p>é”å‡çº§åå¸Œæœ›è·å¾—è¿™ä¸ªé”çš„çº¿ç¨‹å‡éœ€è¦é‡æ–°ç«äº‰è¯¥é”ï¼ŒåŒ…æ‹¬åŸæœ¬å°±æŒæœ‰è¯¥é”çš„çº¿ç¨‹ï¼›</p>
<p>CAS æ“ä½œçš„æœŸæœ›å€¼ä¸ºç©ºï¼Œå½“å‰å€¼ä¸ºç©ºæˆ–è€…æŒæœ‰è¯¥é”çš„çº¿ç¨‹ID/æŒ‡é’ˆï¼Œä¿®æ”¹å€¼ä¸ºè‡ªå·±çš„çº¿ç¨‹ID/æŒ‡é’ˆ</p>
</blockquote>
<p>javaä¸­çš„é”æ˜¯é’ˆå¯¹äºå¯¹è±¡çš„ï¼›å½“å¯¹è±¡çŠ¶æ€ä¸ºåå‘é”æ—¶ï¼Œ<code>Mark Word</code>å­˜å‚¨çš„æ˜¯åå‘çš„çº¿ç¨‹ IDï¼›å½“çŠ¶æ€ä¸ºè½»é‡çº§é”æ—¶ï¼Œ<code>Mark Word</code>å­˜å‚¨çš„æ˜¯æŒ‡å‘çº¿ç¨‹æ ˆä¸­<code>Lock Record</code>çš„æŒ‡é’ˆï¼›å½“çŠ¶æ€ä¸ºé‡é‡çº§é”æ—¶ï¼Œ<code>Mark Word</code>ä¸ºæŒ‡å‘å †ä¸­çš„ monitorï¼ˆç›‘è§†å™¨ï¼‰å¯¹è±¡çš„æŒ‡é’ˆã€‚</p>
<p><strong>Mark Word</strong>ï¼šè¿™æ˜¯å¯¹è±¡å¤´çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡çš„å“ˆå¸Œç ã€GC åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€åå‘é”çº¿ç¨‹ IDã€åå‘æ—¶é—´æˆ³ç­‰ä¿¡æ¯ã€‚å…¶ä¸­ï¼Œé”çŠ¶æ€æ ‡å¿—ä½å°±æŒ‡ç¤ºäº†å½“å‰å¯¹è±¡æ˜¯å¦è¢«é”å®šä»¥åŠé”çš„ç±»å‹ã€‚</p>
<table>
<thead>
<tr>
<th>é”çŠ¶æ€</th>
<th>29 bit æˆ– 61 bit</th>
<th>1 bit æ˜¯å¦æ˜¯åå‘é”ï¼Ÿ</th>
<th>2 bit é”æ ‡å¿—ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— é”</td>
<td></td>
<td>0</td>
<td>01</td>
</tr>
<tr>
<td>åå‘é”</td>
<td>çº¿ç¨‹ ID</td>
<td>1</td>
<td>01</td>
</tr>
<tr>
<td>è½»é‡çº§é”</td>
<td>æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ</td>
<td>æ­¤æ—¶è¿™ä¸€ä½ä¸ç”¨äºæ ‡è¯†åå‘é”</td>
<td>00</td>
</tr>
<tr>
<td>é‡é‡çº§é”</td>
<td>æŒ‡å‘äº’æ–¥é‡ï¼ˆé‡é‡çº§é”ï¼‰çš„æŒ‡é’ˆ</td>
<td>æ­¤æ—¶è¿™ä¸€ä½ä¸ç”¨äºæ ‡è¯†åå‘é”</td>
<td>10</td>
</tr>
<tr>
<td>GC æ ‡è®°</td>
<td></td>
<td>æ­¤æ—¶è¿™ä¸€ä½ä¸ç”¨äºæ ‡è¯†åå‘é”</td>
<td>11</td>
</tr>
</tbody>
</table>
<p><strong>æ— é”çŠ¶æ€ï¼š</strong></p>
<p>å¯¹è±¡æœªè¢«ä»»ä½•çº¿ç¨‹é”å®šã€‚</p>
<p><strong>åå‘é”çŠ¶æ€ï¼š</strong></p>
<blockquote>
<p>è‡ªç”¨è‡ªå‡º</p>
</blockquote>
<p>ç¬¬ä¸€æ¬¡è¿›å…¥åŒæ­¥å—æ—¶ï¼š</p>
<ul>
<li>å½“ <code>Thread-1</code> ç¬¬ä¸€æ¬¡è¿›å…¥ <code>exampleMethod()</code> æ–¹æ³•æ—¶ï¼Œä¼šè¯·æ±‚è·å– <code>exampleMethod()</code> çš„é”ã€‚æ­¤æ—¶ï¼ŒJVM ä¼šä¸ºè¯¥çº¿ç¨‹åˆ›å»ºä¸€ä¸ªåå‘é”ï¼Œå¹¶åœ¨ <code>BiasedLockExample </code> å®ä¾‹çš„å¯¹è±¡å¤´çš„ <code>Mark Word</code> ä¸­è®°å½•ä¸‹ <code>Thread-1</code> çš„çº¿ç¨‹ IDã€‚</li>
</ul>
<p>ç¬¬äºŒæ¬¡è¿›å…¥åŒæ­¥å—æ—¶ï¼š</p>
<ul>
<li>å¦‚æœåŒä¸€ä¸ªçº¿ç¨‹ <code>Thread-1</code> å†æ¬¡è®¿é—® <code>exampleMethod()</code> æ–¹æ³•ï¼Œç”±äº <code>Mark Word</code> ä¸­è®°å½•äº†å®ƒè‡ªå·±çš„çº¿ç¨‹ IDï¼ŒJVM ä¼šç›´æ¥é€šè¿‡æ£€æŸ¥ <code>Mark Word</code> æ¥éªŒè¯è¯¥çº¿ç¨‹å·²ç»æŒæœ‰é”ã€‚å¦‚æœé”ç¡®å®æ˜¯åå‘äº <code>Thread-1</code>ï¼Œåˆ™æ— éœ€ä½¿ç”¨ CAS æ“ä½œæ¥åŠ é”ï¼Œç›´æ¥è¿›å…¥æ–¹æ³•ã€‚</li>
</ul>
<p>å…¶ä»–çº¿ç¨‹å°è¯•è¿›å…¥åŒæ­¥å—æ—¶ï¼š</p>
<ul>
<li>
<p>å½“ <code>Thread-2</code> å°è¯•è¿›å…¥ <code>exampleMethod()</code> æ–¹æ³•æ—¶ï¼Œå®ƒä¼šçœ‹åˆ° <code>Mark Word</code></p>
<p>ä¸­å·²ç»è®°å½•äº† <code>Thread-1</code> çš„çº¿ç¨‹ IDï¼Œè¿™å°±è¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰è¯¥é”ã€‚æ­¤æ—¶ä¼šè¿›è¡Œå¦‚ä¸‹çš„æ“ä½œï¼š</p>
<ul>
<li>CAS æ“ä½œï¼šJVM ä¼šå°è¯•ä½¿ç”¨ CAS æ¥å°† <code>Mark Word</code> ä¸­çš„çº¿ç¨‹ ID æ›¿æ¢æˆ <code>Thread-2</code> çš„çº¿ç¨‹ IDã€‚</li>
<li>æˆåŠŸï¼šå¦‚æœ <code>Thread-1</code> å·²ç»é€€å‡ºå¹¶é‡Šæ”¾äº†é”ï¼ˆä¾‹å¦‚å®ƒå·²ç»æ‰§è¡Œå®Œæ¯•ï¼‰ï¼Œ<code>Mark Word</code> ä¼šæˆåŠŸæ›´æ–°ä¸º <code>Thread-2</code> çš„çº¿ç¨‹ IDã€‚æ­¤æ—¶ï¼Œé”ä»ç„¶æ˜¯åå‘é”ï¼Œ<code>Thread-2</code> å¯ä»¥ç»§ç»­æ‰§è¡Œè¯¥åŒæ­¥å—çš„ä»£ç ï¼Œä¸éœ€è¦è¿›è¡Œå…¶ä»–å¤æ‚çš„åŠ é”æ“ä½œã€‚</li>
<li>å¤±è´¥ï¼šå¦‚æœ <code>Thread-1</code> ä»ç„¶æŒæœ‰é”ï¼ˆå³å®ƒæ²¡æœ‰é€€å‡ºæ–¹æ³•ï¼‰ï¼ŒCAS æ“ä½œä¼šå¤±è´¥ã€‚æ­¤æ—¶ï¼Œ JVM ä¼šåœ¨ä¸€ä¸ª<strong>å®‰å…¨ç‚¹</strong>æš‚åœ <code>Thread-1</code> çš„æ‰§è¡Œï¼Œæ’¤é”€åå‘é”ä¸é”å‡çº§ï¼Œæ¢å¤ <code>Thread-1</code>  çš„æ‰§è¡Œï¼›æ­¤æ—¶ï¼Œ<code>Thread-1</code> å’Œ <code>Thread-2</code> å‡ä¸å†æŒæœ‰è¯¥é”ï¼Œè¯¥é”çŠ¶æ€ä¸ºè½»é‡çº§é”æ— æ‰€å±çº¿ç¨‹çŠ¶æ€ï¼›<strong>çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 é‡æ–°ç«äº‰è½»é‡çº§é”</strong>ï¼Œ æ¥ä¸‹æ¥çš„é”ç«äº‰ä¼šä½¿ç”¨è½»é‡çº§é”çš„æœºåˆ¶æ¥è¿›è¡Œï¼ˆé€šè¿‡è‡ªæ—‹ç­‰æ–¹å¼è¿›è¡Œäº‰æŠ¢ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p><strong>æ’¤é”€åå‘é”çš„è¿‡ç¨‹</strong>ï¼š</p>
<ul>
<li>JVM ä¼šéå† <code>Thread-1</code> çš„æ ˆå¸§ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨é”è®°å½•ã€‚å¦‚æœå­˜åœ¨ï¼ŒJVM ä¼šæ¸…é™¤ä¸åå‘é”ç›¸å…³çš„é”è®°å½•ï¼Œå¹¶ä¸”ä¼šå°† <code>Mark Word</code> ä¸­ä¿å­˜çš„ <code>Thread-1</code> çš„çº¿ç¨‹ ID ç½®ä¸º <code>0</code>ï¼Œè¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”ã€‚</li>
<li><strong>é‡ç½®åå‘é”æ ‡è¯†</strong>ï¼šåå‘é”çš„æ ‡è¯†ä½ä¼šè¢«é‡ç½®ä¸º <code>00</code>ï¼Œå³è¡¨ç¤ºæ²¡æœ‰æŒæœ‰é”ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•çº¿ç¨‹å ç”¨è¯¥é”ã€‚</li>
</ul>
<p><strong>è½»é‡çº§é”çŠ¶æ€ï¼š</strong></p>
<blockquote>
<p>å…¶ä»–çº¿ç¨‹casæŠ¢é”</p>
</blockquote>
<p>JVM ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­åˆ›å»ºç”¨äºå­˜å‚¨é”è®°å½•çš„ç©ºé—´ï¼Œæˆ‘ä»¬ç§°ä¸º Displaced Mark Wordã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è·å¾—é”çš„æ—¶å€™å‘ç°æ˜¯è½»é‡çº§é”ï¼Œä¼šæŠŠé”çš„ Mark Word å¤åˆ¶åˆ°è‡ªå·±çš„ Displaced Mark Word é‡Œé¢ã€‚</p>
<p>ç„¶åçº¿ç¨‹å°è¯•ç”¨ CAS å°†é”çš„ Mark Word æ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¡¨ç¤º Mark Word å·²ç»è¢«æ›¿æ¢æˆäº†å…¶ä»–çº¿ç¨‹çš„é”è®°å½•ï¼Œè¯´æ˜åœ¨ä¸å…¶å®ƒçº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹å°±å°è¯•ä½¿ç”¨è‡ªæ—‹æ¥è·å–é”ã€‚</p>
<p><strong>è½»é‡çº§é”çš„ç«äº‰è¿‡ç¨‹ï¼š</strong></p>
<ul>
<li><strong>è‡ªæ—‹</strong>ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ï¼ˆå¦‚ <code>Thread-1</code> æˆ– <code>Thread-2</code>ï¼‰å°è¯•è·å–è½»é‡çº§é”æ—¶ï¼Œå®ƒä¼šé¦–å…ˆæ£€æŸ¥ <code>Mark Word</code>ï¼Œå¹¶é€šè¿‡ <strong>CAS æ“ä½œ</strong> å°è¯•å°† <code>Mark Word</code> ä¸­çš„å€¼ä¿®æ”¹ä¸ºæŒ‡å‘è‡ªå·±çº¿ç¨‹æ ˆä¸­çš„é”è®°å½•ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªæŒ‡å‘æ ˆå¸§çš„æŒ‡é’ˆï¼‰ã€‚</li>
<li>å¦‚æœ <strong>CAS æˆåŠŸ</strong>ï¼Œè¯¥çº¿ç¨‹å°±æˆåŠŸè·å–é”ï¼Œå¹¶ä¸”è¿›å…¥åŒæ­¥å—ã€‚</li>
<li>å¦‚æœ <strong>CAS å¤±è´¥</strong>ï¼ˆè¡¨ç¤ºå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»æˆåŠŸè·å¾—äº†é”ï¼‰ï¼Œçº¿ç¨‹ä¼šç»§ç»­è‡ªæ—‹ï¼Œå°è¯•å†æ¬¡è·å–é”ã€‚è‡ªæ—‹æ“ä½œæ˜¯ä¸€ç§è½»é‡çº§çš„äº‰ç”¨æœºåˆ¶ï¼Œé€šå¸¸ä¼šåœ¨çŸ­æ—¶é—´å†…å°è¯•å¤šæ¬¡ï¼Œé¿å…ç³»ç»Ÿè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li>
</ul>
<p><strong>å¦‚æœè‡ªæ—‹å¤±è´¥</strong>ï¼š</p>
<ul>
<li>å¦‚æœè‡ªæ—‹çš„æ¬¡æ•°è¿‡å¤šï¼Œæˆ–è€…å¤šä¸ªçº¿ç¨‹æŒç»­äº‰æŠ¢è¯¥é”ï¼Œè½»é‡çº§é”ä¼šå‡çº§ä¸º <strong>é‡é‡çº§é”</strong>ï¼ˆä¿®æ”¹é”æ ‡è¯†ä½ä¸º10ï¼‰ï¼›å½“çº¿ç¨‹2åå¤æŠ¢çº¿ç¨‹1æŒæœ‰çš„è½»é‡çº§é”æ—¶ï¼ŒJVMä¼šå°†è¯¥é”å‡çº§ä¸ºé‡é‡çº§é”ã€‚å‡çº§è¿‡ç¨‹ä¸­ï¼ŒJVMä¼šå¼ºåˆ¶æš‚åœçº¿ç¨‹1ï¼Œå¹¶æ’¤é”€å…¶æŒæœ‰çš„è½»é‡çº§é”ï¼Œç„¶åä¸¤ä¸ªçº¿ç¨‹ä¼šé‡æ–°ç«äº‰è¿™ä¸ªé‡é‡çº§é”ã€‚</li>
</ul>
<p><strong>é‡é‡çº§é”çŠ¶æ€ï¼š</strong></p>
<p>å½“å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ªå¯¹è±¡çš„é”ï¼Œå¹¶ä¸”ç«äº‰æ¿€çƒˆæ—¶ï¼Œå°±ä¼šä½¿ç”¨é‡é‡çº§é”ï¼ˆä¾‹å¦‚ ReentrantLockï¼‰ã€‚é‡é‡çº§é”ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§ã€‚</p>
<h3 id="çº¿ç¨‹ä¸åŒæ­¥">çº¿ç¨‹ä¸åŒæ­¥</h3>
<img src="/2025/01/17/Java/image-20240729104740287.png" class="" title="image-20240729104740287">
<p><strong>LockSupport, wait()/notify() å’Œ join()</strong></p>
<p><strong>æœºåˆ¶åŒºåˆ«</strong></p>
<ul>
<li><strong>LockSupport:</strong> åŸºäº<strong>è®¸å¯è¯</strong>æœºåˆ¶ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯è¯ï¼Œpark() æ¶ˆè€—è®¸å¯è¯ï¼Œunpark() é¢å‘è®¸å¯è¯ã€‚</li>
<li><strong>wait()/notify():</strong> åŸºäº<strong>é”å¯¹è±¡</strong>ï¼Œçº¿ç¨‹éœ€è¦å…ˆè·å–é”å¯¹è±¡çš„ç›‘è§†å™¨é”ï¼Œæ‰èƒ½è°ƒç”¨ wait() è¿›å…¥ç­‰å¾…ï¼Œnotify() å”¤é†’ç­‰å¾…ç›¸åŒé”å¯¹è±¡çš„çº¿ç¨‹ã€‚</li>
<li><strong>join():</strong> åŸºäº<strong>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œè®©ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</li>
</ul>
<p><strong>é”ä¾èµ–</strong></p>
<ul>
<li><strong>LockSupport:</strong> ä¸ä¾èµ–äºä»»ä½•é”ï¼Œå¯ä»¥ç›´æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹ã€‚</li>
<li><strong>wait()/notify()</strong> å’Œ **join(): ** éƒ½éœ€è¦åœ¨è·å–é”çš„å‰æä¸‹æ‰èƒ½ä½¿ç”¨ï¼Œå¹¶ä¸” wait()/notify() è¿˜è¦æ±‚æ“ä½œç›¸åŒçš„é”å¯¹è±¡ã€‚</li>
</ul>
<p><strong>ç²¾ç¡®æ€§</strong></p>
<ul>
<li><strong>LockSupport:</strong> å¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’ï¼Œä¾‹å¦‚å¯ä»¥æŒ‡å®šè¦å”¤é†’çš„çº¿ç¨‹ã€‚</li>
<li><strong>wait()/notify():</strong> notify() æ–¹æ³•éšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸å¤Ÿç²¾ç¡®ã€‚</li>
<li><strong>join():</strong> åªèƒ½ç­‰å¾…ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œæ— æ³•å®ç°æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚</li>
</ul>
<p><strong>ä½¿ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>LockSupport:</strong> é€‚ç”¨äºæ›´åº•å±‚çš„çº¿ç¨‹åŒæ­¥åœºæ™¯ï¼Œä¾‹å¦‚å®ç°è‡ªå®šä¹‰åŒæ­¥å·¥å…·ç±»ã€‚</li>
<li><strong>wait()/notify():</strong> é€‚ç”¨äºç»å…¸çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ç­‰åœºæ™¯ã€‚</li>
<li><strong>join():</strong> é€‚ç”¨äºéœ€è¦ç­‰å¾…æŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åå†ç»§ç»­æ‰§è¡Œçš„åœºæ™¯ã€‚</li>
</ul>
<h4 id="Thread-join">Thread.join()</h4>
<blockquote>
<p>è°è°ƒç”¨ThreadX.join()ï¼Œè°åŠ å…¥çº¿ç¨‹Xçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…çº¿ç¨‹Xæ‰§è¡Œå®Œæˆ</p>
</blockquote>
<p><strong>å¯¹äºçº¿ç¨‹ ThreadA å’Œçº¿ç¨‹ ThreadB:</strong></p>
<p>è‹¥ ThreadA åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œ ThreadB.join()ï¼Œ</p>
<p><strong>ThreadA è¿›å…¥ WAITING çŠ¶æ€:</strong> ThreadB.join() ä¼šè®© ThreadA ç«‹å³è¿›å…¥ WAITING çŠ¶æ€ï¼Œ<strong>å¹¶ä¸”ThreadA ä¼šæ— é™æœŸåœ°ç­‰å¾… ThreadB å®Œæˆï¼Œç›´åˆ° ThreadB æ‰§è¡Œå®Œæ¯•æ‰ä¼šç»§ç»­æ‰§è¡Œ</strong>ã€‚<strong>ThreadA å°†é‡Šæ”¾ä»»ä½•å·²æŒæœ‰çš„é”</strong>ã€‚</p>
<p><strong>ThreadB çŠ¶æ€å¯èƒ½ä¸å˜:</strong> å’Œä¹‹å‰ä¸€æ ·ï¼ŒThreadB.join() çš„è°ƒç”¨ä¸ä¼šç›´æ¥æ”¹å˜ ThreadB çš„çŠ¶æ€ã€‚ThreadB ä¼šæŒ‰ç…§å…¶è‡ªèº«é€»è¾‘å’ŒçŠ¶æ€ç»§ç»­æ‰§è¡Œæˆ–ç­‰å¾…ã€‚</p>
<p><strong>ThreadB æ‰§è¡Œå®Œæ¯•:</strong> å½“ ThreadB æ‰§è¡Œå®Œæ¯•åï¼ŒThreadA ä¼šè¢«å”¤é†’ï¼Œä» WAITING çŠ¶æ€æ¢å¤åˆ° RUNNABLE çŠ¶æ€ï¼Œ<strong>å¹¶å°è¯•é‡æ–°è·å–ä¹‹å‰é‡Šæ”¾çš„é”ï¼ˆå¦‚æœæœ‰ï¼‰</strong>ï¼Œç„¶åç»§ç»­æ‰§è¡Œ ThreadB.join() ä¹‹åçš„ä»£ç ã€‚</p>
<p><strong>Thread.join(1000)</strong></p>
<p>è‹¥ ThreadA åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œ ThreadB.join(1000)ï¼Œ</p>
<p><strong>ThreadA è¿›å…¥ TIMED_WAITING çŠ¶æ€ï¼š</strong> join(1000) ä¼šè®© ThreadA ç«‹å³è¿›å…¥ TIMED_WAITINGï¼ˆè¶…æ—¶ç­‰å¾…ï¼‰çŠ¶æ€ï¼Œæœ€å¤šç­‰å¾… 1000 æ¯«ç§’ï¼ˆ1 ç§’ï¼‰ã€‚<strong>ThreadA å°†é‡Šæ”¾ä»»ä½•å·²æŒæœ‰çš„é”</strong>ã€‚</p>
<p><strong>ThreadB çŠ¶æ€å¯èƒ½ä¸å˜ï¼š</strong> ThreadB.join(1000) çš„è°ƒç”¨ä¸ä¼šç›´æ¥æ”¹å˜ ThreadB çš„çŠ¶æ€ã€‚ThreadB ä¼šæŒ‰ç…§å…¶è‡ªèº«é€»è¾‘å’ŒçŠ¶æ€ç»§ç»­æ‰§è¡Œæˆ–ç­‰å¾…ã€‚</p>
<p><strong>ä¸¤ç§æƒ…å†µåçš„ ThreadAï¼š</strong></p>
<ul>
<li><strong>æƒ…å†µä¸€ï¼š ThreadB åœ¨ 1000 æ¯«ç§’å†…æ‰§è¡Œå®Œæ¯•:</strong> ThreadA ä¼šè¢«å”¤é†’ï¼Œä» TIMED_WAITING çŠ¶æ€æ¢å¤åˆ° RUNNABLE çŠ¶æ€ï¼Œ<strong>å¹¶å°è¯•é‡æ–°è·å–ä¹‹å‰é‡Šæ”¾çš„é”ï¼ˆå¦‚æœæœ‰ï¼‰</strong>ï¼Œç„¶åç»§ç»­æ‰§è¡Œ ThreadB.join(1000) ä¹‹åçš„ä»£ç ã€‚</li>
<li><strong>æƒ…å†µäºŒï¼š ThreadB åœ¨ 1000 æ¯«ç§’å†…æ²¡æœ‰æ‰§è¡Œå®Œæ¯•:</strong> 1000 æ¯«ç§’åï¼ŒThreadA ä¼šè‡ªåŠ¨è¢«å”¤é†’ï¼Œä» TIMED_WAITING çŠ¶æ€æ¢å¤åˆ° RUNNABLE çŠ¶æ€ï¼Œ<strong>å¹¶å°è¯•é‡æ–°è·å–ä¹‹å‰é‡Šæ”¾çš„é”ï¼ˆå¦‚æœæœ‰ï¼‰</strong>ï¼Œç»§ç»­æ‰§è¡Œ ThreadB.join(1000) ä¹‹åçš„ä»£ç ã€‚</li>
</ul>
<h4 id="wait-å’Œ-notify">wait() å’Œ notify()</h4>
<ul>
<li>
<p><strong>wait() å’Œ notify() æ–¹æ³•å¿…é¡»åœ¨åŒæ­¥ä»£ç å— (synchronized) æˆ–åŒæ­¥æ–¹æ³•ä¸­ä½¿ç”¨ã€‚</strong></p>
</li>
<li>
<p><strong>è°ƒç”¨ wait() å’Œ notify() æ–¹æ³•çš„å¯¹è±¡å¿…é¡»æ˜¯è¯¥åŒæ­¥ä»£ç å—æˆ–åŒæ­¥æ–¹æ³•æ‰€å¯¹åº”çš„é”å¯¹è±¡ã€‚</strong></p>
</li>
</ul>
<p><strong>Object.wait()</strong></p>
<p>è®©å½“å‰çº¿ç¨‹ï¼ˆå‡è®¾æ˜¯ ThreadAï¼‰<strong>æ— é™æœŸåœ°é‡Šæ”¾é”å¯¹è±¡ï¼Œå¹¶è¿›å…¥ WAITING çŠ¶æ€</strong>ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹ï¼ˆä¾‹å¦‚ ThreadBï¼‰è°ƒç”¨ notify() æˆ– notifyAll() æ–¹æ³•å”¤é†’å®ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹ä¸º ThreadA</span></span><br><span class="line"><span class="keyword">synchronized</span>(lockObject) &#123; <span class="comment">// lockObject æ˜¯å…±äº«é”å¯¹è±¡ï¼ŒThreadA ä¸º Running çŠ¶æ€ï¼ŒThreadB ä¸º Block çŠ¶æ€</span></span><br><span class="line">  <span class="keyword">while</span> (!someCondition) &#123; <span class="comment">// someCondition æ˜¯çº¿ç¨‹ç­‰å¾…çš„æ¡ä»¶</span></span><br><span class="line">    lockObject.wait(); <span class="comment">// ThreadA é‡Šæ”¾é”ï¼Œè¿›å…¥ WAITING çŠ¶æ€ï¼›ThreadB è¿›å…¥ Ready çŠ¶æ€</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// someCondition ä¸º trueï¼ŒThreadA è¢«å”¤é†’åï¼Œä¼šé‡æ–°å°è¯•è·å–é”</span></span><br><span class="line">  <span class="comment">// ... æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Object.wait(1000)</strong></p>
<p>è®©å½“å‰çº¿ç¨‹ï¼ˆå‡è®¾æ˜¯ ThreadAï¼‰é‡Šæ”¾é”å¯¹è±¡ï¼Œå¹¶è¿›å…¥ TIMED_WAITINGï¼ˆè¶…æ—¶ç­‰å¾…ï¼‰çŠ¶æ€ï¼Œ<strong>æœ€å¤šç­‰å¾… 1000 æ¯«ç§’</strong>ã€‚åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œæœ‰ä¸¤ç§æƒ…å†µå¯ä»¥è®© ThreadA è¢«å”¤é†’ï¼š</p>
<ul>
<li><strong>å…¶ä»–çº¿ç¨‹è°ƒç”¨ notify() æˆ– notifyAll() æ–¹æ³•</strong></li>
<li><strong>ç­‰å¾…æ—¶é—´è¶…è¿‡ 1000 æ¯«ç§’</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹ä¸º ThreadA</span></span><br><span class="line"><span class="keyword">synchronized</span>(lockObject) &#123; <span class="comment">// lockObject æ˜¯å…±äº«é”å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">while</span> (!someCondition) &#123; <span class="comment">// someCondition æ˜¯çº¿ç¨‹ç­‰å¾…çš„æ¡ä»¶</span></span><br><span class="line">    lockObject.wait(<span class="number">1000</span>); <span class="comment">// ThreadA é‡Šæ”¾é”ï¼Œè¿›å…¥ TIMED_WAITING çŠ¶æ€</span></span><br><span class="line">  <span class="comment">// someCondition ä¸º true æˆ–ç­‰å¾…è¶…æ—¶ï¼ŒThreadA ä¼šé‡æ–°å°è¯•è·å–é”</span></span><br><span class="line">  <span class="comment">// è‹¥æ­¤æ—¶è¯¥é”æ— æ³•è·å–åˆ°ï¼ŒThreadAå°†è¿›å…¥blockçŠ¶æ€ç­‰å¾…è·å–lockObjectå¯¹è±¡çš„é”</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Thread.sleep() ä¸ Object.wait() å¯¹æ¯”</p>
<ul>
<li><strong><code>sleep()</code> æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ <code>wait()</code> æ–¹æ³•é‡Šæ”¾äº†é”</strong> ã€‚</li>
<li><code>wait()</code> é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œ<code>sleep()</code>é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚</li>
<li><code>wait()</code> æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ <code>notify()</code>æˆ–è€… <code>notifyAll()</code> æ–¹æ³•ã€‚<code>sleep()</code>æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>wait(long timeout)</code> è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚</li>
<li><code>sleep()</code> æ˜¯ <code>Thread</code> ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œ<code>wait()</code> åˆ™æ˜¯ <code>Object</code> ç±»çš„æœ¬åœ°æ–¹æ³•ã€‚</li>
</ul>
<p><strong>Object.notify()</strong></p>
<ul>
<li><strong>ä½œç”¨:</strong> éšæœºå”¤é†’<strong>ä¸€ä¸ª</strong>æ­£åœ¨ç­‰å¾…<strong>ç›¸åŒé”å¯¹è±¡</strong>çš„çº¿ç¨‹ã€‚</li>
<li><strong>æ³¨æ„ï¼š</strong>
<ul>
<li>notify() æ–¹æ³•<strong>ä¸ä¼šç«‹å³é‡Šæ”¾é”</strong>ã€‚è¢«å”¤é†’çš„çº¿ç¨‹éœ€è¦ç­‰å¾…è°ƒç”¨ notify() çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œæ‰èƒ½çœŸæ­£åœ°è·å–é”å¹¶ç»§ç»­æ‰§è¡Œã€‚</li>
<li>å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…åŒä¸€ä¸ªé”å¯¹è±¡ï¼Œnotify() æ–¹æ³•åªä¼šéšæœºå”¤é†’å…¶ä¸­ä¸€ä¸ªï¼Œè€Œå…¶ä»–çº¿ç¨‹ä»ç„¶ä¼šç»§ç»­ç­‰å¾…ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾ ThreadA å†…è°ƒç”¨ lockObject.wait() è¿›å…¥ç­‰å¾…çŠ¶æ€</span></span><br><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹ä¸º ThreadB</span></span><br><span class="line"><span class="keyword">synchronized</span>(lockObject) &#123;</span><br><span class="line">  <span class="comment">// ... å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„æ“ä½œ ... </span></span><br><span class="line"></span><br><span class="line">  lockObject.notify(); <span class="comment">// éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾… lockObject çš„çº¿ç¨‹ (å¯èƒ½æ˜¯ ThreadA)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... è°ƒç”¨ notify() çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡Šæ”¾é” ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Object.notifyAll()</strong></p>
<ul>
<li><strong>ä½œç”¨:</strong> å”¤é†’<strong>æ‰€æœ‰</strong>æ­£åœ¨ç­‰å¾…<strong>ç›¸åŒé”å¯¹è±¡</strong>çš„çº¿ç¨‹ã€‚</li>
<li><strong>æ³¨æ„ï¼š</strong>
<ul>
<li>å’Œ notify() æ–¹æ³•ä¸€æ ·ï¼ŒnotifyAll() æ–¹æ³•<strong>ä¹Ÿä¸ä¼šç«‹å³é‡Šæ”¾é”</strong>ã€‚</li>
<li>è¢«å”¤é†’çš„çº¿ç¨‹éœ€è¦ç«äº‰é”ï¼Œåªæœ‰æˆåŠŸè·å–é”çš„çº¿ç¨‹æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾ ThreadA å’Œå…¶ä»–çº¿ç¨‹éƒ½åœ¨ç­‰å¾… lockObject</span></span><br><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹ä¸º ThreadB</span></span><br><span class="line"><span class="keyword">synchronized</span>(lockObject) &#123;</span><br><span class="line">  <span class="comment">// ... å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„æ“ä½œ ... </span></span><br><span class="line"></span><br><span class="line">  lockObject.notifyAll(); <span class="comment">// å”¤é†’æ‰€æœ‰ç­‰å¾… lockObject çš„çº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... è°ƒç”¨ notifyAll() çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡Šæ”¾é” ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¢å¤–ï¼šä½¿ç”¨synchronizedå’Œwait/notifyå®ç°çº¿ç¨‹çš„é¡ºåºæ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequentialExecution</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">currentThread</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// ç”¨äºæ ‡è¯†å½“å‰åº”è¯¥æ‰§è¡Œçš„çº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">A</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (currentThread != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait(); <span class="comment">// ç­‰å¾…è½®åˆ°çº¿ç¨‹ A</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread A is running&quot;</span>);</span><br><span class="line">                currentThread = <span class="number">2</span>; <span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªçº¿ç¨‹ä¸º B</span></span><br><span class="line">                lock.notifyAll(); <span class="comment">// å”¤é†’å…¶ä»–çº¿ç¨‹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">B</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (currentThread != <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait(); <span class="comment">// ç­‰å¾…è½®åˆ°çº¿ç¨‹ B</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread B is running&quot;</span>);</span><br><span class="line">                currentThread = <span class="number">3</span>; <span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªçº¿ç¨‹ä¸º C</span></span><br><span class="line">                lock.notifyAll(); <span class="comment">// å”¤é†’å…¶ä»–çº¿ç¨‹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">C</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (currentThread != <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait(); <span class="comment">// ç­‰å¾…è½®åˆ°çº¿ç¨‹ C</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread C is running&quot;</span>);</span><br><span class="line">                currentThread = <span class="number">1</span>; <span class="comment">// é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">                lock.notifyAll(); <span class="comment">// å”¤é†’å…¶ä»–çº¿ç¨‹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        A.start();</span><br><span class="line">        B.start();</span><br><span class="line">        C.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="LockSupport">LockSupport</h4>
<p><strong>è®¸å¯è¯æœºåˆ¶</strong></p>
<p>LockSupport çš„è®¸å¯è¯æœºåˆ¶å¯ä»¥ç†è§£ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªè™šæ‹Ÿçš„ â€œè®¸å¯è¯â€ï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å¤šåªæœ‰ä¸€ä¸ªè®¸å¯è¯ï¼š</p>
<ul>
<li><strong>åˆå§‹çŠ¶æ€ï¼š</strong> çº¿ç¨‹åˆšåˆ›å»ºæ—¶ï¼Œé»˜è®¤<strong>æ²¡æœ‰</strong>è®¸å¯è¯ã€‚</li>
<li><strong>park() è¡Œä¸ºï¼š</strong>
<ul>
<li>å¦‚æœçº¿ç¨‹<strong>æœ‰</strong>è®¸å¯è¯ï¼Œè°ƒç”¨ park() ä¼š<strong>ç«‹å³è¿”å›</strong>ï¼Œå¹¶<strong>æ¶ˆè€—</strong>æ‰è¿™ä¸ªè®¸å¯è¯ã€‚</li>
<li>å¦‚æœçº¿ç¨‹<strong>æ²¡æœ‰</strong>è®¸å¯è¯ï¼Œè°ƒç”¨ park() ä¼š<strong>é˜»å¡çº¿ç¨‹</strong>ï¼Œç›´åˆ°è·å¾—è®¸å¯è¯ã€‚</li>
</ul>
</li>
<li><strong>unpark() è¡Œä¸ºï¼š</strong>
<ul>
<li>å¦‚æœçº¿ç¨‹<strong>æ²¡æœ‰</strong>è®¸å¯è¯ï¼Œè°ƒç”¨ unpark() ä¼š<strong>é¢å‘</strong>ä¸€ä¸ªè®¸å¯è¯ç»™è¯¥çº¿ç¨‹ã€‚</li>
<li>å¦‚æœçº¿ç¨‹<strong>å·²ç»</strong>æœ‰è®¸å¯è¯ï¼Œè°ƒç”¨ unpark() <strong>ä¸ä¼š</strong>äº§ç”Ÿä»»ä½•æ•ˆæœï¼Œè®¸å¯è¯<strong>ä¸ä¼šç´¯ç§¯</strong>ã€‚</li>
</ul>
</li>
</ul>
<p><strong>LockSupport çš„é˜»å¡å’Œå”¤é†’</strong></p>
<p>LockSupport é€šè¿‡æ“ä½œçº¿ç¨‹çš„ <strong>Parker</strong> å¯¹è±¡æ¥å®ç°é˜»å¡å’Œå”¤é†’ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª Parker å¯¹è±¡ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†çº¿ç¨‹çš„é˜»å¡çŠ¶æ€å’Œè®¸å¯è¯ä¿¡æ¯ã€‚</p>
<ul>
<li><strong>park() é˜»å¡çº¿ç¨‹ï¼š</strong> park() æ–¹æ³•ä¼šè°ƒç”¨ Parker å¯¹è±¡çš„ park() æ–¹æ³•ï¼Œå°†çº¿ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸º WAITING æˆ– PARKEDï¼Œå¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç›´åˆ°è·å¾—è®¸å¯è¯ã€‚</li>
<li><strong>unpark() å”¤é†’çº¿ç¨‹ï¼š</strong> unpark() æ–¹æ³•ä¼šè°ƒç”¨ Parker å¯¹è±¡çš„ unpark() æ–¹æ³•ï¼Œå°†çº¿ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸º RUNNABLEï¼Œå¹¶é€šçŸ¥æ“ä½œç³»ç»Ÿè°ƒåº¦è¯¥çº¿ç¨‹</li>
</ul>
<p><strong>çŠ¶æ€ä¸ä¸­æ–­</strong></p>
<p><strong>BLOCKED çŠ¶æ€ (é˜»å¡çŠ¶æ€)</strong></p>
<ul>
<li><strong>æˆå› :</strong> çº¿ç¨‹åœ¨å°è¯•è·å–æŸä¸ªé”æ—¶ï¼Œå¦‚æœè¯¥é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šè¿›å…¥ BLOCKED çŠ¶æ€ã€‚</li>
<li><strong>ä¸­æ–­çš„å½±å“:</strong> BLOCKED çŠ¶æ€çš„çº¿ç¨‹<strong>ä¸ä¼š</strong>å“åº”ä¸­æ–­è¯·æ±‚ã€‚å³ä½¿è°ƒç”¨äº† interrupt() æ–¹æ³•ï¼Œçº¿ç¨‹ä¹Ÿä¸ä¼šç«‹å³é€€å‡ºé˜»å¡çŠ¶æ€ã€‚åªæœ‰å½“çº¿ç¨‹è·å–åˆ°é”ä¹‹åï¼Œæ‰ä¼šæ£€æŸ¥ä¸­æ–­çŠ¶æ€ã€‚</li>
</ul>
<p><strong>WAITING çŠ¶æ€ (ç­‰å¾…çŠ¶æ€)</strong></p>
<ul>
<li><strong>æˆå› :</strong> çº¿ç¨‹è°ƒç”¨äº† wait()ã€join()ï¼ˆæ— è¶…æ—¶ï¼‰ æˆ– park() æ–¹æ³•ï¼Œè¿›å…¥æ— é™æœŸç­‰å¾…çŠ¶æ€ã€‚</li>
<li><strong>ä¸­æ–­çš„å½±å“:</strong> WAITING çŠ¶æ€çš„çº¿ç¨‹<strong>å¯ä»¥</strong>è¢«ä¸­æ–­å”¤é†’ã€‚å½“è°ƒç”¨ interrupt() æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹ä¼šæŠ›å‡º InterruptedExceptionï¼Œå¹¶é€€å‡ºç­‰å¾…çŠ¶æ€ã€‚è¿›å…¥ <strong>RUNNABLE (å¯è¿è¡Œ)</strong> çŠ¶æ€</li>
</ul>
<p><strong>TIMED_WAITING çŠ¶æ€ (è¶…æ—¶ç­‰å¾…çŠ¶æ€)</strong></p>
<ul>
<li><strong>æˆå› :</strong> çº¿ç¨‹è°ƒç”¨äº† wait(timeout)ã€join(timeout)ã€sleep(timeout) æˆ– parkNanos(nanos) æ–¹æ³•ï¼Œè¿›å…¥æœ‰é™æ—¶é—´ç­‰å¾…çŠ¶æ€ã€‚</li>
<li><strong>ä¸­æ–­çš„å½±å“:</strong> TIMED_WAITING çŠ¶æ€çš„çº¿ç¨‹<strong>å¯ä»¥</strong>è¢«ä¸­æ–­å”¤é†’ã€‚ å½“è°ƒç”¨ interrupt() æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹ä¼šæŠ›å‡º InterruptedExceptionï¼Œå¹¶é€€å‡ºç­‰å¾…çŠ¶æ€ã€‚è¿›å…¥ <strong>RUNNABLE (å¯è¿è¡Œ)</strong> çŠ¶æ€</li>
</ul>
<p><strong>ä¸­æ–­åçŠ¶æ€</strong></p>
<p>ä¸­æ–­åç¨‹åºä¼šè¿›å…¥ <strong>RUNNABLE (å¯è¿è¡Œ)</strong> çŠ¶æ€ï¼Œä½†æ˜¯ä¸æ„å‘³ç€ç¨‹åºå¯ä»¥ç«‹å³å‘åæ‰§è¡Œä»£ç </p>
<ul>
<li><strong>éœ€è¦è·å–èµ„æº:</strong> çº¿ç¨‹éœ€è¦é‡æ–°è·å–ä¹‹å‰é‡Šæ”¾çš„èµ„æºï¼Œä¾‹å¦‚ï¼š
<ul>
<li>å¦‚æœæ˜¯é€šè¿‡ wait() è¿›å…¥ WAITING çŠ¶æ€çš„ï¼Œéœ€è¦é‡æ–°è·å– wait() æ–¹æ³•æ‰€å±å¯¹è±¡çš„é”ã€‚æ­¤æ—¶çº¿ç¨‹è‹¥åœ¨ synchronized å—ä¸­ï¼Œä¼šç­‰å¾…è·å–å¯¹è±¡çš„é”ï¼Œè‹¥è·å–ä¸åˆ°ï¼Œä¼šè¿›å…¥ BLOCKED çŠ¶æ€ã€‚</li>
<li>å¦‚æœæ˜¯é€šè¿‡ join() è¿›å…¥ WAITING çŠ¶æ€çš„ï¼Œéœ€è¦ç­‰å¾… join() çš„ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</li>
</ul>
</li>
<li><strong>éœ€è¦ CPU è°ƒåº¦:</strong> çº¿ç¨‹è¿˜éœ€è¦ç­‰å¾… CPU çš„è°ƒåº¦ï¼Œæ‰èƒ½çœŸæ­£åœ°æ‰§è¡Œä»£ç ã€‚</li>
</ul>
<h3 id="CAS">CAS</h3>
<p>Compare-and-Swapï¼Œä¹è§‚é”</p>
<ul>
<li>Vï¼šè¦æ›´æ–°çš„å˜é‡(var)</li>
<li>Eï¼šé¢„æœŸå€¼(expected)ï¼Œæ—§å€¼ï¼›</li>
<li>Nï¼šæ–°å€¼(new)</li>
</ul>
<p>æ¯”è¾ƒå¹¶äº¤æ¢çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>åˆ¤æ–­ V æ˜¯å¦ç­‰äº Eï¼Œå¦‚æœç­‰äºï¼Œå°† V çš„å€¼è®¾ç½®ä¸º Nï¼ˆåŸå­æ“ä½œæ›´æ–°ï¼‰ï¼›å¦‚æœä¸ç­‰ï¼Œè¯´æ˜å·²ç»æœ‰å…¶å®ƒçº¿ç¨‹æ›´æ–°äº† Vï¼Œäºæ˜¯å½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚</p>
<blockquote>
<p>å­˜åœ¨ABAé—®é¢˜ï¼Œå³ V è¢«çº¿ç¨‹1 ä»Aä¿®æ”¹ä¸ºBä¿®æ”¹ä¸ºA ï¼›çº¿ç¨‹2 é¢„æœŸå€¼ä¸º Aï¼Œåœ¨æ¯”è¾ƒæ—¶å‘ç° V   çš„å€¼ A ä¸ é¢„æœŸå€¼E ç›¸åŒï¼Œè®¤ä¸º V æ²¡æœ‰æ”¶åˆ°ä¿®æ”¹ï¼Œå®åˆ™ä¸ç„¶ï¼›</p>
<p>è§£å†³åŠæ³•ï¼šåŠ å…¥ç‰ˆæœ¬å·æ§åˆ¶</p>
</blockquote>
<p>Unsafeç±» nativeæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object o, <span class="type">long</span> offset,Object expected, Object x)</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object o, <span class="type">long</span> offset,<span class="type">int</span> expected,<span class="type">int</span> x)</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSwapLong</span><span class="params">(Object o, <span class="type">long</span> offset,<span class="type">long</span> expected,<span class="type">long</span> x)</span>;</span><br></pre></td></tr></table></figure>
<p>AtomicIntegerç±» getAndIncrement</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> get();  <span class="comment">// å–å¾—AtomicIntegeré‡Œå­˜å‚¨çš„æ•°å€¼</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + <span class="number">1</span>;  <span class="comment">// åŠ 1</span></span><br><span class="line">                <span class="comment">// compareAndSetå³ä¸ºCASæ“ä½œï¼Œcurrentçš„å€¼ä¸ºæ—§å€¼ï¼Œå˜é‡ä¸ºAtomicIntegerï¼Œæ–°å€¼ä¸ºnextçš„å€¼ï¼Œå°è¯•å°†AtomicIntegerçš„å€¼è®¾ç½®ä¸ºnext</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSet(current, next))   <span class="comment">// è°ƒç”¨compareAndSetæ‰§è¡ŒåŸå­æ›´æ–°æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">return</span> current;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>æ ‡å‡†çš„CAS</p>
<ol>
<li>
<p>compareAndSetæ–¹æ³•é¦–å…ˆåˆ¤æ–­AtomicIntegeræ˜¯å¦ç­‰äºcurrentï¼›</p>
</li>
<li>
<p>å¦‚æœå½“å‰å€¼ = current ï¼Œè¯´æ˜AtomicIntegerçš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼›</p>
</li>
<li>
<p>å¦‚æœå½“å‰å€¼ != currentï¼Œè¯´æ˜AtomicIntegerçš„å€¼è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œ<code>compareAndSet()</code>è¿”å›Falseï¼Œå¾ªç¯ç»§ç»­ï¼Œæ— æ³•è¿”å›currentï¼›</p>
</li>
</ol>
<h3 id="AQS">AQS</h3>
<p><strong>CLHé˜Ÿåˆ—</strong></p>
<p>åŒå‘é“¾è¡¨ï¼Œé€šè¿‡headå’Œtailè®°å½•å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œå…ƒç´ ç±»å‹ä¸ºNode</p>
<p>çº¿ç¨‹è·å–ï¼Ÿå¤±è´¥æ—¶ï¼ŒAQSå°†çº¿ç¨‹å’Œç›¸å…³ä¿¡æ¯å°è£…ä¸ºNodeåŠ å…¥CLHé˜Ÿåˆ—ï¼ŒåŒæ—¶é˜»å¡è¯¥çº¿ç¨‹</p>
<p>ref: <a href="https://developer.aliyun.com/article/779674?spm=a2c6h.13262185.profile.72.4c5f3bc8ppEWYX">https://developer.aliyun.com/article/779674?spm=a2c6h.13262185.profile.72.4c5f3bc8ppEWYX</a></p>
<img src="/2025/01/17/Java/20201206223144780.png" class="" title="aqs">
<img src="/2025/01/17/Java/java-thread-x-juc-aqs-1.png" class="" title="image">
<ul>
<li>
<p>state</p>
<p>volatileï¼Œæ–¹æ³• <code>compareAndSetState()</code> ä½¿ç”¨CAS</p>
<p>ç›¸å…³æ–¹æ³•ï¼š <code>getState()</code>, <code>setState()</code>, <code>compareAndSetState()</code></p>
<blockquote>
<p>åœ¨ ReentrantLock ä¸­ï¼Œé€šè¿‡ state åˆ¤æ–­å½“å‰çº¿ç¨‹çŠ¶æ€ï¼›</p>
<p>stateå€¼ä¸º1è¯´æ˜èµ„æºæ­£åœ¨è¢«ä½¿ç”¨ï¼Œå€¼ä¸º0è¯´æ˜èµ„æºæœªè¢«ä½¿ç”¨ï¼›</p>
<p>å‘ç”Ÿé‡å…¥åˆ™ setState(getState() + 1);</p>
</blockquote>
</li>
<li>
<p>exclusiveOwnerThread</p>
<p>å½“å‰ç‹¬å èµ„æºçš„çº¿ç¨‹</p>
</li>
<li>
<p>å†…éƒ¨ç±»Node</p>
<ul>
<li>
<p>ç­‰å¾…æ ‡è®° SHARED, EXCLUSIVE</p>
</li>
<li>
<p>é™æ€å¸¸é‡ CANCELLED, SIGNAL, CONDITION, PROPAGATE</p>
<p>è¿™äº›å¸¸é‡å®šä¹‰äº† Node çš„ waitStatus çŠ¶æ€ï¼Œå®ƒä»¬æ§åˆ¶ç€ç­‰å¾…é˜Ÿåˆ—çš„è¡Œä¸ºï¼š</p>
<blockquote>
<ul>
<li>CANCELLED = 1: è¡¨ç¤ºèŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹å› ä¸ºè¶…æ—¶ã€ä¸­æ–­ç­‰åŸå› è¢«å–æ¶ˆäº†ç­‰å¾…ã€‚ è¢«å–æ¶ˆçš„èŠ‚ç‚¹éœ€è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</li>
<li>SIGNAL = -1: è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰éœ€è¦è¢«å”¤é†’ï¼ˆunparkï¼‰ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”æˆ–å‘å‡ºä¿¡å·æ—¶ï¼Œå®ƒä¼šå°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ waitStatus è®¾ç½®ä¸º SIGNALï¼Œé€šçŸ¥åç»§èŠ‚ç‚¹å°è¯•è·å–é”ã€‚</li>
<li>CONDITION = -2: è¡¨ç¤ºèŠ‚ç‚¹å½“å‰åœ¨ condition é˜Ÿåˆ—ä¸­ç­‰å¾… condition æ»¡è¶³ã€‚ ä¸ä¸»åŒæ­¥é˜Ÿåˆ—ï¼ˆAQS é˜Ÿåˆ—ï¼‰æ˜¯åˆ†å¼€çš„ï¼Œç­‰å¾… Condition.signal() å”¤é†’åï¼ŒèŠ‚ç‚¹ä¼šè¢«è½¬ç§»åˆ°ä¸»åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œé‡æ–°ç«äº‰é”ã€‚</li>
<li>PROPAGATE = -3: åªç”¨äºå…±äº«æ¨¡å¼ã€‚è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„å…±äº«é”é‡Šæ”¾æ“ä½œï¼Œä¸ä»…éœ€è¦å”¤é†’åç»§èŠ‚ç‚¹ï¼Œè€Œä¸”è¦å°†é‡Šæ”¾æ“ä½œä¼ æ’­ï¼ˆpropagateï¼‰åˆ°åç»­èŠ‚ç‚¹ï¼Œå› ä¸ºåç»­èŠ‚ç‚¹å¯èƒ½ä¹Ÿå¯ä»¥è·å–åˆ°å…±äº«é”ã€‚</li>
</ul>
</blockquote>
</li>
<li>
<p><strong>volatile int waitStatus</strong>: èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼ŒåŒ…æ‹¬ä¸Šé¢çš„å››ç§å¸¸é‡æ‰€æè¿°çš„ï¼Œä½¿ç”¨ volatile ä¿è¯å¯è§æ€§ã€‚</p>
</li>
<li>
<p><strong>volatile Node prev</strong>: æŒ‡å‘å‰é©±èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</p>
</li>
<li>
<p><strong>volatile Node next</strong>: æŒ‡å‘åç»§èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</p>
</li>
<li>
<p><strong>volatile Thread thread</strong>: èŠ‚ç‚¹å…³è”çš„çº¿ç¨‹ã€‚</p>
</li>
<li>
<p>**Node nextWaiter: <strong>ä»…åœ¨ Condition ä¸­ä½¿ç”¨</strong>ã€‚ å®ƒæŒ‡å‘ä¸‹ä¸€ä¸ªç­‰å¾… condition çš„èŠ‚ç‚¹ã€‚ åœ¨ AQS çš„ä¸»åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå®ƒç”¨ä½œå…±äº«/ç‹¬å æ¨¡å¼çš„æ ‡è¯†ã€‚ å¦‚æœ nextWaiter == SHAREDï¼Œåˆ™è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
</li>
</ul>
</li>
<li>
<p>å†…éƒ¨ç±»ConditionObject</p>
<p>è¯¥ç±»ç»´æŠ¤äº†ä¸€ä¸ªæ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œå®ç°äº†Conditionæ¥å£</p>
</li>
<li>
<p>æ–¹æ³•</p>
<p>tryAcquireæ–¹æ³•ï¼Œè°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹ä¼šè¯•å›¾åœ¨ç‹¬å æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ã€‚æ­¤æ–¹æ³•åº”è¯¥æŸ¥è¯¢æ˜¯å¦å…è®¸å®ƒåœ¨ç‹¬å æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ï¼Œå¦‚æœå…è®¸ï¼Œåˆ™è·å–å®ƒã€‚</p>
<p>addWaiteræ–¹æ³•å®Œæˆçš„åŠŸèƒ½æ˜¯å°†è°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹å°è£…æˆä¸ºä¸€ä¸ªç»“ç‚¹å¹¶æ”¾å…¥Sync queue</p>
</li>
</ul>
<p><strong>æµç¨‹</strong></p>
<img src="/2025/01/17/Java/2a3c22e2ac6d0a8990f04e4920760b57.png" class="" title="aqs_process">
<p><code>acquire()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tryAcquire()</code> ä¸ºæ¨¡æ¿æ–¹æ³•ï¼Œç”±å­ç±»å®ç°</p>
<p><code>acquireQueued()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹nodeé€šè¿‡acquireQueued()æ–¹æ³•è·å–èµ„æºï¼Œå¿½ç•¥ä¸­æ–­ã€‚</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//è‡ªæ—‹çš„æ“ä½œï¼Œä¸€ä¸ªæ­»å¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//è·å–ä¼ è¿›æ¥çš„nodeèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œèµ‹å€¼ç»™p</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">//å¦‚æœpæ˜¯å¤´ç»“ç‚¹ï¼ŒnodeèŠ‚ç‚¹å°±æ˜¯ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œåˆ™å†æ¬¡å»å°è¯•è·å–èµ„æº</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">//tryAcquire(arg)è·å–èµ„æºæˆåŠŸçš„è¯ï¼Œåˆ™æŠŠnodeèŠ‚ç‚¹è®¾ç½®ä¸ºå¤´ç»“ç‚¹</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                <span class="comment">//æŠŠåŸæ¥çš„å¤´ç»“ç‚¹pçš„åé©±èŠ‚ç‚¹è®¾ç½®ä¸ºnullï¼Œç­‰å¾…GCåƒåœ¾å›æ”¶</span></span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœpä¸æ˜¯å¤´ç»“ç‚¹ï¼Œæˆ–è€…tryAcquire()è·å–èµ„æºå¤±è´¥ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥è¢«parkï¼Œä¹Ÿå°±æ˜¯æŠŠçº¿ç¨‹é˜»å¡èµ·æ¥</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())<span class="comment">//&amp;&amp;å‰é¢å¦‚æœè¿”å›trueï¼Œå°†å½“å‰çº¿ç¨‹é˜»å¡å¹¶æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">                <span class="comment">//å¦‚æœé˜»å¡è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œåˆ™ç½®interruptedæ ‡å¿—ä½ä¸ºtrueã€‚</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>addWaiter()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">//æŠŠå½“å‰çº¿ç¨‹åŒ…è£…æˆNodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">//è·å–åˆ°å°¾ç»“ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å°¾ç»“ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œé‚£å°±è¯æ˜é˜Ÿåˆ—å·²ç»åˆå§‹åŒ–äº†</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å·²ç»åˆå§‹åŒ–äº†ï¼Œå°±ç›´æ¥æŠŠNodeèŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—çš„æœ«å°¾</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="comment">//è¿”å›åŒ…å«å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹Node</span></span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœé˜Ÿåˆ—æ²¡æœ‰åˆå§‹åŒ–ï¼Œé‚£å°±è°ƒç”¨enq()æ–¹æ³•</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="comment">//è‡ªæ—‹æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ­»å¾ªç¯ï¼Œåªæœ‰åŠ å…¥é˜Ÿåˆ—æˆåŠŸæ‰ä¼šreturn</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//æŠŠå°¾ç»“ç‚¹èµ‹å€¼ç»™t</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºç©ºï¼Œè¯æ˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªç©ºçš„NodeèŠ‚ç‚¹ï¼Œå¹¶ä¸”è®¾ç½®ä¸ºå¤´ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                <span class="comment">//ç„¶åæŠŠå¤´ç»“ç‚¹èµ‹å€¼ç»™å°¾ç»“ç‚¹</span></span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¾ªç¯ä¸ºç©ºï¼Œå°±å·²ç»åˆ›å»ºäº†ä¸€ä¸ªä¸€ä¸ªNodeï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡å¾ªç¯å°±ä¸ä¼šä¸ºç©ºäº†</span></span><br><span class="line">            <span class="comment">//å¦‚æœå°¾ç»“ç‚¹ä¸ä¸ºç©ºï¼Œå°±æŠŠä¼ è¿›æ¥çš„nodeèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘å°¾ç»“ç‚¹</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">//casåŸå­æ€§æ“ä½œï¼ŒæŠŠä¼ è¿›æ¥çš„nodeèŠ‚ç‚¹è®¾ç½®ä¸ºå°¾ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">//æŠŠåŸæ¥çš„å°¾ç»“ç‚¹çš„åé©±èŠ‚ç‚¹æŒ‡å‘ä¼ è¿›æ¥çš„nodeèŠ‚ç‚¹</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="synchronized">synchronized</h3>
<p><strong>æ‚²è§‚é”ï¼Œå¯é‡å…¥é”</strong></p>
<p>ä¿®é¥°<strong>å®ä¾‹æ–¹æ³•</strong>/ä¿®é¥°é™æ€æ–¹æ³•  é”ç›®æ ‡ï¼šè¯¥æ–¹æ³•å¯¹åº”çš„<strong>å¯¹è±¡</strong>/<strong>Classå¯¹è±¡</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">       i++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">       i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®é¥°ä»£ç å—  é”ç›®æ ‡ï¼šæŒ‡å®š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (object) &#123; </span><br><span class="line">   <span class="comment">// éœ€è¦åŒæ­¥çš„ä»£ç å—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedCounter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">SynchronizedCounter</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedCounter</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();  <span class="comment">// thread1 joinæ‰§è¡Œï¼ŒåŠ å…¥thread1çš„ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Count: &quot;</span> + counter.getCount()); <span class="comment">// é¢„æœŸè¾“å‡ºï¼š20000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReentrantLock">ReentrantLock</h3>
<p>ReentrantLock æ˜¯<strong>æ‚²è§‚é”ï¼Œå¯é‡å…¥é”ï¼Œå¯ä¸­æ–­é”ï¼Œé‡é‡çº§é”</strong></p>
<p>è‡ªå£°æ˜ä½¿ç”¨çš„é”ï¼Œç±»ä¼¼äºç»å…¸æ“ä½œç³»ç»Ÿä¸­æ‰€ä½¿ç”¨çš„æ¡ˆä¾‹é”ï¼›è¯¥é”ä¸€èˆ¬æ”¾åœ¨å †åŒºï¼Œç”±è¯¥è¿›ç¨‹ä¸­çš„çº¿ç¨‹å…±äº«ä½¿ç”¨ï¼›</p>
<blockquote>
<p>æ¯”synchronizedæ›´é«˜çº§ï¼Œä¾èµ–äºAPI</p>
</blockquote>
<p>reentrant lock å†…éƒ¨ç±» Sync ç»§æ‰¿ AQS</p>
<p>å†…éƒ¨ç±» NonfairSync FairSync ç»§æ‰¿ å†…éƒ¨ç±» Sync</p>
<p>Condition å¸¸ç”¨æ–¹æ³• await() æ–¹æ³•  signal() æ–¹æ³•   signalAll() æ–¹æ³•</p>
<p>await() æ–¹æ³•ç”±çº¿ç¨‹è°ƒç”¨ï¼Œå°†è‡ªå·±åŠ å…¥conditionçš„ç­‰å¾…é˜Ÿåˆ—</p>
<p>signal() æ–¹æ³•ï¼Ÿ</p>
<p>ä¸»è¦åŠŸèƒ½å’Œä½œç”¨ï¼š</p>
<ol>
<li><strong>ç®¡ç†ç­‰å¾…çº¿ç¨‹çš„é˜Ÿåˆ—</strong>ï¼š <code>ConditionObject</code> ä½¿ç”¨ <code>Node</code> æ¥è¡¨ç¤º <strong>ç­‰å¾…é˜Ÿåˆ—</strong> ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨ <code>await()</code> æ—¶ä¼šè¢«å°è£…æˆä¸€ä¸ª <code>Node</code> å¯¹è±¡ï¼ŒåŠ å…¥åˆ° <code>ConditionObject</code> çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚è¯¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œ<code>ConditionObject</code> é€šè¿‡è¿™ä¸ªé˜Ÿåˆ—ç®¡ç†çº¿ç¨‹çš„ç­‰å¾…ä¸å”¤é†’ã€‚</li>
<li>çº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’ï¼š
<ul>
<li><code>await()</code>ï¼šå½“çº¿ç¨‹è°ƒç”¨ <code>await()</code> æ–¹æ³•æ—¶ï¼Œå®ƒä¼šè¿›å…¥ <strong>æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—</strong>ï¼Œå¹¶ä¸”è¯¥çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°æ»¡è¶³æŸäº›æ¡ä»¶åè¢«å”¤é†’ã€‚</li>
<li><code>signal()</code> å’Œ <code>signalAll()</code>ï¼šè¿™äº›æ–¹æ³•ç”¨äºå”¤é†’ç­‰å¾…åœ¨ <code>ConditionObject</code> ä¸Šçš„çº¿ç¨‹ã€‚å½“è°ƒç”¨ <code>signal()</code> æˆ– <code>signalAll()</code> æ—¶ï¼Œ<code>ConditionObject</code> ä¼šæ£€æŸ¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œå¹¶å°†è¿™äº›çº¿ç¨‹ç§»å›åˆ° <strong>åŒæ­¥é˜Ÿåˆ—</strong>ï¼ˆAQS çš„ CLH é˜Ÿåˆ—ï¼‰ï¼Œä½¿å®ƒä»¬æœ‰æœºä¼šé‡æ–°ç«äº‰é”ã€‚</li>
</ul>
</li>
<li><strong>èŠ‚ç‚¹è½¬ç§»</strong>ï¼š å½“çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œ<code>ConditionObject</code> ä¼šå°†èŠ‚ç‚¹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå¹¶é€šè¿‡ <code>AQS</code> ä¸­çš„ <strong>CLH åŒæ­¥é˜Ÿåˆ—</strong> ç»§ç»­å‚ä¸é”ç«äº‰ã€‚<code>Node</code> èŠ‚ç‚¹åœ¨è¿™é‡Œå……å½“äº† <strong>â€œç­‰å¾…â€çŠ¶æ€å’Œâ€œç«äº‰é”â€çŠ¶æ€â€</strong> ä¹‹é—´çš„æ¡¥æ¢ã€‚</li>
</ol>
<p><code>ReentrantLock</code> çš„ <code>ConditionObject</code> ï¼Œå½“è°ƒç”¨ <code>ConditionObject</code> çš„ <code>signal()</code> æ–¹æ³•æ—¶ï¼Œå”¤é†’çš„çº¿ç¨‹ä¼šè¢«é€å›åˆ° <code>ReentrantLock</code> çš„ <strong>CLH é˜Ÿåˆ—</strong> ä¸­ï¼Œä»¥ç»§ç»­ç«äº‰é”ã€‚</p>
<h3 id="Atomic">Atomic</h3>
<p>Atomicç±» åº•å±‚ <code>unsafe.getAndAddInt</code> volatileçš„å˜é‡å’ŒCAS</p>
<p><code>ReentrantLock</code>  åº•å±‚ unsafe çš„ park/unpark</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// unsafe ç±» getAndAddInt æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAddInt</span><span class="params">(Object paramObject, <span class="type">long</span> paramLong, <span class="type">int</span> paramInt)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">do</span></span><br><span class="line">      <span class="variable">i</span> <span class="operator">=</span> getIntVolatile(paramObject, paramLong);</span><br><span class="line">    <span class="keyword">while</span> (!compareAndSwapInt(paramObject, paramLong, i, i + paramInt));</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Concurrent-HashMap">Concurrent HashMap</h3>
<p><code>ConcurrentHashMap</code> æ˜¯ Java æä¾›çš„çº¿ç¨‹å®‰å…¨ <code>Map</code> å®ç°ï¼Œå…¶åœ¨ <strong>JDK 1.7</strong> å’Œ <strong>JDK 1.8</strong> é‡‡ç”¨äº†ä¸åŒçš„æœºåˆ¶æ¥æé«˜å¹¶å‘æ€§èƒ½ï¼š</p>
<hr>
<p><strong>JDK 1.7ï¼šåˆ†æ®µé”ï¼ˆSegment Lockingï¼‰</strong></p>
<p><strong>è®¾è®¡ç»“æ„</strong></p>
<p>åœ¨ JDK 1.7 ç‰ˆæœ¬ä¸­ï¼Œ<code>ConcurrentHashMap</code> é‡‡ç”¨äº† <strong>åˆ†æ®µé”ï¼ˆSegment Lockingï¼‰</strong> æœºåˆ¶ï¼Œå³ <strong>å°†æ•´ä¸ª HashMap æ‹†åˆ†æˆå¤šä¸ªå°çš„ Segmentï¼ˆæ®µï¼‰</strong>ï¼Œæ¯ä¸ª Segment ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ <code>HashMap</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ConcurrentHashMap</span><br><span class="line"> â”œâ”€â”€ Segment 0 ï¼ˆé” 0ï¼‰</span><br><span class="line"> â”œâ”€â”€ Segment 1 ï¼ˆé” 1ï¼‰</span><br><span class="line"> â”œâ”€â”€ Segment 2 ï¼ˆé” 2ï¼‰</span><br><span class="line"> â”œâ”€â”€ ...</span><br><span class="line"> â”œâ”€â”€ Segment N-1 ï¼ˆé” N-1ï¼‰</span><br></pre></td></tr></table></figure>
<p><strong>æ¯ä¸ª <code>Segment</code> ç»´æŠ¤è‡ªå·±çš„ HashMap å’Œé”ï¼Œæ‰€ä»¥ä¸åŒçš„ <code>Segment</code> ä¹‹é—´å¯ä»¥å¹¶è¡Œè®¿é—®ï¼Œå‡å°‘é”ç«äº‰ã€‚</strong></p>
<hr>
<p><strong>ä¸»è¦æ“ä½œ</strong></p>
<ol>
<li><strong>put æ“ä½œ</strong>
<ul>
<li>è®¡ç®— key çš„ hash å€¼ï¼Œå®šä½åˆ°å¯¹åº”çš„ <code>Segment</code>ã€‚</li>
<li>è·å– <code>Segment</code> çš„é”ï¼Œæ‰§è¡Œ <code>put</code> æ“ä½œã€‚</li>
<li>é‡Šæ”¾é”ã€‚</li>
</ul>
</li>
<li><strong>get æ“ä½œ</strong>
<ul>
<li>è®¡ç®— key çš„ hash å€¼ï¼Œæ‰¾åˆ° <code>Segment</code>ã€‚</li>
<li><strong>ä¸éœ€è¦åŠ é”</strong>ï¼Œç›´æ¥è®¿é—®æ•°æ®ï¼Œæé«˜æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><strong>æ‰©å®¹ï¼ˆrehashï¼‰</strong>
<ul>
<li>åªæœ‰ä¸€ä¸ª <code>Segment</code> æ‰©å®¹ï¼Œä¸å½±å“å…¶ä»– <code>Segment</code>ï¼Œé™ä½ <code>rehash</code> çš„æ€§èƒ½æŸè€—ã€‚</li>
</ul>
</li>
</ol>
<hr>
<p><strong>JDK 1.8ï¼šCAS + Synchronized</strong></p>
<p>ä» JDK 1.8 å¼€å§‹ï¼Œ<code>ConcurrentHashMap</code> <strong>ç§»é™¤äº† <code>Segment</code>ï¼Œæ”¹ç”¨ <code>Node[]</code> ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œå¹¶ç»“åˆ CASï¼ˆæ— é”æ“ä½œï¼‰+ <code>synchronized</code>ï¼ˆé”ç«äº‰ï¼‰</strong> æœºåˆ¶ã€‚</p>
<p><strong>è®¾è®¡ç»“æ„</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ConcurrentHashMap</span><br><span class="line"> â”œâ”€â”€ Node 0 ï¼ˆCAS æ“ä½œï¼‰</span><br><span class="line"> â”œâ”€â”€ Node 1 ï¼ˆæ— é”ï¼‰</span><br><span class="line"> â”œâ”€â”€ Node 2 ï¼ˆsynchronizedï¼‰</span><br><span class="line"> â”œâ”€â”€ ...</span><br><span class="line"> â”œâ”€â”€ Node N-1 ï¼ˆCAS æ“ä½œï¼‰</span><br></pre></td></tr></table></figure>
<ul>
<li>é‡‡ç”¨ <strong>æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</strong> ç»“æ„ï¼Œç±»ä¼¼ <code>HashMap</code>ã€‚</li>
<li><strong>æ•°æ®åˆ†å¸ƒåœ¨ <code>Node[]</code> ä¸­ï¼Œä¸å†ä½¿ç”¨ <code>Segment[]</code></strong>ï¼Œç®€åŒ–ç»“æ„ã€‚</li>
<li>é‡‡ç”¨ <strong>CAS + synchronized</strong> æ§åˆ¶å¹¶å‘ï¼Œæå‡æ€§èƒ½ã€‚</li>
</ul>
<hr>
<p><strong>ä¸»è¦ä¼˜åŒ–</strong></p>
<ol>
<li><strong>put æ“ä½œ</strong>
<ul>
<li>å¦‚æœç›®æ ‡æ¡¶ï¼ˆ<code>Node[]</code>ï¼‰ä¸ºç©ºï¼Œä½¿ç”¨ <strong>CAS æ“ä½œ</strong> ç›´æ¥æ’å…¥ï¼Œé¿å…åŠ é”ã€‚</li>
<li>å¦‚æœç›®æ ‡æ¡¶æœ‰æ•°æ®ï¼š
<ul>
<li>è‹¥æ— å¹¶å‘å†²çªï¼Œé‡‡ç”¨ <strong>æ— é”æ“ä½œ</strong> ä¿®æ”¹æ•°æ®ã€‚</li>
<li>è‹¥æœ‰å¹¶å‘å†²çªï¼Œä½¿ç”¨ <strong>synchronized</strong> é”å®šè¯¥æ¡¶ï¼Œé¿å…æ•°æ®ç«äº‰ã€‚</li>
</ul>
</li>
<li><strong>é“¾è¡¨é•¿åº¦è¶…è¿‡ 8 æ—¶ï¼Œè‡ªåŠ¨è½¬ä¸ºçº¢é»‘æ ‘ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</strong></li>
</ul>
</li>
<li><strong>get æ“ä½œ</strong>
<ul>
<li>ç›´æ¥è¯»å– <code>Node[]</code>ï¼Œæ— é”æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><strong>æ‰©å®¹ï¼ˆrehashï¼‰</strong>
<ul>
<li><code>ConcurrentHashMap</code> é‡‡ç”¨ <strong>å¤šçº¿ç¨‹å¹¶å‘æ‰©å®¹</strong>ï¼Œä¸åŒçº¿ç¨‹å¯ä»¥åŒæ—¶å¸®åŠ©è¿ç§»æ•°æ®ï¼Œæå‡æ‰©å®¹æ•ˆç‡ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>åœ¨ Java ä¸­ï¼Œ<code>ConcurrentHashMap</code> å’Œ <code>HashMap</code> å¯¹äºæ’å…¥ç©ºé”®å’Œç©ºå€¼çš„å¤„ç†æ–¹å¼æ˜¯ä¸åŒçš„ã€‚</p>
<p><code>ConcurrentHashMap</code></p>
<ul>
<li><strong>ä¸å…è®¸æ’å…¥ç©ºé”®</strong>ï¼š<code>ConcurrentHashMap</code> ä¸å…è®¸æ’å…¥ç©ºé”®ï¼ˆ<code>null</code> keyï¼‰ã€‚å¦‚æœä½ å°è¯•æ’å…¥ä¸€ä¸ªç©ºé”®ï¼Œä¼šæŠ›å‡º <code>NullPointerException</code>ã€‚</li>
<li><strong>ä¸å…è®¸æ’å…¥ç©ºå€¼</strong>ï¼š<code>ConcurrentHashMap</code> ä¹Ÿä¸å…è®¸æ’å…¥ç©ºå€¼ï¼ˆ<code>null</code> valueï¼‰ã€‚åŒæ ·ï¼Œå¦‚æœä½ å°è¯•æ’å…¥ä¸€ä¸ªç©ºå€¼ï¼Œä¼šæŠ›å‡º <code>NullPointerException</code>ã€‚</li>
</ul>
<p><strong>åŸå› </strong>ï¼š<code>ConcurrentHashMap</code> çš„è®¾è®¡ç›®æ ‡æ˜¯æ”¯æŒé«˜å¹¶å‘çš„åœºæ™¯ã€‚ä¸ºäº†ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§å’Œä¸€è‡´æ€§ï¼Œ<code>ConcurrentHashMap</code> åœ¨å†…éƒ¨ä½¿ç”¨äº†å¤æ‚çš„é”æœºåˆ¶å’Œå¹¶å‘æ§åˆ¶ç­–ç•¥ã€‚å…è®¸ç©ºé”®æˆ–ç©ºå€¼ä¼šå¢åŠ å®ç°çš„å¤æ‚æ€§ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´æ­§ä¹‰æˆ–ä¸ç¡®å®šçš„è¡Œä¸ºã€‚å› æ­¤ï¼Œ<code>ConcurrentHashMap</code> ç›´æ¥ç¦æ­¢äº†ç©ºé”®å’Œç©ºå€¼çš„ä½¿ç”¨ã€‚</p>
<p><code>HashMap</code></p>
<ul>
<li><strong>å…è®¸æ’å…¥ç©ºé”®</strong>ï¼š<code>HashMap</code> å…è®¸æ’å…¥ç©ºé”®ï¼ˆ<code>null</code> keyï¼‰ã€‚ä½ å¯ä»¥å°†ä¸€ä¸ªé”®è®¾ç½®ä¸º <code>null</code>ï¼Œå¹¶ä¸” <code>HashMap</code> ä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„é”®ã€‚</li>
<li><strong>å…è®¸æ’å…¥ç©ºå€¼</strong>ï¼š<code>HashMap</code> ä¹Ÿå…è®¸æ’å…¥ç©ºå€¼ï¼ˆ<code>null</code> valueï¼‰ã€‚ä½ å¯ä»¥å°†å€¼è®¾ç½®ä¸º <code>null</code>ï¼Œå¹¶ä¸” <code>HashMap</code> ä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„å€¼ã€‚</li>
</ul>
<p><strong>åŸå› </strong>ï¼š<code>HashMap</code> çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºå•çº¿ç¨‹ç¯å¢ƒæä¾›é«˜æ•ˆçš„é”®å€¼å¯¹å­˜å‚¨ã€‚å®ƒæ²¡æœ‰å¹¶å‘æ§åˆ¶çš„éœ€æ±‚ï¼Œå› æ­¤å¯ä»¥æ›´çµæ´»åœ°å¤„ç†ç©ºé”®å’Œç©ºå€¼ã€‚å…è®¸ç©ºé”®å’Œç©ºå€¼å¯ä»¥ç®€åŒ–æŸäº›åœºæ™¯ä¸‹çš„ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨éœ€è¦è¡¨ç¤ºâ€œä¸å­˜åœ¨â€æˆ–â€œæœªå®šä¹‰â€çš„æƒ…å†µä¸‹ã€‚</p>
</blockquote>
<h3 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h3>
<p><strong><code>Executor</code> æ¥å£</strong></p>
<p><code>Executor</code> æ˜¯ Java å¹¶å‘åŒ… (<code>java.util.concurrent</code>) ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæ¥å£ï¼Œç”¨äºå°†ä»»åŠ¡çš„æäº¤ä¸ä»»åŠ¡çš„æ‰§è¡Œåˆ†ç¦»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecutorExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Executor</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(command).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        executor.execute(() -&gt; System.out.println(<span class="string">&quot;Task executed by Executor&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>Executors</code> å·¥å…·ç±»</strong></p>
<p><code>Executors</code> æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†è®¸å¤šé™æ€å·¥å‚æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºä¸åŒç±»å‹çš„çº¿ç¨‹æ± ã€‚è¿™äº›çº¿ç¨‹æ± æ˜¯ <code>ExecutorService</code> æ¥å£çš„å®ç°ï¼ˆ<code>ExecutorService</code> æ˜¯ <code>Executor</code> çš„å­æ¥å£ï¼‰ï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°ç®¡ç†çº¿ç¨‹æ± ã€‚</p>
<p><code>Executors</code> çš„ä¸»è¦ä½œç”¨æ˜¯ï¼š<strong>ç®€åŒ–çº¿ç¨‹æ± çš„åˆ›å»º</strong>ã€‚å®ƒæä¾›äº†ä»¥ä¸‹å¸¸è§çš„çº¿ç¨‹æ± ç±»å‹ï¼š</p>
<ul>
<li><strong>å›ºå®šå¤§å°çº¿ç¨‹æ± </strong>ï¼š<code>Executors.newFixedThreadPool(int nThreads)</code></li>
<li><strong>å•çº¿ç¨‹æ± </strong>ï¼š<code>Executors.newSingleThreadExecutor()</code></li>
<li><strong>ç¼“å­˜çº¿ç¨‹æ± </strong>ï¼š<code>Executors.newCachedThreadPool()</code></li>
<li><strong>è°ƒåº¦çº¿ç¨‹æ± </strong>ï¼š<code>Executors.newScheduledThreadPool(int corePoolSize)</code></li>
</ul>
<p><strong><code>ThreadPoolExecutor</code> ç±»</strong></p>
<p><code>ThreadPoolExecutor</code> æ˜¯ <code>ExecutorService</code> æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„çº¿ç¨‹æ± ç®¡ç†åŠŸèƒ½ã€‚å®ƒå…è®¸ä½ é…ç½®æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€çº¿ç¨‹ç©ºé—²æ—¶é—´ã€ä»»åŠ¡é˜Ÿåˆ—ç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutorExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºçº¿ç¨‹æ± </span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">2</span>, <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="number">4</span>, <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="number">60</span>, <span class="comment">// çº¿ç¨‹ç©ºé—²æ—¶é—´</span></span><br><span class="line">            TimeUnit.SECONDS, <span class="comment">// æ—¶é—´å•ä½</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;() <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æäº¤ä»»åŠ¡</span></span><br><span class="line">        executor.execute(() -&gt; System.out.println(<span class="string">&quot;Task 1 executed by ThreadPoolExecutor&quot;</span>));</span><br><span class="line">        executor.execute(() -&gt; System.out.println(<span class="string">&quot;Task 2 executed by ThreadPoolExecutor&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>çº¿ç¨‹æ± çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</strong></p>
<img src="/2025/01/17/Java/java-thread-x-executors-2.png" class="" title="img">
<p><strong>EXECUTEæµç¨‹</strong></p>
<img src="/2025/01/17/Java/02ede02b26c85d797a995abf520e08b5.png" class="" title="threadPool">
<p><strong>çº¿ç¨‹æ± ç±»å‹</strong></p>
<p><code>newFixedThreadPool</code></p>
<p>å®ƒä¼šåˆ›å»ºå›ºå®šæ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”è¿™äº›çº¿ç¨‹ä¼šä¸€ç›´å­˜æ´»ï¼Œç›´åˆ°çº¿ç¨‹æ± è¢«æ˜¾å¼åœ°å…³é—­ï¼ˆé€šè¿‡è°ƒç”¨ <code>shutdown()</code> æˆ– <code>shutdownNow()</code> æ–¹æ³•ï¼‰ï¼Œå³ä½¿çº¿ç¨‹æ± æ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¹Ÿä¸ä¼šé‡Šæ”¾çº¿ç¨‹ã€‚</p>
<p><code>FixedThreadPool</code>çš„å·¥ä½œé˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—<code>LinkedBlockingQueue</code>(é˜Ÿåˆ—å®¹é‡ä¸º<code>Integer.MAX_VALUE</code>), è¿™ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜:</p>
<ul>
<li>çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹æ•°é‡ä¸è¶…è¿‡<code>corePoolSize</code>,è¿™å¯¼è‡´äº†<code>maximumPoolSize</code>å’Œ<code>keepAliveTime</code>å°†ä¼šæ˜¯ä¸ªæ— ç”¨å‚æ•°</li>
<li>ç”±äºä½¿ç”¨äº†æ— ç•Œé˜Ÿåˆ—, æ‰€ä»¥<code>FixedThreadPool</code>æ°¸è¿œä¸ä¼šæ‹’ç», å³é¥±å’Œç­–ç•¥å¤±æ•ˆ</li>
</ul>
<p><code>newSingleThreadExecutor</code></p>
<p>åˆå§‹åŒ–çš„çº¿ç¨‹æ± ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœè¯¥çº¿ç¨‹å¼‚å¸¸ç»“æŸï¼Œä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œå”¯ä¸€çš„çº¿ç¨‹å¯ä»¥ä¿è¯æ‰€æäº¤ä»»åŠ¡çš„é¡ºåºæ‰§è¡Œ.</p>
<p>ç”±äºä½¿ç”¨äº†æ— ç•Œé˜Ÿåˆ—, æ‰€ä»¥SingleThreadPoolæ°¸è¿œä¸ä¼šæ‹’ç», å³é¥±å’Œç­–ç•¥å¤±æ•ˆ</p>
<p><code>newCachedThreadPool</code></p>
<p>çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°å¯è¾¾åˆ°<code>Integer.MAX_VALUE</code>ï¼Œå³2147483647ï¼Œå†…éƒ¨ä½¿ç”¨<code>SynchronousQueue</code>ä½œä¸ºé˜»å¡é˜Ÿåˆ—ï¼› å’Œ<code>newFixedThreadPool</code>åˆ›å»ºçš„çº¿ç¨‹æ± ä¸åŒï¼Œ<code>newCachedThreadPool</code>åœ¨æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå½“çº¿ç¨‹çš„ç©ºé—²æ—¶é—´è¶…è¿‡<code>keepAliveTime</code>ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾çº¿ç¨‹èµ„æºï¼Œå½“æäº¤æ–°ä»»åŠ¡æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä¼šå¯¼è‡´ä¸€å®šçš„ç³»ç»Ÿå¼€é”€ï¼› æ‰§è¡Œè¿‡ç¨‹ä¸å‰ä¸¤ç§ç¨å¾®ä¸åŒ:</p>
<ul>
<li>ä¸»çº¿ç¨‹è°ƒç”¨<code>SynchronousQueue</code>çš„<code>offer()</code>æ–¹æ³•æ”¾å…¥task, å€˜è‹¥æ­¤æ—¶çº¿ç¨‹æ± ä¸­æœ‰ç©ºé—²çš„çº¿ç¨‹å°è¯•è¯»å– <code>SynchronousQueue</code>çš„task, å³è°ƒç”¨äº†<code>SynchronousQueue</code>çš„<code>poll()</code>, é‚£ä¹ˆä¸»çº¿ç¨‹å°†è¯¥taskäº¤ç»™ç©ºé—²çº¿ç¨‹. å¦åˆ™æ‰§è¡Œ(2)</li>
<li>å½“çº¿ç¨‹æ± ä¸ºç©ºæˆ–è€…æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹, åˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡.</li>
<li>æ‰§è¡Œå®Œä»»åŠ¡çš„çº¿ç¨‹å€˜è‹¥åœ¨60så†…ä»ç©ºé—², åˆ™ä¼šè¢«ç»ˆæ­¢. å› æ­¤é•¿æ—¶é—´ç©ºé—²çš„<code>CachedThreadPool</code>ä¸ä¼šæŒæœ‰ä»»ä½•çº¿ç¨‹èµ„æº</li>
</ul>
<hr>
<p>è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼š<a href="https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ThreadPoolExecutor.html">https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ThreadPoolExecutor.html</a></p>
<p><strong>æ‹’ç»ç­–ç•¥</strong></p>
<p><code>handler </code> çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼Œå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”æ²¡æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œå¿…é¡»é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†è¯¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æä¾›äº†4ç§ç­–ç•¥:</p>
<ul>
<li><code>AbortPolicy</code>: ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼›</li>
<li><code>CallerRunsPolicy</code>: ç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›</li>
<li><code>DiscardOldestPolicy</code>: ä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼›</li>
<li><code>DiscardPolicy</code>: ç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼›</li>
</ul>
<p><strong>é…ç½®çº¿ç¨‹æ± éœ€è¦è€ƒè™‘å› ç´ </strong></p>
<p>ä»ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´é•¿çŸ­ï¼Œä»»åŠ¡çš„æ€§è´¨(CPUå¯†é›†/ IOå¯†é›†)ï¼Œä»»åŠ¡çš„ä¾èµ–å…³ç³»è¿™å››ä¸ªè§’åº¦æ¥åˆ†æã€‚å¹¶ä¸”è¿‘å¯èƒ½åœ°ä½¿ç”¨æœ‰ç•Œçš„å·¥ä½œé˜Ÿåˆ—ã€‚</p>
<p>æ€§è´¨ä¸åŒçš„ä»»åŠ¡å¯ç”¨ä½¿ç”¨ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± åˆ†å¼€å¤„ç†:</p>
<ul>
<li>CPUå¯†é›†å‹: å°½å¯èƒ½å°‘çš„çº¿ç¨‹ï¼ŒN_cpu+1</li>
<li>IOå¯†é›†å‹: å°½å¯èƒ½å¤šçš„çº¿ç¨‹, N_cpu*2ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± </li>
<li>æ··åˆå‹: CPUå¯†é›†å‹çš„ä»»åŠ¡ä¸IOå¯†é›†å‹ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å·®åˆ«è¾ƒå°ï¼Œæ‹†åˆ†ä¸ºä¸¤ä¸ªçº¿ç¨‹æ± ï¼›å¦åˆ™æ²¡æœ‰å¿…è¦æ‹†åˆ†</li>
</ul>
<p><strong>çº¿ç¨‹æ± å…³é—­</strong></p>
<p><code>shutdown()</code></p>
<ul>
<li><strong>åŠŸèƒ½:</strong> å¯åŠ¨ä¸€ä¸ª<strong>å¹³æ»‘å…³é—­</strong>è¿‡ç¨‹ã€‚</li>
<li><strong>è¡Œä¸º:</strong>
<ul>
<li>é˜»æ­¢æ–°ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ã€‚</li>
<li>å…è®¸çº¿ç¨‹æ± ä¸­å·²æäº¤çš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ­£åœ¨æ‰§è¡Œå’Œç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼‰å®Œæˆã€‚</li>
<li>çº¿ç¨‹æ± ä¸ä¼šç«‹å³åœæ­¢æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰å¾…æ‰€æœ‰å·²æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œæ‰çœŸæ­£å…³é—­ã€‚</li>
</ul>
</li>
<li><strong>è¿”å›å€¼:</strong> æ— è¿”å›å€¼ã€‚</li>
<li><strong>ä½¿ç”¨åœºæ™¯:</strong> é€‚ç”¨äºå¸Œæœ›çº¿ç¨‹æ± ä¼˜é›…å…³é—­ï¼Œç¡®ä¿æ‰€æœ‰å·²æäº¤çš„ä»»åŠ¡éƒ½å¾—åˆ°å¤„ç†çš„æƒ…å†µã€‚</li>
</ul>
<p><code>shutdownNow()</code></p>
<ul>
<li><strong>åŠŸèƒ½:</strong> å°è¯•<strong>å¼ºåˆ¶å…³é—­</strong>çº¿ç¨‹æ± ã€‚</li>
<li><strong>è¡Œä¸º:</strong>
<ul>
<li>é˜»æ­¢æ–°ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ã€‚</li>
<li>å°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆé€šè¿‡ä¸­æ–­çº¿ç¨‹çš„æ–¹å¼ï¼‰ã€‚</li>
<li>è·³è¿‡æ‰€æœ‰ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«è¿™äº›æœªæ‰§è¡Œä»»åŠ¡çš„ Listã€‚</li>
</ul>
</li>
<li><strong>è¿”å›å€¼:</strong> è¿”å› List&lt;Runnable&gt;ï¼Œå…¶ä¸­åŒ…å«åœ¨ shutdown æ—¶ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚</li>
<li><strong>ä½¿ç”¨åœºæ™¯:</strong> é€‚ç”¨äºéœ€è¦ç«‹å³åœæ­¢çº¿ç¨‹æ± ï¼Œè€Œä¸å…³å¿ƒæœªå®Œæˆä»»åŠ¡çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼Œåœ¨åº”ç”¨ç¨‹åºé‡åˆ°ä¸¥é‡é”™è¯¯éœ€è¦ç«‹å³é€€å‡ºæ—¶ã€‚</li>
</ul>
<h2 id="JVM">JVM</h2>
<p><a href="https://tangxman.github.io/2015/07/27/the-difference-of-java-string-pool/">https://tangxman.github.io/2015/07/27/the-difference-of-java-string-pool/</a></p>
-1722133033018.JPG)
<h3 id="æ–‡ä»¶">æ–‡ä»¶</h3>
<blockquote>
<p>ä¸€ä¸ª <strong>.class</strong> <strong>æ–‡ä»¶å¯¹åº”ä¸€ä¸ª Class æ–‡ä»¶å¸¸é‡æ± !!!</strong></p>
</blockquote>
<p><strong>Class æ–‡ä»¶å¸¸é‡æ±  ï¼š</strong></p>
<ul>
<li><strong>å­˜å‚¨ç±»å’Œæ¥å£çš„å¸¸é‡ä¿¡æ¯ï¼š</strong> Class æ–‡ä»¶å¸¸é‡æ± æ˜¯ Class æ–‡ä»¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå­˜å‚¨äº†ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œä¸»è¦åŒ…æ‹¬ï¼š
<ul>
<li><strong>å­—é¢é‡ (Literals):</strong> åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ã€å­—ç¬¦ä¸²ã€null å€¼ç­‰ã€‚</li>
<li><strong>ç¬¦å·å¼•ç”¨ (Symbolic References):</strong> ç±»å’Œæ¥å£çš„å…¨é™å®šåã€å­—æ®µåã€æ–¹æ³•åã€æ–¹æ³•æè¿°ç¬¦ç­‰ã€‚</li>
</ul>
</li>
<li><strong>æ”¯æŒç±»åŠ è½½å’Œé“¾æ¥ï¼š</strong> åœ¨ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼ŒJVM ä¼šè¯»å– Class æ–‡ä»¶å¸¸é‡æ± ä¸­çš„ä¿¡æ¯ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨ã€‚</li>
</ul>
<p><strong>Class æ–‡ä»¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ± çš„å…³ç³»ï¼š</strong></p>
<ul>
<li><strong>å­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯ Class æ–‡ä»¶å¸¸é‡æ± çš„ä¸€éƒ¨åˆ†ï¼š</strong> Class æ–‡ä»¶å¸¸é‡æ± ä¸­åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„åŒºåŸŸï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²å­—é¢é‡ï¼Œè¿™ä¸ªåŒºåŸŸå°±æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ã€‚</li>
<li><strong>ç±»åŠ è½½æ—¶ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± çš„å†…å®¹ä¼šè¢«åŠ è½½åˆ°å…¨å±€å­—ç¬¦ä¸²æ± (è¿è¡Œæ—¶)ï¼š</strong> è¿™æ ·ï¼Œä¸åŒçš„ç±»å°±å¯ä»¥å…±äº«ç›¸åŒçš„å­—ç¬¦ä¸²å¯¹è±¡ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ã€‚</li>
</ul>
<h3 id="JVMå†…å­˜">JVMå†…å­˜</h3>
<h4 id="Nonheapï¼ˆéå †ï¼‰"><strong>Nonheapï¼ˆéå †ï¼‰</strong></h4>
<p><strong>æ–¹æ³•åŒº/å…ƒç©ºé—´å¯èƒ½ç±»ä¿¡æ¯</strong></p>
<ul>
<li><strong>className, superClassName, accessFlags, interfaceNames, sourceFile</strong>: è¿™äº›æ˜¯ç±»çš„åŸºæœ¬ä¿¡æ¯ï¼Œå±äºå…ƒæ•°æ®ï¼Œå­˜å‚¨åœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´ã€‚</li>
<li><strong>fieldTable</strong>: å­—æ®µä¿¡æ¯è¡¨ï¼ŒåŒ…å«æ¯ä¸ªå­—æ®µçš„æè¿°ä¿¡æ¯ï¼Œå­˜å‚¨åœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´ã€‚</li>
<li><strong>methodTable</strong>: æ–¹æ³•ä¿¡æ¯è¡¨ï¼ŒåŒ…å«æ¯ä¸ªæ–¹æ³•çš„æè¿°ä¿¡æ¯ï¼Œå­˜å‚¨åœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´ã€‚</li>
<li><strong>instanceSize</strong>: å®ä¾‹å¤§å°æ˜¯ç±»çº§åˆ«çš„ä¿¡æ¯ã€‚</li>
<li><strong>innerClasses, enclosingMethod, genericSignature, runtimeVisibleTypeAnnotations, bootstrapMethods, version, minorVersion, majorVersion, constantValueAttributes, methodHandles, exceptions, nestMembers, nestHost, permittedSubclasses, recordComponents</strong>: è¿™äº›ä¿¡æ¯éƒ½å±äºç±»çš„å…ƒæ•°æ®ï¼Œå­˜å‚¨åœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´ã€‚</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Class Info  <span class="comment">// ä»…ä¾›å‚è€ƒï¼Œå­˜åœ¨é”™è¯¯</span></span><br><span class="line">|</span><br><span class="line">+---&gt; className<span class="punctuation">:</span> <span class="string">&quot;com/example/MyClass&quot;</span></span><br><span class="line">+---&gt; superClassName<span class="punctuation">:</span> <span class="string">&quot;java/lang/Object&quot;</span></span><br><span class="line">+---&gt; accessFlags<span class="punctuation">:</span> <span class="number">0x0021</span> (PUBLIC | SUPER)</span><br><span class="line">+---&gt; interfaceNames<span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;java/lang/Runnable&quot;</span><span class="punctuation">,</span> <span class="string">&quot;java/io/Serializable&quot;</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; fieldTable<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      +---&gt; FieldInfo <span class="punctuation">&#123;</span></span><br><span class="line">|      |       fieldName<span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       fieldType<span class="punctuation">:</span> <span class="string">&quot;I&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       accessFlags<span class="punctuation">:</span> <span class="number">0x0002</span> (PRIVATE)<span class="punctuation">,</span></span><br><span class="line">|      |       attributes<span class="punctuation">:</span> <span class="punctuation">[</span>ConstantValue<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">|      |     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      +---&gt; FieldInfo <span class="punctuation">&#123;</span></span><br><span class="line">|      |       fieldName<span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       fieldType<span class="punctuation">:</span> <span class="string">&quot;Ljava/lang/String;&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       accessFlags<span class="punctuation">:</span> <span class="number">0x0004</span> (PROTECTED)<span class="punctuation">,</span></span><br><span class="line">|      |       attributes<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">|      |     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      +---&gt; FieldInfo <span class="punctuation">&#123;</span></span><br><span class="line">|      |       fieldName<span class="punctuation">:</span> <span class="string">&quot;constValue&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       fieldType<span class="punctuation">:</span> <span class="string">&quot;I&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       accessFlags<span class="punctuation">:</span> <span class="number">0x0009</span> (PUBLIC | STATIC)<span class="punctuation">,</span></span><br><span class="line">|      |       attributes<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">|      |     <span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; methodTable<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      +---&gt; MethodInfo <span class="punctuation">&#123;</span></span><br><span class="line">|      |       methodName<span class="punctuation">:</span> <span class="string">&quot;&lt;init&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       methodSignature<span class="punctuation">:</span> <span class="string">&quot;()V&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       accessFlags<span class="punctuation">:</span> <span class="number">0x0001</span> (PUBLIC)<span class="punctuation">,</span></span><br><span class="line">|      |       attributes<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      |         Code<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">|      |           maxStack<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">|      |           maxLocals<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">|      |           code<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">0x2A</span><span class="punctuation">,</span> <span class="number">0xB7</span><span class="punctuation">,</span> <span class="number">0x00</span><span class="punctuation">,</span> <span class="number">0x01</span><span class="punctuation">,</span> <span class="number">0xB1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">|      |           exceptionTable<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">|      |           lineNumberTable<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      |             <span class="punctuation">&#123;</span>start_pc<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> line_number<span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">&#125;</span></span><br><span class="line">|      |           <span class="punctuation">]</span></span><br><span class="line">|      |         <span class="punctuation">&#125;</span></span><br><span class="line">|      |       <span class="punctuation">]</span></span><br><span class="line">|      |     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      +---&gt; MethodInfo <span class="punctuation">&#123;</span></span><br><span class="line">|      |       methodName<span class="punctuation">:</span> <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       methodSignature<span class="punctuation">:</span> <span class="string">&quot;()V&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      |       accessFlags<span class="punctuation">:</span> <span class="number">0x0001</span> (PUBLIC)<span class="punctuation">,</span></span><br><span class="line">|      |       attributes<span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span></span><br><span class="line">|      |     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      +---&gt; MethodInfo <span class="punctuation">&#123;</span></span><br><span class="line">|              methodName<span class="punctuation">:</span> <span class="string">&quot;&lt;clinit&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">|              methodSignature<span class="punctuation">:</span> <span class="string">&quot;()V&quot;</span><span class="punctuation">,</span></span><br><span class="line">|              accessFlags<span class="punctuation">:</span> <span class="number">0x0008</span> (STATIC)<span class="punctuation">,</span></span><br><span class="line">|              attributes<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|                Code<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">|                  maxStack<span class="punctuation">:</span> ...<span class="punctuation">,</span></span><br><span class="line">|                  maxLocals<span class="punctuation">:</span> ...<span class="punctuation">,</span></span><br><span class="line">|                  code<span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">|                  exceptionTable<span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">|                  lineNumberTable<span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span></span><br><span class="line">|                <span class="punctuation">&#125;</span></span><br><span class="line">|              <span class="punctuation">]</span></span><br><span class="line">|            <span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; constantPool<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">:</span> Unused</span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;com/example/MyClass&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Class_info <span class="punctuation">&#123;</span> name_index<span class="punctuation">:</span> <span class="number">1</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;java/lang/Object&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Class_info <span class="punctuation">&#123;</span> name_index<span class="punctuation">:</span> <span class="number">3</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">5</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;id&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;I&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">7</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;name&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">8</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;Ljava/lang/String;&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">9</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;&lt;init&gt;&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ConstantPoolInfo<span class="punctuation">[</span><span class="number">10</span><span class="punctuation">]</span><span class="punctuation">:</span> CONSTANT_Utf8_info <span class="punctuation">&#123;</span> <span class="string">&quot;()V&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">|      +---&gt; ... (more constant pool entries)</span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; sourceFile<span class="punctuation">:</span> <span class="string">&quot;MyClass.java&quot;</span></span><br><span class="line">+---&gt; innerClasses<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      <span class="punctuation">&#123;</span></span><br><span class="line">|        innerClassName<span class="punctuation">:</span> <span class="string">&quot;InnerClass&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        outerClassName<span class="punctuation">:</span> <span class="string">&quot;com/example/MyClass&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        innerName<span class="punctuation">:</span> <span class="string">&quot;InnerClass&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        innerClassAccessFlags<span class="punctuation">:</span> <span class="number">0x0009</span> (PUBLIC | STATIC)</span><br><span class="line">|      <span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; enclosingMethod<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; genericSignature<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; runtimeVisibleAnnotations<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      @java.lang.Deprecated<span class="punctuation">,</span></span><br><span class="line">|      @java.lang.SuppressWarnings(<span class="string">&quot;unchecked&quot;</span>)</span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; runtimeVisibleTypeAnnotations<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; bootstrapMethods<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; version<span class="punctuation">:</span> <span class="number">52.0</span></span><br><span class="line">+---&gt; minorVersion<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">+---&gt; majorVersion<span class="punctuation">:</span> <span class="number">52</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Meta Info  <span class="comment">// ä»…ä¾›å‚è€ƒï¼Œå­˜åœ¨é”™è¯¯</span></span><br><span class="line">|</span><br><span class="line">+---&gt; classMetadata<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">|      <span class="comment">// åŒ…å«ä¸Šè¿°Classä¿¡æ¯çš„æ‰€æœ‰å†…å®¹</span></span><br><span class="line">|    <span class="punctuation">&#125;</span></span><br><span class="line">+---&gt; methodMetadata<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      <span class="punctuation">&#123;</span></span><br><span class="line">|        methodName<span class="punctuation">:</span> <span class="string">&quot;&lt;init&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        compiledCode<span class="punctuation">:</span> &lt;native code address&gt;<span class="punctuation">,</span></span><br><span class="line">|        interpreterEntry<span class="punctuation">:</span> &lt;interpreter entry point&gt;<span class="punctuation">,</span></span><br><span class="line">|        nativeEntry<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">|        bytecodeSize<span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">|        maxStack<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">|        maxLocals<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">|        exceptionTable<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">|        invocationCounter<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">|        backedgeCounter<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">|      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      <span class="punctuation">&#123;</span></span><br><span class="line">|        methodName<span class="punctuation">:</span> <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        <span class="comment">// ... similar structure to &lt;init&gt;</span></span><br><span class="line">|      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      <span class="punctuation">&#123;</span></span><br><span class="line">|        methodName<span class="punctuation">:</span> <span class="string">&quot;&lt;clinit&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        <span class="comment">// ... similar structure to &lt;init&gt;</span></span><br><span class="line">|      <span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; fieldLayout<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      <span class="punctuation">&#123;</span>fieldName<span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> offset<span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      <span class="punctuation">&#123;</span>fieldName<span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span> offset<span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; vtableLength<span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">+---&gt; vtable<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      &lt;address of Object.hashCode&gt;<span class="punctuation">,</span></span><br><span class="line">|      &lt;address of Object.equals&gt;<span class="punctuation">,</span></span><br><span class="line">|      &lt;address of Object.toString&gt;<span class="punctuation">,</span></span><br><span class="line">|      &lt;address of MyClass.run&gt;<span class="punctuation">,</span></span><br><span class="line">|      &lt;address of Object.finalize&gt;</span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; itableLength<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">+---&gt; itable<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      <span class="punctuation">&#123;</span></span><br><span class="line">|        interface<span class="punctuation">:</span> <span class="string">&quot;java/lang/Runnable&quot;</span><span class="punctuation">,</span></span><br><span class="line">|        methods<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|          <span class="punctuation">&#123;</span>methodName<span class="punctuation">:</span> <span class="string">&quot;run&quot;</span><span class="punctuation">,</span> methodAddress<span class="punctuation">:</span> &lt;address of MyClass.run&gt;<span class="punctuation">&#125;</span></span><br><span class="line">|        <span class="punctuation">]</span></span><br><span class="line">|      <span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; instanceSize<span class="punctuation">:</span> <span class="number">24</span> bytes</span><br><span class="line">+---&gt; staticFieldValues<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; constantValueAttributes<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      <span class="punctuation">&#123;</span>fieldIndex<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> constantValue<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; methodHandles<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; exceptions<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; nestMembers<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; nestHost<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; permittedSubclasses<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; recordComponents<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br></pre></td></tr></table></figure>
<p><strong>é™æ€å˜é‡ (Static Variables)ï¼š</strong></p>
<ul>
<li>é™æ€å˜é‡çš„å€¼å’Œå…¶æè¿°ä¿¡æ¯ï¼ˆå¦‚å­—æ®µåã€ç±»å‹ç­‰ï¼‰éƒ½å­˜å‚¨åœ¨<strong>æ–¹æ³•åŒº/å…ƒç©ºé—´</strong>ã€‚æ›´å…·ä½“åœ°è¯´ï¼š
<ul>
<li>æè¿°ä¿¡æ¯å­˜å‚¨åœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´çš„ fieldTable ä¸­ã€‚</li>
<li>å€¼ä¹Ÿå­˜å‚¨åœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´ä¸­ï¼Œä¸ç±»çš„å…¶ä»–é™æ€æ•°æ®ä¸€èµ·ã€‚</li>
</ul>
</li>
</ul>
<p>å½“ Java ä»£ç è®¿é—®é™æ€å˜é‡æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æ­¥éª¤:</p>
<ol>
<li>è™šæ‹Ÿæœºæ ¹æ®å˜é‡åæ‰¾åˆ°å¯¹åº”çš„ <strong>Class å¯¹è±¡</strong>ã€‚</li>
<li>åœ¨ Class å¯¹è±¡çš„ <strong>fieldTable</strong> ä¸­æ‰¾åˆ°è¯¥é™æ€å˜é‡çš„ <strong>FieldInfo</strong> ç»“æ„ä½“ã€‚</li>
<li><strong>ç›´æ¥ä»æ–¹æ³•åŒº/å…ƒç©ºé—´</strong> ä¸­è¯»å–è¯¥é™æ€å˜é‡çš„å€¼ï¼Œè€Œ<strong>ä¸éœ€è¦é€šè¿‡å†…å­˜åœ°å€é—´æ¥è®¿é—®</strong>ã€‚</li>
</ol>
<blockquote>
<p>ä¸€ä¸ªç±»åœ¨ JVM å†…å­˜ä¸­å¯¹åº”ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± ï¼</p>
</blockquote>
<p><strong>è¿è¡Œæ—¶å¸¸é‡æ±  (Runtime Constant Pool)ï¼ˆå¤šä¸ªï¼‰ï¼š</strong></p>
<ul>
<li><strong>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†</strong>ï¼Œæ¯ä¸ªç±»æˆ–æ¥å£éƒ½å¯¹åº”ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± ã€‚</li>
<li><strong>å®ƒæ˜¯ Class æ–‡ä»¶å¸¸é‡æ± çš„è¿è¡Œæ—¶è¡¨ç¤ºå½¢å¼ã€‚</strong></li>
<li>å½“ç±»åŠ è½½å™¨å°† Class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œä¼šä¸ºè¯¥ç±»åˆ›å»ºè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¹¶å°† Class æ–‡ä»¶å¸¸é‡æ± ä¸­çš„å†…å®¹åŠ è½½åˆ°å…¶ä¸­ã€‚</li>
</ul>
<p>è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å­˜å‚¨çš„å†…å®¹ä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>å­—é¢é‡ (Literals):</strong> ä¾‹å¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€null å€¼ç­‰ã€‚</li>
<li><strong>ç¬¦å·å¼•ç”¨ (Symbolic References):</strong> ä¾‹å¦‚ç±»å’Œæ¥å£çš„å…¨é™å®šåã€å­—æ®µåã€æ–¹æ³•åã€æ–¹æ³•æè¿°ç¬¦ç­‰ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">species</span> <span class="operator">=</span> <span class="string">&quot;Human&quot;</span>;  <span class="comment">// é™æ€å˜é‡</span></span><br><span class="line"> <span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.name = name;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BRAND</span> <span class="operator">=</span> <span class="string">&quot;Tesla&quot;</span>; <span class="comment">// é™æ€å¸¸é‡</span></span><br><span class="line"> <span class="keyword">public</span> String model;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">Car</span><span class="params">(String model)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.model = model;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å½“è¿™ä¸¤ä¸ªç±»éƒ½è¢«åŠ è½½åˆ° JVM ä¸­åï¼Œæ–¹æ³•åŒºä¸­å¤§è‡´ä¼šå­˜å‚¨ä»¥ä¸‹ä¿¡æ¯ï¼š</strong></p>
<p><strong>1.  ç±»ä¿¡æ¯:</strong></p>
<ul>
<li><code>Person</code> ç±»çš„ç±»å‹ä¿¡æ¯ï¼š åŒ…æ‹¬ç±»çš„å®Œæ•´åç§° (<code>Person</code>)ã€çˆ¶ç±» (<code>java.lang.Object</code>)ã€æ¥å£ï¼ˆæ— ï¼‰ã€è®¿é—®ä¿®é¥°ç¬¦ (<code>public</code>) ç­‰ã€‚</li>
<li><code>Car</code> ç±»çš„ç±»å‹ä¿¡æ¯ï¼š åŒ…æ‹¬ç±»çš„å®Œæ•´åç§° (<code>Car</code>)ã€çˆ¶ç±» (<code>java.lang.Object</code>)ã€æ¥å£ï¼ˆæ— ï¼‰ã€è®¿é—®ä¿®é¥°ç¬¦ (<code>public</code>) ç­‰ã€‚</li>
</ul>
<p><strong>2.  å­—æ®µä¿¡æ¯:</strong></p>
<ul>
<li><code>Person.species</code>:  å­—æ®µåã€ç±»å‹ (<code>java.lang.String</code>)ã€è®¿é—®ä¿®é¥°ç¬¦ (<code>public static</code>)ã€‚</li>
<li><code>Person.name</code>:  å­—æ®µåã€ç±»å‹ (<code>java.lang.String</code>)ã€è®¿é—®ä¿®é¥°ç¬¦ (<code>public</code>)ã€‚</li>
<li><code>Car.BRAND</code>:  å­—æ®µåã€ç±»å‹ (<code>java.lang.String</code>)ã€è®¿é—®ä¿®é¥°ç¬¦ (<code>public static final</code>)ã€‚</li>
<li><code>Car.model</code>:  å­—æ®µåã€ç±»å‹ (<code>java.lang.String</code>)ã€è®¿é—®ä¿®é¥°ç¬¦ (<code>public</code>)ã€‚</li>
</ul>
<p><strong>3. æ–¹æ³•ä¿¡æ¯:</strong></p>
<ul>
<li><code>Person</code> ç±»çš„æ„é€ æ–¹æ³•å’Œä»»ä½•å…¶ä»–æ–¹æ³•çš„åç§°ã€è¿”å›ç±»å‹ã€å‚æ•°åˆ—è¡¨ã€è®¿é—®ä¿®é¥°ç¬¦ã€æ–¹æ³•ä½“ï¼ˆå­—èŠ‚ç ï¼‰ã€‚</li>
<li><code>Car</code> ç±»çš„æ„é€ æ–¹æ³•å’Œä»»ä½•å…¶ä»–æ–¹æ³•çš„åç§°ã€è¿”å›ç±»å‹ã€å‚æ•°åˆ—è¡¨ã€è®¿é—®ä¿®é¥°ç¬¦ã€æ–¹æ³•ä½“ï¼ˆå­—èŠ‚ç ï¼‰ã€‚</li>
</ul>
<p><strong>4.  è¿è¡Œæ—¶å¸¸é‡æ± :</strong></p>
<blockquote>
<p>ä¸»è¦ç”¨äºå­˜å‚¨å¸¸é‡å€¼ï¼ˆå¦‚å­—ç¬¦ä¸²å­—é¢é‡çš„å¼•ç”¨ï¼ˆ<code>&quot;Human&quot;</code>çš„å¼•ç”¨ï¼‰ã€æ•°å­—å­—é¢é‡ï¼ˆ10ï¼‰ç­‰ï¼‰ï¼Œè¿™äº›å€¼åœ¨ç¼–è¯‘æ—¶å·²ç¡®å®šï¼Œä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
</blockquote>
<ul>
<li><code>Person</code> ç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼š åŒ…å«å­—ç¬¦ä¸²å­—é¢é‡çš„å¼•ç”¨ <code>&quot;Human&quot;</code>ã€â€œnameâ€ ç­‰ï¼Œä»¥åŠ <code>Person</code> æ„é€ æ–¹æ³•ã€<code>species</code> å­—æ®µçš„ç¬¦å·å¼•ç”¨ç­‰ã€‚</li>
<li><code>Car</code> ç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼š åŒ…å«å­—ç¬¦ä¸²å­—é¢é‡çš„å¼•ç”¨ <code>&quot;Tesla&quot;</code>ã€â€œmodelâ€ ç­‰ï¼Œä»¥åŠ <code>Car</code> æ„é€ æ–¹æ³•ã€<code>BRAND</code> å­—æ®µçš„ç¬¦å·å¼•ç”¨ç­‰ã€‚</li>
</ul>
<p><strong>5.  é™æ€å˜é‡:</strong></p>
<blockquote>
<p>å­˜å‚¨äºéå †ï¼Œè¿è¡Œæ—¶å¯å‘é€æ”¹å˜</p>
</blockquote>
<ul>
<li><code>Person.species</code>:  å­˜å‚¨å®é™…çš„å€¼ <code>&quot;Human&quot;</code>ã€‚</li>
<li><code>Car.BRAND</code>:  å­˜å‚¨å®é™…çš„å€¼ <code>&quot;Tesla&quot;</code>ã€‚</li>
</ul>
<p><strong>6. Class å¯¹è±¡:</strong></p>
<ul>
<li><code>Person.class</code> å¯¹è±¡ï¼šå­˜å‚¨ <code>Person</code> ç±»çš„ç±»å‹ä¿¡æ¯ã€å­—æ®µä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ç­‰çš„å¼•ç”¨ã€‚</li>
<li><code>Car.class</code> å¯¹è±¡ï¼šå­˜å‚¨ <code>Car</code> ç±»çš„ç±»å‹ä¿¡æ¯ã€å­—æ®µä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ç­‰çš„å¼•ç”¨ã€‚</li>
</ul>
<h4 id="Heap-å †"><strong>Heap (å †)</strong></h4>
<img src="/2025/01/17/Java/image-20240728103642872.png" class="" title="image-20240728103642872">
<p><strong>æ™®é€šå¯¹è±¡</strong></p>
<p><strong>Classå¯¹è±¡</strong>ï¼ï¼ï¼</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Class Object  <span class="comment">// ä»…ä¾›å‚è€ƒï¼Œå­˜åœ¨é”™è¯¯</span></span><br><span class="line">|</span><br><span class="line">+---&gt; classLoader<span class="punctuation">:</span> SystemClassLoader</span><br><span class="line">+---&gt; protectionDomain<span class="punctuation">:</span> ProtectionDomain <span class="punctuation">&#123;</span></span><br><span class="line">|      codeSource<span class="punctuation">:</span> CodeSource <span class="punctuation">&#123;</span> location<span class="punctuation">:</span> <span class="string">&quot;file:/path/to/MyClass.class&quot;</span><span class="punctuation">,</span> certs<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">|      permissions<span class="punctuation">:</span> Permissions <span class="punctuation">&#123;</span> ... <span class="punctuation">&#125;</span></span><br><span class="line">|    <span class="punctuation">&#125;</span></span><br><span class="line">+---&gt; className<span class="punctuation">:</span> <span class="string">&quot;com.example.MyClass&quot;</span></span><br><span class="line">+---&gt; packageName<span class="punctuation">:</span> <span class="string">&quot;com.example&quot;</span></span><br><span class="line">+---&gt; modifiers<span class="punctuation">:</span> <span class="number">0x0021</span> (PUBLIC | SUPER)</span><br><span class="line">+---&gt; superClass<span class="punctuation">:</span> Class object for <span class="string">&quot;java.lang.Object&quot;</span></span><br><span class="line">+---&gt; interfaces<span class="punctuation">:</span> <span class="punctuation">[</span>Class object for <span class="string">&quot;java.lang.Runnable&quot;</span><span class="punctuation">,</span> Class object for <span class="string">&quot;java.io.Serializable&quot;</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; declaredFields<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      Field object for <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      Field object for <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      Field object for <span class="string">&quot;constValue&quot;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; declaredMethods<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      Method object for <span class="string">&quot;&lt;init&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">|      Method object for <span class="string">&quot;run&quot;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; declaredConstructors<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      Constructor object for <span class="string">&quot;&lt;init&gt;&quot;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; annotations<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      @java.lang.Deprecated<span class="punctuation">,</span></span><br><span class="line">|      @java.lang.SuppressWarnings(<span class="string">&quot;unchecked&quot;</span>)</span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; innerClasses<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">|      Class object for <span class="string">&quot;com.example.MyClass$InnerClass&quot;</span></span><br><span class="line">|    <span class="punctuation">]</span></span><br><span class="line">+---&gt; enclosingMethod<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; enclosingClass<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; genericInfo<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; typeParameters<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">+---&gt; enumConstants<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">+---&gt; classVersion<span class="punctuation">:</span> <span class="number">52.0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Class å¯¹è±¡æœ¬èº«æ˜¯ Java å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å †ä¸Šã€‚Class å¯¹è±¡åŒ…å«æŒ‡å‘æ–¹æ³•åŒº/å…ƒç©ºé—´çš„æŒ‡é’ˆï¼Œç”¨äºè®¿é—®ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ <code>fieldTable</code>, <code>methodTable</code>, <code>constantPool</code> ç­‰ã€‚</p>
<ul>
<li><strong>methodTable æŒ‡é’ˆ</strong>: Class å¯¹è±¡ä¸­çš„ methodTable æŒ‡é’ˆæŒ‡å‘æ–¹æ³•åŒº/å…ƒç©ºé—´ä¸­å­˜å‚¨çš„æ–¹æ³•ä¿¡æ¯æ•°ç»„ã€‚</li>
<li><strong>Runtime Constant Pool æŒ‡é’ˆ</strong>: Class å¯¹è±¡åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æŒ‡é’ˆï¼Œè¯¥å¸¸é‡æ± ä¹Ÿä½äºæ–¹æ³•åŒº/å…ƒç©ºé—´ã€‚</li>
</ul>
</blockquote>
<p><strong>å…¨å±€å­—ç¬¦ä¸²æ±  (String Pool)ï¼ˆJDK7 ä»¥åï¼‰:</strong></p>
<ul>
<li><strong>å…¨å±€å­—ç¬¦ä¸²æ± </strong> æ˜¯ JVM çº§åˆ«ç»´æŠ¤çš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œæ‰€æœ‰ç±»å…±äº«ã€‚</li>
<li>æ¯ä¸ªç±»æˆ–æ¥å£éƒ½æœ‰è‡ªå·±çš„<strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>ï¼Œå­˜å‚¨åœ¨è¯¥ç±»æˆ–æ¥å£çš„å­—èŠ‚ç æ–‡ä»¶ä¸­ã€‚</li>
<li>ç±»åŠ è½½æ—¶ï¼Œç±»çš„å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²ä¼šè¢«åŠ è½½åˆ°å…¨å±€å­—ç¬¦ä¸²æ± ä¸­ã€‚</li>
<li>String.intern() æ–¹æ³•å¯ä»¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²æ‰‹åŠ¨æ·»åŠ åˆ°å…¨å±€å­—ç¬¦ä¸²æ± ä¸­ã€‚</li>
</ul>
<p><strong>classLoader</strong>: ç±»åŠ è½½å™¨æ˜¯ Java å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å †ä¸Šã€‚</p>
<p><strong>protectionDomain</strong>: ä¿æŠ¤åŸŸå¯¹è±¡ä¹Ÿæ˜¯ Java å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å †ä¸Šã€‚</p>
<p><strong>runtimeAnnotations</strong>: è¿è¡Œæ—¶æ³¨è§£æ˜¯ Java å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å †ä¸Šã€‚</p>
<h4 id="Thread-çº¿ç¨‹"><strong>Thread (çº¿ç¨‹)</strong></h4>
<p><strong>è™šæ‹Ÿæœºæ ˆ (JVM Stack)</strong></p>
<ul>
<li><strong>æ¯ä¸ªçº¿ç¨‹ç§æœ‰</strong>ï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œé”€æ¯è€Œé”€æ¯ã€‚</li>
<li><strong>å­˜å‚¨ Java æ–¹æ³•æ‰§è¡Œçš„ä¿¡æ¯ï¼š</strong> æ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ (Stack Frame) å¹¶å‹å…¥è™šæ‹Ÿæœºæ ˆï¼Œæ ˆå¸§ä¸­å­˜å‚¨äº†ï¼š
<ul>
<li><strong>å±€éƒ¨å˜é‡è¡¨ (Local Variable Array):</strong> å­˜å‚¨æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚</li>
<li><strong>æ“ä½œæ•°æ ˆ (Operand Stack):</strong> ç”¨äºå­˜å‚¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœã€‚</li>
<li><strong>åŠ¨æ€é“¾æ¥ (Dynamic Linking):</strong> å­˜å‚¨æ–¹æ³•è¿”å›å€¼çš„åœ°å€ã€å¼‚å¸¸å¤„ç†è¡¨ç­‰ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li><strong>æ–¹æ³•æ‰§è¡Œå®Œåï¼Œå¯¹åº”çš„æ ˆå¸§ä¼šå‡ºæ ˆï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚</strong></li>
<li><strong>å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦è¶…è¿‡äº†è™šæ‹Ÿæœºæ ˆæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œä¼šæŠ›å‡º StackOverflowError å¼‚å¸¸ã€‚</strong></li>
<li><strong>å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œä½†æ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°±ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚</strong></li>
</ul>
<p><strong>æœ¬åœ°æ–¹æ³•æ ˆ (Native Method Stack)</strong></p>
<ul>
<li><strong>ä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</strong></li>
<li><strong>ä¸º native æ–¹æ³•æœåŠ¡ï¼š</strong> native æ–¹æ³•æ˜¯æŒ‡ä½¿ç”¨ Java ä»¥å¤–çš„è¯­è¨€ï¼ˆä¾‹å¦‚ C/C++ï¼‰ç¼–å†™çš„æ–¹æ³•ã€‚</li>
<li><strong>ä¸åŒçš„è™šæ‹Ÿæœºå®ç°æ–¹å¼ä¸åŒï¼š</strong> æœ‰äº›è™šæ‹Ÿæœºï¼ˆä¾‹å¦‚ HotSpot VMï¼‰ç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚</li>
</ul>
<p><strong>ç¨‹åºè®¡æ•°å™¨ (Program Counter Register)</strong></p>
<p>è®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€ã€‚</p>
<blockquote>
<p>åç¨‹</p>
</blockquote>
<h3 id="GC">GC</h3>
<img src="/2025/01/17/Java/image-20240728103642872.png" class="" title="image-20240728103642872">
<h4 id="å †å†…å­˜åˆ’åˆ†"><strong>å †å†…å­˜åˆ’åˆ†</strong></h4>
<p>Java çš„å †å†…å­˜ä¸»è¦è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼š</p>
<ul>
<li><strong>æ–°ç”Ÿä»£ (Young Generation) 4 Minor GC:</strong>  å­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚ç”±äºå¤§å¤šæ•°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸéƒ½æ¯”è¾ƒçŸ­ï¼Œå› æ­¤æ–°ç”Ÿä»£çš„ç©ºé—´ç›¸å¯¹è¾ƒå°ï¼Œåƒåœ¾å›æ”¶ä¹Ÿæ¯”è¾ƒé¢‘ç¹ã€‚æ–°ç”Ÿä»£åˆå¯ä»¥ç»†åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼š
<ul>
<li><strong>Eden åŒº:</strong> æ–°åˆ›å»ºçš„å¯¹è±¡é¦–å…ˆè¢«åˆ†é…åˆ°è¿™é‡Œ, ç©ºé—´ä¸è¶³æ—¶è§¦å‘Minor GC</li>
<li><strong>Survivor åŒº (From, To) 4 Major GC:</strong>  ç»å†è¿‡ä¸€æ¬¡ Minor GC åä»ç„¶å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ° Survivor åŒºã€‚æ–°ç”Ÿä»£æœ‰ä¸¤ä¸ª Survivor åŒºï¼Œæ¯æ¬¡ Minor GC åªä½¿ç”¨å…¶ä¸­ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªå¤„äºé—²ç½®çŠ¶æ€ã€‚<strong>å¤åˆ¶ç®—æ³•</strong></li>
</ul>
</li>
<li><strong>è€å¹´ä»£ (Old Generation):</strong>  å­˜æ”¾ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡ï¼Œä¾‹å¦‚ç¼“å­˜æ•°æ®ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚è€å¹´ä»£çš„ç©ºé—´æ¯”è¾ƒå¤§ï¼Œåƒåœ¾å›æ”¶é¢‘ç‡ä¹Ÿç›¸å¯¹è¾ƒä½ã€‚<strong>æ ‡è®°-æ¸…é™¤/æ ‡è®°-æ•´ç†ç®—æ³•</strong></li>
</ul>
<h4 id="åƒåœ¾æ”¶é›†ç±»å‹">åƒåœ¾æ”¶é›†ç±»å‹</h4>
<blockquote>
<p>ä¼ ç»Ÿåƒåœ¾æ”¶é›†å™¨ï¼ˆå¤§éƒ¨åˆ†é˜¶æ®µï¼‰ä¼šè§¦å‘STWï¼Œç°ä»£ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ˆå°é˜¶æ®µï¼‰è§¦å‘STW</p>
</blockquote>
<p>Java ä¸­çš„åƒåœ¾æ”¶é›†ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p>
<ul>
<li>
<p><strong>éƒ¨åˆ†æ”¶é›† (Partial GC):</strong>  åªæ”¶é›†éƒ¨åˆ†å †å†…å­˜ç©ºé—´ï¼Œé¢‘ç‡è¾ƒé«˜ã€‚</p>
<ul>
<li>
<p><strong>æ–°ç”Ÿä»£æ”¶é›† (Minor GC/Young GC):</strong>  å›æ”¶ Eden åŒºå’Œä¸€ä¸ª Survivor åŒº (From Survivor åŒº) çš„å¯¹è±¡ã€‚</p>
<p>è§¦å‘æ¡ä»¶ï¼š</p>
<ul>
<li>å½“ Eden åŒºç©ºé—´ä¸è¶³æ—¶å°±ä¼šè§¦å‘ Minor GCã€‚</li>
</ul>
</li>
<li>
<p><strong>è€å¹´ä»£æ”¶é›† (Major GC/Old GC):</strong>  æ”¶é›†è€å¹´ä»£çš„åƒåœ¾ã€‚</p>
<p>è§¦å‘æ¡ä»¶ï¼š</p>
<ul>
<li>è€å¹´ä»£ç©ºé—´ä¸è¶³ã€‚</li>
<li>Minor GC åå­˜æ´»çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå¯¼è‡´è€å¹´ä»£ç©ºé—´ä¸è¶³ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>æ•´å †æ”¶é›† (Full GC):</strong>  æ”¶é›†æ•´ä¸ªå †å†…å­˜ç©ºé—´çš„åƒåœ¾ï¼ŒåŒ…æ‹¬æ–°ç”Ÿä»£ï¼Œè€å¹´ä»£ï¼Œæ°¸ä¹…ä»£/å…ƒç©ºé—´ã€‚Full GC çš„é¢‘ç‡å¾ˆä½ï¼Œä½†æ˜¯æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œä¼šé€ æˆåº”ç”¨ç¨‹åºçš„åœé¡¿ã€‚</p>
</li>
</ul>
<blockquote>
<p><strong>JDK6 update 24 åå›æ”¶è§„åˆ™</strong></p>
<p>åœ¨ JDK6 update 24 ä¹‹åï¼Œä¸ºäº†æ›´å¥½åœ°æ§åˆ¶ Full GC çš„è§¦å‘æ—¶æœºï¼Œå¼•å…¥äº†æ–°çš„å›æ”¶è§„åˆ™ï¼š</p>
<p><strong>åªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£ç©ºé—´æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°ï¼Œå°±ä¼šè¿›è¡Œ Minor GCï¼Œå¦åˆ™å°†è¿›è¡Œ Full GCã€‚</strong></p>
<ul>
<li><strong>è€å¹´ä»£çš„è¿ç»­ç©ºé—´:</strong>  æŒ‡è€å¹´ä»£ä¸­æœ€å¤§çš„ä¸€å—è¿ç»­å¯ç”¨ç©ºé—´ã€‚</li>
<li><strong>æ–°ç”Ÿä»£ç©ºé—´æ€»å¤§å°:</strong>  æŒ‡ Eden åŒºå’Œä¸¤ä¸ª Survivor åŒºçš„æ€»å¤§å°ã€‚</li>
<li><strong>å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°:</strong>  æŒ‡å†æ¬¡ Minor GC åæ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚</li>
</ul>
<p><strong>è¯¥è§„åˆ™çš„æ„ä¹‰:</strong></p>
<ul>
<li>å°½å¯èƒ½é¿å… Full GC çš„å‘ç”Ÿï¼Œå› ä¸º Full GC çš„æˆæœ¬å¾ˆé«˜ã€‚</li>
<li>å½“è€å¹´ä»£çš„è¿ç»­ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ–°ç”Ÿä»£çš„å¯¹è±¡æ—¶ï¼Œå³ä½¿è¿›è¡Œ Minor GC ä¹Ÿæ— æ³•é¿å… Full GCï¼Œå› æ­¤ç›´æ¥è¿›è¡Œ Full GC åè€Œæ•ˆç‡æ›´é«˜ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p><strong>æ°¸ä¹…ä»£åƒåœ¾å›æ”¶</strong></p>
<p>æ°¸ä¹…ä»£å†…å­˜åŒºåŸŸä¹Ÿä¼šè¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ°¸ä¹…ä»£çš„åƒåœ¾æ”¶é›†ä¸»è¦åŒ…åºŸå¼ƒå¸¸é‡å’Œæ— ç”¨çš„ç±»ï¼ˆè¢«ç±»åŠ è½½å™¨å¸è½½çš„Classï¼‰ã€‚æ°¸ä¹…ä»£è§¦å‘åƒåœ¾å›æ”¶çš„æ¡ä»¶æ¯”è¾ƒå›°éš¾ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p>
<ul>
<li>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ï¼›</li>
<li>åŠ è½½è¯¥ç±»çš„ClassLoaderå·²ç»è¢«å›æ”¶ï¼›</li>
<li>è¯¥ç±»å¯¹åº”çš„java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ï¼›</li>
</ul>
</blockquote>
<h4 id="å¯¹è±¡è½¬ç§»">å¯¹è±¡è½¬ç§»</h4>
<p><strong>å¯¹è±¡æ™‹å‡</strong></p>
<p>å½“ Eden åŒºç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šè§¦å‘ Minor GCã€‚Minor GC ä¼šå°† Eden åŒºä¸­å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ° Survivor åŒºã€‚å¦‚æœ Survivor åŒºä¹Ÿæ»¡äº†ï¼Œåˆ™ä¼šå°†éƒ¨åˆ†å­˜æ´»çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ã€‚</p>
<p><strong>æ™‹å‡è§„åˆ™:</strong></p>
<ul>
<li>æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œæ¯ç»å†ä¸€æ¬¡ Minor GCï¼Œå¹´é¾„è®¡æ•°å™¨å°±åŠ  1ã€‚å½“å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°ä¸€å®šé˜ˆå€¼ (é»˜è®¤æ˜¯ 15) æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ã€‚</li>
<li>å¦‚æœ Survivor åŒºä¸­ç›¸åŒå¹´é¾„çš„å¯¹è±¡æ€»å¤§å°è¶…è¿‡ Survivor åŒºç©ºé—´çš„ä¸€åŠï¼Œåˆ™å¹´é¾„å¤§äºç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡ä¹Ÿä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ã€‚ï¼ï¼ï¼</li>
</ul>
<h4 id="åƒåœ¾å›æ”¶ç®—æ³•"><strong>åƒåœ¾å›æ”¶ç®—æ³•</strong></h4>
<p>åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§Stop the Worldçš„çŠ¶æ€ã€‚åœ¨<strong>Stop the World</strong>çŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚</p>
<p><strong>æ ‡è®°ç®—æ³•ï¼šå¼•ç”¨è®¡æ•°ç®—æ³•</strong></p>
<blockquote>
<p>Javaåƒåœ¾å›æ”¶æ²¡æœ‰é‡‡ç”¨è¯¥æ–¹æ³•</p>
</blockquote>
<p>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ã€‚ç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚</p>
<p>å¯¹äºä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„å¼•ç”¨è®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡1ã€‚åªè¦å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œå³è¡¨ç¤ºå¯¹è±¡Aä¸å¯èƒ½å†è¢«ä½¿ç”¨ï¼Œå¯è¿›è¡Œå›æ”¶ã€‚</p>
<p>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ï¼›åˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>å®ƒéœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†<strong>å­˜å‚¨ç©ºé—´çš„å¼€é”€</strong>ã€‚</li>
<li>æ¯æ¬¡èµ‹å€¼éƒ½éœ€è¦æ›´æ–°è®¡æ•°å™¨ï¼Œä¼´éšç€åŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œè¿™å¢åŠ äº†<strong>æ—¶é—´å¼€é”€</strong>ã€‚</li>
<li>å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³<strong>æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨</strong>çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€æ¡è‡´å‘½ç¼ºé™·ï¼Œå¯¼è‡´åœ¨Javaçš„åƒåœ¾å›æ”¶å™¨ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ç±»ç®—æ³•ã€‚</li>
</ol>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.cn/post/6981812825735987208">https://juejin.cn/post/6981812825735987208</a></p>
<p><strong>æ ‡è®°ç®—æ³•ï¼šå¯è¾¾æ€§åˆ†æç®—æ³•</strong></p>
<blockquote>
<p>Javaåƒåœ¾å›æ”¶ä½¿ç”¨äº†è¯¥ç®—æ³•</p>
</blockquote>
<p>å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥æ ¹å¯¹è±¡é›†åˆï¼ˆGCRootsï¼‰ä¸ºèµ·å§‹ç‚¹ï¼ŒæŒ‰ç…§ä»ä¸Šè‡³ä¸‹çš„æ–¹å¼<strong>æœç´¢è¢«æ ¹å¯¹è±¡é›†åˆæ‰€è¿æ¥çš„ç›®æ ‡å¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚</strong></p>
<p>ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•åï¼Œå†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–é—´æ¥è¿æ¥ç€ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸º<strong>å¼•ç”¨é“¾</strong>ï¼ˆReference Chainï¼‰</p>
<p>å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™æ˜¯ä¸å¯è¾¾çš„ï¼Œå°±æ„å‘³ç€è¯¥å¯¹è±¡å·±ç»æ­»äº¡ï¼Œå¯ä»¥æ ‡è®°ä¸ºåƒåœ¾å¯¹è±¡ã€‚</p>
<p>åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ï¼Œåªæœ‰èƒ½å¤Ÿè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–è€…é—´æ¥è¿æ¥çš„å¯¹è±¡æ‰æ˜¯å­˜æ´»å¯¹è±¡ã€‚</p>
<img src="/2025/01/17/Java/image-20240814154833539.png" class="" title="image-20240814154833539">
<blockquote>
<p>GC Roots å¯ä»¥æ˜¯ä»¥ä¸‹å…ƒç´ ï¼š</p>
<p><strong>è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡</strong></p>
<ul>
<li>æ¯”å¦‚ï¼šå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰ã€‚</li>
</ul>
<p>æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆé€šå¸¸è¯´çš„æœ¬åœ°æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡</p>
<p><strong>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</strong></p>
<ul>
<li>æ¯”å¦‚ï¼šJavaç±»çš„å¼•ç”¨ç±»å‹é™æ€å˜é‡</li>
</ul>
<p><strong>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</strong></p>
<ul>
<li>æ¯”å¦‚ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆStringTableï¼‰é‡Œçš„å¼•ç”¨</li>
</ul>
<p><strong>æ‰€æœ‰è¢«åŒæ­¥é”synchronizedæŒæœ‰çš„å¯¹è±¡</strong></p>
<p><strong>Javaè™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨</strong></p>
<ul>
<li>åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„Classå¯¹è±¡ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ï¼ˆå¦‚ï¼šNullPointerExceptionã€OutofMemoryErrorï¼‰ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ã€‚</li>
</ul>
<p><strong>åæ˜ javaè™šæ‹Ÿæœºå†…éƒ¨æƒ…å†µçš„JMXBeanã€JVMTIä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ç­‰</strong></p>
</blockquote>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.cn/post/6981812825735987208">https://juejin.cn/post/6981812825735987208</a></p>
<p><strong>æ¸…é™¤ç®—æ³•ï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•</strong></p>
<p>å½“å †ä¸­çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼ˆavailable memoryï¼‰è¢«è€—å°½çš„æ—¶å€™ï¼Œå°±ä¼šåœæ­¢æ•´ä¸ªç¨‹åºï¼ˆä¹Ÿè¢«ç§°ä¸ºstop the worldï¼‰ï¼Œç„¶åè¿›è¡Œä¸¤é¡¹å·¥ä½œï¼Œç¬¬ä¸€é¡¹åˆ™æ˜¯æ ‡è®°ï¼Œç¬¬äºŒé¡¹åˆ™æ˜¯æ¸…é™¤</p>
<ol>
<li>æ ‡è®°ï¼šCollectorä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚ä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ã€‚
<ul>
<li>æ³¨æ„ï¼šæ ‡è®°çš„æ˜¯è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å¯è¾¾å¯¹è±¡ï¼Œå¹¶éæ ‡è®°çš„æ˜¯å³å°†è¢«æ¸…é™¤çš„åƒåœ¾å¯¹è±¡</li>
</ul>
</li>
<li>æ¸…é™¤ï¼šCollectorå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§çš„éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶Headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶</li>
</ol>
<img src="/2025/01/17/Java/image-20240814161729364.png" class="" title="image-20240814161729364">
<blockquote>
<p>è¢«æ¸…é™¤çš„å¯¹è±¡å®é™…ä¸Šæ˜¯è¢«åŠ å…¥åˆ°äº†ç©ºé—²å†…å­˜åˆ—è¡¨ï¼Œä¸‹æ¬¡åˆ†é…å†…å­˜æ—¶è¯¥åŒºåŸŸä¸ºå¯ç”¨åŒºåŸŸï¼Œç›´æ¥è¦†ç›–å†™å…¥æ–°å†…å®¹</p>
</blockquote>
<p><strong>æ¸…é™¤ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•</strong></p>
<p>å°†æ´»ç€çš„å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œæœ€åå®Œæˆåƒåœ¾å›æ”¶</p>
<img src="/2025/01/17/Java/image-20240814161933420.png" class="" title="image-20240814161933420">
<p><strong>æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼ŒEdenåŒºå’ŒS0åŒºå­˜æ´»å¯¹è±¡æ•´ä½“å¤åˆ¶åˆ°S1åŒº</strong></p>
<img src="/2025/01/17/Java/image-20240814162137394.png" class="" title="image-20240814162137394">
<p><strong>æ¸…é™¤ç®—æ³•ï¼šæ ‡è®°-å‹ç¼©ç®—æ³•</strong></p>
<p>æ ‡è®°-å‹ç¼©ç®—æ³• ç­‰ä»·äºè¿›è¡Œ æ ‡è®°-æ¸…é™¤ç®—æ³•+å†…å­˜ç¢ç‰‡æ•´ç†</p>
<ol>
<li>ç¬¬ä¸€é˜¶æ®µå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨å¯¹è±¡</li>
<li>ç¬¬äºŒé˜¶æ®µå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾ã€‚ä¹‹åï¼Œæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ã€‚</li>
</ol>
<img src="/2025/01/17/Java/image-20240814162220131.png" class="" title="image-20240814162220131">
<h4 id="å¸¸è§åƒåœ¾æ”¶é›†å™¨">å¸¸è§åƒåœ¾æ”¶é›†å™¨</h4>
<hr>
<blockquote>
<p>å¹´è½»ä»£åƒåœ¾æ”¶é›†å™¨</p>
</blockquote>
<p><strong>Serial GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šå•çº¿ç¨‹ã€ä½¿ç”¨â€œå¤åˆ¶ç®—æ³•â€è¿›è¡Œåƒåœ¾å›æ”¶ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šä»…ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œä¼š<strong>æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹</strong>ï¼ˆStop-The-Worldï¼ŒSTWï¼‰ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•é«˜æ•ˆï¼Œé€‚åˆå•çº¿ç¨‹æˆ–å°å†…å­˜ç¯å¢ƒã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæ¡Œé¢åº”ç”¨ã€å°å‹åº”ç”¨ã€å•æ ¸CPUã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseSerialGC</code>ã€‚</li>
</ul>
<p><strong>ParNew GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šå¤šçº¿ç¨‹ç‰ˆçš„Serial GCï¼Œä½¿ç”¨â€œå¤åˆ¶ç®—æ³•â€ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šé€šè¿‡å¤šçº¿ç¨‹å¹¶è¡Œå›æ”¶å¹´è½»ä»£ï¼Œä¾ç„¶å­˜åœ¨STWã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šé€‚åˆå¤šæ ¸CPUç¯å¢ƒï¼Œå¸¸ä¸è€å¹´ä»£çš„CMS GCæ­é…ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseParNewGC</code>ã€‚</li>
</ul>
<p><strong>Parallel Scavenge GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šå¤šçº¿ç¨‹ã€æ³¨é‡<strong>ååé‡</strong>ï¼Œä½¿ç”¨â€œå¤åˆ¶ç®—æ³•â€ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šå¤šçº¿ç¨‹å¹¶è¡Œå›æ”¶ï¼Œä¼˜åŒ–ååé‡ï¼ˆGCæ—¶é—´ä¸åº”ç”¨è¿è¡Œæ—¶é—´çš„æ¯”å€¼ï¼‰ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šå¯è°ƒèŠ‚GCæš‚åœæ—¶é—´ä¸ååé‡ä¹‹é—´çš„å¹³è¡¡ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéœ€è¦é«˜ååé‡çš„åå°åº”ç”¨ç¨‹åºã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseParallelGC</code>ã€‚</li>
<li>å¸¸ç”¨è°ƒä¼˜å‚æ•°ï¼š
<ul>
<li><code>-XX:MaxGCPauseMillis=&lt;N&gt;</code>ï¼šè®¾ç½®æœ€å¤§GCæš‚åœæ—¶é—´ã€‚</li>
<li><code>-XX:GCTimeRatio=&lt;N&gt;</code>ï¼šè®¾ç½®ååé‡æ¯”ä¾‹ã€‚</li>
</ul>
</li>
</ul>
<hr>
<blockquote>
<p>è€å¹´ä»£åƒåœ¾æ”¶é›†å™¨</p>
</blockquote>
<p><strong>Serial Old GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šSerial GCçš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œä½¿ç”¨<strong>æ ‡è®°-æ•´ç†ç®—æ³•</strong>ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šå•çº¿ç¨‹ï¼Œå­˜åœ¨STWã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå•çº¿ç¨‹æˆ–å°å‹åº”ç”¨ï¼Œæˆ–ä¸å¹´è½»ä»£çš„Serial GCæ­é…ã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseSerialOldGC</code>ã€‚</li>
</ul>
<p><strong>CMS (Concurrent Mark-Sweep) GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šä½å»¶è¿Ÿã€å¹¶å‘å›æ”¶ï¼Œä½¿ç”¨<strong>æ ‡è®°-æ¸…é™¤ç®—æ³•</strong>ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šé€šè¿‡å¤šä¸ªé˜¶æ®µï¼ˆåˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°ã€é‡æ–°æ ‡è®°ã€å¹¶å‘æ¸…é™¤ï¼‰å›æ”¶åƒåœ¾ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šé™ä½STWæ—¶é—´ï¼Œé€‚åˆä½å»¶è¿Ÿåº”ç”¨ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå¯èƒ½äº§ç”Ÿ<strong>ç¢ç‰‡åŒ–</strong>ï¼Œéœ€è¦è§¦å‘<strong>Full GC</strong>ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„åº”ç”¨ã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseConcMarkSweepGC</code>ã€‚</li>
<li>å¸¸ç”¨è°ƒä¼˜å‚æ•°ï¼š
<ul>
<li><code>-XX:CMSInitiatingOccupancyFraction=&lt;N&gt;</code>ï¼šè®¾ç½®è€å¹´ä»£ä½¿ç”¨ç‡è¾¾åˆ°å¤šå°‘æ—¶è§¦å‘GCã€‚</li>
</ul>
</li>
</ul>
<hr>
<blockquote>
<p>æ•´å †åƒåœ¾æ”¶é›†å™¨</p>
</blockquote>
<p><strong>G1 (Garbage First) GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šåˆ†åŒºæ”¶é›†ï¼Œä½¿ç”¨<strong>æ··åˆç®—æ³•</strong>ï¼ˆæ ‡è®°-æ•´ç†ä¸ºä¸»ï¼Œæ ‡è®°-æ¸…é™¤ä¸ºè¾…ï¼‰ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šå°†å †åˆ’åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„åŒºåŸŸï¼ˆRegionï¼‰ï¼Œå¹¶ä¼˜å…ˆå›æ”¶åƒåœ¾æœ€å¤šçš„åŒºåŸŸã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šå¯æ§çš„GCæš‚åœæ—¶é—´ï¼Œå‡å°‘ç¢ç‰‡åŒ–ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéœ€è¦å¤§å†…å­˜ä¸”è¦æ±‚ä½å»¶è¿Ÿçš„åº”ç”¨ã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseG1GC</code>ã€‚</li>
<li>å¸¸ç”¨è°ƒä¼˜å‚æ•°ï¼š
<ul>
<li><code>-XX:MaxGCPauseMillis=&lt;N&gt;</code>ï¼šè®¾ç½®ç›®æ ‡æœ€å¤§æš‚åœæ—¶é—´ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ZGC (Z Garbage Collector)</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šè¶…ä½å»¶è¿Ÿã€ä½¿ç”¨<strong>æ ‡è®°-ç§»åŠ¨ç®—æ³•</strong>ï¼Œå‡ ä¹ä¸å—å †å¤§å°å½±å“ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šé€šè¿‡å¹¶å‘æ ‡è®°å’Œæ•´ç†ï¼Œç¡®ä¿STWæ—¶é—´é€šå¸¸åœ¨<strong>å‡ æ¯«ç§’å†…</strong>ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šæ”¯æŒéå¸¸å¤§çš„å †å†…å­˜ï¼ˆTBçº§ï¼‰ï¼Œé€‚åˆæä½å»¶è¿Ÿéœ€æ±‚ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå†…å­˜å ç”¨ç¨é«˜ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé‡‘èç³»ç»Ÿã€åœ¨çº¿äº¤æ˜“ç³»ç»Ÿç­‰é«˜å®æ—¶æ€§åœºæ™¯ã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseZGC</code>ã€‚</li>
<li>å¸¸ç”¨è°ƒä¼˜å‚æ•°ï¼š
<ul>
<li><code>-XX:MaxHeapSize=&lt;size&gt;</code>ï¼šè®¾ç½®æœ€å¤§å †å†…å­˜ã€‚</li>
</ul>
</li>
</ul>
<p><strong>Shenandoah GC</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šä½å»¶è¿Ÿã€å¹¶å‘å›æ”¶ï¼Œä½¿ç”¨<strong>æ ‡è®°-æ•´ç†ç®—æ³•</strong>ã€‚</li>
<li><strong>å·¥ä½œæ–¹å¼</strong>ï¼šä¸ZGCç±»ä¼¼ï¼Œç›®æ ‡æ˜¯æœ€å°åŒ–STWæ—¶é—´ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šæ”¯æŒå¤§å †å†…å­˜ï¼Œå»¶è¿Ÿæä½ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé«˜å®æ—¶æ€§åº”ç”¨ã€‚</li>
<li><strong>é…ç½®å‚æ•°</strong>ï¼š<code>-XX:+UseShenandoahGC</code>ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>GC</th>
<th>ä¸»è¦ç®—æ³•</th>
<th>å¤šçº¿ç¨‹æ”¯æŒ</th>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>Serial</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>å¦</td>
<td>ç®€å•é«˜æ•ˆ</td>
<td>æš‚åœæ—¶é—´é•¿</td>
<td>å•çº¿ç¨‹ã€å°å‹åº”ç”¨</td>
</tr>
<tr>
<td>ParNew</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>æ˜¯</td>
<td>å¹¶è¡Œå›æ”¶å¹´è½»ä»£</td>
<td>STWæ—¶é—´ä»å­˜åœ¨</td>
<td>å¤šçº¿ç¨‹ç¯å¢ƒ</td>
</tr>
<tr>
<td>Parallel Scavenge</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>æ˜¯</td>
<td>é«˜ååé‡</td>
<td>æš‚åœæ—¶é—´ä¸ç¡®å®š</td>
<td>åå°æ‰¹é‡å¤„ç†åº”ç”¨</td>
</tr>
<tr>
<td>Serial Old</td>
<td>æ ‡è®°-æ•´ç†ç®—æ³•</td>
<td>å¦</td>
<td>ç®€å•é«˜æ•ˆ</td>
<td>å•çº¿ç¨‹</td>
<td>æ­é…Serial GC</td>
</tr>
<tr>
<td>CMS</td>
<td>æ ‡è®°-æ¸…é™¤ç®—æ³•</td>
<td>æ˜¯</td>
<td>ä½å»¶è¿Ÿã€å¹¶å‘å›æ”¶</td>
<td>å†…å­˜ç¢ç‰‡</td>
<td>å“åº”æ—¶é—´æ•æ„Ÿçš„åº”ç”¨</td>
</tr>
<tr>
<td>G1</td>
<td>æ ‡è®°-æ•´ç†ç®—æ³•</td>
<td>æ˜¯</td>
<td>å¯æ§å»¶è¿Ÿã€å‡å°‘ç¢ç‰‡åŒ–</td>
<td>è°ƒä¼˜å¤æ‚</td>
<td>å¤§å †å†…å­˜ã€ä½å»¶è¿Ÿéœ€æ±‚</td>
</tr>
<tr>
<td>ZGC</td>
<td>æ ‡è®°-ç§»åŠ¨ç®—æ³•</td>
<td>æ˜¯</td>
<td>è¶…ä½å»¶è¿Ÿ</td>
<td>å†…å­˜å¼€é”€é«˜</td>
<td>è¶…å¤§å†…å­˜ã€æä½å»¶è¿Ÿåœºæ™¯</td>
</tr>
<tr>
<td>Shenandoah</td>
<td>æ ‡è®°-æ•´ç†ç®—æ³•</td>
<td>æ˜¯</td>
<td>è¶…ä½å»¶è¿Ÿ</td>
<td>å†…å­˜ä½¿ç”¨ç‡é«˜</td>
<td>ä½å»¶è¿Ÿåœºæ™¯</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Python</title>
    <url>/2025/04/13/Python/</url>
    <content><![CDATA[<p>Python</p>
<span id="more"></span>
<h1>Python</h1>
<h2 id="Keyword">Keyword</h2>
<h3 id="Colon">Colon</h3>
<p><strong>åˆ‡ç‰‡æ“ä½œï¼ˆSliceï¼‰</strong></p>
<p>å†’å·ç”¨äºåˆ†éš”åˆ‡ç‰‡å‚æ•°çš„èµ·å§‹ã€ç»“æŸå’Œæ­¥é•¿ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="string">&quot;Hello, Python&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºæœ¬åˆ‡ç‰‡</span></span><br><span class="line"><span class="built_in">print</span>(s[<span class="number">2</span>:<span class="number">5</span>])   <span class="comment"># è¾“å‡º &quot;llo&quot;ï¼ˆç´¢å¼• 2 åˆ° 5-1ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(s[:<span class="number">3</span>])    <span class="comment"># è¾“å‡º &quot;Hel&quot;ï¼ˆä»å¼€å¤´åˆ°ç´¢å¼• 3-1ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(s[<span class="number">7</span>:])    <span class="comment"># è¾“å‡º &quot;Python&quot;ï¼ˆä»ç´¢å¼• 7 åˆ°æœ«å°¾ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥é•¿åˆ‡ç‰‡</span></span><br><span class="line"><span class="built_in">print</span>(s[::<span class="number">2</span>])   <span class="comment"># è¾“å‡º &quot;Hlo yhn&quot;ï¼ˆæ¯éš”ä¸€ä¸ªå­—ç¬¦å–ä¸€æ¬¡ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(s[::-<span class="number">1</span>])  <span class="comment"># è¾“å‡º &quot;nohtyP ,olleH&quot;ï¼ˆé€†åºï¼‰</span></span><br></pre></td></tr></table></figure>
<br>
<p><strong>lambda å‡½æ•°å‚æ•°ä¸ä¸»ä½“åˆ†éš”</strong></p>
<p>å†’å·åˆ†éš” lambda å‡½æ•°çš„å‚æ•°å’Œè¡¨è¾¾å¼ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">square = <span class="keyword">lambda</span> x: x ** <span class="number">2</span>  <span class="comment"># å†’å·å‰æ˜¯å‚æ•°ï¼Œåæ˜¯è¡¨è¾¾å¼</span></span><br><span class="line"><span class="built_in">print</span>(square(<span class="number">5</span>))  <span class="comment"># è¾“å‡º 25</span></span><br></pre></td></tr></table></figure>
<br>
<p><strong>ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰</strong></p>
<p>Python 3.5+ ä¸­ï¼Œå†’å·ç”¨äºåˆ†éš”å˜é‡åå’Œç±»å‹æ³¨è§£ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:  <span class="comment"># å‚æ•°åå†’å·åˆ†éš”ç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br></pre></td></tr></table></figure>
<br>
<h3 id="Index">Index</h3>
<p>æ­£ç´¢å¼•ä»0å¼€å§‹ï¼Œè´Ÿç´¢å¼•ä»-1å¼€å§‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">my_list = [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(my_list[<span class="number">0</span>])  <span class="comment"># è¾“å‡º: &quot;a&quot;ï¼ˆç¬¬1ä¸ªå…ƒç´ ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(my_list[<span class="number">1</span>])  <span class="comment"># è¾“å‡º: &quot;b&quot;ï¼ˆç¬¬2ä¸ªå…ƒç´ ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(my_list[-<span class="number">1</span>]) <span class="comment"># è¾“å‡º: &quot;d&quot;ï¼ˆå€’æ•°ç¬¬1ä¸ªå…ƒç´ ï¼Œè´Ÿç´¢å¼•ä»-1å¼€å§‹ï¼‰</span></span><br></pre></td></tr></table></figure>
<br>
<br>
<h2 id="Pytorch">Pytorch</h2>
<h3 id="ç»´åº¦">ç»´åº¦</h3>
<p>å¼ é‡æ˜¯æœ‰å¤šä¸ªâ€œç»´åº¦â€çš„ï¼Œæ¯ä¸ªç»´åº¦å¯¹åº”ä¸€ä¸ªâ€œæ–¹å‘â€ï¼š</p>
<ul>
<li><strong>ç»´åº¦ 0ï¼š</strong> æœ€å¤–å±‚ï¼ˆæœ€å·¦è¾¹çš„æ‹¬å·ï¼‰â€”â€” è¡Œçš„ä¸ªæ•° â†’ <strong>ç«–ç€æ–¹å‘</strong></li>
<li><strong>ç»´åº¦ 1ï¼š</strong> æ¯ä¸€è¡Œé‡Œçš„åˆ—æ•° â†’ <strong>æ¨ªç€æ–¹å‘</strong></li>
<li><strong>ç»´åº¦ 2ï¼š</strong> é€šå¸¸æ˜¯æ›´æ·±ä¸€å±‚ï¼Œæ¯”å¦‚ RGB é€šé“ã€é«˜åº¦ã€æ—¶é—´å¸§ç­‰</li>
</ul>
<blockquote>
<p>ç»´åº¦çš„å¤§å° -&gt; ä»æ‹¬å·æœ€å¤–å±‚å‘å†…å¢åŠ </p>
<p>åœ¨ PyTorch ä¸­ï¼Œæ¯å¤šä¸€å±‚æ‹¬å·ï¼Œç»´åº¦ +1ã€‚</p>
</blockquote>
<br>
<h3 id="å¸¸ç”¨å‡½æ•°">å¸¸ç”¨å‡½æ•°</h3>
<br>
<p><code>.view()</code> - æ”¹å˜å¼ é‡å½¢çŠ¶ï¼ˆä¸æ”¹å˜æ•°æ®ï¼‰</p>
<p><strong>ä½œç”¨</strong>ï¼šé‡æ–°æ’åˆ—å¼ é‡çš„ç»´åº¦ï¼Œç±»ä¼¼äºNumPyçš„<code>reshape</code></p>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>
<p>ä¸æ”¹å˜åŸå§‹æ•°æ®ï¼Œåªæ”¹å˜&quot;è§†å›¾&quot;</p>
</li>
<li>
<p>å†…å­˜ä¸­é€ä¸ªå…ƒç´ çš„é‡æ’</p>
</li>
<li>
<p>æ€»å…ƒç´ æ•°å¿…é¡»ä¿æŒä¸å˜ï¼ˆå„ç»´åº¦ä¹˜ç§¯ç›¸åŒï¼‰</p>
</li>
</ul>
<p><strong>ä¾‹å­</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª1x6çš„å¼ é‡</span></span><br><span class="line">x = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(x.shape)  <span class="comment"># torch.Size([1, 6])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¡‘ä¸º2x3</span></span><br><span class="line">y = x.view(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(y)</span><br><span class="line"><span class="comment"># tensor([[1, 2, 3],</span></span><br><span class="line"><span class="comment">#         [4, 5, 6]])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¡‘ä¸º3x2</span></span><br><span class="line">z = x.view(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(z)</span><br><span class="line"><span class="comment"># tensor([[1, 2],</span></span><br><span class="line"><span class="comment">#         [3, 4],</span></span><br><span class="line"><span class="comment">#         [5, 6]])</span></span><br><span class="line">q = self.linear_q(x).view(batch_size, -<span class="number">1</span>, self.heads, self.d_k) </span><br><span class="line"><span class="comment">#  -1 æ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºè‡ªåŠ¨æ¨æ–­è¯¥ç»´åº¦çš„å¤§å°ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®©PyTorchæ ¹æ®å¼ é‡çš„æ€»å…ƒç´ æ•°é‡å’Œå…¶ä»–å·²çŸ¥ç»´åº¦çš„å¤§å°ï¼Œè‡ªåŠ¨è®¡ç®— -1 æ‰€åœ¨ç»´åº¦çš„å…·ä½“å€¼ã€‚</span></span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœå°è¯•<code>x.view(4, 2)</code>ä¼šæŠ¥é”™ï¼Œå› ä¸º1Ã—6 â‰  4Ã—2</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>å«ä¹‰</th>
<th>ç”¨é€”åœºæ™¯</th>
<th>è®°å¿†æŠ€å·§</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.view()</code></td>
<td>å¿«é€Ÿ reshapeï¼Œä½†è¦æ±‚å†…å­˜è¿ç»­</td>
<td>é«˜æ€§èƒ½æ“ä½œï¼ˆå¦‚æ¨¡å‹æ¨ç†ä¸­ï¼‰</td>
<td>â€œåŸåœ°æ¢è§’åº¦â€</td>
</tr>
<tr>
<td><code>.reshape()</code></td>
<td>é€šç”¨ reshapeï¼Œåº•å±‚è‡ªåŠ¨å¤„ç†</td>
<td>å®‰å…¨é¦–é€‰ï¼Œå°¤å…¶æ˜¯å¤æ‚åœºæ™¯</td>
<td>â€œéšä¾¿ä½ æ¢ï¼Œæˆ‘æ¥å…œåº•â€</td>
</tr>
</tbody>
</table>
<br>
<p><code>.transpose()</code> - äº¤æ¢ä¸¤ä¸ªç»´åº¦</p>
<p><strong>ä½œç”¨</strong>ï¼šäº¤æ¢æŒ‡å®šçš„ä¸¤ä¸ªç»´åº¦<br>
<strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>
<p>å¸¸ç”¨äºçŸ©é˜µè½¬ç½®ï¼ˆäº¤æ¢æœ€åä¸¤ä¸ªç»´åº¦ï¼‰</p>
</li>
<li>
<p>æ¯”<code>.permute()</code>æ›´è½»é‡ï¼ˆåªèƒ½äº¤æ¢ä¸¤ä¸ªç»´åº¦ï¼‰</p>
</li>
</ul>
<p><strong>ä¾‹å­</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª2x3çš„å¼ é‡</span></span><br><span class="line">x = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">                  [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(x.shape)  <span class="comment"># torch.Size([2, 3])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬ç½®ä¸º3x2</span></span><br><span class="line">y = x.transpose(<span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># äº¤æ¢ç¬¬0å’Œç¬¬1ç»´åº¦</span></span><br><span class="line"><span class="built_in">print</span>(y)</span><br><span class="line"><span class="comment"># tensor([[1, 4],</span></span><br><span class="line"><span class="comment">#         [2, 5],</span></span><br><span class="line"><span class="comment">#         [3, 6]])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å¤šå¤´æ³¨æ„åŠ›ä¸­çš„å…¸å‹ç”¨æ³•</span></span><br><span class="line">q = torch.randn(<span class="number">2</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">8</span>)  <span class="comment"># (batch, seq_len, heads, d_k)</span></span><br><span class="line">q = q.transpose(<span class="number">1</span>, <span class="number">2</span>)          <span class="comment"># å˜ä¸º (batch, heads, seq_len, d_k)</span></span><br></pre></td></tr></table></figure>
<br>
<p><code>.matmul()</code> - çŸ©é˜µä¹˜æ³•</p>
<p><strong>ä½œç”¨</strong>ï¼šæ‰§è¡ŒçŸ©é˜µä¹˜æ³•ï¼ˆæ”¯æŒå¹¿æ’­ï¼‰<br>
<strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>æ¯”<code>torch.mm()</code>æ›´é€šç”¨ï¼ˆæ”¯æŒé«˜ç»´å¼ é‡ï¼‰</li>
<li>è‡ªåŠ¨å¤„ç†æ‰¹é‡ç»´åº¦ï¼ˆéå¸¸é€‚åˆç¥ç»ç½‘ç»œï¼‰</li>
</ul>
<p><strong>ä¾‹å­</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># çŸ©é˜µä¹˜æ³•ï¼ˆ2Dï¼‰</span></span><br><span class="line">a = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])  <span class="comment"># 2x2</span></span><br><span class="line">b = torch.tensor([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])  <span class="comment"># 2x2</span></span><br><span class="line">c = torch.matmul(a, b)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="comment"># tensor([[19, 22],</span></span><br><span class="line"><span class="comment">#         [43, 50]])</span></span><br><span class="line"><span class="comment"># è®¡ç®—è¿‡ç¨‹ï¼š</span></span><br><span class="line"><span class="comment"># 1*5 + 2*7 = 19 | 1*6 + 2*8 = 22</span></span><br><span class="line"><span class="comment"># 3*5 + 4*7 = 43 | 3*6 + 4*8 = 50</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡çŸ©é˜µä¹˜æ³•ï¼ˆ3Dï¼‰</span></span><br><span class="line">q = torch.randn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>)  <span class="comment"># 3ä¸ª5x7çŸ©é˜µ</span></span><br><span class="line">k = torch.randn(<span class="number">3</span>, <span class="number">7</span>, <span class="number">2</span>)  <span class="comment"># 3ä¸ª7x2çŸ©é˜µ</span></span><br><span class="line">out = torch.matmul(q, k)   <span class="comment"># ç»“æœä¸º3ä¸ª5x2çŸ©é˜µ</span></span><br><span class="line"><span class="built_in">print</span>(out.shape)  <span class="comment"># torch.Size([3, 5, 2])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„åº”ç”¨</span></span><br><span class="line">score = torch.matmul(q, k.transpose(-<span class="number">2</span>, -<span class="number">1</span>))  <span class="comment"># è®¡ç®—Qå’ŒKçš„ç‚¹ç§¯</span></span><br><span class="line"><span class="comment"># qå½¢çŠ¶: (batch, seq_len_q, d_k)</span></span><br><span class="line"><span class="comment"># kå½¢çŠ¶: (batch, seq_len_k, d_k)</span></span><br><span class="line"><span class="comment"># ç»“æœ: (batch, seq_len_q, seq_len_k)</span></span><br></pre></td></tr></table></figure>
<br>
<p><code>torch.gather</code></p>
<p><strong>ä½œç”¨ï¼š</strong><br>
æŒ‰ç…§æŒ‡å®šçš„ç´¢å¼•ï¼Œä»è¾“å…¥å¼ é‡ä¸­<strong>æ”¶é›†ï¼ˆgatherï¼‰æ•°æ®</strong>ã€‚</p>
<p><strong>è¯­æ³•ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CopyEdit</span><br><span class="line">torch.gather(input, dim, index)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>input</code>: åŸå§‹å¼ é‡</li>
<li><code>dim</code>: æ²¿å“ªä¸ªç»´åº¦ç´¢å¼•</li>
<li><code>index</code>: ç´¢å¼•å¼ é‡ï¼ˆå¤§å°ä¸è¿”å›å€¼ä¸€è‡´ï¼‰</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pythonCopyEditx = torch.tensor([[10, 20], [30, 40]])</span><br><span class="line">index = torch.tensor([[0, 0], [1, 0]])</span><br><span class="line">out = torch.gather(x, 1, index)</span><br><span class="line"># out: tensor([[10, 10],</span><br><span class="line">#              [40, 30]])</span><br></pre></td></tr></table></figure>
<p><strong>è®°å¿†æ–¹æ³•ï¼š</strong><br>
â€œ<strong>gather</strong>â€ = æ”¶é›†ï¼šåƒæ˜¯ç”¨ index å¼ é‡å‘Šè¯‰ä½ ï¼š<strong>ä»å“ªé‡ŒæŠŠå€¼æ”¶é›†è¿‡æ¥</strong>ã€‚</p>
<br>
<h3 id="è®¡ç®—å›¾">è®¡ç®—å›¾</h3>
<p>ä»£ç </p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">x</span> = <span class="number">2.0</span></span><br><span class="line"><span class="attr">w</span> = <span class="number">3.0</span></span><br><span class="line"><span class="attr">b</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">z</span> = w * x + b</span><br><span class="line"><span class="attr">a</span> = ReLU(z)</span><br><span class="line"><span class="attr">L</span> = (a - <span class="number">5</span>)^<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„è®¡ç®—å›¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">w (Tensor) --&gt; MulBackward0 (w*x)</span><br><span class="line">x (Tensor) --&gt; MulBackward0 (w*x)</span><br><span class="line">(w*x) --&gt; AddBackward0 (z = w*x + b)</span><br><span class="line">b (Tensor) --&gt; AddBackward0 (z = w*x + b)</span><br><span class="line">z --&gt; ReluBackward0 (a = relu(z))</span><br><span class="line">a --&gt; PowBackward0 (L = (a-5)^2)</span><br></pre></td></tr></table></figure>
<br>
<p>æ¯ä¸€å±‚å‚æ•°ï¼ˆå¦‚æƒé‡ <code>w</code>, åç½® <code>b</code>ï¼‰çš„æ¢¯åº¦ä¼šä¿å­˜åœ¨å¯¹åº”çš„Tensorå¼ é‡å¯¹è±¡ä¸­çš„ <code>.grad</code> å±æ€§é‡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="comment"># å®šä¹‰å¶å­èŠ‚ç‚¹ï¼ˆéœ€è¦æ¢¯åº¦ï¼‰</span></span><br><span class="line">w = torch.tensor([<span class="number">3.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line">b = torch.tensor([<span class="number">1.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‰å‘ä¼ æ’­ï¼ˆæ„å»ºè®¡ç®—å›¾ï¼‰</span></span><br><span class="line">x = torch.tensor([<span class="number">2.0</span>])</span><br><span class="line">y = w * x + b      <span class="comment"># y.grad_fn = AddBackward0</span></span><br><span class="line">loss = (y - <span class="number">5</span>)**<span class="number">2</span>  <span class="comment"># loss.grad_fn = PowBackward0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¼˜åŒ–å™¨ï¼ˆç»‘å®šéœ€è¦æ›´æ–°çš„å‚æ•°ï¼‰</span></span><br><span class="line">optimizer = optim.SGD([w, b], lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‰å‘ä¼ æ’­ï¼ˆæ„å»ºè®¡ç®—å›¾ï¼‰</span></span><br><span class="line">y = w * x + b</span><br><span class="line">loss = (y - <span class="number">5</span>)**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¢¯åº¦</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nåå‘ä¼ æ’­å‰ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å¶å­èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad_fn = <span class="subst">&#123;w.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad_fn = <span class="subst">&#123;b.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad = <span class="subst">&#123;w.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad = <span class="subst">&#123;b.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nä¸­é—´èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad_fn = <span class="subst">&#123;y.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad_fn = <span class="subst">&#123;loss.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad = <span class="subst">&#123;y.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad = <span class="subst">&#123;loss.grad&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå‘ä¼ æ’­ï¼ˆè®¡ç®—æ¢¯åº¦ï¼‰</span></span><br><span class="line">loss.backward()  <span class="comment"># è®¡ç®— w.grad å’Œ b.grad</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¢¯åº¦</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nåå‘ä¼ æ’­åï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å¶å­èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad_fn = <span class="subst">&#123;w.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad_fn = <span class="subst">&#123;b.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad = <span class="subst">&#123;w.grad&#125;</span>&quot;</span>)  <span class="comment"># tensor([4.])</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad = <span class="subst">&#123;b.grad&#125;</span>&quot;</span>)  <span class="comment"># tensor([2.])</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nä¸­é—´èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad_fn = <span class="subst">&#123;y.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad_fn = <span class="subst">&#123;loss.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad = <span class="subst">&#123;y.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad = <span class="subst">&#123;loss.grad&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–å™¨æ›´æ–°å‚æ•°</span></span><br><span class="line">optimizer.step()  <span class="comment"># w = w - lr * w.grad, b = b - lr * b.grad</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nä¼˜åŒ–å™¨æ›´æ–°åï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å¶å­èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad_fn = <span class="subst">&#123;w.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad_fn = <span class="subst">&#123;b.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad = <span class="subst">&#123;w.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad = <span class="subst">&#123;b.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nä¸­é—´èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad_fn = <span class="subst">&#123;y.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad_fn = <span class="subst">&#123;loss.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad = <span class="subst">&#123;y.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad = <span class="subst">&#123;loss.grad&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç©ºæ¢¯åº¦ï¼ˆé¿å…ä¸‹æ¬¡è¿­ä»£æ¢¯åº¦ç´¯ç§¯ï¼‰</span></span><br><span class="line">optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\næ¸…ç©ºæ¢¯åº¦åï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å¶å­èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad_fn = <span class="subst">&#123;w.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad_fn = <span class="subst">&#123;b.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w.grad = <span class="subst">&#123;w.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b.grad = <span class="subst">&#123;b.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nä¸­é—´èŠ‚ç‚¹ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad_fn = <span class="subst">&#123;y.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad_fn = <span class="subst">&#123;loss.grad_fn&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;y.grad = <span class="subst">&#123;y.grad&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loss.grad = <span class="subst">&#123;loss.grad&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\næ›´æ–°åå‚æ•°ï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;w = <span class="subst">&#123;w&#125;</span>&quot;</span>)  <span class="comment"># tensor([2.9600], requires_grad=True)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;b = <span class="subst">&#123;b&#125;</span>&quot;</span>)  <span class="comment"># tensor([0.9800], requires_grad=True)</span></span><br></pre></td></tr></table></figure>
<p><code>next_functions</code> æ˜¯ä¸€ä¸ª tupleï¼Œé‡Œé¢çš„å…ƒç´ ä»£è¡¨äº† <code>MulBackward0</code> çš„ <strong>è¾“å…¥å‡½æ•°</strong>ï¼ˆä¸Šæ¸¸èŠ‚ç‚¹ï¼‰</p>
<p>PyTorch ä¸­æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹çš„ <code>grad_fn</code> æ˜¯è®¡ç®—å›¾çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé€šè¿‡ <code>.next_functions</code> è¿æ¥ä¸Šæ¸¸èŠ‚ç‚¹ï¼Œå¹¶åœ¨ <code>grad_fn.next_functions._saved_results</code> ä¸­ä¿å­˜å‰å‘ä¼ æ’­éœ€è¦çš„ä¸­é—´å˜é‡ï¼Œåå‘ä¼ æ’­æ—¶ä¾æ­¤è‡ªåŠ¨è®¡ç®—æ¢¯åº¦ã€‚</p>
<blockquote>
<p>åœ¨ PyTorch ä¸­ï¼Œ<strong>è®¡ç®—å›¾çš„æ¸…ç†ï¼ˆGraph Cleanupï¼‰</strong> æŒ‡çš„æ˜¯åœ¨åå‘ä¼ æ’­å®Œæˆåï¼Œç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾è®¡ç®—å›¾å ç”¨çš„å†…å­˜ï¼Œä»¥é¿å…ä¸å¿…è¦çš„èµ„æºå ç”¨ã€‚è¿™åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>åˆ é™¤ä¸­é—´å˜é‡çš„æ¢¯åº¦è®¡ç®—å‡½æ•°ï¼ˆ<code>grad_fn</code>ï¼‰</strong>
<ul>
<li>åœ¨åå‘ä¼ æ’­å®Œæˆåï¼ŒPyTorch ä¼šè‡ªåŠ¨é”€æ¯è®¡ç®—å›¾ï¼ˆé™¤éæ˜¾å¼æŒ‡å®š <code>retain_graph=True</code>ï¼‰ã€‚</li>
<li>è¿™æ„å‘³ç€æ‰€æœ‰ä¸­é—´å˜é‡ï¼ˆå¦‚ <code>z2</code>ã€<code>a</code>ï¼‰çš„ <code>grad_fn</code> ä¼šè¢«ç½®ä¸º <code>None</code>ï¼Œä»è€Œæ–­å¼€è®¡ç®—å›¾çš„é“¾æ¥ã€‚</li>
</ul>
</li>
<li><strong>é‡Šæ”¾æ¢¯åº¦ç¼“å†²åŒºï¼ˆ<code>.grad</code>ï¼‰</strong>
<ul>
<li>å¶å­èŠ‚ç‚¹ï¼ˆå¦‚ <code>w</code>ã€<code>x</code>ã€<code>a</code>ã€<code>b</code>ï¼‰çš„æ¢¯åº¦ï¼ˆ<code>.grad</code>ï¼‰ä»ç„¶ä¼šä¿ç•™ï¼Œé™¤éæ‰‹åŠ¨è°ƒç”¨ <code>optimizer.zero_grad()</code> æˆ– <code>tensor.grad = None</code>ã€‚</li>
</ul>
</li>
<li><strong>è®¡ç®—å›¾çš„å†…å­˜å›æ”¶</strong>
<ul>
<li>PyTorch çš„è‡ªåŠ¨å¾®åˆ†å¼•æ“ï¼ˆAutogradï¼‰ä¼šé‡Šæ”¾è®¡ç®—å›¾å ç”¨çš„å†…å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚</li>
</ul>
</li>
</ol>
</blockquote>
<br>
<h3 id="Tensorè®¡ç®—">Tensorè®¡ç®—</h3>
<p><strong>é«˜ç»´å¼ é‡çš„çŸ©é˜µä¹˜æ³•ï¼ˆå¦‚ <code>torch.matmul</code>ï¼‰</strong></p>
<p><strong>è§„åˆ™</strong>ï¼šä»å³å‘å·¦å¯¹é½ç»´åº¦ï¼ŒæŒ‰çŸ©é˜µä¹˜æ³•è§„åˆ™æ‰©å±•ã€‚</p>
<p><strong>(1) æ ¸å¿ƒæ€æƒ³</strong></p>
<ul>
<li>æœ€åä¸¤ä¸ªç»´åº¦ï¼ˆ<code>è¡Œ, åˆ—</code>ï¼‰å¿…é¡»æ»¡è¶³çŸ©é˜µä¹˜æ³•è§„åˆ™ï¼š<br>
<code>(..., m, n) * (..., n, p)</code> â†’ <code>(..., m, p)</code><br>
ï¼ˆæ¶ˆå»ä¸­é—´çš„ <code>n</code>ï¼‰ã€‚</li>
<li>å…¶ä»–ç»´åº¦ï¼ˆå‰é¢çš„ <code>...</code>ï¼‰å¿…é¡»ç›¸åŒæˆ–å¯å¹¿æ’­ã€‚</li>
</ul>
<p><strong>(2) ç¤ºä¾‹</strong></p>
<ol>
<li><strong>æ‰¹é‡çŸ©é˜µä¹˜æ³•</strong>ï¼š<br>
<code>(2, 3, 4) * (2, 4, 5)</code> â†’ ç»“æœ <code>(2, 3, 5)</code>
<ul>
<li>å‰å¯¼ç»´åº¦ <code>2</code> ç›¸åŒï¼Œ</li>
<li>æœ€åä¸¤ç»´ <code>(3,4) * (4,5)</code> â†’ <code>(3,5)</code>ã€‚</li>
</ul>
</li>
<li><strong>å¹¿æ’­çŸ©é˜µä¹˜æ³•</strong>ï¼š<br>
<code>(3, 1, 4) * (1, 4, 5)</code> â†’ å¹¿æ’­ä¸º <code>(3, 1, 4) * (3, 4, 5)</code> â†’ ç»“æœ <code>(3, 1, 5)</code>
<ul>
<li>å‰å¯¼ç»´åº¦ <code>3</code> å’Œ <code>1</code> å¹¿æ’­ä¸º <code>3</code>ï¼Œ</li>
<li>æœ€åä¸¤ç»´ <code>(1,4) * (4,5)</code> â†’ <code>(1,5)</code>ã€‚</li>
</ul>
</li>
</ol>
<br>
<h2 id="å®ä¾‹">å®ä¾‹</h2>
<h3 id="æ‰‹å†™Ttransformer">æ‰‹å†™Ttransformer</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiHeadAttention</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_dim, num_heads, d_model, dropout=<span class="number">0.1</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            input_dim: è¾“å…¥ç»´åº¦</span></span><br><span class="line"><span class="string">            num_heads: æ³¨æ„åŠ›å¤´çš„æ•°é‡</span></span><br><span class="line"><span class="string">            d_model: æ¨¡å‹ç»´åº¦ï¼ˆå¿…é¡»èƒ½è¢«num_headsæ•´é™¤ï¼‰</span></span><br><span class="line"><span class="string">            dropout: dropoutæ¦‚ç‡</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="keyword">assert</span> d_model % num_heads == <span class="number">0</span>, <span class="string">&quot;d_model must be divisible by num_heads&quot;</span></span><br><span class="line"></span><br><span class="line">        self.d_model = d_model</span><br><span class="line">        self.num_heads = num_heads</span><br><span class="line">        self.d_k = d_model // num_heads</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰Qã€Kã€Vçš„çº¿æ€§å˜æ¢å±‚</span></span><br><span class="line">        self.linear_q = nn.Linear(input_dim, d_model)</span><br><span class="line">        self.linear_k = nn.Linear(input_dim, d_model)</span><br><span class="line">        self.linear_v = nn.Linear(input_dim, d_model)</span><br><span class="line">        <span class="comment"># # åˆå¹¶QKVçš„çº¿æ€§å˜æ¢å±‚ï¼Œå‡å°‘çŸ©é˜µä¹˜æ³•æ¬¡æ•°</span></span><br><span class="line">        <span class="comment"># self.qkv_proj = nn.Linear(input_dim, 3 * d_model)</span></span><br><span class="line">        self.dropout = nn.Dropout(dropout)</span><br><span class="line">        self.scale = <span class="number">1.0</span> / math.sqrt(self.d_k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¾“å‡ºçº¿æ€§å±‚</span></span><br><span class="line">        self.out = nn.Linear(d_model, d_model)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, mask=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, input_dim)</span></span><br><span class="line"><span class="string">            mask: å¯é€‰æ©ç ï¼Œå½¢çŠ¶ä¸º(batch_size, 1, seq_len, seq_len)æˆ–(1, 1, seq_len, seq_len)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸è¾“å…¥ç›¸åŒ(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        batch_size, seq_len, _ = x.shape</span><br><span class="line"></span><br><span class="line">        <span class="comment"># çº¿æ€§å˜æ¢å¹¶åˆ†å¤´å¤„ç†</span></span><br><span class="line">        <span class="comment"># å½¢çŠ¶å˜åŒ–: (batch, seq_len, input_dim) -&gt; (batch, seq_len, heads, d_k)</span></span><br><span class="line">        q = self.linear_q(x).view(batch_size, seq_len, self.num_heads, self.d_k)</span><br><span class="line">        k = self.linear_k(x).view(batch_size, seq_len, self.num_heads, self.d_k)</span><br><span class="line">        v = self.linear_v(x).view(batch_size, seq_len, self.num_heads, self.d_k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è½¬ç½®ç»´åº¦ï¼Œä½¿å½¢çŠ¶å˜ä¸º(batch, heads, seq_len, d_k)</span></span><br><span class="line">        q = q.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        k = k.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        v = v.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # ä¸€æ¬¡æ€§è®¡ç®—QKV</span></span><br><span class="line">        <span class="comment"># qkv = self.qkv_proj(x)</span></span><br><span class="line">        <span class="comment"># qkv = qkv.view(batch_size, seq_len, 3, self.num_heads, self.d_k)</span></span><br><span class="line">        <span class="comment"># q, k, v = qkv.unbind(2)  # å½¢çŠ¶å‡ä¸º(batch_size, seq_len, num_heads, d_k), è¡¨ç¤ºæ²¿ç€ç¬¬3ä¸ªç»´åº¦ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼‰æ‹†åˆ†å¼ é‡</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># # è½¬ç½®ç»´åº¦ (batch_size, num_heads, seq_len, d_k)</span></span><br><span class="line">        <span class="comment"># q = q.transpose(1, 2)</span></span><br><span class="line">        <span class="comment"># k = k.transpose(1, 2)</span></span><br><span class="line">        <span class="comment"># v = v.transpose(1, 2)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° (batch_size, num_heads, seq_len, seq_len)</span></span><br><span class="line">        scores = torch.matmul(q, k.transpose(-<span class="number">2</span>, -<span class="number">1</span>)) * self.scale</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åº”ç”¨æ©ç ï¼ˆå¦‚æœæœ‰ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            scores = scores.masked_fill(mask == <span class="number">0</span>, <span class="built_in">float</span>(<span class="string">&#x27;-inf&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—æ³¨æ„åŠ›æƒé‡</span></span><br><span class="line">        att = torch.softmax(scores, dim=-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> self.dropout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            att = self.dropout(att)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åº”ç”¨æ³¨æ„åŠ›æƒé‡åˆ°Vä¸Š</span></span><br><span class="line">        output = torch.matmul(att, v)  <span class="comment"># (batch_size, num_heads, seq_len, d_k)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‹¼æ¥å¤šå¤´ç»“æœ</span></span><br><span class="line">        output = output.transpose(<span class="number">1</span>, <span class="number">2</span>).contiguous()  <span class="comment"># (batch_size, seq_len, num_heads, d_k)</span></span><br><span class="line">        output = output.view(batch_size, seq_len, self.d_model)  <span class="comment"># (batch_size, seq_len, d_model)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æœ€ç»ˆçº¿æ€§å˜æ¢</span></span><br><span class="line">        output = self.out(output)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æµ‹è¯•ä»£ç </span></span><br><span class="line">    batch = <span class="number">2</span></span><br><span class="line">    seq_len = <span class="number">5</span></span><br><span class="line">    input_dim = <span class="number">32</span></span><br><span class="line">    num_heads = <span class="number">2</span></span><br><span class="line">    d_model = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºéšæœºè¾“å…¥</span></span><br><span class="line">    x = torch.randn(size=(batch, seq_len, input_dim))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–å¤šå¤´æ³¨æ„åŠ›å±‚</span></span><br><span class="line">    attention = MultiHeadAttention(input_dim, num_heads, d_model)</span><br><span class="line">    <span class="built_in">print</span>(attention(x).shape)  <span class="comment"># è¾“å‡ºå½¢çŠ¶åº”ä¸º(batch, seq_len, d_model)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸‹ä¸‰è§’æ©ç ï¼ˆç”¨äºè§£ç å™¨è‡ªæ³¨æ„åŠ›ï¼‰</span></span><br><span class="line">    attention_mask = torch.tril(torch.ones(seq_len, seq_len)).view(<span class="number">1</span>, <span class="number">1</span>, seq_len, seq_len)</span><br><span class="line">    attention_mask = attention_mask.to(dtype=torch.float32)</span><br><span class="line">    attention_mask = (attention_mask == <span class="number">0</span>)  <span class="comment"># è½¬æ¢ä¸ºå¸ƒå°”æ©ç </span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(attention_mask)  <span class="comment"># æ‰“å°æ©ç </span></span><br><span class="line">    <span class="built_in">print</span>(attention(x, attention_mask).shape)  <span class="comment"># å¸¦æ©ç çš„è¾“å‡ºå½¢çŠ¶</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Paper-Reading-Record</title>
    <url>/2025/04/02/Paper-Reading-Record/</url>
    <content><![CDATA[<p>Paperé˜…è¯»è®°å½•</p>
<span id="more"></span>
<h1>Paper-Reading-Record</h1>
<img src="/2025/04/02/Paper-Reading-Record/v2-ee9b5d4a0761d2d1d10acb37cebefba3_1440w.jpg" class="" title="img">
<h2 id="Corpus">Corpus</h2>
<p>corpus è¯­æ–™åº“</p>
<p>â€œconditioning the modelâ€ â€œè°ƒèŠ‚æ¨¡å‹â€</p>
<p>â€œword representationsâ€ â€œè¯å‘é‡è¡¨ç¤ºâ€</p>
<p>â€œlog-bilinearâ€ â€œå¯¹æ•°åŒçº¿æ€§â€</p>
<p>â€œfactored 3-wayâ€ â€œå› å­åˆ†è§£ä¸‰å‘â€</p>
<p>modality-biased æ¨¡æ€åç½®</p>
<p>Generation and Retrieval ç”Ÿæˆå’Œæ£€ç´¢</p>
<p>SOTA  â€œState - Of - The - Artâ€</p>
<p>lexicon è¯æ±‡è¡¨</p>
<br>
<p><strong>n-gram</strong>ï¼šæŒ‡è¿ç»­çš„ <em>n</em> ä¸ªè¯ï¼ˆæˆ–å­—ç¬¦ï¼‰ç»„æˆçš„åºåˆ—ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><strong>Unigram (1-gram)</strong>: â€œtheâ€, â€œcatâ€, â€œsatâ€</li>
<li><strong>Bigram (2-gram)</strong>: â€œthe catâ€, â€œcat satâ€</li>
<li><strong>Trigram (3-gram)</strong>: â€œthe cat satâ€</li>
</ul>
<br>
<p><strong>BLEUï¼ˆBilingual Evaluation Understudyï¼‰</strong></p>
<ul>
<li><strong>ç”¨é€”</strong>ï¼šæœºå™¨ç¿»è¯‘è´¨é‡è¯„ä¼°æŒ‡æ ‡ï¼Œé€šè¿‡å¯¹æ¯”ç”Ÿæˆæ–‡æœ¬ä¸äººå·¥å‚è€ƒè¯‘æ–‡çš„n-gramåŒ¹é…åº¦è®¡ç®—å¾—åˆ†ï¼ˆ0-100ï¼Œè¶Šé«˜è¶Šå¥½ï¼‰ã€‚</li>
<li><strong>ä»»åŠ¡</strong>ï¼š<code>EN-DE</code>ï¼ˆè‹±è¯‘å¾·ï¼‰å’Œ<code>EN-FR</code>ï¼ˆè‹±è¯‘æ³•ï¼‰ã€‚</li>
</ul>
<p><strong>FLOPsï¼ˆFloating Point Operationsï¼‰</strong></p>
<ul>
<li><strong>ç”¨é€”</strong>ï¼šè®­ç»ƒæˆæœ¬é‡åŒ–æŒ‡æ ‡ï¼Œè¡¨ç¤ºæ¨¡å‹è®­ç»ƒæ‰€éœ€æµ®ç‚¹è¿ç®—æ€»é‡ï¼ˆæ•°å€¼è¶Šä½ï¼Œè®¡ç®—æ•ˆç‡è¶Šé«˜ï¼‰</li>
</ul>
<br>
<p><strong>Perplexity</strong></p>
<p>å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰æ˜¯è¯„ä¼°è¯­è¨€æ¨¡å‹æ€§èƒ½çš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œç”¨äºè¡¡é‡æ¨¡å‹å¯¹æœªçŸ¥æ•°æ®çš„é¢„æµ‹èƒ½åŠ›ã€‚å›°æƒ‘åº¦åæ˜ äº†æ¨¡å‹å¯¹æµ‹è¯•æ•°æ®ä¸­æ¯ä¸ªè¯çš„é¢„æµ‹â€œä¸ç¡®å®šç¨‹åº¦â€ã€‚å€¼è¶Šä½ï¼Œè¯´æ˜æ¨¡å‹é¢„æµ‹è¶Šå‡†ç¡®ï¼ˆå³æ›´â€œä¸å›°æƒ‘â€ï¼‰ã€‚</p>
<p>å›°æƒ‘åº¦çš„æ•°å­¦è¡¨è¾¾å¼ä¸ºï¼š<br>
$$<br>
\log_2 C(w_{1:n} | x) = -\frac{1}{N} \sum \log_2 P(w_n = i | w_{1:n-1}, x)<br>
$$<br>
å…¶ä¸­ï¼š</p>
<ul>
<li><strong>$w_{1:n}$</strong>ï¼šé•¿åº¦ä¸º n$ çš„æ–‡æœ¬åºåˆ—ï¼ˆä¾‹å¦‚å¥å­æˆ–è¯åºåˆ—ï¼‰ã€‚</li>
<li><strong>$x$</strong>ï¼šé¢å¤–æ¨¡æ€çš„è¾“å…¥ï¼ˆå¦‚å›¾åƒã€éŸ³é¢‘ç­‰ï¼Œåœ¨å¤šæ¨¡æ€ä»»åŠ¡ä¸­å¯èƒ½ä½œä¸ºæ¡ä»¶è¾“å…¥ï¼‰ã€‚</li>
<li><strong>$P(w_n = i | w_{1:n-1}, x)$</strong>ï¼šæ¨¡å‹åŸºäºå†å²åºåˆ— $w_{1:n-1}$ å’Œé¢å¤–ä¿¡æ¯ $x$ï¼Œé¢„æµ‹ä¸‹ä¸€ä¸ªè¯ $w_n$ ä¸º $i$ çš„æ¦‚ç‡ã€‚</li>
<li><strong>$N$</strong>ï¼šåºåˆ—çš„æ€»é•¿åº¦ï¼ˆæˆ–è¯æ•°ï¼‰ã€‚</li>
</ul>
<br>
<h2 id="Datasets">Datasets</h2>
<p>image-text descriptions: IAPR TC-12, Attributes Discovery, and the SBU datasets.</p>
<br>
<h2 id="Paper">Paper</h2>
<h3 id="Distribution-Base">Distribution-Base</h3>
<h4 id="CAP">CAP</h4>
<p>CAP twelve years later: How the â€œrulesâ€ have changed</p>
<p><a href="https://ieeexplore.ieee.org/abstract/document/6133253">https://ieeexplore.ieee.org/abstract/document/6133253</a></p>
<p><strong>ä¸€è‡´æ€§ (Consistency, C)ï¼š</strong></p>
<ul>
<li><strong>å«ä¹‰ï¼š</strong> åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯¹æ•°æ®è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆæˆ–è€…è¯´ä»ä»»ä½•èŠ‚ç‚¹è¯»å–ï¼‰éƒ½èƒ½çœ‹åˆ°ç›¸åŒä¸”æœ€æ–°çš„æ•°æ®ã€‚å°±å¥½æ¯”ç³»ç»Ÿé‡Œåªæœ‰ä¸€ä»½æ•°æ®ï¼Œè€Œä¸”è¿™ä»½æ•°æ®æ€»æ˜¯æœ€æ–°çš„ã€‚</li>
</ul>
<p><strong>é«˜å¯ç”¨æ€§ (High Availability, A)ï¼š</strong></p>
<ul>
<li><strong>å«ä¹‰ï¼š</strong> ç³»ç»Ÿåœ¨éæ•…éšœæƒ…å†µä¸‹ï¼Œåº”è¯¥èƒ½å¤Ÿå¤„ç†æ‰€æœ‰è¯·æ±‚å¹¶è¿”å›å“åº”ï¼ˆæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œç³»ç»Ÿçš„å¤§éƒ¨åˆ†æˆ–å…¨éƒ¨èŠ‚ç‚¹åº”è¯¥å§‹ç»ˆä¿æŒè¿è¡ŒçŠ¶æ€ï¼Œå¹¶ä¸”èƒ½å¤Ÿå“åº”æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ç‰¹åˆ«æ˜¯å¯¹äºå†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯åº”è¯¥æ€»æ˜¯èƒ½å¤ŸæˆåŠŸåœ°å°†æ•°æ®å†™å…¥ç³»ç»Ÿã€‚</li>
</ul>
<p><strong>ç½‘ç»œåˆ†åŒºå®¹å¿æ€§ (Tolerance to Network Partitions, P)ï¼š</strong></p>
<ul>
<li><strong>å«ä¹‰ï¼š</strong> å½“åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ä¹‹é—´å‘ç”Ÿç½‘ç»œé€šä¿¡æ•…éšœæ—¶ï¼ˆå³ç½‘ç»œåˆ†åŒºï¼Œå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹æ— æ³•ä¸å¦ä¸€éƒ¨åˆ†èŠ‚ç‚¹é€šä¿¡ï¼‰ï¼Œç³»ç»Ÿä»ç„¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚</li>
</ul>
<p><strong>æ ¸å¿ƒæ¦‚å¿µæ€»ç»“ï¼š</strong></p>
<p>å½“ç½‘ç»œå‡ºç°åˆ†åŒºï¼ˆPï¼‰æ—¶ï¼Œä¸å¯èƒ½åŒæ—¶æ‹¥æœ‰å®Œç¾çš„â€œä¸€è‡´æ€§â€ï¼ˆCï¼‰å’Œå®Œç¾çš„â€œå¯ç”¨æ€§â€ï¼ˆAï¼‰ã€‚ä½ å¿…é¡»åœ¨è¿™ä¸¤è€…ä¹‹é—´åšå‡ºæƒè¡¡ï¼š</p>
<ul>
<li><strong>CP ç³»ç»Ÿï¼š</strong> ä¼˜å…ˆä¿è¯ä¸€è‡´æ€§ï¼Œåœ¨åˆ†åŒºæ—¶ç‰ºç‰²å¯ç”¨æ€§ã€‚</li>
<li><strong>AP ç³»ç»Ÿï¼š</strong> ä¼˜å…ˆä¿è¯å¯ç”¨æ€§ï¼Œåœ¨åˆ†åŒºæ—¶ç‰ºç‰²ä¸€è‡´æ€§ï¼ˆæ„å‘³ç€å¯èƒ½éœ€è¦åæœŸå¤„ç†æ•°æ®å†²çªï¼‰ã€‚</li>
</ul>
<h3 id="LLM-Base">LLM-Base</h3>
<h4 id="Attention">Attention</h4>
<p><strong>Attention is All You Need</strong></p>
<p><a href="https://arxiv.org/abs/1706.03762">https://arxiv.org/abs/1706.03762</a></p>
<br>
<h4 id="GPT">GPT</h4>
<p><a href="https://cdn.openai.com/research-covers/language-unsupervised/language_understanding_paper.pdf">https://cdn.openai.com/research-covers/language-unsupervised/language_understanding_paper.pdf</a></p>
<p>Improving Language Understanding by Generative Pre-Training</p>
<p>GPTæ˜¯åŸºäºTransformerçš„<strong>Decoder</strong>éƒ¨åˆ†ï¼Œä½†ç§»é™¤äº†äº¤å‰æ³¨æ„åŠ›ã€‚</p>
<ul>
<li><strong>â€œç”Ÿæˆå¼â€</strong>ï¼šæŒ‡çš„æ˜¯é¢„è®­ç»ƒé˜¶æ®µçš„ä»»åŠ¡æ˜¯è¯­è¨€æ¨¡å‹ä»»åŠ¡ï¼Œå³é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ç”Ÿæˆæ–‡æœ¬çš„èƒ½åŠ›ã€‚</li>
<li><strong>â€œé¢„è®­ç»ƒâ€</strong>ï¼šæŒ‡çš„æ˜¯æ¨¡å‹åœ¨å¤§é‡æ— æ ‡ç­¾æ–‡æœ¬æ•°æ®ä¸Šï¼Œé€šè¿‡ä¸Šè¿°ç”Ÿæˆä»»åŠ¡è¿›è¡Œè®­ç»ƒï¼Œä»è€Œå­¦ä¹ åˆ°é€šç”¨çš„è¯­è¨€è¡¨ç¤ºå’Œèƒ½åŠ›ï¼Œè¿™äº›èƒ½åŠ›å¯ä»¥åœ¨åç»­çš„ä¸‹æ¸¸ä»»åŠ¡ä¸­è¿›è¡Œè¿ç§»ã€‚</li>
</ul>
<br>
<p><strong>Two Stage Training</strong></p>
<p><strong>Unsupervised pre-training</strong></p>
<ul>
<li>
<p>â€œGiven an unsupervised corpus of tokens $\mathcal{U} = {u_1, \ldots, u_n}$, we use a standard language modeling objective to maximize the following likelihood:â€</p>
<p>$L_1(\mathcal{U}) = \sum_i \log P(u_i|u_{i-k}, \ldots, u_{i-1}; \Theta)$</p>
</li>
<li>
<p>â€œwhere $k$ is the size of the context window, and the conditional probability $P$ is modeled using a neural network with parameters $\Theta$. These parameters are trained using stochastic gradient descent [51].â€</p>
</li>
<li>
<p>â€œIn our experiments, we use a multi-layer <strong>Transformer decoder</strong> [34] for the language model, which is a variant of the transformer [62]. This model applies a multi-headed self-attention operation over the input context tokens followed by position-wise feedforward layers to produce an output distribution over target tokens:â€<br>
$h_0 = UW_e + W_p$<br>
$h_l = \text{transformer_block}(h_{l-1}) \forall i \in [1, n]$<br>
$P(u) = \text{softmax}(h_n W_e^T)$</p>
</li>
<li>
<p>â€œwhere $U = (u_{-k}, \ldots, u_{-1})$ is the context vector of tokens, $n$ is the number of layers, $W_e$ is the token embedding matrix, and $W_p$ is the position embedding matrix.â€</p>
</li>
</ul>
<br>
<p><strong>Supervised fine-tuning</strong></p>
<ul>
<li>
<p>â€œAfter training the model with the objective in Eq. 1, we adapt the parameters to the supervised target task.â€</p>
</li>
<li>
<p>â€œWe assume a labeled dataset $\mathcal{C}$, where each instance consists of a sequence of input tokens, $x^1, \ldots, x^m$, along with a label $y$.â€<br>
è¿™é‡Œå®šä¹‰äº†ç”¨äºå¾®è°ƒçš„ç›‘ç£æ•°æ®é›† $\mathcal{C}$ã€‚æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ ·æœ¬éƒ½åŒ…å«ä¸€ä¸ªè¾“å…¥åºåˆ—ï¼ˆç”± $m$ ä¸ª token ç»„æˆï¼Œ$x^1, \ldots, x^m$ï¼‰ä»¥åŠä¸€ä¸ªå¯¹åº”çš„æ ‡ç­¾ $y$ã€‚</p>
</li>
<li>
<p>â€œThe inputs are passed through our pre-trained model to obtain the final transformer blockâ€™s activation $h_l^m$, which is then fed into an added linear output layer with parameters $W_y$ to predict $y$:â€<br>
è¿™éƒ¨åˆ†æ˜¯å¾®è°ƒçš„å…³é”®æœºåˆ¶ã€‚</p>
<ol>
<li><strong>è¾“å…¥é€šè¿‡é¢„è®­ç»ƒæ¨¡å‹ï¼š</strong> å°†è¾“å…¥åºåˆ— $x^1, \ldots, x^m$ ä¼ å…¥é¢„è®­ç»ƒå¥½çš„ Transformer æ¨¡å‹ã€‚</li>
<li><strong>è·å–æœ€ç»ˆæ¿€æ´»ï¼š</strong> ä»æ¨¡å‹ä¸­è·å–<strong>æœ€åä¸€ä¸ª Transformer block çš„æ¿€æ´» $h_l^m$</strong>ã€‚è¿™é‡Œçš„ $h_l^m$ é€šå¸¸æŒ‡çš„æ˜¯æ•´ä¸ªè¾“å…¥åºåˆ—ç»è¿‡æœ€åä¸€å±‚ Transformer block å¤„ç†åï¼Œ<strong>æœ€åä¸€ä¸ª token ($x^m$) å¯¹åº”çš„éšè—çŠ¶æ€ï¼ˆæ¿€æ´»å€¼ï¼‰</strong>ã€‚åœ¨åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œé€šå¸¸ä½¿ç”¨åºåˆ—æœ«å°¾çš„éšè—çŠ¶æ€ä½œä¸ºæ•´ä¸ªåºåˆ—çš„è¡¨ç¤ºã€‚</li>
<li><strong>è¿æ¥çº¿æ€§è¾“å‡ºå±‚ï¼š</strong> å°† $h_l^m$ è¾“å…¥åˆ°ä¸€ä¸ªæ–°æ·»åŠ çš„çº¿æ€§è¾“å‡ºå±‚ã€‚è¿™ä¸ªçº¿æ€§å±‚çš„å‚æ•°æ˜¯ $W_y$ã€‚</li>
<li><strong>é¢„æµ‹æ ‡ç­¾ $y$ï¼š</strong> é€šè¿‡è¿™ä¸ªçº¿æ€§å±‚é¢„æµ‹æ ‡ç­¾ $y$ã€‚</li>
</ol>
</li>
<li>
<p>$P(y|x^1, \ldots, x^m) = \text{softmax}(h_l^m W_y).$<br>
è¿™ä¸ªå…¬å¼æè¿°äº†åœ¨ç»™å®šè¾“å…¥åºåˆ— $x^1, \ldots, x^m$ çš„æƒ…å†µä¸‹ï¼Œé¢„æµ‹æ ‡ç­¾ $y$ çš„æ¦‚ç‡ã€‚</p>
<ul>
<li>$h_l^m W_y$ æ˜¯æœ€åä¸€ä¸ª token çš„æ¿€æ´» $h_l^m$ ä¸çº¿æ€§å±‚å‚æ•° $W_y$ çš„çŸ©é˜µä¹˜æ³•ã€‚è¿™ä¼šå¾—åˆ°ä¸€ä¸ªä¸æ ‡ç­¾ç±»åˆ«æ•°é‡ç›¸åŒç»´åº¦çš„å‘é‡ã€‚</li>
<li><code>softmax</code> å‡½æ•°å°†è¿™ä¸ªå‘é‡è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œä½¿å¾—æ‰€æœ‰ç±»åˆ«çš„æ¦‚ç‡ä¹‹å’Œä¸º 1ã€‚</li>
</ul>
</li>
<li>
<p>â€œThis gives us the following objective to maximize:â€<br>
$L_2(\mathcal{C}) = \sum_{(x,y)} \log P(y|x^1, \ldots, x^m).$ (4)<br>
è¿™æ˜¯ç›‘ç£å¾®è°ƒé˜¶æ®µçš„ä¸»è¦ç›®æ ‡å‡½æ•°ã€‚</p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ªå¯¹æ•°ä¼¼ç„¶å‡½æ•°ï¼ˆæˆ–äº¤å‰ç†µæŸå¤±çš„è´Ÿå€¼ï¼‰ã€‚</li>
<li>ç›®æ ‡æ˜¯æœ€å¤§åŒ–åœ¨ç»™å®šè¾“å…¥åºåˆ— $(x^1, \ldots, x^m)$ çš„æƒ…å†µä¸‹ï¼Œæ¨¡å‹é¢„æµ‹æ­£ç¡®æ ‡ç­¾ $y$ çš„å¯¹æ•°æ¦‚ç‡ä¹‹å’Œã€‚</li>
<li>æ±‚å’Œéå†äº†ç›‘ç£æ•°æ®é›† $\mathcal{C}$ ä¸­çš„æ‰€æœ‰æ ·æœ¬ $(x, y)$ã€‚</li>
</ul>
</li>
<li>
<p>â€œWe additionally found that including language modeling as an auxiliary objective to the fine-tuning helped learning by (a) improving generalization of the supervised model, and (b) accelerating convergence. This is in line with prior work [50, 43], who also observed improved performance with such an auxiliary objective.â€<br>
è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„å‘ç°å’Œä¼˜åŒ–ç­–ç•¥ã€‚ä½œè€…å‘ç°ï¼Œåœ¨å¾®è°ƒé˜¶æ®µé™¤äº†ä½¿ç”¨ç›‘ç£ä»»åŠ¡çš„ç›®æ ‡å‡½æ•° $L_2(\mathcal{C})$ï¼Œ<strong>åŒæ—¶å¼•å…¥è¯­è¨€æ¨¡å‹ç›®æ ‡ $L_1(\mathcal{C})$ ä½œä¸ºè¾…åŠ©ç›®æ ‡</strong>ï¼Œèƒ½å¤Ÿï¼š</p>
<ul>
<li>a) æé«˜ç›‘ç£æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
<li>b) åŠ é€Ÿæ”¶æ•›ã€‚</li>
<li>è¿™ä¸ä¹‹å‰çš„å·¥ä½œï¼ˆ[50, 43]ï¼‰è§‚å¯Ÿåˆ°çš„ç»“æœä¸€è‡´ã€‚</li>
</ul>
</li>
<li>
<p>â€œSpecifically, we optimize the following objective (with weight $\lambda$):â€<br>
$L_3(\mathcal{C}) = L_2(\mathcal{C}) + \lambda * L_1(\mathcal{C})$<br>
è¿™æ˜¯æœ€ç»ˆç”¨äºå¾®è°ƒçš„æ€»ç›®æ ‡å‡½æ•°ã€‚</p>
<ul>
<li>$L_3(\mathcal{C})$ æ˜¯ $L_2(\mathcal{C})$ï¼ˆç›‘ç£ä»»åŠ¡ç›®æ ‡ï¼‰å’Œ $L_1(\mathcal{C})$ï¼ˆè¯­è¨€æ¨¡å‹ç›®æ ‡ï¼‰çš„åŠ æƒå’Œã€‚</li>
<li>$\lambda$ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨äºæ§åˆ¶è¯­è¨€æ¨¡å‹è¾…åŠ©ç›®æ ‡çš„é‡è¦æ€§ã€‚</li>
<li>è¿™é‡Œçš„ $L_1(\mathcal{C})$ æ˜¯åœ¨å¾®è°ƒæ•°æ®é›† $\mathcal{C}$ ä¸Šè®¡ç®—çš„è¯­è¨€æ¨¡å‹æŸå¤±ã€‚è¿™æ„å‘³ç€åœ¨å¾®è°ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹ä¸ä»…è¦å­¦ä¹ å¦‚ä½•å®Œæˆä¸‹æ¸¸ä»»åŠ¡ï¼Œè¿˜è¦ç»§ç»­ä¿æŒå…¶è¯­è¨€æ¨¡å‹çš„ç”Ÿæˆèƒ½åŠ›ã€‚</li>
</ul>
</li>
<li>
<p>â€œOverall, the only extra parameters we require during fine-tuning are $W_y$, and embeddings for delimiter tokens (described below in Section 3.3).â€<br>
è¿™å¥è¯æŒ‡å‡ºäº†åœ¨å¾®è°ƒé˜¶æ®µï¼Œé™¤äº†é¢„è®­ç»ƒæ¨¡å‹çš„æ‰€æœ‰å‚æ•°å¤–ï¼Œå”¯ä¸€éœ€è¦é¢å¤–æ·»åŠ å’Œè®­ç»ƒçš„å‚æ•°æ˜¯ï¼š</p>
<ul>
<li>$W_y$ï¼šç”¨äºç›‘ç£ä»»åŠ¡çš„çº¿æ€§è¾“å‡ºå±‚çš„å‚æ•°ã€‚</li>
<li><strong>åˆ†éš”ç¬¦ token çš„åµŒå…¥</strong>ï¼šè¿™åœ¨ä¸‹ä¸€èŠ‚ 3.3 ä¸­ä¼šè¯¦ç»†æè¿°ï¼Œè¿™äº›ç‰¹æ®Š token ç”¨äºå°†è¾“å…¥åºåˆ—æ ¼å¼åŒ–ä»¥é€‚åº”ä¸åŒçš„ä¸‹æ¸¸ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼Œåˆ†ç±»ä»»åŠ¡å¯èƒ½éœ€è¦åœ¨åºåˆ—å¼€å¤´æˆ–ç»“å°¾æ·»åŠ ç‰¹æ®Š tokenï¼‰ã€‚</li>
</ul>
</li>
</ul>
<br>
<p><strong>Task-specific input transformations</strong></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250530104004180.png" class="" title="image-20250530104004180">
<ul>
<li>
<p>â€œFor some tasks, like text classification, we can directly fine-tune our model as described above. Certain other tasks, like question answering or textual entailment, have structured inputs such as ordered sentence pairs, or triplets of document, question, and answers. Since our pre-trained model was trained on contiguous sequences of text, we require some modifications to apply it to these tasks.â€</p>
<ul>
<li>å¯¹äºç®€å•çš„ä»»åŠ¡ï¼ˆå¦‚æ–‡æœ¬åˆ†ç±»ï¼‰ï¼Œå¯ä»¥ç›´æ¥æŒ‰ç…§ 3.2 èŠ‚æè¿°çš„æ–¹å¼å¾®è°ƒæ¨¡å‹ã€‚</li>
<li>ä½†å¯¹äºæ›´å¤æ‚çš„ä»»åŠ¡ï¼ˆå¦‚é—®ç­”æˆ–æ–‡æœ¬è•´æ¶µï¼‰ï¼Œè¾“å…¥é€šå¸¸æ˜¯ç»“æ„åŒ–çš„ï¼Œä¾‹å¦‚æœ‰åºçš„å¥å­å¯¹æˆ–æ–‡æ¡£ã€é—®é¢˜å’Œç­”æ¡ˆçš„ä¸‰å…ƒç»„ã€‚</li>
<li>ç”±äºé¢„è®­ç»ƒæ¨¡å‹æ˜¯åŸºäºè¿ç»­çš„æ–‡æœ¬åºåˆ—è¿›è¡Œè®­ç»ƒçš„ï¼Œä¸ºäº†é€‚åº”è¿™äº›ç»“æ„åŒ–è¾“å…¥ï¼Œéœ€è¦è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚</li>
</ul>
</li>
<li>
<p>â€œPrevious work proposed learning task specific architectures on top of transferred representations [44]. Such an approach re-introduces a significant amount of task-specific customization and does not use transfer learning for these additional architectural components.â€</p>
<ul>
<li>ä»¥å‰çš„å·¥ä½œï¼ˆå¦‚ [44]ï¼‰é€šå¸¸ä¼šåœ¨è¿ç§»çš„è¡¨ç¤ºä¹‹ä¸Šæ„å»ºä»»åŠ¡ç‰¹å®šçš„æ¶æ„ã€‚</li>
<li>è¿™ç§æ–¹æ³•ä¼šå¼•å…¥å¤§é‡çš„ä»»åŠ¡ç‰¹å®šå®šåˆ¶ï¼Œå¹¶ä¸”è¿™äº›é¢å¤–çš„æ¶æ„ç»„ä»¶æ— æ³•äº«å—åˆ°è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿ã€‚</li>
</ul>
</li>
<li>
<p>â€œInstead, we use a traversal-style approach [52], where we convert structured inputs into an ordered sequence that our pre-trained model can process. These input transformations allow us to avoid making extensive changes to the architecture across tasks. We provide a brief description of these input transformations below and Figure 1 provides a visual illustration. All transformations include adding randomly initialized start and end tokens ($\langle s \rangle$, $\langle e \rangle$).â€</p>
<ul>
<li>GPT é‡‡ç”¨äº†â€œéå†å¼â€æ–¹æ³•ï¼ˆå‚è€ƒ [52]ï¼‰ï¼Œå³å°†ç»“æ„åŒ–è¾“å…¥è½¬æ¢æˆä¸€ä¸ªæœ‰åºçš„åºåˆ—ï¼Œä½¿å¾—é¢„è®­ç»ƒæ¨¡å‹å¯ä»¥ç›´æ¥å¤„ç†ã€‚</li>
<li>è¿™ç§è¾“å…¥è½¬æ¢é¿å…äº†å¯¹æ¨¡å‹æ¶æ„è¿›è¡Œå¤§é‡çš„ä»»åŠ¡é—´ä¿®æ”¹ï¼Œä»è€Œä¿æŒäº†æ¶æ„çš„ç»Ÿä¸€æ€§ã€‚</li>
<li>æ‰€æœ‰è½¬æ¢éƒ½åŒ…æ‹¬æ·»åŠ éšæœºåˆå§‹åŒ–çš„<strong>å¼€å§‹ token ($\langle s \rangle$)</strong> å’Œ<strong>ç»“æŸ token ($\langle e \rangle$)</strong>ã€‚è¿™äº›ç‰¹æ®Š token çš„åµŒå…¥åœ¨å¾®è°ƒé˜¶æ®µä¹Ÿä¼šè¢«è®­ç»ƒã€‚</li>
</ul>
</li>
</ul>
<p><strong>Textual entailment (æ–‡æœ¬è•´æ¶µ):</strong><br>
â€œFor entailment tasks, we concatenate the premise $p$ and hypothesis $h$ token sequences, with a delimiter token ($ $$) in between.â€</p>
<ul>
<li><strong>ä»»åŠ¡ï¼š</strong> åˆ¤æ–­ä¸€ä¸ªâ€œå‡è¯´ï¼ˆhypothesisï¼‰â€æ˜¯å¦å¯ä»¥ä»ä¸€ä¸ªâ€œå‰æï¼ˆpremiseï¼‰â€ä¸­æ¨æ–­å‡ºæ¥ã€‚</li>
<li><strong>è¾“å…¥è½¬æ¢ï¼š</strong> å°†å‰æ $p$ çš„ token åºåˆ—å’Œå‡è¯´ $h$ çš„ token åºåˆ—<strong>è¿æ¥èµ·æ¥</strong>ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´æ’å…¥ä¸€ä¸ª<strong>åˆ†éš”ç¬¦ token ($$$)</strong>ã€‚</li>
<li><strong>æ ¼å¼ï¼š</strong> $\langle s \rangle \text{ premise } \text{ $ } \text{ hypothesis } \langle e \rangle$</li>
</ul>
<p><strong>Similarity (ç›¸ä¼¼åº¦):</strong><br>
â€œFor similarity tasks, there is no inherent ordering of the two sentences being compared. To reflect this, we modify the input sequence to contain both possible sentence orderings (with a delimiter in between) and process each independently to produce two sequence representations $h_l^m$ which are added element-wise before being fed into the linear output layer.â€</p>
<ul>
<li><strong>ä»»åŠ¡ï¼š</strong> åˆ¤æ–­ä¸¤ä¸ªå¥å­ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚</li>
<li><strong>æŒ‘æˆ˜ï¼š</strong> ä¸¤ä¸ªå¥å­æ²¡æœ‰å›ºæœ‰çš„é¡ºåºã€‚</li>
<li><strong>è¾“å…¥è½¬æ¢ï¼š</strong> ä¸ºäº†è§£å†³æ— åºæ€§ï¼Œæ¨¡å‹ä¼šç”Ÿæˆ<strong>ä¸¤ç§å¯èƒ½çš„å¥å­é¡ºåº</strong>çš„è¾“å…¥åºåˆ—ï¼š
<ol>
<li><strong>é¡ºåº 1ï¼š</strong> å¥å­ A $\text{ $ }$ å¥å­ B</li>
<li><strong>é¡ºåº 2ï¼š</strong> å¥å­ B $\text{ $ }$ å¥å­ A</li>
</ol>
</li>
<li><strong>å¤„ç†æ–¹å¼ï¼š</strong>
<ul>
<li>åˆ†åˆ«å°†è¿™ä¸¤ä¸ªåºåˆ—ç‹¬ç«‹åœ°ä¼ å…¥é¢„è®­ç»ƒæ¨¡å‹ã€‚</li>
<li>å¾—åˆ°ä¸¤ä¸ªåºåˆ—çš„æœ€ç»ˆè¡¨ç¤º $h_l^m$ï¼ˆå³æ¯ä¸ªåºåˆ—çš„æœ€åä¸€ä¸ª token çš„éšè—çŠ¶æ€ï¼‰ã€‚</li>
<li>å°†è¿™ä¸¤ä¸ª $h_l^m$ <strong>è¿›è¡Œé€å…ƒç´ ç›¸åŠ ï¼ˆelement-wise addï¼‰</strong>ã€‚</li>
<li>å°†ç›¸åŠ åçš„ç»“æœè¾“å…¥åˆ°çº¿æ€§è¾“å‡ºå±‚è¿›è¡Œé¢„æµ‹ã€‚</li>
</ul>
</li>
<li><strong>æ ¼å¼ï¼š</strong>
<ul>
<li>Sequence 1: $\langle s \rangle \text{ sentence}_1 \text{ $ } \text{ sentence}_2 \langle e \rangle$</li>
<li>Sequence 2: $\langle s \rangle \text{ sentence}_2 \text{ $ } \text{ sentence}_1 \langle e \rangle$</li>
<li>ç„¶åå°†ä¸¤ä¸ªåºåˆ—çš„è¾“å‡ºè¡¨ç¤ºç›¸åŠ ã€‚</li>
</ul>
</li>
</ul>
<p><strong>Question Answering and Commonsense Reasoning (é—®ç­”å’Œå¸¸è¯†æ¨ç†):</strong><br>
â€œFor these tasks, we are given a context document $z$, a question $q$, and a set of possible answers ${a_k}$. We concatenate the document context and question with each possible answer, adding a delimiter token in between to get $[z; q; $; a_k]$. Each of these sequences are processed independently with our model and then normalized via a softmax layer to produce an output distribution over possible answers.â€</p>
<ul>
<li><strong>ä»»åŠ¡ï¼š</strong> ç»™å®šä¸€ä¸ªæ–‡æ¡£ $z$ã€ä¸€ä¸ªé—®é¢˜ $q$ å’Œä¸€ç»„å¯èƒ½çš„ç­”æ¡ˆ ${a_k}$ï¼Œé€‰æ‹©æ­£ç¡®ç­”æ¡ˆã€‚</li>
<li><strong>è¾“å…¥è½¬æ¢ï¼š</strong> å¯¹äºæ¯ä¸ªå¯èƒ½çš„ç­”æ¡ˆ $a_k$ï¼Œæ„é€ ä¸€ä¸ªç‹¬ç«‹çš„è¾“å…¥åºåˆ—ã€‚
<ul>
<li>å°†<strong>æ–‡æ¡£ä¸Šä¸‹æ–‡ $z$</strong>ã€<strong>é—®é¢˜ $q$</strong> å’Œ<strong>å½“å‰å¯èƒ½çš„ç­”æ¡ˆ $a_k$</strong> è¿æ¥èµ·æ¥ã€‚</li>
<li>åœ¨æ–‡æ¡£ä¸Šä¸‹æ–‡å’Œé—®é¢˜ä¹‹é—´ï¼Œä»¥åŠé—®é¢˜å’Œç­”æ¡ˆä¹‹é—´ï¼Œéƒ½æ’å…¥ä¸€ä¸ª<strong>åˆ†éš”ç¬¦ token ($$$)</strong>ã€‚</li>
</ul>
</li>
<li><strong>æ ¼å¼ï¼š</strong> $\langle s \rangle \text{ document } \text{ $ } \text{ question } \text{ $ } \text{ answer}_k \langle e \rangle$</li>
<li><strong>å¤„ç†æ–¹å¼ï¼š</strong>
<ul>
<li>å¯¹äºæ¯ä¸ªæ„é€ çš„åºåˆ—ï¼ˆå³æ¯ä¸ªå¯èƒ½çš„ç­”æ¡ˆï¼‰ï¼Œéƒ½ç‹¬ç«‹åœ°é€šè¿‡æ¨¡å‹è¿›è¡Œå¤„ç†ã€‚</li>
<li>å¾—åˆ°æ¯ä¸ªåºåˆ—çš„æœ€ç»ˆè¡¨ç¤ºåï¼Œé€šè¿‡ softmax å±‚å½’ä¸€åŒ–ï¼Œå¾—åˆ°æ¯ä¸ªç­”æ¡ˆçš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li>æ¨¡å‹æœ€ç»ˆé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ç­”æ¡ˆã€‚</li>
</ul>
</li>
</ul>
<br>
<br>
<h4 id="BERT">BERT</h4>
<p><strong>BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding</strong></p>
<p><a href="https://arxiv.org/abs/1810.04805">https://arxiv.org/abs/1810.04805</a></p>
<p>BERT arch</p>
<p>denote input embedding as $E$, the final hidden vector of the special [CLS] token as $C \in \mathbb{R}^H$, and the final hidden vector for the $i^{\text{th}}$ input token as $T_i \in \mathbb{R}^H$.</p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250530112142071.png" class="" title="image-20250530112142071">
<p>BERT token representation</p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250530110615396.png" class="" title="image-20250530110615396">
<br>
<p><strong>pre-training</strong></p>
<p>$BERT_{BASE}$ was chosen to have the same model size as OpenAI GPT for comparison purposes. Critically, however, the BERT Transformer uses bidirectional self-attention, while the GPT Transformer uses constrained self-attention where every token can only attend to context to its left</p>
<p>BERTæ˜¯åŸºäºTransformerçš„<strong>Encoder</strong>éƒ¨åˆ†</p>
<p><strong>MLM</strong></p>
<p>â€œé®è”½è¯­è¨€æ¨¡å‹â€ï¼ˆMLMï¼‰æ–¹æ³•</p>
<p>MLMçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p>
<ol>
<li><strong>éšæœºé®è”½ï¼ˆMaskï¼‰è¾“å…¥åºåˆ—ä¸­çš„ä¸€éƒ¨åˆ†è¯è¯­ã€‚</strong> å°±åƒåœ¨å¥å­ä¸­æŒ–ç©ºä¸€æ ·ã€‚</li>
<li><strong>ç„¶åï¼Œæ¨¡å‹çš„ç›®æ ‡æ˜¯é¢„æµ‹è¿™äº›è¢«é®è”½çš„è¯è¯­æ˜¯ä»€ä¹ˆã€‚</strong></li>
</ol>
<p>è¿™ä¸ä¼ ç»Ÿçš„â€œå®Œå½¢å¡«ç©ºâ€ï¼ˆCloze taskï¼‰éå¸¸ç›¸ä¼¼ï¼Œå³ç»™å‡ºä¸€ä¸ªå¥å­ï¼Œå…¶ä¸­æœ‰ä¸€äº›ç¼ºå¤±çš„è¯ï¼Œè¦æ±‚å¡«å…¥æ­£ç¡®çš„è¯ã€‚</p>
<p>å½“æ¨¡å‹å¤„ç†å®Œè¢«é®è”½çš„è¾“å…¥åºåˆ—åï¼Œå¯¹äºæ¯ä¸ª [MASK] æ ‡è®°ï¼ŒBERTä¼šè¾“å‡ºä¸€ä¸ªå¯¹åº”çš„<strong>æœ€ç»ˆéšè—å‘é‡ï¼ˆfinal hidden vectorï¼‰</strong>ã€‚è¿™ä¸ªéšè—å‘é‡åŒ…å«äº†æ¨¡å‹å¯¹è¯¥ä½ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ç†è§£ã€‚</p>
<p>ç„¶åï¼Œè¿™ä¸ªéšè—å‘é‡ä¼šè¢«é€å…¥ä¸€ä¸ª<strong>è¾“å‡ºSoftmaxå±‚</strong>ã€‚è¿™ä¸ªSoftmaxå±‚çš„è¾“å‡ºç»´åº¦ç­‰äºè¯æ±‡è¡¨çš„å¤§å°ï¼ˆvocabulary sizeï¼‰ã€‚Softmaxä¼šä¸ºè¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªè¯åˆ†é…ä¸€ä¸ªæ¦‚ç‡ï¼Œè¡¨ç¤ºè¯¥è¯æ˜¯ [MASK] ä½ç½®çš„æ­£ç¡®è¯çš„æ¦‚ç‡ã€‚æ¨¡å‹ä¼šé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯ä½œä¸ºé¢„æµ‹ç»“æœã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºæ ‡å‡†è¯­è¨€æ¨¡å‹çš„é¢„æµ‹æ–¹å¼ï¼Œåªæ˜¯è¿™é‡Œåªé’ˆå¯¹è¢«é®è”½çš„è¯ã€‚</p>
<ul>
<li><strong>é®è”½æ¯”ä¾‹ï¼š</strong> åœ¨BERTçš„æ‰€æœ‰å®éªŒä¸­ï¼Œæ¯ä¸ªè¾“å…¥åºåˆ—ä¸­**15%**çš„WordPiece tokensï¼ˆBERTä½¿ç”¨çš„å­è¯åˆ†è¯å•å…ƒï¼‰ä¼šè¢«éšæœºé€‰ä¸­å¹¶é®è”½ã€‚</li>
<li><strong>ä¸å»å™ªè‡ªç¼–ç å™¨çš„åŒºåˆ«ï¼š</strong> ä¼ ç»Ÿçš„å»å™ªè‡ªç¼–ç å™¨ï¼ˆDenoising Auto-encodersï¼‰åœ¨è¾“å…¥ä¸­åŠ å…¥å™ªå£°ï¼ˆæ¯”å¦‚é®è”½ï¼‰ï¼Œç„¶åæ¨¡å‹çš„ç›®æ ‡æ˜¯<strong>é‡æ„æ•´ä¸ªåŸå§‹è¾“å…¥</strong>ã€‚è€ŒBERTçš„MLMä¸åŒï¼Œå®ƒ<strong>åªé¢„æµ‹è¢«é®è”½çš„è¯</strong>ï¼Œè€Œä¸æ˜¯é‡æ„æ•´ä¸ªå¥å­ã€‚è¿™ä½¿å¾—BERTèƒ½å¤Ÿæ›´ä¸“æ³¨äºç†è§£ä¸Šä¸‹æ–‡ï¼Œå¹¶é¢„æµ‹ç¼ºå¤±çš„ä¿¡æ¯ã€‚</li>
</ul>
<p>MLMç¡®å®è®©BERTè·å¾—äº†åŒå‘çš„ä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ã€‚ç„¶è€Œï¼Œå®ƒä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼šåœ¨é¢„è®­ç»ƒé˜¶æ®µï¼Œæ¨¡å‹ä¼šçœ‹åˆ°ç‰¹æ®Šçš„ [MASK] æ ‡è®°ã€‚ä½†åœ¨<strong>å¾®è°ƒï¼ˆfine-tuningï¼‰é˜¶æ®µ</strong>ï¼Œå®é™…çš„ä¸‹æ¸¸ä»»åŠ¡ï¼ˆå¦‚æƒ…æ„Ÿåˆ†æã€é—®ç­”ã€å‘½åå®ä½“è¯†åˆ«ç­‰ï¼‰çš„è¾“å…¥æ•°æ®ä¸­<strong>ä¸ä¼šå‡ºç° [MASK] æ ‡è®°</strong>ã€‚è¿™å¯¼è‡´äº†é¢„è®­ç»ƒå’Œå¾®è°ƒä¹‹é—´çš„<strong>ä¸åŒ¹é…ï¼ˆmismatchï¼‰</strong>ï¼šæ¨¡å‹åœ¨é¢„è®­ç»ƒæ—¶å­¦ä¹ äº†å¦‚ä½•å¤„ç† [MASK]ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­å´ä»æœªé‡åˆ°å®ƒã€‚è¿™å¯èƒ½ä¼šå½±å“æ¨¡å‹çš„æ€§èƒ½ã€‚</p>
<p>ä¸ºäº†ç¼“è§£ä¸Šè¿°é¢„è®­ç»ƒ-å¾®è°ƒä¸åŒ¹é…é—®é¢˜ï¼ŒBERTå¼•å…¥äº†ä¸€ä¸ªå·§å¦™çš„ç­–ç•¥ï¼š</p>
<ol>
<li><strong>é¦–å…ˆï¼Œç¡®å®šè¦è¢«â€œé®è”½â€çš„è¯ï¼š</strong> ä»ç„¶éšæœºé€‰æ‹©**15%**çš„tokenä½ç½®ä½œä¸ºè¦è¢«é¢„æµ‹çš„â€œç›®æ ‡â€è¯ã€‚å‡è®¾ç¬¬iä¸ªtokenè¢«é€‰ä¸­ã€‚</li>
<li><strong>å¯¹è¿™15%çš„é€‰ä¸­è¯ï¼Œé‡‡å–ä¸‰ç§ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š</strong>
<ul>
<li><strong>80% çš„æƒ…å†µï¼šç”¨ [MASK] æ›¿æ¢ã€‚</strong> è¿™æ˜¯æœ€å¸¸è§çš„å¤„ç†æ–¹å¼ï¼Œå’Œé€šå¸¸çš„MLMä¸€æ ·ã€‚æ¨¡å‹å­¦ä¹ äº† [MASK] çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºã€‚</li>
<li><strong>10% çš„æƒ…å†µï¼šç”¨ä¸€ä¸ªéšæœºè¯æ›¿æ¢ã€‚</strong> è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„æŠ€å·§ã€‚
<ul>
<li><strong>ç›®çš„ï¼š</strong> å¼ºåˆ¶æ¨¡å‹ä¸ä»…è¦ä¾èµ– [MASK] æ ‡è®°æ¥é¢„æµ‹ï¼Œè¿˜è¦å­¦ä¼šå¤„ç†â€œé”™è¯¯â€çš„è¾“å…¥è¯ã€‚è¿™æ„å‘³ç€æ¨¡å‹éœ€è¦åˆ©ç”¨å…¶<strong>åŒå‘ä¸Šä¸‹æ–‡</strong>æ¥åˆ¤æ–­å½“å‰è¯æ˜¯å¦åˆç†ï¼Œå¹¶é¢„æµ‹å‡ºå®ƒåŸæ¥çš„æ­£ç¡®è¯ã€‚è¿™æé«˜äº†æ¨¡å‹çš„é²æ£’æ€§ã€‚</li>
</ul>
</li>
<li><strong>10% çš„æƒ…å†µï¼šä¿æŒä¸å˜ï¼ˆä¸æ›¿æ¢ï¼‰ã€‚</strong>
<ul>
<li><strong>ç›®çš„ï¼š</strong> è¿™è¿«ä½¿æ¨¡å‹ä¸ä»…ä»…æ˜¯â€œå¡«ç©ºâ€ï¼Œå®ƒè¿˜éœ€è¦è¯†åˆ«å‡ºå“ªäº›è¯æ˜¯å®ƒéœ€è¦é¢„æµ‹çš„ï¼ˆå³ä½¿å®ƒä»¬æ²¡æœ‰è¢«æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”åœ¨æ²¡æœ‰ [MASK] æ ‡è®°çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è¿›è¡Œé¢„æµ‹ã€‚è¿™è¿›ä¸€æ­¥å‡å°‘äº†é¢„è®­ç»ƒå’Œå¾®è°ƒä¹‹é—´çš„å·®å¼‚ï¼Œå› ä¸ºåœ¨å¾®è°ƒæ—¶ï¼Œæ¨¡å‹æ€»æ˜¯çœ‹åˆ°â€œæ­£å¸¸çš„â€è¯ï¼Œè€Œæ²¡æœ‰ [MASK]ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>é¢„æµ‹ç›®æ ‡ï¼š</strong> ä¸è®ºä¸Šè¿°å“ªç§æƒ…å†µï¼Œæ¨¡å‹çš„ç›®æ ‡<strong>å§‹ç»ˆæ˜¯é¢„æµ‹åŸå§‹çš„ã€æœªè¢«ä¿®æ”¹çš„token</strong>ã€‚æŸå¤±å‡½æ•°æ˜¯<strong>äº¤å‰ç†µæŸå¤±ï¼ˆcross entropy lossï¼‰</strong>ï¼Œç”¨äºè¡¡é‡æ¨¡å‹é¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒä¸çœŸå®è¯çš„ç‹¬çƒ­ç¼–ç ï¼ˆone-hot encodingï¼‰ä¹‹é—´çš„å·®å¼‚ã€‚</li>
</ol>
<blockquote>
<p><strong>ä¾‹å­ï¼š</strong><br>
åŸå§‹å¥å­ï¼šThe quick brown fox jumps over the lazy dog.<br>
å‡è®¾ brown è¢«é€‰ä¸­ä½œä¸º15%è¦é¢„æµ‹çš„è¯ä¹‹ä¸€ã€‚</p>
<ul>
<li><strong>æƒ…å†µ1 (80%): [MASK] æ›¿æ¢</strong>
<ul>
<li>è¾“å…¥ï¼šThe quick [MASK] fox jumps over the lazy dog.</li>
<li>æ¨¡å‹é¢„æµ‹ï¼šbrown</li>
</ul>
</li>
<li><strong>æƒ…å†µ2 (10%): éšæœºè¯æ›¿æ¢</strong>
<ul>
<li>å‡è®¾éšæœºé€‰æ‹©äº†è¯ appleã€‚</li>
<li>è¾“å…¥ï¼šThe quick apple fox jumps over the lazy dog.</li>
<li>æ¨¡å‹é¢„æµ‹ï¼šbrown (è™½ç„¶è¾“å…¥æ˜¯ appleï¼Œä½†æ¨¡å‹éœ€è¦æ ¹æ®ä¸Šä¸‹æ–‡ The quick ___ fox åˆ¤æ–­å‡º apple æ˜¯ä¸åˆç†çš„ï¼Œå¹¶é¢„æµ‹åŸè¯ brown)</li>
</ul>
</li>
<li><strong>æƒ…å†µ3 (10%): ä¿æŒä¸å˜</strong>
<ul>
<li>è¾“å…¥ï¼šThe quick brown fox jumps over the lazy dog.</li>
<li>æ¨¡å‹é¢„æµ‹ï¼šbrown (å³ä½¿ brown æ²¡æœ‰è¢«é®è”½ï¼Œæ¨¡å‹ä¹Ÿéœ€è¦å­¦ä¼šé¢„æµ‹å®ƒã€‚è¿™æœ‰ç‚¹åƒä¸€ä¸ªâ€œè‡ªæˆ‘çº æ­£â€æœºåˆ¶ï¼Œæˆ–è€…è¯´ï¼Œåœ¨æ²¡æœ‰ [MASK] æç¤ºçš„æƒ…å†µä¸‹ï¼Œæ¨¡å‹ä¾ç„¶èƒ½å¤Ÿè¯†åˆ«å‡ºæŸäº›ä½ç½®æ˜¯å®ƒéœ€è¦ç‰¹åˆ«å…³æ³¨å’Œé¢„æµ‹çš„ï¼Œå› ä¸ºå®ƒè¢«æ ‡è®°ä¸ºâ€œç›®æ ‡é¢„æµ‹è¯â€ä¹‹ä¸€ã€‚)</li>
</ul>
</li>
</ul>
<p>ä»¥ <code>quick</code> è¿™ä¸ªè¯ä¸ºä¾‹ï¼š</p>
<ul>
<li><strong>çœŸå®æ ‡ç­¾ (Target):</strong> <code>quick</code>ã€‚åœ¨one-hotç¼–ç ä¸­ï¼Œåªæœ‰ <code>quick</code> å¯¹åº”çš„ç»´åº¦æ˜¯1ï¼Œå…¶ä»–éƒ½æ˜¯0ã€‚</li>
<li><strong>BERTæ¨¡å‹é¢„æµ‹æ¦‚ç‡ (Prediction):</strong> BERTæ¨¡å‹å¯¹äº <code>[MASK]</code> ä½ç½®çš„è¾“å‡ºï¼Œç»è¿‡softmaxåï¼Œä¼šå¾—åˆ°ä¸€ä¸ªå…³äºæ•´ä¸ªè¯æ±‡è¡¨çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä¾‹å¦‚ï¼š
<ul>
<li>$P(\text{quick}) = 0.9$</li>
<li>$P(\text{slow}) = 0.05$</li>
<li>$P(\text{brown}) = 0.01$</li>
<li>â€¦</li>
</ul>
</li>
</ul>
<p>äº¤å‰ç†µæŸå¤±è®¡ç®—å°†æ˜¯ï¼š<br>
$Loss_{quick} = - (1 \cdot \log(P(\text{quick})) + 0 \cdot \log(P(\text{slow})) + â€¦)$</p>
<p><strong>åŒç†ï¼Œå¯¹ <code>fox</code> å’Œ <code>lazy</code> è¿›è¡Œè®¡ç®—ï¼š</strong></p>
<ul>
<li>
<p><strong>å¯¹äº <code>fox</code> (è¢«æ›¿æ¢ä¸º <code>apple</code> çš„ä½ç½®):</strong></p>
<ul>
<li>çœŸå®æ ‡ç­¾: <code>fox</code></li>
<li>BERTæ¨¡å‹é¢„æµ‹æ¦‚ç‡: $P(\text{fox})$</li>
<li>$Loss_{fox} = - \log(P(\text{fox}))$</li>
</ul>
</li>
<li>
<p><strong>å¯¹äº <code>lazy</code> (ä¿æŒä¸å˜çš„ä½ç½®):</strong></p>
<ul>
<li>çœŸå®æ ‡ç­¾: <code>lazy</code></li>
<li>BERTæ¨¡å‹é¢„æµ‹æ¦‚ç‡: $P(\text{lazy})$</li>
<li>$Loss_{lazy} = - \log(P(\text{lazy}))$</li>
</ul>
</li>
</ul>
<p><strong>æ€»æŸå¤±ï¼š</strong></p>
<p>æœ€ç»ˆçš„MLMä»»åŠ¡çš„æ€»æŸå¤±æ˜¯æ‰€æœ‰è¢«é¢„æµ‹è¯çš„äº¤å‰ç†µæŸå¤±çš„<strong>å¹³å‡å€¼</strong>ï¼ˆæˆ–æ±‚å’Œï¼Œç„¶åé™¤ä»¥è¢«é¢„æµ‹è¯çš„æ•°é‡ï¼‰ã€‚</p>
<p>$Total Loss = (Loss_{quick} + Loss_{fox} + Loss_{lazy}) / 3$ (å‡è®¾åªæœ‰è¿™ä¸‰ä¸ªè¯è¢«é¢„æµ‹)</p>
</blockquote>
<br>
<p><strong>NSP</strong></p>
<p>BERTçš„ç¬¬ä¸€ä¸ªé¢„è®­ç»ƒä»»åŠ¡ï¼ˆMLMï¼‰ä¸»è¦å…³æ³¨çš„æ˜¯<strong>è¯æ±‡å±‚é¢çš„ç†è§£å’Œä¸Šä¸‹æ–‡è¡¨ç¤º</strong>ã€‚ç„¶è€Œï¼Œè®¸å¤šé‡è¦çš„è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ä¸‹æ¸¸ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><strong>é—®ç­”ï¼ˆQuestion Answering, QAï¼‰</strong>ï¼šæ¨¡å‹éœ€è¦åˆ¤æ–­ä¸€ä¸ªå¥å­ï¼ˆé—®é¢˜ï¼‰å’Œå¦ä¸€ä¸ªå¥å­ï¼ˆæ®µè½ä¸­çš„ç­”æ¡ˆå¥ï¼‰ä¹‹é—´çš„å…³ç³»ã€‚</li>
<li><strong>è‡ªç„¶è¯­è¨€æ¨ç†ï¼ˆNatural Language Inference, NLIï¼‰</strong>ï¼šä¹Ÿç§°ä¸ºè•´å«è¯†åˆ«ï¼Œæ¨¡å‹éœ€è¦åˆ¤æ–­ä¸€ä¸ªå‰æï¼ˆpremiseï¼‰å’Œä¸€ä¸ªå‡è®¾ï¼ˆhypothesisï¼‰ä¹‹é—´çš„å…³ç³»ï¼ˆè•´å«ã€çŸ›ç›¾ã€ä¸­ç«‹ï¼‰ã€‚</li>
</ul>
<p>è¿™äº›ä»»åŠ¡éƒ½è¦æ±‚æ¨¡å‹èƒ½å¤Ÿç†è§£<strong>ä¸¤ä¸ªå¥å­ä¹‹é—´çš„å…³ç³»</strong>ï¼Œè€Œä¸ä»…ä»…æ˜¯å•ä¸ªå¥å­å†…éƒ¨çš„è¯è¯­å…³ç³»ã€‚ä¼ ç»Ÿçš„è¯­è¨€æ¨¡å‹ï¼ˆæ— è®ºæ˜¯ä»å·¦åˆ°å³è¿˜æ˜¯MLMï¼‰å¹¶æ²¡æœ‰ç›´æ¥æ•æ‰è¿™ç§è·¨å¥å­çš„å…³ç³»ã€‚</p>
<p>NSPä»»åŠ¡çš„è®­ç»ƒæ•°æ®ç”Ÿæˆæ–¹å¼å¦‚ä¸‹ï¼š<br>
å¯¹äºæ¯ä¸ªè®­ç»ƒæ ·æœ¬ï¼Œæ¨¡å‹ä¼šè¾“å…¥ä¸¤ä¸ªå¥å­ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå¥å­Aå’Œå¥å­Bã€‚</p>
<ol>
<li><strong>50% çš„æƒ…å†µï¼šIsNext (æ˜¯ä¸‹ä¸€å¥)</strong>
<ul>
<li>å¥å­Bç¡®å®æ˜¯è¯­æ–™åº“ä¸­ç´§è·Ÿåœ¨å¥å­Aåé¢çš„é‚£å¥è¯ã€‚</li>
<li>è¿™ä¸ªæ ·æœ¬ä¼šè¢«æ ‡è®°ä¸º IsNextã€‚</li>
</ul>
</li>
<li><strong>50% çš„æƒ…å†µï¼šNotNext (ä¸æ˜¯ä¸‹ä¸€å¥)</strong>
<ul>
<li>å¥å­Bæ˜¯è¯­æ–™åº“ä¸­éšæœºé€‰æ‹©çš„å¦ä¸€å¥è¯ï¼Œä¸å¥å­Aæ²¡æœ‰ç›´æ¥çš„è¿ç»­å…³ç³»ã€‚</li>
<li>è¿™ä¸ªæ ·æœ¬ä¼šè¢«æ ‡è®°ä¸º NotNextã€‚</li>
</ul>
</li>
</ol>
<p>ç»“æ„å›¾ä¸­çš„â€œCâ€æŒ‡çš„æ˜¯BERTæ¨¡å‹åœ¨å¤„ç†å¤šå¥è¾“å…¥æ—¶ï¼Œç”¨äºè¡¨ç¤ºæ•´ä¸ªè¾“å…¥åºåˆ—çš„ç‰¹æ®Šæ ‡è®° [CLS] çš„æœ€ç»ˆéšè—å‘é‡ã€‚åœ¨BERTçš„è¾“å…¥æ ¼å¼ä¸­ï¼Œä¸¤ä¸ªå¥å­Aå’ŒBä¼šè¢«è¿æ¥èµ·æ¥ï¼Œä¸­é—´ç”¨ [SEP] åˆ†éš”ï¼Œå¼€å¤´æœ‰ [CLS] æ ‡è®°ã€‚</p>
<p>è¾“å…¥æ ¼å¼å¤§è‡´æ˜¯ï¼š[CLS] Sentence A [SEP] Sentence B [SEP]</p>
<ul>
<li>[CLS] æ ‡è®°çš„æœ€ç»ˆéšè—å‘é‡ï¼ˆé€šå¸¸ç§°ä¸º C æˆ– T_CLSï¼‰è¢«è®¤ä¸ºæ˜¯åŒ…å«äº†æ•´ä¸ªè¾“å…¥åºåˆ—ï¼ˆåŒ…æ‹¬ä¸¤ä¸ªå¥å­åŠå…¶å…³ç³»ï¼‰çš„ç»¼åˆä¿¡æ¯ã€‚</li>
<li>è¿™ä¸ª [CLS] æ ‡è®°å¯¹åº”çš„éšè—å‘é‡ä¼šè¢«é€å…¥ä¸€ä¸ªç®€å•çš„åˆ†ç±»å±‚ï¼ˆä¾‹å¦‚ä¸€ä¸ªçº¿æ€§å±‚æ¥Softmaxï¼‰ï¼Œè¿›è¡ŒäºŒåˆ†ç±»é¢„æµ‹ï¼šIsNext æˆ– NotNextã€‚</li>
</ul>
<blockquote>
<p><strong>ä¾‹å­ï¼š</strong><br>
å¯¹äºè¾“å…¥ [CLS] The cat sat on the mat. [SEP] It was a fluffy cat. [SEP]</p>
<ol>
<li>BERTå¤„ç†æ•´ä¸ªè¾“å…¥åºåˆ—ã€‚</li>
<li>æå– [CLS] æ ‡è®°å¯¹åº”çš„è¾“å‡ºå‘é‡ã€‚</li>
<li>å°†è¯¥å‘é‡é€å…¥ä¸€ä¸ªåˆ†ç±»å™¨ã€‚</li>
<li>åˆ†ç±»å™¨è¾“å‡ºæ¦‚ç‡ï¼šP(IsNext)=0.98, P(NotNext)=0.02ã€‚æ¨¡å‹é¢„æµ‹ IsNextã€‚</li>
</ol>
</blockquote>
<br>
<p><strong>Fine-tuning</strong></p>
<p>BERTç›´æ¥æŠŠä¸¤æ®µæ–‡æœ¬ï¼ˆä¾‹å¦‚ï¼Œé—®é¢˜å’Œæ–‡ç« ï¼‰<strong>æ‹¼æ¥</strong>åœ¨ä¸€èµ·ï¼ˆç”¨ç‰¹æ®Šåˆ†éš”ç¬¦[SEP]éš”å¼€ï¼‰ï¼Œç„¶åä¸€èµ·è¾“å…¥ç»™BERTã€‚BERTçš„<strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ç¥å¥‡ä¹‹å¤„åœ¨äºï¼Œå½“å®ƒå¤„ç†è¿™ä¸ªæ‹¼æ¥åçš„é•¿æ–‡æœ¬æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åœ°åœ¨é—®é¢˜å’Œæ–‡ç« çš„è¯è¯­ä¹‹é—´å»ºç«‹èµ·â€œåŒå‘äº¤å‰æ³¨æ„åŠ›â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªè¯åœ¨é—®é¢˜ä¸­ï¼Œå®ƒä¹Ÿä¼šå…³æ³¨æ–‡ç« ä¸­çš„æ‰€æœ‰è¯ï¼›ä¸€ä¸ªè¯åœ¨æ–‡ç« ä¸­ï¼Œå®ƒä¹Ÿä¼šå…³æ³¨é—®é¢˜ä¸­çš„æ‰€æœ‰è¯ã€‚è¿™ä¸€ä¸ªæ­¥éª¤å°±å®Œæˆäº†ä¼ ç»Ÿçš„â€œç‹¬ç«‹ç¼–ç â€å’Œâ€œäº¤å‰æ³¨æ„åŠ›â€ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œï¼Œç®€åŒ–äº†æ¨¡å‹ç»“æ„ã€‚</p>
<p>å¯¹äºæ¯ä¸ªä¸åŒçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠä»»åŠ¡å¯¹åº”çš„è¾“å…¥æ ¼å¼ï¼ˆå¦‚å•å¥ã€å¥å­å¯¹ï¼‰å’Œä»»åŠ¡å¯¹åº”çš„è¾“å‡ºè¦æ±‚ï¼ˆå¦‚åˆ†ç±»ç»“æœã€è¯çº§åˆ«æ ‡ç­¾ï¼‰æ¥å…¥åˆ°é¢„è®­ç»ƒå¥½çš„BERTæ¨¡å‹ä¸Šï¼Œç„¶åä»å¤´åˆ°å°¾ï¼ˆend-to-endï¼‰åœ°å¾®è°ƒæ•´ä¸ªæ¨¡å‹çš„æ‰€æœ‰å‚æ•°ã€‚</p>
<p>BERTåœ¨å¾®è°ƒæ—¶ï¼Œæ ¹æ®ä»»åŠ¡ç±»å‹åˆ©ç”¨å…¶è¾“å‡ºçš„ä¸åŒéƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>Token-level tasks (è¯çº§åˆ«ä»»åŠ¡)ï¼š</strong>
<ul>
<li><strong>ç”¨é€”ï¼š</strong> å¯¹äºéœ€è¦å¯¹è¾“å…¥æ–‡æœ¬ä¸­çš„æ¯ä¸ªè¯è¿›è¡Œåˆ¤æ–­æˆ–æ ‡è®°çš„ä»»åŠ¡ã€‚</li>
<li><strong>å–ç”¨è¾“å‡ºï¼š</strong> ä½¿ç”¨BERTè¾“å‡ºçš„<strong>æ¯ä¸ªè¯ï¼ˆtokenï¼‰å¯¹åº”çš„å‘é‡è¡¨ç¤º</strong>ã€‚</li>
<li><strong>ä¸¾ä¾‹ï¼š</strong>
<ul>
<li><strong>åºåˆ—æ ‡æ³¨ (Named Entity Recognition, NER)ï¼š</strong> è¾“å…¥ â€œå¼ ä¸‰åœ¨çº½çº¦å·¥ä½œâ€ã€‚BERTä¼šä¸º&quot;å¼ ä¸‰&quot;ã€â€œåœ¨â€ã€â€œçº½çº¦â€ã€&quot;å·¥ä½œ&quot;ç­‰æ¯ä¸ªè¯ç”Ÿæˆä¸€ä¸ªå‘é‡ã€‚ç„¶åï¼Œå°†è¿™äº›å‘é‡è¾“å…¥ä¸€ä¸ªçº¿æ€§å±‚ï¼Œåˆ†åˆ«é¢„æµ‹&quot;å¼ ä¸‰&quot;æ˜¯äººåï¼ˆPERï¼‰ã€&quot;çº½çº¦&quot;æ˜¯åœ°åï¼ˆLOCï¼‰ã€‚</li>
<li><strong>é—®ç­” (Question Answering, QA)ï¼š</strong> BERTä¸ºæ–‡ç« ä¸­çš„æ¯ä¸ªè¯ç”Ÿæˆå‘é‡ã€‚è¿™äº›å‘é‡è¢«ç”¨äºé¢„æµ‹ç­”æ¡ˆçš„èµ·å§‹è¯å’Œç»“æŸè¯ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>Classification tasks (åˆ†ç±»ä»»åŠ¡)ï¼š</strong>
<ul>
<li><strong>ç”¨é€”ï¼š</strong> å¯¹äºéœ€è¦å¯¹æ•´ä¸ªè¾“å…¥æ–‡æœ¬ï¼ˆæˆ–æ–‡æœ¬å¯¹ï¼‰è¿›è¡Œåˆ†ç±»çš„ä»»åŠ¡ã€‚</li>
<li><strong>å–ç”¨è¾“å‡ºï¼š</strong> ä½¿ç”¨BERTè¾“å‡ºçš„**[CLS] tokenå¯¹åº”çš„å‘é‡è¡¨ç¤º**ã€‚[CLS] tokenæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ï¼Œå®ƒçš„æœ€ç»ˆå‘é‡è¡¨ç¤ºè¢«è®¾è®¡æˆèƒ½å¤Ÿæ±‡èšæ•´ä¸ªè¾“å…¥åºåˆ—çš„è¯­ä¹‰ä¿¡æ¯ã€‚</li>
<li><strong>ä¸¾ä¾‹ï¼š</strong>
<ul>
<li><strong>è¯­ä¹‰è•´å« (Entailment)ï¼š</strong> è¾“å…¥[CLS] ç‹—åœ¨è·‘ [SEP] åŠ¨ç‰©åœ¨è¿åŠ¨ [SEP]ã€‚å–[CLS]çš„å‘é‡ï¼Œè¾“å…¥ä¸€ä¸ªåˆ†ç±»å±‚ï¼Œåˆ¤æ–­å±äºâ€œè•´å«â€ã€â€œçŸ›ç›¾â€è¿˜æ˜¯â€œä¸­æ€§â€ã€‚</li>
<li><strong>æƒ…æ„Ÿåˆ†æ (Sentiment Analysis)ï¼š</strong> è¾“å…¥[CLS] è¿™éƒ¨ç”µå½±å¤ªæ£’äº†ï¼ [SEP]ã€‚å–[CLS]çš„å‘é‡ï¼Œè¾“å…¥ä¸€ä¸ªåˆ†ç±»å±‚ï¼Œåˆ¤æ–­å±äºâ€œæ­£é¢â€ã€â€œè´Ÿé¢â€æˆ–â€œä¸­æ€§â€ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>åŸå§‹BERTè®ºæ–‡ä¸­æåˆ°çš„é—®ç­”ä»»åŠ¡ï¼Œç‰¹æŒ‡<strong>é—®ç­”æŠ½å–ï¼ˆExtractive QAï¼‰</strong>ï¼Œè€Œä¸æ˜¯é—®ç­”ç”Ÿæˆã€‚</p>
</blockquote>
<br>
<p><strong>Training Objectives</strong></p>
<ul>
<li><strong>é¢„è®­ç»ƒé˜¶æ®µï¼š</strong> BERTåœ¨é¢„è®­ç»ƒæ—¶å­¦ä¹ äº†ä¸¤ç§ä»»åŠ¡ï¼šMLMï¼ˆMasked Language Modelï¼‰å’ŒNSPï¼ˆNext Sentence Predictionï¼‰ã€‚NSPä»»åŠ¡çš„è¾“å…¥å°±æ˜¯[CLS] Sentence A [SEP] Sentence B [SEP]ï¼Œå®ƒéœ€è¦åˆ¤æ–­Sentence Bæ˜¯å¦æ˜¯Sentence Açš„ä¸‹ä¸€å¥ã€‚è¿™é‡Œçš„Sentence Aå’ŒSentence Bæ˜¯ä»»æ„ä»è¯­æ–™ä¸­æŠ½å–çš„ã€‚</li>
<li><strong>åˆ°ä¸‹æ¸¸ä»»åŠ¡çš„æ˜ å°„ï¼š</strong>
<ol>
<li><strong>Paraphrasing (å¤è¿°åˆ¤æ–­)ï¼š</strong> åˆ¤æ–­ä¸¤å¥è¯æ˜¯å¦è¡¨è¾¾ç›¸åŒçš„æ„æ€ã€‚
<ul>
<li>å¯¹åº”ï¼š[CLS] å¥å­A [SEP] å¥å­B [SEP]</li>
<li>ä¾‹å¦‚ï¼š[CLS] ä»–ä¹°äº†ä¸€è¾†æ–°è½¦ [SEP] ä»–è´­å…¥äº†ä¸€å°æ–°è½¿è½¦ [SEP]</li>
</ul>
</li>
<li><strong>Entailment (è¯­ä¹‰è•´å«)ï¼š</strong> åˆ¤æ–­ä¸€ä¸ªâ€œå‡è®¾å¥â€æ˜¯å¦èƒ½ä»ä¸€ä¸ªâ€œå‰æå¥â€ä¸­æ¨å¯¼å‡ºæ¥ã€‚
<ul>
<li>å¯¹åº”ï¼š[CLS] å‡è®¾å¥ [SEP] å‰æå¥ [SEP]</li>
<li>ä¾‹å¦‚ï¼š[CLS] ç‹—åœ¨è·‘ [SEP] åŠ¨ç‰©åœ¨è¿åŠ¨ [SEP] (å‡è®¾å¥ï¼šç‹—åœ¨è·‘ï¼Œå‰æå¥ï¼šåŠ¨ç‰©åœ¨è¿åŠ¨ã€‚ç‹—åœ¨è·‘è•´å«åŠ¨ç‰©åœ¨è¿åŠ¨)</li>
</ul>
</li>
<li><strong>Question Answering (é—®ç­”)ï¼š</strong>
<ul>
<li>å¯¹åº”ï¼š[CLS] é—®é¢˜ [SEP] æ®µè½ [SEP]</li>
<li>ä¾‹å¦‚ï¼š[CLS] è°æ˜¯ç¾å›½ç¬¬ä¸€ä½æ€»ç»Ÿï¼Ÿ [SEP] ä¹”æ²»Â·åç››é¡¿æ˜¯ç¾å›½çš„ç¬¬ä¸€ä½æ€»ç»Ÿâ€¦ [SEP]</li>
</ul>
</li>
<li><strong>Degenerate text-âˆ… pair in text classification or sequence tagging (æ–‡æœ¬åˆ†ç±»æˆ–åºåˆ—æ ‡æ³¨ä¸­çš„â€œé€€åŒ–â€æ–‡æœ¬-ç©ºå¯¹)ï¼š</strong> è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œå¯¹äºåªæ¶‰åŠå•å¥çš„ä»»åŠ¡ï¼Œå¯ä»¥æŠŠâ€œç©ºâ€è§†ä¸ºç¬¬äºŒæ®µæ–‡æœ¬ã€‚
<ul>
<li>å¯¹åº”ï¼š[CLS] å¥å­A [SEP] [SEP] (æ³¨æ„ï¼Œè¿™é‡ŒSentence Bå®é™…ä¸Šæ˜¯ç©ºçš„ï¼Œåªç”¨äº†ä¸€ä¸ª[SEP]æ ‡è®°)</li>
<li>ä¾‹å¦‚ï¼ˆæƒ…æ„Ÿåˆ†æï¼‰ï¼š[CLS] è¿™éƒ¨ç”µå½±å¤ªæ£’äº†ï¼ [SEP] (ä¸¥æ ¼æ¥è¯´æ˜¯[CLS] è¿™éƒ¨ç”µå½±å¤ªæ£’äº†ï¼ [SEP] [SEP])</li>
<li>ä¾‹å¦‚ï¼ˆå‘½åå®ä½“è¯†åˆ«ï¼‰ï¼š[CLS] å¼ ä¸‰åœ¨çº½çº¦å·¥ä½œ [SEP]</li>
</ul>
</li>
</ol>
</li>
</ul>
<br>
<p><strong>Inference</strong></p>
<p>BERTçš„è¾“å‡ºä¸€èˆ¬ä¸º<strong>åˆ†ç±»ä»»åŠ¡ (æƒ…æ„Ÿåˆ†æã€è¯­ä¹‰è•´å«)</strong>ï¼Œ**åºåˆ—æ ‡æ³¨ä»»åŠ¡ (å‘½åå®ä½“è¯†åˆ«)**ç­‰</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè¾“å…¥åºåˆ—ï¼š<code>&quot;The dog [MASK] at the cat.&quot;</code><br>
BERTçš„ç›®æ ‡æ˜¯é¢„æµ‹ <code>[MASK]</code> ä½ç½®åº”è¯¥å¡«å…¥ä»€ä¹ˆè¯ã€‚</p>
<p><strong>æ­¥éª¤åˆ†è§£ï¼š</strong></p>
<ol>
<li>
<p><strong>è¾“å…¥é¢„å¤„ç†ä¸åµŒå…¥ï¼š</strong></p>
<ul>
<li>è¾“å…¥åºåˆ—è¢«æ ‡è®°åŒ–ä¸ºï¼š<code>[&quot;The&quot;, &quot;dog&quot;, &quot;[MASK]&quot;, &quot;at&quot;, &quot;the&quot;, &quot;cat&quot;, &quot;[SEP]&quot;]</code> (é€šå¸¸è¿˜ä¼šåŠ ä¸Š <code>[CLS]</code> åœ¨å¼€å¤´ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–å…³æ³¨ç‚¹æš‚ä¸æ)ã€‚</li>
<li>æ¯ä¸ªtokenï¼ˆåŒ…æ‹¬ <code>[MASK]</code> tokenæœ¬èº«ï¼‰è¢«è½¬æ¢ä¸ºå…¶å¯¹åº”çš„è¯åµŒå…¥å’Œä½ç½®ç¼–ç ï¼Œå¹¶ç›¸åŠ ã€‚</li>
<li>å¾—åˆ°ä¸€ä¸ªè¾“å…¥å¼ é‡ï¼Œç»´åº¦ä¸º <code>(1, L, D)</code> (batch_size=1, L=7, D=éšè—å±‚ç»´åº¦ï¼Œä¾‹å¦‚768)ã€‚</li>
</ul>
</li>
<li>
<p><strong>é€šè¿‡Transformer Encoderå±‚ï¼š</strong></p>
<ul>
<li>è¿™ä¸ª <code>(1, L, D)</code> çš„å¼ é‡ä¼šé€šè¿‡BERTçš„å¤šä¸ªTransformer Encoderå±‚ï¼ˆä¾‹å¦‚BERT-baseæœ‰12å±‚ï¼ŒBERT-largeæœ‰24å±‚ï¼‰ã€‚</li>
<li><strong>å…³é”®ç‚¹åœ¨äºï¼š</strong> BERTçš„Encoderå±‚ä¸­çš„è‡ªæ³¨æ„åŠ›æ˜¯<strong>åŒå‘çš„</strong>ã€‚è¿™æ„å‘³ç€å½“æ¨¡å‹å¤„ç† <code>[MASK]</code> tokenæ—¶ï¼Œå®ƒ<strong>å¯ä»¥åŒæ—¶å…³æ³¨åˆ° <code>[MASK]</code> å‰åçš„æ‰€æœ‰è¯</strong>ï¼ˆâ€œTheâ€, â€œdogâ€, â€œatâ€, â€œtheâ€, â€œcatâ€, â€œ[SEP]â€ï¼‰ã€‚</li>
<li>æ¯ä¸€å±‚éƒ½ä¼šå¯¹tokençš„è¡¨ç¤ºè¿›è¡Œç»†åŒ–å’Œæ›´æ–°ï¼Œèå…¥æ›´æ·±å±‚æ¬¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>
<p><strong>è·å– <code>[MASK]</code> token çš„æœ€ç»ˆéšè—çŠ¶æ€ï¼š</strong></p>
<ul>
<li>ç»è¿‡æ‰€æœ‰Encoderå±‚åï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæœ€ç»ˆçš„éšè—çŠ¶æ€å¼ é‡ï¼Œç»´åº¦ä»ç„¶æ˜¯ <code>(1, L, D)</code>ã€‚</li>
<li>æˆ‘ä»¬ç°åœ¨éœ€è¦ä»è¿™ä¸ªå¼ é‡ä¸­ï¼Œ<strong>æå–å¯¹åº” <code>[MASK]</code> token ä½ç½®çš„éšè—çŠ¶æ€</strong>ã€‚</li>
<li>å‡è®¾ <code>[MASK]</code> token åœ¨åºåˆ—ä¸­çš„ç´¢å¼•æ˜¯2ã€‚é‚£ä¹ˆæˆ‘ä»¬å–å‡º <code>output_tensor[0, 2, :]</code>ï¼Œè¿™å°†å¾—åˆ°ä¸€ä¸ªç»´åº¦ä¸º <code>(D,)</code> çš„å‘é‡ï¼ˆä¾‹å¦‚ <code>(768,)</code>ï¼‰ã€‚</li>
<li>è¿™ä¸ªå‘é‡æ˜¯ <code>[MASK]</code> token åœ¨**å……åˆ†åˆ©ç”¨äº†æ•´ä¸ªåºåˆ—ï¼ˆåŒ…æ‹¬å…¶ä¸Šä¸‹æ–‡ï¼‰**ä¿¡æ¯åæ‰€å½¢æˆçš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥è¡¨ç¤ºã€‚</li>
</ul>
</li>
<li>
<p><strong>è¯­è¨€æ¨¡å‹å¤´ï¼ˆMLM Head / Decoder Headï¼‰ï¼š</strong></p>
<ul>
<li>è¿™ä¸ª <code>(D,)</code> å‘é‡è¢«é€å…¥ä¸€ä¸ªä¸“é—¨ç”¨äºé¢„æµ‹è¢«é®ç›–è¯çš„â€œè¯­è¨€æ¨¡å‹å¤´â€ã€‚è¿™ä¸ªå¤´é€šå¸¸åŒ…å«ï¼š
<ul>
<li><strong>ä¸€ä¸ªçº¿æ€§å±‚ï¼š</strong> å°† <code>(D,)</code> å‘é‡æŠ•å½±åˆ°ä¸€ä¸ªä¸­é—´ç»´åº¦ï¼Œä¾‹å¦‚ <code>(D,) -&gt; (D,)</code>ã€‚è¿™å±‚é€šå¸¸æ˜¯ä¸€ä¸ªéçº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ GELUï¼‰å’Œä¸€ä¸ª Layer Normalizationã€‚</li>
<li><strong>å¦ä¸€ä¸ªçº¿æ€§å±‚ï¼š</strong> å°†ä¸­é—´ç»´åº¦æŠ•å½±åˆ°è¯æ±‡è¡¨å¤§å°çš„ç»´åº¦ï¼š<code>(D,) -&gt; (V,)</code>ã€‚è¿™ä¸ªè¾“å‡ºå°±æ˜¯<strong>é€»è¾‘å€¼ï¼ˆlogitsï¼‰</strong>ã€‚</li>
</ul>
</li>
<li>è¿™ä¸ªçº¿æ€§å±‚çš„æƒé‡çŸ©é˜µç»´åº¦æ˜¯ <code>(D, V)</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>Softmax ä¸é¢„æµ‹ï¼š</strong></p>
<ul>
<li>å¯¹ <code>(V,)</code> ç»´åº¦çš„ logits åº”ç”¨ Softmax æ¿€æ´»å‡½æ•°ã€‚è¿™å°†å¾—åˆ°ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œè¡¨ç¤ºè¯æ±‡è¡¨ä¸­æ¯ä¸ªè¯æ˜¯ <code>[MASK]</code> token çš„æ¦‚ç‡ã€‚</li>
<li><code>P(word | context) = softmax(logits)</code></li>
<li>æ¨¡å‹ä¼šé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯ä½œä¸ºé¢„æµ‹ç»“æœã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä¸¾ä¾‹è¯´æ˜ï¼š</strong></p>
<p>è¾“å…¥ï¼š<code>&quot;The dog [MASK] at the cat.&quot;</code></p>
<ol>
<li>
<p><strong>è¾“å…¥å’ŒåµŒå…¥ï¼š</strong><br>
<code>[CLS] The dog [MASK] at the cat [SEP]</code><br>
å‡è®¾ <code>[MASK]</code> çš„ç´¢å¼•æ˜¯ 3ã€‚<br>
<code>E_CLS</code>, <code>E_The</code>, <code>E_dog</code>, <code>E_MASK</code>, <code>E_at</code>, <code>E_the</code>, <code>E_cat</code>, <code>E_SEP</code> (åˆå§‹åµŒå…¥)</p>
</li>
<li>
<p><strong>é€šè¿‡12å±‚BERT Encoderï¼š</strong><br>
æ¯ä¸ª token çš„è¡¨ç¤ºéƒ½ä¼šé€šè¿‡å¤šå±‚ Transformer Layer è¿›è¡Œæ›´æ–°ã€‚<br>
ä¾‹å¦‚ï¼Œåœ¨ç¬¬ä¸€å±‚ï¼Œ<code>E_MASK</code> å°±å¯ä»¥é€šè¿‡åŒå‘æ³¨æ„åŠ›çœ‹åˆ° <code>E_The</code>, <code>E_dog</code>, <code>E_at</code>, <code>E_the</code>, <code>E_cat</code> ç­‰æ‰€æœ‰å…¶ä»–è¯çš„ä¿¡æ¯ã€‚<br>
ç»è¿‡æ‰€æœ‰å±‚åï¼Œæˆ‘ä»¬å¾—åˆ°æœ€ç»ˆçš„éšè—çŠ¶æ€ <code>H</code>ï¼š<br>
<code>H = [h_CLS, h_The, h_dog, h_MASK, h_at, h_the, h_cat, h_SEP]</code><br>
å…¶ä¸­ <code>h_MASK</code> æ­¤æ—¶æ˜¯ä¸€ä¸ªéå¸¸ä¸°å¯Œçš„å‘é‡ï¼Œå®ƒå·²ç»å¸æ”¶äº† <code>The dog</code> å’Œ <code>at the cat</code> çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><strong>æå– <code>h_MASK</code>ï¼š</strong><br>
æˆ‘ä»¬å–å‡º <code>h_MASK</code>ï¼Œå…¶ç»´åº¦æ˜¯ <code>(D,)</code> (ä¾‹å¦‚ 768)ã€‚</p>
</li>
<li>
<p><strong>è¯­è¨€æ¨¡å‹å¤´ï¼š</strong><br>
<code>h_MASK</code> ç»è¿‡ä¸€ä¸ª <code>(D, D)</code> çš„çº¿æ€§å±‚å’Œä¸€ä¸ª <code>(D, V)</code> çš„çº¿æ€§å±‚ã€‚<br>
<code>logits = h_MASK @ W_linear</code> (è¿™é‡Œçš„ <code>W_linear</code> æ˜¯ä¸¤ä¸ªçº¿æ€§å±‚çš„ç»„åˆæƒé‡ï¼Œæˆ–è€…åˆ†æ­¥è®¡ç®—)<br>
<code>logits</code> çš„ç»´åº¦æ˜¯ <code>(V,)</code> (ä¾‹å¦‚ 50257)ã€‚</p>
</li>
<li>
<p><strong>Softmax é¢„æµ‹ï¼š</strong><br>
<code>softmax(logits)</code> å¾—åˆ°ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒã€‚<br>
åœ¨è¿™ä¸ªæ¦‚ç‡åˆ†å¸ƒä¸­ï¼Œ<code>barked</code>ã€<code>looked</code>ã€<code>ran</code> ç­‰è¯çš„æ¦‚ç‡ä¼šå¾ˆé«˜ï¼Œè€Œ <code>car</code>ã€<code>apple</code> ç­‰è¯çš„æ¦‚ç‡ä¼šå¾ˆä½ã€‚<br>
æ¨¡å‹æœ€ç»ˆé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯ï¼Œä¾‹å¦‚ <code>barked</code>ã€‚</p>
</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆä¸GPTä¸åŒï¼Ÿ</strong></p>
<ul>
<li><strong>BERTçš„ <code>[MASK]</code> ä½ç½®ï¼š</strong> BERTèƒ½å¤Ÿç›´æ¥åœ¨ <code>[MASK]</code> ä½ç½®è¿›è¡Œé¢„æµ‹ï¼Œå› ä¸ºå®ƒçš„æ³¨æ„åŠ›æ˜¯åŒå‘çš„ã€‚å½“å®ƒè®¡ç®— <code>[MASK]</code> çš„è¡¨ç¤ºæ—¶ï¼Œå®ƒèƒ½çœ‹åˆ°æ•´ä¸ªå¥å­çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ <code>[MASK]</code> ä¹‹åçš„è¯ã€‚è¿™æ„å‘³ç€å®ƒèƒ½ä»ä¸¤è¾¹æ¨æ–­å‡º <code>[MASK]</code> åº”è¯¥æ˜¯ä»€ä¹ˆã€‚</li>
<li><strong>GPTçš„ä¸‹ä¸€ä¸ªè¯é¢„æµ‹ï¼š</strong> GPTçš„æ³¨æ„åŠ›æ˜¯å•å‘çš„ã€‚å¦‚æœå®ƒè¦é¢„æµ‹ <code>[MASK]</code>ï¼Œå®ƒå¿…é¡»å‡è£… <code>[MASK]</code> æ˜¯åºåˆ—çš„æœ€åä¸€ä¸ªè¯ï¼Œå¹¶ä¸”ä¸èƒ½çœ‹åˆ° <code>[MASK]</code> ä¹‹åçš„ä»»ä½•è¯ã€‚è¿™ä½¿å¾—å®ƒåœ¨è®­ç»ƒæ—¶æ— æ³•åƒBERTé‚£æ ·å……åˆ†åˆ©ç”¨å·¦å³ä¸Šä¸‹æ–‡æ¥ç†è§£ä¸€ä¸ªè¯çš„å«ä¹‰ã€‚GPTæ“…é•¿çš„æ˜¯ç»™å®šå‰ç¼€ï¼Œè‡ªå›å½’åœ°ç»­å†™ã€‚</li>
</ul>
<p>å› æ­¤ï¼ŒBERTçš„MLMä»»åŠ¡å’ŒåŒå‘æ³¨æ„åŠ›ä½¿å…¶èƒ½å¤Ÿæœ‰æ•ˆåœ°é¢„æµ‹è¢«é®ç›–çš„è¯ï¼Œè¿™æ˜¯å®ƒåœ¨ç†è§£å¥å­å†…éƒ¨å…³ç³»æ–¹é¢è¡¨ç°å‡ºè‰²çš„å…³é”®ã€‚</p>
<br>
<h3 id="æ–‡æœ¬">æ–‡æœ¬</h3>
<h4 id="GPT2">GPT2</h4>
<p><a href="https://cdn.openai.com/better-language-models/language_models_are_unsupervised_multitask_learners.pdf">https://cdn.openai.com/better-language-models/language_models_are_unsupervised_multitask_learners.pdf</a></p>
<blockquote>
<p>å–ç‚¹ï¼šæ›´å¤§çš„æ•°æ®é›†ï¼Œæ›´å¤§çš„æ¨¡å‹ï¼Œzero shot(ä¸€æ¬¡è®­ç»ƒï¼Œå››å¤„ä½¿ç”¨</p>
</blockquote>
<p>å¯¹æ¯”GPT pretrain + fine-tuning</p>
<ul>
<li>
<p>éœ€è¦é’ˆå¯¹ä¸‹æ¸¸ä»»åŠ¡è¿›è¡Œå¾®è°ƒ</p>
</li>
<li>
<p>å¾®è°ƒè®­ç»ƒé›†éœ€è¦äººå·¥å¼•å…¥æ–°ç¬¦å·</p>
</li>
</ul>
<br>
<h4 id="GPT3">GPT3</h4>
<p><a href="https://arxiv.org/abs/2005.14165">https://arxiv.org/abs/2005.14165</a></p>
<blockquote>
<p>å–ç‚¹ï¼šæ— éœ€å¾®è°ƒæ•°æ®é›† + å…‹æœå¾®è°ƒæ³›åŒ–æ€§é—®é¢˜ + å¯è¿ç§»</p>
</blockquote>
<p>GPT3åœ¨æ¨ç†æ—¶ä¸æ›´æ–°æ¢¯åº¦ï¼Œé€šè¿‡promptå®ç°one-shot æˆ– few-shot</p>
<br>
<h4 id="InstructGPT">InstructGPT</h4>
<p>Training a Helpful and Harmless Assistant with Reinforcement Learning from Human Feedback&quot; (InstructGPT, 2022)</p>
<p><a href="https://arxiv.org/abs/2204.05862">https://arxiv.org/abs/2204.05862</a></p>
<br>
<h4 id="LLaMa-1">LLaMa-1</h4>
<p>LLaMA: Open and Efficient Foundation Language Models</p>
<p><a href="https://arxiv.org/abs/2302.13971">https://arxiv.org/abs/2302.13971</a></p>
<br>
<h4 id="LLaMA-2">LLaMA-2</h4>
<p>Llama 2: Open Foundation and Fine-Tuned Chat Models</p>
<p><a href="https://arxiv.org/abs/2307.09288">https://arxiv.org/abs/2307.09288</a></p>
<br>
<h4 id="DeepSeek-V1">DeepSeek-V1</h4>
<p><a href="https://arxiv.org/abs/2401.02954">https://arxiv.org/abs/2401.02954</a></p>
<br>
<h4 id="DeepSeek-V2">DeepSeek-V2</h4>
<p><a href="https://arxiv.org/abs/2405.04434">https://arxiv.org/abs/2405.04434</a></p>
<br>
<h4 id="DeepSeek-V3">DeepSeek-V3</h4>
<p><a href="https://arxiv.org/abs/2412.19437">https://arxiv.org/abs/2412.19437</a></p>
<br>
<h4 id="DeepSeek-R1-Zero-DeepSeek-R1">DeepSeek-R1-Zero&amp;DeepSeek-R1</h4>
<p><a href="https://arxiv.org/abs/2501.12948">https://arxiv.org/abs/2501.12948</a></p>
<br>
<h4 id="Qwen3">Qwen3</h4>
<p><a href="https://github.com/QwenLM/Qwen3/blob/main/Qwen3_Technical_Report.pdf">https://github.com/QwenLM/Qwen3/blob/main/Qwen3_Technical_Report.pdf</a></p>
<p>ä½¿ç”¨æŠ€æœ¯ï¼šGQA SwiGLU RoPE RMSNorm QK-Norm BBPE embedding</p>
<p><strong>æ¦‚è¿°</strong></p>
<p>è®­ç»ƒæ•°æ®é€šè¿‡å¤šæ¨¡å‹è·å–</p>
<ul>
<li>Qwen2.5-VL æå–PDFæ–‡ä»¶å†…å®¹</li>
<li>Qwen2.5-Math ç”Ÿæˆæ•°å­¦å†…å®¹</li>
<li>Qwen2.5-Coder ç”Ÿæˆä»£ç å†…å®¹</li>
</ul>
<p>ä¸‰é˜¶æ®µ pre-training</p>
<ul>
<li>é€šç”¨çŸ¥è¯† train on 30 trillion tokens</li>
<li>STEM&amp;coding çŸ¥è¯†</li>
<li>é•¿ä¸Šä¸‹æ–‡æ•°æ®</li>
</ul>
<p>å¤šé˜¶æ®µ post-training: fisrt two stages</p>
<ul>
<li>CoT cold-start finetuning</li>
<li>RL on math&amp;coding</li>
</ul>
<p>å¤šé˜¶æ®µ post-training: final two stages</p>
<ul>
<li>æ··åˆ reasoning path data finetuning</li>
<li>general-domain RL</li>
</ul>
<br>
<p><strong>æ¶æ„</strong></p>
<p><strong>embedding</strong></p>
<p><strong>layer</strong></p>
<p>begin</p>
<ul>
<li>
<p>è¾“å…¥ -&gt; RMSNorm</p>
</li>
<li>
<p>transformer</p>
<ul>
<li>GQA å¤´ &amp; ç§»é™¤QKV-bias</li>
<li>å¯¹ Qï¼ŒK è¿›è¡ŒRMSNorm</li>
<li>RoPE æ·»åŠ äºnormå Qï¼ŒK</li>
<li>æ³¨æ„åŠ›è®¡ç®—</li>
</ul>
</li>
<li>
<p>æ®‹å·®</p>
</li>
</ul>
<p>end</p>
<p>begin</p>
<ul>
<li>è¾“å…¥ -&gt; RMSNorm</li>
<li>MLP</li>
<li>æ®‹å·®</li>
</ul>
<p>end</p>
<br>
<p><strong>MoE</strong></p>
<ul>
<li>sparse MoEï¼Œæ²¡æœ‰shared MoE</li>
<li>load balancing loss ä¸“å®¶è¢«é€‰çš„è¶Šå¤šæƒ©ç½šé¡¹è¶Šå¤§</li>
</ul>
<br>
<p><strong>pretrain</strong></p>
<br>
<h3 id="CV">CV</h3>
<h4 id="Stable-Diffusion">Stable Diffusion</h4>
<p>2112.10752 High-Resolution Image Synthesis with Latent Diffusion Models (<a href="http://arxiv.org">arxiv.org</a>)</p>
<br>
<h4 id="ViT">ViT</h4>
<p><strong>An Image is Worth 16x16 Words: Transformers for Image Recognition at Scale(ViT)</strong></p>
<p><a href="https://arxiv.org/abs/2010.11929">https://arxiv.org/abs/2010.11929</a></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250530145000198.png" class="" title="image-20250530145000198">
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> ViTå°†å›¾åƒè§†ä¸ºä¸€ç³»åˆ—çš„å›¾åƒå—ï¼ˆpatchesï¼‰ï¼Œç„¶åå°†è¿™äº›å›¾åƒå—çš„çº¿æ€§åµŒå…¥åŠ ä¸Šä½ç½®ç¼–ç ï¼Œé€å…¥æ ‡å‡†çš„Transformer Encoderã€‚</p>
<br>
<p><strong>ViT åœ¨é¢„è®­ç»ƒé˜¶æ®µï¼ˆæˆ–ä½œä¸ºç‰¹å¾æå–å™¨ï¼‰çš„è¾“å‡º</strong></p>
<p>åœ¨å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ï¼ŒViTé€šå¸¸ä¼šæ¨¡ä»¿BERTï¼Œå¼•å…¥ä¸€ä¸ªç‰¹æ®Šçš„**<code>[CLS]</code> token**ï¼ˆåˆ†ç±»æ ‡è®°ï¼‰ã€‚</p>
<ul>
<li>
<p><strong>è¾“å…¥å¤„ç†ï¼š</strong></p>
<ol>
<li>å›¾åƒè¢«åˆ†å‰²æˆå›ºå®šå¤§å°çš„å›¾åƒå—ï¼ˆe.g., 16x16 åƒç´ ï¼‰ã€‚</li>
<li>æ¯ä¸ªå›¾åƒå—è¢«çº¿æ€§æŠ•å½±ï¼ˆembeddingï¼‰æˆä¸€ä¸ªå‘é‡ã€‚</li>
<li>ä¸€ä¸ªå¯å­¦ä¹ çš„ <code>[CLS]</code> token åµŒå…¥ï¼ˆä¸å›¾åƒå—åµŒå…¥ç»´åº¦ç›¸åŒï¼‰è¢«æ·»åŠ åˆ°åºåˆ—çš„<strong>å¼€å¤´</strong>ã€‚</li>
<li>ä½ç½®ç¼–ç è¢«æ·»åŠ åˆ°è¿™äº›åµŒå…¥ä¸­ï¼Œä»¥ä¿ç•™ç©ºé—´ä¿¡æ¯ã€‚</li>
<li>æ‰€æœ‰è¿™äº›åµŒå…¥ï¼ˆ<code>[CLS]</code> tokenåµŒå…¥ + å›¾åƒå—åµŒå…¥ + ä½ç½®ç¼–ç ï¼‰å½¢æˆä¸€ä¸ªåºåˆ—ï¼Œä½œä¸ºTransformer Encoderçš„è¾“å…¥ã€‚</li>
</ol>
</li>
<li>
<p><strong>Transformer Encoder å¤„ç†ï¼š</strong></p>
<ul>
<li>è¿™ä¸ªåºåˆ—ï¼ˆä¾‹å¦‚ <code>[CLS]</code> + 256ä¸ªå›¾åƒå—ï¼Œå¦‚æœå›¾åƒæ˜¯ 224x224 ä¸”å—å¤§å°æ˜¯ 16x16ï¼‰ä¼šé€šè¿‡å¤šä¸ªæ ‡å‡†çš„Transformer Encoderå±‚ã€‚</li>
<li><strong>å…³é”®ç‚¹ï¼š</strong> Transformer Encoderä¸­çš„è‡ªæ³¨æ„åŠ›æ˜¯<strong>åŒå‘çš„</strong>ã€‚è¿™æ„å‘³ç€ <code>[CLS]</code> tokenå¯ä»¥å…³æ³¨åˆ°æ‰€æœ‰å›¾åƒå—çš„ä¿¡æ¯ï¼Œåä¹‹äº¦ç„¶ï¼Œæ‰€æœ‰å›¾åƒå—ä¹Ÿå¯ä»¥å…³æ³¨åˆ°å½¼æ­¤ä»¥åŠ <code>[CLS]</code> tokenã€‚</li>
<li>ç»è¿‡æ‰€æœ‰Encoderå±‚åï¼Œæ¯ä¸ªtokenï¼ˆåŒ…æ‹¬ <code>[CLS]</code> tokenå’Œæ‰€æœ‰å›¾åƒå—ï¼‰éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æœ€ç»ˆéšè—å‘é‡ã€‚</li>
</ul>
</li>
<li>
<p><strong>ViT æœ€ç»ˆè¾“å‡ºçš„å¼ é‡ç»´åº¦ (ä½œä¸ºç‰¹å¾æå–å™¨)ï¼š</strong></p>
<ol>
<li>
<p><strong><code>[CLS]</code> token çš„æœ€ç»ˆéšè—å‘é‡ï¼š</strong></p>
<ul>
<li>è¿™ä¸ªæ˜¯<strong>æœ€å¸¸è¢«ç”¨æ¥è¡¨ç¤ºæ•´ä¸ªå›¾åƒä¿¡æ¯</strong>çš„è¾“å‡ºã€‚</li>
<li>ç»´åº¦ï¼š<code>(batch_size, d_model)</code></li>
<li>ä¾‹å¦‚ï¼šå¦‚æœ <code>batch_size = 3</code>ï¼Œ<code>d_model = 768</code> (ViT-Base)ï¼Œé‚£ä¹ˆè¾“å‡ºæ˜¯ <code>(3, 768)</code>ã€‚</li>
<li>è¿™ä¸ªå‘é‡åŒ…å«äº†æ•´ä¸ªå›¾åƒçš„å…¨å±€ç‰¹å¾ï¼Œå› ä¸ºå®ƒé€šè¿‡åŒå‘æ³¨æ„åŠ›æ•´åˆäº†æ‰€æœ‰å›¾åƒå—çš„ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ‰€æœ‰ token çš„æœ€ç»ˆéšè—å‘é‡åºåˆ—ï¼š</strong></p>
<ul>
<li>å¦‚æœä½ éœ€è¦æ¯ä¸ªå›¾åƒå—çš„ç»†ç²’åº¦ç‰¹å¾ï¼Œæˆ–è€…ç”¨äºå…¶ä»–ä¸‹æ¸¸ä»»åŠ¡ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹ã€è¯­ä¹‰åˆ†å‰²ï¼Œä½†é€šå¸¸éœ€è¦é¢å¤–çš„è§£ç å™¨ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰tokençš„è¾“å‡ºã€‚</li>
<li>ç»´åº¦ï¼š<code>(batch_size, num_tokens, d_model)</code></li>
<li><code>num_tokens</code> = <code>1</code> (for <code>[CLS]</code>) + <code>num_patches</code>ã€‚</li>
<li>ä¾‹å¦‚ï¼šå¦‚æœ <code>batch_size = 3</code>ï¼Œ<code>num_patches = 256</code>ï¼Œ<code>d_model = 768</code>ï¼Œé‚£ä¹ˆè¾“å‡ºæ˜¯ <code>(3, 257, 768)</code>ã€‚</li>
</ul>
</li>
</ol>
</li>
</ul>
<br>
<p><strong>ViT ç”¨äºå›¾åƒåˆ†ç±»ä»»åŠ¡æ—¶çš„æœ€ç»ˆè¾“å‡º</strong></p>
<p>å½“ViTè¢«ç”¨äºå›¾åƒåˆ†ç±»ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šåœ¨ä¸Šè¿° <code>[CLS]</code> token çš„è¾“å‡ºä¹‹ä¸Šï¼Œæ·»åŠ ä¸€ä¸ªåˆ†ç±»å¤´ã€‚</p>
<ul>
<li>
<p><strong>åˆ†ç±»å¤´ï¼š</strong></p>
<ul>
<li>é€šå¸¸æ˜¯ä¸€ä¸ªç®€å•çš„<strong>çº¿æ€§å±‚ï¼ˆLinear Layerï¼‰</strong>ï¼Œå®ƒæ¥æ”¶ <code>[CLS]</code> token çš„æœ€ç»ˆéšè—å‘é‡ <code>(batch_size, d_model)</code> ä½œä¸ºè¾“å…¥ã€‚</li>
<li>çº¿æ€§å±‚å°†è¿™ä¸ªå‘é‡æŠ•å½±åˆ°**ç±»åˆ«æ•°é‡ï¼ˆnum_classesï¼‰**çš„ç»´åº¦ã€‚</li>
<li>çº¿æ€§å±‚çš„æƒé‡çŸ©é˜µç»´åº¦æ˜¯ <code>(d_model, num_classes)</code>ã€‚</li>
<li>è¿›è¡ŒçŸ©é˜µä¹˜æ³•ï¼š<code>(batch_size, d_model) @ (d_model, num_classes) = (batch_size, num_classes)</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>æœ€ç»ˆè¾“å‡ºç»´åº¦ (ç”¨äºåˆ†ç±»ä»»åŠ¡çš„ logits)ï¼š</strong></p>
<ul>
<li><code>(batch_size, num_classes)</code></li>
<li>è¿™äº›æ˜¯æ¯ä¸ªå›¾åƒåœ¨æ‰€æœ‰ç±»åˆ«ä¸Šçš„<strong>é€»è¾‘å€¼ï¼ˆlogitsï¼‰</strong>ã€‚</li>
<li>åœ¨æ¨ç†æ—¶ï¼Œé€šå¸¸ä¼šå†å¯¹è¿™äº› logits åº”ç”¨ Softmax æ¿€æ´»å‡½æ•°ï¼Œä»¥å¾—åˆ°æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li><code>P(class | image) = softmax(logits)</code></li>
<li>ç„¶åé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ç±»åˆ«ä½œä¸ºæœ€ç»ˆçš„åˆ†ç±»ç»“æœã€‚</li>
</ul>
</li>
</ul>
<p><strong>ä¸¾ä¾‹è¯´æ˜ (ViT-Base ç”¨äº ImageNet åˆ†ç±»)ï¼š</strong></p>
<ul>
<li><code>batch_size = 4</code></li>
<li><code>d_model = 768</code></li>
<li><code>num_classes = 1000</code> (ImageNet çš„ç±»åˆ«æ•°)</li>
</ul>
<ol>
<li>
<p><strong>ViT Encoder çš„è¾“å‡º (ç‰¹å¾æå–):</strong></p>
<ul>
<li><code>[CLS]</code> token çš„éšè—å‘é‡: <code>(4, 768)</code></li>
<li>æ‰€æœ‰ token çš„éšè—å‘é‡: <code>(4, 257, 768)</code> (å‡è®¾å›¾åƒå—æ•°é‡æ˜¯ 256)</li>
</ul>
</li>
<li>
<p><strong>åˆ†ç±»ä»»åŠ¡çš„æœ€ç»ˆè¾“å‡º (logits):</strong></p>
<ul>
<li><code>(4, 1000)</code></li>
</ul>
</li>
</ol>
<p>ViTçš„è¾“å‡ºæ˜¯å…¶æ ¸å¿ƒTransformer Encoderå±‚å¤„ç†åçš„<strong>ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ç‰¹å¾è¡¨ç¤º</strong>ã€‚å¯¹äºå›¾åƒåˆ†ç±»ï¼Œæœ€ç›´æ¥çš„è¾“å‡ºé€šå¸¸æ˜¯**<code>[CLS]</code> tokenå¯¹åº”çš„éšè—å‘é‡**ï¼Œå› ä¸ºå®ƒè¢«è®¾è®¡ç”¨æ¥èšåˆæ•´ä¸ªå›¾åƒçš„å…¨å±€ä¿¡æ¯ã€‚è¿™ä¸ª <code>[CLS]</code> tokençš„å‘é‡éšåä¼šç»è¿‡ä¸€ä¸ªçº¿æ€§åˆ†ç±»å¤´ï¼Œæœ€ç»ˆè¾“å‡º<strong>æ¯ä¸ªç±»åˆ«çš„logits</strong>ï¼Œå…¶ç»´åº¦ä¸º <code>(batch_size, num_classes)</code>ã€‚</p>
<br>
<h3 id="å›¾åƒ-æ–‡æœ¬">å›¾åƒ-æ–‡æœ¬</h3>
<h4 id="UNITER">UNITER</h4>
<p><a href="https://arxiv.org/abs/1909.11740">https://arxiv.org/abs/1909.11740</a></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250603133711303.png" class="" title="image-20250603133711303">
<p>four main tasks to pre-train our model:</p>
<ul>
<li>Masked Language Modeling conditioned on image regions (MLM),</li>
<li>Masked Region Modeling conditioned on input text (with three variants) (MRM),</li>
<li>Image-Text Matching (ITM),</li>
<li>Word-Region Alignment (WRA).</li>
</ul>
<p>æ–¹æ³•ï¼š</p>
<ul>
<li>å¯¹äºMLMå’ŒMRMï¼Œrandomly mask some words or regions from the input and learn to recover the words or regions as the output of Transformer. Specifically, word masking is realized by replacing the token with a special token [MASK], and region masking is implemented by replacing the visual feature vector with all zeros. ä»…maskå•æ¨¡æ€ï¼Œè‡ªç›‘ç£å­¦ä¹ </li>
<li>å¯¹äºITMï¼Œsample both positive and negative imagesentence pairs and learn their matching scores. æ¨¡å‹è¾“å‡º true or falseåˆ¤å®šå›¾ç‰‡æ–‡æœ¬æ˜¯å¦åŒ¹é…ï¼ˆç›‘ç£å­¦ä¹ ï¼‰å¹¶è®¡ç®—äº¤å‰ç†µä¼˜åŒ–</li>
<li>å¯¹äºWARï¼Œé€šè¿‡è®­ç»ƒæ¨¡å‹æ—¨åœ¨æœ€å°åŒ– $\sum_{i,j} T_{ij}.c(w_i, v_j)$, where $c(w_i, v_j)$ ä¸ºè¡¡é‡ $w_i$ å’Œ $v_j$ ç›¸å…³æ€§çš„æˆæœ¬å‡½æ•°ï¼ˆæ–‡ä¸­ä¸ºcosine distanceï¼‰
<ul>
<li><strong>Optimal Transport (OT) å’Œä¼ è¾“è®¡åˆ’ T æœ¬èº«ä¸æ˜¯ UNITER æ¨¡å‹çš„å‚æ•°ã€‚</strong></li>
<li>æœ€å°åŒ–çš„$\sum_{i,j} T_{ij}.c(w_i, v_j)$ä¸ºæŸå¤±å‡½æ•°çš„ä¸€éƒ¨åˆ†ï¼›å½“è¯¥å€¼æœ€å°åŒ–æ—¶ï¼Œå½“å‰æ¨¡å‹ä¸­çš„ è¯å‘é‡ å’Œ å›¾å‘é‡çš„å¯¹é½ç¨‹åº¦æœ€é«˜</li>
</ul>
</li>
</ul>
<br>
<h4 id="ViLT">ViLT</h4>
<p><a href="http://proceedings.mlr.press/v139/kim21k/kim21k.pdf">http://proceedings.mlr.press/v139/kim21k/kim21k.pdf</a></p>
<p>å‚è€ƒï¼š<a href="https://www.gnn.club/?p=2910">https://www.gnn.club/?p=2910</a></p>
<p>å¯¹æ¯”å…¶ä»–æ¶æ„</p>
<img src="/2025/04/02/Paper-Reading-Record/20250410155409605.png" class="" title="img">
<p>æ–‡ç« æ¶æ„</p>
<img src="/2025/04/02/Paper-Reading-Record/20250410214653107.png" class="" title="img">
<p>We train ViLT with two objectives commonly used to train VLP models: image text matching (ITM) and masked language modeling (MLM).</p>
<br>
<h4 id="ALBEF">ALBEF</h4>
<p><a href="https://arxiv.org/abs/2107.07651">https://arxiv.org/abs/2107.07651</a></p>
<p>å‚è€ƒï¼š<a href="https://gnn.club/?p=2989">https://gnn.club/?p=2989</a></p>
<img src="/2025/04/02/Paper-Reading-Record/20250421211315671.png" class="" title="img">
<p><strong>è®­ç»ƒ</strong></p>
<ul>
<li>Imageï¼Text Contrastive Lossï¼ŒITC</li>
<li>Imageï¼Text Matching Lossï¼ŒITM</li>
<li>Masked Language Modeling Lossï¼ŒMLM</li>
</ul>
<br>
<h3 id="MoE">MoE</h3>
<h4 id="A-survey-on-MoE">A survey on MoE</h4>
<p><a href="https://arxiv.org/pdf/2407.06204">https://arxiv.org/pdf/2407.06204</a></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250613211803671.png" class="" title="image-20250613211803671">
<br>
<h4 id="Switch-Transformers">Switch Transformers</h4>
<p>Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</p>
<p><a href="https://arxiv.org/abs/2101.03961">https://arxiv.org/abs/2101.03961</a></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250604100042926.png" class="" title="image-20250604100042926">
<br>
<h4 id="MoE-in-DS-v3">MoE in DS-v3</h4>
<p><a href="https://arxiv.org/html/2412.19437v1">https://arxiv.org/html/2412.19437v1</a></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250613211948220.png" class="" title="image-20250613211948220">
<blockquote>
<p>æ··åˆ sparse &amp; dense MoE</p>
</blockquote>
<br>
<h3 id="å¤šæ¨¡æ€">å¤šæ¨¡æ€</h3>
<h4 id="CLIP">CLIP</h4>
<p><a href="https://arxiv.org/abs/2103.00020">https://arxiv.org/abs/2103.00020</a></p>
<p>å‚è€ƒï¼š<a href="https://gnn.club/?p=2921">https://gnn.club/?p=2921</a></p>
<p>ä»…é¢„æµ‹å“ªæ®µæ–‡æœ¬æ•´ä½“ä¸å“ªå¼ å›¾åƒé…å¯¹ï¼Œè€Œæ— éœ€é¢„æµ‹æ–‡æœ¬çš„å…·ä½“è¯æ±‡ã€‚</p>
<p>Given a batch of N (image, text) pairs, CLIP is trained to predict which of the N Ã— N possible (image, text) pairings across a batch actually occurred.</p>
<p>To do this, CLIP learns a multi-modal embedding space by jointly training an image encoder and text encoder to maximize the cosine similarity of the image and text embeddings of the $N$ real pairs in the batch while minimizing the cosine similarity of the embeddings of the $N^2 âˆ’ N$ incorrect pairings. We optimize a symmetric cross entropy loss over these similarity scores.</p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250601135610999.png" class="" title="image-20250601135610999">
<p>æ¨¡å‹ç»“æ„</p>
<p>We consider two different architectures for the image encoder. For the first, we use ResNet-50 (He et al., 2016a) as the base architecture for the image encoder due to its widespread adoption and proven performance. We make several modifications to the original version using the ResNetD improvements from He et al. (2019) and the antialiased rect-2 blur pooling from Zhang (2019). We also replace the global average pooling layer with an attention pooling mechanism. The attention pooling is implemented as a single layer of â€œtransformer-styleâ€ multi-head QKV attention where the query is conditioned on the global average-pooled representation of the image. For the second architecture, we experiment with the recently introduced Vision Transformer (ViT) (Dosovitskiy et al., 2020). We closely follow their implementation with only the minor modification of adding an additional layer normalization to the combined patch and position embeddings before the transformer and use a slightly different initialization scheme.</p>
<p>The text encoder is a Transformer (Vaswani et al., 2017) with the architecture modifications described in Radford et al. (2019). As a base size we use a 63M-parameter 12- layer 512-wide model with 8 attention heads. The transformer operates on a lower-cased byte pair encoding (BPE) representation of the text with a 49,152 vocab size (Sennrich et al., 2015). For computational efficiency, the max sequence length was capped at 76. The text sequence is bracketed with [SOS] and [EOS] tokens and the activations of the highest layer of the transformer at the [EOS] token are treated as the feature representation of the text which is layer normalized and then linearly projected into the multi-modal embedding space. Masked self-attention was used in the text encoder to preserve the ability to initialize with a pre-trained language model or add language modeling as an auxiliary objective, though exploration of this is left as future work.</p>
<br>
<h4 id="Flamingo">Flamingo</h4>
<p>Flamingo: a Visual Language Model for Few-Shot Learning</p>
<p><a href="https://arxiv.org/abs/2204.14198">https://arxiv.org/abs/2204.14198</a></p>
<img src="/2025/04/02/Paper-Reading-Record/image-20250605114032032.png" class="" title="image-20250605114032032">
<img src="/2025/04/02/Paper-Reading-Record/image-20250605114141206.png" class="" title="image-20250605114141206">
<br>
<h4 id="BLIP-2">BLIP-2</h4>
<p>BLIP-2: Bootstrapping Language-Image Pre-training with Frozen Image Encoders and Large Language Models</p>
<p><a href="https://arxiv.org/abs/2301.12597">https://arxiv.org/abs/2301.12597</a></p>
<br>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<br>]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>QuestionBank</title>
    <url>/2025/02/03/QuestionBank/</url>
    <content><![CDATA[<p>å¤ºå‘½è¿ç¯é—®ï¼</p>
<span id="more"></span>
<h1>Java Question Bank</h1>
<blockquote>
<p>ä»¥ä¸‹é—®é¢˜ä¸ºè½¬è½½ï¼Œæä¾›ç­”æ¡ˆä¸ºAIç”Ÿæˆï¼Œä»…ä½œå‚è€ƒå’Œå¯èƒ½æé—®èŒƒå›´å­¦ä¹ </p>
</blockquote>
<p>ref: <a href="https://www.v2ex.com/t/1106872">https://www.v2ex.com/t/1106872</a></p>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>HashSet çš„åº•å±‚å®ç°è¯´ä¸‹ï¼Ÿä¸ºä»€ä¹ˆå†…ç½® HashMap ï¼Ÿè¯´ä¸‹å®ƒçš„æ•°æ®ç»“æ„ï¼Œä¸ºä»€ä¹ˆ loadFactor æ˜¯ 0.75 ï¼Ÿä½ è¯´æ³Šæ¾åˆ†å¸ƒï¼Œä»€ä¹ˆæ˜¯æ³Šæ¾åˆ†å¸ƒï¼Ÿä¸ºä»€ä¹ˆè¦é«˜ä½å‚ä¸ä¸è¿ç®—ï¼Ÿä¸ºä»€ä¹ˆå®ƒçš„ size æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Ÿä¸ºä»€ä¹ˆé»˜è®¤æ˜¯ 16 ï¼Ÿè®²ä¸‹å®ƒçš„æ‰©å®¹æœºåˆ¶ã€‚ä»€ä¹ˆæ—¶å€™è½¬çº¢é»‘æ ‘ï¼Œä¸ºä»€ä¹ˆè¦è½¬çº¢é»‘æ ‘ï¼Ÿä¸ºä»€ä¹ˆå®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå®ƒçš„å“ªäº›æ–¹æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šé€ æˆæ­»å¾ªç¯ï¼Ÿ 1.8 æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Ÿå®ƒçš„çº¿ç¨‹å®‰å…¨çš„å®ç°æœ‰ä»€ä¹ˆï¼Ÿ ConcurrentHashMap å’Œ HashTable æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿè¯´ä¸‹å®ƒ 1.7 å’Œ 1.8 çš„å®ç°æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿä¸ºä»€ä¹ˆè¯´ ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿå®ƒçš„ get æ“ä½œæ˜¯æœ‰é”çš„å—ï¼Ÿå®ƒæ˜¯å¼ºä¸€è‡´æ€§çš„å—ï¼Ÿå®ƒä¸ºä»€ä¹ˆæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼Ÿ ConcurrentHashMap 1.7 å’Œ 1.8 æ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿ sizeCtl å‚æ•°æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œè®²è®²å˜æ¢è¿‡ç¨‹ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨ volatile ä¿®é¥°ï¼Ÿè¯´è¯´å®ƒçš„åŠŸèƒ½ï¼Ÿä»€ä¹ˆæ˜¯ MESI åè®®ï¼Ÿ CPU åŸè¯­æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯å¯è§æ€§ï¼Ÿ JMM è¯´è¯´æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰ JMM ï¼Ÿ Happened-before æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œ synchronized çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿé”çš„å‡çº§ä¸é™çº§è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿè‡ªæ—‹é”æ˜¯ä»€ä¹ˆï¼Ÿåå‘é”æ˜¯ä»€ä¹ˆï¼Ÿ Mark-Word è¯´ä¸‹ï¼Ÿé”çš„ç²’åº¦æ˜¯ä»€ä¹ˆï¼Ÿé”æ¶ˆé™¤äº†è§£å—ï¼Ÿé”ä¼šè¢«åˆå¹¶å—ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿï¼Ÿä½ åˆšæ‰è¯´äº† CAS ï¼Œä½ èƒ½è¯´ä¸‹å®ƒæ˜¯ä»€ä¹ˆä¸œè¥¿å—ï¼Ÿä¸ºä»€ä¹ˆè¦å¼•å…¥ CAS ï¼Ÿ ABA é—®é¢˜æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ AQS äº†è§£å—ï¼Ÿå®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ CLH åˆæ˜¯ä»€ä¹ˆï¼Ÿ ReentrantLock å’Œ synchronized åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ ReetrantLock èƒ½å®ç°å…¬å¹³é”ï¼Ÿé»˜è®¤æ„é€ å™¨æ˜¯å…¬å¹³é”å—ï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯ï¼Ÿ Copy-on-Write äº†è§£å—ï¼Ÿ Fork/Join åˆæ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Œä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿä½ åˆšæ‰è¯´äº†ç®¡ç¨‹ï¼Ÿä½ èƒ½è¯´ä¸‹è¿™å‡ ä¸ªåˆ°åº•æ˜¯åšä»€ä¹ˆçš„å—ï¼Ÿçº¿ç¨‹æ± è¯´ä¸‹å‚æ•°ï¼Œå››ç§å†…ç½®çš„æ‹’ç»ç­–ç•¥ï¼Œä»¥åŠå®ƒçš„æ‰§è¡Œæµç¨‹ã€‚ä½ ç”¨è¿‡å—ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾ç½®å‚æ•°ï¼Ÿ I/O å¯†é›†å‹åº”ç”¨å’Œè®¡ç®—å¯†é›†å‹åº”ç”¨å¦‚ä½•è®¾ç½®å…¶å‚æ•°ï¼Ÿä½ å…·ä½“çš„ä¸šåŠ¡çº¿ç¨‹æ± çš„å‚æ•°æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿæµ‹è¿‡å—ï¼Ÿä½ å®šåˆ¶åŒ–å¼€å‘è¿‡å—ï¼Ÿçº¿ç¨‹æ± é¢„ç•™äº† 3 ä¸ªä¾›å­ç±»æ‰©å±•çš„æ–¹æ³•ä½ çŸ¥é“æ˜¯å“ªä¸‰ä¸ªå—ï¼Ÿèƒ½åšä»€ä¹ˆä½ çŸ¥é“å—ï¼Ÿ ThreadLocal æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä¸ºä»€ä¹ˆä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Ÿä½ å®é™…å¼€å‘ä¸­ç”¨åˆ°è¿‡å—ï¼Ÿ Spring äº‹åŠ¡ç”¨è¿™ä¸ªå¹²ä»€ä¹ˆçš„ï¼Ÿä»€ä¹ˆæ˜¯ Spring äº‹åŠ¡çš„ SavePoint ï¼Ÿä½ çŸ¥é“æ­»é”å—ï¼Ÿå¦‚ä½•è§£å†³æ­»é”ï¼Ÿ sleep å’Œ wait çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ BIO ã€NIO ã€AIO æ˜¯ä»€ä¹ˆï¼Ÿè¯´ä¸‹åŒºåˆ«ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ï¼Ÿäº†è§£ Netty å—ï¼Ÿå¦‚ä½•è§£å†³ç²˜åŒ…é—®é¢˜ï¼Ÿ ChannelPipeline åˆæ˜¯ä»€ä¹ˆï¼Ÿ ByteBuf çŸ¥é“å—ï¼Ÿè¯»å†™æŒ‡é’ˆåˆæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Œè§£å†³äº† NIO ç±»åº“çš„ ByteBuffer ä»€ä¹ˆé—®é¢˜ï¼Ÿå®ƒå’Œ mina çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„ Zero-Copy ï¼Ÿäº†è§£è¿‡ FastThreadLocal å—ï¼Ÿå®ƒä¸ºä»€ä¹ˆæ¯” ThreadLocal å¿«ï¼Ÿæœ‰çœ‹è¿‡å…¶ä¸­æºç å—ï¼Ÿ Netty è§£å†³äº† NIO ç±»åº“çš„ä»€ä¹ˆé—®é¢˜ï¼Ÿç©ºè½®è¯¢åˆæ˜¯ä»€ä¹ˆï¼Ÿ RPC åˆæ˜¯ä»€ä¹ˆï¼Ÿåºåˆ—åŒ–å’Œååºåˆ—åŒ–åˆæ˜¯ä»€ä¹ˆï¼Ÿå‡ ä¸ªæ ¸å¿ƒæŠ½è±¡è¯´ä¸‹ã€‚æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿè®²è®² Netty çš„çº¿ç¨‹æ¨¡å‹ã€‚</p>
<p>ä½ è¯´ä½ äº†è§£è™šæ‹Ÿæœºï¼Œä½ çŸ¥é“è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶æ•°æ®åŒºå—ï¼Ÿå“ªäº›æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œå“ªäº›æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Ÿä½ äº†è§£ JVM è°ƒä¼˜å—ï¼Ÿè°ƒä¼˜è¿‡å—ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾ç½®ï¼Ÿåƒåœ¾å›æ”¶ç®—æ³•æœ‰å‡ ç§ï¼Ÿä¸ºä»€ä¹ˆè¦åˆ†ä»£æ”¶é›†ï¼Ÿ Young åŒºè¯´è¯´å®ƒçš„åˆ†å¸ƒç»“æ„ï¼Œä¸ºä»€ä¹ˆ Eden åŒº 80%ï¼Ÿä¸ºä»€ä¹ˆå¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Ÿæ§åˆ¶çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿä¸€ä¸ªå¯¹è±¡å¦‚æœä¸æ˜¯å¤§å¯¹è±¡ï¼Œæ€æ ·æ‰èƒ½è¿›å…¥è€å¹´ä»£ï¼Ÿæ§åˆ¶çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿ OOM ï¼Ÿä½ é‡åˆ°è¿‡å—ï¼Ÿæ€ä¹ˆè§£å†³çš„ï¼Ÿä¸ºä»€ä¹ˆä½ç‰ˆæœ¬çš„ JDK è¦æŠŠæ°¸ä¹…ä»£å†…å­˜è°ƒå¤§ç‚¹ï¼Ÿé»˜è®¤å¤§å°æ˜¯å¤šå°‘ä½ çŸ¥é“å—ï¼Ÿä»€ä¹ˆæ˜¯ Major GC ï¼Œä»€ä¹ˆæ˜¯ Minor GC ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹ä¼šé¢‘ç¹ GC ï¼Ÿä½ æŸ¥çœ‹è¿‡ GC æ—¥å¿—å—ï¼Ÿä»€ä¹ˆæ—¶å€™å›æ”¶å¯¹è±¡ï¼Ÿå¼•ç”¨è®¡æ•°å’Œå¯è¾¾æ€§åˆ†ææ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ Java ä½¿ç”¨åè€…ï¼Ÿ Python ä½¿ç”¨å‰è€…ï¼Ÿä»€ä¹ˆæ˜¯ GCRoot ï¼Ÿä»€ä¹ˆç±»å‹çš„å¯¹è±¡å¯ä»¥ä½œä¸º GCRoot ï¼Ÿä»€ä¹ˆæ—¶å€™å¯¹è±¡ä¸å¯è¾¾ï¼Ÿ Java çš„å››ç§å¼•ç”¨è¯´ä¸‹ï¼Œåˆ†åˆ«ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ï¼Ÿä½ çŸ¥é“ JDK æºç å“ªé‡Œæœ‰ç”¨åˆ° WeakReference å—ï¼Ÿä»€ä¹ˆæ˜¯ STW ï¼Ÿä»€ä¹ˆæ˜¯ Safepoint ï¼Ÿç±»åŠ è½½çš„è¿‡ç¨‹è¯´ä¸‹ï¼Œä»€ä¹ˆæ—¶å€™ä¼˜åŒ–ï¼Œä»¥åŠä¸åŒçš„é˜¶æ®µçš„ä¸»è¦ä¼˜åŒ–æ˜¯ä»€ä¹ˆï¼Ÿè§£è¯­æ³•ç³–æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿä¸ºä»€ä¹ˆåœ¨ç¼–è¯‘çš„æ—¶å€™è§£è¯­æ³•ç³–ï¼Ÿä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿå¯ä»¥ç ´åå—ï¼Ÿå„ä¸ª ClassLoader åŠ è½½å“ªéƒ¨åˆ†ç±»çš„ï¼Ÿä½ è‡ªå®šä¹‰è¿‡ ClassLoader å—ï¼Ÿä½ è¯´ä½ ç”¨è¿‡ Jstack è¯Šæ–­ CPU ä½¿ç”¨ç‡é£™å‡çš„æƒ…å†µï¼Œè¯´ä¸‹å…·ä½“æ­¥éª¤ï¼Ÿ Arthas ç”¨è¿‡å—ï¼Ÿ Class æ–‡ä»¶æ ¼å¼è¯´ä¸‹ï¼Œä»€ä¹ˆæ˜¯é­”æ•°ï¼ŒClass æ–‡ä»¶çš„é­”æ•°æ˜¯ä»€ä¹ˆï¼Ÿ JMX äº†è§£å—ï¼Ÿç”Ÿäº§ä¸Šæœ‰ç¢°åˆ°è¿‡è™šæ‹Ÿæœºçš„é—®é¢˜å—ï¼Ÿæ€ä¹ˆè§£å†³çš„ï¼Ÿ</p>
<p>ACID è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•å®ç°çš„ï¼Ÿä½ è¯´ä½ ä¼˜åŒ–è¿‡ SQL ï¼Œæ€ä¹ˆä¼˜åŒ–çš„è¯´ä¸‹ã€‚like â€˜%xx%â€™ï¼Œlike â€˜%xxâ€™ï¼Œlike â€˜xx%â€™ å“ªç§æƒ…å†µä¼šç”¨åˆ°ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆï¼Ÿè¯´ä¸‹ MySQL æ‰§è¡Œæµç¨‹ã€‚WAL(Write-Ahead Logging) çŸ¥é“å—ï¼Ÿ redo log å’Œ undo log æ˜¯ä»€ä¹ˆï¼Œå®ƒä»¬ä½œç”¨è¯´ä¸‹ã€‚ä½ è¯´ä½ æ”¹è¿‡ buffer_pool_size ç­‰å‚æ•°ï¼Œä¸ºä»€ä¹ˆè¦æ”¹å®ƒï¼Ÿå®ƒé‡Œé¢çš„æ•°æ®ç»“æ„è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå†·çƒ­ 3:7 ï¼Ÿ join_buffer ä½ è¯´ä½ ä¹Ÿæ”¹äº†ï¼Œä¸ºä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿä½ è¯´ä½ å»ºäº†ç´¢å¼•ï¼Œä»€ä¹ˆæ˜¯è”Ÿé›†ç´¢å¼•ï¼Œä»€ä¹ˆæ˜¯éè”Ÿé›†ç´¢å¼•ï¼Ÿä»€ä¹ˆæ˜¯å›è¡¨ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šç´¢å¼•å¤±æ•ˆï¼Ÿä½ çš„äºŒçº§ç´¢å¼•ä»€ä¹ˆç”¨å¾—å¤šï¼Ÿä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨æ™®é€šç´¢å¼•ï¼Œè€Œä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Ÿ MySQL ä¼šæ­»é”å—ï¼Ÿä»€ä¹ˆæ˜¯é—´éš™é”ï¼Ÿå®ƒä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ MVCC è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿ 4 ç§äº‹åŠ¡è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿå“ªç§æˆ–è€…å“ªå‡ ç§äº‹åŠ¡éš”ç¦»çº§åˆ«èƒ½é¿å…å¹»è¯»ï¼Ÿèƒ½é¿å…è„è¯»ï¼Ÿä½ è¯´ä½ è¿˜å¼€å¯äº† binlog ï¼Œèƒ½è¯´è¯´æ˜¯ä»€ä¹ˆå—ï¼Ÿ binlog æœ‰å‡ ç§æ ¼å¼ï¼Ÿä½ é€‰çš„æ˜¯å“ªä¸ªï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ canal ç”¨è¿‡å—ï¼Ÿè¯´è¯´å®ƒçš„åŸç†ã€‚MySQL ä¸»ä»æ¨¡å¼å¦‚ä½•å¼€å¯ï¼Ÿä½ æ˜¯å¦‚ä½•ä¼˜åŒ– SQL çš„ï¼Ÿä¸Šäº¿çº§åˆ«çš„æ•°æ®ä½ æ˜¯å¦‚ä½•ä¼˜åŒ–åˆ†é¡µçš„ï¼Ÿä¸ºä»€ä¹ˆä¸å»ºè®®åœ¨ MySQL ä¸­ä½¿ç”¨åˆ†åŒºæœºåˆ¶ï¼Ÿå‡ ä¸ªä¸»è¦çš„çº¿ç¨‹è¯´ä¸‹å®ƒä»¬æ˜¯ä»€ä¹ˆï¼Ÿåšä»€ä¹ˆçš„ï¼Ÿ MySQL è¯»å†™äº†è§£å—ï¼Ÿå¦‚ä½•å®ç°çš„ï¼Ÿèƒ½åšåˆ°å¼ºä¸€è‡´æ€§å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆåˆ äº†æ•°æ®è¿˜æ˜¯ç£ç›˜ç©ºé—´ä¸å˜ï¼Ÿè‡ªå¢ä¸»é”®ç”¨å®Œäº†ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿè‡ªå¢ä¸»é”®ä»€ä¹ˆæ—¶å€™æ˜¯ä¸è¿ç»­çš„ï¼Ÿè¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ¨èç”¨è‡ªå¢ä¸»é”®ï¼Ÿ B+ Tree åˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è¿ç§»æ•°æ®åº“ï¼Ÿä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨å¤–é”®ï¼Ÿåœ¨é«˜ç‰ˆæœ¬çš„ MySQL ä¸­ count(1) å’Œ count(*) åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ order by æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿåˆ†é¡µæœºåˆ¶åˆæ˜¯ä»€ä¹ˆï¼Ÿ ACL å’Œ RBAC æ˜¯ä»€ä¹ˆï¼Ÿ PBAC å’Œ ABAC çŸ¥é“å—è¯´ä¸‹ï¼Ÿ grant ä¹‹åä¸€å®šè¦åˆ·æ–°å—ï¼Ÿè§†å›¾ç”¨è¿‡å—ï¼Ÿå®ƒçš„ä½œç”¨è¯´ä¸‹ã€‚è§†å›¾å’Œè¡¨çš„åŒºåˆ«è¯´ä¸‹ã€‚å­˜å‚¨è¿‡ç¨‹å†™è¿‡å—ï¼Ÿå­˜å‚¨å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹çš„åŒºåˆ«è¯´ä¸‹ã€‚ä¸ºä»€ä¹ˆè¦åˆ†åº“åˆ†è¡¨ï¼Ÿåˆ†åº“åˆ†è¡¨å¦‚ä½•åšåˆ°åŠ¨æ€ç¼©å®¹/æ‰©å®¹ï¼Ÿ NoSQL ç”¨è¿‡å—ï¼Ÿ OceanBase äº†è§£å—ï¼Ÿ HBase äº†è§£å—ï¼Ÿ HBase æœ‰å“ªäº›å‘ï¼Œä½ ç¢°åˆ°è¿‡å—ï¼Ÿä»€ä¹ˆæ˜¯ RegionServer ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ NoSQL ï¼Œå®ƒèƒ½å–ä»£ RDBMS å—ï¼Ÿä½ è¯´ä½ ç”¨è¿‡ Elasticsearch ï¼Œèƒ½è¯´ä¸‹å®ƒçš„è¯·æ±‚æ‰§è¡Œè¿‡ç¨‹å—ï¼Ÿå®ƒçš„æ€»ä½“æ¶æ„è¯´ä¸‹ï¼Œç”»ä¸€ä¸‹ã€‚å®ƒçš„æ’ä»¶ä½ ç”¨è¿‡å—ï¼Ÿä½ ä»¬çš„åˆ†è¯ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿå€’æ’ç´¢å¼•è¯´ä¸‹æ˜¯ä»€ä¹ˆã€‚</p>
<p>çº¿ç¨‹å’Œè¿›ç¨‹è¯´ä¸‹åŒºåˆ«ï¼Ÿçº¿ç¨‹çš„å‡ ç§çŠ¶æ€è¯´ä¸‹ã€‚Java ä¸­çš„çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹å…³ç³»ï¼ŸåŠ¨æ€å†…å­˜åˆ†é…å’Œå›æ”¶ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯ç©ºé—²åˆ—è¡¨å’ŒæŒ‡é’ˆç¢°æ’ï¼Ÿå…·ä½“ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å­˜çš„ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨å®ƒä»¬ï¼Ÿç©ºé—²åˆ—è¡¨å››ç§ç­–ç•¥è¯´ä¸‹ã€‚Page Cache çŸ¥é“å—ï¼Œè¯´è¯´å®ƒçš„ä½œç”¨ã€‚Redis å’Œ Kafka ä¸­é—´ä»¶å¦‚ä½•é€šè¿‡ Page Cache æ¥ä¼˜åŒ–ï¼Ÿå“ªäº›ç±»å‹ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ TCP å’Œ HTTP æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬ä¹‹é—´çš„å…³ç³»è¯´ä¸‹ã€‚OSI ä¸ƒå±‚æ˜¯å“ªä¸ƒå±‚ï¼Ÿåˆ†åˆ«æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ TCP å’Œ UDP åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šå¯¼è‡´ TCP æŠ–åŠ¨ï¼Ÿ TCP æ˜¯å¦‚ä½•ä¿è¯ç¨³å®šçš„ï¼Ÿæˆ‘å°±è¦ç”¨ UDP ï¼Œå¦‚ä½•ä½¿å®ƒå’Œ TCP ä¸€æ ·èƒ½ä¿è¯æ•°æ®åˆ°è¾¾ï¼Ÿ CPU æ˜¯å¦‚ä½•æ‰§è¡Œä»»åŠ¡çš„ï¼Ÿä½ çŸ¥é“ numa æ¶æ„å—ï¼Ÿå“ªäº›ä¸­é—´ä»¶å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥æ€ä¹ˆä¼˜åŒ–ï¼Ÿä¸ºä»€ä¹ˆç»‘æ ¸èƒ½ä¼˜åŒ–ï¼Ÿä»€ä¹ˆæ˜¯ Zero-Copy ï¼Ÿä½ ç”¨çš„ä¸­é—´ä»¶ä¸­æœ‰å“ªäº›ç”¨åˆ°äº†è¿™ä¸ªç‰¹æ€§ï¼Ÿå†…æ ¸æ€å’Œç”¨æˆ·æ€æ˜¯ä»€ä¹ˆï¼Ÿç¡¬ä»¶ä½ äº†è§£è¿‡å—ï¼Ÿä»€ä¹ˆæ˜¯ x86 ï¼Ÿä»€ä¹ˆæ˜¯ ARM ï¼Ÿä½ è¯´ç²¾ç®€æŒ‡ä»¤é›†ï¼Ÿå®ƒç²¾ç®€äº†ä»€ä¹ˆï¼Ÿ ARM æ¶æ„çš„ CPU æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿç”»ä¸€ä¸‹ã€‚M1 èŠ¯ç‰‡ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Œæœ‰äº†è§£å—ï¼Ÿ 5G æœ‰äº†è§£å—ï¼Ÿæœ‰ç‚¹é¢˜å¤–è¯äº†ï¼Œæœ€åé—®ä½ ä¸ªé—®é¢˜ï¼Œä½ è¯´ä½ æ˜¯è½¯ä»¶é€šä¿¡å·¥ç¨‹ï¼Œé€šä¿¡å­¦çš„ä»€ä¹ˆï¼Ÿé€‰ä¿®äº†ä»€ä¹ˆï¼Ÿé€šä¿¡æ˜¯å­¦ç¡¬ä»¶å—ï¼Ÿå…‰çº¤ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ 8 æ ¹çº¿å’Œ 4 æ ¹çº¿åŒºåˆ«ï¼Ÿå‚…ç«‹å¶å˜æ¢è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿæ•°å­—ä¿¡å·æ¨¡æ‹Ÿä¿¡å·ï¼Ÿä½ å¤§å­¦åœ¨ç­çº§å®šä½ï¼Ÿå‰å‡ ï¼Ÿ</p>
<p>Redis å®ƒçš„ 5 ç§åŸºç¡€ç±»å‹å’Œ 6 ä¸ªæ•°æ®ç»“æ„è¯´ä¸‹ã€‚HyperLogLog ã€BitMap ã€GEO ã€Stream æœ‰æ¥è§¦è¿‡å—ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨è¿™äº›ç‰¹æ®Šæ•°æ®ç»“æ„ï¼Ÿè·³è¡¨åˆæ˜¯ä»€ä¹ˆï¼Œç”»ä¸€ä¸‹ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨è·³è¡¨ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨çº¢é»‘æ ‘ï¼Ÿå…¨å±€ Hash è¡¨åˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•æ‰©å®¹çš„ï¼Ÿä»€ä¹ˆæ˜¯æ¸è¿›å¼ rehash ï¼Ÿ Redis æ€ä¹ˆåšåˆ°çš„ï¼Ÿ IO å¤šè·¯å¤ç”¨æ˜¯ä»€ä¹ˆï¼Ÿå¤šè·¯æ˜¯ä»€ä¹ˆï¼Ÿå¤ç”¨äº†ä»€ä¹ˆï¼Ÿ AOF å’Œ RDB åˆæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ Redis æ²¡æœ‰å®ç° WAL æœºåˆ¶ï¼Ÿ AOF æŒä¹…åŒ–ç­–ç•¥æœ‰å“ªä¸‰ç§ï¼Ÿä½ ä»¬æ˜¯æ€ä¹ˆé€‰çš„ï¼Ÿ AOF ä»€ä¹ˆæ—¶å€™é‡å†™ï¼Ÿä¸ºä»€ä¹ˆé‡å†™ï¼Ÿä¸»ä»å¤åˆ¶ç”¨åˆ°äº†å“ªç§æ—¥å¿—ï¼Ÿä¸»ä»å¤åˆ¶è¿‡ç¨‹è¯´ä¸‹ã€‚ä¸»ä»å¤åˆ¶ä»€ä¹ˆæ—¶å€™å¢é‡ï¼Œä»€ä¹ˆæ—¶å€™å…¨é‡ï¼Ÿç¬¬ä¸€æ¬¡è¿æ¥æ—¶ï¼Œç½‘ç»œä¸­æ–­äº†æ€ä¹ˆåŠï¼Ÿ Redis ä¸»ä»æ˜¯ä»€ä¹ˆï¼Ÿä¸»ä»ä»åˆæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸»ä»ä»å¯ä»¥å‡å°‘ä¸»åº“å‹åŠ›ï¼Ÿä»åº“å¯ä»¥è®¾ç½®å¯å†™å—ï¼Ÿä»åº“å¯å†™ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸»ä»ä»€ä¹ˆæ—¶å€™ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Ÿ Redis åä¸‡å¹¶å‘èƒ½æ”¯æ’‘ä½å—ï¼Ÿå¦‚ä½•æ”¯æ’‘åä¸‡ä»¥ä¸Šå¹¶å‘ï¼Ÿä¸ºä»€ä¹ˆæ“ä½œå¤§å¯¹è±¡æ”¯æŒä¸äº†åä¸‡å¹¶å‘ï¼Ÿ Redis Cluster æ˜¯ä»€ä¹ˆï¼Ÿ ä½ è¯´åˆ°äº† CRC16 ï¼Œä½ çŸ¥é“ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å—ï¼Œèƒ½è¯´ä¸‹æ˜¯ä»€ä¹ˆå—ï¼Ÿä½ è¯´è™šæ‹ŸèŠ‚ç‚¹ï¼Œè¯´ä¸‹å¦‚ä½•å®ç°ï¼Ÿ Codis äº†è§£å—ï¼Ÿä½ ä»¬çš„ Redis é›†ç¾¤æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ Redis æ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„ï¼Ÿå“¨å…µæœºåˆ¶äº†è§£å—ï¼Ÿä»€ä¹ˆæ˜¯ä¸»è§‚ä¸‹çº¿ä»€ä¹ˆæ˜¯å®¢è§‚ä¸‹çº¿ï¼Ÿé€‰ä¸»çš„å››ä¸ªç­›é€‰æ¡ä»¶ä¼˜å…ˆçº§çš„æ¡ä»¶ä¾æ¬¡é€’å‡åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿæ‰“åˆ†åˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•æ‰“åˆ†ï¼Ÿç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©ã€ç¼“å­˜ç©¿é€è¯´ä¸‹ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿå¸ƒéš†è¿‡æ»¤å™¨åˆæ˜¯ä»€ä¹ˆï¼Ÿèƒ½æ‰‹å†™ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿæ•°æ®å€¾æ–œçŸ¥é“å—ï¼Œå¦‚ä½•è§£å†³ï¼Ÿåˆ†å¸ƒå¼é”äº†è§£è¿‡å—ï¼Ÿè®²è®²åˆ†å¸ƒå¼é”å®ç°åŸç†ï¼Ÿ Redisson æºç çœ‹è¿‡å—ï¼Ÿå®ƒæ˜¯å¦‚ä½•å®ç°çš„åˆ†å¸ƒå¼é”ï¼Ÿ Lua è„šæœ¬ä¿è¯åŸå­æ€§å—ï¼Ÿåˆ†å¸ƒå¼é”éœ€è¦æ³¨æ„å“ªå››ä¸ªé—®é¢˜ï¼Ÿ Redis äº‹åŠ¡è¯´ä¸‹ã€‚ç¼“å­˜æ±¡æŸ“çŸ¥é“æ˜¯ä»€ä¹ˆå—ï¼Ÿå¦‚ä½•æ·˜æ±°æ•°æ®çš„ï¼Ÿåˆ†åˆ«æ˜¯å“ªå…«ç§ç­–ç•¥ï¼Ÿ Redis å¯¹ lru åšäº†ä»€ä¹ˆæ”¹å˜å—ï¼Ÿ lfu åˆæ˜¯ä»€ä¹ˆï¼Ÿ Redis åšäº†ä»€ä¹ˆä¼˜åŒ–ï¼Ÿ Redis å¤šçº¿ç¨‹æ˜¯ä»€ä¹ˆå¤šçº¿ç¨‹ï¼Ÿé»˜è®¤å¼€å¯å—ï¼Ÿä½ ä»¬ç”Ÿäº§ä¸­ç”¨äº†å—ï¼Ÿ Redis 6 è¿˜æœ‰ä»€ä¹ˆæ–°ç‰¹æ€§ï¼Ÿè‡ªå®šä¹‰è¿‡ Redis æ•°æ®ç±»å‹å—ï¼Ÿè‡ªå®šä¹‰è¿‡ Redis å‘½ä»¤å—ï¼Ÿå¦‚ä½•è§£å†³æ•°æ®åº“å’Œç¼“å­˜æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Ÿ Pika çŸ¥é“å—ï¼Ÿ Tendis å’Œå®ƒçš„åŒºåˆ«ï¼Ÿå¦‚ä½•å®ç°ä¸€ä¸ª Key åƒä¸‡å¹¶å‘ï¼Ÿï¼ˆè¿™ä¸ªæœ‰ä¸ªç¾¤çš„ç¾¤å‹çš„ Zoom é¢è¯•é¢˜ï¼‰</p>
<p>æ¶ˆæ¯ä¸­é—´ä»¶è§£å†³äº†å“ªå‡ ä¸ªé—®é¢˜ï¼Ÿç®€å•ä»‹ç»ä¸‹ä½ ç”¨çš„ Kafka ã€‚ä» Topic -&gt; Record&lt;Key,Value&gt; -&gt; Producer -&gt; acks -&gt; Interceptor -&gt; Broker -&gt; Page Cache -&gt; Controller -&gt; Coordinator -&gt; Partition -&gt; Replica -&gt; Leader Replica -&gt; Follower Replica -&gt; ISR -&gt; Unclean Leader Election -&gt; Consumer -&gt; Consumer Group -&gt; Consumer Offset -&gt; Consumer Group Offset -&gt; Idempotence -&gt; Transaction -&gt; Rebalance -&gt; High Watermark -&gt; Log Deletion -&gt; Leader Epoch -&gt; LEO -&gt; Zero Copy -&gt; Consumer Heartbeat -&gt; Zookeeper åˆ°è¿™ç»“æŸã€‚å®ƒå’Œ RocketMQ ã€RabbitMQ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™æ¶ˆæ¯ä¼šä¸¢å¤±ï¼Ÿ Producer ç½‘ç»œæŠ–åŠ¨åï¼Œå®ƒçš„æ¶ˆæ¯åœ¨å“ªå­˜ç€ï¼Œå†…å­˜è¿˜æ˜¯ç£ç›˜è¿˜æ˜¯å“ªé‡Œï¼Ÿ Producer å’Œ Consumer ä»€ä¹ˆæ—¶å€™å»ºç«‹çš„ TCP è¿æ¥ï¼Ÿä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿ Consumer ä¸ºä»€ä¹ˆè¦é‡‡å– pull çš„æ–¹å¼ï¼Ÿ Producer ä¸ºä»€ä¹ˆé‡‡ç”¨ push çš„æ–¹å¼ï¼Ÿä¸ºä»€ä¹ˆç”¨ TCP ä¸ç”¨ HTTP ï¼Ÿé«˜æ°´ä½ã€LEO æ˜¯ä»€ä¹ˆï¼Ÿ Lead Epoch çŸ¥é“å—ï¼Ÿå¹‚ç­‰æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿè¯´ä¸‹ Kafka äº‹åŠ¡ï¼ŒKafka äº‹åŠ¡å®ç°çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™è§¦å‘ Rebalance ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿå¦‚ä½•æŒ‡å®šå‘é€æ¶ˆæ¯åˆ°æŒ‡å®š Partition ï¼Ÿæ¶ˆæ¯äº¤ä»˜å¯é æ€§ä¿éšœæ‰¿è¯ºä¸‰ä¸ªè¯´ä¸‹ï¼Œä»¥åŠ Kafka æ˜¯å¦‚ä½•å®ç°å®ƒä»¬çš„ï¼Ÿå“¦ï¼Œä½ è¯´ç²¾å‡†ä¸€æ¬¡ï¼Œæ€ä¹ˆå®ç°çš„ï¼Ÿæ ¹æ®æ¶ˆæ¯æ•°ä»¥åŠæ¶ˆæ¯å¤§å°ï¼Œè®¡ç®—éœ€è¦å¤šå°‘ç£ç›˜å®¹é‡å’Œå¸¦å®½ã€‚Kafka çš„ JVM å‚æ•°è°ƒä¼˜è¯´ä¸‹ã€‚JMS äº†è§£å—ï¼Ÿ</p>
<p>Spring Bean Scope è¯´ä¸‹ã€‚Spring çš„æ³¨å…¥æ–¹å¼æœ‰å‡ ç§ï¼Œä¸ºä»€ä¹ˆæ¨èç”¨æ„é€ å™¨æ³¨å…¥ï¼Ÿ@Resource å’Œ @<a href="https://www.v2ex.com/member/Autowired">Autowired</a> åŒºåˆ«è¯´ä¸‹ã€‚ä»€ä¹ˆæ˜¯ IoC å’Œ AOP ï¼Ÿ Spring è§£å†³äº†ä»€ä¹ˆï¼Ÿ@Bean å’Œ @<a href="https://www.v2ex.com/member/Component">Component</a> åŒºåˆ«è¯´ä¸‹ã€‚Spring Bean çš„ç”Ÿå‘½å‘¨æœŸè¯´ä¸‹ã€‚Spring AOP åŸç†ï¼Œå„ç§ Advice å’Œ Advisor è¯´ä¸‹ã€‚AOP çš„ä¸¤ç§ä»£ç†æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿ AOP ä¸€èˆ¬ä½œç”¨è¯´ä¸‹ã€‚ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–çš„è¿‡ç¨‹è¯´ä¸‹ã€‚Spring çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºè¯´ä¸‹ã€‚Spring äº‹åŠ¡éš”ç¦»çº§åˆ«è¯´ä¸‹ã€‚Spring äº‹åŠ¡å®ç°åŸç†ã€‚Spring ç”¨åˆ°äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Œèƒ½åˆ†åˆ«è®²è®²å®ƒæ˜¯å¦‚ä½•å®ç°çš„å—ï¼Œå…·ä½“æ˜¯å“ªäº›ç±»ï¼Ÿ BeanFactory å’Œ ApplicationContext è¯´ä¸‹åŒºåˆ«ã€‚è¯´ä¸‹ BeanFactory å’Œ FactoryBean åŒºåˆ«ï¼Ÿ BeanPostProcessor å’Œ BeanFactoryPostProcessor åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ Spring äº‹ä»¶çŸ¥é“å—ï¼Ÿ Spring å¦‚ä½•è‡ªå®šä¹‰ XML è§£æï¼Ÿå„ç§ Smart å¼€å¤´çš„ Bean çš„å‰ç½®å¤„ç†å™¨ï¼Œä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Œä½ çŸ¥é“å—ï¼Ÿ Spring Cache æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ Spring Data JPA å‘¢ï¼Ÿ æ³¨è§£æ‰«æå¦‚ä½•å®ç°çš„ï¼Œä½ èƒ½æ‰‹å†™ä¸ªå—ï¼Ÿå†™è¿‡ Spring çš„æ’ä»¶å—ï¼Ÿå¦‚ä½•å®ç°çš„ï¼Ÿä»£ç å¼€æºäº†å—ï¼Ÿ</p>
<p>Spring MVC æ‰§è¡Œæµç¨‹è¯´ä¸‹ã€‚ @<a href="https://www.v2ex.com/member/RestController">RestController</a> å’Œ @<a href="https://www.v2ex.com/member/Controller">Controller</a> åŒºåˆ«è¯´ä¸‹ã€‚æ€ä¹ˆå–å¾— URL ä¸­çš„ { } é‡Œé¢çš„å˜é‡ï¼Ÿ Spring MVC å’Œ Struts2 æ¯”æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ Spring MVC æ€ä¹ˆæ ·è®¾å®šé‡å®šå‘å’Œè½¬å‘çš„ï¼Ÿè¯´ä¸‹ Spring MVC çš„å¸¸ç”¨æ³¨è§£ã€‚å¦‚ä½•è§£å†³ POST è¯·æ±‚ä¸­æ–‡ä¹±ç é—®é¢˜ï¼ŒGET çš„åˆå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ Interceptor å’Œ Filter åŒºåˆ«ï¼Ÿ Spring MVC çš„å¼‚å¸¸å¤„ç† ï¼Ÿæ€æ ·åœ¨æ–¹æ³•é‡Œé¢å¾—åˆ° Request ï¼Œæˆ–è€… Session ï¼Ÿ Spring MVC ä¸­å‡½æ•°çš„è¿”å›å€¼æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆæ ·æŠŠ ModelMap é‡Œé¢çš„æ•°æ®æ”¾å…¥ Session é‡Œé¢ï¼Ÿ Spring MVC çš„æ§åˆ¶å™¨æ˜¯ä¸æ˜¯å•ä¾‹æ¨¡å¼,å¦‚æœæ˜¯,æœ‰ä»€ä¹ˆé—®é¢˜,æ€ä¹ˆè§£å†³ï¼Ÿ Spring MVC çš„ RequestMapping çš„æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿä»‹ç»ä¸‹ WebApplicationContext ã€‚è·¨åŸŸé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿå¦‚ä½•è§£å†³å…¨å±€å¼‚å¸¸ï¼Ÿ validation æœ‰äº†è§£å—ï¼Ÿç”¨è¿‡å—ï¼Ÿ Json å¤„ç†å¦‚ä½•å®ç°çš„ï¼Ÿå“¦ï¼Œä½ åˆšæ‰è¯´äº†çˆ¶å­å®¹å™¨ï¼Œèƒ½è®²è®²ä»€ä¹ˆæ˜¯çˆ¶å­å®¹å™¨å—ï¼Ÿ Spring MVC å›½é™…åŒ–æœ‰äº†è§£è¿‡å—ï¼Ÿæ€ä¹ˆå®ç°çš„</p>
<p>Spring Boot æ˜¯å¦‚ä½•å®ç°è‡ªåŠ¨è£…é…çš„ï¼Ÿè¿è¡Œ Spring Boot æœ‰å‡ ç§æ–¹å¼ï¼Ÿ Spring Boot Starter å·¥ä½œåŸç†ã€‚Spring Boot æ ¸å¿ƒæ³¨è§£è¯´ä¸‹ã€‚ @<a href="https://www.v2ex.com/member/Enable">Enable</a> ç±»å‹æ³¨è§£æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ@Conditional ç±»å‹æ³¨è§£å‘¢ï¼Ÿè‡ªå®šä¹‰è¿‡å—ï¼Ÿè¯´ä¸‹å¼‚æ­¥è°ƒç”¨ @<a href="https://www.v2ex.com/member/Async">Async</a> ã€‚ä»€ä¹ˆæ˜¯ YAML ï¼Ÿ Spring Boot Profiles å¦‚ä½•å®ç°çš„ï¼Ÿ bootstrap.properties å’Œ application.properties è¯´ä¸‹åŒºåˆ«ã€‚Spring Boot äº‹ä»¶å’Œ Spring äº‹ä»¶æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ Spring Boot Actuator äº†è§£è¿‡å—ï¼Ÿè¯´ä¸€ä¸‹ã€‚Spring Batcher ç”¨è¿‡å—ï¼Œè¯´ä¸‹ã€‚Spring Boot æ˜¯å¦‚ä½•å®ç°å†…åµŒ Servlet å®¹å™¨çš„ï¼Œåœ¨å“ªè¡Œä»£ç å¯åŠ¨çš„ï¼Ÿ Spring Boot å®Œç¾å®ç°äº†æ¨¡å—åŒ–ç¼–ç¨‹ï¼Œä½ è®¤åŒå—ï¼Ÿ</p>
<p>Spring Cloud Netflix å¬è¯´ä½ äº†è§£ã€‚ç”»ä¸€ä¸‹ Spring Cloud Netflix æ¶æ„å›¾ã€‚è¯´è¯´ Eureka é»˜è®¤å¤šå°‘ç§’å‘é€å¿ƒè·³ï¼Ÿå¢é‡è¿˜æ˜¯å…¨é‡ï¼Ÿ CP è¿˜æ˜¯ AP ï¼Ÿå¦‚ä½•é˜²æ­¢è„‘è£‚çš„ï¼ŸäºŒçº§ç¼“å­˜çŸ¥é“å—ï¼Ÿ Eureaka çš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼è¯´ä¸‹ã€‚ServiceInstance å’Œ DiscoryClient çŸ¥é“å—ï¼Ÿæ˜¯å¹²å˜›çš„ï¼Ÿåˆ†å¸ƒå¼äº‹åŠ¡é™¤äº†ä¸¤æ®µæäº¤ï¼Œè¿˜æœ‰ä»€ä¹ˆå®ç°æ–¹å¼ï¼Ÿå“¦ï¼Œä½ è¯´ Saga ï¼ŒSaga ä½ è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿ Ribbon æ˜¯ä»€ä¹ˆè¯´ä¸€ä¸‹ï¼Œå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ Feign åˆæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œ Ribbon ä»€ä¹ˆå…³ç³»ï¼Ÿ Dubbo å’Œ Feign åŒºåˆ«ï¼Ÿ Dubbo çš„ SPI çŸ¥é“å—ï¼Ÿ Zuul æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œ Nginx æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿé™¤äº† Zuul è¿˜æœ‰ä»€ä¹ˆç½‘å…³å¯é€‰ï¼Ÿ Hystrix æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿç†”æ–­ã€é™çº§å’Œé™æµä»–ä»¬çš„åŒºåˆ«è¯´ä¸€ä¸‹ã€‚Hystrix ä¿¡å·é‡æœºåˆ¶ï¼Œéš”ç¦»ç­–ç•¥ç»†ç²’åº¦æ§åˆ¶å¦‚ä½•åšçš„ï¼Ÿäº†è§£è¿‡ä»–ä»¬çš„æºç å®ç°å—ï¼Ÿçœ‹è¿‡æºç å—ï¼Ÿä½ ä¼˜åŒ–è¿‡å—ï¼Ÿå¾®æœåŠ¡åä¸€ç‚¹è¯´ä¸€ä¸‹åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒæœ‰å“ªäº›ï¼Ÿä½ ä»¬ç”¨çš„ Apollo è¿˜æ˜¯ Spring Config è¿˜æ˜¯å…¶ä»–çš„ï¼Ÿä¸ºä»€ä¹ˆï¼ŸæœåŠ¡ç›‘æ§æœ‰äº†è§£å—ï¼Ÿä»€ä¹ˆæ˜¯å¹‚ç­‰ï¼Ÿå¦‚ä½•å®ç°æ¥å£å¹‚ç­‰ï¼Ÿå¦‚ä½•å®ç°åˆ†å¸ƒå¼ Session ï¼Ÿæœ‰æ›´å¥½çš„æ–¹æ³•å—ï¼Ÿå“¦ï¼Œä½ è¯´äº† JWT ï¼Œèƒ½è¯¦ç»†è¯´ä¸‹å—ï¼Ÿä¸åŒç³»ç»Ÿçš„é—´æˆæƒçš„ OAuth2 äº†è§£å—ï¼Ÿ</p>
<p>MyBatis äº†è§£å—ï¼Ÿä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ï¼Ÿ# å’Œ $ è¯´ä¸‹ã€‚å¦‚ä½•å®ç°çš„åŠ¨æ€ SQL ï¼Ÿ ORM æ˜¯ä»€ä¹ˆï¼Ÿå’Œ Hibernate åŒºåˆ«ï¼Ÿ MyBatis å·¥ä½œåŸç†ï¼Ÿ MyBatis éƒ½æœ‰å“ªäº› Executor æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ MyBatis ä¸­å¦‚ä½•æŒ‡å®šä½¿ç”¨å“ªä¸€ç§ Executor æ‰§è¡Œå™¨ï¼Ÿæ¨¡ç³ŠæŸ¥è¯¢ like è¯­å¥è¯¥æ€ä¹ˆå†™ï¼Ÿ MyBatis æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ MyBatis å¦‚ä½•æ‰§è¡Œæ‰¹é‡æ“ä½œï¼Ÿ SqlSessionFactoryBean æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•å®ç°å’Œ Spring çš„æ•´åˆçš„ï¼Ÿ Mapper æ–¹æ³•å¯ä»¥é‡è½½å—ï¼Ÿä¸ºä»€ä¹ˆä¸å¯ä»¥ï¼Ÿ MyBatis æ˜¯å¦‚ä½•å°† SQL æ‰§è¡Œç»“æœå°è£…ä¸ºç›®æ ‡å¯¹è±¡å¹¶è¿”å›çš„ï¼Ÿéƒ½æœ‰å“ªäº›æ˜ å°„å½¢å¼ï¼Ÿå“¦ï¼Œä½ è¯´ç®€å•å°è£…äº† JDBC ï¼Œè¯´ä¸‹ JDBC å‡ ä¸ªé‡è¦çš„ç±»ã€‚ä¸ºä»€ä¹ˆè¦é¢„ç¼–è¯‘ï¼Ÿæœ‰ä»€ä¹ˆå¥½å¤„å—ï¼Ÿ</p>
<p>Nginx äº†è§£å—ï¼Œè¯´ä¸‹å…¶ä¼˜ç¼ºç‚¹ï¼Ÿæ€ä¹ˆå®ç° Nginx é›†ç¾¤ï¼Ÿä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼Ÿå’Œæ­£å‘ä»£ç†åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ Tomcat å’Œ Nginx åŒºåˆ«ï¼Ÿé™æµæ€ä¹ˆåšçš„ï¼Œæœ‰å“ªä¸‰ç§ï¼Ÿä»¤ç‰Œæ¡¶å’Œæ¼æ–—ç®—æ³•æ˜¯ä»€ä¹ˆï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•åœ¨å…¶ä¹‹ä¸Šä½¿ç”¨ Lua è„šæœ¬ï¼Ÿæœ‰å‡ ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Ÿä½ ä»¬ç”Ÿäº§ä¸Šç”¨çš„å“ªä¸ªï¼Ÿä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ Nginx æ€§èƒ½è¿™ä¹ˆé«˜ï¼Ÿæœ‰æ²¡æœ‰æ›´é«˜çš„ï¼Ÿ F5 åˆæ˜¯ä»€ä¹ˆï¼Ÿ Nginx æ˜¯æ€ä¹ˆå¤„ç†è¯·æ±‚çš„ï¼Ÿ Nginx ç›®å½•æœ‰å“ªäº›ï¼Ÿ nginx.conf é…ç½®è¿‡å—ï¼Ÿæœ‰å“ªäº›å±æ€§æ¨¡å—ï¼Ÿé™æ€èµ„æºæ”¾å“ªï¼Ÿè™šæ‹Ÿä¸»æœºé…ç½®ï¼Ÿ location è¯´ä¸‹ã€‚location è¯­æ³•è¯´ä¸‹ã€‚</p>
<p>Tomcat ä½ ä¹Ÿäº†è§£ï¼Ÿä»€ä¹ˆæ˜¯ Tomcat çš„ Connector ï¼Ÿ Service ã€Connector ã€Container ä»‹ç»ä¸‹å®ƒä»¬ã€‚è¯¦ç»†è¯´ä¸‹å®ƒä»¬æ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚çš„ï¼Œèƒ½ç”»ä¸‹å®ƒä»¬çš„æ¶æ„å›¾å—ï¼Ÿå¦‚ä½•éƒ¨ç½²çš„ï¼Ÿä¸€å®šè¦æ”¾åˆ° webapps ç›®å½•ä¸‹å—ï¼Ÿåœ¨å“ªé…ç½®ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨ Jetty ï¼ŸåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ Servlet æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿæ€æ ·è®©å®ƒçº¿ç¨‹å®‰å…¨ï¼Ÿ Servlet åˆå§‹åŒ–è¿‡ç¨‹ï¼Ÿ init æ–¹æ³•ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Ÿ Servlet ä»€ä¹ˆæ—¶å€™ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Ÿ JSP çŸ¥é“å—ï¼Ÿæœ‰å‡ ä¸ªå†…ç½®å¯¹è±¡ï¼Ÿä½ è¯´ JSP æ˜¯ç‰¹æ®Šçš„ Servlet ï¼Œä½ çœ‹è¿‡æºç å—ï¼Ÿ JSP å¦‚ä½•çƒ­éƒ¨ç½²çš„ï¼Ÿ EL è¡¨è¾¾å¼çŸ¥é“å—ï¼Ÿå¦‚ä½•å®ç°çš„ï¼Ÿï¼ˆå¤§å››ç¥å·é›†å›¢æ ¡æ‹›çš„æ—¶å€™è¢«é—®åˆ°çš„ï¼‰ã€‚</p>
<p>äº‘åŸç”Ÿäº†è§£å—ï¼Ÿäº‘åŸç”ŸåäºŒè¦ç´ è¯´ä¸‹ã€‚Cloud Foundry å¹³å°ä½ çŸ¥é“å—ï¼Ÿ HeroKu ï¼Ÿ Kong ï¼Ÿ</p>
<p>å“¦ï¼Ÿä½ è¯´æ˜¯å…­è¾¹å½¢æ¶æ„ï¼Ÿä½ è¯´ä¸‹ä»€ä¹ˆæ˜¯å…­è¾¹å½¢æ¶æ„ï¼Ÿæ•´æ´æ¶æ„å‘¢ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ï¼Ÿåˆ†å±‚æ¶æ„äº†è§£å—ï¼Ÿ MVP ã€MVC æ¶æ„è¯´ä¸‹ã€‚è´Ÿè½½å‡è¡¡ç®—æ³•ä¸ƒç§è¯´ä¸‹ã€‚å¦‚ä½•å®ç°ä¸€ä¸ªç§’æ€ç³»ç»Ÿã€‚ä¸€å®šä¸ä¼šè¶…å–å—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿä»€ä¹ˆæ˜¯ SOA ï¼Ÿä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Ÿä»¥åŠä¸¤è€…çš„åŒºåˆ«ã€‚ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Ÿ CAP å’Œ BASE è¯´ä¸‹æ˜¯ä»€ä¹ˆï¼Ÿæœ€ç»ˆä¸€è‡´æ€§å’Œäººå¼±ä¸€è‡´æ€§ä»€ä¹ˆå…³ç³»ï¼Ÿç”»ä¸€ä¸‹ä½ ä»¬ç³»ç»Ÿçš„æ•´ä½“æ¶æ„å›¾ã€‚QPS å’Œ TPS ï¼Ÿä½ ä»¬çš„ QPS æ˜¯å¤šå°‘çŸ¥é“å—ï¼Ÿå‹æµ‹è¿‡å—ï¼Ÿè¯´ä¸‹ç‚¹å‡»ç½‘é¡µçš„è¯·æ±‚è¿‡ç¨‹ã€‚å“¦ï¼Œä½ è¯´ä½ æ˜¯è“ç»¿éƒ¨ç½²ï¼Œä»€ä¹ˆæ˜¯è“ç»¿éƒ¨ç½²ï¼Ÿä»€ä¹ˆæ˜¯é‡‘ä¸é›€å‘å¸ƒï¼Ÿå¦‚ä½•å®ç°ï¼Ÿ</p>
<p>Docker ä½ ä¹Ÿç”¨ï¼Ÿæ€ä¹ˆæ„å»º Docker é•œåƒï¼Ÿ Docker å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«ï¼Ÿ Docker å¥½å¤„è¯´ä¸‹ï¼Ÿ Kubernetes ä½ ä¹ŸçŸ¥é“ï¼Œè¯´ä¸‹å®ƒçš„ç»„æˆç»“æ„ï¼Ÿ etcd æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨ Zookeeper ï¼Ÿ pod åˆæ˜¯ä»€ä¹ˆï¼Ÿä½ ä»¬ç”Ÿäº§ä¸Šæ€ä¹ˆç”¨çš„ï¼Ÿå¦‚ä½•æ§åˆ¶æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ï¼Ÿ</p>
<p>ä½ è¯´ä½ çŸ¥é“ DDD ï¼Ÿèƒ½ç®€å•è¯´ä¸‹å—ï¼Ÿä½ ä»¬ä»£ç è½åœ°äº†å—ï¼Ÿæ˜¯å¦‚ä½•æ‹†åˆ†æœåŠ¡çš„ï¼Ÿäº‹ä»¶é£æš´åˆæ˜¯ä»€ä¹ˆï¼Ÿä½ ä»¬æœ‰ Code Review å—ï¼Ÿå…·ä½“è§„çŸ©ï¼Ÿé¢†åŸŸäº‹ä»¶æ˜¯ä»€ä¹ˆï¼Ÿå­åŸŸã€é€šç”¨åŸŸã€æ ¸å¿ƒåŸŸã€æ”¯æ’‘åŸŸã€é™ç•Œä¸Šä¸‹æ–‡ã€èšåˆã€èšåˆæ ¹ã€å®ä½“ã€å€¼å¯¹è±¡åˆæ˜¯ä»€ä¹ˆï¼Ÿä½ ä»¬æœ‰ EventBus å—ï¼Ÿå¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ</p>
<h2 id="åˆ·é¢˜">åˆ·é¢˜</h2>
<p>ç®—æ³•ï¼šä»£ç éšæƒ³å½•ã€LCR75ã€LChot100ã€é¢è¯•é¢˜150é¢˜ å°±ç…§ç€ä¸Šé¢é¡ºåºåˆ·ä¸‹å»å°±å¥½äº†ï¼Œä¿æŒæ‰‹æ„Ÿï¼Œåšå¥½ç¬”è®°ã€‚</p>
<p>å‰‘æŒ‡ offer <a href="https://www.nowcoder.com/exam/oj/ta?page=1&amp;tpId=13&amp;type=13">https://www.nowcoder.com/exam/oj/ta?page=1&amp;tpId=13&amp;type=13</a></p>
<p>leetcode hot 100 <a href="https://leetcode.cn/studyplan/top-100-liked/">https://leetcode.cn/studyplan/top-100-liked/</a></p>
<p>ç»™äºŒå‰æ ‘ååºå’Œä¸­åºéå†ï¼Œå†™å‰åºéå†ã€‚æ‰‹å†™ä¸ªå¿«æ’ã€‚ç¿»è½¬ä¸€ä¸‹é“¾è¡¨ã€‚O(1) ç©ºé—´å¤æ‚åº¦æ‰¾å‡ºé“¾è¡¨æœ‰ç¯ã€‚DFS æ‰¾å‡ºäºŒå‰æ ‘æœç´¢æ ‘ç¬¬ k å¤§èŠ‚ç‚¹ï¼ˆè¿™äº›éƒ½çœŸçš„ç¢°è¿‡äº†ï¼‰ã€‚</p>
<p>å®ç°ä¸€ä¸ªå¤šçº¿ç¨‹ç±»ï¼Œå¹¶ç”¨è¯¥çº¿ç¨‹ç±»å®ä¾‹åŒ– 3 ä¸ªçº¿ç¨‹ A,B,C ï¼› A çº¿ç¨‹æ‰“å°å­—ç¬¦ A,B çº¿ç¨‹æ‰“å°å­—ç¬¦ B ï¼ŒC çº¿ç¨‹æ‰“å°å­—ç¬¦ C ï¼›å¯åŠ¨è¿™ 3 ä¸ªçº¿ç¨‹ï¼Œè¦æ±‚å¯åŠ¨çº¿ç¨‹çš„é¡ºåºä¸º C çº¿ç¨‹-&gt;B çº¿ç¨‹-&gt;A çº¿ç¨‹ï¼Œå¹¶ä¸”æœ€åè¾“å‡ºå†…å®¹ä¸ºï¼šA B C ã€‚ç¦æ­¢ä½¿ç”¨ sleep å‡½æ•°ã€‚é˜¿é‡Œåº”è¯¥è¿˜æœ‰å„ç§å¤šçº¿ç¨‹æ‰“å°çš„é—®é¢˜ï¼Œè¿™ä¸ªå¾—å‡†å¤‡ã€‚è¿™äº›åªæ˜¯æœ€æœ€æœ€åŸºç¡€çš„å†…å®¹ã€‚</p>
<p>æ¥ä¸‹æ¥åº”è¯¥æ˜¯æ›´é«˜çº§çš„ç®—æ³•é¢˜ç›®ï¼Œè‡³å°‘æ˜¯ LeetCode Menium éš¾åº¦çš„ï¼Œç¿»è½¬é“¾è¡¨ç¡®å®æœ‰ç‚¹åˆçº§ï¼Œç»ƒä¸ªåŠä¸ªå°æ—¶å°±æå®šäº†ã€‚æš‚æ—¶è¿˜æ²¡ç¢°åˆ°ï¼Œç¢°åˆ°æˆ‘ä¹ŸæŒ‚äº†ã€‚åº”è¯¥æ˜¯åŠ¨æ€è§„åˆ’ï¼Œæ»‘åŠ¨çª—å£ï¼Œå­—ç¬¦ä¸²çš„é—®é¢˜ï¼Œæ‰‹å†™ O(1) æ—¶é—´å¤æ‚åº¦çš„ LRU ï¼Œå›æº¯ï¼Œè´ªå¿ƒã€‚</p>
<p>å¤–æ’åºï¼ˆç£ç›˜æ’åºï¼‰</p>
<p>java å¤šçº¿ç¨‹æ±‚10000ä»¥å†…è´¨æ•°</p>
<p>thread - runnable - Callable&lt;T&gt;+Future+threadpool.submit(lambda)</p>
<h2 id="æ‚">æ‚</h2>
<p>JavaåŸºç¡€ï¼šéŸ©é¡ºå¹³</p>
<p>Redisçœ‹é»‘é©¬ï¼Œåšäº†é»‘é©¬ç‚¹è¯„</p>
<p>JUCã€JVMçœ‹ç¨€åœŸçš„ç«¹å­çˆ±ç†ŠçŒ«</p>
<p>Springå¯ä»¥çœ‹çœ‹å»–é›ªå³°ã€é»‘é©¬ã€‚</p>
<p>è®¡ç½‘ã€æ“ä½œç³»ç»Ÿã€MySQLï¼šå°æ—coding</p>
<p>å…¶ä»–æ¨èï¼šæå®¢æ—¶é—´çš„MySQL45è®²ã€ã€Šå¯¹çº¿é¢è¯•å®˜ã€‹ã€é»‘é©¬23å¹´é¢ç»</p>
<p>å¾®ä¿¡æœ‹å‹åœˆç³»ç»Ÿè®¾è®¡ï¼ˆfeedæµç³»ç»Ÿï¼‰</p>
<p>ç»™ä¸€ä¸ªç”Ÿæˆ65536å†…éšæœºæ•°çš„å‡½æ•°å¯¹20wè…¾è®¯å‘˜å·¥å…¬å¹³æŠ½å¥–ï¼ˆkè¿›åˆ¶ï¼‰</p>
<p>ç”¨udpå®ç°tcpï¼ˆhttp3ï¼‰</p>
<p>å®ç°atoiåŸå‹</p>
<p>ä½å›¾æ¡¶æ’åº</p>
<p>mysqlè”åˆç´¢å¼•å®ç°åŸç†å’Œåœºæ™¯åˆ†æï¼ˆå‹åŠ›ï¼Œé—®çš„å¾ˆæ€ªï¼Œéœ€è¦æ ¹æ®åŸç†å»å¦å®šä¸€äº›ç¦»è°±çš„è¦æ±‚ï¼‰</p>
<p>æ™ºåŠ›é¢˜30ï¼å’Œint64è°æ›´å¤§</p>
<p>æ™ºåŠ›é¢˜ å€’æ°´10 7 3 ä»10 0 0å€’å‡º5 5 0</p>
<p>sleepèƒ½ä¸èƒ½å®ç°å‡†ç¡®çš„å¾®ç§’çº§åˆ«çš„ç¡çœ æ—¶é—´ï¼ˆå¾ˆæ€ªï¼Œæ‰¯äº†æ‰¯çº¿ç¨‹åˆ‡æ¢å’Œçº¿ç¨‹çŠ¶æ€å°±ä¸è¿½é—®äº†ï¼Œè½¬é—®æ“ä½œç³»ç»Ÿç»†èŠ‚ï¼‰</p>
<p>å…«è‚¡ï¼šé»‘é©¬ç¨‹åºå‘˜+å¤§è¯é¢è¯•+ç«¹å­çˆ±ç†ŠçŒ«+å°æ—coding</p>
<p>ç®—æ³•ï¼šhot100+top150åå¤åˆ·ï¼Œé¢è¯•å‰åˆ·CodeTopï¼ˆè·Ÿç€ä»£ç éšæƒ³å½•å…¥é—¨ä¹‹åæ¯å¤©å®šæ—¶åˆ·ä¸‰é“ï¼‰</p>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>Algorithm, Java</tag>
      </tags>
  </entry>
  <entry>
    <title>SAR&amp;Rela</title>
    <url>/2025/04/16/Search-Ads-Rec-Rela/</url>
    <content><![CDATA[<p>Search, Advertising, Recommendationä¸ç›¸å…³</p>
<p>æ–½å·¥ä¸­â€¦</p>
<span id="more"></span>
<h1>SAR&amp;Rela</h1>
<br>
<h2 id="æ¦‚è¦">æ¦‚è¦</h2>
<h3 id="é“¾è·¯">é“¾è·¯</h3>
<p>å¤šé€šé“å¬å›</p>
<ul>
<li>å†…å®¹è¿‡æ»¤</li>
<li>ååŒè¿‡æ»¤</li>
<li>åŒå¡”â€¦</li>
</ul>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672040737101-86c337d2-1134-4829-b25a-4d0ee6e7a1be.png" class="" title="img">
<p>ç²—æ’&amp;ç²¾æ’</p>
<ul>
<li>ç²—æ’ä½¿ç”¨å°è§„æ¨¡ç¥ç»ç½‘ç»œï¼Œç»™å‡ åƒç¯‡ç¬”è®°æ‰“åˆ†ï¼Œé€‰å‡ºåˆ†æ•°æœ€é«˜çš„å‡ ç™¾ç¯‡ï¼›</li>
<li>ç”¨å¤§è§„æ¨¡ç¥ç»ç½‘ç»œï¼Œç»™å‡ ç™¾ç¯‡ç¬”è®°æ‰“åˆ†ï¼Œé€‰å‡ºåˆ†æ•°æœ€é«˜çš„å‡ åç¯‡ï¼›</li>
</ul>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672040737189-3e05f4a0-4485-42c8-b518-62280943b0c9.png" class="" title="img">
<p>é‡æ’</p>
<ul>
<li>å¤šæ ·æ€§éšæœºæŠ½æ ·ï¼šé¿å…æ¨èç»“æœè¿‡äºåŒè´¨åŒ–ï¼ˆä¾‹å¦‚å…¨éƒ¨æ˜¯åŒä¸€ç±»å‹çš„ç¬”è®°ï¼‰ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ›´ä¸°å¯Œçš„å†…å®¹ï¼Œå¯¹å€™é€‰é›†æŒ‰ç±»åˆ«ã€ä¸»é¢˜ã€ä½œè€…ç­‰ç»´åº¦åˆ†ç»„ï¼ˆå¦‚â€œç¾é£Ÿâ€â€œæ—…è¡Œâ€â€œç§‘æŠ€â€ï¼‰ï¼Œä»æ¯ç»„ä¸­éšæœºæŠ½å–ä¸€å®šæ¯”ä¾‹çš„å†…å®¹ï¼Œç»„æˆæœ€ç»ˆæ¨èåˆ—è¡¨ã€‚</li>
<li>è§„åˆ™å»é‡ï¼šé˜²æ­¢å†…å®¹é«˜åº¦ç›¸ä¼¼çš„ç¬”è®°è¿ç»­å‡ºç°ï¼ˆä¾‹å¦‚åŒä¸€ä½œè€…çš„å¤šä¸ªç¬”è®°ï¼Œæˆ–åŒä¸€äº‹ä»¶çš„é‡å¤æŠ¥é“ï¼‰ã€‚</li>
<li>å¹¿å‘Šæ’å…¥</li>
</ul>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672040737268-b4922779-dc96-4c53-b21e-1c46437cdbc7.png" class="" title="img">
<br>
<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<p><strong>A/Bæµ‹è¯•</strong></p>
<p>é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªæˆ–å¤šä¸ªç‰ˆæœ¬ï¼ˆAç‰ˆå’ŒBç‰ˆï¼‰æ¥ç¡®å®šå“ªä¸ªç‰ˆæœ¬æ•ˆæœæ›´å¥½çš„å®éªŒæ–¹æ³•ã€‚</p>
<br>
<p><strong>åˆ†å±‚å®éªŒ</strong></p>
<ul>
<li>åŒå±‚äº’æ–¥ï¼šä¾‹å¦‚ï¼Œåœ¨å¬å›å±‚çš„ç”¨æˆ·ä»…å¯ä»¥å±äºä¸€ä¸ªæ¡¶</li>
<li>å¼‚å±‚æ­£äº¤ï¼šä¾‹å¦‚ï¼Œå¬å›å±‚ç”¨æˆ·Aåœ¨ç²—æ’å±‚è¢«éšæœºæ‰“æ•£åˆ†å¸ƒåœ¨ç²—æ’å±‚çš„10ä¸ªæ¡¶</li>
</ul>
<br>
<p><strong>Holdout</strong></p>
<p>ä¿ç•™10%çš„ç”¨æˆ·å®Œå…¨ä¸å‚ä¸åˆ°å®éªŒä¸­ï¼Œä½œä¸ºå¯¹ç…§ç»„</p>
<br>
<h2 id="ç¦»æ•£ç‰¹å¾å¤„ç†">ç¦»æ•£ç‰¹å¾å¤„ç†</h2>
<h3 id="ç¦»æ•£ç‰¹å¾">ç¦»æ•£ç‰¹å¾</h3>
<p>ç¦»æ•£ç‰¹å¾æ¡ˆä¾‹ï¼š</p>
<ul>
<li>æ€§åˆ«ï¼šç”·ã€å¥³ä¸¤ç§ç±»åˆ«</li>
<li>å›½ç±ï¼šä¸­å›½ã€ç¾å›½ã€å°åº¦ç­‰ 200 ä¸ªå›½å®¶</li>
<li>è‹±æ–‡å•è¯ï¼šå¸¸è§çš„è‹±æ–‡å•è¯æœ‰å‡ ä¸‡ä¸ª</li>
</ul>
<p>ç¦»æ•£ç‰¹å¾å‘é‡åŒ–</p>
<ul>
<li>one-hotï¼šè¶…é«˜ç»´ç¨€ç– - çƒé¢</li>
<li>åˆ†è¯å™¨ï¼šå•ç»´ç¨ å¯† - åæ ‡è½´</li>
<li>embedding</li>
</ul>
<br>
<h3 id="çŸ©é˜µè¡¥å……">çŸ©é˜µè¡¥å……</h3>
<p>åœ¨å®è·µä¸­ä¸ä½¿ç”¨ï¼ï¼</p>
<p>ç”¨äºå®é™…ç‰©å“æ•°é‡åºå¤§ï¼Œå¯æš´éœ²ç»™ç”¨æˆ·çš„ç‰©å“é‡æå°‘ï¼ˆç»¿è‰²ä¸ºæš´éœ²ç»™ç”¨æˆ·çš„ï¼Œç°è‰²ä¸ºæ²¡æœ‰æ›å…‰çš„ï¼‰ï¼ŒçŸ©é˜µè¡¥å……ç”¨äºè®­ç»ƒç½‘ç»œé¢„æµ‹æœªæš´éœ²ç»™ç”¨æˆ·çš„ï¼Œç”¨æˆ·å¯¹ç‰©å“çš„å…´è¶£åº¦ï¼ˆæ ¼å­ä¸­çš„å€¼ä¸ºå…´è¶£åº¦ï¼‰</p>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042316018-1bf99117-9105-4290-9997-5fd589d5ba94.png" class="" title="img">
<br>
<h4 id="è®­ç»ƒ">è®­ç»ƒ</h4>
<p>è®­ç»ƒä¸¤ä¸ªEmbedding Layerï¼Œå†…ç§¯ä¸ºé¢„æµ‹çš„å…´è¶£åº¦</p>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042315791-5bfc7658-6112-4537-8a28-4d1085472232.png" class="" title="img">
<p>æ•°æ®é›†ï¼š</p>
<ul>
<li>
<p>ï¼ˆç”¨æˆ· IDï¼Œç‰©å“ IDï¼ŒçœŸå®å…´è¶£åˆ†æ•°ï¼‰çš„é›†åˆï¼Œè®°ä½œ $\Omega={(u,i,y) }$</p>
</li>
<li>
<p>æ•°æ®é›†ä¸­çš„å…´è¶£åˆ†æ•°æ˜¯ç³»ç»Ÿè®°å½•çš„ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æ›å…‰ä½†æ˜¯æ²¡æœ‰ç‚¹å‡» â†’ 0 åˆ†</li>
<li>ç‚¹å‡»ã€ç‚¹èµã€æ”¶è—ã€è½¬å‘ â†’ å„ç®— 1 åˆ†</li>
<li>åˆ†æ•°æœ€ä½æ˜¯ 0ï¼Œæœ€é«˜æ˜¯ 4</li>
</ul>
</li>
<li>
<p>è®­ç»ƒçš„ç›®çš„å°±æ˜¯è®©æ¨¡å‹çš„è¾“å‡ºæ‹ŸåˆçœŸå®å…´è¶£åˆ†æ•°</p>
</li>
</ul>
<p>æŸå¤±å‡½æ•°ï¼š</p>
<p>$$<br>
\min_{\bold{A},\bold{B}}\sum_{(u,i,y)\in\Omega}(y- \left\langle \bold{a}_u,\bold{b}_i \right\rangle)^2<br>
$$</p>
<br>
<h4 id="è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢">è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢</h4>
<h5 id="è¡¡é‡è¿‘é‚»æŒ‡æ ‡">è¡¡é‡è¿‘é‚»æŒ‡æ ‡</h5>
<ul>
<li>æ¬§å¼è·ç¦»</li>
<li>å‘é‡å†…ç§¯</li>
<li>å¤¹è§’ä½™å¼¦</li>
</ul>
<br>
<h5 id="æµç¨‹">æµç¨‹</h5>
<ul>
<li>æ•°æ®é¢„å¤„ç†ï¼šå°†æ•°æ®åˆ’åˆ†ä¸ºå¤šä¸ªåŒºåŸŸï¼Œä½¿ç”¨ç´¢å¼•å‘é‡ï¼ˆå•ä½å‘é‡ï¼‰è¡¨ç¤ºæ¯ä¸ªåŒºåŸŸ</li>
<li>å®æ—¶æ¨èæ—¶ï¼Œå°†ç”¨æˆ·å‘é‡ä¸æ‰€æœ‰ç´¢å¼•å‘é‡åšå¯¹æ¯”</li>
<li>é€šè¿‡ç´¢å¼•å‘é‡ï¼Œæ‰¾åˆ°ç´¢å¼•å¯¹åº”åŒºåŸŸä¸­çš„æ‰€æœ‰ç‰©å“ï¼Œç„¶åå†è®¡ç®—è¯¥åŒºåŸŸä¸­æ‰€æœ‰ç‰©å“ä¸ ç”¨æˆ·å‘é‡ çš„ç›¸ä¼¼åº¦</li>
</ul>
<br>
<h2 id="å¬å›">å¬å›</h2>
<h3 id="åŸºäºååŒè¿‡æ»¤çš„å¬å›">åŸºäºååŒè¿‡æ»¤çš„å¬å›</h3>
<p>æ— éœ€ç‰©å“ç‰¹å¾ï¼ˆå¦‚åˆ†ç±»ã€æ ‡ç­¾ï¼‰ï¼Œä»…ä¾èµ–ç”¨æˆ·è¡Œä¸ºå³å¯å·¥ä½œã€‚</p>
<br>
<h4 id="ItemCF">ItemCF</h4>
<p><strong>Item-based Collaborative Filtering</strong> åŸºäºç‰©å“çš„ååŒè¿‡æ»¤</p>
<h5 id="è¯„åˆ†">è¯„åˆ†</h5>
<p>å®šä¹‰ç”¨æˆ·ä¸º $u$ï¼Œå®šä¹‰ç‰©å“ä¸º $i$ï¼Œ ç”¨æˆ·å¯¹å€™é€‰ç‰©å“ $i_k$ çš„å…´è¶£è¡¨ç¤ºä¸ºï¼š<br>
$$<br>
R(u, i_k) = \sum_{j}R(u, i_{j}) \times \text{sim}(i_{j},i_{k})<br>
$$</p>
<br>
<h5 id="ç‰©å“ç›¸ä¼¼åº¦">ç‰©å“ç›¸ä¼¼åº¦</h5>
<p>ç›¸ä¼¼åº¦è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p>
<p>å®šä¹‰å–œæ¬¢ç‰©å“ $i$ ï¼ˆä¸ç‰©å“ $i$ æœ‰äº¤äº’ï¼‰çš„ç”¨æˆ·ç¾¤ä½“ä¸º $N(i)$ï¼Œæœ‰ç‰©å“ç›¸ä¼¼åº¦å®šä¹‰å¦‚ä¸‹ï¼š<br>
$$<br>
\text{sim}(i_1, i_2) = \frac{|N(i_1) \cap N(i_2)|}{\sqrt{|N(i_1)|\cdot|N(i_2)|}}<br>
$$<br>
ä¿®æ­£ï¼šè‹¥å¼•å…¥ç”¨æˆ·å¯¹ç‰©å“çš„è¯„åˆ† $R(u, i)$ï¼Œç‰©å“ç›¸ä¼¼åº¦å®šä¹‰å¦‚ä¸‹ï¼š<br>
$$<br>
\text{sim}(i_1, i_2) = \frac{\sum_{u \in N(i_1) \cap N(i_2)}R(u, i_1)\cdot R(u, i_2)}{\sqrt{\sum_{u_{1} \in N(i)}R^{2}(u_{1}, i_1)} \cdot \sqrt{\sum_{u_{2} \in N(i_2)}R^{2}(u_{2}, i_2)}}<br>
$$</p>
<blockquote>
<p>ç›¸ä¼¼åº¦å…¬å¼1ç›¸å½“äºå…¬å¼2ä¸­çš„Rä¸ºå¸ƒå°”å€¼</p>
</blockquote>
<p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä½¿ç”¨å‘é‡è®¡ç®—ç›¸ä¼¼åº¦</p>
<ul>
<li>æ¯ä¸ªç‰©å“é€šè¿‡å‘é‡è¡¨ç¤º</li>
<li>å‘é‡çš„æ¯ä¸€ä½è¡¨ç¤ºç”¨æˆ·å¯¹è¯¥ç‰©å“çš„å–œæ¬¢åº¦</li>
<li>ç›¸ä¼¼åº¦ä¸ºç‰©å“å‘é‡å¤¹è§’ä½™å¼¦</li>
</ul>
<br>
<h5 id="æµç¨‹-2">æµç¨‹</h5>
<p>å¦‚æœæƒ³çŸ¥é“ Alice å¯¹ç‰©å“5æ‰“å¤šå°‘åˆ†ï¼Œ åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ç®—æ³•ä¼šè¿™ä¹ˆåšï¼š</p>
<ul>
<li>é¦–å…ˆè®¡ç®—ä¸€ä¸‹ç‰©å“5å’Œç‰©å“1ï¼Œ 2ï¼Œ 3ï¼Œ 4ä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚</li>
<li>åœ¨Aliceæ‰¾å‡ºä¸ç‰©å“ 5 æœ€ç›¸è¿‘çš„ n ä¸ªç‰©å“ã€‚</li>
<li>æ ¹æ® Alice å¯¹æœ€ç›¸è¿‘çš„ n ä¸ªç‰©å“çš„æ‰“åˆ†å»è®¡ç®—å¯¹ç‰©å“ 5 çš„æ‰“åˆ†æƒ…å†µã€‚</li>
</ul>
<br>
<h4 id="UserCF">UserCF</h4>
<p>åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤</p>
<h5 id="è¯„åˆ†-2">è¯„åˆ†</h5>
<p>$$<br>
R(u, i) = \sum_jsim(u,u_j)Ã—R(u_j,i)<br>
$$</p>
<h5 id="ç”¨æˆ·ç›¸ä¼¼åº¦">ç”¨æˆ·ç›¸ä¼¼åº¦</h5>
<p>å®šä¹‰ç”¨æˆ·ç›¸ä¼¼åº¦ä¸º</p>
<ul>
<li>è®°ç”¨æˆ· $u_1$ äº¤äº’ç‰©å“çš„é›†åˆä¸º $\mathcal{J}(u_1)$</li>
<li>è®°ç”¨æˆ· $u_2$ äº¤äº’ç‰©å“çš„é›†åˆä¸º $\mathcal{J}(u_2)$</li>
</ul>
<p>ç”¨æˆ·çš„ç›¸ä¼¼åº¦å…¬å¼ä¸ºï¼š</p>
<p>$$<br>
sim(u_1,u_2)=\frac{|\mathcal{J}(u_1)\cap\mathcal{J}(u_2)|}{\sqrt{|\mathcal{J}(u_1)|Â·|\mathcal{J}(u_2)|}}<br>
$$</p>
<p>ä¿®æ­£ï¼šè€ƒè™‘é™ä½çƒ­é—¨ç‰©å“çš„æƒé‡</p>
<p>$$<br>
sim(u_1,u_2)=\frac{\sum_{l\in{\mathcal{J}_1\cap\mathcal{J}_2}} \frac{1}{\log{(1+n_l)}}}{\sqrt{|\mathcal{J}(u_1)|Â·|\mathcal{J}(u_2)|}}<br>
$$</p>
<ul>
<li>
<p>$n_l$ï¼šå–œæ¬¢ç‰©å“ $l$ çš„ç”¨æˆ·æ•°é‡ï¼Œåæ˜ ç‰©å“çš„çƒ­é—¨ç¨‹åº¦</p>
</li>
<li>
<p>ç‰©å“è¶Šçƒ­é—¨ï¼Œ$\frac{1}{\log{(1+n_l)}}$ è¶Šå°ï¼Œå¯¹ç›¸ä¼¼åº¦çš„è´¡çŒ®å°±è¶Šå°</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line">i = [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]  // ç”¨æˆ·iï¼Œæ¯ä¸€åˆ—è¡¨ç¤ºå¯¹ç‰©å“næ˜¯å¦å–œæ¬¢</span><br><span class="line">j = [<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]  // ç”¨æˆ·jï¼Œæ¯ä¸€åˆ—è¡¨ç¤ºå¯¹ç‰©å“næ˜¯å¦å–œæ¬¢</span><br><span class="line">cosine_similarity([i, j])</span><br></pre></td></tr></table></figure>
<br>
<h5 id="æµç¨‹-3">æµç¨‹</h5>
<p>é¢„ä¼°ç”¨æˆ·aå¯¹ç‰©å“xçš„è¯„åˆ†</p>
<ul>
<li>æŸ¥æ‰¾æ•°æ®åº“ï¼Œå¾—åˆ°ä¸ç”¨æˆ·aç›¸ä¼¼ç¨‹åº¦æœ€æ¥è¿‘ï¼ˆè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ANNå¾—åˆ°ï¼‰çš„å‰Nä¸ªç”¨æˆ·</li>
<li>æ ¹æ®ç›¸ä¼¼ç”¨æˆ·å¯¹ç‰©å“xçš„è¯„åˆ†ä¼°è®¡ç”¨æˆ·aå¯¹ç‰©å“xçš„è¯„åˆ†</li>
</ul>
<br>
<h4 id="Swing">Swing</h4>
<p>ç‰©å“ç›¸ä¼¼åº¦å…¬å¼æ›´æ–°ï¼Œå…¶ä»–ä¸ItemCFç›¸åŒ</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œSwingå¬å›â€ä¸»è¦ç”¨äºæ¨èç³»ç»Ÿä¸­ï¼Œé€šè¿‡æ„é€ ç”¨æˆ·â€“ç‰©å“äºŒåˆ†å›¾æ¥è¡¡é‡ä¸¤ä¸ªç‰©å“ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå…¶æ€æƒ³æ˜¯æ—¢è€ƒè™‘äº†ç›´æ¥ç”±åŒä¸€ç”¨æˆ·è§¦å‘çš„å…±ç°å…³ç³»ï¼Œä¹Ÿè€ƒè™‘äº†é—´æ¥çš„å…³è”ï¼ˆå³â€œæ‘‡æ‘†â€æ•ˆæœï¼‰ã€‚ä¸åŒçš„è®ºæ–‡å’Œå®ç°å¯èƒ½åœ¨ç»†èŠ‚ä¸Šæœ‰æ‰€å·®åˆ«ï¼Œä½†åŸºæœ¬æ€æƒ³æ˜¯ä¸€è‡´çš„ã€‚</p>
<br>
<h5 id="ç›¸ä¼¼åº¦">ç›¸ä¼¼åº¦</h5>
<p>åœ¨å®è·µä¸­å¸¸ç”¨çš„<strong>ç»Ÿä¸€åŒé‡æ±‚å’Œ</strong>å½¢å¼</p>
<ul>
<li>ç”¨æˆ· $u_1$ å–œæ¬¢çš„ç‰©å“è®°ä½œé›†åˆ $\mathcal{J}(u_1)$</li>
<li>ç”¨æˆ· $u_2$ å–œæ¬¢çš„ç‰©å“è®°ä½œé›†åˆ $\mathcal{J}(u_2)$</li>
</ul>
<p>ç”¨æˆ· $u_1$ å’Œ $u_2$ çš„é‡åˆåº¦é«˜ï¼Œåˆ™ä»–ä»¬å¯èƒ½æ¥è‡ªä¸€ä¸ªå°åœˆå­ï¼Œè¦é™ä½ä»–ä»¬çš„æƒé‡</p>
<br>
<p>ç‰©å“ç›¸ä¼¼åº¦</p>
<ul>
<li>å–œæ¬¢ç‰©å“ $i_1$ çš„ç”¨æˆ·è®°ä½œé›†åˆ $N_1$</li>
<li>å–œæ¬¢ç‰©å“ $i_2$ çš„ç”¨æˆ·è®°ä½œé›†åˆ $N_2$</li>
</ul>
<p>ä¸¤ä¸ªç‰©å“çš„ç›¸ä¼¼åº¦ï¼š<br>
$$<br>
sim(i_1,i_2)=\sum_{u_1\in N_1 \cap N_2 }\sum_{u_2\in N_1 \cap N_2} \frac{1}{\sqrt{|\mathcal{J}(u_1)}} \cdot \frac{1}{\sqrt{|\mathcal{J}(u_2)|}} \cdot \frac{1}{\alpha+|\mathcal{J}(u_1) \cap \mathcal{J}(u_2)|}<br>
$$</p>
<ul>
<li>
<p>$Î±$ æ˜¯è¶…å‚æ•°</p>
</li>
<li>
<p>é‡åˆåº¦é«˜ï¼Œè¯´æ˜ä¸¤äººæ˜¯ä¸€ä¸ªå°åœˆå­çš„ï¼Œé‚£ä¹ˆä»–ä¸¤å¯¹ç‰©å“ç›¸ä¼¼åº¦çš„è´¡çŒ®å°±æ¯”è¾ƒå°ï¼›é‡åˆåº¦å°ï¼Œä¸¤äººä¸æ˜¯ä¸€ä¸ªå°åœˆå­çš„ï¼Œä»–ä¸¤å¯¹ç‰©å“ç›¸ä¼¼åº¦çš„è´¡çŒ®å°±æ¯”è¾ƒå¤§</p>
</li>
</ul>
<br>
<h4 id="çŸ©é˜µåˆ†è§£">çŸ©é˜µåˆ†è§£</h4>
<p>Matrix Factorization</p>
<br>
<h3 id="åŸºäºå‘é‡çš„å¬å›">åŸºäºå‘é‡çš„å¬å›</h3>
<h4 id="FMå¬å›">FMå¬å›</h4>
<br>
<h4 id="item2vecå¬å›">item2vecå¬å›</h4>
<br>
<h4 id="åŒå¡”æ¨¡å‹">åŒå¡”æ¨¡å‹</h4>
<h5 id="æ¨¡å‹ä¸è®­ç»ƒ">æ¨¡å‹ä¸è®­ç»ƒ</h5>
<h6 id="æ¨¡å‹">æ¨¡å‹</h6>
<p><strong>ç”¨æˆ·</strong></p>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042316812-3bce2474-8eda-48cb-aa80-6f58bb78b238.png" class="" title="img">
<p><strong>ç‰©å“</strong></p>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042316930-512c4448-5964-4bf2-9309-419cd3a16db5.png" class="" title="img">
<p><strong>åŒå¡”æ¨¡å‹</strong></p>
<p>è¾“å‡ºçš„ä½™å¼¦ç›¸ä¼¼åº¦ä¸º <strong>é¢„ä¼°ç”¨æˆ·å¯¹ç‰©å“çš„å…´è¶£</strong></p>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042317078-7e47cf8c-e659-4582-8ea5-4b131b39913f.png" class="" title="img">
<h6 id="è®­ç»ƒ-2">è®­ç»ƒ</h6>
<p><strong>Pointwise</strong></p>
<p>äºŒå…ƒåˆ†ç±»æ¯ä¸ªæ­£æ ·æœ¬ï¼Œè´Ÿæ ·æœ¬</p>
<p>å¯¹äºæ­£æ ·æœ¬ï¼Œé¼“åŠ± $cos(\mathbf{a},\mathbf{b})$ æ¥è¿‘ +1</p>
<p>å¯¹äºè´Ÿæ ·æœ¬ï¼Œé¼“åŠ± $cos(\mathbf{a},\mathbf{b})$ æ¥è¿‘ -1</p>
<br>
<p><strong>Pairwise</strong></p>
<p>æ¯æ¬¡å–ä¸€ä¸ªæ­£æ ·æœ¬å’Œä¸€ä¸ªè´Ÿæ ·æœ¬</p>
<blockquote>
<p>ref: Jui-Ting Huang et al. Embedding-based Retrieval in Facebook Search. In KDD, 2020</p>
</blockquote>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042317349-25d382e4-8c3f-4881-984e-7348d3173963.png" class="" title="img">
<p>é¼“åŠ± $\cos{(\mathbf{a},\mathbf{b}^+)}$ å¤§äº $\cos{(\mathbf{a},\mathbf{b}^-)}$</p>
<ul>
<li>
<p>å¦‚æœ  $\cos{(\mathbf{a},\mathbf{b}^+)}$ å¤§äº  $\cos{(\mathbf{a},\mathbf{b}^-)}+m$ï¼Œåˆ™æ²¡æœ‰æŸå¤±</p>
<ul>
<li>m æ˜¯è¶…å‚æ•°ï¼Œéœ€è¦è°ƒ</li>
</ul>
</li>
<li>
<p>å¦åˆ™ï¼ŒæŸå¤±ç­‰äº  $\cos{(\mathbf{a},\mathbf{b}^-)}+m-\cos{(\mathbf{a},\mathbf{b}^+)}$</p>
</li>
</ul>
<br>
<p><strong>Triplet hinge loss</strong>:<br>
$$<br>
L(\mathbf{a}, \mathbf{b}^+, \mathbf{b}^-) = \max \left{ 0, \cos(\mathbf{a}, \mathbf{b}^-) + m - \cos(\mathbf{a}, \mathbf{b}^+) \right}<br>
$$<br>
<strong>Triplet logistic loss:</strong><br>
$$<br>
L(\mathbf{a}, \mathbf{b}^+, \mathbf{b}^-) = \log \left( 1 + \exp \left[ \sigma \cdot \left( \cos(\mathbf{a}, \mathbf{b}^-) - \cos(\mathbf{a}, \mathbf{b}^+) \right) \right] \right)<br>
$$</p>
<ul>
<li>$\sigma$ æ˜¯å¤§äº 0 çš„è¶…å‚æ•°ï¼Œæ§åˆ¶æŸå¤±å‡½æ•°çš„å½¢çŠ¶ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®</li>
</ul>
<br>
<p><strong>Listwise</strong></p>
<blockquote>
<p>ref: Xinyang Yi et al. Sampling-Bias-Corrected Neural Modeling for Large Corpus Item Recommendations. In RecSys, 2019.</p>
</blockquote>
<p>æ¯æ¬¡å–ä¸€ä¸ªæ­£æ ·æœ¬å’Œå¤šä¸ªè´Ÿæ ·æœ¬ï¼Œè®­ç»ƒæ•°æ®åŒ…å«ï¼š</p>
<ul>
<li>
<p>ä¸€ä¸ªç”¨æˆ·ï¼Œç‰¹å¾å‘é‡è®°ä½œ $\mathbf{a}$</p>
</li>
<li>
<p>ä¸€ä¸ªæ­£æ ·æœ¬ï¼Œç‰¹å¾å‘é‡è®°ä½œ $\mathbf{b}^+$</p>
</li>
<li>
<p>å¤šä¸ªè´Ÿæ ·æœ¬ï¼Œç‰¹å¾å‘é‡è®°ä½œ $\mathbf{b}^-_1,â€¦,\mathbf{b}^-_n$</p>
</li>
</ul>
<p>é¼“åŠ± $\cos{(\mathbf{a},\mathbf{b}^+)}$ å°½é‡å¤§</p>
<p>é¼“åŠ± $\cos{(\mathbf{a},\mathbf{b}^-_1)},â€¦,\cos{(\mathbf{a},\mathbf{b}^-_n)}$ å°½é‡å°</p>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042317453-2e6860cf-79ad-492a-b350-5f8115174edf.png" class="" title="img">
<p>ç”¨ $y$ å’Œ $s$ çš„äº¤å‰ç†µä½œä¸ºæŸå¤±å‡½æ•°ï¼Œæ„æ€æ˜¯é¼“åŠ± $Softmax$ çš„è¾“å‡º $s$ æ¥è¿‘æ ‡ç­¾ $y$</p>
<br>
<br>
<h5 id="æ­£è´Ÿæ ·æœ¬">æ­£è´Ÿæ ·æœ¬</h5>
<h6 id="æ ·æœ¬">æ ·æœ¬</h6>
<ul>
<li>æ­£æ ·æœ¬ï¼šæ›å…‰è€Œä¸”æœ‰ç‚¹å‡»çš„ï¼ˆç”¨æˆ·-ç‰©å“äº¤äº’ï¼‰ ç”¨æˆ·-ç‰©å“ äºŒå…ƒç»„</li>
<li>è´Ÿæ ·æœ¬ï¼š
<ul>
<li>æ²¡æœ‰è¢«å¬å›çš„ï¼Ÿ</li>
<li>å¬å›ä½†æ˜¯è¢«ç²—æ’ï¼Œç²¾æ’æ·˜æ±°çš„ï¼Ÿ</li>
<li>æ›å…‰ä½†æ˜¯æœªç‚¹å‡»ï¼Ÿ</li>
</ul>
</li>
</ul>
<img src="/2025/04/16/Search-Ads-Rec-Rela/1672042317852-e1721f7f-f1cb-4910-af2f-0847eaf52b1b.png" class="" title="img">
<br>
<h6 id="æ­£æ ·æœ¬">æ­£æ ·æœ¬</h6>
<p>æ›å…‰è€Œä¸”æœ‰ç‚¹å‡»çš„ï¼ˆç”¨æˆ·-ç‰©å“äº¤äº’ï¼‰ ç”¨æˆ·-ç‰©å“ äºŒå…ƒç»„</p>
<p>å­˜åœ¨é—®é¢˜ï¼šæ­£æ ·æœ¬å¤šä¸ºçƒ­é—¨ç‰©å“ï¼›</p>
<p>è§£å†³æ–¹æ¡ˆï¼šè¿‡é‡‡æ ·å†·é—¨ç‰©å“ï¼Œé™é‡‡æ ·çƒ­é—¨ç‰©å“ï¼›</p>
<h6 id="ç®€å•è´Ÿæ ·æœ¬">ç®€å•è´Ÿæ ·æœ¬</h6>
<p>å– ç”¨æˆ·-ç‰©å“äº¤äº’ æ¡ç›®ä¸ºBatch</p>
<p>Batchå†… ç”¨æˆ·ä¸æœªäº¤äº’ç‰©å“å½¢æˆè´Ÿæ ·æœ¬</p>
<br>
<p>å­˜åœ¨é—®é¢˜ï¼šçƒ­é—¨ç‰©å“é«˜æ¦‚ç‡æˆä¸ºè´Ÿæ ·æœ¬</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<blockquote>
<p>Xinyang Yi et al. Sampling-Bias-Corrected Neural Modeling for Large Corpus Item Recommendations. In RecSys, 2019.</p>
</blockquote>
<p>ä¿®æ­£åå·®ï¼š</p>
<ul>
<li>
<p>ç‰©å“ $i$ è¢«æŠ½æ ·åˆ°çš„æ¦‚ç‡ï¼š$p_i \propto \text{ç‚¹å‡»æ¬¡æ•°}$</p>
<ul>
<li>é¢„ä¼°ç”¨æˆ·å¯¹ç‰©å“ $i$ çš„å…´è¶£ï¼š$cos(\mathbf{a}, \mathbf{b_i})$</li>
<li>è®­ç»ƒæ—¶ï¼Œå°†å…´è¶£è°ƒæ•´ä¸ºï¼š$cos(\mathbf{a}, \mathbf{b_i)} - log(p_i)$</li>
</ul>
</li>
<li>
<p>çº åé¿å…è¿‡åº¦æ‰“å‹çƒ­é—¨ç‰©å“</p>
<ul>
<li>éè®­ç»ƒçº¿ä¸Šå¬å›æ—¶ï¼Œä½¿ç”¨ $cos(\mathbf{a}, \mathbf{b_i})$ ä½œä¸ºå…´è¶£</li>
</ul>
</li>
</ul>
<br>
<h6 id="å›°éš¾è´Ÿæ ·æœ¬">å›°éš¾è´Ÿæ ·æœ¬</h6>
<p>è¢«ç²—æ’æ·˜æ±°çš„ç‰©å“ï¼ˆæ¯”è¾ƒå›°éš¾ï¼‰</p>
<ul>
<li>è¿™äº›ç‰©å“è¢«å¬å›ï¼Œè¯´æ˜å’Œç”¨æˆ·å…´è¶£æœ‰å…³ï¼›åˆè¢«ç²—æ’æ·˜æ±°ï¼Œè¯´æ˜ç”¨æˆ·å¯¹ç‰©å“å…´è¶£ä¸å¤§</li>
<li>è€Œåœ¨å¯¹æ­£è´Ÿæ ·æœ¬åšäºŒå…ƒåˆ†ç±»æ—¶ï¼Œè¿™äº›å›°éš¾æ ·æœ¬å®¹æ˜“è¢«åˆ†é”™ï¼ˆè¢«é”™è¯¯åˆ¤å®šä¸ºæ­£æ ·æœ¬ï¼‰</li>
</ul>
<p>ç²¾æ’åˆ†æ•°é åçš„ç‰©å“ï¼ˆéå¸¸å›°éš¾ï¼‰</p>
<ul>
<li>èƒ½å¤Ÿè¿›å…¥ç²¾æ’ï¼Œè¯´æ˜ç‰©å“æ¯”è¾ƒç¬¦åˆç”¨æˆ·å…´è¶£ï¼Œä½†ä¸æ˜¯ç”¨æˆ·æœ€æ„Ÿå…´è¶£çš„</li>
</ul>
<br>
<p>å¯¹æ­£è´Ÿæ ·æœ¬åšäºŒå…ƒåˆ†ç±»ï¼š</p>
<ul>
<li>å…¨ä½“ç‰©å“ï¼ˆç®€å•ï¼‰åˆ†ç±»å‡†ç¡®ç‡é«˜</li>
<li>è¢«ç²—æ’æ·˜æ±°çš„ç‰©å“ï¼ˆæ¯”è¾ƒå›°éš¾ï¼‰å®¹æ˜“åˆ†é”™</li>
<li>ç²¾æ’åˆ†æ•°é åçš„ç‰©å“ï¼ˆéå¸¸å›°éš¾ï¼‰æ›´å®¹æ˜“åˆ†é”™</li>
</ul>
<p>è®­ç»ƒæ•°æ®</p>
<ul>
<li>æ··åˆå‡ ç§è´Ÿæ ·æœ¬
<ul>
<li>
<p>50% çš„è´Ÿæ ·æœ¬æ˜¯å…¨ä½“ç‰©å“ï¼ˆç®€å•è´Ÿæ ·æœ¬ï¼‰</p>
</li>
<li>
<p>50% çš„è´Ÿæ ·æœ¬æ˜¯æ²¡é€šè¿‡æ’åºçš„ç‰©å“ï¼ˆå›°éš¾è´Ÿæ ·æœ¬ï¼‰</p>
<ul>
<li>å³åœ¨ç²—æ’ã€ç²¾æ’æ·˜æ±°çš„ç‰©å“</li>
</ul>
</li>
</ul>
</li>
</ul>
<br>
<h5 id="çº¿ä¸Šå¬å›ä¸æ›´æ–°">çº¿ä¸Šå¬å›ä¸æ›´æ–°</h5>
<h6 id="çº¿ä¸Šå¬å›">çº¿ä¸Šå¬å›</h6>
<p><strong>åŒå¡”æ¨¡å‹çš„å¬å›</strong></p>
<p>ç¦»çº¿å­˜å‚¨ï¼š</p>
<ol>
<li>å®Œæˆè®­ç»ƒä¹‹åï¼Œç”¨ç‰©å“å¡”è®¡ç®—æ¯ä¸ªç‰©å“çš„ç‰¹å¾å‘é‡ $\mathbf{b_i}$</li>
<li>æŠŠå‡ äº¿ä¸ªç‰©å“å‘é‡ $\mathbf{b_i}$ å­˜å…¥å‘é‡æ•°æ®åº“ï¼ˆæ¯”å¦‚ Milvusã€Faissã€HnswLib ï¼‰</li>
<li>å‘é‡æ•°æ®åº“å»ºç´¢å¼•ï¼Œä»¥ä¾¿åŠ é€Ÿæœ€è¿‘é‚»æŸ¥æ‰¾</li>
</ol>
<p>çº¿ä¸Šå¬å›ï¼šæŸ¥æ‰¾ç”¨æˆ·æœ€æ„Ÿå…´è¶£çš„ $k$ ä¸ªç‰©å“</p>
<ol>
<li>ç»™å®šç”¨æˆ· ID å’Œç”»åƒï¼Œçº¿ä¸Šç”¨ç¥ç»ç½‘ç»œç°ç®—ï¼ˆ<strong>å®æ—¶è®¡ç®—</strong>ï¼‰ç”¨æˆ·å‘é‡ $\mathbf{a}$</li>
<li>æœ€è¿‘é‚»æŸ¥æ‰¾ï¼š
<ul>
<li>
<p>æŠŠå‘é‡ $\mathbf{a}$ ä½œä¸º queryï¼Œè°ƒç”¨å‘é‡æ•°æ®åº“åšæœ€è¿‘é‚»æŸ¥æ‰¾</p>
</li>
<li>
<p>è¿”å›ä½™å¼¦ç›¸ä¼¼åº¦æœ€å¤§çš„ $k$ ä¸ªç‰©å“ï¼Œä½œä¸ºå¬å›ç»“æœ</p>
</li>
</ul>
</li>
</ol>
<br>
<p>ä¸ºä»€ä¹ˆäº‹å…ˆå­˜å‚¨ç‰©å“å‘é‡ $\mathbf{b_i}$ï¼Œçº¿ä¸Šç°ç®—ç”¨æˆ·å‘é‡ $\mathbf{a}$ï¼Ÿ</p>
<ul>
<li>æ¯åšä¸€æ¬¡å¬å›ï¼Œç”¨åˆ°ä¸€ä¸ªç”¨æˆ·å‘é‡ $\mathbf{a}$ï¼Œå‡ äº¿ç‰©å“å‘é‡ $\mathbf{b_i}$ï¼ˆçº¿ä¸Šç®—ç‰©å“å‘é‡çš„ä»£ä»·è¿‡å¤§ï¼‰</li>
<li>ç”¨æˆ·å…´è¶£åŠ¨æ€å˜åŒ–ï¼Œè€Œç‰©å“ç‰¹å¾ç›¸å¯¹ç¨³å®šï¼ˆå¯ä»¥ç¦»çº¿å­˜å‚¨ç”¨æˆ·å‘é‡ï¼Œä½†ä¸åˆ©äºæ¨èæ•ˆæœï¼‰</li>
</ul>
<br>
<h6 id="æ¨¡å‹æ›´æ–°">æ¨¡å‹æ›´æ–°</h6>
<br>
<h3 id="å…¶ä»–å¬å›æ¨¡å‹">å…¶ä»–å¬å›æ¨¡å‹</h3>
<h4 id="BM25å¬å›">BM25å¬å›</h4>
<blockquote>
<p>langchainçš„BM25 retrieveré»˜è®¤ä½¿ç”¨çš„preprocessing_funcæ˜¯é€šè¿‡whitespaceåˆ†å‰²stringçš„ï¼Œé€‚ç”¨äºè‹±æ–‡å¥å­ï¼Œä¸é€‚ç”¨äºä¸­æ–‡</p>
</blockquote>
<p>BM25ï¼ˆBest Match 25ï¼‰æ˜¯ä¸€ç§<strong>åŸºäºè¯é¢‘ç»Ÿè®¡</strong>çš„æ–‡æœ¬ç›¸å…³æ€§è®¡ç®—æ¨¡å‹ï¼Œå¹¿æ³›åº”ç”¨äºä¿¡æ¯æ£€ç´¢é¢†åŸŸï¼Œå°¤å…¶åœ¨æ—©æœŸé˜¶æ®µçš„å¬å›ï¼ˆRetrievalï¼‰ç¯èŠ‚ä¸­æ‰®æ¼”é‡è¦è§’è‰²ã€‚å®ƒçš„ç›®æ ‡æ˜¯æ ¹æ®æŸ¥è¯¢ï¼ˆqueryï¼‰å’Œæ–‡æ¡£ï¼ˆdocumentï¼‰ä¸­çš„è¯è¯­åŒ¹é…ç¨‹åº¦ï¼Œç»™æ–‡æ¡£æ‰“åˆ†ï¼Œä»è€Œæ‰¾å‡ºä¸æŸ¥è¯¢æœ€ç›¸å…³çš„æ–‡æ¡£é›†åˆã€‚</p>
<p>è¾“å…¥ æŸ¥è¯¢è¯listï¼Œè¿”å›æ¯ä¸ªæ–‡æ¡£ä¸ æŸ¥è¯¢è¯list çš„åŒ¹é…æ€§åˆ†æ•°ï¼Œåˆ†æ•°è¶Šé«˜åŒ¹é…åº¦è¶Šé«˜</p>
<br>
<p><strong>BM25 çš„æ ¸å¿ƒæ€æƒ³</strong></p>
<p>BM25 çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p>
<ol>
<li><strong>è¯é¢‘ï¼ˆTFï¼‰çš„é‡è¦æ€§ï¼š</strong> ä¸€ä¸ªè¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°è¶Šå¤šï¼Œè¯¥è¯å¯¹äºæ–‡æ¡£çš„é‡è¦æ€§è¶Šé«˜ã€‚</li>
<li><strong>é€†æ–‡æ¡£é¢‘ç‡ï¼ˆIDFï¼‰çš„é‡è¦æ€§ï¼š</strong> ä¸€ä¸ªè¯åœ¨æ•´ä¸ªè¯­æ–™åº“ä¸­å‡ºç°çš„æ–‡æ¡£è¶Šå°‘ï¼Œè¯¥è¯å¯¹äºåŒºåˆ†æ–‡æ¡£çš„é‡è¦æ€§è¶Šé«˜ã€‚</li>
<li><strong>æ–‡æ¡£é•¿åº¦çš„æ ‡å‡†åŒ–ï¼š</strong> çŸ­æ–‡æ¡£å‡ºç°æŸä¸ªè¯çš„é¢‘ç‡å¯èƒ½å¾ˆé«˜ï¼Œä½†ä¸ä¸€å®šæ¯”é•¿æ–‡æ¡£æ›´ç›¸å…³ã€‚BM25 ä¼šå¯¹æ–‡æ¡£é•¿åº¦è¿›è¡Œæ ‡å‡†åŒ–ï¼Œé¿å…é•¿æ–‡æ¡£å¤©ç„¶è·å¾—æ›´é«˜çš„åˆ†æ•°ã€‚</li>
<li><strong>è¯é¢‘é¥±å’Œåº¦ï¼š</strong> 20 ä¸ªâ€œçŒ«â€å­—ä¸ä¸€å®šæ¯” 10 ä¸ªâ€œçŒ«â€å­—æ›´é‡è¦ä¸¤å€ã€‚å½“è¯é¢‘è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œå…¶å¯¹åˆ†æ•°çš„è´¡çŒ®ä¼šé€æ¸å‡å°ã€‚</li>
</ol>
<br>
<p><strong>BM25 çš„è®¡ç®—å…¬å¼</strong></p>
<p>BM25 çš„æ‰“åˆ†å…¬å¼å¦‚ä¸‹ï¼š</p>
<p>$$Score(D, Q) = \sum_{i=1}^{n} IDF(q_i) \cdot \frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{avgDL})}$$</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>
<p>$D$ï¼šæ–‡æ¡£ï¼ˆDocumentï¼‰</p>
</li>
<li>
<p>$Q$ï¼šæŸ¥è¯¢ï¼ˆQueryï¼‰ï¼Œç”± $n$ ä¸ªè¯ $q_1, q_2, â€¦, q_n$ ç»„æˆ</p>
</li>
<li>
<p>$f(q_i, D)$ï¼šæŸ¥è¯¢è¯ $q_i$ åœ¨æ–‡æ¡£ $D$ ä¸­å‡ºç°çš„é¢‘ç‡ï¼ˆTerm Frequency, TFï¼‰</p>
</li>
<li>
<p>$|D|$ï¼šæ–‡æ¡£ $D$ çš„é•¿åº¦ï¼ˆè¯æ•°ï¼‰</p>
</li>
<li>
<p>$avgDL$ï¼šè¯­æ–™åº“ä¸­æ‰€æœ‰æ–‡æ¡£çš„å¹³å‡é•¿åº¦</p>
</li>
<li>
<p><strong>$k_1$ï¼ˆè¯é¢‘é¥±å’Œåº¦å‚æ•°ï¼‰ï¼š</strong></p>
<ul>
<li>é€šå¸¸å–å€¼èŒƒå›´åœ¨ $1.2$ åˆ° $2.0$ ä¹‹é—´ã€‚</li>
<li>$k_1$ è¶Šå¤§ï¼Œè¯é¢‘å¯¹åˆ†æ•°çš„å½±å“è¶Šå¤§ï¼Œç›´åˆ°è¯é¢‘éå¸¸é«˜ã€‚</li>
<li>$k_1$ è¶Šå°ï¼Œè¯é¢‘å¯¹åˆ†æ•°çš„è´¡çŒ®è¶Šå¿«è¾¾åˆ°é¥±å’Œã€‚</li>
<li>$k_1 = 0$ æ—¶ï¼Œå®Œå…¨ä¸è€ƒè™‘è¯é¢‘ã€‚</li>
</ul>
</li>
<li>
<p><strong>$b$ï¼ˆæ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–å‚æ•°ï¼‰ï¼š</strong></p>
<ul>
<li>é€šå¸¸å–å€¼èŒƒå›´åœ¨ $0$ åˆ° $1$ ä¹‹é—´ã€‚</li>
<li>$b = 1$ æ—¶ï¼Œå®Œå…¨æ ¹æ®æ–‡æ¡£é•¿åº¦è¿›è¡Œå½’ä¸€åŒ–ï¼ˆçŸ­æ–‡æ¡£ä¼šå¾—åˆ°ç›¸å¯¹æ›´é«˜çš„åˆ†æ•°ï¼‰ã€‚</li>
<li>$b = 0$ æ—¶ï¼Œä¸è¿›è¡Œæ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–ã€‚</li>
</ul>
</li>
<li>
<p>$IDF(q_i)$ï¼šæŸ¥è¯¢è¯ $q_i$ çš„é€†æ–‡æ¡£é¢‘ç‡ï¼ˆInverse Document Frequencyï¼‰ã€‚é€šå¸¸ä½¿ç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š<br>
$$IDF(q_i) = \log \frac{N - n(q_i) + 0.5}{n(q_i) + 0.5} + 1$$<br>
æˆ–è€…æ›´ç®€å•çš„ï¼š<br>
$$IDF(q_i) = \log \frac{N}{n(q_i)}$$<br>
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å‰è€…ï¼Œå› ä¸ºå®ƒåœ¨å®è·µä¸­è¡¨ç°æ›´å¥½ï¼Œé¿å…äº†å½“ $n(q_i)=0$ æ—¶çš„å¯¹æ•°æ— ç©·å¤§é—®é¢˜ã€‚</p>
<ul>
<li>$N$ï¼šè¯­æ–™åº“ä¸­çš„æ–‡æ¡£æ€»æ•°</li>
<li>$n(q_i)$ï¼šåŒ…å«æŸ¥è¯¢è¯ $q_i$ çš„æ–‡æ¡£æ•°é‡ï¼ˆDocument Frequency, DFï¼‰</li>
</ul>
<p>åŒ…å«æŸ¥è¯¢è¯ $q_i$ çš„æ–‡æ¡£æ•°é‡è¶Šå¤šï¼Œ$IDF(q_i)$ çš„å€¼è¶Šå°</p>
</li>
</ul>
<p>å¯¹äºå…¬å¼çš„å„éƒ¨åˆ†</p>
<ul>
<li>$IDF(q_i)$ æ—¨åœ¨ èµ‹äºˆç¨€æœ‰è¯æ›´é«˜çš„æƒé‡ï¼Œå› ä¸ºç¨€æœ‰è¯æ¯”å¸¸è§è¯æ›´èƒ½åŒºåˆ†æ–‡æ¡£ã€‚
<ul>
<li><strong>åŸç†ï¼š</strong>
<ul>
<li><strong>é€†æ–‡æ¡£é¢‘ç‡ (IDF)ï¼š</strong> è¿™æ˜¯ä¿¡æ¯æ£€ç´¢ä¸­çš„æ ¸å¿ƒæ€æƒ³ã€‚ä¸€ä¸ªè¯åœ¨è¯­æ–™åº“ä¸­å‡ºç°çš„æ–‡æ¡£è¶Šå¤šï¼ˆ$n(q_i)$ è¶Šå¤§ï¼‰ï¼Œå®ƒä½œä¸ºæŸ¥è¯¢è¯æ—¶ï¼Œå…¶åŒºåˆ†æ–‡æ¡£çš„èƒ½åŠ›å°±è¶Šå¼±ï¼Œå› æ­¤æƒé‡åº”è¯¥è¶Šä½ã€‚åä¹‹ï¼Œä¸€ä¸ªè¯åœ¨å°‘é‡æ–‡æ¡£ä¸­å‡ºç°ï¼Œå®ƒå°±æ›´å…·ç‹¬ç‰¹æ€§ï¼Œæ›´èƒ½æŒ‡ç¤ºæ–‡æ¡£çš„ä¸»é¢˜ï¼Œæ‰€ä»¥æƒé‡åº”è¯¥æ›´é«˜ã€‚</li>
<li><strong>å¯¹æ•° (log)ï¼š</strong> ä½¿ç”¨å¯¹æ•°æ˜¯ä¸ºäº†å¹³æ»‘ IDF çš„å€¼ã€‚è¯çš„æ–‡æ¡£é¢‘ç‡åˆ†å¸ƒå¾€å¾€æ˜¯é•¿å°¾çš„ï¼Œç›´æ¥ä½¿ç”¨ $N/n(q_i)$ ä¼šå¯¼è‡´ä¸€äº›æç«¯ç¨€æœ‰è¯çš„ IDF å€¼è¿‡å¤§ï¼Œå¯¹æ€»åˆ†äº§ç”Ÿè¿‡å¤§çš„å½±å“ã€‚å¯¹æ•°å‡½æ•°èƒ½æœ‰æ•ˆç¼©å°é«˜ IDF å€¼çš„å·®è·ï¼Œä½¿å…¶æ›´åŠ ç¨³å®šã€‚</li>
<li><strong>å¹³æ»‘é¡¹ $0.5$ï¼š</strong>
<ul>
<li>åœ¨åˆ†å­å’Œåˆ†æ¯ä¸­éƒ½åŠ ä¸Š $0.5$ (æˆ–å…¶å®ƒå°å¸¸æ•°)ã€‚è¿™è¢«ç§°ä¸º<strong>å¹³æ»‘å¤„ç†</strong>ã€‚</li>
<li><strong>è§£å†³é—®é¢˜1 (Zero Frequency Problem):</strong> å¦‚æœä¸€ä¸ªæŸ¥è¯¢è¯ $q_i$ ä»æœªåœ¨è¯­æ–™åº“ä¸­å‡ºç°è¿‡ï¼Œé‚£ä¹ˆ $n(q_i)$ ä¼šæ˜¯ $0$ã€‚å¦‚æœç›´æ¥ç”¨ $\log(N/n(q_i))$ï¼Œå°±ä¼šå‡ºç°é™¤ä»¥é›¶çš„é—®é¢˜ã€‚åŠ ä¸Š $0.5$ å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚</li>
<li><strong>è§£å†³é—®é¢˜2 (High Frequency Problem):</strong> å¦‚æœä¸€ä¸ªè¯åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­éƒ½å‡ºç° ($n(q_i) = N$)ï¼Œé‚£ä¹ˆåŸå§‹çš„ $\log(N/N) = \log(1) = 0$ã€‚è€ŒåŠ ä¸Šå¹³æ»‘é¡¹åï¼Œåˆ†å­ $N - N + 0.5 = 0.5$ï¼Œåˆ†æ¯ $N + 0.5$ï¼ŒIDF ä¼šæ˜¯ä¸€ä¸ªå¾ˆå°çš„è´Ÿå€¼æˆ–æ¥è¿‘äº0çš„æ•°ã€‚è¿™æ ·ï¼Œå¯¹äºæå…¶å¸¸è§çš„è¯ï¼ˆå¦‚åœç”¨è¯ï¼‰ï¼Œå…¶ IDF è´¡çŒ®ä¼šå˜å¾—éå¸¸å°ï¼Œç¬¦åˆå…¶åŒºåˆ†åº¦ä½çš„ç‰¹æ€§ã€‚</li>
<li><strong>é¢å¤–çš„ $+1$ï¼š</strong> ç¡®ä¿ IDF å€¼ä¸ä¼šæ˜¯è´Ÿæ•°ï¼Œå¹¶ä¸”å¯¹äºéå¸¸å¸¸è§çš„è¯ï¼Œå…¶ IDF ä»ç„¶æ˜¯ä¸€ä¸ªæ­£æ•°ï¼ˆå°½ç®¡éå¸¸å°ï¼‰ï¼Œé¿å…äº†å¯¹æ•°ç»“æœä¸ºé›¶æˆ–è´Ÿæ•°å¯¼è‡´çš„é—®é¢˜ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>åˆ†æ•°éƒ¨åˆ† $\frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{avgDL})}$ ç»“åˆäº†è¯é¢‘ã€è¯é¢‘é¥±å’Œåº¦ã€æ–‡æ¡£é•¿åº¦å’Œæ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–
<ul>
<li>
<p><strong>åˆ†å­ $f(q_i, D) \cdot (k_1 + 1)$ï¼š</strong></p>
<ul>
<li><strong>$f(q_i, D)$ (Term Frequency, TF)ï¼š</strong> æŸ¥è¯¢è¯ $q_i$ åœ¨æ–‡æ¡£ $D$ ä¸­å‡ºç°çš„é¢‘ç‡ã€‚ç›´è§‚ä¸Šï¼Œä¸€ä¸ªè¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°è¶Šå¤šï¼Œæ–‡æ¡£ä¸è¯¥è¯çš„ç›¸å…³æ€§å°±è¶Šå¼ºã€‚</li>
<li><strong>$(k_1 + 1)$ï¼š</strong> è¿™æ˜¯ä¸€ä¸ªå¸¸æ•°å› å­ï¼Œå®ƒç¡®ä¿å½“ $f(q_i, D)$ å¢åŠ æ—¶ï¼Œåˆ†å­ä¹Ÿèƒ½ä»¥çº¿æ€§æ–¹å¼å¢åŠ ï¼Œä¸ºåé¢çš„é¥±å’Œåº¦å‡½æ•°æä¾›ä¸€ä¸ªæ¯”ä¾‹å› å­ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå¯è°ƒå‚æ•°ï¼Œåªæ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚</li>
</ul>
</li>
<li>
<p><strong>åˆ†æ¯ $f(q_i, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{avgDL})$ï¼š</strong><br>
è¿™æ˜¯æ•´ä¸ª BM25 è®¾è®¡çš„ç²¾é«“æ‰€åœ¨ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªå…³é”®çš„ BM25 æ”¹è¿›ç‚¹ï¼š<strong>è¯é¢‘é¥±å’Œåº¦</strong> å’Œ <strong>æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–</strong>ã€‚</p>
<ul>
<li>
<p><strong>$f(q_i, D)$ï¼š</strong> å†æ¬¡å‡ºç°è¯é¢‘ï¼Œåœ¨åˆ†æ¯ä¸­ï¼Œå®ƒçš„å­˜åœ¨ä½¿å¾—æ•´ä¸ªåˆ†å¼è¡¨ç°å‡ºâ€œé¥±å’Œâ€ç‰¹æ€§ã€‚</p>
</li>
<li>
<p><strong>$k_1$ï¼ˆè¯é¢‘é¥±å’Œåº¦å‚æ•°ï¼‰ï¼š</strong></p>
<ul>
<li><strong>è®¾è®¡ç›®çš„ï¼š</strong> è§£å†³ä¼ ç»Ÿ TFï¼ˆå¦‚çº¿æ€§å¢é•¿ï¼‰çš„ä¸è¶³ã€‚BM25 è®¤ä¸ºï¼Œè¯é¢‘å¯¹ç›¸å…³æ€§çš„è´¡çŒ®ä¸æ˜¯çº¿æ€§å¢é•¿çš„ã€‚å½“ä¸€ä¸ªè¯å‡ºç°ä¸€ä¸¤æ¬¡æ—¶ï¼Œæ¯æ¬¡å¢åŠ å…¶å‡ºç°é¢‘ç‡ä¼šæ˜¾è‘—æé«˜ç›¸å…³æ€§ï¼›ä½†å½“è¯¥è¯å‡ºç°å‡ åæ¬¡åï¼Œå†å¢åŠ å…¶å‡ºç°é¢‘ç‡ï¼Œå¯¹ç›¸å…³æ€§çš„é¢å¤–æå‡æ•ˆæœä¼šé€’å‡ï¼Œæœ€ç»ˆè¶‹äºé¥±å’Œã€‚</li>
<li><strong>åŸç†ï¼š</strong>
<ul>
<li>å½“ $f(q_i, D)$ å¾ˆå°æ—¶ï¼Œåˆ†æ¯ä¸»è¦ç”± $k_1 \cdot (\dots)$ é¡¹ä¸»å¯¼ï¼Œæ­¤æ—¶ TF-Component æ¥è¿‘äº $\frac{f(q_i, D) \cdot (k_1 + 1)}{k_1 \cdot (\dots)}$ï¼Œè¡¨ç°å‡ºè¿‘ä¼¼çº¿æ€§çš„å¢é•¿ã€‚</li>
<li>å½“ $f(q_i, D)$ å¾ˆå¤§æ—¶ï¼Œåˆ†æ¯ä¸­çš„ $f(q_i, D)$ ä¼šå˜å¾—å ä¸»å¯¼åœ°ä½ï¼Œæ­¤æ—¶ TF-Component æ¥è¿‘äº $\frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D)} = k_1 + 1$ã€‚è¿™æ„å‘³ç€ï¼Œæ— è®ºè¯é¢‘å¤šé«˜ï¼Œå…¶å¯¹åˆ†æ•°çš„è´¡çŒ®éƒ½ä¸ä¼šè¶…è¿‡ä¸€ä¸ªä¸Šé™å€¼ $(k_1 + 1)$ã€‚</li>
<li>$k_1$ çš„å€¼æ§åˆ¶äº†é¥±å’Œçš„é€Ÿåº¦ã€‚$k_1$ è¶Šå°ï¼Œé¥±å’Œé€Ÿåº¦è¶Šå¿«ï¼ˆå³è¯é¢‘å¯¹åˆ†æ•°çš„è´¡çŒ®è¶Šæ—©è¾¾åˆ°ä¸Šé™ï¼‰ï¼›$k_1$ è¶Šå¤§ï¼Œé¥±å’Œé€Ÿåº¦è¶Šæ…¢ï¼ˆè¯é¢‘å¯¹åˆ†æ•°çš„è´¡çŒ®å¯ä»¥æŒç»­æ›´ä¹…ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>$(1 - b + b \cdot \frac{|D|}{avgDL})$ï¼ˆæ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–é¡¹ï¼‰ï¼š</strong></p>
<ul>
<li><strong>è®¾è®¡ç›®çš„ï¼š</strong> è§£å†³é•¿æ–‡æ¡£åœ¨ TF-IDF ä¸­å¯èƒ½å¤©ç„¶è·å¾—æ›´é«˜åˆ†æ•°çš„åè§ã€‚åœ¨æ²¡æœ‰é•¿åº¦å½’ä¸€åŒ–çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé•¿æ–‡æ¡£å› ä¸ºè¯æ±‡é‡å¤§ï¼Œæ›´å®¹æ˜“åŒ…å«æŸä¸ªæŸ¥è¯¢è¯ï¼Œè€Œä¸”å³ä¾¿æŸä¸ªè¯åªå‡ºç°ä¸€æ¬¡ï¼Œä½†ç”±äºæ–‡æ¡£æ€»è¯æ•°å¤šï¼Œå…¶ TF å€¼ä¹Ÿå¯èƒ½è¢«ç¨€é‡Šã€‚æ›´é‡è¦çš„æ˜¯ï¼Œé•¿æ–‡æ¡£æ›´å®¹æ˜“å‡ºç°æŸ¥è¯¢è¯ï¼Œä½†å¹¶ä¸æ„å‘³ç€å®ƒå°±æ¯”çŸ­æ–‡æ¡£æ›´ç›¸å…³ã€‚</li>
<li><strong>åŸç†ï¼š</strong>
<ul>
<li><strong>$|D|$ï¼š</strong> å½“å‰æ–‡æ¡£çš„é•¿åº¦ï¼ˆè¯æ•°ï¼‰ã€‚</li>
<li><strong>$avgDL$ï¼š</strong> è¯­æ–™åº“ä¸­æ‰€æœ‰æ–‡æ¡£çš„å¹³å‡é•¿åº¦ã€‚</li>
<li><strong>$\frac{|D|}{avgDL}$ï¼š</strong> è¿™ä¸ªæ¯”å€¼è¡¡é‡äº†å½“å‰æ–‡æ¡£ç›¸å¯¹äºå¹³å‡æ–‡æ¡£æ˜¯é•¿è¿˜æ˜¯çŸ­ã€‚
<ul>
<li>å¦‚æœ $|D| &gt; avgDL$ï¼Œåˆ™ $\frac{|D|}{avgDL} &gt; 1$ã€‚</li>
<li>å¦‚æœ $|D| &lt; avgDL$ï¼Œåˆ™ $\frac{|D|}{avgDL} &lt; 1$ã€‚</li>
</ul>
</li>
<li><strong>$b$ï¼ˆæ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–å‚æ•°ï¼‰ï¼š</strong>
<ul>
<li><strong>è®¾è®¡ä½œç”¨ï¼š</strong> æ§åˆ¶æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–çš„ç¨‹åº¦ã€‚</li>
<li>å½“ $b=0$ æ—¶ï¼šæ•´ä¸ªé¡¹å˜ä¸º $(1 - 0 + 0 \cdot \frac{|D|}{avgDL}) = 1$ã€‚æ­¤æ—¶åˆ†æ¯ä¸­çš„ $k_1 \cdot (\dots)$ é¡¹ç®€åŒ–ä¸º $k_1$ï¼Œå®Œå…¨ä¸è€ƒè™‘æ–‡æ¡£é•¿åº¦ã€‚</li>
<li>å½“ $b=1$ æ—¶ï¼šæ•´ä¸ªé¡¹å˜ä¸º $(1 - 1 + 1 \cdot \frac{|D|}{avgDL}) = \frac{|D|}{avgDL}$ã€‚æ­¤æ—¶åˆ†æ¯ä¸­çš„ $k_1 \cdot (\dots)$ é¡¹å˜ä¸º $k_1 \cdot \frac{|D|}{avgDL}$ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªæ–‡æ¡£æ¯”å¹³å‡æ–‡æ¡£é•¿ï¼Œé‚£ä¹ˆåˆ†æ¯ä¼šå˜å¤§ï¼Œå¯¼è‡´æ•´ä¸ª TF-Component å˜å°ï¼Œä»è€Œé™ä½è¯¥æ–‡æ¡£çš„åˆ†æ•°ã€‚åä¹‹ï¼Œå¦‚æœæ–‡æ¡£æ¯”å¹³å‡æ–‡æ¡£çŸ­ï¼Œåˆ†æ¯ä¼šå˜å°ï¼Œåˆ†æ•°ä¼šå‡é«˜ã€‚</li>
<li>é€šå¸¸ $b$ å– $0.75$ï¼Œè¿™æ„å‘³ç€é•¿åº¦å½’ä¸€åŒ–æ˜¯é€‚åº¦çš„ï¼Œè€Œä¸æ˜¯å®Œå…¨çš„ã€‚</li>
</ul>
</li>
<li><strong>æ•´ä½“æ•ˆæœï¼š</strong> è¿™ä¸ªé•¿åº¦å½’ä¸€åŒ–é¡¹ä¼šå½±å“åˆ†æ¯çš„å¤§å°ã€‚
<ul>
<li>å¯¹äº<strong>é•¿æ–‡æ¡£</strong>ï¼ˆ$|D| &gt; avgDL$ï¼‰ï¼Œè¿™ä¸ªé¡¹ä¼šå¤§äº 1ï¼Œä½¿å¾—åˆ†æ¯å˜å¤§ï¼Œä»è€Œ<strong>é™ä½</strong>æ•´ä¸ª TF-Component çš„å€¼ã€‚</li>
<li>å¯¹äº<strong>çŸ­æ–‡æ¡£</strong>ï¼ˆ$|D| &lt; avgDL$ï¼‰ï¼Œè¿™ä¸ªé¡¹ä¼šå°äº 1ï¼Œä½¿å¾—åˆ†æ¯å˜å°ï¼Œä»è€Œ<strong>æé«˜</strong>æ•´ä¸ª TF-Component çš„å€¼ã€‚</li>
</ul>
</li>
<li><strong>ä¼˜åŠ¿ï¼š</strong> è¿™ç§è®¾è®¡ä½¿å¾—çŸ­æ–‡æ¡£åœ¨åŒ…å«æŸ¥è¯¢è¯æ—¶ï¼Œå…¶ç›¸å…³æ€§åˆ†æ•°ä¸ä¼šè¢«é•¿æ–‡æ¡£çš„â€œè¯æ±‡é‡ä¼˜åŠ¿â€æ‰€æ©ç›–ï¼Œæ›´å…¬å¹³åœ°è¯„ä¼°å…¶ç›¸å…³æ€§ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br>
<p><strong>BM25 å¬å›çš„æ­¥éª¤</strong></p>
<ol>
<li><strong>æ–‡æœ¬é¢„å¤„ç†ï¼š</strong> å¯¹æ‰€æœ‰æ–‡æ¡£å’ŒæŸ¥è¯¢è¿›è¡Œåˆ†è¯ã€å»é™¤åœç”¨è¯ã€è¯å¹²åŒ–/è¯å½¢è¿˜åŸç­‰æ“ä½œã€‚</li>
<li><strong>æ„å»ºå€’æ’ç´¢å¼•ï¼š</strong> ä¸ºäº†é«˜æ•ˆè®¡ç®— $f(q_i, D)$ å’Œ $n(q_i)$ï¼Œé€šå¸¸éœ€è¦æ„å»ºå€’æ’ç´¢å¼•ã€‚å€’æ’ç´¢å¼•ä¼šå­˜å‚¨æ¯ä¸ªè¯å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ä¸­ï¼Œä»¥åŠåœ¨è¯¥æ–‡æ¡£ä¸­å‡ºç°çš„é¢‘ç‡ã€‚</li>
<li><strong>è®¡ç®—æ‰€æœ‰è¯çš„ IDF å€¼ï¼š</strong> éå†æ•´ä¸ªè¯­æ–™åº“ï¼Œç»Ÿè®¡æ¯ä¸ªè¯çš„æ–‡æ¡£é¢‘ç‡ï¼Œç„¶åè®¡ç®—å…¶ IDF å€¼ã€‚</li>
<li><strong>è®¡ç®—å¹³å‡æ–‡æ¡£é•¿åº¦ï¼š</strong> éå†æ‰€æœ‰æ–‡æ¡£ï¼Œè®¡ç®—å…¶é•¿åº¦ï¼Œç„¶åæ±‚å¹³å‡å€¼ã€‚</li>
<li><strong>å¤„ç†æŸ¥è¯¢ï¼š</strong>
<ul>
<li>å¯¹æŸ¥è¯¢è¿›è¡Œé¢„å¤„ç†ã€‚</li>
<li>å¯¹äºæŸ¥è¯¢ä¸­çš„æ¯ä¸ªè¯ $q_i$ï¼ŒæŸ¥æ‰¾å…¶åœ¨æ¯ä¸ªæ–‡æ¡£ $D$ ä¸­çš„é¢‘ç‡ $f(q_i, D)$ã€‚</li>
<li>ä½¿ç”¨ä¸Šè¿° BM25 å…¬å¼ï¼Œè®¡ç®—æŸ¥è¯¢ä¸æ¯ä¸ªæ–‡æ¡£ä¹‹é—´çš„åˆ†æ•°ã€‚</li>
</ul>
</li>
<li><strong>æ’åºå¹¶è¿”å›ï¼š</strong> æ ¹æ®è®¡ç®—å‡ºçš„åˆ†æ•°ï¼Œå¯¹æ–‡æ¡£è¿›è¡Œé™åºæ’åºï¼Œè¿”å›å¾—åˆ†æœ€é«˜çš„ K ä¸ªæ–‡æ¡£ã€‚</li>
</ol>
<br>
<p><strong>ä¸¾ä¾‹è¯¦è§£ BM25 å¬å›ï¼ˆPython å®ç°ï¼‰</strong></p>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥æ¼”ç¤º BM25 å¬å›ã€‚</p>
<p><strong>è¯­æ–™åº“ (Corpus):</strong></p>
<ol>
<li>â€œThe quick brown fox jumps over the lazy dog.â€</li>
<li>â€œA dog is a manâ€™s best friend.â€</li>
<li>â€œFoxes are clever animals.â€</li>
<li>â€œThe quick brown fox.â€</li>
</ol>
<p><strong>æŸ¥è¯¢ (Query):</strong> â€œquick foxâ€</p>
<br>
<p><strong>Python å®ç°</strong></p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ <code>nltk</code> è¿›è¡Œåˆ†è¯ï¼Œå¹¶æ‰‹åŠ¨å®ç° BM25 ç®—æ³•ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨ <code>gensim</code> åº“ï¼Œå®ƒå†…ç½®äº† BM25 å®ç°ï¼Œæ›´åŠ é«˜æ•ˆã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</span><br><span class="line"><span class="keyword">from</span> nltk.corpus <span class="keyword">import</span> stopwords</span><br><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line"></span><br><span class="line">nltk.download(<span class="string">&#x27;punkt_tab&#x27;</span>)</span><br><span class="line">nltk.download(<span class="string">&#x27;stopwords&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æ–‡æœ¬é¢„å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess_text</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="comment"># è½¬ä¸ºå°å†™</span></span><br><span class="line">    text = text.lower()</span><br><span class="line">    <span class="comment"># åˆ†è¯</span></span><br><span class="line">    tokens = word_tokenize(text)</span><br><span class="line">    <span class="comment"># ç§»é™¤æ ‡ç‚¹ç¬¦å·å’Œæ•°å­— (å¯é€‰ï¼Œæ ¹æ®éœ€æ±‚)</span></span><br><span class="line">    tokens = [word <span class="keyword">for</span> word <span class="keyword">in</span> tokens <span class="keyword">if</span> word.isalpha()]</span><br><span class="line">    <span class="comment"># ç§»é™¤åœç”¨è¯ (å¯é€‰ï¼Œæ ¹æ®éœ€æ±‚)</span></span><br><span class="line">    stop_words = <span class="built_in">set</span>(stopwords.words(<span class="string">&#x27;english&#x27;</span>))</span><br><span class="line">    tokens = [word <span class="keyword">for</span> word <span class="keyword">in</span> tokens <span class="keyword">if</span> word <span class="keyword">not</span> <span class="keyword">in</span> stop_words]</span><br><span class="line">    <span class="keyword">return</span> tokens</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ„å»ºè¯­æ–™åº“å’Œè¯æ±‡è¡¨</span></span><br><span class="line">corpus = [</span><br><span class="line">    <span class="string">&quot;The quick brown fox jumps over the lazy dog.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A dog is a man&#x27;s best friend.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Foxes are clever animals.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;The quick brown fox.&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„å¤„ç†æ‰€æœ‰æ–‡æ¡£</span></span><br><span class="line">processed_corpus = [preprocess_text(doc) <span class="keyword">for</span> doc <span class="keyword">in</span> corpus]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;--- é¢„å¤„ç†åçš„æ–‡æ¡£ ---&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(processed_corpus):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Doc <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;doc&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¡ç®—æ–‡æ¡£é¢‘ç‡ (DF) å’Œ è¯é¢‘ (TF)</span></span><br><span class="line"><span class="comment"># doc_freq: å­˜å‚¨æ¯ä¸ªè¯åœ¨å¤šå°‘ä¸ªæ–‡æ¡£ä¸­å‡ºç°</span></span><br><span class="line">doc_freq = defaultdict(<span class="built_in">int</span>)</span><br><span class="line"><span class="comment"># term_freqs: å­˜å‚¨æ¯ä¸ªæ–‡æ¡£ä¸­æ¯ä¸ªè¯çš„é¢‘ç‡ &#123;doc_id: &#123;word: count&#125;&#125;</span></span><br><span class="line">term_freqs = []</span><br><span class="line"><span class="comment"># doc_lengths: å­˜å‚¨æ¯ä¸ªæ–‡æ¡£çš„é•¿åº¦</span></span><br><span class="line">doc_lengths = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, doc_tokens <span class="keyword">in</span> <span class="built_in">enumerate</span>(processed_corpus):</span><br><span class="line">    doc_len = <span class="built_in">len</span>(doc_tokens)</span><br><span class="line">    doc_lengths.append(doc_len)</span><br><span class="line"></span><br><span class="line">    current_doc_tf = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">    unique_words_in_doc = <span class="built_in">set</span>() <span class="comment"># ç”¨äºç»Ÿè®¡doc_freq</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> token <span class="keyword">in</span> doc_tokens:</span><br><span class="line">        current_doc_tf[token] += <span class="number">1</span></span><br><span class="line">        unique_words_in_doc.add(token)</span><br><span class="line"></span><br><span class="line">    term_freqs.append(current_doc_tf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> unique_words_in_doc:</span><br><span class="line">        doc_freq[word] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">N = <span class="built_in">len</span>(corpus) <span class="comment"># æ–‡æ¡£æ€»æ•°</span></span><br><span class="line">avgDL = <span class="built_in">sum</span>(doc_lengths) / N <span class="comment"># å¹³å‡æ–‡æ¡£é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ–‡æ¡£æ€»æ•° (N): <span class="subst">&#123;N&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;å¹³å‡æ–‡æ¡£é•¿åº¦ (avgDL): <span class="subst">&#123;avgDL:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;--- è¯çš„æ–‡æ¡£é¢‘ç‡ (DF) ---&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> word, df <span class="keyword">in</span> doc_freq.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;&#x27;<span class="subst">&#123;word&#125;</span>&#x27;: <span class="subst">&#123;df&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. è®¡ç®— IDF (Inverse Document Frequency)</span></span><br><span class="line"><span class="comment"># IDF(q_i) = log((N - n(q_i) + 0.5) / (n(q_i) + 0.5)) + 1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_idf</span>(<span class="params">word, N, doc_freq</span>):</span><br><span class="line">    n_qi = doc_freq.get(word, <span class="number">0</span>) <span class="comment"># åŒ…å«è¯çš„æ–‡æ¡£æ•°é‡</span></span><br><span class="line">    <span class="keyword">return</span> math.log((N - n_qi + <span class="number">0.5</span>) / (n_qi + <span class="number">0.5</span>)) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. å®ç° BM25 è¯„åˆ†å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bm25_score</span>(<span class="params">query_tokens, doc_id, k1, b, N, avgDL, term_freqs, doc_freq, doc_lengths</span>):</span><br><span class="line">    score = <span class="number">0.0</span></span><br><span class="line">    current_doc_tf = term_freqs[doc_id]</span><br><span class="line">    doc_len = doc_lengths[doc_id]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> q_i <span class="keyword">in</span> query_tokens:</span><br><span class="line">        <span class="comment"># å¦‚æœæŸ¥è¯¢è¯ä¸åœ¨æ–‡æ¡£ä¸­ï¼Œè·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> q_i <span class="keyword">not</span> <span class="keyword">in</span> current_doc_tf:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        f_qi_D = current_doc_tf[q_i] <span class="comment"># è¯ q_i åœ¨æ–‡æ¡£ D ä¸­çš„é¢‘ç‡</span></span><br><span class="line">        idf_qi = calculate_idf(q_i, N, doc_freq)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®— BM25 çš„ TF éƒ¨åˆ†</span></span><br><span class="line">        tf_component = (f_qi_D * (k1 + <span class="number">1</span>)) / (f_qi_D + k1 * (<span class="number">1</span> - b + b * (doc_len / avgDL)))</span><br><span class="line">        </span><br><span class="line">        score += idf_qi * tf_component</span><br><span class="line">    <span class="keyword">return</span> score</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. å®šä¹‰å‚æ•°</span></span><br><span class="line">k1 = <span class="number">1.5</span> <span class="comment"># è¯é¢‘é¥±å’Œåº¦å‚æ•°ï¼Œå¸¸ç”¨èŒƒå›´ 1.2 - 2.0</span></span><br><span class="line">b = <span class="number">0.75</span> <span class="comment"># æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–å‚æ•°ï¼Œå¸¸ç”¨èŒƒå›´ 0 - 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. æ‰§è¡ŒæŸ¥è¯¢</span></span><br><span class="line">query = <span class="string">&quot;quick fox&quot;</span></span><br><span class="line">processed_query = preprocess_text(query)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æŸ¥è¯¢ (Query): &#x27;<span class="subst">&#123;query&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;é¢„å¤„ç†åçš„æŸ¥è¯¢: <span class="subst">&#123;processed_query&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">results = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">    score = bm25_score(processed_query, i, k1, b, N, avgDL, term_freqs, doc_freq, doc_lengths)</span><br><span class="line">    results.append((score, i, corpus[i]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. æ’åºå¹¶è¾“å‡ºç»“æœ</span></span><br><span class="line">results.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;--- BM25 å¬å›ç»“æœ ---&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> score, doc_id, original_doc <span class="keyword">in</span> results:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ–‡æ¡£ ID: <span class="subst">&#123;doc_id+<span class="number">1</span>&#125;</span>, åˆ†æ•°: <span class="subst">&#123;score:<span class="number">.4</span>f&#125;</span>, æ–‡æ¡£å†…å®¹: &#x27;<span class="subst">&#123;original_doc&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>è¿è¡Œç»“æœå’Œåˆ†æ</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--- é¢„å¤„ç†åçš„æ–‡æ¡£ ---</span><br><span class="line">Doc 1: [&#x27;quick&#x27;, &#x27;brown&#x27;, &#x27;fox&#x27;, &#x27;jumps&#x27;, &#x27;lazy&#x27;, &#x27;dog&#x27;]</span><br><span class="line">Doc 2: [&#x27;dog&#x27;, &#x27;man&#x27;, &#x27;best&#x27;, &#x27;friend&#x27;]</span><br><span class="line">Doc 3: [&#x27;foxes&#x27;, &#x27;clever&#x27;, &#x27;animals&#x27;]</span><br><span class="line">Doc 4: [&#x27;quick&#x27;, &#x27;brown&#x27;, &#x27;fox&#x27;]</span><br><span class="line">------------------------------</span><br><span class="line">æ–‡æ¡£æ€»æ•° (N): 4</span><br><span class="line">å¹³å‡æ–‡æ¡£é•¿åº¦ (avgDL): 4.00</span><br><span class="line">--- è¯çš„æ–‡æ¡£é¢‘ç‡ (DF) ---</span><br><span class="line">&#x27;brown&#x27;: 2</span><br><span class="line">&#x27;jumps&#x27;: 1</span><br><span class="line">&#x27;dog&#x27;: 2</span><br><span class="line">&#x27;fox&#x27;: 2</span><br><span class="line">&#x27;lazy&#x27;: 1</span><br><span class="line">&#x27;quick&#x27;: 2</span><br><span class="line">&#x27;best&#x27;: 1</span><br><span class="line">&#x27;man&#x27;: 1</span><br><span class="line">&#x27;friend&#x27;: 1</span><br><span class="line">&#x27;foxes&#x27;: 1</span><br><span class="line">&#x27;clever&#x27;: 1</span><br><span class="line">&#x27;animals&#x27;: 1</span><br><span class="line">------------------------------</span><br><span class="line">æŸ¥è¯¢ (Query): &#x27;quick fox&#x27;</span><br><span class="line">é¢„å¤„ç†åçš„æŸ¥è¯¢: [&#x27;quick&#x27;, &#x27;fox&#x27;]</span><br><span class="line">------------------------------</span><br><span class="line">--- BM25 å¬å›ç»“æœ ---</span><br><span class="line">æ–‡æ¡£ ID: 4, åˆ†æ•°: 2.2535, æ–‡æ¡£å†…å®¹: &#x27;The quick brown fox.&#x27;</span><br><span class="line">æ–‡æ¡£ ID: 1, åˆ†æ•°: 1.6327, æ–‡æ¡£å†…å®¹: &#x27;The quick brown fox jumps over the lazy dog.&#x27;</span><br><span class="line">æ–‡æ¡£ ID: 2, åˆ†æ•°: 0.0000, æ–‡æ¡£å†…å®¹: &#x27;A dog is a man&#x27;s best friend.&#x27;</span><br><span class="line">æ–‡æ¡£ ID: 3, åˆ†æ•°: 0.0000, æ–‡æ¡£å†…å®¹: &#x27;Foxes are clever animals.&#x27;</span><br></pre></td></tr></table></figure>
<br>
<h4 id="åœ°ç†ä½ç½®å¬å›">åœ°ç†ä½ç½®å¬å›</h4>
<br>
<h4 id="å…³æ³¨è€…å¬å›">å…³æ³¨è€…å¬å›</h4>
<br>
<h4 id="ç¼“å­˜å¬å›">ç¼“å­˜å¬å›</h4>
<br>
<br>
<h2 id="æ’åº">æ’åº</h2>
<h3 id="GBDT-LR">GBDT+LR</h3>
<br>
<br>
<h3 id="ç‰¹å¾äº¤å‰">ç‰¹å¾äº¤å‰</h3>
<br>
<br>
<h3 id="åºåˆ—æ¨¡å‹">åºåˆ—æ¨¡å‹</h3>
<br>
<h3 id="å¤šä»»åŠ¡å­¦ä¹ ">å¤šä»»åŠ¡å­¦ä¹ </h3>
<br>
<h2 id="é‡æ’">é‡æ’</h2>
<br>
<h3 id="RRFç®—æ³•">RRFç®—æ³•</h3>
<p>RRFç®—æ³•çš„ç›®çš„æ˜¯ç”Ÿæˆä¸€ä¸ª <strong>æœ‰åºä¸”å—åˆ°é™åˆ¶çš„é‡æ’åºåˆ—</strong>ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªé€šç”¨çš„éšæœºæ’åˆ—ç®—æ³•ï¼Œè€Œæ˜¯é’ˆå¯¹ <strong>æ’åä¿¡æ¯</strong> å’Œ <strong>é™åˆ¶æ¡ä»¶</strong> è¿›è¡Œé‡æ’åˆ—çš„ã€‚å¯ä»¥ç†è§£ä¸ºï¼šåœ¨ä¸€ä¸ªå·²æ’åºçš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œ<strong>å±€éƒ¨è°ƒæ•´</strong>ï¼Œä»¥è¾¾åˆ°æŸç§ä¼˜åŒ–ç›®æ ‡ã€‚</p>
<br>
<h2 id="ç‰©å“å†·å¯åŠ¨">ç‰©å“å†·å¯åŠ¨</h2>
<br>
<br>]]></content>
      <categories>
        <category>SAR</category>
      </categories>
      <tags>
        <tag>Python, LLM</tag>
      </tags>
  </entry>
  <entry>
    <title>Trae &amp; Claude Task Master 4 Develop</title>
    <url>/2025/07/13/Trae-Claude-Task-Master-4-Develop/</url>
    <content><![CDATA[<p>AI-Agent workflow Record</p>
<span id="more"></span>
<h1>Trae &amp; Claude Task Master 4 Develop</h1>
<h2 id="ç›¸å…³å·¥å…·">ç›¸å…³å·¥å…·</h2>
<p>Traeä¸ºå­—èŠ‚å¼€å‘çš„<strong>Intelligence IDE</strong>  ref: <a href="https://www.trae.ai/">https://www.trae.ai/</a></p>
<blockquote>
<p>Q: ä¸ºä»€ä¹ˆé€‰æ‹©Traeï¼Ÿ</p>
<p>A: å› ä¸ºæœ¬äººäº‹å­¦ç”Ÿæ‰€ä»¥Traeæ¯«æ— ç–‘é—®æ˜¯æœ€ä¾¿å®œçš„IDE</p>
<p>å¯¹æ¯”é€‰æ‹©</p>
<ul>
<li>cursor è´µ</li>
<li>windsurf ï¼ˆå›¢é˜Ÿå¥½åƒéƒ½è¦è·‘è·¯äº†ç°åœ¨å¼€proç–‘ä¼¼æœ‰ç‚¹å±é™©</li>
<li>Claude Code å°å·ç‹ï¼Œæ²¡æœ‰çº¯å‡€IPä¸å»ºè®®</li>
<li>Gemini Code ä¸ªäººæ²¡è¯•è¿‡</li>
</ul>
</blockquote>
<p>Claude Task Masterä¸ºé¡¹ç›®çº§ä»»åŠ¡ç®¡ç†MCP ref: <a href="https://github.com/eyaltoledano/claude-task-master">https://github.com/eyaltoledano/claude-task-master</a></p>
<blockquote>
<p>è¿™é‡Œä¸å¾—ä¸åæ§½ä¸€å¥ï¼šå› ä¸ºClaude Task Masteræ˜¯ä½œä¸ºMCPä½¿ç”¨çš„ï¼Œå®ƒçš„æ–‡æ¡£å†™çš„çœŸçš„æ˜¯â€¦ï¼ˆå› ä¸ºç»™AIçœ‹æ‰€ä»¥å°±ä¸å¥½å¥½å†™æ–‡æ¡£äº†æ˜¯å§</p>
</blockquote>
<br>
<p><strong>CTMåŠŸèƒ½åˆ†æ</strong></p>
<p><strong>å¯ç”¨å·¥å…·</strong></p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713145216113.png" class="" title="image-20250713145216113">
<br>
<p><strong>æ ¸å¿ƒåŠŸèƒ½</strong></p>
<ol>
<li>é¡¹ç›®åˆå§‹åŒ–</li>
</ol>
<p>åˆ›å»ºæ–‡ä»¶å¤¹ <code>.taskmaster</code> å’Œ <code>.xxx</code>(å¯¹åº”IDE rules)</p>
<p><code>.taskmaster</code></p>
<ul>
<li><code>config.json</code> é…ç½®å„æ¨¡å¼ä½¿ç”¨LLM</li>
<li><code>templates</code> PRDæ–‡æ¡£æ¨¡æ¿</li>
<li><code>tasks</code> åŒ…å«æ–‡ä»¶ <code>tasks.json</code> PRDæ–‡æ¡£è§£æåå¾—åˆ°çš„ä»»åŠ¡åˆ—è¡¨</li>
<li><code>docs</code> ç”¨æˆ·è‡ªè¡Œåˆ›å»ºæ–‡ä»¶ <code>prd.txt</code></li>
</ul>
<p><code>.xxx</code>(å¯¹åº”IDE rules)</p>
<ul>
<li><code>rules</code> IDEåŸºæœ¬è§„åˆ™ï¼Œå‚è€ƒ<a href="https://docs.cursor.com/context/rules">cursor rules</a>, <a href="https://docs.trae.ai/ide/rules-for-ai">trae rules</a> å’Œ <a href="https://github.com/PatrickJS/awesome-cursorrules">rulesç¼–å†™</a></li>
<li><code>mcp.json</code> é…ç½®LLM API key</li>
</ul>
<br>
<ol start="2">
<li>PRDæ–‡æ¡£è§£æ</li>
</ol>
<p>PRDæ–‡æ¡£è§£æä½¿ç”¨é¡¹ç›®åˆå§‹åŒ–åçš„ <code>.taskmaster\config.json</code> é…ç½®å¯ç”¨LLMï¼Œä½¿ç”¨ä»¥ä¸‹Promptå®ç°æ–‡æ¡£è§£æåŠŸèƒ½ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;system&quot;</span><span class="punctuation">:</span> <span class="string">&quot;You are an AI assistant specialized in analyzing Product Requirements Documents (PRDs) and generating a structured, logically ordered, dependency-aware and sequenced list of development tasks in JSON format.&#123;&#123;#if research&#125;&#125;\nBefore breaking down the PRD into tasks, you will:\n1. Research and analyze the latest technologies, libraries, frameworks, and best practices that would be appropriate for this project\n2. Identify any potential technical challenges, security concerns, or scalability issues not explicitly mentioned in the PRD without discarding any explicit requirements or going overboard with complexity -- always aim to provide the most direct path to implementation, avoiding over-engineering or roundabout approaches\n3. Consider current industry standards and evolving trends relevant to this project (this step aims to solve LLM hallucinations and out of date information due to training data cutoff dates)\n4. Evaluate alternative implementation approaches and recommend the most efficient path\n5. Include specific library versions, helpful APIs, and concrete implementation guidance based on your research\n6. Always aim to provide the most direct path to implementation, avoiding over-engineering or roundabout approaches\n\nYour task breakdown should incorporate this research, resulting in more detailed implementation guidance, more accurate dependency mapping, and more precise technology recommendations than would be possible from the PRD text alone, while maintaining all explicit requirements and best practices and all details and nuances of the PRD.&#123;&#123;/if&#125;&#125;\n\nAnalyze the provided PRD content and generate &#123;&#123;#if (gt numTasks 0)&#125;&#125;approximately &#123;&#123;numTasks&#125;&#125;&#123;&#123;else&#125;&#125;an appropriate number of&#123;&#123;/if&#125;&#125; top-level development tasks. If the complexity or the level of detail of the PRD is high, generate more tasks relative to the complexity of the PRD\nEach task should represent a logical unit of work needed to implement the requirements and focus on the most direct and effective way to implement the requirements without unnecessary complexity or overengineering. Include pseudo-code, implementation details, and test strategy for each task. Find the most up to date information to implement each task.\nAssign sequential IDs starting from &#123;&#123;nextId&#125;&#125;. Infer title, description, details, and test strategy for each task based *only* on the PRD content.\nSet status to &#x27;pending&#x27;, dependencies to an empty array [], and priority to &#x27;&#123;&#123;defaultTaskPriority&#125;&#125;&#x27; initially for all tasks.\nRespond ONLY with a valid JSON object containing a single key \&quot;tasks\&quot;, where the value is an array of task objects adhering to the provided Zod schema. Do not include any explanation or markdown formatting.\n\nEach task should follow this JSON structure:\n&#123;\n\t\&quot;id\&quot;: number,\n\t\&quot;title\&quot;: string,\n\t\&quot;description\&quot;: string,\n\t\&quot;status\&quot;: \&quot;pending\&quot;,\n\t\&quot;dependencies\&quot;: number[] (IDs of tasks this depends on),\n\t\&quot;priority\&quot;: \&quot;high\&quot; | \&quot;medium\&quot; | \&quot;low\&quot;,\n\t\&quot;details\&quot;: string (implementation details),\n\t\&quot;testStrategy\&quot;: string (validation approach)\n&#125;\n\nGuidelines:\n1. &#123;&#123;#if (gt numTasks 0)&#125;&#125;Unless complexity warrants otherwise&#123;&#123;else&#125;&#125;Depending on the complexity&#123;&#123;/if&#125;&#125;, create &#123;&#123;#if (gt numTasks 0)&#125;&#125;exactly &#123;&#123;numTasks&#125;&#125;&#123;&#123;else&#125;&#125;an appropriate number of&#123;&#123;/if&#125;&#125; tasks, numbered sequentially starting from &#123;&#123;nextId&#125;&#125;\n2. Each task should be atomic and focused on a single responsibility following the most up to date best practices and standards\n3. Order tasks logically - consider dependencies and implementation sequence\n4. Early tasks should focus on setup, core functionality first, then advanced features\n5. Include clear validation/testing approach for each task\n6. Set appropriate dependency IDs (a task can only depend on tasks with lower IDs, potentially including existing tasks with IDs less than &#123;&#123;nextId&#125;&#125; if applicable)\n7. Assign priority (high/medium/low) based on criticality and dependency order\n8. Include detailed implementation guidance in the \&quot;details\&quot; field&#123;&#123;#if research&#125;&#125;, with specific libraries and version recommendations based on your research&#123;&#123;/if&#125;&#125;\n9. If the PRD contains specific requirements for libraries, database schemas, frameworks, tech stacks, or any other implementation details, STRICTLY ADHERE to these requirements in your task breakdown and do not discard them under any circumstance\n10. Focus on filling in any gaps left by the PRD or areas that aren&#x27;t fully specified, while preserving all explicit requirements\n11. Always aim to provide the most direct path to implementation, avoiding over-engineering or roundabout approaches&#123;&#123;#if research&#125;&#125;\n12. For each task, include specific, actionable guidance based on current industry standards and best practices discovered through research&#123;&#123;/if&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Here&#x27;s the Product Requirements Document (PRD) to break down into &#123;&#123;#if (gt numTasks 0)&#125;&#125;approximately &#123;&#123;numTasks&#125;&#125;&#123;&#123;else&#125;&#125;an appropriate number of&#123;&#123;/if&#125;&#125; tasks, starting IDs from &#123;&#123;nextId&#125;&#125;:&#123;&#123;#if research&#125;&#125;\n\nRemember to thoroughly research current best practices and technologies before task breakdown to provide specific, actionable implementation details.&#123;&#123;/if&#125;&#125;\n\n&#123;&#123;prdContent&#125;&#125;\n\n\n\t\tReturn your response in this format:\n&#123;\n    \&quot;tasks\&quot;: [\n        &#123;\n            \&quot;id\&quot;: 1,\n            \&quot;title\&quot;: \&quot;Setup Project Repository\&quot;,\n            \&quot;description\&quot;: \&quot;...\&quot;,\n            ...\n        &#125;,\n        ...\n    ],\n    \&quot;metadata\&quot;: &#123;\n        \&quot;projectName\&quot;: \&quot;PRD Implementation\&quot;,\n        \&quot;totalTasks\&quot;: &#123;&#123;#if (gt numTasks 0)&#125;&#125;&#123;&#123;numTasks&#125;&#125;&#123;&#123;else&#125;&#125;&#123;number of tasks&#125;&#123;&#123;/if&#125;&#125;,\n        \&quot;sourceFile\&quot;: \&quot;&#123;&#123;prdPath&#125;&#125;\&quot;,\n        \&quot;generatedAt\&quot;: \&quot;YYYY-MM-DD\&quot;\n    &#125;\n&#125;&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<br>
<h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h2>
<p>ç”±äºTrae MCPå¸‚åœºæš‚æ— CTMï¼Œå› æ­¤æ‰‹åŠ¨å®‰è£…</p>
<p>å‘½ä»¤è¡Œå®‰è£…</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Install globally</span></span><br><span class="line">npm install <span class="literal">-g</span> task<span class="literal">-master-ai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OR install locally within your project</span></span><br><span class="line">npm install task<span class="literal">-master-ai</span></span><br></pre></td></tr></table></figure>
<p>é…ç½®MCP</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713151404427.png" class="" title="image-20250713151404427">
<p>Configure Manually</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713151435125.png" class="" title="image-20250713151435125">
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;taskmaster-ai&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;--package=task-master-ai&quot;</span><span class="punctuation">,</span> <span class="string">&quot;task-master-ai&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ANTHROPIC_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_ANTHROPIC_API_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PERPLEXITY_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_PERPLEXITY_API_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OPENAI_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_OPENAI_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;GOOGLE_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_GOOGLE_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;MISTRAL_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_MISTRAL_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OPENROUTER_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_OPENROUTER_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;XAI_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_XAI_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;AZURE_OPENAI_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_AZURE_KEY_HERE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OLLAMA_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR_OLLAMA_API_KEY_HERE&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>API Keyæ¨èä½¿ç”¨Gemini</p>
<p>åœ¨ä¸ç»‘å¡çš„æƒ…å†µä¸‹å¯ç›´æ¥å…è´¹è¯•ç”¨</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713151804420.png" class="" title="image-20250713151804420">
</blockquote>
<p>é…ç½®å®Œæˆ</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713151517858.png" class="" title="image-20250713151517858">
<p>é€‰æ‹©Agentå¼€å§‹å¼€å‘</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713151555641.png" class="" title="image-20250713151555641">
<br>
<h2 id="æµç¨‹">æµç¨‹</h2>
<h3 id="åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®</h3>
<p>ç›´æ¥ä¸Agentå¯¹è¯</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713152021953.png" class="" title="image-20250713152021953">
<p>æˆ–è€…</p>
<p>å‘½ä»¤è¡Œåˆå§‹åŒ–é¡¹ç›®</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713152046213.png" class="" title="image-20250713152046213">
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯</p>
<p>åœ¨åˆå§‹åŒ–é¡¹ç›®ä¸Šï¼Œè¯·æŒ‡å®šæ‚¨å½“å‰æ‰€ä½¿ç”¨çš„IDEï¼›å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒAgentåœ¨å‘½ä»¤çš„ä¼ å…¥å‚æ•°ä¸­æŒ‡å®šäº†IDE rulesä¸ºTrae</p>
</blockquote>
<br>
<h3 id="å®ŒæˆPRDæ–‡æ¡£">å®ŒæˆPRDæ–‡æ¡£</h3>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713151900249.png" class="" title="image-20250713151900249">
<br>
<h3 id="Parse-PRD">Parse PRD</h3>
<p>è§£æPRDæ–‡æ¡£å¾—åˆ°task list</p>
<p>è¯¥æ­¥éª¤éœ€è¦ä½¿ç”¨LLMï¼Œå› æ­¤è¯·é…ç½®ä»¥ä¸‹æ–‡ä»¶</p>
<ul>
<li>
<p><code>.trae\mcp.json</code>: æ·»åŠ LLM API Keyï¼Œæ¨èä½¿ç”¨Gemini</p>
</li>
<li>
<p><code>.taskmaster\config.json</code>: ä¿®æ”¹ main ä¸º google gemini</p>
</li>
</ul>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713152535100.png" class="" title="image-20250713152535100">
<blockquote>
<p>å¦‚æœæ‰§è¡Œå¤±è´¥äº†ï¼ŒAgentä¹Ÿä¼šç»™å‡ºå»ºè®®ä¿®å¤è¯¥é—®é¢˜</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713152633165.png" class="" title="image-20250713152633165">
</blockquote>
<p>å¾—åˆ°tasks.json</p>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713152708978.png" class="" title="image-20250713152708978">
<br>
<h3 id="ä»»åŠ¡æ‰§è¡Œ">ä»»åŠ¡æ‰§è¡Œ</h3>
<img src="/2025/07/13/Trae-Claude-Task-Master-4-Develop/image-20250713152810221.png" class="" title="image-20250713152810221">
<br>
<h2 id="å­˜åœ¨é—®é¢˜">å­˜åœ¨é—®é¢˜</h2>
<p>æ–½å·¥ä¸­â€¦</p>
]]></content>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Op_sys Learning Record</title>
    <url>/2024/04/12/Op-sys-Learning-Record/</url>
    <content><![CDATA[<p>æ“ä½œç³»ç»Ÿç›¸å…³å­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>Op_sys_learning_record</h1>
<h3 id="ç¡¬ä»¶">ç¡¬ä»¶</h3>
<p>QEMUï¼šè¿‘ä¼¼æ¨¡æ‹Ÿç¡¬ä»¶SiFiveFU540-C000ä¸»æ¿(RISC-V,64 bit register, 56 bit physical memory)</p>
<p>intel 8086ï¼š20æ ¹åœ°å€çº¿ï¼Œ16ä½å¯„å­˜å™¨</p>
<h3 id="è½¯ä»¶">è½¯ä»¶</h3>
<p>XV6ï¼šæ“ä½œç³»ç»Ÿ</p>
<p><a href="https://github.com/seaswalker/tiny-os">tiny-os</a></p>
<h2 id="ç³»ç»Ÿå¯åŠ¨">ç³»ç»Ÿå¯åŠ¨</h2>
<h3 id="åŸºç¡€ä¿¡æ¯">åŸºç¡€ä¿¡æ¯</h3>
<h4 id="ç‰©ç†åœ°å€ç©ºé—´">ç‰©ç†åœ°å€ç©ºé—´</h4>
<p>20æ ¹åœ°å€çº¿ï¼Œ16ä½å¯„å­˜å™¨ï¼Œå¯è®¿é—®1MBçš„å†…å­˜ç©ºé—´</p>
<p>0x00000-0x9FFFF: DRAM</p>
<p>0xF0000-0xFFFFF: ROMï¼ŒBIOSä»£ç ä½ç½®</p>
<p>é€šè¿‡æ®µå¯„å­˜å™¨å·¦ç§»4ä½+åç§»åœ°å€</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240413150024273.png" class="" title="image-20240413150024273">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417110651232.png" class="" title="image-20240417110651232">
<h4 id="SiFive-FU540ç‰©ç†åœ°å€ç©ºé—´">SiFive FU540ç‰©ç†åœ°å€ç©ºé—´</h4>
<p>ç‰©ç†åœ°å€0x80000000ä»¥å‰çš„éƒ¨åˆ†ç”±ä¸»æ¿ä¸ŠéDRAMç»„æˆï¼ˆä¾‹å¦‚ï¼šboot ROMï¼ŒPLICç­‰ï¼‰</p>
<p>ç‰©ç†åœ°å€å¯¹åº”çš„ç¡¬ä»¶ï¼ˆå›¾ä¾‹ä¸ºSiFiveä¸»æ¿ï¼Œä»…æˆªå–éƒ¨åˆ†ï¼Œç‰©ç†åœ°å€0x80000000ä»¥å‰çš„éƒ¨åˆ†éDRAMï¼‰</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240413150852809.png" class="" title="image-20240413150852809">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240412184947166.png" class="" title="image-20240412184947166">
<h4 id="æ˜¾å­˜åœ°å€ç©ºé—´">æ˜¾å­˜åœ°å€ç©ºé—´</h4>
<p>0xB8000-0xBFFFFä¸ºæ˜¾å­˜ä¸­å­—ç¬¦æ˜¾ç¤ºéƒ¨åˆ†ï¼Œé»˜è®¤æ¨¡å¼ä¸º80ä¸ªå­—ç¬¦*25è¡Œï¼Œä¸€ä¸ªå­—ç¬¦2å­—èŠ‚è¡¨ç¤º</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420184138573.png" class="" title="image-20240420184138573">
<h4 id="å¯„å­˜å™¨">å¯„å­˜å™¨</h4>
<p>ä¸å¯è§å¯„å­˜å™¨</p>
<p>GDTR	å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨</p>
<p>IDTR	ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨</p>
<p>LDTR	å±€éƒ¨æè¿°ç¬¦è¡¨å¯„å­˜å™¨</p>
<p>TR	ä»»åŠ¡å¯„å­˜å™¨</p>
<p>CR0~3	æ§åˆ¶å¯„å­˜å™¨</p>
<p>IP	æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨</p>
<p>flags	æ ‡å¿—å¯„å­˜å™¨</p>
<p>DR0~3	è°ƒè¯•å¯„å­˜å™¨</p>
<p>å¯è§å¯„å­˜å™¨</p>
<p>é€šç”¨å¯„å­˜å™¨ï¼Œå¯ç›´æ¥è®¿é—®</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420144227413.png" class="" title="image-20240420144227413">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420144655049.png" class="" title="image-20240420144655049">
<p>æ®µå¯„å­˜å™¨ï¼Œæ®µåŸºå€*16+åç§»</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420144356905.png" class="" title="image-20240420144356905">
<p>32ä½ä¸16ä½</p>
<p>32ä½åœ°å€æ€»çº¿ï¼Œ32ä½å¯„å­˜å™¨</p>
<p>å¯„å­˜å™¨ç»„</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416185859023.png" class="" title="image-20240416185859023">
<p>é€šç”¨å¯„å­˜å™¨ç»„ï¼ŒEflagå’ŒEIPå˜ä¸º32ä½</p>
<p>æ®µå¯„å­˜å™¨ä»ä¸º16ä½å®½ï¼ï¼å†…å®¹ä¸ºæ®µé€‰æ‹©å­</p>
<h4 id="Intelè¯­æ³•é£æ ¼">Intelè¯­æ³•é£æ ¼</h4>
<p>å³ -&gt; å·¦</p>
<p>å®æ¨¡å¼</p>
<p>æ®µå†…åç§»é»˜è®¤åŸºäºDSè¿›è¡Œåç§»</p>
<p>åŸºå€å¯„å­˜å™¨ï¼šbxå¯„å­˜å™¨é»˜è®¤åŸºäºDSè¿›è¡Œåç§»ï¼Œbpå¯„å­˜å™¨é»˜è®¤åŸºäºSSè¿›è¡Œåç§»</p>
<p>å˜å€å¯„å­˜å™¨ï¼šsiå¯„å­˜å™¨å’Œdiå¯„å­˜å™¨é»˜è®¤åŸºäºdsè¿›è¡Œåç§»</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax, [0x1234]	;å–DS*16+0x1234å¤„çš„å€¼èµ‹ç»™ax</span><br><span class="line"></span><br><span class="line">add [bx], 0x1234	;å°†0x1234èµ‹ç»™å†…å­˜ä¸­DS*16+bxå¤„</span><br><span class="line"></span><br><span class="line">mov ax, [fs:0x5678]	;æ˜¾å¼æŒ‡å®šä½¿ç”¨gså¯„å­˜å™¨ä½œä¸ºæ®µåŸºå€ï¼Œå°†gs*16+0x5678çš„å€¼èµ‹ç»™ax</span><br><span class="line"></span><br><span class="line">mov byte [gs:0x01], &#x27;M&#x27;	;æ˜¾å¼æŒ‡å®šä½¿ç”¨gsæ®µå¯„å­˜å™¨ä½œä¸ºæ®µåŸºå€ï¼ŒæŒ‡å®šæ“ä½œæ•°ä¸º1å­—èŠ‚ï¼Œå‘gs*16+0x01çš„ä½ç½®å†™å…¥1å­—èŠ‚çš„æ•°æ®&#x27;M&#x27;</span><br><span class="line"></span><br><span class="line">mov ax, [sp]	;å°†spæŒ‡å‘çš„å€¼èµ‹ç»™ax</span><br><span class="line"></span><br><span class="line">mov ax, [bp+4]	;å°†SS*16+bp+4å¤„çš„å€¼èµ‹ç»™ax</span><br><span class="line"></span><br><span class="line">mov [di], ax	;å°†axçš„å€¼å†™å…¥DS*16+diå¤„</span><br><span class="line"></span><br><span class="line">mov [si+0x1234], ax	;å°†axçš„å€¼å†™å…¥DS*16+si+0x1234å¤„</span><br><span class="line"></span><br><span class="line">mov [bx+di], ax	;å°†axçš„å€¼å†™å…¥DS*16+bx+di</span><br><span class="line"></span><br><span class="line">jump $	; $ç¬¦å·è¡¨ç¤ºå½“å‰è¡Œï¼Œè¯¥è¯­å¥ä¸ºè·³è½¬è‡³å½“å‰è¡Œï¼›$$ä¸ºå½“å‰section</span><br><span class="line"></span><br><span class="line">;-----------------------stdcallè°ƒç”¨çº¦å®š------------------------</span><br><span class="line">push 2</span><br><span class="line">push 3	;ä»å³å¾€å·¦å°†ä¼ å…¥å‚æ•°å‹æ ˆ</span><br><span class="line">call subtract	;å°†å½“å‰eipå‹æ ˆï¼Œè·³è½¬è‡³è¢«è°ƒå‡½æ•°åœ°å€å¼€å§‹æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">push ebp	;å‹æ ˆä¿å­˜åŸebpï¼Œ</span><br><span class="line">mov ebp, esp	;æ›´æ–°æ ˆå¸§åŸºå€ï¼Œè¿›å…¥æ–°æ ˆå¸§</span><br><span class="line"></span><br><span class="line">mov eax, [ebp+0x8]</span><br><span class="line">mov eax, [ebp+0xc]</span><br><span class="line"></span><br><span class="line">mov esp, ebp</span><br><span class="line"></span><br><span class="line">pop ebp	;å¼¹å‡ºæ ˆé¡¶ä¿å­˜çš„åŸebpå€¼åˆ°ebp</span><br><span class="line">ret 8	;å¼¹å‡ºæ ˆé¡¶åœ°å€åˆ°eip(å¼¹æ ˆä½¿å¾—espè‡ªåŠ 4)ï¼Œesp+8(ç§»é™¤å‹æ ˆçš„ä¼ å…¥å‚æ•°)</span><br><span class="line">;-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">;-----------------------cdeclè°ƒç”¨çº¦å®š--------------------------</span><br><span class="line">push 2</span><br><span class="line">push 3	;ä»å³å¾€å·¦å°†ä¼ å…¥å‚æ•°å‹æ ˆ</span><br><span class="line">call subtract	;å°†å½“å‰eipå‹æ ˆï¼Œè·³è½¬è‡³è¢«è°ƒå‡½æ•°åœ°å€å¼€å§‹æ‰§è¡Œ</span><br><span class="line">add esp, 8	;æ¸…æ ˆï¼Œç§»é™¤ä¼ å…¥å‚æ•°</span><br><span class="line"></span><br><span class="line">push ebp	;å‹æ ˆä¿å­˜åŸebpï¼Œè¿›å…¥æ–°æ ˆå¸§</span><br><span class="line">mov ebp, esp</span><br><span class="line"></span><br><span class="line">mov eax, [ebp+0x8]</span><br><span class="line">mov eax, [ebp+0xc]</span><br><span class="line"></span><br><span class="line">mov esp, ebp</span><br><span class="line"></span><br><span class="line">pop ebp	;å¼¹å‡ºæ ˆé¡¶ä¿å­˜çš„åŸebpå€¼åˆ°ebp</span><br><span class="line">ret	;å¼¹å‡ºæ ˆé¡¶åœ°å€åˆ°eip(å¼¹æ ˆä½¿å¾—espè‡ªåŠ 4)ï¼Œesp+8(ç§»é™¤å‹æ ˆçš„ä¼ å…¥å‚æ•°)</span><br><span class="line">;-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">section .data	;sectionä¸ºä¼ªæŒ‡ä»¤ï¼Œé¢å‘ç¨‹åºå‘˜çš„è·³è½¬è®°å·</span><br><span class="line">	var dd 0</span><br><span class="line">	str: dd &quot;hello&quot;, 0xa, 0</span><br><span class="line"></span><br><span class="line">section .text</span><br><span class="line">extern c_print	;å¯¼å…¥å¤–éƒ¨å‡½æ•° c_print</span><br><span class="line">global _start	;å°†å‡½æ•°_startå¯¼å‡ºä¸ºå…¨å±€ç¬¦å·ï¼Œä¾›å¤–éƒ¨æ–‡ä»¶è°ƒç”¨</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">	push str</span><br><span class="line">	jmp $$</span><br></pre></td></tr></table></figure>
<p>SSä¸ºæ ˆåº•ï¼Œbpä¸ºå½“å‰å¸§åº•</p>
<p>ä¿æŠ¤æ¨¡å¼</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420193121630.png" class="" title="image-20240420193121630">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420195137241.png" class="" title="image-20240420195137241">
<p>segmentä¸section</p>
<p>sectionç§°ä¸ºèŠ‚ï¼Œæ˜¯æŒ‡åœ¨æ±‡ç¼–æºç ä¸­ç»ç”±å…³é”®å­—sectionæˆ–segmentä¿®é¥°ã€é€»è¾‘åˆ’åˆ†çš„æŒ‡ä»¤æˆ–æ•°æ®åŒºåŸŸï¼Œæ±‡ç¼–å™¨ä¼šå°†è¿™ä¸¤ä¸ªå…³é”®å­—ä¿®é¥°çš„åŒºåŸŸåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ç¼–è¯‘æˆèŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´â€œèŠ‚â€æœ€åˆè¯ç”Ÿäºç›®æ ‡æ–‡ä»¶ä¸­ã€‚</p>
<p>segmentç§°ä¸ºæ®µï¼Œæ˜¯é“¾æ¥å™¨æ ¹æ®ç›®æ ‡æ–‡ä»¶ä¸­å±æ€§ç›¸åŒçš„å¤šä¸ªsectionåˆå¹¶åçš„sectioné›†åˆï¼Œè¿™ä¸ªé›†åˆç§°ä¸ºsegmentï¼Œä¹Ÿå°±æ˜¯æ®µï¼Œé“¾æ¥å™¨æŠŠç›®æ ‡æ–‡ä»¶é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå› æ­¤æ®µæœ€ç»ˆè¯ç”Ÿäºå¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„å¯æ‰§è¡Œç¨‹åºå†…å­˜ç©ºé—´ä¸­çš„ä»£ç æ®µå’Œæ•°æ®æ®µå°±æ˜¯æŒ‡çš„segmentã€‚</p>
<h4 id="AT-Tè¯­æ³•é£æ ¼">AT&amp;Tè¯­æ³•é£æ ¼</h4>
<p>å·¦ -&gt; å³</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">movl %eax, immed32(%ebx, %esi,2)	</span><br><span class="line">	#å°†eaxçš„å€¼å†™å…¥å†…å­˜immed32+ebx+esi*2å¤„</span><br><span class="line">	#()æ‹¬å·è¡¨ç¤ºå–å†…çš„å€¼ä½œä¸ºå†…å­˜åœ°å€</span><br><span class="line">	#å¯„å­˜å™¨å‰å¿…é¡»æœ‰%</span><br><span class="line"></span><br><span class="line">movl $123, %eax	#å°†ç«‹å³æ•°123å†™å…¥å¯„å­˜å™¨eax</span><br><span class="line"></span><br><span class="line">andl %ebx, %ecx #å¯¹å¯„å­˜å™¨ %ebx å’Œ %ecx çš„å†…å®¹æ‰§è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ° %ecx å¯„å­˜å™¨ä¸­ã€‚</span><br><span class="line"></span><br><span class="line">xchgl %eax, (%esp) #äº¤æ¢å¯„å­˜å™¨eaxå’Œæ ˆé¡¶ä½ç½®çš„å€¼</span><br><span class="line"></span><br><span class="line">popl %eax #æŒ‡ä»æ ˆé¡¶å¼¹å‡ºæ•°æ®ï¼Œå¹¶å°†å¼¹å‡ºçš„æ•°æ®å†™å…¥ %eax å¯„å­˜å™¨ã€‚</span><br><span class="line"></span><br><span class="line">ret #å¼¹å‡ºæ ˆé¡¶å€¼å†™å…¥PC</span><br><span class="line">iret #å¼¹å‡ºeipå¹¶å†™å…¥ï¼Œå¼¹å‡ºcså¹¶å†™å…¥ï¼Œå¼¹å‡ºeflagså¹¶å†™å…¥</span><br></pre></td></tr></table></figure>
<p>å†…è”æ±‡ç¼–</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> [<span class="keyword">volatile</span>] (<span class="string">&quot;&quot;</span>)	<span class="comment">//volatileä¸ºå¯é€‰é¡¹ï¼Œè¡¨ç¤ºæ­¤å¤„ä»£ç ä¸å¾—ä¿®æ”¹</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;movl $9, %eax;&quot;</span> <span class="string">&quot;pushl %eax&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">asm</span> [<span class="keyword">volatile</span>] (<span class="string">&quot;&quot;</span>:<span class="string">&quot;&quot;</span>(output) :<span class="string">&quot;&quot;</span>(input) :clobber/modify)</span><br><span class="line">	<span class="comment">//&quot;&quot; å†…éƒ¨ä¸ºæ±‡ç¼–ä»£ç </span></span><br><span class="line">    <span class="comment">//output, inputä¸ºcå˜é‡ï¼Œå®ƒä»¬å‰é¢çš„&quot;&quot;ä¸ºçº¦æŸ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;addl %%ebx, %%eax;&quot;</span>:<span class="string">&quot;=a&quot;</span>(out_sum):<span class="string">&quot;a&quot;</span>(in_a),<span class="string">&quot;b&quot;</span>(in_b))</span><br><span class="line">	<span class="comment">//&quot;a&quot;ä¸ºçº¦æŸåï¼Œçº¦æŸcè¯­è¨€å˜é‡in_aä½¿ç”¨å¯„å­˜å™¨eax</span></span><br><span class="line">	<span class="comment">//&quot;b&quot;ä¸ºçº¦æŸåï¼Œçº¦æŸcè¯­è¨€å˜é‡in_bä½¿ç”¨å¯„å­˜å™¨ebx</span></span><br><span class="line">	<span class="comment">//&quot;=a&quot;ä¸ºçº¦æŸåï¼Œå°†å¯„å­˜å™¨eaxçš„å€¼å†™å…¥cè¯­è¨€å˜é‡out_sum</span></span><br><span class="line">	<span class="comment">//=ä¸ºåªå†™ï¼Œ+ä¸ºè¯»å†™ï¼Œ&amp;ä¸ºç‹¬å æ‰€çº¦æŸçš„å¯„å­˜å™¨</span></span><br><span class="line">	<span class="comment">//ç”±äºæ‰©å±•å†…è”æ±‡ç¼–ä¸­ï¼Œ%0ä¸ºå ä½ç¬¦ç¬¦å·ï¼Œæ•…ä¿®æ”¹å¯„å­˜å™¨è¡¨ç¤ºä¸º%%eax</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;movb %0 %1;&quot;</span>::<span class="string">&quot;a&quot;</span>(in_a),<span class="string">&quot;m&quot;</span>(in_b))</span><br><span class="line">	<span class="comment">//&quot;a&quot;ä¸ºçº¦æŸåï¼Œçº¦æŸcè¯­è¨€å˜é‡in_aä½¿ç”¨å¯„å­˜å™¨eax</span></span><br><span class="line">	<span class="comment">//&quot;m&quot;ä¸ºçº¦æŸåï¼Œä½¿ç”¨cè¯­è¨€å˜é‡in_bçš„å†…å­˜åœ°å€</span></span><br><span class="line">	<span class="comment">//%0,%1ä¸ºåºå·å ä½ç¬¦ï¼Œæ‰€æœ‰inputå’Œoutputä»å·¦è‡³å³è¢«æ ‡åºå·ï¼Œè¿™é‡Œå¯¹åº”in_a, in_b</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;divb %[divisor]; movb %%al, %[result]&quot;</span>\</span><br><span class="line">		:[result]<span class="string">&quot;=m&quot;</span>(out)\</span><br><span class="line">		:<span class="string">&quot;a&quot;</span>(in_a),[divisor]<span class="string">&quot;m&quot;</span>(in_b)\</span><br><span class="line">		);</span><br><span class="line">	<span class="comment">//[divisor]ä¸ºin_bçš„å†…å­˜åœ°å€ï¼Œé€šè¿‡%[divisor]è·å–å†…å­˜çš„å€¼</span></span><br><span class="line">	<span class="comment">//[result]ä¸ºoutçš„å†…å­˜åœ°å€ï¼Œ</span></span><br></pre></td></tr></table></figure>
<h4 id="C-C-ç›¸å…³">C/C++ ç›¸å…³</h4>
<p><strong>å®å‡½æ•°</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SQUARE(x) ((x) * (x))</span></span><br><span class="line"><span class="comment">//  (x) * (x)å¤–çš„ä¸€å±‚æ‹¬å·æ˜¯ä¸ºäº†å±•å¼€æ—¶ä¸æ”¹å˜è¿è¾“ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment">// å¯¹æ¯” </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD(x) (x) + (x)</span></span><br><span class="line"><span class="comment">// åœ¨ä½¿ç”¨ 4 / ADD(2) æ—¶ï¼Œå±•å¼€å¼</span></span><br><span class="line"><span class="comment">// 4 / (2) * (2) å¯¼è‡´è¿ç®—ä¼˜å…ˆçº§é”™è¯¯</span></span><br><span class="line"><span class="comment">// å¯¹æ¯” </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQUARE(x) x * x</span></span><br><span class="line"><span class="comment">// åœ¨ä½¿ç”¨ SQUARE(2 + 3) æ—¶ï¼Œå±•å¼€å¼</span></span><br><span class="line"><span class="comment">// 2 + 3 * 2 + 3 å¯¼è‡´è¿ç®—ä¼˜å…ˆçº§é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_FUNC(x) &#123; \</span></span><br><span class="line"><span class="meta">    int result = (x) * 2; \</span></span><br><span class="line"><span class="meta">    printf(<span class="string">&quot;result: %d\n&quot;</span>, result); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ &#123;&#125; å¯ä»¥ä¸ºå®å‡½æ•°åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ä½œç”¨åŸŸï¼Œé¿å…å®å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ä¸å¤–éƒ¨ä»£ç ä¸­çš„å˜é‡å‘ç”Ÿå†²çªã€‚</span></span><br><span class="line"><span class="comment">// æ•…åœ¨ä½¿ç”¨å®å‡½æ•°çš„æ—¶å€™ä½¿ç”¨æ‹¬å· #define func() (&#123;å‡½æ•°ä½“&#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®å‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(a, b) ((a) &gt; (b) ? (a) : (b))</span></span><br><span class="line"><span class="comment">//é¢„å¤„ç†å™¨ä¼šå°†ä»£ç ä¸­æ‰€æœ‰å‡ºç°å®å‡½æ•°åçš„åœ°æ–¹ï¼Œæ›¿æ¢æˆå®å‡½æ•°å®šä¹‰çš„ä»£ç æ®µã€‚æ–‡æœ¬æ›¿æ¢</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>å†…è”å‡½æ•°</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®å‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(a, b) ((a) &gt; (b) ? (a) : (b))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…è”å‡½æ•°</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">max</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a &gt; b ? a : b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å†…è”å‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µç”±ç¼–è¯‘å™¨å†³å®šæ˜¯å¦è¿›è¡Œå†…è”å±•å¼€ã€‚å¦‚æœç¼–è¯‘å™¨è®¤ä¸ºå‡½æ•°ä½“ç§¯è¾ƒå°ï¼Œä¸”è°ƒç”¨é¢‘ç‡è¾ƒé«˜ï¼Œå°±ä¼šå°†å‡½æ•°ä»£ç ç›´æ¥æ’å…¥åˆ°è°ƒç”¨ç‚¹ï¼Œä¸ä½¿ç”¨å‡½æ•°è°ƒç”¨çš„æ–¹å¼ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//MAX æ˜¯ä¸€ä¸ªå®å‡½æ•°ï¼Œè€Œ max æ˜¯ä¸€ä¸ªå†…è”å‡½æ•°ã€‚ä¸¤è€…éƒ½å¯ä»¥ç”¨æ¥è®¡ç®—ä¸¤ä¸ªæ•°çš„æœ€å¤§å€¼ï¼Œä½† max å‡½æ•°æ›´å®‰å…¨ï¼Œå› ä¸ºå®ƒæœ‰ç±»å‹æ£€æŸ¥ï¼Œå¹¶ä¸”ä¸ä¼šé€ æˆå˜é‡åæ±¡æŸ“ã€‚</span></span><br></pre></td></tr></table></figure>
<p><strong>constä¸const_cast&lt;&gt;()</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> <span class="type">const</span></span>;	<span class="comment">//è¯¥constå£°æ˜æ­¤å‡½æ•°ä¸ä¼šä¿®æ”¹è°ƒç”¨è¯¥å‡½æ•°çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">//ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Complex</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  	<span class="built_in">Complex</span>(<span class="type">double</span> real, <span class="type">double</span> imag) : <span class="built_in">real_</span>(real), <span class="built_in">imag_</span>(imag) &#123;&#125; <span class="comment">// æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨ï¼Œå†’å·æ ‡å¿—ç€åˆå§‹åŒ–åˆ—è¡¨çš„å¼€å§‹ï¼Œå°†æ„é€ å‡½æ•°å‚æ•° real çš„å€¼èµ‹ç»™æˆå‘˜å˜é‡ real_</span></span><br><span class="line">    </span><br><span class="line">    Complex <span class="keyword">operator</span>+(<span class="type">const</span> Complex&amp; other) <span class="type">const</span> &#123;  <span class="comment">// ç‰ˆæœ¬1: const æˆå‘˜å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Complex</span>(real_ + other.real_, imag_ + other.imag_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Complex <span class="keyword">operator</span>+(<span class="type">const</span> Complex&amp; other) &#123;       <span class="comment">// ç‰ˆæœ¬2: é const æˆå‘˜å‡½æ•°</span></span><br><span class="line">        real_ += other.real_; <span class="comment">// ä¿®æ”¹äº†è°ƒç”¨è¯¥å‡½æ•°çš„å¯¹è±¡</span></span><br><span class="line">        imag_ += other.imag_;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">  		<span class="type">double</span> real_;</span><br><span class="line">  		<span class="type">double</span> imag_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Complex <span class="title">c1</span><span class="params">(<span class="number">1.0</span>, <span class="number">2.0</span>)</span></span>;</span><br><span class="line">    <span class="function">Complex <span class="title">c2</span><span class="params">(<span class="number">3.0</span>, <span class="number">4.0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    c1 = c1 + c2;  <span class="comment">// è°ƒç”¨ç‰ˆæœ¬1æˆ–ç‰ˆæœ¬2éƒ½å¯ä»¥</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> Complex <span class="title">c3</span><span class="params">(<span class="number">5.0</span>, <span class="number">6.0</span>)</span></span>;</span><br><span class="line">    c3 = c3 + c2;  <span class="comment">// åªèƒ½è°ƒç”¨ç‰ˆæœ¬1 (const æˆå‘˜å‡½æ•°)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">void</span> <span class="title">func</span><span class="params">()</span></span>;	<span class="comment">//è¯¥å‡½æ•°è¿”å›å€¼ä¸ºconst</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">   <span class="built_in">A</span>()  </span><br><span class="line">   &#123;  </span><br><span class="line">      m_iNum = <span class="number">1</span>;  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">   <span class="type">int</span> m_iNum;  </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span>    </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">   <span class="comment">//1. æŒ‡é’ˆæŒ‡å‘ç±»    </span></span><br><span class="line">   <span class="type">const</span> A *pca1 = <span class="keyword">new</span> A;    </span><br><span class="line">   A *pa2 = <span class="built_in">const_cast</span>&lt;A*&gt;(pca1);  <span class="comment">//å¸¸é‡æŒ‡é’ˆè½¬æ¢ä¸ºéå¸¸é‡æŒ‡é’ˆ    </span></span><br><span class="line">   pa2-&gt;m_iNum = <span class="number">200</span>;    <span class="comment">//fine    </span></span><br><span class="line">       </span><br><span class="line">   <span class="comment">//è½¬æ¢åæŒ‡é’ˆæŒ‡å‘åŸæ¥çš„å¯¹è±¡    </span></span><br><span class="line">   cout&lt;&lt; pca1-&gt;m_iNum &lt;&lt;pa2-&gt;m_iNum&lt;&lt;endl; <span class="comment">//200 200    </span></span><br><span class="line">        </span><br><span class="line">   <span class="comment">//2. æŒ‡é’ˆæŒ‡å‘åŸºæœ¬ç±»å‹    </span></span><br><span class="line">   <span class="type">const</span> <span class="type">int</span> ica = <span class="number">100</span>;    </span><br><span class="line">   <span class="type">int</span> * ia = <span class="built_in">const_cast</span>&lt;<span class="type">int</span> *&gt;(&amp;ica);    </span><br><span class="line">   *ia = <span class="number">200</span>;    </span><br><span class="line">   cout&lt;&lt; *ia &lt;&lt;ica&lt;&lt;endl;   <span class="comment">//200 100  </span></span><br><span class="line">    </span><br><span class="line">   A a0;  </span><br><span class="line">   <span class="type">const</span> A &amp;a1 = a0;  </span><br><span class="line">   A a2 = <span class="built_in">const_cast</span>&lt;A&amp;&gt;(a1);ã€€<span class="comment">//å¸¸é‡å¼•ç”¨è½¬ä¸ºéå¸¸é‡å¼•ç”¨</span></span><br><span class="line">  </span><br><span class="line">   a2.m_iNum = <span class="number">200</span>;    <span class="comment">//fine    </span></span><br><span class="line">  </span><br><span class="line">   cout&lt;&lt; a0.m_iNum &lt;&lt; a1.m_iNum &lt;&lt; a2.m_iNum &lt;&lt; endl; <span class="comment">//1 1 200    </span></span><br><span class="line">    </span><br><span class="line">   <span class="comment">//å¸¸é‡å¯¹è±¡è¢«è½¬æ¢æˆéå¸¸é‡å¯¹è±¡æ—¶å‡ºé”™  </span></span><br><span class="line">   <span class="type">const</span> A ca;  </span><br><span class="line">   A a = <span class="built_in">const_cast</span>&lt;A&gt;(ca);  <span class="comment">//ä¸å…è®¸</span></span><br><span class="line">   </span><br><span class="line">   <span class="type">const</span> <span class="type">int</span> i = <span class="number">100</span>;  </span><br><span class="line">   <span class="type">int</span> j = <span class="built_in">const_cast</span>&lt;<span class="type">int</span>&gt;(i);  <span class="comment">//ä¸å…è®¸ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><strong>static_cast&lt;??&gt;(obj)</strong>:
<ul>
<li>ç”¨äº<strong>ç›¸å…³ç±»å‹</strong>ä¹‹é—´çš„è½¬æ¢ï¼Œä¾‹å¦‚ï¼š
<ul>
<li>åŸºæœ¬ç±»å‹è½¬æ¢ (int åˆ° floatï¼Œdouble åˆ° int ç­‰)</li>
<li>void æŒ‡é’ˆå’Œå…¶ä»–æŒ‡é’ˆç±»å‹ä¹‹é—´çš„è½¬æ¢</li>
<li>å‘ä¸Šè½¬å‹ (æ´¾ç”Ÿç±»æŒ‡é’ˆ/å¼•ç”¨åˆ°åŸºç±»æŒ‡é’ˆ/å¼•ç”¨)</li>
<li>å‘ä¸‹è½¬å‹ (åŸºç±»æŒ‡é’ˆ/å¼•ç”¨åˆ°æ´¾ç”Ÿç±»æŒ‡é’ˆ/å¼•ç”¨ï¼Œ<strong>éœ€è¦ç¨‹åºå‘˜ä¿è¯å®‰å…¨æ€§</strong>)</li>
</ul>
</li>
<li>ç¼–è¯‘æ—¶æ£€æŸ¥ç±»å‹ï¼Œä¸å®‰å…¨çš„æ“ä½œå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li>
<li>å°†objè½¬æ¢ä¸º<code>&lt;??&gt;</code>ç±»å‹</li>
</ul>
</li>
<li><strong>dynamic_cast</strong>:
<ul>
<li>ç”¨äº<strong>å¤šæ€ç±»å‹</strong>ä¹‹é—´çš„<strong>å®‰å…¨å‘ä¸‹è½¬å‹</strong> (åŸºç±»æŒ‡é’ˆ/å¼•ç”¨åˆ°æ´¾ç”Ÿç±»æŒ‡é’ˆ/å¼•ç”¨)ã€‚</li>
<li>è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹ï¼Œå¤±è´¥æ—¶è¿”å› nullptr (æŒ‡é’ˆ) æˆ–æŠ›å‡º std::bad_cast å¼‚å¸¸ (å¼•ç”¨)ã€‚</li>
<li>è¦æ±‚åŸºç±»è‡³å°‘æœ‰ä¸€ä¸ªè™šå‡½æ•°ã€‚</li>
</ul>
</li>
<li><strong>const_cast</strong>:
<ul>
<li>ç”¨äº<strong>ç§»é™¤æˆ–æ·»åŠ  const å’Œ volatile é™å®šç¬¦</strong>ã€‚</li>
<li>ä¸ä¼šæ”¹å˜å¯¹è±¡æœ¬èº«çš„å¸¸é‡æ€§ï¼Œåªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦è¿›è¡Œå¸¸é‡æ€§æ£€æŸ¥ã€‚</li>
<li>å¦‚æœä¿®æ”¹äº†å®é™…ä¸ºå¸¸é‡çš„å¯¹è±¡ï¼Œä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li>
</ul>
</li>
<li><strong>reinterpret_cast</strong>:
<ul>
<li>ç”¨äº<strong>åº•å±‚ç±»å‹è½¬æ¢</strong>ï¼Œä¾‹å¦‚ï¼š
<ul>
<li>å°†æŒ‡é’ˆè½¬æ¢ä¸ºæ•´æ•°</li>
<li>å°†æ•´æ•°è½¬æ¢ä¸ºæŒ‡é’ˆ</li>
<li>å°†ä¸€ä¸ªæŒ‡é’ˆè½¬æ¢ä¸ºå¦ä¸€ä¸ªä¸ç›¸å…³çš„æŒ‡é’ˆç±»å‹</li>
</ul>
</li>
<li>éå¸¸å±é™©ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>å‡½æ•°æŒ‡é’ˆ</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">greet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello from greet function!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// returnType (*pointerName)(parameter1Type, parameter2Type, ...);</span></span><br><span class="line"><span class="built_in">void</span> (*ptr)() = greet; <span class="comment">// å®šä¹‰å‡½æ•°æŒ‡é’ˆå¹¶åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸¤ç§è°ƒç”¨æ–¹å¼æ˜¯ç­‰æ•ˆçš„</span></span><br><span class="line"><span class="built_in">ptr</span>();         <span class="comment">// ç®€æ´å†™æ³•ï¼Œptrå®é™…ä¸ºåœ°å€</span></span><br><span class="line">(*ptr)();     <span class="comment">// æ›´æ˜ç¡®çš„å†™æ³•ï¼Œå¼ºè°ƒè§£å¼•ç”¨</span></span><br><span class="line">(<span class="type">void</span> *)<span class="number">1234</span>	<span class="comment">//è¡¨ç¤ºä¸€ä¸ªæœªçŸ¥ç±»å‹çš„åœ°å€</span></span><br><span class="line">(<span class="built_in">void</span> (*)())<span class="number">1234</span>  <span class="comment">//å°†1234å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆï¼ˆå‡½æ•°çš„åœ°å€</span></span><br><span class="line">(*((<span class="built_in">void</span> (*)())<span class="number">1234</span>))()  <span class="comment">//è°ƒç”¨ä½äºåœ°å€1234å¤„çš„å‡½æ•°</span></span><br></pre></td></tr></table></figure>
<p><strong>è™šå‡½æ•°ä¸çº¯è™šå‡½æ•°</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">makeSound</span><span class="params">()</span> </span>&#123;  <span class="comment">// æ™®é€šè™šå‡½æ•°ï¼Œæœ‰é»˜è®¤å®ç°ï¼›å¿…é¡»å£°æ˜ä¸ºè™šæ‰å¯ä»¥åœ¨å­ç±»ä¸­é‡å†™</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Animal making sound\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> : <span class="keyword">public</span> Animal &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">makeSound</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="comment">// é‡å†™åŸºç±»çš„è™šå‡½æ•°,å¯ä»¥ä¸é‡å†™</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Woof!\n&quot;</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span> &#123;  <span class="comment">// ä¸€ä¸ªç±»ä¸­å¯åŒæ—¶å­˜åœ¨è™šå’Œéè™šå‡½æ•°</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">()</span> </span>= <span class="number">0</span>;  <span class="comment">// çº¯è™šå‡½æ•°ï¼Œæ²¡æœ‰å‡½æ•°ä½“</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">printDescription</span><span class="params">()</span> </span>&#123;  <span class="comment">// éè™šå‡½æ•°</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;This is a shape.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span> : <span class="keyword">public</span> Shape &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">draw</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;  <span class="comment">// æ´¾ç”Ÿç±»å¿…é¡»å®ç° draw() å‡½æ•°</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Drawing a circle.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VShape</span> &#123; <span class="comment">// å«çº¯è™šå‡½æ•°å³ä¸å¯å®ä¾‹åŒ–</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="comment">// ... </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">()</span> </span>= <span class="number">0</span>; <span class="comment">// çº¯è™šå‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span> &#123; <span class="comment">// éæŠ½è±¡ç±»ï¼ŒåŒ…å«è™šå‡½æ•°</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="comment">// ... </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Shape* s = new Shape();  // é”™è¯¯ï¼šæ— æ³•å®ä¾‹åŒ–æŠ½è±¡ç±»</span></span><br><span class="line">    Shape* c = <span class="keyword">new</span> <span class="built_in">Circle</span>();    <span class="comment">// æ­£ç¡®</span></span><br><span class="line"></span><br><span class="line">    Rectangle r;               <span class="comment">// æ­£ç¡®ï¼šéæŠ½è±¡ç±»å¯ä»¥å®ä¾‹åŒ–</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span> c;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç»§æ‰¿ä¸åˆå§‹åŒ–åˆ—è¡¨</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// :: åŒå†’å· ä½œç”¨åŸŸè§£æè¿ç®—ç¬¦</span></span><br><span class="line"><span class="comment">// : å•å†’å· ç»§æ‰¿/åˆå§‹åŒ–åˆ—è¡¨/æ ‡ç­¾/ä¸‰ç›®è¿ç®—ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ C++ ä¸­ï¼Œå½“å­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶ï¼Œå­ç±»å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚åœ¨ C++ å¤šç»§æ‰¿æƒ…å†µä¸‹ï¼Œå­ç±»å¯¹è±¡åˆ›å»ºæ—¶ä¼šè°ƒç”¨æ‰€æœ‰ç›´æ¥çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœçˆ¶ç±»æœ‰é»˜è®¤æ„é€ å‡½æ•°(å³æ²¡æœ‰å‚æ•°çš„æ„é€ å‡½æ•°)ï¼š å­ç±»å¯ä»¥ä¸æ˜¾å¼è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚å¦‚æœçˆ¶ç±»æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼š å­ç±»å¿…é¡»åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­æ˜¾å¼è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°å¹¶ä¼ é€’å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">// åœ¨ Java ä¸­ï¼Œå­ç±»æ„é€ å‡½æ•°ä¸ä¼šè‡ªåŠ¨è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œéœ€è¦ç¨‹åºå‘˜æ˜¾å¼åœ°ä½¿ç”¨ super() æ–¹æ³•æ¥è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå¹¶é€šè¿‡ä¼ å‚çš„ä¸åŒï¼Œè°ƒç”¨ä¸åŒçš„æ„é€ å‡½æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>: <span class="keyword">public</span> ClassA, <span class="keyword">public</span> ClassB  &#123;  <span class="comment">// å…¬æœ‰ç»§æ‰¿äºClassAå’ŒClassB</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Person</span>(<span class="type">const</span> std::string&amp; name, <span class="type">int</span> age) : <span class="built_in">a</span>(age),  <span class="built_in">n</span>(name) &#123;&#125;  <span class="comment">// åˆå§‹åŒ–åˆ—è¡¨ï¼Œæˆå‘˜å˜é‡çš„åˆå§‹åŒ–é¡ºåºä¸å…¶åœ¨ç±»å®šä¹‰ä¸­å£°æ˜çš„é¡ºåºä¸€è‡´ã€‚ç¼–è¯‘å™¨ä¼šæŒ‰ç…§æˆå‘˜å˜é‡åœ¨ç±»å®šä¹‰ä¸­å‡ºç°çš„é¡ºåºä¾æ¬¡è¿›è¡Œåˆå§‹åŒ–ï¼Œå³ä½¿ä½ åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ä»¥ä¸åŒçš„é¡ºåºåˆ—å‡ºå®ƒä»¬ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:  <span class="comment">// æŒ‰ç…§è¿™é‡Œçš„é¡ºåºåˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œå³å…ˆåˆå§‹åŒ–nï¼Œååˆå§‹åŒ–a</span></span><br><span class="line">  std::string n;</span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å˜é‡å(å€¼)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Base1</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Base1 default constructor called.\n&quot;</span>; &#125;  <span class="comment">// é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Base2</span>(<span class="type">int</span> value) : <span class="built_in">m_value</span>(value) &#123;&#125; <span class="comment">// æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> m_value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2 &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Derived</span>() &#123;  &#125; <span class="comment">// æ²¡æœ‰æ˜¾å¼è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°ï¼ŒæŠ¥é”™</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived2</span> : <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2 &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Derived</span>(<span class="type">int</span> value) : <span class="built_in">Base2</span>(value) &#123;&#125; <span class="comment">// æ˜¾å¼è°ƒç”¨ Base2 çš„æ„é€ å‡½æ•°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>staticä¸å†…éƒ¨ç±»</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// c++æ²¡æœ‰é™æ€ç±»çš„æ¦‚å¿µï¼Œç›´æ¥ä½¿ç”¨staticå£°æ˜ç±»çš„æˆå‘˜å‡½æ•°/å˜é‡å³å¯ã€‚ç›¸ä¼¼çš„ï¼Œå¯ä»¥åœ¨æ²¡æœ‰å®ä¾‹åŒ–ç±»çš„æƒ…å†µä¸‹ç›´æ¥è°ƒç”¨æ–¹æ³•/è®¿é—®å˜é‡</span></span><br><span class="line"><span class="comment">// c++çš„å†…éƒ¨ç±»å’Œæ™®é€šç±»æ— åŒºåˆ«</span></span><br><span class="line"><span class="comment">// javaåªæœ‰å†…éƒ¨ç±»å¯ä»¥æ˜¯é™æ€çš„ï¼›é™æ€å†…éƒ¨ç±»å¯ä»¥æœ‰ï¼ˆéé™æ€çš„å˜é‡å’Œæ–¹æ³•ï¼‰å’Œï¼ˆé™æ€çš„å˜é‡å’Œæ–¹æ³•ï¼‰</span></span><br><span class="line"><span class="comment">// javaæ™®é€šå†…éƒ¨ç±»ä¸èƒ½æœ‰é™æ€å˜é‡/æ–¹æ³•ï¼ï¼ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> staticVar; <span class="comment">// é™æ€æ•°æ®æˆå‘˜å£°æ˜</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">staticMethod</span><span class="params">()</span> </span>&#123; <span class="comment">// é™æ€æˆå‘˜å‡½æ•°</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;This is a static method.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> MyClass::staticVar = <span class="number">10</span>; <span class="comment">// é™æ€æ•°æ®æˆå‘˜å®šä¹‰å’Œåˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MyClass::<span class="built_in">staticMethod</span>(); <span class="comment">// ç›´æ¥è°ƒç”¨é™æ€æˆå‘˜å‡½æ•°</span></span><br><span class="line">    std::cout &lt;&lt; MyClass::staticVar &lt;&lt; std::endl; <span class="comment">// ç›´æ¥è®¿é—®é™æ€æ•°æ®æˆå‘˜</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OuterClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> outerVar = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…éƒ¨ç±»</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">InnerClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// é™æ€æˆå‘˜</span></span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> staticVar;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éé™æ€æˆå‘˜</span></span><br><span class="line">        <span class="type">int</span> instanceVar;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line">        <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">staticMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Static method in inner class&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éé™æ€æ–¹æ³•</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">instanceMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Instance method in inner class&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">accessOuterClass</span><span class="params">(OuterClass&amp; outer)</span> </span>&#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Accessing outer class variable: &quot;</span> &lt;&lt; outer.outerVar &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€æˆå‘˜åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">int</span> OuterClass::InnerClass::staticVar = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    OuterClass outer;</span><br><span class="line">    OuterClass::InnerClass inner;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨é™æ€æ–¹æ³•</span></span><br><span class="line">    OuterClass::InnerClass::<span class="built_in">staticMethod</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨éé™æ€æ–¹æ³•</span></span><br><span class="line">    inner.<span class="built_in">instanceMethod</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¿é—®å¤–éƒ¨ç±»æˆå‘˜</span></span><br><span class="line">    inner.<span class="built_in">accessOuterClass</span>(outer);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é»˜è®¤æ„é€ å‡½æ•°</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ˜¾å¼çš„å®šä¹‰æ„é€ å‡½æ•°ï¼Œä½†æ˜¯å³ä½¿æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰æ„é€ å‡½æ•°ï¼ŒC++ ä¹Ÿä¼šæä¾›ä¸€ä¸ªé»˜è®¤æ„é€ å‡½æ•°ã€‚é»˜è®¤æ„é€ å‡½æ•°ä¼šå°†ç±»çš„æˆå‘˜å˜é‡åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ (ä¾‹å¦‚ï¼Œæ•°å­—ç±»å‹åˆå§‹åŒ–ä¸º 0ï¼ŒæŒ‡é’ˆç±»å‹åˆå§‹åŒ–ä¸º nullptr)ã€‚</span></span><br><span class="line">    <span class="type">int</span> value;  <span class="comment">// valueè¢«é»˜è®¤æ„é€ å‡½æ•°åˆå§‹åŒ–ä¸º0</span></span><br><span class="line"></span><br><span class="line">    <span class="function">MyClass* <span class="title">createInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">MyClass</span>(); <span class="comment">// ä½¿ç”¨æŒ‡é’ˆåˆ›å»ºå®ä¾‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MyClass obj1;  <span class="comment">// obj1é€šè¿‡è°ƒç”¨äº†é»˜è®¤æ„é€ å‡½æ•°å¯¹å…¶è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œä¸ä¸ºnull</span></span><br><span class="line">    </span><br><span class="line">    MyClass* obj2 = obj1.<span class="built_in">createInstance</span>(); <span class="comment">// é€šè¿‡obj1æŒ‡é’ˆåˆ›å»ºå®ä¾‹</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Address of obj1: &quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">void</span>*&gt;(&amp;obj1) &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// æœ¬æœºæµ‹è¯• Address of obj1: 0x61fe14</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;obj2 value: &quot;</span> &lt;&lt; obj2-&gt;value &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> obj2;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è±å½¢ç»§æ‰¿ä¸è™šç»§æ‰¿</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">int</span> x) : <span class="built_in">data</span>(x) &#123; </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;A constructor called with &quot;</span> &lt;&lt; data &lt;&lt; std::endl; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// è™šç»§æ‰¿ä¸ä¼šæ”¹å˜æˆå‘˜ç»§æ‰¿è§„åˆ™ï¼Œæ´¾ç”Ÿç±»ä»ç„¶ä¼šç»§æ‰¿è™šåŸºç±»çš„æ‰€æœ‰æˆå‘˜ã€‚</span></span><br><span class="line"><span class="comment">// è™šç»§æ‰¿Aç±»æ—¶ï¼ŒAç±»ç›¸å½“äºæˆä¸ºäº†ä¸€ä¸ªå…±äº«ç±»ï¼Œå…¶ä»–æ‰€æœ‰å†è¿›è¡Œè™šç»§æ‰¿Aç±»æ—¶ï¼Œå‡åªä¼šç»§æ‰¿è¯¥å…±äº«ç±»ï¼Œä¸ä¼šå‡ºç°äºŒä¹‰æ€§ç»§æ‰¿ï¼ˆå³Dç±»ç»§æ‰¿äº†ä¸¤ä¸ªAç±»ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">// ä¸ªäººç†è§£ï¼šç±»Bæ™®é€šç»§æ‰¿ç±»Aæ—¶ï¼ŒBä¸­ç›¸å½“äºåŠ äº†ä¸ªAï¼›å¦‚æœç±»Cæ™®é€šç»§æ‰¿ç±»Aï¼Œç±»Dæ™®é€šç»§æ‰¿ç±»Bï¼ŒCæ—¶ï¼ŒDä¸­ç›¸å½“äºæœ‰äº†ä¸¤ä¸ªå®Aï¼Œå‡ºç°äºŒä¹‰æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒç†ï¼Œå½“Bç±»è™šç»§æ‰¿Aï¼ŒCç±»ç»§æ‰¿Aï¼ŒDç±»ç»§æ‰¿Bï¼ŒCæ—¶ï¼Œç±»Dç›¸å½“äºæœ‰äº†ä¸€ä¸ªè™šAä¸€ä¸ªå®Aï¼Œãƒ€ãƒ¡ã§ã™ã€‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> : <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123; <span class="comment">// è™šç»§æ‰¿</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">B</span>(<span class="type">int</span> x) : <span class="built_in">A</span>(x) &#123; </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;B constructor called&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> : <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123; <span class="comment">// è™šç»§æ‰¿</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">C</span>(<span class="type">int</span> x) : <span class="built_in">A</span>(x) &#123; </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;C constructor called&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹æ–¹å¼ç»§æ‰¿ä¼šè®©Dç»§æ‰¿åˆ°ä¸¤ä¸ªAï¼Œç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯Açš„æ„é€ å‡½æ•°è§¦å‘ä¸¤æ¬¡</span></span><br><span class="line"><span class="comment">// å°è¯•æ‰“å°Aä¸­çš„dataå˜é‡ï¼ŒæŠ¥é”™ï¼š&quot;D::data&quot; is ambiguous</span></span><br><span class="line"><span class="comment">//class C : public A &#123;</span></span><br><span class="line"><span class="comment">//public:</span></span><br><span class="line"><span class="comment">//    C(int x) : A(x) &#123; </span></span><br><span class="line"><span class="comment">//        std::cout &lt;&lt; &quot;C constructor called&quot; &lt;&lt; std::endl; </span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span> : <span class="keyword">public</span> B, <span class="keyword">public</span> C &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">D</span>(<span class="type">int</span> x) : <span class="built_in">A</span>(x), <span class="built_in">B</span>(x), <span class="built_in">C</span>(x) &#123;  <span class="comment">// ç›´æ¥åˆå§‹åŒ–è™šåŸºç±» A</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;D constructor called&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">D <span class="title">d</span><span class="params">(<span class="number">10</span>)</span></span>; </span><br><span class="line">    std::cout &lt;&lt; d.data &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ¨¡æ¿</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¤´æ–‡ä»¶: my_template_class.h</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTemplateClass</span> &#123;  <span class="comment">// ç±»æ¨¡æ¿</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(<span class="type">const</span> T&amp; value)</span></span>;</span><br><span class="line">  <span class="function">T <span class="title">getValue</span><span class="params">()</span> <span class="type">const</span></span>; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æºæ–‡ä»¶: my_template_class.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;my_template_class.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// template &lt;typename T&gt; ä½œç”¨åŸŸæå°ï¼Œåªæœ‰ç´§æ¥ç€çš„å‡½æ•°/ç±»ä¸­</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="comment">// ä¸º print å‡½æ•°å£°æ˜æ¨¡æ¿å‚æ•°ï¼Œå³ print å‡½æ•°ä¸ºæ¨¡æ¿å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> MyTemplateClass&lt;T&gt;::<span class="built_in">print</span>(<span class="type">const</span> T&amp; value) &#123; <span class="comment">// ä¸ºæ¨¡æ¿ç±» MyTemplateClass&lt;T&gt; å®šä¹‰ print</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå†™æˆ MyTemplateClass::printï¼Œç¼–è¯‘å™¨ä¼šè®¤ä¸ºæ­£åœ¨ä¸ºéæ¨¡æ¿ç±» MyTemplateClass çš„æŸä¸ªæ¨¡æ¿æˆå‘˜å‡½æ•°è¿›è¡Œå®šä¹‰ã€‚</span></span><br><span class="line"><span class="comment">//1.ç”±äºä¸å­˜åœ¨è¯¥éæ¨¡æ¿ç±»ï¼ŒæŠ¥é”™ã€‚2.éæ¨¡æ¿ç±»ä¸èƒ½åŒ…å«æ¨¡æ¿å‡½æ•°: éæ¨¡æ¿ç±»åªèƒ½åŒ…å«éæ¨¡æ¿å‡½æ•°ï¼Œä¸èƒ½åŒ…å«æ¨¡æ¿å‡½æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="comment">// ä¸º getValue å‡½æ•°å£°æ˜æ¨¡æ¿å‚æ•°ï¼Œå³ getValue å‡½æ•°ä¸ºæ¨¡æ¿å‡½æ•°</span></span><br><span class="line">T MyTemplateClass&lt;T&gt;::<span class="built_in">getValue</span>() <span class="type">const</span> &#123; <span class="comment">// ä¸º MyTemplateClass&lt;T&gt; å®šä¹‰ getValue</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ ˆä¸Šåˆ›å»ºä¸å †ä¸Šåˆ›å»º</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ˆä¸Šåˆ›å»º</span></span><br><span class="line"><span class="function">MyTemplateClass&lt;<span class="type">int</span>&gt; <span class="title">intObject1</span><span class="params">(<span class="number">10</span>)</span></span>;  <span class="comment">// å˜é‡åintObject1ï¼Œå€¼10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å˜é‡å(å€¼)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å †ä¸Šåˆ›å»º</span></span><br><span class="line">MyTemplateClass&lt;<span class="type">int</span>&gt;* intObject2 = <span class="keyword">new</span> <span class="built_in">MyTemplateClass</span>&lt;<span class="type">int</span>&gt;(<span class="number">20</span>);</span><br></pre></td></tr></table></figure>
<h4 id="GDT-LDTä¸TSS">GDT, LDTä¸TSS</h4>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240609174716552.png" class="" title="image-20240609174716552">
<p>ç¡¬ä»¶å‚å•†æ¨èé€šè¿‡æ¯ä¸ªä»»åŠ¡æ‹¥æœ‰ä¸€ä¸ªLDTå’Œä¸€ä¸ªTSSçš„æ–¹å¼å®ç°å¤šä»»åŠ¡</p>
<p>eg: call 0x0018:0x1234 ä½¿ç”¨åœ¨GDTä¸­ç´¢å¼•0x0018çš„é€‰æ‹©å­è·å¾—æ®µåŸºå€ï¼Œåç§»0x1234</p>
<blockquote>
<p>åœ¨ä½¿ç”¨ä¸­ï¼Œæ®µå¯„å­˜å™¨ä¸­çš„å€¼å°†ç¡®å®šä½¿ç”¨GDT/LDTä¸­çš„ç¬¬xé¡¹</p>
</blockquote>
<h4 id="æ®µæè¿°ç¬¦ä¸é—¨æè¿°ç¬¦åŒºåˆ«">æ®µæè¿°ç¬¦ä¸é—¨æè¿°ç¬¦åŒºåˆ«</h4>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416192952163.png" class="" title="image-20240416192952163">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417104649804.png" class="" title="image-20240417104649804">
<p>é—¨ = é€‰æ‹©å­ + åç§»</p>
<p>é€‰æ‹©å­ = åŸºå€ + åç§»</p>
<p>IDT ä¿å­˜ ä¸­æ–­é—¨</p>
<p>GDT/LDT ä¿å­˜ ä»»åŠ¡é—¨/æè¿°ç¬¦</p>
<h4 id="ç‰©ç†åœ°å€ç©ºé—´ä½¿ç”¨æƒ…å†µ">ç‰©ç†åœ°å€ç©ºé—´ä½¿ç”¨æƒ…å†µ</h4>
<p>tiny-os kernelåœ°å€ç©ºé—´</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240421151156773.png" class="" title="image-20240421151156773">
<p>åœ°å€ç©ºé—´ï¼š</p>
<p>0x0009a000ä¸ºä½å›¾èµ·å§‹åœ°å€ï¼Œå 4é¡µ</p>
<p>0x0009e000ä¸ºå†…æ ¸PCBèµ·å§‹ï¼Œå 1é¡µ</p>
<p>â€‹	0x0009f000ä¸ºPCBä¸­å†…æ ¸æ ˆé¡¶(ä½1Måœ°å€ä¸­æ‰€ä½¿ç”¨åˆ°çš„æœ€é«˜åœ°å€)</p>
<p>0x0009f000~0x00100000ä¸ºç©º</p>
<p>0x00100000ä¸ºå†…æ ¸å †èµ·å§‹ï¼Œ</p>
<p>â€‹	0x00100000~0x00101fffä¸ºé¡µç›®å½•è¡¨å’Œé¡µè¡¨</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240427095137775.png" class="" title="image-20240427095137775">
<p>SiFive FU540</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240412184838896.png" class="" title="image-20240412184838896.png">
<p>ç”¨æˆ·ç¨‹åºåœ°å€ç©ºé—´</p>
<p>è™šæ‹Ÿåœ°å€ï¼š</p>
<p>KERNBASE = 0x8000 0000</p>
<p>KERNLINK = 0x8010 0000</p>
<p>KERNBASE+PHYSTOP = 0x8E00 0000</p>
<p>DEVSPACE = 0xFE00 0000</p>
<p>ç‰©ç†åœ°å€ï¼š</p>
<p>ä½1Méƒ¨åˆ†ï¼š0 - 0x10 0000</p>
<p>éƒ¨åˆ†å†…æ ¸æ•°æ®+ç©ºé—²ç©ºé—´ï¼ˆç”¨æˆ·ç¨‹åºæ‰€åˆ†é…çš„é¡µè¡¨ï¼‰ï¼š0x10 0000 - 0xE00 0000(PHYSTOP)</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240412200020614.png" class="" title="image-20240412200020614">
<p>ç”¨æˆ·ç¨‹åºè™šæ‹Ÿå†…å­˜å†…å®¹</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240413095215393.png" class="" title="image-20240413095215393">
<p>Linux 0.11</p>
<p>è™šæ‹Ÿåœ°å€ç©ºé—´ä½¿ç”¨æƒ…å†µ</p>
<p>æ¯ä¸ªè¿›ç¨‹æœ€å¤§è™šæ‹Ÿç©ºé—´ä¸º64MBï¼ˆå·¨å¤§å·®å¼‚</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706102456745.png" class="" title="image-20240706102456745">
<h4 id="ä¼šè¯session">ä¼šè¯session</h4>
<p>è¿›ç¨‹é€šè¿‡forkåˆ›å»ºæ–°çš„å­è¿›ç¨‹ï¼Œè¿›ç¨‹ä¸åˆ›å»ºå‡ºçš„å­è¿›ç¨‹åŒå±ä¸€ä¸ªè¿›ç¨‹ç»„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> main.c | grep <span class="keyword">for</span> | more</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä¸‰ä¸ªå‘½ä»¤å¯¹åº”ä¸‰ä¸ªè¿›ç¨‹ï¼ŒåŒå±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼ŒCTRL+Cå°†ä¸­æ­¢è¯¥è¿›ç¨‹ç»„çš„æ‰€æœ‰è¿›ç¨‹</p>
<p>Sessionä¸ºè¿›ç¨‹ç»„çš„é›†åˆï¼Œç”¨æˆ·é€šè¿‡ttyç™»å½•åæ‰€æœ‰çš„å‘½ä»¤(æ‰§è¡Œçš„ç¨‹åº)å±äºåŒä¸€ä¸ªsession</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240609190505627.png" class="" title="image-20240609190505627">
<h3 id="å¼•å¯¼å¯åŠ¨ç¨‹åº">å¼•å¯¼å¯åŠ¨ç¨‹åº</h3>
<h4 id="å¯åŠ¨æµç¨‹å›¾">å¯åŠ¨æµç¨‹å›¾</h4>
<p>Linux</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240608151929426.png" class="" title="image-20240608151929426">
<h4 id="BIOS">BIOS</h4>
<p>è®¡ç®—æœºå¯åŠ¨æ—¶ä¸ºå®æ¨¡å¼è¿è¡Œï¼Œ20ä½åœ°å€çº¿ï¼Œä»…èƒ½è®¿é—®1MBç©ºé—´</p>
<p>æœºå™¨ä¸Šç”µï¼Œcs:ip åˆå§‹åŒ–ä¸º 0xf000:0x1110ï¼›</p>
<p>CPUä»0xffff0å¼€å§‹æ‰§è¡Œï¼Œæ‰§è¡Œè‡³0xfffffå¤„æŒ‡ä»¤jumpåè·³è½¬è‡³ f000:e05bï¼ŒBIOSä¸»ä½“ä»£ç æ‰€åœ¨å¤„ï¼›</p>
<p>BIOSå†…å®¹ä»£ç è¿›è¡Œç¡¬ä»¶æ£€æµ‹ï¼ˆå†…å­˜æ£€æµ‹ï¼Œæ˜¾å¡æ£€æµ‹â€¦ï¼‰ï¼Œ</p>
<p>åœ¨0x000-0x3ffå¤„å»ºç«‹æ•°æ®ç»“æ„ï¼Œä¸­æ–­å‘é‡è¡¨IVTï¼Œå¡«å†™ä¸­æ–­ä¾‹ç¨‹ï¼Œ</p>
<p>è¿›è¡Œå¯åŠ¨ç›˜æ£€æµ‹(0ç›˜0é“1æ‰‡åŒºæœ€å2ä¸ªå­—èŠ‚:55AA)ï¼Œä»ç¡¬ç›˜0ç›˜0é“1æ‰‡åŒºåŠ è½½MBRè‡³0x7c00åï¼Œè·³è½¬æ‰§è¡ŒMBRã€‚</p>
<h4 id="MBR">MBR</h4>
<p>MBRå 512å­—èŠ‚ï¼ˆä¸€ä¸ªæ‰‡åŒºï¼‰ï¼Œç»“å°¾å†…å®¹ä¸º55AAã€‚</p>
<p>MBRç¨‹åºä½äº0x7c00</p>
<p>Linux: boot/bootsect.s</p>
<p>bootsectç¨‹åº(MBR)ä½äº0x7c00ï¼Œç„¶åbootsectå°†è‡ªèº«å¤åˆ¶åˆ°0x90000å¤„ï¼Œæ‰§è¡Œè·³è½¬è‡³0x90000ï¼Œä½¿ç”¨0x9ff00ä¸ºæ ˆé¡¶</p>
<p>bootsectå°†setupç¨‹åºå†™å…¥0x90200å¤„ï¼Œå°†systemåŠ è½½è‡³0x10000å¤„</p>
<p>â€‹	ps:æœªç›´æ¥åŠ è½½å†…æ ¸è‡³0x00000çš„åŸå› æ˜¯0x00000æœ‰ä¸­æ–­å‘é‡è¡¨</p>
<p>tiny_os</p>
<p>MBRç¨‹åºå°†loaderç¨‹åºå†™å…¥0x90000å¤„</p>
<h4 id="setup-loader">setup&amp;loader</h4>
<p>Linux: boot/setup.s</p>
<p>ä½¿ç”¨å®æ¨¡å¼ä¸‹çš„ä¸­æ–­å‘é‡è¡¨è¯»å–æœºå™¨æ•°æ®ï¼ˆè¯»å–å±å¹•å…‰æ ‡ä½ç½®ï¼Œè¯»å–æ‰©å±•å†…å­˜å¤§å°ï¼Œè¯»å–æ˜¾å¡æ˜¾ç¤ºæ¨¡å¼ï¼Œæ£€æŸ¥æ˜¾ç¤ºæ–¹å¼å¹¶å–å‚æ•°ï¼Œå–ç¡¬ç›˜0ä¿¡æ¯ï¼Œå–ç¡¬ç›˜1ä¿¡æ¯ï¼Œæ£€æŸ¥ç¡¬ç›˜2ä¿¡æ¯ï¼‰ï¼Œå†™å…¥0x90000åŠä»¥åå¤„ï¼ˆè¦†ç›–bootsectï¼‰</p>
<p>å°†å†…æ ¸ä»0x10000~0x8ffffç§»åŠ¨è‡³0x00000~0x7ffffå¤„ï¼Œ</p>
<p>å¼€å¯A20åœ°å€çº¿</p>
<p>ä¿®æ”¹æ§åˆ¶å¯„å­˜å™¨CR0ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼</p>
<p>è·³è½¬è‡³åœ°å€0x00000ï¼ˆé€šè¿‡æ®µé€‰æ‹©å­2ï¼Œåç§»0è½¬ç§»ï¼‰</p>
<p>ä¸´æ—¶gdtå·²é€šè¿‡dataæ®µå½¢å¼å®ç°åœ¨setup.sç¨‹åºå°¾éƒ¨</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706144702481.png" class="" title="image-20240706144702481">
<p>tiny_os</p>
<p>loaderç¨‹åºä½äº0x90000ï¼Œä½¿ç”¨0x90000ä»¥ä¸‹éƒ¨åˆ†ä½œä¸ºç¨‹åºæ ˆ</p>
<p>loaderè®¾ç½®gdtï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œå¹¶åœ¨ä¿æŠ¤æ¨¡å¼åŠ è½½å†…æ ¸</p>
<h5 id="ä¿æŠ¤æ¨¡å¼">ä¿æŠ¤æ¨¡å¼</h5>
<p>ä¿æŠ¤æ¨¡å¼ä½¿æœºå™¨ä»16ä½è¿›å…¥åˆ°32ä½ï¼Œå¯»å€æ–¹å¼å˜æ›´ä¸º åŸºå€+åç§»</p>
<h6 id="æ®µæè¿°ç¬¦ä¸å…¨å±€æè¿°ç¬¦è¡¨GDT">æ®µæè¿°ç¬¦ä¸å…¨å±€æè¿°ç¬¦è¡¨GDT</h6>
<p>æ®µå¯„å­˜å™¨: cs, ds, â€¦(16ä½å¯„å­˜å™¨)ï¼Œä¿å­˜é€‰æ‹©å­ï¼Œå³gdt/ldtçš„indexå¯¹äºçš„å€¼</p>
<p>é€‰æ‹©å­</p>
<p>RPLï¼šç‰¹æƒç­‰çº§ï¼›TIï¼šé€‰æ‹©GDT/LDTï¼›ç´¢å¼•å€¼ï¼šGDT/LDTè¡¨ä¸­çš„ç¬¬xä¸ªæ®µæè¿°ç¬¦</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416193845119.png" class="" title="image-20240416193845119">
<p>GDTR</p>
<p>ä¿å­˜GDTçš„ç‰©ç†åœ°å€ï¼ŒGDTçš„æ®µæè¿°ç¬¦è®°å½•äº†å„å†…å­˜æ®µçš„ç›¸å…³ä¿¡æ¯</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416193617238.png" class="" title="image-20240416193617238">
<p>LDTR</p>
<p>ä¿å­˜LDTçš„å†…å­˜åœ°å€ï¼Œ<strong>LDTå¿…é¡»åœ¨GDTä¸­å£°æ˜</strong>ï¼Œé€šè¿‡GDTè·å¾—LDTå†…å­˜åœ°å€åå†™å…¥LDTRåä½¿ç”¨LDT</p>
<p>GDT</p>
<p>item: æ®µæè¿°ç¬¦</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416192952163.png" class="" title="image-20240416192952163">
<p>æ®µåŸºå€ï¼š32ä½æ®µåŸºå€ï¼›</p>
<p>æ®µç•Œé™ï¼šå¯¹äºæ•°æ®æ®µå’Œä»£ç æ®µï¼Œæ®µç•Œé™å‘é«˜åœ°å€å»¶ç”³ï¼›å¯¹äºæ ˆï¼Œæ®µç•Œé™å‘ä½åœ°å€å»¶ç”³ï¼›è‹¥åç§»é‡è¶…ç•Œé”™ï¼›æ®µå¤§å°ç”± æ®µç•Œé™*G ç¡®å®šï¼Œ</p>
<p>DPLï¼šæ®µç‰¹æƒçº§</p>
<p>Sï¼šæ˜¯å¦ç³»ç»Ÿæ®µ</p>
<p>TYPEï¼šæ®µç±»å‹</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240427102403905.png" class="" title="image-20240427102403905">
<p>æ®µæè¿°ç¬¦ç¼“å†²å¯„å­˜å™¨</p>
<p>ä¿å­˜å¤„ç†åçš„æ®µæè¿°ç¬¦</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420192623948.png" class="" title="image-20240420192623948">
<p>æ®µæè¿°ç¬¦ä¸å†…å­˜æ®µ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240427102456078.png" class="" title="image-20240427102456078">
<p>åœ°å€è®¡ç®—æ–¹å¼=32ä½æ®µåŸºå€+32æ®µåç§»</p>
<h5 id="ä¿æŠ¤æ¨¡å¼çš„å¯åŠ¨">ä¿æŠ¤æ¨¡å¼çš„å¯åŠ¨</h5>
<p>Linux: boot/setup.s</p>
<p>ä½¿ç”¨å®æ¨¡å¼ä¸‹çš„ä¸­æ–­å‘é‡è¡¨è¯»å–æœºå™¨æ•°æ®ï¼Œå†™å…¥0x90000å¤„ï¼ˆè¦†ç›–bootsectï¼‰</p>
<p>æ•´ä½“ä¸‹ç§»å†…æ ¸è‡³0x00000å¤„ï¼Œ</p>
<p>è®¾ç½®ä¸´æ—¶ldtå’Œgdtï¼ŒåŠ è½½ldtrå’Œgdtrï¼Œå¼€å¯A20åœ°å€çº¿ï¼›</p>
<p>é‡æ–°è®¾å¤‡ä¸­æ–­æ§åˆ¶èŠ¯ç‰‡8259Aï¼Œè®¾ç½®ç¡¬ä»¶ä¸­æ–­å·ä¸º0x20 ~ 0x2fï¼Œä¿®æ”¹CR0å¯„å­˜å™¨</p>
<p>è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œè·³è½¬è‡³åœ°å€0x00000</p>
<p>tiny_os</p>
<p>loaderç¨‹åºä½äº0x90000ï¼Œä½¿ç”¨0x90000ä»¥ä¸‹éƒ¨åˆ†ä½œä¸ºç¨‹åºæ ˆ</p>
<p>1.æ„å»ºGDTï¼Œ<strong>GDTå†…å®¹ç›´æ¥å®šä¹‰åœ¨loaderå†…</strong></p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240427102121106.png" class="" title="image-20240427102121106">
<p>2.å¼€å¯A20åœ°å€çº¿</p>
<p>A20åœ°å€çº¿ï¼š20ä½åœ°å€çº¿çš„CPUè‡ªåŠ¨å‘ç”Ÿåœ°å€å›ç»•ï¼ˆ20ä½æ®µåŸºå€+16ä½æ®µåç§»æ‰€äº§ç”Ÿçš„è¶…å‡º1MBçš„éƒ¨åˆ†ï¼‰</p>
<p>32ä½åœ°å€çº¿ä¸ºäº†å…¼å®¹20ä½åœ°å€çº¿äº§ç”Ÿçš„åœ°å€å›ç»•ï¼Œåœ¨å…³é—­A20åœ°å€çº¿æ—¶ï¼ŒCPUå°†è¿›è¡Œåœ°å€å›ç»•ï¼›åœ¨å¼€å¯A20åœ°å€çº¿æ—¶ï¼Œæ­£ç¡®è®¿é—®ï¼›</p>
<p>3.åŠ è½½GDTåœ°å€åˆ°GDTR</p>
<p>4.ç½®ä½CR0å¯„å­˜å™¨çš„PEä½</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416195112069.png" class="" title="image-20240416195112069">
<p>5.å°†æ®µå¯„å­˜å™¨å†…å®¹æ›´æ–°ä¸ºæ®µé€‰æ‹©å­å†…å®¹</p>
<p>Linux:[ç±»ä¼¼]</p>
<p>ä¸´æ—¶gdtåŒ…å«äº†ä¸¤ä¸ªæ®µæè¿°ç¬¦ï¼Œæ•°æ®æ®µæè¿°ç¬¦å’Œä»£ç æ®µæè¿°ç¬¦ï¼Œæ®µåŸºå€å‡ä¸º0x00000</p>
<p>è·³è½¬0x00000å¤„</p>
<h4 id="head-loader">head&amp;loader</h4>
<h5 id="é¡µè¡¨ç»„æˆä¸æ„å»º">é¡µè¡¨ç»„æˆä¸æ„å»º</h5>
<p>è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€æ˜ å°„å…³ç³»</p>
<p>è™šå®è½¬æ¢ç”±MMU(Memory Management Unit)ç¡¬ä»¶å®ç°ï¼Œ</p>
<p>CPUä¸­çš„SATPå¯„å­˜å™¨ä¿å­˜Page Table Entryï¼ŒæŒ‡å‘æœ€é«˜ä¸€çº§çš„é¡µç›®å½•page directoryçš„ç‰©ç†å†…å­˜åœ°å€</p>
<p>CPUä¸­çš„TLB(Translation Lookside Buffer)ä¿å­˜è¿‘æœŸè®¿é—®çš„PTEå†…å®¹</p>
<p>XV6</p>
<p>é¡µè¡¨ä¸­çš„æ¯ä¸€é¡¹ä¸ºPTE(Page Table Entry)ï¼Œä¸€ä¸ªPTE 54bitï¼Œä¸€çº§é¡µè¡¨ä¸º3.375KB</p>
<p>é€šè¿‡SATPå¯„å­˜å™¨è·å¾—æœ€é«˜çº§é¡µè¡¨çš„ç‰©ç†åœ°å€PPNï¼Œä½¿ç”¨L2æŸ¥æœ€é«˜çº§é¡µè¡¨è·å¾—ä¸­é—´çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼›ä½¿ç”¨L1æŸ¥ä¸­é—´çº§é¡µè¡¨è·å¾—æœ€ä½çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼›ä½¿ç”¨L0æŸ¥æœ€ä½çº§é¡µè¡¨ï¼Œè·å¾—ç‰©ç†åœ°å€ï¼›</p>
<p>é€šè¿‡TLBè·å–ç‰©ç†åœ°å€PPNï¼›</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240412190738605.png" class="" title="image-20240412190738605">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240412192043741.png" class="" title="image-20240412192043741">
<p>Linux 2.6</p>
<p>è™šæ‹Ÿåœ°å€é«˜10ä½ï¼Œåœ¨é¡µç›®å½•è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”ç´¢å¼•ï¼Œè·å¾—é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼ˆ20ä½ï¼Œä½™ä¸‹12ä½è¡¥0ï¼‰ï¼›</p>
<p>è™šæ‹Ÿåœ°å€ä¸­10ä½ï¼Œåœ¨é¡µè¡¨ä¸­æŸ¥æ‰¾å¯¹åº”ç´¢å¼•ï¼Œè·å¾—é¡µçš„ç‰©ç†åœ°å€ï¼ˆ20ä½ï¼Œä½™ä¸‹12ä½è¡¥0ï¼‰ï¼›</p>
<p>è™šæ‹Ÿåœ°å€å12ä½ï¼Œé¡µå†…åç§»ï¼›</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240420140907729.png" class="" title="image-20240420140907729">
<p>tiny-os</p>
<p>ç”¨æˆ·ä½¿ç”¨ä½3GBï¼Œå†…æ ¸ä½¿ç”¨é«˜1GBï¼Œæ¯é¡µ4KB</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240427102727532.png" class="" title="image-20240427102727532">
<p>å»ºç«‹é¡µç›®å½•è¡¨â€“é¡µç›®å½•è¡¨çš„é¡¹å³æŒ‡å‘ä¸€ä¸ªé¡µè¡¨</p>
<p>åœ¨ç‰©ç†åœ°å€0x100000å»ºç«‹é¡µç›®å½•è¡¨ï¼Œä¸€ä¸ªé¡µç›®å½•è¡¨å«1024ä¸ªé¡µè¡¨é¡¹PDEï¼Œæ¯ä¸ªé¡µç›®å½•è¡¨é¡¹4Bï¼Œå 4KBï¼Œ</p>
<p>ç¬¬0é¡¹ï¼ˆä¿è¯loaderç¨‹åºåœ¨å¯åŠ¨é¡µè¡¨åèƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼‰æŒ‡å‘ç¬¬ä¸€ä¸ªé¡µè¡¨ï¼Œç‰©ç†åœ°å€0x101000</p>
<p>ç¬¬768é¡¹ï¼ˆè™šæ‹Ÿåœ°å€3GBï¼Œç”¨æˆ·ç¨‹åºè®¿é—®å†…æ ¸ï¼‰æŒ‡å‘ç¬¬ä¸€ä¸ªé¡µè¡¨ï¼Œç‰©ç†åœ°å€0x101000</p>
<p>ç¬¬1023é¡¹æŒ‡å‘é¡µç›®å½•è¡¨ï¼Œç‰©ç†åœ°å€0x100000</p>
<p>å»ºç«‹é¡µè¡¨</p>
<p>åœ¨ç‰©ç†åœ°å€0x101000å»ºç«‹ï¼Œä¸€ä¸ªé¡µè¡¨å«1024ä¸ªé¡µè¡¨é¡¹ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹4Bï¼Œå 4KBï¼Œå¯è¡¨ç¤º4KB*1024=4MBçš„åœ°å€ç©ºé—´</p>
<p>è¯¥é¡µè¡¨æŒ‡å‘çš„ç‰©ç†åœ°å€ä¸º0-0x3fffff</p>
<h5 id="head-s-é¡µè¡¨æ„å»ºä¸è¿›å…¥åˆ†é¡µæ¨¡å¼">head.s / é¡µè¡¨æ„å»ºä¸è¿›å…¥åˆ†é¡µæ¨¡å¼</h5>
<p>Linux: boot/head.s</p>
<p>![image-20240609161606117](file://D:/github/blog/source/_posts/Op-sys-Learning-Record/image-20240609161606117.png?lastModify=1717920885)</p>
<p>ä½äºç‰©ç†åœ°å€0x00000å¤„</p>
<p>åŠ è½½æ•°æ®æ®µå¯„å­˜å™¨ï¼Œ</p>
<p>é‡æ–°è®¾ç½®idtrï¼Œå¾ªç¯åˆ›å»º256é¡¹ä¸­æ–­æè¿°ç¬¦ï¼Œå…¨éƒ¨æŒ‡å‘å“‘ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆè¯¥ç¨‹åºä½äº0x6000~ä¸­æ–­æè¿°ç¬¦è¡¨å‰ï¼Œå›¾ä¸­çš„head.séƒ¨åˆ†ä»£ç ï¼‰</p>
<p>é‡æ–°è®¾ç½®gdtr</p>
<p>æ£€æŸ¥A20åœ°å€çº¿æ˜¯å¦å¼€å¯</p>
<p>æ£€æŸ¥æœºå™¨æ˜¯å¦å«æœ‰æ•°å­¦åå¤„ç†å™¨ï¼Œä¿®æ”¹CR0å¯„å­˜å™¨æ ‡å¿—ä½</p>
<p>å°†mainä»£ç çš„åœ°å€å‹å…¥ä½äº(ss: å†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦, esp: å†…æ ¸schedæ¨¡å—user_stackå¤„ )çš„æ ˆï¼Œ</p>
<p>è®¾ç½®é¡µç›®å½•è¡¨ï¼ˆä¸ºå…¨ä½“è¿›ç¨‹ä½¿ç”¨ï¼‰ä¸é¡µè¡¨ï¼Œ4ä¸ªé¡µè¡¨ï¼ˆå†…æ ¸ä¸“ç”¨é¡µè¡¨ï¼Œæ–°çš„è¿›ç¨‹çš„é¡µè¡¨ä¼šåœ¨ä¸»å†…å­˜åŒºç”³è¯·ï¼‰ä½äºé¡µç›®å½•è¡¨ä¹‹åï¼Œå¯»å€16Mbç©ºé—´ï¼ˆ4KB/é¡µè¡¨å¤§å°ï¼Œ4B/é¡µè¡¨é¡¹ï¼Œ1024*4KB=4MBæ¯é¡¹å¯»å€ç©ºé—´ï¼‰</p>
<p>iretå¼¹å‡ºå…¥æ ˆçš„mainå‡½æ•°åœ°å€ï¼Œè·³è½¬å‰å¾€æ‰§è¡Œmainå‡½æ•°</p>
<blockquote>
<p>è¿™æ®µæ±‡ç¼–å…ˆä»0x0000å¼€å§‹è¿è¡Œï¼Œç„¶åè¿è¡Œåˆ°è®¾ç½®å†…å­˜é¡µè¡¨çš„æ—¶å€™ä½¿ç”¨.orgå‘åè·³ï¼Œç©ºå‡ºå†…å­˜é¡µè¡¨çš„ç©ºé—´0x1000~0x5000ï¼Œä¸€ç›´è·³åˆ°0x6000å¤„ç»§ç»­ï¼Œå°†mainå‚æ•°å’Œåœ°å€å‹æ ˆï¼Œç„¶åè·³è¿‡å“‘ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå¼€å§‹åˆ›å»ºé¡µå†…å­˜ç›®å½•è¡¨å’Œå†™å…¥åˆšæ‰ç©ºå‡ºæ¥çš„å†…å­˜é¡µè¡¨ï¼ˆé¡µå†…å­˜ç›®å½•è¡¨åˆ›å»ºåœ¨0x0000ï¼Œè¿™æ„å‘³ç€åŸæœ¬ä½äºè¿™é‡Œçš„head.sçš„ä»£ç å°†è¢«è¦†ç›–</p>
<p>idtæ˜¯å¾ªç¯åˆ›å»ºçš„ï¼Œgdtæ˜¯é¢„å…ˆæ‰‹å†™å¥½çš„</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706163733389.png" class="" title="image-20240706163733389">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706163716837.png" class="" title="image-20240706163716837">
<p>Linux 0.1x å†…æ ¸å’Œæ‰€æœ‰è¿›ç¨‹å…±ç”¨0x0000çš„é¡µç›®å½•è¡¨ï¼ˆè¿™æ„å‘³ç€CR3å¯„å­˜å™¨ä¸­çš„å€¼å§‹ç»ˆä¸º0x0000ï¼Œå³å…¨éƒ¨è¿›ç¨‹å…±äº«çš„é¡µç›®å½•è¡¨ï¼Œ</p>
<p>å…¶ä»–çš„4é¡µé¡µè¡¨ä¸ºå†…æ ¸ä¸“ç”¨ï¼Œç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨å­˜æ”¾åœ¨éšæœºçš„ä¸»å†…å­˜åŒº</p>
</blockquote>
<p>tiny_os</p>
<p>loaderä¸­å®ç°é¡µè¡¨çš„æ„å»ºä¸è¿›å…¥åˆ†é¡µæ¨¡å¼</p>
<p>loaderç¨‹åº</p>
<p>6.æ¸…ç©ºé¡µç›®å½•å ç”¨ç©ºé—´0x100000+4096</p>
<p>7.åˆ›å»ºé¡µç›®å½•é¡¹å¹¶å†™å…¥é¡µç›®å½•è¡¨ç¬¬0é¡¹(æŒ‡å‘ç¬¬1ä¸ªé¡µè¡¨)ï¼Œç¬¬768é¡¹(æŒ‡å‘ç¬¬1ä¸ªé¡µè¡¨)å’Œç¬¬1023é¡¹(æŒ‡å‘é¡µç›®å½•è¡¨ï¼Œè¯¥é¡¹ç”¨äºä¿®æ”¹é¡µç›®å½•è¡¨)</p>
<p>8.åˆ›å»ºé¡µè¡¨é¡¹å†™å…¥ç¬¬1ä¸ªé¡µè¡¨(ä½äº0x101000)ï¼Œåˆ†é…ç‰©ç†åœ°å€0~0x3fffff(å®éªŒç”¨miniå†…æ ¸åœ¨æ­¤å¤„)</p>
<p>9.åˆ›å»ºé¡µç›®å½•é¡¹å¹¶å†™å…¥é¡µç›®å½•è¡¨ç¬¬769é¡¹~ç¬¬1022é¡¹(æŒ‡å‘ç¬¬2,3,4â€¦ä¸ªé¡µè¡¨,ç¬¬2,3,4â€¦ä¸ªé¡µè¡¨ä½äº0x102000,0x103000â€¦)</p>
<p>10.ä¿®æ”¹gdtä¸­æ®µæè¿°ç¬¦çš„åœ°å€å€¼ï¼Œä¸Šç§»è‡³0xc0000000ä»¥ä¸Š</p>
<p>11.ä¿®æ”¹gdtåŸºå€ï¼Œä¿®æ”¹espï¼Œä¸Šç§»è‡³0xc0000000ä»¥ä¸Š</p>
<p>12.å°†é¡µç›®å½•åœ°å€èµ‹å€¼ç»™cr3ï¼Œæ‰“å¼€cr3çš„pgä½ï¼Œæ–°gdtå€¼å†™å…¥gdtr</p>
<p>åˆ†é¡µæ¨¡å¼å¯åŠ¨ï¼Œ</p>
<p>ç¨‹åº<strong>æ­¤æ—¶</strong>å·²è¿›å…¥è™šæ‹Ÿåœ°å€è¿è¡Œï¼Œ</p>
<p>å½“å‰è™šæ‹Ÿåœ°å€0x0000xxxxï¼Œä»å¤„äºä½1Måœ°å€ç©ºé—´ä¸­(é¡µç›®å½•è¡¨ç¬¬ä¸€é¡¹æŒ‡å‘ç¬¬ä¸€ä¸ªé¡µè¡¨çš„åŸå› )ï¼›</p>
<p>ä»gdtä¸­è·å¾—çš„æ®µæè¿°ç¬¦çš„å€¼ä¸ºè™šæ‹Ÿåœ°å€ï¼›</p>
<h4 id="å†…å­˜åˆ†æ®µæœºåˆ¶">å†…å­˜åˆ†æ®µæœºåˆ¶</h4>
<p>â€‹	<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706103147318.png" class="" title="image-20240706103147318"></p>
<p>ä»è¯¥å›¾å¯ä»¥çœ‹å‡ºï¼Œåç§»å€¼(IP)å’Œæ®µé€‰æ‹©å­(CS/DS/â€¦)ä¸­çš„åœ°å€ä¸ºè™šæ‹Ÿåœ°å€ï¼Œ</p>
<p>é€šè¿‡æ®µé€‰æ‹©å­è¯»å–æ®µæè¿°ç¬¦è¡¨ä¸­çš„æ®µæè¿°ç¬¦è·å–å®Œæ•´è™šæ‹Ÿåœ°å€åŸºå€ï¼Œå¾—åˆ°çº¿æ€§åœ°å€ï¼›</p>
<p>ä½¿ç”¨çº¿æ€§åœ°å€æ ¹æ®é¡µç›®å½•è¡¨å’Œé¡µè¡¨å¾—åˆ°ç‰©ç†åœ°å€</p>
<h4 id="main-c-loader">main.c&amp;loader</h4>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240609163346462.png" class="" title="image-20240609163346462">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240609180508264.png" class="" title="image-20240609180508264">
<p>Linux: main.c &amp; ä»»åŠ¡0ï¼ˆidleè¿›ç¨‹ï¼‰</p>
<p>åˆå§‹åŒ–è®¾å¤‡ä¸å†…å­˜ä¿¡æ¯ï¼š</p>
<p>â€‹	æ ¹è®¾å¤‡å·ï¼Œé«˜é€Ÿç¼“å­˜æœ«ç«¯åœ°å€ï¼Œæœºå™¨å†…å­˜é‡ï¼Œä¸»å†…å­˜å¼€å§‹åœ°å€ï¼›</p>
<p>è°ƒç”¨å†…æ ¸ä¸­åˆå§‹åŒ–å‡½æ•°åˆå§‹åŒ–å„åŠŸèƒ½éƒ¨åˆ†ï¼›</p>
<ul>
<li>ä¸»å†…å­˜åŒºåˆå§‹åŒ–</li>
<li>ç¡¬ä»¶ä¸­æ–­å‘é‡åˆå§‹åŒ–</li>
<li>å—è®¾å¤‡åˆå§‹åŒ–</li>
<li>å­—ç¬¦è®¾å¤‡åˆå§‹åŒ–</li>
<li>ttyåˆå§‹åŒ–</li>
<li>æ—¶é—´åˆå§‹åŒ–ï¼Œè®¿é—®CMOSè·å–</li>
<li>è°ƒåº¦ç¨‹åºåˆå§‹åŒ–</li>
<li>ç¼“å­˜åˆå§‹åŒ–</li>
<li>ç¡¬ç›˜åˆå§‹åŒ–</li>
<li>è½¯é©±åˆå§‹åŒ–</li>
</ul>
<p>ç§»åŠ¨åˆ°ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œ</p>
<blockquote>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706162745211.png" class="" title="image-20240706162745211">
<p>æ­¤å¤„çš„å®å‡½æ•°move_to_user_modeå±•å¼€åï¼Œå®é™…ä¸Šæ˜¯åŸåœ°è·³è½¬ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†</p>
<p>csæ®µé€‰æ‹©ç¬¦-&gt;(ldtrå¯„å­˜å™¨)LDTè¡¨çš„RPL=3çš„ç¬¬ä¸€ä¸ªæ®µé€‰æ‹©å­ï¼Œä»»åŠ¡0ä»£ç æ®µ</p>
<p>eip-&gt;ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€(åŸåœ°è·³è½¬)</p>
<p>ds, es, fs, gs -&gt; (ldtrå¯„å­˜å™¨)LDTè¡¨çš„RPL=3çš„ç¬¬äºŒä¸ªæ®µé€‰æ‹©å­ï¼Œä»»åŠ¡0æ•°æ®æ®µ</p>
<p>ssæœªå˜æ›´ï¼Ÿ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706163156118.png" class="" title="image-20240706163156118">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240706163204640.png" class="" title="image-20240706163204640">
</blockquote>
<p>forkåˆ›å»ºå‡ºä»»åŠ¡1(init())</p>
<p>å¾ªç¯pauseçŠ¶æ€â€”</p>
<p>â€‹	ps: ç¨‹åºè¿›å…¥interruptibleçŠ¶æ€ï¼ˆé—²ç½®è¿›ç¨‹ï¼‰ï¼Œæ— ä»»åŠ¡å¯è°ƒåº¦æ—¶è°ƒåº¦ä»»åŠ¡0</p>
<p>â€‹	ps:ä»»åŠ¡0ä¸ºæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œæ•…ä¸ä½¿ç”¨å †æ ˆ</p>
<p>Linux: main.c/init() ä»»åŠ¡1</p>
<p>è¯»å–ç¡¬ç›˜å‚æ•°ï¼ˆåŒ…å«åˆ†åŒºè¡¨ä¿¡æ¯ï¼‰ï¼ŒåŠ è½½è™šæ‹Ÿç›˜ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡</p>
<p>ä»¥è¯»å†™æ–¹å¼æ‰“å¼€tty0ï¼Œå¾—åˆ°æ–‡ä»¶å¥æŸ„0stdinï¼Œå¤åˆ¶ä¸¤æ¬¡å¾—åˆ°stdoutå’Œstderr</p>
<p>forkäº§ç”Ÿä»»åŠ¡2ï¼Œç­‰å¾…ä»»åŠ¡2é€€å‡º</p>
<p>å¾ªç¯</p>
<p>è‹¥äº§ç”Ÿçš„å­è¿›ç¨‹æ­»äº¡ï¼Œé‡æ–°äº§ç”Ÿæ–°çš„è¿›ç¨‹å¹¶è¿›å…¥wait</p>
<blockquote>
<p>ä»»åŠ¡1ä¸ä»»åŠ¡0åŒºåˆ«</p>
<p>ä»»åŠ¡1çš„é¡µè¡¨åœ¨ä¸»å†…å­˜åŒºï¼Œå¯¹äºä»»åŠ¡1ï¼Œåœ¨é¡µç›®å½•è¡¨æœ‰å¯¹åº”äºè‡ªå·±çš„é¡µç›®å½•è¡¨é¡¹ï¼Œé¡µè¡¨å†…å®¹ä¸ä»»åŠ¡0ç›¸åŒï¼Œè™šæ‹Ÿåœ°å€é«˜ä»»åŠ¡0ä¸€ä¸ªé¡µç›®å½•è¡¨é¡¹ï¼ˆåœ¨å›¾ä¸­çº¿æ€§åœ°å€ä¸­ä½“ç°ï¼Œé«˜çš„åŸå› æ˜¯ä»»åŠ¡1çš„é¡µç›®å½•è¡¨é¡¹ä¸ºç¬¬äºŒä¸ª</p>
<p>ä»»åŠ¡1ä¼šåœ¨ä¸»å†…å­˜åŒºç”³è¯·1é¡µå­˜æ”¾PCB+å†…æ ¸æ ˆ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240713185606091.png" class="" title="image-20240713185606091">
</blockquote>
<p>Linux: main.c/init() ä»»åŠ¡2</p>
<p>å…³é—­ä»ä»»åŠ¡1æ‰€ç»§æ‰¿çš„stdinï¼Œstdoutå’Œstderrï¼›åˆ›å»ºæ–°çš„ä¼šè¯æœŸ</p>
<p>tiny_os</p>
<p>loaderä¸­å®ç°kernelå†™å…¥å†…æ ¸</p>
<p>loaderç¨‹åºä½äº0x90000ï¼Œä½¿ç”¨0x90000ä»¥ä¸‹éƒ¨åˆ†ä½œä¸ºç¨‹åºæ ˆ</p>
<p>13.è¯»ç£ç›˜æŒ‡å®šæ‰‡åŒºï¼Œå†™kernel.binåˆ°è™šæ‹Ÿåœ°å€0xc0070000~0xc009fbff</p>
<p>14.åˆå§‹åŒ–kernelï¼Œå°†kernel.binä¸­çš„segmentå¤åˆ¶åˆ°è¢«ç¼–è¯‘çš„è™šæ‹Ÿåœ°å€å¤„ï¼Œç¬¬ä¸€ä¸ªsegmentèµ·å§‹äº0xc0001500</p>
<p>15.ä¿®æ”¹æ ˆæŒ‡é’ˆï¼Œè·³è½¬è‡³kernelï¼Œè™šæ‹Ÿåœ°å€0xc0001500</p>
<h2 id="ä¸­æ–­">ä¸­æ–­</h2>
<h3 id="å¤–éƒ¨ä¸­æ–­ä¸å†…éƒ¨ä¸­æ–­">å¤–éƒ¨ä¸­æ–­ä¸å†…éƒ¨ä¸­æ–­</h3>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240421152049031.png" class="" title="image-20240421152049031">
<p>ä¸­æ–­å¼•è„šï¼š</p>
<p>INTR: Interupter</p>
<p>NMI: Non Maskable Interupter	å‘CPUä¼ å…¥ä¸­æ–­å‘é‡å· 2</p>
<p>å¤–éƒ¨è®¾å¤‡ä¸­æ–­ç”±ä¸­æ–­ä»£ç†èŠ¯ç‰‡8259Aæ¥æ”¶åå‘é€ä¸­æ–­å‘é‡å·åˆ°CPUä¸­æ–­å¼•è„šINTR</p>
<p>Linuxï¼š int32 ~ int47 -&gt; IRQ0 ~ IRQ15</p>
<p>è½¯ä¸­æ–­ï¼šç³»ç»Ÿè°ƒç”¨</p>
<p>Linuxï¼šint128</p>
<p>å¼‚å¸¸ï¼šæŒ‡é’ˆè¶Šç•Œï¼Œæ ˆæº¢å‡º</p>
<p>Linuxï¼šint0 ~ int31</p>
<h3 id="å®æ¨¡å¼ä¸‹çš„ä¸­æ–­å‘é‡è¡¨">å®æ¨¡å¼ä¸‹çš„ä¸­æ–­å‘é‡è¡¨</h3>
<p>ä»…åœ¨å®æ¨¡å¼ä½¿ç”¨ï¼Œç”±BIOSè¿›è¡Œåˆ›å»ºï¼Œä½äº0x00000~0x003ff</p>
<h3 id="ä¸­æ–­é—¨ä¸ä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¸­æ–­æè¿°ç¬¦è¡¨IDT">ä¸­æ–­é—¨ä¸ä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¸­æ–­æè¿°ç¬¦è¡¨IDT</h3>
<p>ä¸­æ–­å‘é‡å·ä¸º ä¸­æ–­å‘é‡è¡¨/ä¸­æ–­æè¿°ç¬¦è¡¨ çš„ç´¢å¼•ä¸‹æ ‡</p>
<p>IDTR(Interrupt Descriptor Table Register) ä¸­ä¿å­˜ IDT ä½ç½®ä¿¡æ¯</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417105214817.png" class="" title="image-20240417105214817">
<p>IDT(Interrupt Descriptor Table)</p>
<p>item: é—¨</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417104649804.png" class="" title="image-20240417104649804">
<h3 id="ä¸­æ–­è¿‡ç¨‹">ä¸­æ–­è¿‡ç¨‹</h3>
<h4 id="ä¸­æ–­åˆå§‹åŒ–">ä¸­æ–­åˆå§‹åŒ–</h4>
<p>tiny_os</p>
<p>å®æ¨¡å¼ç”±BIOSåˆ›å»ºä¸­æ–­å‘é‡è¡¨å’Œä¸­æ–­å¤„ç†ç¨‹åºï¼›</p>
<p>ä¿æŠ¤æ¨¡å¼ç”±kernelåˆ›å»ºä¸­æ–­æè¿°ç¬¦è¡¨å’Œä¸­æ–­å¤„ç†ç¨‹åºï¼›</p>
<p>1.kernelè¿›è¡Œä¸­æ–­åˆå§‹åŒ–ï¼šä¸­æ–­æè¿°ç¬¦åˆå§‹åŒ–ï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºåˆå§‹åŒ–ï¼Œpicåˆå§‹åŒ–</p>
<p>2.ä¸­æ–­æè¿°ç¬¦åˆå§‹åŒ–ï¼šåˆ›å»ºä¸­æ–­æè¿°ç¬¦ï¼Œæè¿°ç¬¦ä¸­çš„åç§»é‡ç”±ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åºçš„åç§»ç»™å‡º(ä½äºkernel.asmï¼Œä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åºåœ¨è¿›è¡Œä¸Šä¸‹æ–‡ä¿å­˜åcalläºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå³è¯¥åˆå§‹åŒ–ä¸­åˆ›å»ºçš„å¼‚å¸¸å¤„ç†ç¨‹åº)ï¼Œå†™å…¥ä¸­æ–­æè¿°ç¬¦è¡¨</p>
<p>3.å¼‚å¸¸å¤„ç†ç¨‹åºåˆå§‹åŒ–ï¼šå°†å¼‚å¸¸å¤„ç†ç¨‹åºçš„åœ°å€å†™å…¥äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åºè¡¨ï¼Œè¯¥è¡¨ä¿å­˜å‡½æ•°åœ°å€ï¼Œç”±ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åºcallï¼›</p>
<p>4.picåˆå§‹åŒ–</p>
<p>5.å°†ä¸­æ–­æè¿°ç¬¦è¡¨åœ°å€å†™å…¥idtr</p>
<h4 id="ä¸­æ–­å¤„ç†è¿‡ç¨‹">ä¸­æ–­å¤„ç†è¿‡ç¨‹</h4>
<p>1.ä¸­æ–­è¯·æ±‚</p>
<p>ä¸­æ–­è¯·æ±‚å¯èƒ½ä¸ºå†…éƒ¨ä¸­æ–­æˆ–è€…å¤–éƒ¨ä¸­æ–­</p>
<p>å¤–éƒ¨ä¸­æ–­å¦‚ä¸‹ï¼š</p>
<p>å½“å¤–è®¾å‘å‡ºä¸­æ–­ä¿¡å·åï¼Œä¿¡å·è¢«é€å…¥8259Aï¼›</p>
<p>8259Aæ£€æŸ¥IMRå¯„å­˜å™¨ä¸­æ˜¯å¦å±è”½äº†æ¥è‡ªè¯¥IRQçš„ä¿¡å·ï¼Œè‹¥IMRå¯„å­˜å™¨ä¸­å¯¹åº”çš„ä½ä¸º1ï¼Œè¡¨ç¤ºå±è”½äº†IRQä»£è¡¨çš„ä¸­æ–­ï¼Œåˆ™ä¸¢æ‰æ­¤ä¸­æ–­ä¿¡å·ï¼Œè‹¥IMRå¯„å­˜å™¨ä¸­å¯¹åº”çš„ä½ä¸º0ï¼Œè¡¨ç¤ºæœªå±è”½æ­¤ä¸­æ–­ï¼Œåˆ™å°†IRRå¯„å­˜å™¨ä¸­ä¸æ­¤ä¸­æ–­å¯¹åº”çš„ä½ ç½®1ã€‚</p>
<p>PRä¼˜å…ˆçº§è£å†³å™¨ä»IRRå¯„å­˜å™¨ä¸­æŒ‘é€‰ä¸€ä¸ªä¼˜å…ˆçº§æœ€å¤§çš„ä¸­æ–­ï¼Œç„¶å8259Aå‘CPUå‘é€INTRä¿¡å·ã€‚</p>
<p>å†…éƒ¨ä¸­æ–­ç”±ä»£ç é€šè¿‡ä¸­æ–­å‘é‡å·è§¦å‘ã€‚</p>
<p>2.(å¤–)ä¸­æ–­å“åº”</p>
<p>CPUæ”¶åˆ°INTRä¿¡å·åä¾¿çŸ¥é“æœ‰æ–°çš„ä¸­æ–­äº†ï¼Œåœ¨æ‰§è¡Œå®Œå½“å‰æŒ‡ä»¤åï¼Œå‘8259Aå‘é€ä¸€ä¸ªä¸­æ–­å›å¤ä¿¡å·ã€‚</p>
<p>8259Aæ”¶åˆ°å›å¤ä¿¡å·åï¼Œå°†é€‰å‡ºæ¥çš„ä¼˜å…ˆçº§æœ€å¤§çš„ä¸­æ–­åœ¨ISRå¯„å­˜å™¨ä¸­ç›¸åº”çš„ä½ ç½®1ï¼Œè¡¨ç¤ºè¯¥ä¸­æ–­æ­£åœ¨å¤„ç†ï¼ŒåŒæ—¶å°†æ­¤ä¸­æ–­åœ¨IRRå¯„å­˜å™¨ä¸­ç›¸åº”çš„ä½ ç½®0ï¼Œç›¸å½“äºå°†æ­¤ä¸­æ–­ä»ä¸­æ–­è¯·æ±‚é˜Ÿåˆ—ä¸­å»æ‰ã€‚</p>
<p>CPUå†å‘8259Aå‘é€INTRä¿¡å·ï¼Œè¡¨ç¤ºæƒ³è¦è·å–ä¸­æ–­å‘é‡å·ã€‚</p>
<p>8259Aé€šè¿‡æ•°æ®æ€»çº¿å‘CPUå‘é€ä¸­æ–­å‘é‡å·ï¼Œ<strong>ä¸­æ–­å‘é‡å· = èµ·å§‹å‘é‡å· + IRQæ¥å£å·</strong>ï¼Œä¸€èˆ¬èµ·å§‹å‘é‡å·ä¸º32ï¼Œä»ä¸­æ–­å‘é‡è¡¨å¯çœ‹å‡º0â€”31å·²ç»è¢«å ç”¨ï¼Œåé¢çš„32â€”127æ˜¯åˆ†é…ç»™å¯å±è”½ä¸­æ–­çš„ï¼Œæ‰€ä»¥æ­¤å¤„å¤–è®¾çš„ä¸­æ–­è®¾ç½®çš„èµ·å§‹å‘é‡å·ä¾¿ä¸º32ã€‚</p>
<p>3.ä¿æŠ¤ç°åœº__å‹æ ˆ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714201118464.png" class="" title="image-20240714201118464">
<p>CPUæ®ä¸­æ–­å‘é‡å·å»IDTä¸­è·å–ä¸­æ–­æè¿°ç¬¦ï¼Œ</p>
<blockquote>
<p>æ­¤æ—¶å°†å–å‡ºé€‰æ‹©å­ä¸­çš„DPLä¸å½“å‰ç‰¹æƒçº§CPLè¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç‰¹æƒçº§å‘ç”Ÿå˜åŒ–ï¼Œåˆ™éœ€è¦åˆ‡æ¢æ ˆï¼ˆä¸åŒç‰¹æƒçº§æœ‰ç€ä¸åŒçš„æ ˆï¼Œå¦‚Linuxä½¿ç”¨äº†0ï¼Œ 3ç‰¹æƒçº§ï¼Œåˆ™æœ‰ä¸¤ä¸ªæ ˆï¼Œä¸€ä¸ªå†…æ ¸æ ˆï¼Œä¸€ä¸ªç”¨æˆ·æ ˆï¼‰ã€‚</p>
</blockquote>
<p>å¤„ç†å™¨ä»å½“å‰ä»»åŠ¡çš„TSSæ®µï¼ˆæ¯ä¸€ä¸ªä»»åŠ¡æœ‰ä¸€ä¸ªTSSç»“æ„ï¼Œå…¶ä¸­ä¿å­˜ç€ä¸åŒç‰¹æƒçº§æ ˆçš„SSå’ŒESPå€¼ï¼‰ä¸­è·å–ä¸DPLç‰¹æƒçº§ç›¸åŒçš„æ ˆä¿¡æ¯ï¼Œå¤„ç†å™¨å°†å½“å‰çš„æ—§çš„SSå’ŒESPçš„å€¼å‹å…¥ç›®æ ‡æ ˆ(<strong>æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„å†…æ ¸æ ˆ</strong>).</p>
<p>å‘å†…æ ¸æ ˆå‹å…¥EFLAGSå¯„å­˜å™¨å€¼</p>
<p>å‘å†…æ ¸æ ˆå‹å…¥CSï¼ŒEIPå€¼ã€‚</p>
<p>è‹¥è¯¥ä¸­æ–­æœ‰é”™è¯¯ç ï¼Œå‹å…¥é”™è¯¯ç ï¼Œ</p>
<p>å°† æ®µé€‰æ‹©ç¬¦ï¼Œåç§»å€¼å†™å…¥CS, EIP, å‰å¾€æ‰§è¡Œä¸€é˜¶ä¸­æ–­æœåŠ¡ç¨‹åº</p>
<p>å›¾ç¤ºä¸ºå‘ç”Ÿäº†ç‰¹æƒçº§æ”¹å˜æ—¶çš„å‹æ ˆæƒ…å†µ</p>
<p><strong>ä»¥ä¸Šè¿‡ç¨‹ä¸ç”±ä¸€é˜¶ä¸­æ–­ç¨‹åºå®ç°ï¼Œç¡¬ä»¶è‡ªåŠ¨å®ç°</strong></p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240421154614894.png" class="" title="image-20240421154614894">
<p>4.å®šä½ä¸­æ–­æœåŠ¡ç¨‹åº</p>
<p>è®¿é—®ä¸­æ–­å¤„ç†ç¨‹åºçš„æµç¨‹</p>
<p>1.é€šè¿‡idtrè·å¾—idtçš„åœ°å€ï¼Œå°†ä¸­æ–­å‘é‡å·ä½œä¸ºç´¢å¼•ï¼Œè®¿é—®åˆ°ä¸­æ–­æè¿°ç¬¦</p>
<p>2.ä¸­æ–­æè¿°ç¬¦ç»™å‡º<strong>ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>çš„æ®µé€‰æ‹©å­å’Œåç§»</p>
<p>3.é€šè¿‡gdtrè·å¾—gdtçš„åœ°å€ï¼Œå°†æ®µé€‰æ‹©å­ä½œä¸ºç´¢å¼•ï¼Œè®¿é—®åˆ°æ®µæè¿°ç¬¦</p>
<p>4.æ®µæè¿°ç¬¦ç»™å‡º<strong>ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>çš„æ®µ<strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417110140482.png" class="" title="image-20240417110140482">
<p>5.é€šè¿‡æ®µ<strong>è™šæ‹Ÿåœ°å€</strong>å’Œåç§»è®¿é—®åˆ°<strong>ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>ï¼Œ</p>
<p><strong>ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>å°†Cå‡½æ•°åœ°å€(äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº)å‹æ ˆï¼Œåå°†åœ°å€äº¤æ¢å†™å…¥eax, åŸeaxå€¼å…¥æ ˆ</p>
<p>å…¶ä½™ä¸Šä¸‹æ–‡(ebx,ecx,edx,edi,esi,ebp,ds,es,fs)å‹æ ˆï¼Œ</p>
<p>å‹å…¥é”™è¯¯ç ï¼Œå‹å…¥æ‰§è¡Œä¸€é˜¶ä¸­æ–­ç¨‹åºå‰çš„æ ˆæŒ‡é’ˆ(esp0)ï¼Œä½œä¸º<strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åºå‚æ•°</strong></p>
<p>å¹¶åœ¨<strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>æ‰§è¡Œå®Œæˆåï¼Œ</p>
<p>å¼¹å‡ºé”™è¯¯ç å’Œesp0ï¼Œå¼¹å‡ºä¸Šä¸‹æ–‡</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240702102514943.png" class="" title="image-20240702102514943">
<p>6.ä¸­æ–­å¤„ç†è¿‡ç¨‹</p>
<p><strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>ï¼Œæ‰“å°å‡ºé”™ç¨‹åºä¿¡æ¯</p>
<p>ä¸­æ–­çš„å®é™…å¤„ç†è¿‡ç¨‹å°±æ˜¯æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºï¼ŒLinuxå°†ä¸­æ–­å¤„ç†ç¨‹åºåˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œéœ€è¦ç´§æ€¥å¤„ç†ç«‹å³æ‰§è¡Œçš„å½’ä¸ºä¸ŠåŠéƒ¨ï¼Œä¸é‚£ä¹ˆç´§æ€¥çš„å½’ä¸ºä¸‹åŠéƒ¨ã€‚</p>
<p>å¼€ä¸­æ–­ï¼Œå³EFLAGSçš„IFä½ç½®1ï¼Œè¡¨ç¤ºå…è®¸å“åº”ä¸­æ–­ï¼›å…³ä¸­æ–­ï¼Œå³EFLAGSçš„IFä½ç½®0ï¼Œè¡¨ç¤ºä¸å…è®¸å“åº”ä¸­æ–­ã€‚</p>
<p>ä¸ŠåŠéƒ¨åˆ†æ˜¯åˆ»ä¸å®¹ç¼“çš„ï¼Œéœ€è¦ç«‹å³æ‰§è¡Œçš„éƒ¨åˆ†ï¼Œæ‰€ä»¥è¦åœ¨å…³ä¸­æ–­çš„çŠ¶æ€ä¸‹æ‰§è¡Œã€‚</p>
<p>è€Œä¸‹åŠéƒ¨åˆ†ä¸é‚£ä¹ˆç´§æ€¥ï¼Œåœ¨å¼€ä¸­æ–­çš„æƒ…å†µä¸‹è¿›è¡Œï¼Œå¦‚æœæ­¤æ—¶æœ‰æ–°çš„ä¸­æ–­å‘ç”Ÿï¼Œå½“å‰ä¸­æ–­å¤„ç†ç¨‹åºä¾¿ä¼šæ¢ä¸‹CPUï¼ŒCPUä¼šå¦å¯»æ—¶é—´é‡æ–°è°ƒåº¦ï¼Œå®Œæˆæ•´ä¸ªä¸­æ–­å¤„ç†ç¨‹åºã€‚</p>
<p>7.ä¸­æ–­è¿”å›â€”â€”å‡ºæ ˆ</p>
<p>ä¸­æ–­è¿”å›å°±æ˜¯å‡ºæ ˆçš„è¿‡ç¨‹ï¼Œå°†ç¬¬ä¸‰æ­¥ä¿æŠ¤ç°åœºå‹å…¥æ ˆä¸­çš„ä¿¡æ¯å¼¹å‡ºã€‚</p>
<p>æœ‰é”™è¯¯ç å¼¹å‡ºé”™è¯¯ç ã€‚</p>
<p>æ­¤æ—¶çš„æ ˆé¡¶æŒ‡é’ˆESPåº”æŒ‡å‘EIP_oldï¼Œå‰©ä½™æ ˆä¸­çš„ä¿¡æ¯ä½¿ç”¨iretæŒ‡ä»¤å¼¹å‡ºï¼ŒCPUæ‰§è¡Œåˆ°iretæŒ‡ä»¤æ—¶å†æ¬¡æ£€æŸ¥å’Œæ¯”è¾ƒç‰¹æƒçº§æ˜¯å¦å˜åŒ–ã€‚</p>
<p>å¼¹å‡ºEIP_old, CS_old</p>
<p>è‹¥ç‰¹æƒçº§å˜åŒ–ï¼Œå°†ESP_old, SS_old, åŠ è½½åˆ°ESPï¼ŒSSå¯„å­˜å™¨ã€‚</p>
<h3 id="ä¸­æ–­å¤„ç†ç¨‹åº">ä¸­æ–­å¤„ç†ç¨‹åº</h3>
<p>Linux: asm.s, traps.c</p>
<p>asm.s</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240702102514943.png" class="" title="image-20240702102514943">
<p><strong>ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>å°†Cå‡½æ•°åœ°å€(äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº)å‹æ ˆï¼Œåå°†è¯¥å€¼äº¤æ¢è¿›å…¥eax, åŸeaxå€¼å…¥æ ˆ</p>
<p>å…¶ä½™ä¸Šä¸‹æ–‡(ebx,ecx,edx,edi,esi,ebp,ds,es,fs)å‹æ ˆï¼Œ</p>
<p>å‹å…¥é”™è¯¯ç (æˆ–0)ï¼Œå‹å…¥æ‰§è¡Œä¸€é˜¶ä¸­æ–­ç¨‹åºå‰çš„æ ˆæŒ‡é’ˆ(esp0)ï¼Œä½œä¸º<strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åºå‚æ•°</strong></p>
<p>æ”¹å˜æ®µå¯„å­˜å™¨ds, es, fsä¸ºå†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦</p>
<p>call<strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>,</p>
<p>å¹¶åœ¨<strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>æ‰§è¡Œå®Œæˆåï¼Œå¼¹å‡ºé”™è¯¯ç å’Œesp0ï¼Œå¼¹å‡ºä¸Šä¸‹æ–‡</p>
<p>traps.c</p>
<p><strong>äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>, æ‰“å°å‡ºé”™ä¿¡æ¯</p>
<p>åˆå§‹åŒ–ï¼Œè®¾ç½®ä¸­æ–­è°ƒç”¨é—¨ï¼Œä¼ å…¥<strong>ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº</strong>(å‡½æ•°)çš„åœ°å€</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºä¸ä¿¡å·">ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºä¸ä¿¡å·</h3>
<p>Linux: system.c</p>
<p><strong>å«æ—¶é’Ÿä¸­æ–­!!!</strong></p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240704153835415.png" class="" title="image-20240704153835415">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240704190208804.png" class="" title="image-20240704190208804">
<p>å¯¹äºç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åº(ä¸€é˜¶ä¸­æ–­å¤„ç†ç¨‹åº)ï¼š</p>
<p>åˆ¤æ–­è°ƒç”¨å·èŒƒå›´</p>
<p>å‹æ ˆds, es, fs, edx, ecx, ebx,</p>
<p>ä¿®æ”¹ds, es, fs,</p>
<p>call å¯¹åº”çš„Cå¤„ç†å‡½æ•°(äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº)</p>
<p>å‹æ ˆeax(äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›å€¼)</p>
<p>if(ä»»åŠ¡éå°±ç»ª/æ—¶é—´ç‰‡è€—å°½):</p>
<p>â€‹	æ‰§è¡Œè°ƒåº¦ç¨‹åº</p>
<p>â€‹	æ‰§è¡Œret_from_sys_call</p>
<p>else:</p>
<p>â€‹	æ‰§è¡Œret_from_sys_call</p>
<p>å¯¹äºå‡½æ•°ret_from_sys_callï¼š</p>
<p>if(éåˆå§‹ä»»åŠ¡/éè¶…çº§ç”¨æˆ·ç¨‹åº/?):</p>
<p>â€‹	å–å½“å‰ä»»åŠ¡ç»“æ„çš„ä¿¡å·ä½å›¾ï¼Œå–ä¿¡å·å±è”½ç ï¼Œå¾—åˆ°å¯è¡Œä¿¡å·å›¾ï¼Œå¤ä½ä¿¡å·å›¾å¹¶å†™å›</p>
<p>â€‹	å°†å¯è¡Œä¿¡å·å›¾ä¸­æœ€å°çš„ä¿¡å·å‹æ ˆï¼Œcall do_signalï¼Œ</p>
<p>å¼¹å‡ºä¿¡å·å€¼signr, eax, ebx, ecx, edx, fs, es, ds</p>
<blockquote>
<p>æ­¤æ—¶csä¸ºç”¨æˆ·ä»£ç æ®µé€‰æ‹©å­ï¼Œeipä¸ºä¿¡å·å¤„ç†ç¨‹åºï¼›å†…æ ¸æ ˆä¸­çš„sså’Œespå°†åœ¨cpuæ£€æŸ¥æ®µé€‰æ‹©å­çš„rpléƒ¨åˆ†æ—¶å‘ç°è¿›å…¥ä½ç‰¹æƒçº§ï¼Œå¼¹å‡ºå¹¶å†™å…¥ï¼›</p>
<p>åç»­æ‰§è¡Œä¿¡å·å¤„ç†ç¨‹åºï¼Œretæ—¶å°†ç”¨æˆ·æ ˆé¡¶çš„restorerå†™å…¥eipï¼Œæ‰§è¡Œrestorerï¼›</p>
<p>restorerä¸¢å¼ƒç”¨æˆ·æ ˆé¡¶çš„ä¿¡å·å€¼signr, è®¾ç½®ä¿¡å·å±è”½ç , ä¸¢å¼ƒblock, å¼¹å‡ºeax, ecx, edx, eflags, retå°†ç”¨æˆ·æ ˆé¡¶çš„åŸeipå†™å…¥eipï¼Œæ¢å¤ç³»ç»Ÿè°ƒç”¨å‰çŠ¶æ€</p>
</blockquote>
<p>â€‹</p>
<p>å‡½æ•°do_signalï¼š</p>
<blockquote>
<p>sys_signalå’Œsys_sigactionä¿®æ”¹è¿›ç¨‹task_structçš„sigaction[32]ï¼Œç”¨äºä¿®æ”¹åœ¨æ¥æ”¶ä¿¡å·æ—¶çš„å¤„ç†å‡½æ•°ï¼Œè¿”å›åŸå¯¹åº”ä¿¡å·çš„å¤„ç†å‡½æ•°æŒ‡é’ˆ</p>
<p>sigaction[32]çš„é¡¹ï¼š</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240704193952350.png" class="" title="image-20240704193952350">
<p>sys_sigactionæ˜¯sys_signalçš„è¶…é›†</p>
</blockquote>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240704190208804.png" class="" title="image-20240704190208804">
<p>ä»task_struct-&gt;sigaction[32]ä¸­è·å–ä¿¡å·signrå¯¹åº”çš„sigaction</p>
<p>if(éå¿½ç•¥å¥æŸ„/éé»˜è®¤å¥æŸ„):</p>
<p>â€‹	è‹¥sigaction-&gt;sa_flagä¸ºoneshot, å°†å¥æŸ„ç½®ç©º</p>
<p>â€‹	ä¿®æ”¹å†…æ ¸å †æ ˆä¸­eipçš„å€¼ä¸ºä¿¡å·å¤„ç†ç¨‹åºå¥æŸ„</p>
<p>â€‹	ä¸‹ç§»ç”¨æˆ·å †æ ˆå¯¹åº”espï¼Œå¹¶å‘ç”¨æˆ·å †æ ˆå†™å…¥å›¾ç¤ºå€¼</p>
<blockquote>
<p>sa_restorer</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240704195323779.png" class="" title="image-20240704195323779">
</blockquote>
<p><strong>ä¿¡å·</strong></p>
<p>æœ‰ä¸Šå¯çŸ¥ï¼Œä¿¡å·å°†åœ¨ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶æ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨è¯¥ç¨‹åºtask_structä¸­sigaction[32]ä¸­è®¾ç½®çš„å¤„ç†å‡½æ•°è¿›è¡Œå¤„ç†</p>
<p>å‘æŸç¨‹åºå‘ä¿¡æ¯ -&gt; ä¿®æ”¹è¯¥ç¨‹åºtask_structçš„signal</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240705101522972.png" class="" title="image-20240705101522972">
<h3 id="ä¸­æ–­å¤„ç†ç¨‹åº-ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºçš„æ³¨å†Œ">ä¸­æ–­å¤„ç†ç¨‹åº/ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºçš„æ³¨å†Œ</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">register_handler</span><span class="params">(<span class="type">uint8_t</span> vec_no, intr_handler handler)</span> &#123;</span><br><span class="line">    sys_call_table[vec_no] = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹<strong>ä¸­æ–­å¤„ç†ç¨‹åºè¡¨/ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºè¡¨</strong>æŒ‡å‘çš„äºŒé˜¶ä¸­æ–­å¤„ç†ç¨‹åº</p>
<p>ä»…åœ¨å†…æ ¸æ€å¯ä¿®æ”¹æ­¤ç±»è¡¨</p>
<h2 id="è¿›ç¨‹ä¸çº¿ç¨‹">è¿›ç¨‹ä¸çº¿ç¨‹</h2>
<h3 id="TSSä¸ä»»åŠ¡é“¾">TSSä¸ä»»åŠ¡é“¾</h3>
<p>TR(Task Register)</p>
<p>ä¿å­˜TSSåœ°å€</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714093840136.png" class="" title="image-20240714093840136">
<p>Task State Segment</p>
<p>TSSæè¿°ç¬¦ä¿å­˜äºGDT</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240506191146645.png" class="" title="image-20240506191146645">
<p>TSSå†…å®¹</p>
<p>ä¿å­˜ä»»åŠ¡å¿«ç…§ï¼ˆä»»åŠ¡è¢«æ¢ä¸Š/æ¢ä¸‹CPUæ—¶ï¼‰</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240506191245406.png" class="" title="image-20240506191245406">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240428111029824.png" class="" title="image-20240428111029824">
<p>TSSæ®µ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240713192515176.png" class="" title="image-20240713192515176">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240713192710613.png" class="" title="image-20240713192710613">
<h3 id="PCB">PCB</h3>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240705104639547.png" class="" title="image-20240705104639547">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240705104656011.png" class="" title="image-20240705104656011">
<blockquote>
<p>è¿›ç¨‹çš„é¡µç›®å½•è¡¨åŸºå€ä¿å­˜åœ¨PCBï¼Œlinux 0.1xçš„æ‰€æœ‰è¿›ç¨‹çš„è¿™ä¸ªå€¼å‡ä¸º0x0000</p>
<p>è¿›ç¨‹çš„tssä½äºPCB</p>
<p>è¿›ç¨‹çš„ldtä½äºPCBå’Œtss</p>
</blockquote>
<h3 id="è¿›ç¨‹">è¿›ç¨‹</h3>
<p>Linux</p>
<h4 id="fork">fork</h4>
<p>é€šè¿‡forkä»task0åˆ›å»º</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714144402746.png" class="" title="image-20240714144402746">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714144419322.png" class="" title="image-20240714144419322">
<blockquote>
<p>è¢«forkå‡ºæ¥çš„å­è¿›ç¨‹å°†å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µç›®å½•è¡¨å’Œé¡µè¡¨ï¼Œfork()åï¼Œå­è¿›ç¨‹å°†è·å¾—è‡ªå·±çš„PCBï¼Œå…¶ä¸­PCBçš„é¡µç›®å½•è¡¨åŸºå€å’Œçˆ¶è¿›ç¨‹ä¸ä¸€è‡´ï¼ŒæŒ‡å‘è‡ªå·±çš„é¡µç›®å½•è¡¨ã€‚è¯¥é¡µç›®å½•è¡¨å¯¹åº”é¡µè¡¨ä¸­çš„é¡µè¡¨é¡¹æŒ‡å‘çš„ç‰©ç†åœ°å€ä¸çˆ¶è¿›ç¨‹çš„ä¸€è‡´ï¼Œç›´è‡³å­è¿›ç¨‹å‘ç”Ÿå†™è¡Œä¸ºæ—¶åˆ†é…æ–°å†…å­˜é¡µï¼ˆå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼‰</p>
<p>åˆ›å»ºæ–°è¿›ç¨‹éœ€è¦åœ¨forkååœ¨å­è¿›ç¨‹å†…æ‰§è¡Œexecveåˆ‡æ¢æ‰§è¡Œå†…å®¹</p>
<p>forkçš„æ ¸å¿ƒå·¥ä½œæ˜¯å¤åˆ¶å‡ºæ–°çš„PCBï¼Œå¹¶ä¿®æ”¹PCBä¸­çš„å„å€¼(åŒ…æ‹¬å¯¹TSSçš„ä¿®æ”¹)</p>
</blockquote>
<h4 id="execve">execve</h4>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240715111107866.png" class="" title="image-20240715111107866">
<p>tiny_os</p>
<p>è¿›ç¨‹åˆ›å»ºè¿‡ç¨‹</p>
<p>kernelå¯åŠ¨è¿›ç¨‹ï¼Œä¼ å…¥è¿›ç¨‹å‚æ•°ï¼ˆè¿›ç¨‹æ–‡ä»¶åå’Œè¿›ç¨‹åï¼‰ï¼Œå¯åŠ¨è¿›ç¨‹ã€‚</p>
<p>1.åˆå§‹åŒ–çº¿ç¨‹</p>
<p>ä»å†…æ ¸ç©ºé—´ç”³è¯·é¡µé¢ï¼Œæ¸…æ´—é¡µé¢ï¼Œåˆå§‹åŒ–çº¿ç¨‹åä¸ºçº¿ç¨‹/è¿›ç¨‹åï¼›</p>
<p>æ ¹æ®çº¿ç¨‹/è¿›ç¨‹ååˆå§‹åŒ–çº¿ç¨‹çŠ¶æ€ï¼›</p>
<p>åˆå§‹åŒ–ä¼˜å…ˆçº§ï¼Œæ—¶é—´ç‰‡ä¸Šé™ï¼Œå·²ä½¿ç”¨æ—¶é—´ç‰‡ï¼Œé¡µç›®å½•è¡¨åœ°å€ï¼Œå†…æ ¸æ ˆæŒ‡é’ˆï¼Œé­”æ•°ç­‰ï¼›</p>
<p>åŠ å…¥çº¿ç¨‹é˜Ÿåˆ—ï¼Œçº¿ç¨‹æŒ‡é’ˆthreadæŒ‡å‘è¯¥é¡µé¢åº•éƒ¨ï¼›</p>
<p>2.åˆ›å»ºç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€æ± </p>
<p>ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿåœ°å€æ± ä½äºPCBä¸­</p>
<p>è®¾ç½®è™šæ‹Ÿåœ°å€æ± èµ·å§‹äº0x00000000</p>
<p>è®¾ç½®è™šæ‹Ÿåœ°å€æ± æ‰€ç®¡ç†çš„ç©ºé—´çš„é¡µæ•°å’Œè™šæ‹Ÿåœ°å€æ± é•¿åº¦</p>
<p>3.åˆå§‹åŒ–å†…æ ¸æ ˆ</p>
<p>çº¿ç¨‹å†…æ ¸æ ˆä½ç½®ä¸ºPCBé¡µé¢é¡¶éƒ¨ï¼ˆé«˜åœ°å€ï¼‰ï¼Œthread-&gt;self_kstackä¸ºçº¿ç¨‹å†…æ ¸æ ˆæŒ‡é’ˆï¼›</p>
<p>ä¸‹ç§»thread-&gt;self_kstackï¼Œç•™å‡ºä¸­æ–­æ ˆç©ºé—´sizeof(intr_stack)</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240425101059850.png" class="" title="image-20240425101059850">
<p>ä¸‹ç§»thread-&gt;self_kstackï¼Œç•™å‡ºçº¿ç¨‹æ ˆç©ºé—´sizeof(thread_stack)</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240425101121206.png" class="" title="image-20240425101121206">
<p>åˆ›å»ºçº¿ç¨‹æ ˆæŒ‡é’ˆkthread_stackï¼ŒæŒ‡å‘å½“å‰thread-&gt;self_kstackæŒ‡é’ˆä½ç½®ï¼Œ</p>
<p>åˆå§‹åŒ–çº¿ç¨‹æ ˆï¼Œä¾æ¬¡å†™å…¥eipï¼Œå‡½æ•°åï¼Œå‡½æ•°å‚æ•°å’Œå¯„å­˜å™¨åˆå§‹å€¼ebp,ebx,esi,ediï¼›</p>
<p>thread-&gt;self_kstackæ­¤æ—¶ä½äºçº¿ç¨‹æ ˆæ ˆé¡¶ï¼Œæ ˆé¡¶å†…å®¹ä¸ºediï¼Œesiï¼Œebxï¼Œebpï¼Œå‡½æ•°å‚æ•°ï¼Œå‡½æ•°åï¼Œeipï¼›</p>
<p>//ä¸æ‰§è¡ŒretæŒ‡ä»¤ï¼Œå°†å‹æ ˆçš„å‡½æ•°å‚æ•°ï¼Œå‡½æ•°åå’Œè¿”å›åœ°å€å¼¹å‡ºï¼Œå¹¶å‰å¾€æ‰§è¡Œå¯¹åº”å‡½æ•°ï¼›</p>
<p>4.åˆ›å»ºç”¨æˆ·è¿›ç¨‹çš„é¡µç›®å½•è¡¨</p>
<p>ä»å†…æ ¸åˆ†é…ä¸€é¡µä½œä¸ºè¿›ç¨‹é¡µç›®å½•è¡¨</p>
<p>å°†å†…æ ¸é¡µç›®å½•è¡¨çš„é«˜åŠéƒ¨åˆ†ï¼ˆå¯¹åº”å†…æ ¸ç©ºé—´éƒ¨åˆ†ï¼‰é¡¹å¤åˆ¶åˆ°è¿›ç¨‹é¡µç›®å½•è¡¨ä¸­</p>
<p>è®¾ç½®æœ€åä¸€é¡¹é¡µè¡¨çš„åœ°å€ä¸ºé¡µç›®å½•è¡¨åœ°å€</p>
<p>4.5 åˆå§‹åŒ–ç”¨æˆ·å†…å­˜å—è¡¨</p>
<p>5.åŠ å…¥è°ƒåº¦é“¾è¡¨</p>
<p>å…³ä¸­æ–­ï¼›</p>
<p>å°†è¿›ç¨‹åŠ å…¥è°ƒåº¦é“¾è¡¨ï¼›</p>
<p>å¼€ä¸­æ–­ï¼›</p>
<p>è¿›ç¨‹æ‰§è¡Œ</p>
<p>æ„å»ºç”¨æˆ·è¿›ç¨‹åˆå§‹ä¸Šä¸‹æ–‡ä¿¡æ¯</p>
<p>ç§»åŠ¨çº¿ç¨‹æ ˆæŒ‡é’ˆkthread_stackæŒ‡å‘intr_stacké¡¶éƒ¨ï¼Œçº¿ç¨‹æ ˆåº•éƒ¨</p>
<p>å†™å…¥ä¸­æ–­æ ˆï¼Œä¾æ¬¡å†™å…¥edi, esi, ebp, esp_dummy</p>
<p>ebx, edx, ecx, eax, gs,</p>
<p>ds, es, fs, eip, cs, eflag, esp, ss, æ­¤ç±»å¯„å­˜å™¨ä¸­å€¼å‡ä¸ºç”¨æˆ·ç©ºé—´ï¼Œä¸ºé€šè¿‡ä¸­æ–­è¿”å›çš„æ–¹å¼è¿›å…¥3ç‰¹æƒçº§åšå‡†å¤‡</p>
<p>thread-&gt;self_kstackæ­¤æ—¶ä½äºä¸­æ–­æ ˆæ ˆé¡¶ï¼Œæ ˆé¡¶å†…å®¹ä¸ºï¼š</p>
<p>vec_no, edi, esi, ebp, esp_dummyâ€¦</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240507185615764.png" class="" title="image-20240507185615764">
<p>å°†espè®¾ç½®ä¸ºä¸­æ–­æ ˆæ ˆé¡¶æŒ‡é’ˆthread-&gt;self_kstackï¼Œ</p>
<p>jmp intr_exitï¼Œè·³è¿‡å‹å…¥çš„ä¸­æ–­å‘é‡å·vec_noï¼Œpopadå¼¹å‡ºæ‰€æœ‰é€šç”¨å¯„å­˜å™¨å€¼ï¼Œpop gsï¼Œfsï¼Œesï¼Œdsï¼Œè·³è¿‡é”™è¯¯ç ï¼›æ­¤æ—¶æ ˆé¡¶ä¸ºï¼šeipå€¼ä¸ºfilenameï¼ˆæŒ‡å‘ç”¨æˆ·è¿›ç¨‹å…¥å£åœ°å€ï¼‰ï¼Œcså€¼ä¸ºSELECTOR_U_CODEï¼Œeflagä¸º(EFLAGS_IOPL_0 | EFLAGS_MBS | EFLAGS_IF_1);</p>
<p>å‰å¾€æ‰§è¡Œå¯¹åº”å‡½æ•°ï¼Œè¿›å…¥ç‰¹æƒçº§3ï¼›</p>
<h3 id="è°ƒåº¦">è°ƒåº¦</h3>
<p>è°ƒåº¦å‘ç”Ÿåœ¨ï¼š</p>
<p>Flag <code>need_sched</code>ä¸º1</p>
<p>1.ç³»ç»Ÿè°ƒç”¨/ä¸­æ–­(åŒ…æ‹¬æ—¶é—´ä¸­æ–­)-æ‰§è¡Œå¤„ç†å‡½æ•°åï¼Œè‹¥å½“å‰è¿›ç¨‹æ—¶é—´ç‰‡ä¸º0æˆ–ä»»åŠ¡æœªå°±ç»ªï¼Œè°ƒç”¨<code>schedule()</code></p>
<p>2.åˆ‡æ¢å½“å‰runningæ€è¿›ç¨‹ä¸ºå…¶ä»–æ€åï¼Œè°ƒç”¨<code>schedule()</code></p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240608144715684.png" class="" title="image-20240608144715684">
<p>TASK_INTERRUPTIBLEä¸TASK_UNINTERRUPTIBLE</p>
<p>TASK_INTERRUPTIBLEå¯æ¥æ”¶ä¿¡å·ï¼Œä¼šè¢«æå‰å”¤é†’å¹¶å“åº”ä¿¡å·</p>
<p>TASK_UNINTERRUPTIBLEå±è”½ä¿¡å·ï¼Œå³ä½¿æ˜¯ SIGKILL ä¿¡å·ä¹Ÿæ— æ³•å°†å…¶æ€æ­»ã€‚ åªæœ‰å½“å®ƒè‡ªå·± wake up ä¹‹åï¼Œæ‰ä¼šæŸ¥çœ‹ä¿¡å·ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚</p>
<p><strong>è¿›ç¨‹éœ€è¦è°ƒåº¦åˆ¤å®š</strong></p>
<p>PCB <code>need_resched</code> flag</p>
<p><strong><code>need_resched</code> æ ‡å¿—ä½œç”¨</strong></p>
<p>need_resched æ ‡å¿—ç”¨äºæŒ‡ç¤ºå†…æ ¸è°ƒåº¦å™¨ï¼Œå½“å‰è¿›ç¨‹éœ€è¦é‡æ–°è°ƒåº¦ã€‚å½“è¯¥æ ‡å¿—è¢«è®¾ç½®ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºå½“å‰è¿›ç¨‹çš„è¿è¡Œæ—¶é—´å·²ç»è¶…è¿‡äº†å…¶æ—¶é—´ç‰‡ï¼Œæˆ–è€…æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œå†…æ ¸è°ƒåº¦å™¨éœ€è¦åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶æœºé€‰æ‹©æ–°çš„è¿›ç¨‹è¿è¡Œã€‚</p>
<p><strong><code>need_resched</code> æ ‡å¿—ç”Ÿæ•ˆæ—¶æœº</strong></p>
<p>å¤šç§æƒ…å†µä¸‹ä¼šè®¾ç½® <code>need_resched</code> æ ‡å¿—ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>æ—¶é—´ç‰‡è€—å°½ï¼š</strong> å½“ä¸€ä¸ªè¿›ç¨‹è¿è¡Œçš„æ—¶é—´è¶…è¿‡äº†åˆ†é…ç»™å®ƒçš„æ—¶é—´ç‰‡æ—¶ï¼Œå†…æ ¸è°ƒåº¦å™¨ä¼šè®¾ç½®è¯¥è¿›ç¨‹çš„ <code>need_resched</code> æ ‡å¿—ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶é€‰æ‹©å…¶ä»–è¿›ç¨‹è¿è¡Œã€‚</li>
<li><strong>æ›´é«˜ä¼˜å…ˆçº§è¿›ç¨‹å°±ç»ªï¼š</strong> å½“ä¸€ä¸ªæ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€æ—¶ï¼Œå†…æ ¸è°ƒåº¦å™¨ä¼šè®¾ç½®å½“å‰è¿è¡Œè¿›ç¨‹ï¼ˆå¦‚æœå…¶ä¼˜å…ˆçº§ä½äºæ–°å°±ç»ªè¿›ç¨‹ï¼‰çš„ <code>need_resched </code>æ ‡å¿—ï¼Œä»¥ä¾¿å°½å¿«è°ƒåº¦æ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹è¿è¡Œã€‚</li>
<li><strong>è¿›ç¨‹ä¸»åŠ¨æ”¾å¼ƒ CPUï¼š</strong> å½“ä¸€ä¸ªè¿›ç¨‹ä¸»åŠ¨è°ƒç”¨ sched_yield() æˆ–ç±»ä¼¼çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¡¨ç¤ºå®ƒæ„¿æ„æ”¾å¼ƒ CPU ä½¿ç”¨æƒï¼Œæ­¤æ—¶å†…æ ¸ä¼šè®¾ç½®è¯¥è¿›ç¨‹çš„ <code>need_resched </code>æ ‡å¿—ã€‚</li>
<li><strong>ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€ï¼š</strong> å½“ä¸€ä¸ªè¿›ç¨‹ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥ <code>need_resched </code>æ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†è¯¥æ ‡å¿—ï¼Œåˆ™ä¼šè¿›è¡Œè¿›ç¨‹è°ƒåº¦ï¼Œåˆ‡æ¢åˆ°æ–°çš„è¿›ç¨‹è¿è¡Œã€‚</li>
</ul>
<p><strong><code>need_resched</code> æ ‡å¿—æ£€æŸ¥æ—¶æœº</strong></p>
<p>å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶ï¼šç³»ç»Ÿè°ƒç”¨è¿”å›/ä¸­æ–­è¿”å›ï¼ˆå«æ—¶é’Ÿä¸­æ–­ï¼‰</p>
<p>è‹¥<code>need_resched</code>æ ‡å¿—ä¸º<code>1</code>ï¼Œåˆ™è°ƒç”¨<code>schedule()</code></p>
<p><strong>ç­‰å¾…é˜Ÿåˆ—ä¸å”¤é†’</strong></p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240801110805754.png" class="" title="image-20240801110805754">
<p><strong>ä¸€ä¸ªæ–‡ä»¶è¡¨é¡¹ -&gt; ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ï¼ï¼</strong></p>
<p><strong>è¿‡ç¨‹</strong></p>
<ol>
<li>
<p><strong>è¿›ç¨‹ç¡çœ ï¼š</strong></p>
<ul>
<li>
<p>è¿›ç¨‹è°ƒç”¨ read() ç­‰ç³»ç»Ÿè°ƒç”¨è¯»å–é©±åŠ¨è®¾å¤‡æ•°æ®ï¼Œç”±äºæ•°æ®å°šæœªå‡†å¤‡å¥½ï¼Œé©±åŠ¨ç¨‹åºä¼šå°†è¿›ç¨‹åŠ å…¥åˆ°è‡ªèº«ç»´æŠ¤çš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ / è¿›ç¨‹å°†è‡ªå·±æ·»åŠ è¿›ç­‰å¾…é˜Ÿåˆ—</p>
<p>è¿›ç¨‹é€šè¿‡ä»¥ä¸‹æ­¥éª¤å°†è‡ªå·±åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240801110303316.png" class="" title="image-20240801110303316">
<blockquote>
<p>è¿›ç¨‹åœ¨æ‰§è¡Œåˆ°<code>schedule()</code>æ—¶ï¼Œå°†è‡ªå·±å½“å‰çŠ¶æ€çš„ä¸Šä¸‹æ–‡ä¿å­˜è‡³TSSï¼ŒåŒ…æ‹¬EIPå’ŒCSï¼Œç”±äºEIPæŒ‡å‘<code>while(!condition)</code>åˆ¤æ–­ï¼Œå³ä¸‹æ¬¡ç¨‹åºæ‰§è¡Œæ—¶ä¼šè¿›è¡Œconditionçš„åˆ¤æ–­ï¼Œè‹¥æ»¡è¶³åˆ™ç»“æŸç­‰å¾…</p>
</blockquote>
</li>
<li>
<p>è¿›ç¨‹å°†è‡ªèº«çŠ¶æ€è®¾ç½®ä¸º TASK_INTERRUPTIBLE æˆ– TASK_UNINTERRUPTIBLEï¼Œè¡¨ç¤ºå¯ä»¥è¢«ä¿¡å·æˆ–ä¸­æ–­å”¤é†’ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>ä¸­æ–­/äº‹ä»¶å‘ç”Ÿï¼š</strong></p>
<ul>
<li>é©±åŠ¨è®¾å¤‡å®Œæˆæ•°æ®è¾“å…¥åï¼Œä¼šå‘ CPU å‘å‡ºä¸€ä¸ªä¸­æ–­è¯·æ±‚ / è¢«å ç”¨çš„èµ„æºè¢«é‡Šæ”¾ / è¿›ç¨‹ä¸»åŠ¨ç­‰å¾…çš„æ¡ä»¶æ»¡è¶³ã€‚</li>
<li>CPU æ”¶åˆ°ä¸­æ–­è¯·æ±‚åï¼Œä¼šä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œå¹¶è·³è½¬åˆ°è¯¥ä¸­æ–­å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œ / æ‰§è¡Œä¸è¯¥äº‹ä»¶å…³è”çš„ä»£ç ï¼ˆä¾‹å¦‚ï¼Œèµ„æºç®¡ç†ä»£ç ï¼‰</li>
</ul>
</li>
<li>
<p><strong>å¤„ç†ç¨‹åº/å”¤é†’ç¨‹åºï¼š</strong></p>
<ul>
<li>å¤„ç†ç¨‹åºæ‰§è¡Œè®¾å¤‡ç›¸å…³çš„å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚ä»è®¾å¤‡è¯»å–æ•°æ®åˆ°ç¼“å†²åŒºã€‚</li>
<li><strong>å…³é”®æ­¥éª¤ï¼š</strong> ä¸­æ–­å¤„ç†ç¨‹åºä¼šè°ƒç”¨ wake_up_interruptible() æˆ–ç±»ä¼¼çš„ APIã€‚è¯¥å‡½æ•°ä¼š:
<ul>
<li>å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰ç­‰å¾…è¯¥è®¾å¤‡æ•°æ®çš„è¿›ç¨‹æ ‡è®°ä¸º<strong>çŠ¶æ€TASK_RUNNING</strong>ï¼Œå¹¶å°†è¿›ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—çš„é“¾è¡¨ä¸­ç§»é™¤ï¼Œ<code>activate_task()</code> å‡½æ•°è´Ÿè´£å°†è¿›ç¨‹åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>è°ƒåº¦ä¸å”¤é†’ï¼š</strong></p>
<ul>
<li>ä¸­æ–­å¤„ç†å®Œæˆåï¼ŒCPU ä¼šæ ¹æ®è°ƒåº¦ç­–ç•¥é€‰æ‹©ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„è¿›ç¨‹ã€‚</li>
<li>è¢«å”¤é†’çš„è¿›ç¨‹æœ€ç»ˆè·å¾— CPU æ—¶é—´ï¼Œç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶ read() ç³»ç»Ÿè°ƒç”¨ä¼šæˆåŠŸè¿”å›è¯»å–åˆ°çš„æ•°æ®ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä»»åŠ¡åˆ‡æ¢</strong></p>
<p>ä½¿ç”¨è¿œè·³è½¬å®ç°ä»»åŠ¡åˆ‡æ¢</p>
<p>callæŒ‡ä»¤å¯ä»¥å®ç°å‘é«˜ç‰¹æƒçº§è·³è½¬ï¼Œjmpå¹³çº§è·³è½¬</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; è¿‘è·³è½¬</span><br><span class="line">jmp short next_instruction</span><br><span class="line"></span><br><span class="line">; è¿œè·³è½¬ï¼Œä½¿ç”¨æ®µåœ°å€å’Œåç§»é‡ (å®æ¨¡å¼)</span><br><span class="line">jmp far 1000h:1234h</span><br><span class="line"></span><br><span class="line">; è¿œè·³è½¬ï¼Œä½¿ç”¨é€‰æ‹©å­å’Œåç§»é‡ (ä¿æŠ¤æ¨¡å¼)</span><br><span class="line">jmp far [selector:offset]</span><br><span class="line">call 0x0008:0x1234 ; å‘GDTä¸­ç´¢å¼•ä¸º1çš„è°ƒç”¨é—¨è·³è½¬ï¼Œå¿½ç•¥åç§»0x1234</span><br></pre></td></tr></table></figure>
<p>åœ¨linux 0.x ä¸­ï¼Œæ‰€æœ‰ä»»åŠ¡çš„TSSå‡ä¿å­˜åœ¨GDTä¸­ï¼›</p>
<p>åœ¨å‘ç”Ÿä¸Šè¿°ä¸¤ç§éœ€è¦è°ƒåº¦çš„æƒ…å†µæ—¶ï¼Œè°ƒåº¦ç¨‹åº(å†…æ ¸)å°†è·å–ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶è·å–è¯¥ä»»åŠ¡å¯¹åº”çš„TSSï¼›</p>
<p>jmp far [TSS é€‰æ‹©å­]</p>
<ul>
<li><strong>è¯»å– TSS é€‰æ‹©å­ï¼š</strong> CPU ä»æŒ‡ä»¤ä¸­è·å– [TSS é€‰æ‹©å­] çš„å€¼ï¼Œè¯¥å€¼æŒ‡å‘ç›®æ ‡ä»»åŠ¡ (Task B) çš„ TSS æè¿°ç¬¦åœ¨ GDT ä¸­çš„ä½ç½®ã€‚</li>
<li><strong>è¯»å– TSS æè¿°ç¬¦ï¼š</strong> CPU æ ¹æ® TSS é€‰æ‹©å­ï¼Œä» GDT ä¸­è¯»å– Task B çš„ TSS æè¿°ç¬¦ï¼Œè¯¥æè¿°ç¬¦åŒ…å«äº† Task B çš„ TSS æ®µåŸºå€ã€‚</li>
<li><strong>åŠ è½½æ–° TSSï¼š</strong> CPU å°† Task B çš„ TSS æ®µåŸºå€åŠ è½½åˆ° TR å¯„å­˜å™¨ä¸­ï¼Œè¡¨ç¤ºå½“å‰ä»»åŠ¡åˆ‡æ¢ä¸º Task Bã€‚</li>
<li><strong>ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€ï¼š</strong> CPU å°†å½“å‰ä»»åŠ¡ (Task A) çš„çŠ¶æ€ä¿¡æ¯ä¿å­˜åˆ° Task A çš„ TSS ä¸­ï¼ŒåŒ…æ‹¬ï¼š
<ul>
<li>CSã€EIPã€EFLAGSã€SSã€ESP ç­‰é€šç”¨å¯„å­˜å™¨çš„å€¼ã€‚</li>
<li>æ®µå¯„å­˜å™¨ DSã€ESã€FSã€GS çš„å€¼ã€‚</li>
</ul>
</li>
<li><strong>åŠ è½½æ–°ä»»åŠ¡çŠ¶æ€ï¼š</strong> CPU ä» Task B çš„ TSS ä¸­åŠ è½½æ–°çš„ä»»åŠ¡çŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š
<ul>
<li>å°† Task B çš„ CSã€EIPã€EFLAGSã€SSã€ESP ç­‰å¯„å­˜å™¨çš„å€¼åŠ è½½åˆ°ç›¸åº”çš„å¯„å­˜å™¨ä¸­ã€‚</li>
<li>å°† Task B çš„ DSã€ESã€FSã€GS æ®µå¯„å­˜å™¨çš„å€¼åŠ è½½åˆ°ç›¸åº”çš„æ®µå¯„å­˜å™¨ä¸­ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>åœ¨CPUè¯†åˆ«å‡ºè·³è½¬ç›®æ ‡ä¸ºTSSé€‰æ‹©å­æ—¶ï¼ˆé€šè¿‡ç¡¬ä»¶æœºåˆ¶è¯†åˆ«ï¼‰ï¼Œä¸ä¼šç›´æ¥å°† é€‰æ‹©å­:åç§» å†™å…¥ CS:EIPï¼Œä¼šè¿›å…¥ä»»åŠ¡åˆ‡æ¢æµç¨‹ï¼Œé€šè¿‡ç¡¬ä»¶è‡ªåŠ¨å°†å½“å‰ä»»åŠ¡çš„ CS:EIP ä»¥åŠå…¶ä»–ç›¸å…³å¯„å­˜å™¨ï¼ˆåŒ…æ‹¬ EFLAGSã€SSã€ESPã€æ®µå¯„å­˜å™¨ç­‰ï¼‰çš„å€¼ä¿å­˜åœ¨å½“å‰ä»»åŠ¡çš„ TSS ä¸­ï¼Œç„¶åä»ç›®æ ‡ä»»åŠ¡çš„ TSS ä¸­åŠ è½½æ–°çš„ CS:EIP ä»¥åŠå…¶ä»–å¯„å­˜å™¨çš„å€¼ã€‚</p>
</blockquote>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240715103745870.png" class="" title="image-20240715103745870">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240715103802105.png" class="" title="image-20240715103802105">
<p>è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œä¿®æ”¹ä»¥ä¸‹ï¼š</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714095015752.png" class="" title="image-20240714095015752">
<p>Linux: system_call.s</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.align 2</span><br><span class="line">_timer_interrupt:</span><br><span class="line">	push %ds		# save ds,es and put kernel data space</span><br><span class="line">	push %es		# into them. %fs is used by _system_call</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx		# we save %eax,%ecx,%edx as gcc doesn&#x27;t</span><br><span class="line">	pushl %ecx		# save those across function calls. %ebx</span><br><span class="line">	pushl %ebx		# is saved as we use that in ret_sys_call</span><br><span class="line">	pushl %eax</span><br><span class="line">	movl $0x10,%eax</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	movl $0x17,%eax</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	incl _jiffies  #å‘ç”Ÿæ—¶é—´ä¸­æ–­æ—¶å°†jiffiesè‡ªå¢</span><br><span class="line">	movb $0x20,%al		# EOI to interrupt controller #1</span><br><span class="line">	outb %al,$0x20</span><br><span class="line">	movl CS(%esp),%eax</span><br><span class="line">	andl $3,%eax		# %eax is CPL (0 or 3, 0=supervisor)</span><br><span class="line">	pushl %eax</span><br><span class="line">	call _do_timer		# &#x27;do_timer(long CPL)&#x27; does everything from PS: å…¶å®å°±æ˜¯ä¿®æ”¹è®¡æ—¶å™¨å’Œè°ƒåº¦</span><br><span class="line">	addl $4,%esp		# task switching to accounting ...</span><br><span class="line">	jmp ret_from_sys_call</span><br></pre></td></tr></table></figure>
<p>Linux: sched.cï¼ˆæ ¸å¿ƒä»£ç </p>
<p>jiffies</p>
<blockquote>
<p>include/sched.h å®šä¹‰ä¸ºå˜é‡</p>
</blockquote>
<p>schedule()</p>
<blockquote>
<p>è°ƒåº¦ä»£ç </p>
</blockquote>
<p>ä»ä»»åŠ¡æ•°ç»„ä¸­æœ€åä¸€ä¸ªä»»åŠ¡å¼€å§‹å‘å‰æ‰«æç›´åˆ°ç¬¬ä¸€ä¸ªä»»åŠ¡å‰(è·³è¿‡ç©º)ï¼š</p>
<p>â€‹	è‹¥task_struct-&gt;alarm &lt; jiffies, ä¿®æ”¹signalå¹¶ç½®alarmä¸º0</p>
<p>â€‹	è‹¥ä»»åŠ¡é™¤å»å±è”½ä¿¡å·å¤–å­˜åœ¨ä¿¡å·ä¸”ä¸ºinterruptible, ä¿®æ”¹task_struct-&gt;stateä¸ºå°±ç»ª</p>
<blockquote>
<p>alarmåˆ¤æ–­+æœ‰ä¿¡å·å­˜åœ¨</p>
</blockquote>
<p>next = 0</p>
<p>while(1)</p>
<p>â€‹	ä»ä»»åŠ¡æ•°ç»„ä¸­æœ€åä¸€ä¸ªä»»åŠ¡å¼€å§‹å‘å‰æ‰«æç›´åˆ°ç¬¬ä¸€ä¸ªä»»åŠ¡å‰(è·³è¿‡ç©º)ï¼š</p>
<p>â€‹		next = å½“å‰task_struct-&gt;counteræœ€å¤§çš„ä»»åŠ¡ï¼›</p>
<p>â€‹		if(counteræœ€å¤§çš„ä»»åŠ¡çš„counter&gt;0):break;</p>
<p>â€‹		else:ä½¿ç”¨ä»»åŠ¡ä¼˜å…ˆçº§æ›´æ–°æ‰€æœ‰ä»»åŠ¡çš„counter</p>
<p>switch_to(next)</p>
<blockquote>
<p>nexté»˜è®¤ä¸º0ï¼Œå³åœ¨æ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡æ—¶ç³»ç»Ÿåˆ‡æ¢è‡³ä»»åŠ¡0(idleä»»åŠ¡)æ‰§è¡Œ</p>
</blockquote>
<p>sleep_on(struct task_struct **p)</p>
<blockquote>
<p>å°†å½“å‰ä»»åŠ¡stateç½®ä¸ºuninterruptibleå¹¶åŠ å…¥ç¡çœ é˜Ÿåˆ—</p>
<p>ä¼ å…¥çš„pæŒ‡å‘ç¡çœ é˜Ÿåˆ—å¤´ï¼Œè¯¥å‡½æ•°å°†å½“å‰taskç½®ä¸ºç¡çœ é˜Ÿåˆ—å¤´</p>
</blockquote>
<p>do_timer(long cpl)</p>
<blockquote>
<p>æ—¶é’Ÿä¸­æ–­äºŒé˜¶å¤„ç†ç¨‹åº</p>
</blockquote>
<p>å¢åŠ å†…æ ¸/ç”¨æˆ·ä»£ç è¿è¡Œæ—¶é—´</p>
<p>å®šæ—¶å™¨é“¾ä¸­å®šæ—¶å™¨çš„å€¼å‡å°‘ï¼Œè‹¥ä¸º0è°ƒç”¨å¤„ç†å‡½æ•°å¹¶ç§»é™¤è¯¥å®šæ—¶å™¨</p>
<p>å‡å°‘å½“å‰ç¨‹åºçš„<code>counter</code>å€¼ï¼Œè‹¥ä¸º0åˆ™ç½®å½“å‰è¿›ç¨‹<code>need_sched</code>ä¸º<code>1</code></p>
<p>switch_to()</p>
<blockquote>
<p>switch_toä¿®æ”¹currentæŒ‡é’ˆæŒ‡å‘ä¼ å…¥çš„taskä»»åŠ¡ï¼Œåˆ‡æ¢è¿›ç¨‹</p>
</blockquote>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240705161507324.png" class="" title="image-20240705161507324">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240705155902092.png" class="" title="image-20240705155902092">
<h2 id="ç‰¹æƒçº§">ç‰¹æƒçº§</h2>
<p>CPL(Current Privilege Level)  å½“å‰ä»£ç ç‰¹æƒçº§</p>
<p>ä¸ºå½“å‰è¿è¡Œä»£ç æ®µçš„ç‰¹æƒçº§ï¼Œä¿å­˜äºCSå¯„å­˜å™¨ä¸­æ®µé€‰æ‹©å­çš„RPL(2ä½)å¤„</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416193845119.png" class="" title="image-20240416193845119">
<p>eg: è¿è¡Œç”¨æˆ·ç¨‹åºä»£ç ï¼ŒCPL = 3</p>
<p>â€‹	  è¿è¡Œå†…æ ¸ç¨‹åºä»£ç ï¼ŒCPL = 0</p>
<p>RPL(Request Privilege Level) è®¿é—®è€…ç‰¹æƒçº§</p>
<p>è®¿é—®è€…ä»£ç æ‰€åœ¨æ®µçš„æè¿°ç¬¦çš„DPLä¸ºRPLå€¼</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416192952163.png" class="" title="image-20240416192952163">
<p>DPL(Descriptor Privilege Level) å—è®¿è€…ç‰¹æƒçº§</p>
<p>å—è®¿è€…ä»£ç æ‰€åœ¨æ®µçš„æè¿°ç¬¦çš„DPL</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240416192952163.png" class="" title="image-20240416192952163">
<h3 id="é—¨æè¿°ç¬¦">é—¨æè¿°ç¬¦</h3>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417104649804.png" class="" title="image-20240417104649804">
<p>é—¨æè¿°ç¬¦å«æœ‰DPLï¼Œè®¿é—®è€…çš„æƒé™éœ€å¤§äºç­‰äºé—¨æè¿°ç¬¦çš„æƒé™</p>
<p>eg: è®¿é—®è€…RPL=3, é—¨æè¿°ç¬¦DPL=3</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240417104649804.png" class="" title="image-20240417104649804">
<p>é—¨æè¿°ç¬¦ç»™å‡ºç›®æ ‡ä¸­æ–­ç¨‹åºçš„æ®µæè¿°ç¬¦é€‰æ‹©å­ï¼Œ</p>
<p>æ®µæè¿°ç¬¦é€‰æ‹©å­å«æœ‰DPLï¼Œé—¨æè¿°ç¬¦çš„ç‰¹æƒå°äºè¢«è®¿é—®è€…(ä¸­æ–­ç¨‹åº)çš„æƒé™</p>
<p>eg: é—¨æè¿°ç¬¦DPL=3ï¼Œä¸­æ–­ç¨‹åºæ®µæè¿°ç¬¦DPL=0</p>
<h3 id="è®¿é—®è¿‡ç¨‹">è®¿é—®è¿‡ç¨‹</h3>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240506164402606.png" class="" title="image-20240506164402606">
<h2 id="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</h2>
<p>tiny_os</p>
<p>ç‰©ç†å†…å­˜è¢«åˆ’åˆ†ä¸ºå†…æ ¸å†…å­˜æ± å’Œç”¨æˆ·å†…å­˜æ± </p>
<p>æ‰€æœ‰ç¨‹åºï¼ˆç”¨æˆ·ç¨‹åºå’Œå†…æ ¸ï¼‰å‡å­˜åœ¨è™šæ‹Ÿåœ°å€æ± ï¼Œè®°å½•è™šæ‹Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240425160621730.png" class="" title="image-20240425160621730">
<h3 id="å†…å­˜ç®¡ç†-2">å†…å­˜ç®¡ç†</h3>
<p>Linux</p>
<blockquote>
<p>Linuxä¸å¯¹ä¸»å†…å­˜(ç‰©ç†å†…å­˜)è¿›è¡Œå†…æ ¸ä½¿ç”¨å’Œç”¨æˆ·ä½¿ç”¨çš„åˆ’åˆ†ï¼›</p>
<p>æ‰€æœ‰ç‰©ç†å†…å­˜çš„ç”³è¯·å‡åœ¨ä¸»å†…å­˜å®ç°ï¼›</p>
</blockquote>
<p><strong>VMA åˆ—è¡¨</strong></p>
<p>åœ¨ Linux ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVirtual Memory Areaï¼ŒVMAï¼‰åˆ—è¡¨ã€‚</p>
<p>VMA åˆ—è¡¨å­˜å‚¨åœ¨è¿›ç¨‹çš„ PCB çš„ mm_struct ç»“æ„ä½“ä¸­ã€‚mm_struct ç»“æ„ä½“æ˜¯ Linux å†…æ ¸ç”¨æ¥ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚</p>
<p>è¯¥åˆ—è¡¨è®°å½•äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ¯ä¸ªå†…å­˜åŒºåŸŸçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><strong>èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ï¼š</strong>  å®šä¹‰äº†è¯¥ VMA è¦†ç›–çš„è™šæ‹Ÿåœ°å€èŒƒå›´ã€‚</li>
<li><strong>è®¿é—®æƒé™ï¼š</strong>  ä¾‹å¦‚ï¼Œåªè¯»ã€è¯»å†™ã€å¯æ‰§è¡Œç­‰ã€‚</li>
<li><strong>æ˜ å°„ç±»å‹ï¼š</strong>  ä¾‹å¦‚ï¼Œæ–‡ä»¶æ˜ å°„ã€åŒ¿åæ˜ å°„ã€è®¾å¤‡æ˜ å°„ç­‰ã€‚</li>
<li><strong>æ–‡ä»¶æ˜ å°„ä¿¡æ¯ï¼š</strong>  å¦‚æœ VMA æ˜ å°„äº†æ–‡ä»¶ï¼Œåˆ™ä¼šè®°å½•æ–‡ä»¶çš„è·¯å¾„ã€æ–‡ä»¶åç§»é‡ç­‰ä¿¡æ¯ã€‚</li>
<li><strong>å…¶ä»–å±æ€§ï¼š</strong>  ä¾‹å¦‚ï¼Œæ˜¯å¦å…±äº«ã€æ˜¯å¦ç§æœ‰ã€æ˜¯å¦å¯äº¤æ¢ç­‰ã€‚</li>
</ul>
<p>è¿›ç¨‹çš„ VMA åˆ—è¡¨æ˜¯ä¸€ä¸ªæŒ‰ç…§è™šæ‹Ÿåœ°å€æ’åºçš„é“¾è¡¨ã€‚ å†…æ ¸å¯ä»¥ä½¿ç”¨çº¢é»‘æ ‘ç­‰æ•°æ®ç»“æ„æ¥åŠ é€Ÿ VMA çš„æŸ¥æ‰¾ã€‚</p>
<p>æ¯ä¸ª VMA åªæ˜¯æè¿°äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä¸€æ®µ<strong>è¿ç»­åŒºåŸŸ</strong>ã€‚ ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ª VMAï¼Œæ¯ä¸ª VMA å¯¹åº”ä¸åŒçš„å†…å­˜åŒºåŸŸï¼Œä¾‹å¦‚ä»£ç æ®µã€æ•°æ®æ®µã€å †ã€æ ˆã€å…±äº«åº“æ˜ å°„åŒºåŸŸç­‰ã€‚</p>
<p><strong>VMA æ•°æ®ç»“æ„</strong></p>
<p>VMA åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª <code>vm_area_struct</code> ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰åœ¨ <code>include/linux/mm_types.h</code> å¤´æ–‡ä»¶ä¸­ã€‚  ä»¥ä¸‹æ˜¯ <code>vm_area_struct</code> ç»“æ„ä½“ä¸­ä¸€äº›é‡è¦çš„æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* VMA çš„èµ·å§‹å’Œç»“æŸè™šæ‹Ÿåœ°å€ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_start;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_end;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* VMA çš„è®¿é—®æƒé™ */</span></span><br><span class="line">    <span class="type">pgprot_t</span> vm_page_prot;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* VMA çš„æ ‡å¿—ä½ï¼Œä¾‹å¦‚ VM_READã€VM_WRITEã€VM_EXEC ç­‰ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æŒ‡å‘ VMA æ‰€å±è¿›ç¨‹çš„ mm_struct ç»“æ„ä½“æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> * <span class="title">vm_mm</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æŒ‡å‘ä¸‹ä¸€ä¸ª VMA çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vm_next</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æŒ‡å‘æ˜ å°„æ–‡ä»¶çš„ file ç»“æ„ä½“æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ–‡ä»¶æ˜ å°„çš„èµ·å§‹åç§»é‡ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ... å…¶ä»–æˆå‘˜å˜é‡ ... */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>è™šæ‹Ÿå†…å­˜åŒºåŸŸ</strong></p>
<p>å¸¸è§çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸé€šå¸¸å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ª VMAï¼š</p>
<ul>
<li><strong>ä»£ç æ®µ (Text Segment):</strong> å­˜å‚¨ç¨‹åºçš„æœºå™¨æŒ‡ä»¤ä»£ç ï¼Œé€šå¸¸æ˜¯åªè¯»çš„ã€‚</li>
<li><strong>æ•°æ®æ®µ (Data Segment):</strong> å­˜å‚¨ç¨‹åºçš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œåˆ†ä¸ºåˆå§‹åŒ–æ•°æ®æ®µå’Œæœªåˆå§‹åŒ–æ•°æ®æ®µã€‚</li>
<li><strong>å † (Heap):</strong> ç”¨äºåŠ¨æ€å†…å­˜åˆ†é…ï¼Œé€šè¿‡ malloc()ã€calloc()ã€realloc() ç­‰å‡½æ•°ç®¡ç†ã€‚</li>
<li><strong>æ ˆ (Stack):</strong> ç”¨äºå‡½æ•°è°ƒç”¨ï¼Œå­˜å‚¨å‡½æ•°å‚æ•°ã€å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚</li>
<li><strong>å…±äº«åº“æ˜ å°„åŒº (Shared Library Mapping Area):</strong> ç”¨äºæ˜ å°„åŠ¨æ€é“¾æ¥åº“ (DLL) çš„ä»£ç å’Œæ•°æ®ã€‚</li>
<li><strong>å†…å­˜æ˜ å°„æ–‡ä»¶ (Memory-Mapped Files):</strong> ä½¿ç”¨ mmap() ç³»ç»Ÿè°ƒç”¨å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚</li>
<li><strong>åŒ¿åæ˜ å°„ (Anonymous Mapping):</strong> ä¸å¯¹åº”äºä»»ä½•æ–‡ä»¶çš„å†…å­˜æ˜ å°„ï¼Œé€šå¸¸ç”¨äºè¿›ç¨‹é—´é€šä¿¡æˆ–åŠ¨æ€å†…å­˜åˆ†é…ã€‚</li>
</ul>
<p>tiny_os</p>
<p>å†…å­˜æ± åˆ›å»ºï¼š</p>
<p>1.kernelåˆ›å»ºå†…æ ¸å†…å­˜æ± å’Œç”¨æˆ·å†…å­˜æ± ï¼Œä¸¤ä¸ªæ± å‡ä½äºç‰©ç†åœ°å€0x0009a000ï¼›åˆ†åˆ«ç®¡ç†ç‰©ç†å†…å­˜çš„0x00102000~?å’Œ0x?(å¤§å°ä¸ºç‰©ç†å†…å­˜å‰©ä¸‹çš„ä¸€åŠ)</p>
<p>2.kernelåˆ›å»ºkernelçš„è™šæ‹Ÿåœ°å€æ± ï¼Œä½äºkbmå’Œubmä¹‹åï¼›ç®¡ç†0xc0100000~?(å¤§å°åŒå†…æ ¸å†…å­˜æ± )çš„è™šæ‹Ÿåœ°å€</p>
<p>3.åˆå§‹åŒ–å†…æ ¸å†…å­˜æ± ï¼Œç”¨æˆ·å†…å­˜æ± ï¼Œè™šæ‹Ÿåœ°å€æ± ï¼Œ</p>
<p>ç”³è¯·å†…å­˜è¿‡ç¨‹ï¼š</p>
<p>1.åœ¨è™šæ‹Ÿåœ°å€æ± ä¸­ç”³è¯·è¿ç»­è™šæ‹Ÿå†…å­˜</p>
<p>æ‰«æè™šæ‹Ÿåœ°å€æ± ä½å›¾ï¼Œåˆ¤æ–­æ˜¯å¦å¯ç”³è¯·å¯¹åº”é¡µæ•°ï¼›è‹¥å…è®¸ï¼Œä¿®æ”¹ä½å›¾å¹¶è¿”å›é¡µ<strong>èµ·å§‹è™šæ‹Ÿåœ°å€</strong>ã€‚</p>
<p>2.åœ¨ç»™å®šçš„ç‰©ç†å†…å­˜æ± ä¸­é€ä¸€ç”³è¯·ç‰©ç†é¡µ(ä¸è¦æ±‚è¿ç»­)</p>
<p>åˆ¤æ–­éœ€è¦åœ¨å“ªä¸ªç‰©ç†æ± ä¸­è¿›è¡Œç”³è¯·ï¼›æ‰«æç‰©ç†åœ°å€æ± ä½å›¾ï¼Œä¿®æ”¹ä½å›¾å¹¶è¿”å›å•é¡µ<strong>èµ·å§‹ç‰©ç†åœ°å€</strong>ï¼Œé‡å¤ã€‚</p>
<p>3.é€šè¿‡é¡µè¡¨å»ºç«‹è™šæ‹Ÿé¡µä¸ç‰©ç†é¡µçš„æ˜ å°„å…³ç³».</p>
<p>å°†å¤šé¡µè™šæ‹Ÿåœ°å€å·®åˆ†ä¸ºå•é¡µï¼Œä¼ å…¥å•é¡µè™šæ‹Ÿåœ°å€çš„å’Œå•é¡µç‰©ç†åœ°å€ï¼›</p>
<p>å°†è™šæ‹Ÿåœ°å€é«˜10ä½ä½œä¸ºé¡µç›®å½•ç´¢å¼•v_pdiï¼Œä¸­10ä½ä½œä¸ºé¡µè¡¨ç´¢å¼•v_ptiï¼›</p>
<p>è‹¥é¡µç›®å½•ç´¢å¼•v_pdiå¤„å­˜åœ¨PDEï¼Œä½¿ç”¨å•é¡µç‰©ç†åœ°å€æ„é€ é¡µè¡¨é¡¹PTEï¼Œå†™å…¥PDEæŒ‡å‘çš„é¡µè¡¨çš„é¡µè¡¨ç´¢å¼•v_ptiå¤„ï¼›</p>
<p>è‹¥é¡µç›®å½•ç´¢å¼•v_pdiå¤„ä¸ºç©ºï¼Œåœ¨å†…æ ¸ä¸­ç”³è¯·ä¸€ä¸ªç‰©ç†é¡µä½œä¸ºé¡µè¡¨ï¼Œä½¿ç”¨å•é¡µç‰©ç†åœ°å€æ„é€ é¡µè¡¨é¡¹PTEï¼Œå†™å…¥PDEæŒ‡å‘çš„é¡µè¡¨çš„é¡µè¡¨ç´¢å¼•v_ptiå¤„ï¼›</p>
<p>ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå°†æ‰€ç”³è¯·åˆ°çš„é¡µæ¸…ç†å¹²å‡€</p>
<h3 id="åŠ¨æ€åŠ è½½ä¸ç¼ºé¡µ">åŠ¨æ€åŠ è½½ä¸ç¼ºé¡µ</h3>
<p><strong>ç¼ºé¡µä¸­æ–­å­˜åœ¨ä¸¤ç§æƒ…å†µ</strong></p>
<ol>
<li><strong>é¡µè¡¨é¡¹å­˜åœ¨ï¼Œä½† Present ä½ä¸º 0:</strong> è¿™è¡¨ç¤ºè¯¥è™šæ‹Ÿåœ°å€å·²ç»æ˜ å°„åˆ°æŸä¸ªç‰©ç†é¡µé¢ï¼Œä½†è¯¥é¡µé¢å½“å‰ä¸åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œå¯èƒ½è¢«æ¢å‡ºåˆ°ç£ç›˜äº†ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºéœ€è¦å°†é¡µé¢ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶æ›´æ–°é¡µè¡¨é¡¹ã€‚</li>
<li><strong>é¡µè¡¨é¡¹ä¸å­˜åœ¨ï¼š</strong> è¿™è¡¨ç¤ºè¯¥è™šæ‹Ÿåœ°å€å°šæœªæ˜ å°„åˆ°ä»»ä½•ç‰©ç†é¡µé¢ã€‚ è¿™é€šå¸¸å‘ç”Ÿåœ¨ç¨‹åºç¬¬ä¸€æ¬¡è®¿é—®è¯¥åœ°å€æ—¶ï¼Œä¾‹å¦‚è®¿é—®æœªåˆå§‹åŒ–çš„æ•°æ®æ®µã€å †åŒºæˆ–åŠ¨æ€é“¾æ¥åº“ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºéœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µé¢ï¼Œå¹¶å°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°è¯¥é¡µé¢ï¼Œç„¶åæ‰ä¼šå…è®¸ç¨‹åºç»§ç»­æ‰§è¡Œã€‚</li>
</ol>
<p><strong>åŠ è½½dllæ–‡ä»¶</strong></p>
<ul>
<li><strong>æŸ¥æ‰¾ DLL æ–‡ä»¶ï¼š</strong> æ ¹æ®æ–‡ä»¶ååœ¨ç£ç›˜ä¸Šæœç´¢ DLL æ–‡ä»¶ã€‚</li>
<li><strong>åˆ†é…è™šæ‹Ÿåœ°å€ç©ºé—´ï¼š</strong> åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—²åŒºåŸŸï¼Œç”¨äºæ˜ å°„ DLL æ–‡ä»¶ã€‚ <strong>è¿™ä¸€æ­¥å°±å†³å®šäº† DLL ä¼šè¢«åŠ è½½åˆ°å“ªä¸ªè™šæ‹Ÿåœ°å€èŒƒå›´ã€‚</strong></li>
<li><strong>åˆ›å»º VMAï¼š</strong> ä¸º DLL åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ (VMA)ï¼Œè®°å½• DLL çš„èµ·å§‹åœ°å€ã€å¤§å°ã€è®¿é—®æƒé™ç­‰ä¿¡æ¯ã€‚</li>
<li><strong>ä¿®æ”¹é¡µè¡¨ï¼š</strong> æ­¤æ—¶ï¼Œæ“ä½œç³»ç»Ÿ<strong>å¹¶ä¸ä¼š</strong>ç«‹å³ä¸º DLL åˆ†é…ç‰©ç†é¡µé¢ï¼Œä¹Ÿä¸ä¼šå°† DLL æ–‡ä»¶å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ å®ƒåªæ˜¯ä¿®æ”¹è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°† DLL æ–‡ä»¶çš„æ˜ å°„ä¿¡æ¯å†™å…¥é¡µè¡¨ï¼Œå¹¶å°†è¿™äº›é¡µè¡¨é¡¹æ ‡è®°ä¸º<strong>æ— æ•ˆ</strong> (ä¾‹å¦‚ï¼ŒPresent ä½ä¸º 0)ã€‚</li>
<li><strong>å¤„ç†é‡å®šä½è¡¨ï¼š</strong> DLL æ–‡ä»¶ä¸­åŒ…å«ä¸€ä¸ªé‡å®šä½è¡¨ï¼Œè®°å½•äº† DLL ä»£ç å’Œæ•°æ®ä¸­éœ€è¦è¿›è¡Œåœ°å€ä¿®æ­£çš„ä½ç½®ã€‚ åŠ è½½å™¨ä¼šæ ¹æ® DLL çš„åŠ è½½åœ°å€ï¼Œä¿®æ”¹é‡å®šä½è¡¨ä¸­çš„åœ°å€ï¼Œç¡®ä¿ DLL èƒ½å¤Ÿæ­£ç¡®è®¿é—®è‡ªèº«å’Œå…¶ä»–æ¨¡å—çš„ä»£ç å’Œæ•°æ®ã€‚</li>
</ul>
<p><strong>åŠ è½½æ–‡ä»¶</strong></p>
<ul>
<li><strong>ç³»ç»Ÿè°ƒç”¨ï¼š</strong> è¿›ç¨‹ä½¿ç”¨ read()ã€write() ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¯»å†™æ–‡ä»¶ã€‚</li>
<li><strong>æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼š</strong> å†…æ ¸æ ¹æ®æ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶è¡¨é¡¹æŒ‡é’ˆã€‚</li>
<li><strong>æ–‡ä»¶è¡¨é¡¹ï¼š</strong> å†…æ ¸è®¿é—®æ–‡ä»¶è¡¨é¡¹ï¼Œè·å–æ–‡ä»¶çš„å½“å‰åç§»é‡ã€è®¿é—®æ¨¡å¼ç­‰ä¿¡æ¯ã€‚</li>
<li><strong>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (VFS)ï¼š</strong> å†…æ ¸è°ƒç”¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (VFS) çš„å‡½æ•°ï¼Œå°†æ–‡ä»¶æ“ä½œè½¬æ¢ä¸ºå…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œã€‚</li>
<li><strong>å…·ä½“æ–‡ä»¶ç³»ç»Ÿï¼š</strong> å…·ä½“æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ï¼Œext4ã€NTFSï¼‰è´Ÿè´£å°†æ–‡ä»¶æ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œæˆ–è€…å°†å†…æ ¸ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ã€‚</li>
<li><strong>æ•°æ®æ‹·è´ï¼š</strong> å†…æ ¸å°†æ•°æ®åœ¨å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç©ºé—´ç¼“å†²åŒºä¹‹é—´è¿›è¡Œæ‹·è´ã€‚</li>
</ul>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸ç›´æ¥å°†ç”¨æˆ·è¿›ç¨‹çš„ä¸€éƒ¨åˆ†è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„åˆ°å†…å­˜ä¸­æ–‡ä»¶</p>
<p>è€ƒè™‘å¤šä¸ªè¿›ç¨‹è®¿é—®ä¸€ä¸ªæ–‡ä»¶çš„æƒ…å†µï¼šè¿›ç¨‹ç›´æ¥ä¿®æ”¹å†…å­˜ä¸­çš„æ–‡ä»¶åŸä»¶ä¼šå¯¼è‡´åŒæ­¥æ–‡ä»¶ï¼ˆå¦‚åŒæ—¶å†™å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ï¼‰ï¼Œè¿˜æœ‰å®‰å…¨é£é™©ã€æ— æ³•å……åˆ†åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜æœºåˆ¶çš„é—®é¢˜ã€‚</p>
<p>å¯¹æ¯” <code>mmap()</code></p>
<p>mmap() ç³»ç»Ÿè°ƒç”¨æä¾›äº†å¤šç§ä¸åŒçš„æ˜ å°„æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>æ–‡ä»¶æ˜ å°„ï¼š</strong> å°†æ–‡ä»¶å†…å®¹æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå¯ä»¥é«˜æ•ˆåœ°è¯»å–å’Œä¿®æ”¹æ–‡ä»¶æ•°æ®ã€‚</li>
<li><strong>åŒ¿åæ˜ å°„ï¼š</strong> åˆ›å»ºä¸å¯¹åº”äºä»»ä½•æ–‡ä»¶çš„å†…å­˜æ˜ å°„ï¼Œå¯ç”¨äºè¿›ç¨‹é—´é€šä¿¡ã€åŠ¨æ€å†…å­˜åˆ†é…ç­‰ã€‚</li>
<li><strong>è®¾å¤‡æ˜ å°„ï¼š</strong> å°†è®¾å¤‡å¯„å­˜å™¨æˆ–å…¶ä»–ç¡¬ä»¶èµ„æºæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œæ–¹ä¾¿ç”¨æˆ·ç¨‹åºç›´æ¥è®¿é—®ç¡¬ä»¶ã€‚</li>
</ul>
<p>ä½¿ç”¨mmapå°±å¯ä»¥è¾¾åˆ°ä¸Šé¢è®²çš„é‚£ç§æƒ…å†µäº†</p>
<p>PSï¼šmmapå…è®¸å°†ç›¸åŒçš„ç‰©ç†åœ°å€æ˜ å°„åˆ°ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ä¸­ä¸åŒçš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šï¼Œè¿™æ ·å°±å®ç°äº†IPCè¿›ç¨‹é—´é€šä¿¡ï¼Œéš”å£Binderæœºåˆ¶å°±æ˜¯è¿™ä¹ˆåšçš„</p>
<ul>
<li><strong>MAP_SHARED æ ‡å¿—ï¼š</strong> å½“ä½¿ç”¨ mmap() åˆ›å»ºæ˜ å°„æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š MAP_SHARED æ ‡å¿—æ¥å®ç°å…±äº«å†…å­˜ã€‚ ä½¿ç”¨è¯¥æ ‡å¿—æ—¶ï¼Œå¤šä¸ªè¿›ç¨‹å¯¹æ˜ å°„åŒºåŸŸçš„ä¿®æ”¹å¯¹æ‰€æœ‰è¿›ç¨‹å¯è§ã€‚</li>
</ul>
</blockquote>
<ul>
<li><strong>æ›´æ–°æ–‡ä»¶åç§»é‡ï¼š</strong> å†…æ ¸æ›´æ–°æ–‡ä»¶è¡¨é¡¹ä¸­çš„æ–‡ä»¶åç§»é‡ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¯»å†™æ“ä½œä»æ­£ç¡®çš„ä½ç½®å¼€å§‹ã€‚</li>
</ul>
<h2 id="æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</h2>
<h3 id="ièŠ‚ç‚¹">ièŠ‚ç‚¹</h3>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714155420209.png" class="" title="image-20240714155420209">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714155445517.png" class="" title="image-20240714155445517">
<h3 id="æ–‡ä»¶æ‰“å¼€">æ–‡ä»¶æ‰“å¼€</h3>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714155625208.png" class="" title="image-20240714155625208">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714155718673.png" class="" title="image-20240714155718673">
<p><code>open()</code> å‡½æ•°è¿”å›çš„æŒ‡é’ˆæ˜¯è¿›ç¨‹æ•°æ®ç»“æ„ä¸­æ–‡ä»¶æŒ‡é’ˆæ•°ç»„çš„ä¸€ä¸ªç´¢å¼•ã€‚å…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªæ–‡ä»¶è¢«æ‰“å¼€æ—¶ï¼Œ<code>open()</code> å‡½æ•°ä¼šåœ¨è¿›ç¨‹çš„æ•°æ®ç»“æ„ä¸­åˆ†é…ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆæ•°ç»„çš„ç´¢å¼•ï¼ˆåœ¨å›¾çš„æœ€å·¦è¾¹ï¼‰ï¼Œå¹¶å°†å…¶æŒ‡å‘æ–‡ä»¶è¡¨ï¼ˆ<code>file_table</code>ï¼‰ä¸­çš„ä¸€ä¸ªæ¡ç›®ã€‚åœ¨æ–‡ä»¶è¡¨æ¡ç›®ä¸­åŒ…å«äº†æ–‡ä»¶çš„çŠ¶æ€æ ‡å¿—ã€å¼•ç”¨è®¡æ•°ã€inodeæŒ‡é’ˆå’Œæ–‡ä»¶ä½ç½®ç­‰ä¿¡æ¯ã€‚</p>
<p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œ<code>open()</code> å‡½æ•°è¿”å›çš„å€¼æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œé€šå¸¸ä»0å¼€å§‹é€’å¢ã€‚è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”äºè¿›ç¨‹æ•°æ®ç»“æ„ä¸­æ–‡ä»¶æŒ‡é’ˆæ•°ç»„çš„ä¸€ä¸ªç´¢å¼•ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹å¤šæ¬¡æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¼šåœ¨ç³»ç»Ÿçš„æ‰“å¼€æ–‡ä»¶è¡¨ä¸­æ–°å¢å¤šä¸ªé¡¹ï¼Œå› ä¸ºæ‰“å¼€æ–‡ä»¶è¡¨ä¸­çš„é¡¹è®°å½•äº†æ‰“å¼€æ–‡ä»¶çš„æƒé™ï¼ˆeg.: åªè¯»ï¼‰ï¼Œå¤šæ¬¡æ‰“å¼€æ—¶çš„è®¾ç½®å¯èƒ½ä¸ä¸€æ ·</p>
</blockquote>
<p><strong>æ–‡ä»¶æè¿°ç¬¦çš„å€¼</strong></p>
<p>åœ¨ä¸€ä¸ªå…¸å‹çš„UNIXç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶æè¿°ç¬¦çš„å€¼å¯èƒ½æ˜¯ï¼š</p>
<ul>
<li><code>0</code> å¯¹åº”æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰</li>
<li><code>1</code> å¯¹åº”æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰</li>
<li><code>2</code> å¯¹åº”æ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰</li>
</ul>
<p>å…¶ä»–æ–‡ä»¶æè¿°ç¬¦å€¼å°†åˆ†é…ç»™ç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œ<code>open()</code> å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œå¯èƒ½è¿”å› <code>3</code>ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¿›ç¨‹</span><br><span class="line">+--------------------+</span><br><span class="line">| FD Table (è¿›ç¨‹)    |</span><br><span class="line">| +-----+------------|</span><br><span class="line">| | 0   | stdin      |</span><br><span class="line">| | 1   | stdout     |</span><br><span class="line">| | 2   | stderr     |</span><br><span class="line">| | ... | ...        |</span><br><span class="line">| | 3   | device_fd  | --&gt; æ–‡ä»¶è¡¨é¡¹ --&gt; inode (device)</span><br><span class="line">| | 4   | property_fd| --&gt; æ–‡ä»¶è¡¨é¡¹ --&gt; inode (property)</span><br><span class="line">| | 5   | socket_fd  | --&gt; æ–‡ä»¶è¡¨é¡¹ --&gt; å¥—æ¥å­—ç»“æ„</span><br><span class="line">| | 6   | pipe_read_fd | --&gt; æ–‡ä»¶è¡¨é¡¹ --&gt; ç®¡é“ç¼“å†²åŒº</span><br><span class="line">| | 7   | pipe_write_fd| --&gt; æ–‡ä»¶è¡¨é¡¹ --&gt; ç®¡é“ç¼“å†²åŒº</span><br><span class="line">+-----+--------------+</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…³äºpipe</p>
<p>åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œä½¿ç”¨ <code>pipe</code> ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€ä¸ªç”¨äºè¯»ç«¯ (<code>pipe_read_fd</code>)ï¼Œä¸€ä¸ªç”¨äºå†™ç«¯ (<code>pipe_write_fd</code>)ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘ä¸åŒçš„æ–‡ä»¶è¡¨é¡¹ï¼Œä½†æ–‡ä»¶è¡¨é¡¹æŒ‡å‘ç›¸åŒçš„ç®¡é“ç¼“å†²åŒºã€‚</p>
<p>æ“ä½œç³»ç»Ÿä¸ä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºæ–°çš„inodeèŠ‚ç‚¹ï¼Œå› ä¸ºç®¡é“æ˜¯å†…å­˜æ•°æ®ç»“æ„ï¼Œå¹¶ä¸ä¸æ–‡ä»¶ç³»ç»Ÿå®ä½“å…³è”</p>
<p>å‡å®šå½“å‰è¿›ç¨‹æ˜¯ä¸€ä¸ªshellï¼Œè€Œå®ƒè°ƒç”¨fork()äº§ç”Ÿä¸¤ä¸ªå­è¿›ç¨‹ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªä¸¤é˜¶æ®µç®¡é“ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>1ï¼Œä½¿ç”¨pipe() åˆ›å»ºç®¡é“ã€‚å¿…é¡»é¦–å…ˆåšåˆ°è¿™ä¸€ç‚¹ï¼Œä»¥ä¾¿ä¸»è¿›ç¨‹åˆ›å»ºçš„ä¸¤ä¸ªå­è¿›ç¨‹èƒ½å¤Ÿç»§æ‰¿æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p>2ï¼Œè°ƒç”¨fork()ï¼Œäº§ç”Ÿæˆ‘ä»¬çš„â€œç”Ÿäº§è€…è¿›ç¨‹â€ã€‚è¯¥è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºæµå‘ç®¡é“ã€‚åœ¨è¯¥å­è¿›ç¨‹ä¸­è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<p>a, å› ä¸ºç”Ÿäº§è€…è¿›ç¨‹ä¸éœ€è¦ç®¡é“çš„è¯»å–ç«¯æ‰€ä»¥ä½¿ç”¨ close(pipefd[0]) å…³é—­å®ƒã€‚</p>
<p>b,ä½¿ç”¨close(STDOUT_FILENO)ï¼Œï¼ˆå³1ï¼‰å…³é—­æœ€åˆçš„æ ‡å‡†è¾“å‡ºã€‚</p>
<p>c,ä½¿ç”¨dup(pipefd[1])å°†ç®¡é“çš„å†™å…¥ç«¯æ”¹å˜ä¸ºæ–‡ä»¶æè¿°ç¬¦1.</p>
<blockquote>
<p>dup å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒæŒ‡å‘ä¸ oldfd ç›¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨é¡¹ã€‚æ–°æ–‡ä»¶æè¿°ç¬¦çš„å€¼å°†æ˜¯å½“å‰è¿›ç¨‹ä¸­å¯ç”¨çš„æœ€å°æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚æ­¤å¤„å³ä¸ºåˆšæ‰å…³é—­çš„æ ‡å‡†è¾“å‡ºï¼Œæ–‡ä»¶æè¿°ç¬¦1ã€‚</p>
</blockquote>
<p>d,æˆ‘ä»¬ä¸éœ€è¦æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸¤ä»½æ‹·è´ï¼Œæ‰€ä»¥ä½¿ç”¨close(pipefd[1])å…³é—­ä¸€ä¸ªã€‚</p>
<blockquote>
<p>æ³¨æ„å…³é—­æœªä½¿ç”¨çš„ç®¡é“æ–‡ä»¶æè¿°ç¬¦çš„é‡è¦æ€§ã€‚å› ä¸ºç›´åˆ°æœ€åä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å…³é—­ï¼Œæ–‡ä»¶æ‰çœŸæ­£å…³é—­ï¼Œå³ä½¿å¤šä¸ªè¿›ç¨‹å…±äº«æ–‡ä»¶æè¿°ç¬¦æ—¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å› ä¸ºåªæœ‰æ‰€æœ‰çš„å†™å…¥ç«¯æ‹·è´éƒ½è¢«å…³é—­ï¼Œä»ç®¡é“è¯»å–æ•°æ® çš„è¿›ç¨‹æ‰ä¼šçŸ¥é“æ˜¯å¦åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œæ‰€ä»¥å…³é—­æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦è‡³å…³é‡è¦ã€‚</p>
</blockquote>
<p>e,è°ƒç”¨exec()å¯åŠ¨è¿è¡Œçš„ç¨‹åºã€‚</p>
<p>3ï¼Œè°ƒç”¨fork()äº§ç”Ÿæˆ‘ä»¬çš„â€œæ¶ˆè´¹è€…è¿›ç¨‹â€œï¼Œè¯¥è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥æ¥è‡ªäºç®¡é“ã€‚è¯¥å­è¿›ç¨‹ä¸­çš„å’Œç”Ÿäº§è€…çš„æ­¥éª¤ç›¸ä¼¼ï¼Œ</p>
<p>a,å› ä¸ºå³ä¾§çš„å­è¿›ç¨‹ä¸éœ€è¦ç®¡é“çš„è¾“å…¥ç«¯æ‰€ä»¥ä½¿ç”¨close(pipefd[1]) å…³é—­å®ƒã€‚</p>
<p>b,ä½¿ç”¨close(STDIN_FILENO)å…³é—­æœ€åˆçš„æ ‡å‡†è¾“å…¥ã€‚STDIN_FILENOä¸º 0</p>
<p>c,ä½¿ç”¨dup(pipefd[0])å°†ç®¡é“çš„è¯»å–ç«¯ï¼ˆè¾“å…¥ï¼‰æ”¹å˜ä¸ºæ–‡ä»¶æè¿°ç¬¦0.</p>
<p>d,ä½¿ç”¨close(pipefd[0])å…³é—­æ–‡ä»¶æè¿°ç¬¦çš„ä¸€ä¸ªæ‹·è´ã€‚</p>
<p>e,è°ƒç”¨exec()å¯åŠ¨è¿è¡Œçš„ç¨‹åºã€‚</p>
<p>4ï¼Œçˆ¶è¿›ç¨‹å…³é—­ç®¡é“çš„ä¸¤ç«¯close(pipefd[0]),close(pipefd[1])ã€‚</p>
<p>5ï¼Œæœ€åï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­ä½¿ç”¨waitç­‰å¾…ä¸¤ä¸ªå­è¿›ç¨‹çš„ç»“æŸã€‚</p>
</blockquote>
<blockquote>
<p>å…³äºsocket</p>
<p>å†…æ ¸ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>
<p><strong>åˆ†é…èµ„æºï¼š</strong> åœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ªæ–°çš„ socket æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨ socket çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šåè®®æ—ã€å¥—æ¥å­—ç±»å‹ã€æœ¬åœ°åœ°å€ã€è¿œç¨‹åœ°å€ã€è¿æ¥çŠ¶æ€ç­‰ã€‚</p>
</li>
<li>
<p><strong>åˆ›å»ºæ–‡ä»¶è¡¨é¡¹ï¼š</strong> ä¸º socket åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¡¨é¡¹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿæ‰“å¼€æ–‡ä»¶è¡¨ä¸­ã€‚æ–‡ä»¶è¡¨é¡¹ä¸­åŒ…å«æŒ‡å‘ socket æ•°æ®ç»“æ„çš„æŒ‡é’ˆä»¥åŠå…¶ä»–æ–‡ä»¶æ“ä½œç›¸å…³çš„ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><strong>åˆ†é…æ–‡ä»¶æè¿°ç¬¦ï¼š</strong> åœ¨è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€å°çš„æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶å°†å…¶æŒ‡å‘æ–°åˆ›å»ºçš„æ–‡ä»¶è¡¨é¡¹ã€‚</p>
</li>
</ol>
</blockquote>
<p><strong>æ–‡ä»¶è¡¨ä¸­çš„å€¼</strong></p>
<p>æ–‡ä»¶è¡¨ï¼ˆ<code>file_table</code>ï¼‰ä¸­çš„æ¯ä¸ªæ¡ç›®ï¼ˆ<code>struct file</code>ï¼‰å¯èƒ½åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li><code>f_flags</code>ï¼šæ–‡ä»¶çŠ¶æ€æ ‡å¿—ï¼Œå¦‚åªè¯»ã€åªå†™æˆ–è¯»å†™ã€‚</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼špollç³»ç»Ÿè°ƒç”¨ç›‘è§†çš„å°±æ˜¯è¿™ä¸ªå€¼çš„å˜åŒ–</p>
</blockquote>
<ul>
<li><code>f_count</code>ï¼šå¼•ç”¨è®¡æ•°ï¼Œè¡¨ç¤ºå½“å‰æœ‰å¤šå°‘è¿›ç¨‹å…±äº«æ­¤æ–‡ä»¶ã€‚</li>
<li><code>f_inode</code>ï¼šæŒ‡å‘å†…å­˜ä¸­ièŠ‚ç‚¹ç»“æ„çš„æŒ‡é’ˆï¼ŒåŒ…å«æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚</li>
<li><code>f_pos</code>ï¼šæ–‡ä»¶ä½ç½®æŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰æ–‡ä»¶çš„è¯»å†™ä½ç½®ã€‚</li>
</ul>
<p>æ–‡ä»¶è¡¨åœ¨ç³»ç»Ÿä¸­çš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„æ–‡ä»¶æŒ‡é’ˆæ•°ç»„</strong>ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨æ–‡ä»¶æè¿°ç¬¦åˆ°æ–‡ä»¶è¡¨æ¡ç›®çš„æ˜ å°„ã€‚</li>
<li><strong>å…¨å±€æ–‡ä»¶è¡¨</strong>ï¼šæ–‡ä»¶è¡¨æ˜¯å†…æ ¸ä¸­çš„å…¨å±€ç»“æ„ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«ä¸€ä¸ªæ–‡ä»¶è¡¨ã€‚æ–‡ä»¶è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®å­˜å‚¨äº†æ–‡ä»¶çš„çŠ¶æ€å’Œä½ç½®ä¿¡æ¯ã€‚</li>
</ul>
<p>ç¤ºä¾‹</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªè¿›ç¨‹Aå’ŒBï¼ŒåŒæ—¶æ‰“å¼€äº†åŒä¸€ä¸ªæ–‡ä»¶ã€‚æ–‡ä»¶è¡¨å’Œæ–‡ä»¶æŒ‡é’ˆæ•°ç»„å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¿›ç¨‹Açš„æ–‡ä»¶æŒ‡é’ˆæ•°ç»„:</span><br><span class="line">[0] -&gt; stdin</span><br><span class="line">[1] -&gt; stdout</span><br><span class="line">[2] -&gt; stderr</span><br><span class="line">[3] -&gt; file_table[5]</span><br><span class="line"></span><br><span class="line">è¿›ç¨‹Bçš„æ–‡ä»¶æŒ‡é’ˆæ•°ç»„:</span><br><span class="line">[0] -&gt; stdin</span><br><span class="line">[1] -&gt; stdout</span><br><span class="line">[2] -&gt; stderr</span><br><span class="line">[3] -&gt; file_table[5]</span><br><span class="line"></span><br><span class="line">å…¨å±€æ–‡ä»¶è¡¨(file_table):</span><br><span class="line">[0] - ç©ºé—²</span><br><span class="line">[1] - ç©ºé—²</span><br><span class="line">...</span><br><span class="line">[5] -&gt; &#123;</span><br><span class="line">    f_flags: O_RDWR,  // è¯»å†™æ ‡å¿—</span><br><span class="line">    f_count: 2,      // å¼•ç”¨è®¡æ•°ä¸º2ï¼Œå› ä¸ºä¸¤ä¸ªè¿›ç¨‹éƒ½æ‰“å¼€äº†è¿™ä¸ªæ–‡ä»¶</span><br><span class="line">    f_inode: æŒ‡å‘ièŠ‚ç‚¹,</span><br><span class="line">    f_pos: 0         // æ–‡ä»¶ä½ç½®</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">[63] - ç©ºé—²</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>open()</code> å‡½æ•°åœ¨è¿›ç¨‹Aå’ŒBä¸­åˆ†åˆ«è¿”å›äº† <code>3</code>ï¼ŒæŒ‡å‘äº†æ–‡ä»¶è¡¨ä¸­çš„åŒä¸€ä¸ªæ¡ç›®ï¼ˆ<code>file_table[5]</code>ï¼‰ï¼Œå¹¶ä¸”å¼•ç”¨è®¡æ•°ä¸º <code>2</code>ã€‚</p>
<h2 id="å­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡">å­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡</h2>
<p>æ§åˆ¶è®¾å¤‡çš„<strong>å†…æ ¸æ¨¡å—</strong>è¢«æˆä¸º<strong>è®¾å¤‡é©±åŠ¨ç¨‹åº</strong>ï¼Œä¸€ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºæ§åˆ¶ä¸€ç±»è®¾å¤‡</p>
<p>e.g.: ä¸€ä¸ªç£ç›˜é©±åŠ¨ç¨‹åºæ§åˆ¶æ‰€æœ‰çš„ç£ç›˜è®¾å¤‡</p>
<p>éƒ¨åˆ†é©±åŠ¨ç¨‹åºæ§åˆ¶çš„æ˜¯<strong>è½¯è®¾å¤‡</strong>ï¼Œè½¯è®¾å¤‡ä¸å­˜åœ¨å¯¹åº”çš„ç‰©ç†è®¾å¤‡</p>
<p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œç¡¬ä»¶è®¾å¤‡è¢«æŠ½è±¡ä¸ºæ–‡ä»¶ï¼Œç§°ä¸ºè®¾å¤‡æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸ä½äº /dev ç›®å½•ä¸‹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ–‡ä»¶æ“ä½œå‡½æ•°æ¥è®¿é—®ç¡¬ä»¶è®¾å¤‡</p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714193850691.png" class="" title="image-20240714193850691">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714194037398.png" class="" title="image-20240714194037398">
<h3 id="å­—ç¬¦è®¾å¤‡">å­—ç¬¦è®¾å¤‡</h3>
<p>å­—ç¬¦è®¾å¤‡æ˜¯ä¸€ç§ä»¥å­—èŠ‚æµçš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“çš„è®¾å¤‡ï¼Œå®ƒæ¯æ¬¡åªä¼ è¾“ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®ä¼ è¾“æ²¡æœ‰ç¼“å­˜</p>
<ul>
<li>é”®ç›˜ã€é¼ æ ‡ï¼šæ¯æ¬¡æŒ‰é”®æˆ–ç§»åŠ¨é¼ æ ‡éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªå­—ç¬¦æµã€‚</li>
<li>ä¸²å£ã€å¹¶å£ï¼šæ•°æ®ä»¥å­—èŠ‚æµçš„å½¢å¼è¿›è¡Œä¼ è¾“ã€‚</li>
<li>ç»ˆç«¯è®¾å¤‡ (tty, Teletypewriter)ï¼šç”¨äºä¸ç”¨æˆ·äº¤äº’ï¼Œæ¯æ¬¡è¾“å…¥æˆ–è¾“å‡ºä¸€ä¸ªå­—ç¬¦ã€‚</li>
</ul>
<h4 id="TTY">TTY</h4>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714194408562.png" class="" title="image-20240714194408562">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714194437093.png" class="" title="image-20240714194437093">
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240714194601289.png" class="" title="image-20240714194601289">
<blockquote>
<p>é”®ç›˜æŒ‰é”®å¦‚ä½•åˆ°è¾¾è¿›ç¨‹çš„</p>
<p><strong>1. ç¡¬ä»¶ä¸­æ–­ï¼š</strong></p>
<ul>
<li>å½“æŒ‰ä¸‹æˆ–é‡Šæ”¾é”®ç›˜ä¸Šçš„ä¸€ä¸ªé”®æ—¶ï¼Œé”®ç›˜æ§åˆ¶å™¨ï¼ˆKeyboard Controllerï¼‰ä¼šç”Ÿæˆä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ä¿¡å·ï¼Œå‘é€ç»™ä¸­æ–­æ§åˆ¶å™¨ï¼ˆInterrupt Controllerï¼‰ã€‚</li>
<li>ä¸­æ–­æ§åˆ¶å™¨ä¼šæ ¹æ®ä¸­æ–­ä¼˜å…ˆçº§å’Œå…¶ä»–å› ç´ ï¼Œå†³å®šæ˜¯å¦å°†è¯¥ä¸­æ–­ä¿¡å·ä¼ é€’ç»™ CPUã€‚</li>
</ul>
<p><strong>2. ä¸­æ–­å¤„ç†ç¨‹åºï¼š</strong></p>
<ul>
<li>
<p>ç»ˆç«¯é©±åŠ¨ç¨‹åºï¼ˆTerminal Driverï¼‰ä¼šæ³¨å†Œä¸€ä¸ªä¸­æ–­å¤„ç†ç¨‹åºï¼Œä¸“é—¨å¤„ç†æ¥è‡ªé”®ç›˜çš„ä¸­æ–­ã€‚</p>
</li>
<li>
<p>å¦‚æœ CPU æ¥å—äº†ä¸­æ–­è¯·æ±‚ï¼Œå®ƒä¼šæš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè½¬è€Œæ‰§è¡Œé”®ç›˜ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆInterrupt Handlerï¼‰ã€‚å½“é”®ç›˜ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œç»ˆç«¯é©±åŠ¨çš„ä¸­æ–­å¤„ç†ç¨‹åºä¼šè¢«è°ƒç”¨ï¼Œå®ƒä¼šå°†æ‰«æç è½¬æ¢ä¸º ASCII ç æˆ– Unicode ç ç­‰å­—ç¬¦ç¼–ç ã€‚</p>
</li>
<li>
<p>ä¸­æ–­å¤„ç†ç¨‹åºä¼šè¯»å–é”®ç›˜æ§åˆ¶å™¨ä¸­çš„æ•°æ®ï¼Œè·å–æŒ‰é”®çš„æ‰«æç ï¼ˆScan Codeï¼‰ï¼Œå®ƒä»£è¡¨äº†æŒ‰ä¸‹æˆ–é‡Šæ”¾çš„å…·ä½“é”®ä½ã€‚ç»ˆç«¯é©±åŠ¨ç¨‹åºä¼šå°†è½¬æ¢åçš„å­—ç¬¦å­˜å‚¨åœ¨ä¸€ä¸ªç¼“å†²åŒºï¼ˆBufferï¼‰ä¸­ï¼Œç­‰å¾…ç”¨æˆ·ç¨‹åºè¯»å–ã€‚</p>
</li>
</ul>
<p><strong>3. ç”¨æˆ·ç¨‹åºï¼š</strong></p>
<ul>
<li>å½“ç”¨æˆ·ç¨‹åºï¼ˆä¾‹å¦‚ shell æˆ–æ–‡æœ¬ç¼–è¾‘å™¨ï¼‰éœ€è¦è·å–é”®ç›˜è¾“å…¥æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼ˆSystem Callï¼‰è¯»å–ç»ˆç«¯è®¾å¤‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ /dev/ttyï¼‰ã€‚</li>
<li>ç»ˆç«¯é©±åŠ¨ç¨‹åºä¼šå°†ç¼“å†²åŒºä¸­çš„å­—ç¬¦è¿”å›ç»™ç”¨æˆ·ç¨‹åºï¼Œç”¨æˆ·ç¨‹åºå°±å¯ä»¥æ ¹æ®è¿™äº›å­—ç¬¦æ‰§è¡Œç›¸åº”çš„æ“ä½œäº†ã€‚</li>
</ul>
</blockquote>
<h3 id="å—è®¾å¤‡">å—è®¾å¤‡</h3>
<p>å—è®¾å¤‡æ˜¯ä¸€ç§ä»¥æ•°æ®å—ä¸ºå•ä½è¿›è¡Œæ•°æ®ä¼ è¾“çš„è®¾å¤‡ï¼Œå®ƒå¯ä»¥éšæœºè®¿é—®æ•°æ®å—ï¼Œå¹¶ä¸”æ•°æ®ä¼ è¾“é€šå¸¸æœ‰ç¼“å­˜</p>
<ul>
<li>ç¡¬ç›˜ã€SSDï¼šæ•°æ®ä»¥å—çš„å½¢å¼å­˜å‚¨å’Œè¯»å–ã€‚</li>
<li>USB å­˜å‚¨è®¾å¤‡ï¼šä¾‹å¦‚ U ç›˜ã€ç§»åŠ¨ç¡¬ç›˜ç­‰ã€‚</li>
<li>CD/DVD å…‰é©±ï¼šæ•°æ®ä»¥æ‰‡åŒº (sector) ä¸ºå•ä½å­˜å‚¨ï¼Œæ¯ä¸ªæ‰‡åŒºé€šå¸¸ä¸º 512 å­—èŠ‚ã€‚</li>
</ul>
<h2 id="kernelç¨‹åº">kernelç¨‹åº</h2>
<h3 id="VX6-kernelç¨‹åºå†…å®¹">VX6 kernelç¨‹åºå†…å®¹</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kinitï¼šè®¾ç½®å¥½é¡µè¡¨åˆ†é…å™¨ï¼ˆpage allocatorï¼‰</span><br><span class="line"></span><br><span class="line">kvminitï¼šä¸ºkernelåˆ†é…é¡µè¡¨ï¼Œå°†ä½åœ°å€è®¾å¤‡æ˜ å°„åˆ°kernelåœ°å€ç©ºé—´ï¼ˆå³åœ¨kernelé¡µè¡¨ä¸­å†™å…¥PTEæŒ‡å‘è®¾å¤‡ï¼‰</span><br><span class="line"></span><br><span class="line">kvminithartï¼šé¡µè¡¨å¼€å§‹ç”Ÿæ•ˆï¼Œç¨‹åºè®¡æ•°å™¨å°†ä¼šé€šè¿‡MMUç¿»è¯‘ä¸ºç‰©ç†åœ°å€</span><br><span class="line"></span><br><span class="line">processinitï¼šè®¾ç½®å¥½åˆå§‹è¿›ç¨‹æˆ–è€…è¯´è®¾ç½®å¥½è¿›ç¨‹è¡¨å•</span><br><span class="line"></span><br><span class="line">trapinit/trapinithartï¼šè®¾ç½®å¥½user/kernel modeè½¬æ¢ä»£ç </span><br><span class="line"></span><br><span class="line">plicinit/plicinithartï¼šè®¾ç½®å¥½ä¸­æ–­æ§åˆ¶å™¨PLICï¼ˆPlatform Level Interrupt Controllerï¼‰ï¼Œæˆ‘ä»¬åé¢åœ¨ä»‹ç»ä¸­æ–­çš„æ—¶å€™ä¼šè¯¦ç»†çš„ä»‹ç»è¿™éƒ¨åˆ†ï¼Œè¿™æ˜¯æˆ‘ä»¬ç”¨æ¥ä¸ç£ç›˜å’Œconsoleäº¤äº’æ–¹å¼</span><br><span class="line"></span><br><span class="line">binitï¼šåˆ†é…buffer cache</span><br><span class="line"></span><br><span class="line">iinitï¼šåˆå§‹åŒ–inodeç¼“å­˜</span><br><span class="line"></span><br><span class="line">fileinitï¼šåˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">virtio_disk_initï¼šåˆå§‹åŒ–ç£ç›˜</span><br><span class="line"></span><br><span class="line">userinitï¼šæœ€åå½“æ‰€æœ‰çš„è®¾ç½®éƒ½å®Œæˆäº†ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿè¿è¡Œèµ·æ¥äº†ï¼Œä¼šé€šè¿‡userinitè¿è¡Œç¬¬ä¸€ä¸ªè¿›ç¨‹</span><br></pre></td></tr></table></figure>
<h3 id="tiny-os-kernelç¨‹åºå†…å®¹">tiny-os kernelç¨‹åºå†…å®¹</h3>
<p>loaderç¨‹åºä¸kernelç¨‹åºå¯¹æ¯”</p>
<p>loaderä¸ºçº¯äºŒè¿›åˆ¶ç¨‹åº ï¼Œä»…åŒ…å«æœºå™¨ç ï¼Œæ ¹æ®æœºå™¨ç å†…å®¹è£…è½½è‡³å†…å­˜åç›´æ¥å¼€å§‹è¿è¡Œï¼›</p>
<p>kernelä¸ºelfæ–‡ä»¶ï¼Œå­˜åœ¨æ–‡ä»¶å¤´ï¼ŒèŠ‚ç­‰å†…å®¹ï¼Œåœ¨è¿›è¡Œsegmentå±•å¼€åæˆä¸ºå¯è¿è¡Œçš„æœºå™¨ç </p>
<img src="/2024/04/12/Op-sys-Learning-Record/image-20240421144651548.png" class="" title="image-20240421144651548">
<p>kernelä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//interrupt.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">idt_init</span><span class="params">()</span> &#123;</span><br><span class="line">    idt_desc_init(); <span class="comment">//åˆ›å»ºé—¨æè¿°ç¬¦ï¼Œå†™å…¥å±æ€§å’Œä¸€é˜¶ä¸­æ–­ç¨‹åºå…¥å£åœ°å€ï¼Œå¡«å…¥idt</span></span><br><span class="line">    exception_handler_init();</span><br><span class="line">    <span class="comment">//å¼‚å¸¸å¤„ç†å‡½æ•°åˆå§‹åŒ–ï¼Œåˆ›å»ºä¸­æ–­å¤„ç†å‡½æ•°ï¼Œä½¿ä¸€é˜¶ä¸­æ–­ç¨‹åºæœ‰å¯ç”¨è°ƒç”¨çš„å‡½æ•°</span></span><br><span class="line">    pic_init(); <span class="comment">//åˆå§‹åŒ–ä¸»ç‰‡8259A</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†idtåœ°å€å†™å…¥idtr</span></span><br><span class="line">    <span class="type">uint64_t</span> idt_operand = ((<span class="keyword">sizeof</span>(idt) - <span class="number">1</span>) | ((<span class="type">uint64_t</span>) ((<span class="type">uint32_t</span>) idt &lt;&lt; <span class="number">16</span>)));</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;lidt %0&quot;</span> : : <span class="string">&quot;m&quot;</span> (idt_operand))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//timer.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_init</span><span class="params">()</span> &#123;</span><br><span class="line">    frequency_set(COUNTER0_PORT, COUNTER0_NO, READ_WRITE_LATCH, COUNTER_MODE, COUNTER0_VALUE);<span class="comment">//è®¾ç½®8253å‘ä¸­æ–­çš„å‘¨æœŸ</span></span><br><span class="line">    register_handler(<span class="number">0x20</span>, intr_timer_handler);</span><br><span class="line">    <span class="comment">//è§¦å‘0x20ä¸­æ–­æ—¶è°ƒç”¨intr_timer_handlerå‡½æ•°ï¼Œç”¨äºè¿›è¡Œè°ƒåº¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//memory.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mem_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> total_memory = (*(<span class="type">uint32_t</span>*) (<span class="number">0xb00</span>));</span><br><span class="line">    mem_pool_init(total_memory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//init.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_all</span><span class="params">()</span> &#123;</span><br><span class="line">    idt_init();</span><br><span class="line">    timer_init</span><br><span class="line">    <span class="title function_">mem_init</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//thread.h</span></span><br><span class="line"><span class="keyword">struct</span> task_struct* <span class="title function_">thread_start</span><span class="params">(<span class="type">char</span>* name, <span class="type">int</span> prio, thread_func function, <span class="type">void</span>* func_args)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>* <span class="title">thread</span> =</span> get_kernel_pages(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//æ­¤ä¸ºå†…æ ¸æ‹‰èµ·çš„å†…æ ¸çº¿ç¨‹ï¼Œæ•…ç”³è¯·å†…æ ¸é¡µä½œä¸ºPCB</span></span><br><span class="line"></span><br><span class="line">    init_thread(thread, name, prio);</span><br><span class="line">    <span class="comment">//å°†ç”³è¯·åˆ°çš„å†…æ ¸é¡µæ¸…ç©ºå¹¶å†™å…¥PCBä¸­çš„å±æ€§</span></span><br><span class="line">    </span><br><span class="line">    thread_create(thread, function, func_args);</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–PCBä¸­çš„æ ˆï¼Œåˆ›å»ºä¸­æ–­æ ˆå’Œçº¿ç¨‹æ ˆï¼Œå‹å…¥çº¿ç¨‹éœ€è¦æ‰§è¡Œçš„å‡½æ•°çš„ç›¸å…³æ•°æ®å’Œå¯„å­˜å™¨åˆå§‹å€¼</span></span><br><span class="line"></span><br><span class="line">    ASSERT(!list_find(&amp;thread_ready_list, &amp;thread-&gt;general_tag));</span><br><span class="line">    list_append(&amp;thread_ready_list, &amp;thread-&gt;general_tag);</span><br><span class="line">    <span class="comment">//å°†çº¿ç¨‹åŠ å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œgeneral_tagä¸ºå°±ç»ªé˜Ÿåˆ—/è¿è¡Œé˜Ÿåˆ—/é˜»å¡é˜Ÿåˆ—ç­‰ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line">    ASSERT(!list_find(&amp;thread_all_list, &amp;thread-&gt;all_list_tag));</span><br><span class="line">    list_append(&amp;thread_all_list, &amp;thread-&gt;all_list_tag);</span><br><span class="line">    <span class="comment">//å°†çº¿ç¨‹åŠ å…¥ç³»ç»Ÿçº¿ç¨‹é˜Ÿåˆ—ï¼Œall_list_tagä¸ºç³»ç»Ÿçº¿ç¨‹é˜Ÿåˆ—ä½¿ç”¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movl %0, %%esp; pop %%ebp; pop %%ebx; pop %%edi; pop %%esi; ret&quot;</span> : : <span class="string">&quot;g&quot;</span> (thread-&gt;self_kstack) : <span class="string">&quot;memory&quot;</span>)</span>;</span><br><span class="line">    <span class="comment">//å°†å‹æ ˆçš„å¯„å­˜å™¨åˆå§‹å€¼å¼¹æ ˆï¼Œretå°†çº¿ç¨‹éœ€è¦æ‰§è¡Œçš„å‡½æ•°çš„ç›¸å…³æ•°æ®å¼¹æ ˆå¹¶å‰å¾€æ‰§è¡Œ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//main.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    init_all();</span><br><span class="line">    thread_start(<span class="string">&quot;k_thread_1&quot;</span>, <span class="number">31</span>, k_thread_function, <span class="string">&quot;skywalker &quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Operation System</category>
      </categories>
      <tags>
        <tag>C</tag>
      </tags>
  </entry>
  <entry>
    <title>common-commands</title>
    <url>/2024/06/22/common-commands/</url>
    <content><![CDATA[<p>å¸¸ç”¨æŒ‡ä»¤</p>
<span id="more"></span>
<h1>Common Commands</h1>
<h2 id="python">python</h2>
<p><a href="https://zhuanlan.zhihu.com/p/69746955">https://zhuanlan.zhihu.com/p/69746955</a></p>
<p>pythonå˜é‡ï¼Œå‡½æ•°å‡ä¸ºå¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>() : </span><br><span class="line">    <span class="comment">#å‡½æ•°åœ¨åˆ›å»ºæ—¶åŒæ—¶ç”Ÿæˆå˜é‡å¯¹è±¡helloå’Œå‡½æ•°å¯¹è±¡ï¼ˆå‡½æ•°å¯¹è±¡åä¸ºhelloï¼‰</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(test())<span class="comment">#å‡½æ•°é»˜è®¤è¿”å›å€¼ä¸ºNone</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">say = hello</span><br><span class="line"> </span><br><span class="line"><span class="keyword">del</span> hello <span class="comment">#delåˆ é™¤äº†helloå˜é‡å¯¹è±¡</span></span><br><span class="line">say()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(say))<span class="comment">##å¯¹è±¡å±æ€§</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(say))<span class="comment">##å¯¹è±¡å±æ€§</span></span><br><span class="line"><span class="built_in">print</span>(say)<span class="comment">##å¯¹è±¡å±æ€§</span></span><br><span class="line"><span class="built_in">print</span>(say.__name__) <span class="comment">##å¯¹è±¡å±æ€§,æŸ¥çœ‹å¯¹è±¡å</span></span><br></pre></td></tr></table></figure>
<p>pythonç±»</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class MyClass:</span><br><span class="line">    def my_method(self, arg1, arg2):</span><br><span class="line">    #ç±»çš„æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºself</span><br><span class="line">        # æ–¹æ³•ä½“</span><br><span class="line"></span><br><span class="line">#Bound Method</span><br><span class="line">obj = MyClass()#ç±» å®ä¾‹åŒ–</span><br><span class="line">obj.my_method(arg1, arg2)#å®ä¾‹å¯¹è±¡è°ƒç”¨æ–¹æ³•</span><br><span class="line"></span><br><span class="line">#Unbound Method</span><br><span class="line">MyClass.my_method(obj, arg1, arg2)</span><br><span class="line">	#åŸå› ï¼šå¯ä»¥ç›´æ¥é€šè¿‡ç±»è®¿é—®æ–¹æ³•ï¼Œä½†æ˜¯å¿…é¡»æŒ‡å®šç±»çš„å®ä¾‹</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°å†…éƒ¨å‡½æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">        x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> test</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hello()())</span><br><span class="line"><span class="comment">#é¦–å…ˆhello()è¿”å›å‡½æ•°å¯¹è±¡testï¼Œç„¶åè°ƒç”¨ test()</span></span><br></pre></td></tr></table></figure>
<p>å‡½æ•°è£…é¥°å™¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">f</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inn</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;inner&quot;</span>)</span><br><span class="line">        f()</span><br><span class="line">    <span class="keyword">return</span> inn</span><br><span class="line"></span><br><span class="line"><span class="meta">@hello</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#ç­‰ä»·äº</span></span><br><span class="line">test=hello(test)<span class="comment">#åŸå‡½æ•°å¯¹è±¡testä»å­˜åœ¨ï¼Œå˜é‡å¯¹è±¡testæŒ‡å‘æ–°å‡½æ•°hello(test)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#test &lt;function test at 0x000001821AE551C0&gt;</span></span><br><span class="line"><span class="comment">#test() None</span></span><br><span class="line"><span class="comment">#testä¸ºå‡½æ•°å¯¹è±¡ï¼Œtest()ä¸ºï¼ˆæ‰§è¡Œå‡½æ•°å¯¹è±¡åçš„ï¼‰è¿”å›å€¼</span></span><br><span class="line">test()</span><br><span class="line"><span class="built_in">print</span>(test.__name__)</span><br></pre></td></tr></table></figure>
<p>withè¯­å¥ ä¸Šä¸‹æ–‡å¯¹è±¡ç®¡ç†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">with open(&#x27;myfile.txt&#x27;, &#x27;r&#x27;) as f:</span><br><span class="line">    contents = f.read()</span><br><span class="line">    print(contents)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>open(â€˜myfile.txtâ€™, â€˜râ€™)</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒæ‰“å¼€æ–‡ä»¶å¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ã€‚</li>
<li><strong>as f</strong>ï¼šå°†æ–‡ä»¶å¯¹è±¡èµ‹å€¼ç»™å˜é‡ fï¼Œä»¥ä¾¿åœ¨ with ä»£ç å—ä¸­ä½¿ç”¨ã€‚</li>
<li>åœ¨ with ä»£ç å—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ f è¯»å–æ–‡ä»¶å†…å®¹ã€‚</li>
<li>å½“ with ä»£ç å—æ‰§è¡Œå®Œæ¯•åï¼Œæ–‡ä»¶ä¼šè‡ªåŠ¨å…³é—­ï¼Œå³ä½¿åœ¨è¯»å–è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ã€‚</li>
</ul>
<p>Pythonç±»å‹æ³¨è§£</p>
<p><a href="https://zhuanlan.zhihu.com/p/419955374">https://zhuanlan.zhihu.com/p/419955374</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">say_hi</span>(<span class="params">name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="comment">#è§„å®šå‡½æ•°ä¼ å…¥å‚æ•°ä¸ºstrç±»å‹ï¼Œè¿”å›å€¼ä¸ºstrç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Hello <span class="subst">&#123;name&#125;</span>!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix</span>(<span class="params">scores: <span class="built_in">list</span>[<span class="built_in">int</span>], ages: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]</span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="comment">#å®¹å™¨æ³¨è§£</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">seq: Seq1[<span class="built_in">str</span>]</span>):</span><br><span class="line">    <span class="comment">#ä¼ å…¥å‚æ•°ä¸ºï¼ˆåˆ—è¡¨+å…ƒç»„ï¼‰çš„æ³›åŒ–ï¼šåºåˆ—Seq</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> seq:</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">a: <span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="comment">#å¯é€‰è¿”å›å€¼ï¼šä¸ºNoneæˆ–ä¸ºstr</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Yeah&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>() -&gt; <span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">int</span>, <span class="built_in">float</span>]:</span><br><span class="line">    <span class="comment">#å¯é€‰è¿”å›å€¼ï¼šä¸ºstrï¼Œintï¼Œfloat ä¸‰é€‰ä¸€</span></span><br><span class="line">    <span class="comment">#Optional[int] å’Œ Union[int, None] æ˜¯ç­‰ä»·çš„ã€‚</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#Tä¸ºæ³›å‹ï¼ŒTå¿…é¡»ä¸ºstræˆ–int</span></span><br><span class="line">T = TypeVar(<span class="string">&#x27;T&#x27;</span>, <span class="built_in">str</span>, <span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>(<span class="params">a: T, b: T</span>) -&gt; <span class="type">List</span>[T]:</span><br><span class="line">    <span class="keyword">return</span> [a, b]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kçš„å…·ä½“ç±»å‹æ²¡æœ‰é™åˆ¶</span></span><br><span class="line">K = TypeVar(<span class="string">&quot;K&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="python-ç¯å¢ƒ">python ç¯å¢ƒ</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update  <span class="comment"># æ›´æ–°åŒ…ç®¡ç†å™¨</span></span><br><span class="line"></span><br><span class="line">sudo apt-get install python3-venv  <span class="comment"># å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒå·¥å…·</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /path/to/your/project</span><br><span class="line"></span><br><span class="line">python3 -m venv venv</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line"></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line">deactivate</span><br></pre></td></tr></table></figure>
<p>condaæŒ‡ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">conda <span class="built_in">env</span> list</span><br><span class="line"></span><br><span class="line">conda create --name your_env_name python=3.5 numpy scipy</span><br><span class="line"></span><br><span class="line">conda remove --name your_env_name --all</span><br><span class="line"></span><br><span class="line">conda install</span><br><span class="line"></span><br><span class="line">conda install numpy=1.9.3</span><br><span class="line"></span><br><span class="line">activate your_env_name</span><br><span class="line"></span><br><span class="line">deactivate</span><br><span class="line"></span><br><span class="line">conda clean --all</span><br></pre></td></tr></table></figure>
<p>å½“å‰condaè™šæ‹Ÿç¯å¢ƒä¸­å­˜åœ¨pipæ—¶ï¼Œä½¿ç”¨pipæŒ‡ä»¤å°†ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒä¸­pipè€Œéå…¨å±€pipï¼Œå¯é€šè¿‡pip listï¼ˆå½“å‰ç¯å¢ƒå¿…é¡»å·²å®‰è£…pipï¼‰å’Œ conda list æŸ¥çœ‹å½“å‰ç¯å¢ƒåŒ…åˆ—è¡¨</p>
<p>å‡ºç°æŠ¥é”™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PackagesNotFoundError: The following packages are not available from current channels</span><br></pre></td></tr></table></figure>
<p>å°è¯•åœ¨<a href="https://anaconda.xn--org-us9ds1a2eq8vn4srgggrku8b9tcdqf8an48pgtee4b666aphkt3ki53cqmo">https://anaconda.orgç›´æ¥æœç´¢è¯¥åŒ…å¹¶ä½¿ç”¨ç½‘ç«™æ‰€æä¾›çš„æŒ‡ä»¤å®‰è£…</a></p>
<h2 id="Docker">Docker</h2>
<ol>
<li>
<p><strong><code>docker pull</code></strong>ï¼šç”¨äºä» Docker é•œåƒä»“åº“ä¸‹è½½é•œåƒåˆ°æœ¬åœ°ä¸»æœºã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker pull [OPTIONS] NAME[:TAG|@DIGEST]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker pull ubuntu:20.04</code></li>
</ul>
<p>è¿™ä¸ªå‘½ä»¤ç”¨äºè·å– Docker é•œåƒï¼Œå…¶ä¸­ <code>NAME</code> è¡¨ç¤ºé•œåƒçš„åç§°ï¼Œ<code>TAG</code> è¡¨ç¤ºé•œåƒçš„æ ‡ç­¾ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ <code>@DIGEST</code> æ¥æŒ‡å®šé•œåƒçš„æ‘˜è¦ã€‚å¦‚æœä¸æŒ‡å®šæ ‡ç­¾ï¼Œå°†é»˜è®¤è·å– <code>latest</code> æ ‡ç­¾çš„é•œåƒã€‚</p>
</li>
<li>
<p><strong><code>docker load</code></strong>ï¼šç”¨äºä»æ–‡ä»¶åŠ è½½é•œåƒï¼Œé€šå¸¸æ˜¯ä»¥ tar å½’æ¡£æ–‡ä»¶çš„å½¢å¼ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker load [OPTIONS]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker load -i myimage.tar</code></li>
</ul>
<p>è¿™ä¸ªå‘½ä»¤ç”¨äºåŠ è½½ä»¥ tar å½’æ¡£æ–‡ä»¶æ ¼å¼å­˜å‚¨çš„ Docker é•œåƒã€‚é€šå¸¸ç”¨äºå°†é•œåƒä»ä¸€ä¸ªç¯å¢ƒä¼ è¾“åˆ°å¦ä¸€ä¸ªç¯å¢ƒã€‚</p>
</li>
<li>
<p><strong><code>docker save</code></strong>ï¼šç”¨äºå°† Docker é•œåƒä¿å­˜ä¸º tar å½’æ¡£æ–‡ä»¶ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker save [OPTIONS] IMAGE [IMAGE...]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker save -o myimage.tar myimage:tag</code></li>
</ul>
<p>è¿™ä¸ªå‘½ä»¤å…è®¸ä½ å°†ä¸€ä¸ªæˆ–å¤šä¸ª Docker é•œåƒä¿å­˜ä¸º tar å½’æ¡£æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºå¯¼å‡ºé•œåƒä»¥ä¾¿åœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>
</li>
<li>
<p><strong><code>docker run</code></strong>ï¼šç”¨äºåˆ›å»ºå’Œå¯åŠ¨ Docker å®¹å™¨ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker run -d -p 8080:80 my-web-app</code></li>
</ul>
<p>è¿™ä¸ªå‘½ä»¤ç”¨äºåœ¨ Docker å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ªé•œåƒï¼Œä½ éœ€è¦æŒ‡å®šé•œåƒçš„åç§°ã€å®¹å™¨é€‰é¡¹ï¼ˆå¦‚ç«¯å£æ˜ å°„ã€ç¯å¢ƒå˜é‡ã€å®¹å™¨åç§°ç­‰ï¼‰ï¼Œä»¥åŠå®¹å™¨å†…è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p>
</li>
<li>
<p><strong><code>docker build</code></strong>ï¼šç”¨äºæ„å»ºè‡ªå®šä¹‰ Docker é•œåƒï¼Œé€šå¸¸é€šè¿‡ Dockerfile æ–‡ä»¶å®šä¹‰æ„å»ºæ­¥éª¤ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker build [OPTIONS] PATH | URL | -</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker build -t my-custom-image .</code></li>
</ul>
<p><code>docker build</code> å‘½ä»¤ç”¨äºåŸºäº Dockerfile æ„å»ºè‡ªå®šä¹‰é•œåƒã€‚ä½ éœ€è¦æä¾›åŒ…å« Dockerfile çš„è·¯å¾„ï¼Œä»¥åŠå¯é€‰çš„é€‰é¡¹å’Œæ ‡ç­¾ã€‚</p>
<p>Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ä½¿ç”¨å®˜æ–¹ Python 3 é•œåƒä½œä¸ºåŸºç¡€é•œåƒ</span><br><span class="line">FROM python:3.8</span><br><span class="line"></span><br><span class="line"># è®¾ç½®å·¥ä½œç›®å½•</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"># å¤åˆ¶æœ¬åœ°é¡¹ç›®åˆ°å®¹å™¨ä¸­</span><br><span class="line">COPY ./myproject /app</span><br><span class="line"></span><br><span class="line"># å®‰è£…é¡¹ç›®ä¾èµ–</span><br><span class="line">RUN pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"># æŒ‡å®šå®¹å™¨å¯åŠ¨å‘½ä»¤</span><br><span class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>docker rm</code></strong>ï¼šç”¨äºåˆ é™¤å·²åœæ­¢çš„å®¹å™¨ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker rm [OPTIONS] CONTAINER [CONTAINER...]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker rm my-container</code></li>
</ul>
<p>è¿™ä¸ªå‘½ä»¤ç”¨äºåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå·²ç»åœæ­¢çš„å®¹å™¨ï¼Œé‡Šæ”¾èµ„æºå¹¶æ¸…ç†ç³»ç»Ÿã€‚</p>
</li>
<li>
<p><strong><code>docker stop</code></strong>ï¼šç”¨äºåœæ­¢è¿è¡Œä¸­çš„å®¹å™¨ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker stop [OPTIONS] CONTAINER [CONTAINER...]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker stop my-container</code></li>
</ul>
<p>è¿™ä¸ªå‘½ä»¤ç”¨äºåœæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œä½¿å®ƒä»¬ä»è¿è¡ŒçŠ¶æ€è½¬æ¢ä¸ºåœæ­¢çŠ¶æ€ã€‚</p>
</li>
<li>
<p><strong><code>docker ps</code></strong>ï¼šç”¨äºåˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨ã€‚</p>
<ul>
<li>è¯­æ³•ï¼š<code>docker ps [OPTIONS]</code></li>
<li>ç¤ºä¾‹ï¼š<code>docker ps -a</code></li>
</ul>
<p><code>docker ps</code> å‘½ä»¤ç”¨äºåˆ—å‡ºå½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŒ…æ‹¬å®¹å™¨çš„ IDã€çŠ¶æ€ã€ç«¯å£æ˜ å°„ç­‰ä¿¡æ¯ã€‚åŠ ä¸Š <code>-a</code> é€‰é¡¹å¯ä»¥åˆ—å‡ºæ‰€æœ‰å®¹å™¨ï¼ŒåŒ…æ‹¬å·²åœæ­¢çš„å®¹å™¨ã€‚</p>
</li>
</ol>
<h2 id="Gitæ“ä½œå®ä¾‹"><strong>Gitæ“ä½œå®ä¾‹</strong></h2>
<p>Git çš„è®¾è®¡æ˜¯åŸºäºä¸å¯å˜çš„ DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰</p>
<p><strong>å·¥ä½œåŒº</strong>ï¼šå¼€å‘è€…åœ¨å·¥ä½œåŒºä¸­è¿›è¡Œæ—¥å¸¸çš„ä»£ç å¼€å‘å’Œä¿®æ”¹å·¥ä½œï¼ˆå°±æ˜¯ä»€ä¹ˆgitæ“ä½œéƒ½æ²¡æœ‰åšç›´æ¥æ”¹ä»£ç ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯å·¥ä½œåŒº</p>
<p><strong>æš‚å­˜åŒº</strong>ï¼š<code>git add</code> ä¼šå°†æ–‡ä»¶çš„å½“å‰çŠ¶æ€ï¼ˆå³ <strong>ä¿®æ”¹åçš„å†…å®¹</strong>ï¼‰ä» <strong>å·¥ä½œåŒº</strong> æ‹·è´åˆ° <strong>æš‚å­˜åŒº</strong>ã€‚å¦‚æœæ­¤æ—¶å†æ¬¡ä¿®æ”¹ <strong>å·¥ä½œåŒº</strong> å†…å®¹ï¼Œ <strong>æš‚å­˜åŒº</strong> å†…å®¹ä¸å—å½±å“ã€‚</p>
<p><a href="https://learngitbranching.js.org/">https://learngitbranching.js.org/</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨æ¡Œé¢åˆ›å»ºtestç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> /Users/wangsaichao/Desktop/test</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ°testç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> /Users/wangsaichao/Desktop/test</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶åˆå§‹åŒ–gitåº“</span></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥åˆ°è¿œç¨‹gitä»“åº“ </span></span><br><span class="line"><span class="comment"># -t é»˜è®¤ä½¿ç”¨è¿œç¨‹ä»“åº“çš„ main åˆ†æ”¯ï¼Œoriginä¸ºè¿œç¨‹ä»“åº“åˆ«åï¼ˆæ›¿æ¢é“¾æ¥ï¼‰</span></span><br><span class="line"><span class="comment"># ä¸ºæœ¬åœ°åˆ†æ”¯ main è®¾ç½®äº†ä¸Šæ¸¸è·Ÿè¸ªåˆ†æ”¯ä¸º origin/mainã€‚è¿™æ„å‘³ç€å½“æ‰§è¡Œ git pull æˆ– git push ä¸å¸¦åˆ†æ”¯å‚æ•° æ—¶ï¼ŒGit ä¼šé»˜è®¤ä½¿ç”¨ main åˆ†æ”¯ä¸ origin/main åŒæ­¥</span></span><br><span class="line">git remote add origin -t main https://github.com/xx/xxx.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¿œç¨‹gitåº“ä¸‹è½½åˆ°æœ¬åœ°</span></span><br><span class="line">git pull origin/main</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶éƒ½å¢åŠ åˆ°æœ¬åœ°åº“ä¸­ã€‚</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># æäº¤æ›´æ”¹åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">git commit -m <span class="string">&#x27;æäº¤æ³¨é‡Š&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æœ¬åœ°çš„masteråˆ†æ”¯æ”¹ä¸ºmainåˆ†æ”¯, githubä¸ºé¿å…è”æƒ³å¥´éš¶åˆ¶ã€‚åœ¨æŒç»­çš„å¤–ç•Œå½±å“ä¹‹ä¸‹,é»˜è®¤åˆ†æ”¯ç”±masteræ”¹ä¸ºmainã€‚ </span></span><br><span class="line"><span class="comment"># ä½†æ˜¯gitå·¥å…·é»˜è®¤initè¿˜æ˜¯åˆ›å»ºçš„masteråˆ†æ”¯ æ‰€ä»¥è¦æ”¹æˆmainåˆ†æ”¯ã€‚</span></span><br><span class="line">git branch -M main</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æœ¬åœ°ä¿®æ”¹æ¨åˆ°githubä¸Š</span></span><br><span class="line">git push -u origin main  <span class="comment"># é¦–æ¬¡</span></span><br><span class="line">git push origin main</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç§»é™¤æ–‡ä»¶è·Ÿè¸ª é€‚ç”¨äºæ–‡ä»¶å¤¹</span></span><br><span class="line">git <span class="built_in">rm</span> -r --cached <span class="built_in">dir</span>/</span><br><span class="line"><span class="comment"># ç§»é™¤æ–‡ä»¶è·Ÿè¸ª é€‚ç”¨äºæ–‡ä»¶</span></span><br><span class="line">git <span class="built_in">rm</span> --cached file</span><br></pre></td></tr></table></figure>
<p>branch</p>
<p><strong>åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯æŒ‡é’ˆ</strong>ï¼Œå¹¶å°†å®ƒæŒ‡å‘å½“å‰çš„ <code>HEAD</code> æ‰€åœ¨çš„æ£€æŸ¥ç‚¹ï¼ˆå³å½“å‰çš„ commitï¼‰ã€‚è¿™ä¸ªæ–°çš„åˆ†æ”¯æŒ‡é’ˆä¼šæŒ‡å‘å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤ï¼Œæˆ–è€…å¦‚æœä½ åœ¨ä¸€ä¸ª <strong>detached HEAD</strong> çŠ¶æ€ä¸‹ï¼Œå®ƒä¼šæŒ‡å‘ <code>HEAD</code> å½“å‰æŒ‡å‘çš„ commitã€‚</p>
<ul>
<li>
<p><strong>åˆ†æ”¯æŒ‡é’ˆå§‹ç»ˆæŒ‡å‘è¯¥åˆ†æ”¯æœ€æ–°çš„ commitï¼ˆHEAD çš„ä½ç½®ï¼‰ã€‚</strong></p>
</li>
<li>
<p>å½“åœ¨è¯¥åˆ†æ”¯ä¸Šæäº¤æ–°çš„ commit æ—¶ï¼Œåˆ†æ”¯æŒ‡é’ˆä¼šè‡ªåŠ¨å‰ç§»åˆ°æ–° commitã€‚</p>
</li>
<li>
<p>æ³¨æ„ï¼Œåˆ†æ”¯æŒ‡é’ˆæŒ‡å‘çš„æ˜¯æœ€æ–°çš„ commitï¼Œè€Œä¸æ˜¯æ‰€æœ‰ commitã€‚å†å² commit é€šè¿‡é“¾å¼å¼•ç”¨è”ç³»åœ¨ä¸€èµ·ã€‚</p>
</li>
</ul>
<p>commit</p>
<p>åˆ›å»ºæ£€æŸ¥ç‚¹ï¼Œæ¯ä¸ª commit éƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªåç»§å¼•ç”¨å®ƒï¼ˆä¾‹å¦‚åˆ†æ”¯æˆ–æ ‡ç­¾ï¼‰ï¼Œä½†å®ƒä¸â€œå±äºâ€ä»»ä½•ç‰¹å®šåˆ†æ”¯ã€‚</p>
<p><strong>åˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯â€œé‡ç”Ÿâ€çš„ï¼Œæ ¸å¿ƒå°±æ˜¯çœ‹æ˜¯å¦æœ‰ä»»ä½•åˆ†æ”¯æŒ‡é’ˆé€šè¿‡å›æº¯èƒ½å¤Ÿéå†åˆ°å®ƒã€‚</strong></p>
<p>add</p>
<p>å°†å·¥ä½œåŒºå†…å®¹<strong>è¦†å†™</strong>åˆ°æš‚å­˜åŒº</p>
<p>checkout</p>
<p>ä½¿<strong>headæŒ‡é’ˆ</strong>æŒ‡å‘<strong>æŒ‡å®šbranchæŒ‡é’ˆ</strong>æˆ–<strong>æ£€æŸ¥ç‚¹</strong></p>
<p>git checkout main  # åˆ‡æ¢headæŒ‡å‘mainåˆ†æ”¯æŒ‡é’ˆ</p>
<p>git checkout C1  # åˆ‡æ¢headæŒ‡å‘æ£€æŸ¥ç‚¹ï¼Œ<strong>æ­¤æ—¶headæŒ‡é’ˆä¸mainæŒ‡é’ˆåˆ†ç¦»ï¼ï¼ï¼</strong>ï¼Œåç»­æäº¤çš„èŠ‚ç‚¹ä¸º&quot;é‡ç”Ÿ&quot;èŠ‚ç‚¹</p>
<blockquote>
<p>å½“ HEAD æŒ‡é’ˆç§»åŠ¨åˆ° main åˆ†æ”¯ä¸Šçš„éæœ€æ–°æäº¤ c1 (æœ€æ–°æäº¤æ˜¯ c2) åï¼Œæ‰§è¡ŒcommitæŒ‡ä»¤</p>
<ol>
<li><strong>HEAD æŒ‡é’ˆç§»åŠ¨:</strong> git checkout c1 å‘½ä»¤ä¼šå°† HEAD æŒ‡é’ˆç§»åŠ¨åˆ° c1 æäº¤ï¼Œæ­¤æ—¶å¤„äº â€œåˆ†ç¦» HEAD çŠ¶æ€â€ã€‚</li>
<li><strong>æ–°æäº¤äº§ç”Ÿ:</strong> å½“è¿›è¡Œæ–°çš„æäº¤æ—¶ï¼ŒGit ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤å¯¹è±¡ c3ï¼Œå¹¶å°† c1 ä½œä¸º c3 çš„çˆ¶æäº¤ã€‚</li>
<li><strong>HEAD æŒ‡é’ˆç§»åŠ¨:</strong> c3 æäº¤åˆ›å»ºåï¼ŒHEAD æŒ‡é’ˆä¼šæŒ‡å‘æ–°çš„æäº¤ c3ã€‚æ–°çš„æ£€æŸ¥ç‚¹å°†ä¸å±äºä»»ä½•branchï¼Œå¯èƒ½åœ¨æœªæ¥çš„è¢«åƒåœ¾å›æ”¶</li>
</ol>
</blockquote>
<p>reset</p>
<p>ç§»åŠ¨å½“å‰branchæŒ‡é’ˆåˆ°æŒ‡å®šæ£€æŸ¥ç‚¹</p>
<p>å‡è®¾æœ‰ä»¥ä¸‹å†å²ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">A---B---C---D  (main)</span><br><span class="line">            ^</span><br><span class="line">           HEAD</span><br></pre></td></tr></table></figure>
<ol>
<li><strong><code>git reset --soft B</code></strong>ï¼š
<ul>
<li>HEAD æŒ‡å‘ <code>B</code>ã€‚</li>
<li><code>C</code> å’Œ <code>D</code> è¢«â€œå–æ¶ˆâ€ï¼Œä½†å®ƒä»¬çš„æ›´æ”¹ä»ç„¶åœ¨æš‚å­˜åŒºä¸­ï¼ˆå³æäº¤<code>C</code>å’Œ<code>D</code>çš„ä¿®æ”¹å†…å®¹å…¨éƒ¨ä¿å­˜åœ¨æš‚å­˜åŒº</li>
</ul>
</li>
<li><strong><code>git reset --mixed B</code></strong>ï¼š
<ul>
<li>HEAD æŒ‡å‘ <code>B</code>ã€‚</li>
<li><code>C</code> å’Œ <code>D</code> çš„æ›´æ”¹ä»æš‚å­˜åŒºç§»åˆ°å·¥ä½œåŒºã€‚</li>
</ul>
</li>
<li><strong><code>git reset --hard B</code></strong>ï¼š
<ul>
<li>HEAD æŒ‡å‘ <code>B</code>ã€‚</li>
<li><code>C</code> å’Œ <code>D</code> è¢«ä¸¢å¼ƒï¼Œæš‚å­˜åŒºå’Œå·¥ä½œåŒºéƒ½å›åˆ° <code>B</code> çš„çŠ¶æ€ã€‚</li>
</ul>
</li>
</ol>
<p>rebase [target branch] [source branch(å¯é€‰)]</p>
<p>å‡è®¾æœ‰ä»¥ä¸‹åˆ†æ”¯ç»“æ„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">A---B---C  (current-branch)</span><br><span class="line"> \</span><br><span class="line">  D---E---F  (target-branch)</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>current-branch</code> ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git rebase target-branch</span><br></pre></td></tr></table></figure>
<p>Rebase ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>æ‰¾åˆ°å…±åŒç¥–å…ˆ</strong>ï¼š
<ul>
<li><code>A</code> æ˜¯ <code>current-branch</code> å’Œ <code>target-branch</code> çš„å…±åŒç¥–å…ˆã€‚</li>
</ul>
</li>
<li><strong>æš‚å­˜å½“å‰åˆ†æ”¯çš„æäº¤</strong>ï¼š
<ul>
<li>æå– <code>B</code> å’Œ <code>C</code>ï¼Œå‡†å¤‡åœ¨ç›®æ ‡åˆ†æ”¯ä¸Šé‡æ–°åº”ç”¨ã€‚</li>
</ul>
</li>
<li><strong>åœ¨ç›®æ ‡åˆ†æ”¯çš„åŸºç¡€ä¸Šé‡æ–°åº”ç”¨</strong>ï¼š
<ul>
<li><code>B</code> è¢«é‡æ–°åº”ç”¨åˆ° <code>F</code> ä¹‹åï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ commitï¼ˆå‡è®¾ä¸º <code>B'</code>ï¼‰ã€‚</li>
<li><code>C</code> è¢«é‡æ–°åº”ç”¨åˆ° <code>B'</code> ä¹‹åï¼Œäº§ç”Ÿå¦ä¸€ä¸ªæ–°çš„ commitï¼ˆå‡è®¾ä¸º <code>C'</code>ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>ç§»åŠ¨å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆ</strong>ï¼š
<ul>
<li><code>current-branch</code> çš„æŒ‡é’ˆè¢«ç§»åŠ¨åˆ° <code>C'</code>ã€‚</li>
</ul>
</li>
</ol>
<p>æœ€ç»ˆçš„ç»“æ„å˜æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D---E---F---B&#x27;---C&#x27;  (current-branch)</span><br></pre></td></tr></table></figure>
<p>merge [target branch]</p>
<p>åˆ›å»ºæ–°çš„æ£€æŸ¥ç‚¹ï¼Œè¯¥æ£€æŸ¥ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸º<strong>å½“å‰branchæŒ‡é’ˆæ‰€æŒ‡å‘èŠ‚ç‚¹</strong>å’Œ<strong>ç›®æ ‡branchæŒ‡é’ˆæ‰€æŒ‡å‘èŠ‚ç‚¹</strong>ï¼Œ<strong>ç§»åŠ¨å½“å‰branchæŒ‡é’ˆæŒ‡å‘æ–°åˆ›å»ºèŠ‚ç‚¹</strong>ã€‚</p>
<p>fetch</p>
<ul>
<li>fetchå°†ä¸‹è½½è¿œç¨‹ä»“åº“çš„å†…å®¹ï¼Œå¹¶ç§»åŠ¨ è¿œç¨‹æŒ‡é’ˆ &lt;è¿œç¨‹ä»“åº“å&gt;/&lt;åˆ†æ”¯&gt; æŒ‡å‘ä¸è¿œç¨‹ä»“åº“åŒæ­¥çš„ä½ç½®</li>
<li>ä¸æ›´æ–°æœ¬åœ°æŒ‡é’ˆï¼ï¼ï¼è¿™æ„å‘³ç€ï¼Œå¦‚æœæœ¬åœ°mainåˆ†æ”¯æŒ‡é’ˆç°åœ¨æŒ‡å‘C2ï¼Œè¿œç¨‹æŒ‡é’ˆæŒ‡å‘C1ï¼Œè¿œç¨‹ä»“åº“å·²æ›´æ–°è‡³C3ï¼Œæ‰§è¡Œfetchåä¼šå­˜åœ¨ä»¥ä¸‹æƒ…å†µ</li>
</ul>
<img src="/2024/06/22/common-commands/image-20240823160319940.png" class="" title="image-20240823160319940">
<img src="/2024/06/22/common-commands/image-20240823160406360.png" class="" title="image-20240823160406360">
<p>pull</p>
<ul>
<li>pullæŒ‡ä»¤ä¸ºfetchå’ŒmergeæŒ‡ä»¤çš„å’Œï¼Œå› æ­¤ä¼šä½¿å½“å‰branchæŒ‡é’ˆç§»åŠ¨</li>
<li><code>git pull</code> æ‹‰å–æ—¶ï¼Œé»˜è®¤æ˜¯é’ˆå¯¹å½“å‰åˆ†æ”¯å…³è”çš„å•ä¸ªè¿œç¨‹åˆ†æ”¯è¿›è¡Œæ“ä½œ</li>
</ul>
<p><code>git pull</code> çš„ä¸€äº›å¸¸è§è¡Œä¸ºï¼š</p>
<ul>
<li>
<p><strong><code>git pull</code> (ä¸å¸¦å‚æ•°):</strong> è¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚å®ƒä¼šä»å½“å‰åˆ†æ”¯è¿½è¸ªçš„è¿œç¨‹åˆ†æ”¯è·å–æœ€æ–°æäº¤ï¼Œå¹¶å°è¯•å°†å…¶åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ã€‚å¦‚æœä½ çš„å½“å‰åˆ†æ”¯å·²ç»è®¾ç½®äº†ä¸Šæ¸¸åˆ†æ”¯ (upstream branch)ï¼Œé‚£ä¹ˆ <code>git pull</code> å°†ä¼šä½¿ç”¨è¿™ä¸ªä¸Šæ¸¸åˆ†æ”¯ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>git branch -vv</code> æŸ¥çœ‹å½“å‰åˆ†æ”¯è¿½è¸ªçš„è¿œç¨‹åˆ†æ”¯ã€‚</p>
</li>
<li>
<p>**<code>git pull &lt;remote&gt; &lt;branch&gt;</code>: ** è¿™ä¼šä»æŒ‡å®šçš„è¿œç¨‹ä»“åº“ <code>&lt;remote&gt;</code> çš„ <code>&lt;branch&gt;</code> åˆ†æ”¯è·å–æœ€æ–°æäº¤ï¼Œå¹¶å°è¯•å°†å…¶åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ã€‚ ä¾‹å¦‚ï¼Œ<code>git pull origin develop</code> ä¼šä»è¿œç¨‹ä»“åº“ <code>origin</code> çš„ <code>develop</code> åˆ†æ”¯è·å–æ›´æ–°ï¼Œå¹¶åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ã€‚</p>
</li>
<li>
<p><strong><code>git pull --rebase</code>:</strong> è¿™ä¼šä½¿ç”¨ <code>git rebase</code> è€Œä¸æ˜¯ <code>git merge</code> æ¥æ•´åˆè¿œç¨‹åˆ†æ”¯çš„æ›´æ”¹ã€‚<code>rebase</code> ä¼šå°†ä½ çš„æœ¬åœ°æäº¤æ”¾åœ¨è¿œç¨‹åˆ†æ”¯çš„æœ€æ–°æäº¤ä¹‹åï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ›´çº¿æ€§çš„æäº¤å†å²ã€‚  å¯ä»¥é€šè¿‡ <code>git config --global pull.rebase true</code> è®¾ç½®å…¨å±€ä½¿ç”¨ rebase æ¨¡å¼ã€‚</p>
</li>
</ul>
<p>push</p>
<ul>
<li><code>git push</code> å‘½ä»¤é»˜è®¤åªæ¨é€<strong>å½“å‰åˆ†æ”¯</strong>åˆ°è¿œç¨‹å¯¹åº”çš„åˆ†æ”¯ã€‚</li>
</ul>
<p>å‡ ç§ <code>git push</code> çš„è¡Œä¸ºï¼š</p>
<ul>
<li>
<p><strong><code>git push</code> (ä¸å¸¦ä»»ä½•å‚æ•°):</strong>  æ¨é€å½“å‰åˆ†æ”¯åˆ°å…¶upstreamåˆ†æ”¯ã€‚å¦‚æœå½“å‰åˆ†æ”¯æ²¡æœ‰è®¾ç½®upstreamåˆ†æ”¯ï¼Œä¼šæŠ¥é”™ã€‚  è¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚</p>
</li>
<li>
<p><strong><code>git push &lt;remote&gt;</code>:</strong> æ¨é€å½“å‰åˆ†æ”¯åˆ°æŒ‡å®šè¿œç¨‹ä»“åº“ <code>&lt;remote&gt;</code> çš„åŒååˆ†æ”¯ã€‚ä¾‹å¦‚ <code>git push origin</code> ä¼šå°†å½“å‰åˆ†æ”¯æ¨é€åˆ°åä¸º <code>origin</code> çš„è¿œç¨‹ä»“åº“çš„åŒååˆ†æ”¯ã€‚</p>
</li>
<li>
<p><strong><code>git push &lt;remote&gt; &lt;branch&gt;</code>:</strong> å°†æœ¬åœ° <code>&lt;branch&gt;</code> åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ <code>&lt;remote&gt;</code> çš„ <code>&lt;branch&gt;</code> åˆ†æ”¯ã€‚ä¾‹å¦‚ <code>git push origin develop</code> ä¼šå°†æœ¬åœ°çš„ <code>develop</code> åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ <code>origin</code> çš„ <code>develop</code> åˆ†æ”¯ã€‚</p>
</li>
<li>
<p><strong><code>git push &lt;remote&gt; &lt;local_branch&gt;:&lt;remote_branch&gt;</code>:</strong> å°†æœ¬åœ° <code>&lt;local_branch&gt;</code> åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ <code>&lt;remote&gt;</code> çš„ <code>&lt;remote_branch&gt;</code> åˆ†æ”¯ã€‚ è¿™å…è®¸ä½ å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹çš„ä¸åŒååˆ†æ”¯ã€‚ä¾‹å¦‚ <code>git push origin feature/new-login:develop</code> ä¼šå°†æœ¬åœ°çš„ <code>feature/new-login</code> åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ <code>origin</code> çš„ <code>develop</code> åˆ†æ”¯ã€‚</p>
</li>
<li>
<p><strong><code>git push &lt;remote&gt; --all</code>:</strong> æ¨é€æ‰€æœ‰æœ¬åœ°åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ <code>&lt;remote&gt;</code>ã€‚</p>
</li>
<li>
<p><strong><code>git push &lt;remote&gt; --tags</code>:</strong>  æ¨é€æ‰€æœ‰æœ¬åœ°æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“ <code>&lt;remote&gt;</code>ã€‚</p>
</li>
</ul>
<h2 id="bashé€šé…ç¬¦">bashé€šé…ç¬¦</h2>
<p>?è¡¨ç¤ºå•ä¸ªå­—ç¬¦ï¼Œ*è¡¨ç¤ºä»»æ„ä¸ªå­—ç¬¦ï¼Œ[abc]è¡¨ç¤ºåŒ¹é…abcä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦ï¼Œ{a,b,c}è¡¨ç¤ºåŒ¹é…aæˆ–bæˆ–c</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ls [ab].txt</span><br><span class="line">a.txt b.txt</span><br><span class="line"></span><br><span class="line">$ ls *[ab].txt</span><br><span class="line">ab.txt a.txt b.txt</span><br><span class="line"></span><br><span class="line">$ echo d&#123;a,e,i,u,o&#125;g</span><br><span class="line">dag deg dig dug dog</span><br></pre></td></tr></table></figure>
<h2 id="gcc">gcc</h2>
<p>hello.c -é¢„å¤„ç† -E-&gt; hello.i -ç¼–è¯‘ -S-&gt; hello.s -æ±‡ç¼– -c-&gt; hello.o -é“¾æ¥ -&gt; hello</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc  main.cpp hello.cpp factorial.cpp -o hello</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨gcc å°†å¤šä¸ªæ–‡ä»¶ <strong>ç”Ÿæˆ</strong> ä¸º helloå¯æ‰§è¡Œæ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	gcc test.c</span><br><span class="line">	å°† test.c é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–å¹¶é“¾æ¥å½¢æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™é‡ŒæœªæŒ‡å®šè¾“å‡ºæ–‡ä»¶ï¼Œé»˜è®¤è¾“å‡ºä¸º a.outã€‚</span><br><span class="line"></span><br><span class="line">-oï¼šæŒ‡å®šç”Ÿæˆçš„è¾“å‡ºæ–‡ä»¶ï¼›</span><br><span class="line">	gcc test.c -o test</span><br><span class="line">	å°† test.c é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–å¹¶é“¾æ¥å½¢æˆå¯æ‰§è¡Œæ–‡ä»¶ testã€‚-o é€‰é¡¹ç”¨æ¥æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„æ–‡ä»¶åã€‚</span><br><span class="line">	</span><br><span class="line">-Eï¼šä»…æ‰§è¡Œç¼–è¯‘é¢„å¤„ç†ï¼›</span><br><span class="line">	gcc -E test.c -o test.i</span><br><span class="line">	å°† test.c é¢„å¤„ç†è¾“å‡º test.i æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">-Sï¼šå°†Cä»£ç è½¬æ¢ä¸ºæ±‡ç¼–ä»£ç ï¼›</span><br><span class="line">	gcc -S test.i</span><br><span class="line">	å°†é¢„å¤„ç†è¾“å‡ºæ–‡ä»¶ test.i æ±‡ç¼–æˆ test.s æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">-wallï¼šæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼›</span><br><span class="line"></span><br><span class="line">-cï¼šä»…æ‰§è¡Œç¼–è¯‘æ“ä½œï¼Œä¸è¿›è¡Œè¿æ¥æ“ä½œã€‚</span><br><span class="line">	gcc -c test.s</span><br><span class="line">	å°†æ±‡ç¼–è¾“å‡ºæ–‡ä»¶ test.s ç¼–è¯‘è¾“å‡º test.o æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">-lï¼šç”¨æ¥æŒ‡å®šç¨‹åºè¦é“¾æ¥çš„åº“ï¼Œ-lå‚æ•°ç´§æ¥ç€å°±æ˜¯åº“å</span><br><span class="line"></span><br><span class="line">-Iï¼šå¯»æ‰¾å¤´æ–‡ä»¶çš„ç›®å½•</span><br></pre></td></tr></table></figure>
<h2 id="Makefile">Makefile</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make main</span><br><span class="line">make -f config.txt //æŒ‡å®šmakefileæ–‡ä»¶</span><br><span class="line">make --file=config.txt</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨MakeæŒ‡ä»¤æ‰§è¡ŒMakefileæ–‡ä»¶(makeæŒ‡ä»¤è‡ªåŠ¨å¯»æ‰¾å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„Makefileæ–‡ä»¶)</p>
<p>Makefileæ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;target&gt; : &lt;prerequisites&gt;	//ç›®æ ‡ï¼Œå‰ç½®æ¡ä»¶</span><br><span class="line">[tab] &lt;commands&gt;	//å‘½ä»¤</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.PHONY: clean	//å£°æ˜ç›®æ ‡cleanä¸ºä¼ªç›®æ ‡</span><br><span class="line">clean:</span><br><span class="line">    rm -rf *.o</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ä¸€ä¸ªç®€å•çš„å®ä¾‹</span><br><span class="line">main:main.o fun0.o fun1.o fun2.0	</span><br><span class="line">	gcc -o main main.o fun0.o fun1.o fun2.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ä¸€ä¸ªå¤æ‚çš„å®ä¾‹</span><br><span class="line"># Define required macros here</span><br><span class="line">SHELL = /bin/sh		//å®å®šä¹‰</span><br><span class="line">OBJS =  main.o factorial.o hello.o</span><br><span class="line">CFLAG = -Wall -g</span><br><span class="line">CC = gcc</span><br><span class="line">INCLUDE =</span><br><span class="line">LIBS = -lm</span><br><span class="line">hello:$&#123;OBJ&#125;	//$&#123;&#125;è¡¨ç¤ºå˜é‡</span><br><span class="line">   $&#123;CC&#125; $&#123;CFLAGS&#125; $&#123;INCLUDES&#125; -o $@ $&#123;OBJS&#125; $&#123;LIBS&#125;</span><br><span class="line">clean:</span><br><span class="line">   -rm -f *.o core *.core	//ç±»ä¼¼äºbash,?è¡¨ç¤ºå•ä¸ªå­—ç¬¦ï¼Œ*è¡¨ç¤ºä»»æ„ä¸ªå­—ç¬¦ï¼Œ[abc]è¡¨ç¤ºåŒ¹é…abcä¸­ä»»æ„ä¸ªå­—ç¬¦ï¼Œ&#123;a,b,c&#125;è¡¨ç¤ºåŒ¹é…aæˆ–bæˆ–c</span><br><span class="line">.cpp.o:</span><br><span class="line">   $&#123;CC&#125; $&#123;CFLAGS&#125; $&#123;INCLUDES&#125; -c</span><br></pre></td></tr></table></figure>
<p>å†’å·å·¦ä¾§ï¼šç›®æ ‡æ–‡ä»¶</p>
<p>å†’å·å³ä¾§ï¼šè¢«ä¾èµ–æ–‡ä»¶ï¼Œå‰ç½®æ¡ä»¶</p>
<p>å‰ç½®æ¡ä»¶å†³å®š â€œç›®æ ‡â€ æ˜¯å¦éœ€è¦é‡æ–°æ„å»ºã€‚åªè¦å‰ç½®æ¡ä»¶ä¸­åˆ—å‡ºçš„æ–‡ä»¶ä¸­ï¼Œæœ‰ä»»ä½•ä¸€ä¸ªæ–‡ä»¶è¢«æ›´æ–°ï¼ˆå³å‰ç½®æ¡ä»¶åˆ—å‡ºçš„æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´æ¯”ç›®æ ‡çš„æœ€åä¿®æ”¹æ—¶é—´æ–°ï¼‰ï¼Œæˆ–è€… â€œç›®æ ‡â€ ä¸å­˜åœ¨ï¼Œé‚£ â€œç›®æ ‡â€ å°±éœ€è¦é‡æ–°æ„å»ºã€‚</p>
<p>å¦‚æœå‰ç½®æ¡ä»¶ä¸­åˆ—å‡ºçš„æ–‡ä»¶ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆ Make å°±éœ€è¦åœ¨ Makefile æ–‡ä»¶ä¸­å¯»æ‰¾å¹¶æ‰§è¡Œèƒ½å¤Ÿç”Ÿæˆè¯¥æ–‡ä»¶çš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´ç¼ºå¤±æ–‡ä»¶æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª â€œç›®æ ‡â€ï¼Œéœ€è¦å…ˆå°†è¯¥ â€œç›®æ ‡â€ æ„å»ºå‡ºæ¥æ‰èƒ½åˆ©ç”¨å®ƒå»æ„å»ºå½“å‰ â€œç›®æ ‡â€ï¼ˆæ„å»º A æ—¶å‘ç° A éœ€è¦ä¾èµ– Bï¼Œæ‰€ä»¥è¦å…ˆæ„å»º B æ‰èƒ½ç»§ç»­æ„å»º Aï¼Œç®€ç§°é€’å½’ç”Ÿæˆä¾èµ–ï¼‰ã€‚</p>
<p><code>$@</code>ï¼Œ<code>$^</code>ï¼Œ<code>$&lt;</code> è¿™ç§ç¬¦å·ï¼Œè¿™ç§ç¬¦å·ç§°ä¸ºè‡ªåŠ¨å˜é‡ã€‚è‡ªåŠ¨å˜é‡æ˜¯å±€éƒ¨å˜é‡ï¼Œä½œç”¨åŸŸèŒƒå›´åœ¨å½“å‰çš„è§„åˆ™å†…ï¼ˆå³è‡ªåŠ¨åŒ–å˜é‡åªåº”è¯¥å‡ºç°åœ¨ Makefile ç›®æ ‡è§„åˆ™ä¸­ï¼‰</p>
<p><code>$@</code> æŒ‡ä»£å½“å‰ç›®æ ‡ï¼Œ Make å‘½ä»¤æ„å›¾æ„å»ºçš„ç›®æ ‡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hello: hello.o</span><br><span class="line">    gcc hello.o -o $@	//$@ä¸ºhello</span><br></pre></td></tr></table></figure>
<p><code>$&lt;</code> æŒ‡ä»£ç¬¬ä¸€ä¸ªå‰ç½®æ¡ä»¶ã€‚æ¯”å¦‚è§„åˆ™ä¸º hello: a bï¼Œé‚£ä¹ˆ <code>$&lt;</code> å°±æŒ‡ä»£ aã€‚</p>
<p><code>$^</code> æŒ‡ä»£æ‰€æœ‰å‰ç½®æ¡ä»¶ï¼Œä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ã€‚æ¯”å¦‚ï¼Œè§„åˆ™ä¸º hello: a bï¼Œé‚£ä¹ˆ <code>$^</code> å°±æŒ‡ä»£ a å’Œ bã€‚</p>
]]></content>
      <tags>
        <tag>Python, Bash, C</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¬¬ä¸€ç¯‡åšå®¢</title>
    <url>/2024/04/11/first_post/</url>
    <content><![CDATA[<p>å†™ä¸€ä¸ªæµ‹è¯•è¯•ä¸€ä¸‹</p>
<p>æ•°å­¦å…¬å¼æµ‹è¯•ï¼š$r_n=W_n\log_2\left(1+\frac{P_nd_n^{-\beta}h_n^2}{N_0+I_n}\right)$</p>
<p>$$t_n^{loc}=\frac{(1-\rho_n)C_n}{f_n}$$</p>
]]></content>
  </entry>
  <entry>
    <title>Project</title>
    <url>/2025/02/19/Project/</url>
    <content><![CDATA[<p>Project &amp; related</p>
<span id="more"></span>
<h1>Project</h1>
<h2 id="E-Shop">E-Shop</h2>
<h3 id="è´£ä»»é“¾æ¨¡å¼">è´£ä»»é“¾æ¨¡å¼</h3>
<br>
<h3 id="ç§’æ€åœºæ™¯">ç§’æ€åœºæ™¯</h3>
<p>é‡‡ç”¨é¢„å–-ç¼“å†²æ± æ€è·¯</p>
<ul>
<li>åœ¨ç§’æ€ä¸šåŠ¡å¼€å¯å‰ï¼Œå¤šåœ°çš„Redisé¢„å…ˆä»æ•°æ®åº“ä¸­æ‰£é™¤ä¸€å®šé‡çš„åº“å­˜ï¼Œä¿å­˜åœ¨Redisä¸­ï¼Œ<strong>ä¿®æ”¹æ•°æ®åº“å€¼</strong></li>
<li>æ¯ä¸ªserviceè¿›è¡Œç§’æ€æ—¶ï¼Œä½¿ç”¨Luaè„šæœ¬åŸå­çš„æ‰£é™¤æœ¬åœ°Redisçš„åº“å­˜ï¼Œ<strong>ä¸æ¶‰åŠæ•°æ®åº“è®¿é—®</strong></li>
<li>ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼‰æ¯ä¸ªserviceè€ƒè™‘é¢„å…ˆä»æœ¬åœ°Redisä¸­å–å‡ºä¸€å®šé‡çš„åº“å­˜ï¼Œè¿›è¡Œæœ¬åœ°åŸå­æ‰£é™¤ï¼›è‹¥æœ¬åœ°ç¼“å­˜ä¸å¤Ÿï¼ŒåŸå­çš„ä»æœ¬åœ°Redisä¸­å–å‡ºä¸€å®šé‡çš„åº“å­˜ï¼›</li>
<li>ç§’æ€æµé‡ä¸‹é™åï¼ˆè€ƒè™‘ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—æ–¹å¼å®ç°å»¶æ—¶ä»»åŠ¡ï¼‰ï¼Œå¤šåœ°çš„Redisè¿”è¿˜æ•°æ®åº“åº“å­˜ï¼Œ<strong>ä¿®æ”¹æ•°æ®åº“å€¼</strong></li>
</ul>
<br>
<p>luaè„šæœ¬</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">-- KEYS[1]: åº“å­˜ Key (seckill:stock:&#123;å•†å“ID&#125;)</span></span><br><span class="line"><span class="comment">-- KEYS[2]: ç”¨æˆ·è´­ä¹°è®°å½• Key (seckill:user:&#123;ç”¨æˆ·ID&#125;:&#123;å•†å“ID&#125;)</span></span><br><span class="line"><span class="comment">-- ARGV[1]: ç”¨æˆ· ID</span></span><br><span class="line"><span class="comment">-- ARGV[2]: å•†å“ ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–åº“å­˜</span></span><br><span class="line"><span class="keyword">local</span> stock = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>])) <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ£€æŸ¥åº“å­˜æ˜¯å¦å¤§äº 0</span></span><br><span class="line"><span class="keyword">if</span> stock &lt;= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> <span class="comment">-- åº“å­˜ä¸è¶³</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°</span></span><br><span class="line"><span class="keyword">local</span> purchased = redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">if</span> purchased <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span> <span class="comment">-- ç”¨æˆ·å·²è´­ä¹°</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ‰£å‡åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;DECR&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ ‡è®°ç”¨æˆ·å·²è´­ä¹°</span></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[<span class="number">2</span>], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿”å›æˆåŠŸ</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<br>
<h2 id="ShortLink">ShortLink</h2>
<p>åˆ›æ–°ç‚¹</p>
<ol>
<li>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥åˆ¤æ–­çŸ­é“¾æ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œæé«˜äº†åˆ¤æ–­æ•ˆç‡ï¼Œè¿œèƒœäºä½¿ç”¨åˆ†å¸ƒå¼é”æ­é…æŸ¥è¯¢æ•°æ®åº“çš„æ–¹æ¡ˆã€‚</li>
<li>å€ŸåŠ© RocketMQ æ¶ˆæ¯é˜Ÿåˆ—çš„&quot;å‰Šå³°&quot;ç‰¹ç‚¹ï¼Œå®ç°æµ·é‡è®¿é—®çŸ­é“¾æ¥åœºæ™¯ä¸‹çš„ç›‘æ§ä¿¡æ¯å­˜å‚¨åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹ä»èƒ½æ­£å¸¸è¿è¡Œã€‚</li>
<li>ä¼˜åŒ–æ›´æ–°æˆ–å¤±æ•ˆåœºæ™¯ä¸‹å¤§é‡è¯·æ±‚æŸ¥è¯¢æ•°æ®åº“é—®é¢˜ï¼Œå°è£…ç¼“å­˜ä¸å­˜åœ¨è¯»å–åŠŸèƒ½ï¼Œé‡‡ç”¨åˆ†å¸ƒå¼é”äº’æ–¥ç­–ç•¥ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„é¢‘ç¹æŸ¥è¯¢ã€‚</li>
<li>ä¸ºä¿éšœçŸ­é“¾æ¥ç¼“å­˜ä¸æ•°æ®åº“ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œé‡‡ç”¨äº†é€šè¿‡æ›´æ–°æ•°æ®åº“åˆ é™¤ç¼“å­˜çš„ç­–ç•¥ï¼Œä¿è¯äº†ä¸¤è€…ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚</li>
<li>åœ¨æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä½¿ç”¨ Redis æ¥å®Œæˆå¹‚ç­‰åœºæ™¯çš„å¤„ç†ï¼Œç¡®ä¿æ¶ˆæ¯åœ¨ä¸€å®šæ—¶é—´å†…ä»…è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œé¿å…é‡å¤å¤„ç†ã€‚</li>
<li>ä¸ºå®ç°çŸ­é“¾æ¥åœ¨æµ·é‡è®¿é—®åœºæ™¯ä¸‹çš„æ•°æ®ä¿®æ”¹åŠŸèƒ½ï¼Œæˆ‘ä½¿ç”¨äº† Redisson åˆ†å¸ƒå¼è¯»å†™é”ï¼Œç¡®ä¿æ•°æ®ä¿®æ”¹çš„å®‰å…¨å’Œä¸€è‡´æ€§ã€‚</li>
<li>è€ƒè™‘å…¼å®¹çŸ­é“¾æ¥ç”¨æˆ·éœ€æ±‚ï¼ŒçŸ­é“¾æ¥æ•°æ®åˆ†ç‰‡çš„åŸºç¡€ä¸Šå¢åŠ äº†è·¯ç”±è¡¨ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ–¹ä¾¿åœ°åˆ†é¡µæŸ¥çœ‹çŸ­é“¾æ¥ã€‚</li>
<li>ä½¿ç”¨ Sentinel è¿›è¡Œæ¥å£è®¿é—®çš„ QPS é™æµï¼Œä»¥ä¿éšœçŸ­é“¾æ¥ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œã€‚å½“è§¦å‘é™æµè§„åˆ™æ—¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œé™çº§å¤„ç†ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§ã€‚</li>
</ol>
<br>
<h3 id="åç«¯æ•æ„Ÿä¿¡æ¯è¿”å›">åç«¯æ•æ„Ÿä¿¡æ¯è¿”å›</h3>
<p>æ–¹æ¡ˆä¸€ï¼š</p>
<p>ä½¿ç”¨Spring AOPå¯¹è¿”å›ä¿¡æ¯è¿‡æ»¤</p>
<p>æ–¹æ¡ˆäºŒï¼š</p>
<p>é€šè¿‡Jsonåºåˆ—åŒ–ï¼Œåœ¨Springè¿”å›å¯¹è±¡çš„åºåˆ—åŒ–ç»“æœæ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨è¿›è¡Œåºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneDesensitizationSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(String phone, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneDesensitization</span> <span class="operator">=</span> DesensitizedUtil.mobilePhone(phone);</span><br><span class="line">        jsonGenerator.writeString(phoneDesensitization);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonSerialize(using = PhoneDesensitizationSerializer.class)</span></span><br><span class="line"><span class="keyword">private</span> String phone;</span><br></pre></td></tr></table></figure>
<br>
<br>
<h3 id="ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡ä¿å­˜">ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡ä¿å­˜</h3>
<p>è‡ªå®šä¹‰ Servlet å®¹å™¨ Filter è¿‡æ»¤å™¨ï¼Œä½¿ç”¨ThreadLocalä¿å­˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿‡æ»¤å™¨å®ç°ä»è¯·æ±‚ä¸­æˆªå–ç”¨æˆ·åå¹¶åˆ›å»ºå¯¹è±¡ä¿å­˜åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalå¯¹è±¡ä¸­</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTransmitFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(username)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">realName</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;realName&quot;</span>);</span><br><span class="line">            <span class="type">UserInfoDTO</span> <span class="variable">userInfoDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfoDTO</span>(userId, username, realName);</span><br><span class="line">            UserContext.setUser(userInfoDTO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            UserContext.removeUser(); <span class="comment">// ç§»é™¤ThreadLocalå¯¹è±¡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šä¸‹æ–‡ä¿å­˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;https://github.com/alibaba/transmittable-thread-local&quot; /&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;UserInfoDTO&gt; USER_THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®ç”¨æˆ·è‡³ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user ç”¨æˆ·è¯¦æƒ…ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setUser</span><span class="params">(UserInfoDTO user)</span> &#123;</span><br><span class="line">        USER_THREAD_LOCAL.set(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="æµé‡æ§åˆ¶">æµé‡æ§åˆ¶</h3>
<p>ä¾‹å¦‚ï¼Œ1ç§’ä¸­å…è®¸è¯·æ±‚æœ€å¤š x æ¬¡</p>
<p>é€šè¿‡ Redis <code>increment</code> å‘½ä»¤å¯¹ ä¸ç”¨æˆ·åæ˜ å°„çš„æ•°æ® è¿›è¡Œé€’å¢ï¼Œè¶…è¿‡ x æ¬¡å°±ä¼šè¿”å›å¤±è´¥ï¼›è¯¥æ•°æ®æœ‰æ•ˆæœŸä¸º 1 ç§’</p>
<br>
<h3 id="å¸ƒéš†è¿‡æ»¤å™¨çš„ä½¿ç”¨ä¸è¯¯åˆ¤">å¸ƒéš†è¿‡æ»¤å™¨çš„ä½¿ç”¨ä¸è¯¯åˆ¤</h3>
<p>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨</p>
<p>ä½å›¾ + å¤šä¸ªæ•£åˆ—å‡½æ•°</p>
<p>ä¾‹å¦‚</p>
<img src="/2025/02/19/Project/image-20250219124534631.png" class="" title="image-20250219124534631">
<br>
<p>å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è¯¯åˆ¤æƒ…å†µ</p>
<p><strong>ç›®æ ‡ä¸å­˜åœ¨ï¼Œåˆ¤å®šä¸ºå­˜åœ¨</strong></p>
<blockquote>
<p>ä¸å¯èƒ½æƒ…å†µï¼šç›®æ ‡å­˜åœ¨ï¼Œåˆ¤å®šä¸ºä¸å­˜åœ¨</p>
<p>å¸ƒéš†è¿‡æ»¤å™¨ä¸èƒ½è¿›è¡Œåˆ é™¤å“¦</p>
</blockquote>
<p>å³ å¸ƒéš†è¿‡æ»¤å™¨ ä¼šç»™å‡º</p>
<ul>
<li>ä¸å­˜åœ¨</li>
<li>å¯èƒ½å­˜åœ¨</li>
</ul>
<p>å› æ­¤ï¼Œ</p>
<p><strong>æŸ¥è¯¢æ—¶</strong>ï¼Œå…ˆé€šè¿‡å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ã€‚å‡é˜³æ€§å¯èƒ½å¯¼è‡´è¯¯æŸ¥è¯¢ï¼Œä½†ä¸ä¼šæ¼æ‰çœŸå®å­˜åœ¨çš„è®°å½•ã€‚</p>
<p><strong>æ’å…¥æ—¶</strong>ï¼Œå¸ƒéš†è¿‡æ»¤å™¨åº”è¯¥åœ¨æ•°æ®æ’å…¥æ•°æ®åº“ä¹‹åæ›´æ–°ï¼Œä»¥ä¿æŒä¸€è‡´æ€§ã€‚</p>
<p><strong>åˆ é™¤æ—¶</strong>ï¼Œåˆ é™¤æ“ä½œéœ€è¦è°¨æ…ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¸ç›´æ¥æ”¯æŒåˆ é™¤ï¼Œæ“ä½œæ•°æ®åº“ã€‚</p>
<p><strong>æ›´æ–°æ—¶</strong>ï¼Œå…ˆé€šè¿‡å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œç„¶åå†è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ä¸å¸ƒéš†æ›´æ–°ã€‚</p>
<br>
<h3 id="çŸ­é“¾ä¿¡æ¯ç»Ÿè®¡">çŸ­é“¾ä¿¡æ¯ç»Ÿè®¡</h3>
<p>ç›¸åŒçš„ç”¨æˆ·å¤šæ¬¡è®¿é—®ç›¸åŒçŸ­é“¾æ¥ï¼Œä½¿ç”¨Cookieè®°å½•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ShortLinkStatsRecordDTO <span class="title function_">buildLinkStatsRecordAndSetUser</span><span class="params">(String fullShortUrl, ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">AtomicBoolean</span> <span class="variable">uvFirstFlag</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>();</span><br><span class="line">        Cookie[] cookies = ((HttpServletRequest) request).getCookies();</span><br><span class="line">        AtomicReference&lt;String&gt; uv = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€ä¸ª Runnable ä»»åŠ¡ addResponseCookieTaskï¼Œç”¨äºæ·»åŠ å“åº” Cookie å¹¶å¤„ç†é¦–æ¬¡è®¿é—®çš„é€»è¾‘</span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">addResponseCookieTask</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            uv.set(UUID.fastUUID().toString());</span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">uvCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;uv&quot;</span>, uv.get());</span><br><span class="line">            uvCookie.setMaxAge(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>);</span><br><span class="line">            <span class="comment">// è®¾ç½® Cookie çš„è·¯å¾„ã€‚ä» fullShortUrl ä¸­æˆªå–ç¬¬ä¸€ä¸ª &#x27;/&#x27; ä¹‹åçš„éƒ¨åˆ†ä½œä¸ºè·¯å¾„ã€‚</span></span><br><span class="line">            <span class="comment">// æ¯”å¦‚ fullShortUrl æ˜¯ &quot;http://example.com/s/xyz&quot;ï¼Œé‚£ä¹ˆè·¯å¾„å°±æ˜¯ &quot;/s/xyz&quot;</span></span><br><span class="line">            uvCookie.setPath(StrUtil.sub(fullShortUrl, fullShortUrl.indexOf(<span class="string">&quot;/&quot;</span>), fullShortUrl.length()));</span><br><span class="line">            ((HttpServletResponse) response).addCookie(uvCookie);</span><br><span class="line">            <span class="comment">// è®¾ç½® uvFirstFlag ä¸º trueï¼Œè¡¨ç¤ºæ˜¯é¦–æ¬¡è®¿é—®</span></span><br><span class="line">            uvFirstFlag.set(Boolean.TRUE);</span><br><span class="line">            <span class="comment">// å°†ç”¨æˆ·æ ‡è¯†ç¬¦ uv æ·»åŠ åˆ° Redis Set ä¸­ï¼Œç”¨äºç»Ÿè®¡ç‹¬ç«‹è®¿å®¢ï¼ˆUVï¼‰ã€‚</span></span><br><span class="line">            <span class="comment">// Key æ˜¯ SHORT_LINK_STATS_UV_KEY + fullShortUrlã€‚</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(SHORT_LINK_STATS_UV_KEY + fullShortUrl, uv.get());</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦å­˜åœ¨ Cookie</span></span><br><span class="line">        <span class="keyword">if</span> (ArrayUtil.isNotEmpty(cookies)) &#123;</span><br><span class="line">            Arrays.stream(cookies)</span><br><span class="line">                    .filter(each -&gt; Objects.equals(each.getName(), <span class="string">&quot;uv&quot;</span>))</span><br><span class="line">                    .findFirst()</span><br><span class="line">                    .map(Cookie::getValue)</span><br><span class="line">                    <span class="comment">// å¦‚æœå­˜åœ¨åä¸º &quot;uv&quot; çš„ Cookieï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</span></span><br><span class="line">                    .ifPresentOrElse(each -&gt; &#123;</span><br><span class="line">                        <span class="comment">// å°† Cookie çš„å€¼ï¼ˆå³å·²æœ‰çš„ç”¨æˆ·æ ‡è¯†ç¬¦ï¼‰è®¾ç½®åˆ° uv ä¸­</span></span><br><span class="line">                        uv.set(each);</span><br><span class="line">                        <span class="comment">// å°è¯•å°†ç”¨æˆ·æ ‡è¯†ç¬¦æ·»åŠ åˆ° Redis Set ä¸­ã€‚</span></span><br><span class="line">                        <span class="comment">//  stringRedisTemplate.opsForSet().add() è¿”å›ä¸€ä¸ª Long å€¼ï¼š</span></span><br><span class="line">                        <span class="comment">//  - å¦‚æœæ·»åŠ æˆåŠŸï¼ˆå³è¯¥å€¼ä¹‹å‰ä¸å­˜åœ¨äº Set ä¸­ï¼‰ï¼Œåˆ™è¿”å› 1ã€‚</span></span><br><span class="line">                        <span class="comment">//  - å¦‚æœæ·»åŠ å¤±è´¥ï¼ˆå³è¯¥å€¼å·²å­˜åœ¨äº Set ä¸­ï¼‰ï¼Œåˆ™è¿”å› 0ã€‚</span></span><br><span class="line">                        <span class="comment">//  - å¦‚æœå‡ºç°é”™è¯¯ï¼Œå¯èƒ½è¿”å› nullã€‚</span></span><br><span class="line">                        <span class="type">Long</span> <span class="variable">uvAdded</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().add(SHORT_LINK_STATS_UV_KEY + fullShortUrl, each);</span><br><span class="line">                        <span class="comment">// è®¾ç½® uvFirstFlagã€‚å¦‚æœ uvAdded ä¸ä¸º null ä¸”å¤§äº 0ï¼Œåˆ™è¡¨ç¤ºæ˜¯é¦–æ¬¡è®¿é—®ï¼Œè®¾ç½®ä¸º trueï¼›å¦åˆ™ä¸º falseã€‚</span></span><br><span class="line">                        uvFirstFlag.set(uvAdded != <span class="literal">null</span> &amp;&amp; uvAdded &gt; <span class="number">0L</span>);</span><br><span class="line">                    &#125;, addResponseCookieTask); <span class="comment">// å¦‚æœä¸å­˜åœ¨åä¸º &quot;uv&quot; çš„ Cookieï¼Œåˆ™æ‰§è¡Œ addResponseCookieTaskï¼ˆå³åˆ›å»ºæ–°çš„ UV å¹¶æ·»åŠ åˆ°å“åº”ä¸­ï¼‰</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addResponseCookieTask.run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteAddr</span> <span class="operator">=</span> LinkUtil.getActualIp(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> LinkUtil.getOs(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">browser</span> <span class="operator">=</span> LinkUtil.getBrowser(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">device</span> <span class="operator">=</span> LinkUtil.getDevice(((HttpServletRequest) request));</span><br><span class="line">        <span class="type">String</span> <span class="variable">network</span> <span class="operator">=</span> LinkUtil.getNetwork(((HttpServletRequest) request));</span><br><span class="line">        <span class="comment">// å°è¯•å°†è®¿é—®è€…çš„ IP åœ°å€æ·»åŠ åˆ° Redis Set ä¸­ï¼ŒSHORT_LINK_STATS_UIP_KEY + fullShortUrl ä¸º Keyï¼ŒUnique IP ä¸º Value</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">uipAdded</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().add(SHORT_LINK_STATS_UIP_KEY + fullShortUrl, remoteAddr);</span><br><span class="line">        <span class="comment">// å¦‚æœ Redis Set ä¸­å·²ç»å­˜åœ¨è¯¥ IP åœ°å€ï¼Œåˆ™ uipAdded ä¸º null æˆ– 0ï¼Œå¦åˆ™ä¸ºæ–°åŠ å…¥çš„ IP åœ°å€æ•°é‡ (1)ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–° IP</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uipFirstFlag</span> <span class="operator">=</span> uipAdded != <span class="literal">null</span> &amp;&amp; uipAdded &gt; <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ShortLinkStatsRecordDTO.builder()</span><br><span class="line">                .fullShortUrl(fullShortUrl)</span><br><span class="line">                .uv(uv.get())</span><br><span class="line">                .uvFirstFlag(uvFirstFlag.get())</span><br><span class="line">                .uipFirstFlag(uipFirstFlag)</span><br><span class="line">                .remoteAddr(remoteAddr)</span><br><span class="line">                .os(os)</span><br><span class="line">                .browser(browser)</span><br><span class="line">                .device(device)</span><br><span class="line">                .network(network)</span><br><span class="line">                .currentDate(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<br>
<h3 id="ç¼“å­˜å‡»ç©¿é˜²æŠ¤">ç¼“å­˜å‡»ç©¿é˜²æŠ¤</h3>
<p>ç¼“å­˜è¿‡æœŸæ—¶é—´å·¥å…·ç±»ï¼š</p>
<p>1.å¦‚æœdateè¶…è¿‡å½“å‰æ—¶é—´ä¸€å‘¨ï¼Œé‚£ä¹ˆè®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºä¸€å‘¨ï¼Œå¹¶éšæœºä¸€ä¸ª0~24å°æ—¶çš„æ—¶é—´</p>
<p>2.å¦‚æœdateæ²¡æœ‰è¶…è¿‡å½“å‰æ—¶é—´ä¸€å‘¨ï¼Œé‚£ä¹ˆè®¾ç½®æŒ‡å®šçš„æ—¶é—´</p>
<p>3.å¦‚æœdateä¸ºnullï¼Œåˆ™è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºä¸€å‘¨ï¼Œå¹¶éšæœºä¸€ä¸ª0~24å°æ—¶çš„æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ONE_WEEK_MILLIS</span> <span class="operator">=</span> <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>; </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* è·å–çŸ­é“¾æ¥ç¼“å­˜è¿‡æœŸæ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> date æ—¥æœŸ </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> çŸ­é“¾æ¥ç¼“å­˜è¿‡æœŸæ—¶é—´æˆ³ </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getShortLinkCacheTime</span><span class="params">(Date date)</span> &#123;    </span><br><span class="line">    <span class="comment">// å½“å‰æ—¶é—´    </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();     </span><br><span class="line">    <span class="comment">// å¦‚æœ date ä¸º nullï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸ºä¸€å‘¨åçš„æ—¶é—´æˆ³ï¼Œå¹¶éšæœºä¸€ä¸ª 0 ~ 24 å°æ—¶çš„æ—¶é—´    </span></span><br><span class="line">    <span class="keyword">if</span> (date == <span class="literal">null</span>) &#123;        </span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        calendar.add(Calendar.DAY_OF_MONTH, <span class="number">7</span>);        </span><br><span class="line">        <span class="keyword">return</span> calendar.getTimeInMillis() + ThreadLocalRandom.current().nextLong(<span class="number">0</span>, <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>);    </span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="type">long</span> <span class="variable">dateMillis</span> <span class="operator">=</span> date.getTime();     <span class="comment">// æ£€æŸ¥ date æ˜¯å¦è¶…è¿‡ä¸€å‘¨    </span></span><br><span class="line">    <span class="keyword">if</span> (dateMillis - currentTimeMillis &gt; ONE_WEEK_MILLIS) &#123;        </span><br><span class="line">        <span class="comment">// å¦‚æœè¶…è¿‡ä¸€å‘¨ï¼Œé‚£ä¹ˆå°†æœ‰æ•ˆæ—¶é—´è®¾ç½®åœ¨ä¸€å‘¨å        </span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        calendar.add(Calendar.DAY_OF_MONTH, <span class="number">7</span>);        </span><br><span class="line">        <span class="keyword">return</span> calendar.getTimeInMillis() + ThreadLocalRandom.current().nextLong(<span class="number">0</span>, <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>);    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;        </span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰è¶…è¿‡ä¸€å‘¨ï¼Œåˆ™è®¾ç½®ä¸º date çš„æ—¶é—´æˆ³        </span></span><br><span class="line">        <span class="keyword">return</span> dateMillis;    </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="ç¼“å­˜ç©¿é€é˜²æŠ¤">ç¼“å­˜ç©¿é€é˜²æŠ¤</h3>
<p>redis ä¿å­˜ æ— æ•ˆçŸ­é“¾æ¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">gotoIsNullShortLink</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl));  <span class="comment">// ä»redisä¸­è·å–è¯¥çŸ­é“¾æ¥æ˜¯å¦è¢«æ ‡è®°ä¸ºnullã€‚ ç”¨äºé˜²æ­¢ç¼“å­˜å‡»ç©¿ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(gotoIsNullShortLink)) &#123; <span class="comment">// å¦‚æœredisä¸­å­˜åœ¨è¯¥çŸ­é“¾è¢«æ ‡è®°ä¸ºnullã€‚</span></span><br><span class="line">((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>); <span class="comment">// å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸€ä¸ª &quot;notfound&quot; é¡µé¢ï¼Œè¡¨ç¤ºè¯¥çŸ­é“¾æ¥URLæ— æ•ˆã€‚</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="æ¶ˆæ¯é˜Ÿåˆ—æ›´æ–°æ•°æ®åº“">æ¶ˆæ¯é˜Ÿåˆ—æ›´æ–°æ•°æ®åº“</h3>
<br>
<br>
<h3 id="æµç¨‹">æµç¨‹</h3>
<h4 id="çŸ­é“¾ç”Ÿæˆæµç¨‹">çŸ­é“¾ç”Ÿæˆæµç¨‹</h4>
<img src="/2025/02/19/Project/71DF4D3AC7166BD8DE046102F534D4EB.png" class="" title="71DF4D3AC7166BD8DE046102F534D4EB">
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ShortLinkCreateRespDTO <span class="title function_">createShortLink</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    verificationWhitelist(requestParam.getOriginUrl());</span><br><span class="line">    <span class="type">String</span> <span class="variable">shortLinkSuffix</span> <span class="operator">=</span> generateSuffix(requestParam);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullShortUrl</span> <span class="operator">=</span> StrBuilder.create(createShortLinkDefaultDomain)</span><br><span class="line">        .append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">        .append(shortLinkSuffix)</span><br><span class="line">        .toString();</span><br><span class="line">    <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">        .domain(createShortLinkDefaultDomain)</span><br><span class="line">        .originUrl(requestParam.getOriginUrl())</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .createdType(requestParam.getCreatedType())</span><br><span class="line">        .validDateType(requestParam.getValidDateType())</span><br><span class="line">        .validDate(requestParam.getValidDate())</span><br><span class="line">        .describe(requestParam.getDescribe())</span><br><span class="line">        .shortUri(shortLinkSuffix)</span><br><span class="line">        .enableStatus(<span class="number">0</span>)</span><br><span class="line">        .totalPv(<span class="number">0</span>)</span><br><span class="line">        .totalUv(<span class="number">0</span>)</span><br><span class="line">        .totalUip(<span class="number">0</span>)</span><br><span class="line">        .delTime(<span class="number">0L</span>)</span><br><span class="line">        .fullShortUrl(fullShortUrl)</span><br><span class="line">        .favicon(getFavicon(requestParam.getOriginUrl()))</span><br><span class="line">        .build();</span><br><span class="line">    <span class="type">ShortLinkGotoDO</span> <span class="variable">linkGotoDO</span> <span class="operator">=</span> ShortLinkGotoDO.builder()</span><br><span class="line">        .fullShortUrl(fullShortUrl)</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        baseMapper.insert(shortLinkDO);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DuplicateKeyException ex) &#123;</span><br><span class="line">        <span class="comment">// åŠ å…¥æ•°æ®åº“å¤±è´¥ï¼Œæ•°æ®åº“å·²å­˜åœ¨é‡å¤çŸ­é“¾</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­å¸ƒéš†ä¸­æ˜¯å¦å­˜åœ¨è¯¥çŸ­é“¾ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ </span></span><br><span class="line">        <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(fullShortUrl)) &#123;</span><br><span class="line">            shortUriCreateCachePenetrationBloomFilter.add(fullShortUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(String.format(<span class="string">&quot;çŸ­é“¾æ¥ï¼š%s ç”Ÿæˆé‡å¤&quot;</span>, fullShortUrl));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†çŸ­é“¾-åŸé“¾åŠ å…¥Redis_ex</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(</span><br><span class="line">        String.format(GOTO_SHORT_LINK_KEY, fullShortUrl),</span><br><span class="line">        requestParam.getOriginUrl(),</span><br><span class="line">        LinkUtil.getLinkCacheValidTime(requestParam.getValidDate()), TimeUnit.MILLISECONDS</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// å°†çŸ­é“¾åŠ å…¥å¸ƒéš†</span></span><br><span class="line">    shortUriCreateCachePenetrationBloomFilter.add(fullShortUrl);</span><br><span class="line">    <span class="keyword">return</span> ShortLinkCreateRespDTO.builder()</span><br><span class="line">        .fullShortUrl(<span class="string">&quot;http://&quot;</span> + shortLinkDO.getFullShortUrl())</span><br><span class="line">        .originUrl(requestParam.getOriginUrl())</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ShortLinkCreateRespDTO <span class="title function_">createShortLinkByLock</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    verificationWhitelist(requestParam.getOriginUrl());</span><br><span class="line">    String fullShortUrl;</span><br><span class="line">    <span class="comment">// åˆ†å¸ƒå¼é”åˆ›å»ºçŸ­é“¾æ¥</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(SHORT_LINK_CREATE_LOCK_KEY);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shortLinkSuffix</span> <span class="operator">=</span> generateSuffixByLock(requestParam);</span><br><span class="line">        fullShortUrl = StrBuilder.create(createShortLinkDefaultDomain)</span><br><span class="line">            .append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">            .append(shortLinkSuffix)</span><br><span class="line">            .toString();</span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">            .domain(createShortLinkDefaultDomain)</span><br><span class="line">            .originUrl(requestParam.getOriginUrl())</span><br><span class="line">            .gid(requestParam.getGid())</span><br><span class="line">            .createdType(requestParam.getCreatedType())</span><br><span class="line">            .validDateType(requestParam.getValidDateType())</span><br><span class="line">            .validDate(requestParam.getValidDate())</span><br><span class="line">            .describe(requestParam.getDescribe())</span><br><span class="line">            .shortUri(shortLinkSuffix)</span><br><span class="line">            .enableStatus(<span class="number">0</span>)</span><br><span class="line">            .totalPv(<span class="number">0</span>)</span><br><span class="line">            .totalUv(<span class="number">0</span>)</span><br><span class="line">            .totalUip(<span class="number">0</span>)</span><br><span class="line">            .delTime(<span class="number">0L</span>)</span><br><span class="line">            .fullShortUrl(fullShortUrl)</span><br><span class="line">            .favicon(getFavicon(requestParam.getOriginUrl()))</span><br><span class="line">            .build();</span><br><span class="line">        <span class="type">ShortLinkGotoDO</span> <span class="variable">linkGotoDO</span> <span class="operator">=</span> ShortLinkGotoDO.builder()</span><br><span class="line">            .fullShortUrl(fullShortUrl)</span><br><span class="line">            .gid(requestParam.getGid())</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            baseMapper.insert(shortLinkDO);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(String.format(<span class="string">&quot;çŸ­é“¾æ¥ï¼š%s ç”Ÿæˆé‡å¤&quot;</span>, fullShortUrl));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(</span><br><span class="line">            String.format(GOTO_SHORT_LINK_KEY, fullShortUrl),</span><br><span class="line">            requestParam.getOriginUrl(),</span><br><span class="line">            LinkUtil.getLinkCacheValidTime(requestParam.getValidDate()), TimeUnit.MILLISECONDS</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(fullShortUrl)) &#123;</span><br><span class="line">            shortUriCreateCachePenetrationBloomFilter.add(fullShortUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ShortLinkCreateRespDTO.builder()</span><br><span class="line">        .fullShortUrl(<span class="string">&quot;http://&quot;</span> + fullShortUrl)</span><br><span class="line">        .originUrl(requestParam.getOriginUrl())</span><br><span class="line">        .gid(requestParam.getGid())</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸åŠ é”åˆ›å»ºçŸ­é“¾åç¼€</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">generateSuffix</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">customGenerateCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    String shorUri;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (customGenerateCount &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;çŸ­é“¾æ¥é¢‘ç¹ç”Ÿæˆï¼Œè¯·ç¨åå†è¯•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">originUrl</span> <span class="operator">=</span> requestParam.getOriginUrl();</span><br><span class="line">        originUrl += UUID.randomUUID().toString();  <span class="comment">// åŸé“¾ + éšæœºæ•° </span></span><br><span class="line">        shorUri = HashUtil.hashToBase62(originUrl); <span class="comment">// åŸé“¾ + éšæœºæ•° -&gt; çŸ­é“¾</span></span><br><span class="line">        <span class="comment">// å…ˆæŸ¥å¸ƒéš†ï¼Œè‹¥å¯èƒ½å­˜åœ¨ç›´æ¥ä¸‹ä¸€è½®</span></span><br><span class="line">        <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(createShortLinkDefaultDomain + <span class="string">&quot;/&quot;</span> + shorUri)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        customGenerateCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shorUri;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// åŠ é”åˆ›å»ºçŸ­é“¾åç¼€</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">generateSuffixByLock</span><span class="params">(ShortLinkCreateReqDTO requestParam)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">customGenerateCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    String shorUri;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (customGenerateCount &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;çŸ­é“¾æ¥é¢‘ç¹ç”Ÿæˆï¼Œè¯·ç¨åå†è¯•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">originUrl</span> <span class="operator">=</span> requestParam.getOriginUrl();</span><br><span class="line">        originUrl += UUID.randomUUID().toString();</span><br><span class="line">        shorUri = HashUtil.hashToBase62(originUrl);</span><br><span class="line">        LambdaQueryWrapper&lt;ShortLinkDO&gt; queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)</span><br><span class="line">            .eq(ShortLinkDO::getGid, requestParam.getGid())</span><br><span class="line">            .eq(ShortLinkDO::getFullShortUrl, createShortLinkDefaultDomain + <span class="string">&quot;/&quot;</span> + shorUri)</span><br><span class="line">            .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>);</span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper);  <span class="comment">// æŸ¥æ•°æ®åº“çœ‹æ–°ç”ŸæˆçŸ­é“¾æ˜¯å¦å·²å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (shortLinkDO == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        customGenerateCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shorUri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ä¼˜åŒ–">ä¼˜åŒ–</h5>
<p>ä½¿ç”¨ä¸‰çº§é€šé“æŠ€æœ¯</p>
<p>å‚è€ƒäº¬ä¸œ <a href="https://juejin.cn/post/7382344353068974115#heading-12">https://juejin.cn/post/7382344353068974115#heading-12</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortLinkGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY</span> <span class="operator">=</span> <span class="string">&quot;shortlink_counter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BATCH_SIZE</span> <span class="operator">=</span> <span class="number">10000</span>;  <span class="comment">// æ¯æ¬¡ä»å†…å­˜ç”Ÿæˆ10000ä¸ªçŸ­ç </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ID_LENGTH</span> <span class="operator">=</span> <span class="number">62</span>;   <span class="comment">// çŸ­ç çš„åŸºæ•°ï¼Œ62è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ID_RANGE</span> <span class="operator">=</span> <span class="number">99999</span>;  <span class="comment">// æœ€å¤§çš„5ä½æ•°èŒƒå›´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALPHABET</span> <span class="operator">=</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Jedis jedis; <span class="comment">// Rediså®¢æˆ·ç«¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger memoryCounter; <span class="comment">// å†…å­˜è®¡æ•°å™¨ï¼Œç”¨äºè‡ªå¢</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”ŸæˆçŸ­é“¾çŸ­ç </span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateShortLink</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> getNextId();</span><br><span class="line">        <span class="keyword">return</span> idToShortLink(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å†…å­˜è·å–è‡ªå¢IDï¼Œå¦‚æœå†…å­˜å·²ç”¨å®Œåˆ™ä»Rediså–å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getNextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> getFromMemory();</span><br><span class="line">        <span class="keyword">if</span> (id == -<span class="number">1</span>) &#123; <span class="comment">// å¦‚æœå†…å­˜å·æ®µç”¨å®Œï¼Œå»Redisè·å–</span></span><br><span class="line">            id = getFromRedis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å†…å­˜ä¸­è·å–ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getFromMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨AtomicIntegeræ¥è¿›è¡Œè‡ªå¢ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> memoryCounter.get();</span><br><span class="line">        <span class="keyword">if</span> (current &gt;= BATCH_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// å†…å­˜å·æ®µç”¨å®Œï¼Œè¿”å›-1è¡¨ç¤ºéœ€è¦ä»Redisè·å–æ–°çš„å·æ®µ</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> memoryCounter.incrementAndGet(); <span class="comment">// åŸå­æ€§åœ°è‡ªå¢</span></span><br><span class="line">            <span class="keyword">return</span> current + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»Redisä¸­è·å–è‡ªå¢ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getFromRedis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">newId</span> <span class="operator">=</span> jedis.incrBy(REDIS_KEY, BATCH_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (newId &gt; MAX_ID_RANGE) &#123;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(SHORT_LINK_CREATE_LOCK_KEY);</span><br><span class="line">        	lock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                jedis.set(REDIS_KEY, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="comment">// é‡æ–°è·å–ID</span></span><br><span class="line">                newId = jedis.incr(REDIS_KEY);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// æ›´æ–°å†…å­˜è®¡æ•°å™¨ï¼Œä¿è¯æ¯æ¬¡å†…å­˜è‡ªå¢æ—¶ï¼ŒRediså·æ®µè¢«å®Œå…¨æ¶ˆè€—å‰ä¸ä¼šé‡æ–°è·å–</span></span><br><span class="line">        memoryCounter.set(<span class="number">0</span>); <span class="comment">// é‡ç½®å†…å­˜è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">return</span> newId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†IDè½¬æ¢ä¸º62è¿›åˆ¶çŸ­ç </span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">idToShortLink</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">shortLink</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">while</span> (id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            shortLink.append(ALPHABET.charAt((<span class="type">int</span>) (id % MAX_ID_LENGTH)));</span><br><span class="line">            id /= MAX_ID_LENGTH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shortLink.reverse().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<br>
<br>
<h4 id="çŸ­é“¾æ›´æ–°æµç¨‹">çŸ­é“¾æ›´æ–°æµç¨‹</h4>
<img src="/2025/02/19/Project/E68452CA74D6142357E95AD499697CFB.png" class="" title="E68452CA74D6142357E95AD499697CFB">
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateShortLink</span><span class="params">(ShortLinkUpdateReqDTO requestParam)</span> &#123;</span><br><span class="line">    verificationWhitelist(requestParam.getOriginUrl());</span><br><span class="line">    <span class="keyword">if</span> (!shortUriCreateCachePenetrationBloomFilter.contains(requestParam.getFullShortUrl())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;çŸ­é“¾æ¥è®°å½•ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LambdaQueryWrapper&lt;ShortLinkDO&gt; queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)</span><br><span class="line">        .eq(ShortLinkDO::getGid, requestParam.getOriginGid())</span><br><span class="line">        .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">        .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">        .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>);</span><br><span class="line">    <span class="type">ShortLinkDO</span> <span class="variable">hasShortLinkDO</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper); <span class="comment">// æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">if</span> (hasShortLinkDO == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;çŸ­é“¾æ¥è®°å½•ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(hasShortLinkDO.getGid(), requestParam.getGid())) &#123; <span class="comment">// å¦‚æœæ›´æ–°å‰å gid ç›¸åŒï¼Œå³æ›´æ–°ä¸æ¢ç»„ï¼Œç›´æ¥æ›´æ–°çŸ­é“¾æ¥çš„å±æ€§</span></span><br><span class="line">        LambdaUpdateWrapper&lt;ShortLinkDO&gt; updateWrapper = Wrappers.lambdaUpdate(ShortLinkDO.class) <span class="comment">// æ„å»ºæ›´æ–°æ“ä½œçš„æ¡ä»¶</span></span><br><span class="line">            .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">            .eq(ShortLinkDO::getGid, requestParam.getGid())</span><br><span class="line">            .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">            .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>)</span><br><span class="line">            .set(Objects.equals(requestParam.getValidDateType(), VailDateTypeEnum.PERMANENT.getType()), ShortLinkDO::getValidDate, <span class="literal">null</span>); <span class="comment">// å¦‚æœè¯·æ±‚å‚æ•°ä¸­çš„ æœ‰æ•ˆæœŸç±»å‹ ä¸º æ°¸ä¹…ï¼Œè®¾ç½®DOå¯¹è±¡çš„ æœ‰æ•ˆæœŸ ä¸ºnull</span></span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder() <span class="comment">// æ‰§è¡Œæ›´æ–°æ“ä½œ</span></span><br><span class="line">            .domain(hasShortLinkDO.getDomain())</span><br><span class="line">            .shortUri(hasShortLinkDO.getShortUri())</span><br><span class="line">            .favicon(Objects.equals(requestParam.getOriginUrl(), hasShortLinkDO.getOriginUrl()) ? hasShortLinkDO.getFavicon() : getFavicon(requestParam.getOriginUrl())) <span class="comment">// è¯·æ±‚å‚æ•°ä¸­çš„ é•¿é“¾æ¥ å’Œ å½“å‰é•¿é“¾æ¥ æ˜¯å¦ä¸€è‡´ï¼Ÿä¸ä¸€è‡´åˆ™æ›´æ¢</span></span><br><span class="line">            .createdType(hasShortLinkDO.getCreatedType())</span><br><span class="line">            .gid(requestParam.getGid())  <span class="comment">// æ¢ç»„</span></span><br><span class="line">            .originUrl(requestParam.getOriginUrl())  <span class="comment">// æ¢é•¿é“¾æ¥</span></span><br><span class="line">            .describe(requestParam.getDescribe())   <span class="comment">// æ¢æè¿°</span></span><br><span class="line">            .validDateType(requestParam.getValidDateType())  <span class="comment">// æ¢æœ‰æ•ˆç±»å‹</span></span><br><span class="line">            .validDate(requestParam.getValidDate())  <span class="comment">// æ¢æœ‰æ•ˆæœŸ</span></span><br><span class="line">            .build();</span><br><span class="line">        baseMapper.update(shortLinkDO, updateWrapper);  <span class="comment">// ä½¿ç”¨DOå¯¹è±¡å¯¹æ•°æ®åº“è¿›è¡Œæ›´æ–°ï¼›æ›´æ–°æ—¶åŒ…å«é€»è¾‘ï¼šå¦‚æœè¯·æ±‚å‚æ•°çš„æœ‰æ•ˆç±»å‹ä¸ºæ°¸ä¹…ï¼Œåˆ™å°†æœ‰æ•ˆæœŸç½®ä¸ºnull</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// æ›´æ–°æ¢ç»„</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ Redisson åˆ†å¸ƒå¼è¯»å†™é”ç¡®ä¿å¹¶å‘å®‰å…¨ã€‚</span></span><br><span class="line">        <span class="type">RReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(String.format(LOCK_GID_UPDATE_KEY, requestParam.getFullShortUrl()));</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> readWriteLock.writeLock();</span><br><span class="line">        rLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LambdaUpdateWrapper&lt;ShortLinkDO&gt; linkUpdateWrapper = Wrappers.lambdaUpdate(ShortLinkDO.class)</span><br><span class="line">                .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">                .eq(ShortLinkDO::getGid, hasShortLinkDO.getGid())</span><br><span class="line">                .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">                .eq(ShortLinkDO::getDelTime, <span class="number">0L</span>)</span><br><span class="line">                .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>);</span><br><span class="line">            <span class="type">ShortLinkDO</span> <span class="variable">delShortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">                .delTime(System.currentTimeMillis())</span><br><span class="line">                .build();</span><br><span class="line">            delShortLinkDO.setDelFlag(<span class="number">1</span>);</span><br><span class="line">            baseMapper.update(delShortLinkDO, linkUpdateWrapper);</span><br><span class="line">            <span class="comment">// å°†æ—§çš„çŸ­é“¾æ¥æ ‡è®°ä¸ºå·²åˆ é™¤ã€‚</span></span><br><span class="line">            <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> ShortLinkDO.builder()</span><br><span class="line">                .domain(createShortLinkDefaultDomain)</span><br><span class="line">                .originUrl(requestParam.getOriginUrl())</span><br><span class="line">                .gid(requestParam.getGid())</span><br><span class="line">                .createdType(hasShortLinkDO.getCreatedType())</span><br><span class="line">                .validDateType(requestParam.getValidDateType())</span><br><span class="line">                .validDate(requestParam.getValidDate())</span><br><span class="line">                .describe(requestParam.getDescribe())</span><br><span class="line">                .shortUri(hasShortLinkDO.getShortUri())</span><br><span class="line">                .enableStatus(hasShortLinkDO.getEnableStatus())</span><br><span class="line">                .totalPv(hasShortLinkDO.getTotalPv())</span><br><span class="line">                .totalUv(hasShortLinkDO.getTotalUv())</span><br><span class="line">                .totalUip(hasShortLinkDO.getTotalUip())</span><br><span class="line">                .fullShortUrl(hasShortLinkDO.getFullShortUrl())</span><br><span class="line">                .favicon(Objects.equals(requestParam.getOriginUrl(), hasShortLinkDO.getOriginUrl()) ? hasShortLinkDO.getFavicon() : getFavicon(requestParam.getOriginUrl()))</span><br><span class="line">                .delTime(<span class="number">0L</span>)</span><br><span class="line">                .build();</span><br><span class="line">            baseMapper.insert(shortLinkDO);</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„çŸ­é“¾æ¥è®°å½•ï¼Œå¹¶å°†æ–°çš„å±æ€§è®¾ç½®åˆ°æ–°è®°å½•ä¸­ã€‚</span></span><br><span class="line">            LambdaQueryWrapper&lt;ShortLinkGotoDO&gt; linkGotoQueryWrapper = Wrappers.lambdaQuery(ShortLinkGotoDO.class)</span><br><span class="line">                .eq(ShortLinkGotoDO::getFullShortUrl, requestParam.getFullShortUrl())</span><br><span class="line">                .eq(ShortLinkGotoDO::getGid, hasShortLinkDO.getGid());</span><br><span class="line">            <span class="type">ShortLinkGotoDO</span> <span class="variable">shortLinkGotoDO</span> <span class="operator">=</span> shortLinkGotoMapper.selectOne(linkGotoQueryWrapper);</span><br><span class="line">            <span class="comment">// æ›´æ–° ShortLinkGotoDO è¡¨ä¸­çš„ gid ä¿¡æ¯ã€‚</span></span><br><span class="line">            shortLinkGotoMapper.delete(linkGotoQueryWrapper);</span><br><span class="line">            shortLinkGotoDO.setGid(requestParam.getGid());</span><br><span class="line">            shortLinkGotoMapper.insert(shortLinkGotoDO);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœçŸ­é“¾æ¥çš„æœ‰æ•ˆæœŸç±»å‹ã€æœ‰æ•ˆæœŸæ—¶é—´æˆ–åŸå§‹ URL å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ¸…é™¤ GOTO_SHORT_LINK_KEY ç¼“å­˜ã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ—§çš„çŸ­é“¾æ¥å·²è¿‡æœŸï¼Œå¹¶ä¸”æ›´æ–°åçš„çŸ­é“¾æ¥æ˜¯æ°¸ä¹…æœ‰æ•ˆæˆ–è€…æ–°çš„æœ‰æ•ˆæœŸåœ¨å½“å‰æ—¶é—´ä¹‹åï¼Œåˆ™æ¸…é™¤ GOTO_IS_NULL_SHORT_LINK_KEY ç¼“å­˜ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(hasShortLinkDO.getValidDateType(), requestParam.getValidDateType())</span><br><span class="line">        || !Objects.equals(hasShortLinkDO.getValidDate(), requestParam.getValidDate())</span><br><span class="line">        || !Objects.equals(hasShortLinkDO.getOriginUrl(), requestParam.getOriginUrl())) &#123;</span><br><span class="line">        stringRedisTemplate.delete(String.format(GOTO_SHORT_LINK_KEY, requestParam.getFullShortUrl()));</span><br><span class="line">        <span class="type">Date</span> <span class="variable">currentDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="keyword">if</span> (hasShortLinkDO.getValidDate() != <span class="literal">null</span> &amp;&amp; hasShortLinkDO.getValidDate().before(currentDate)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(requestParam.getValidDateType(), VailDateTypeEnum.PERMANENT.getType()) || requestParam.getValidDate().after(currentDate)) &#123;</span><br><span class="line">                stringRedisTemplate.delete(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, requestParam.getFullShortUrl()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redis ä¸ æ•°æ®åº“ æ•°æ®ä¸€è‡´æ€§</p>
<p><strong>é‡‡ç”¨æ–¹æ¡ˆ 2ï¼šæ•°æ®åº“ä¼˜å…ˆï¼Œç¼“å­˜å»¶è¿Ÿæ›´æ–°</strong></p>
<p><strong>æµç¨‹ï¼š</strong></p>
<ul>
<li>ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®</li>
<li>æ•°æ®åº“å®Œæˆä¿®æ”¹åï¼Œåˆ é™¤redisä¸­æ•°æ®----ï¼ˆåˆ†ç•Œçº¿ï¼šæ­¤åŠ¨ä½œå‰åæŸ¥è¯¢åˆ°çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼‰</li>
<li>è®¿é—®rediså‘ç”Ÿç¼ºå¤±æ—¶ï¼Œè§¦å‘misså¹¶æŸ¥è¯¢æ•°æ®åº“æ–°æ•°æ®ï¼Œç„¶åå†™å…¥redis</li>
</ul>
<br>
<h4 id="çŸ­é“¾è§£ææµç¨‹">çŸ­é“¾è§£ææµç¨‹</h4>
<p>redis_ex - bloomFilter - redis_nx - MySQL</p>
<p>è¶…é«˜å¹¶å‘åœºæ™¯ï¼ï¼ï¼</p>
<img src="/2025/02/19/Project/5CF8B7418CDADCA4998A29C7F084CE08.png" class="" title="5CF8B7418CDADCA4998A29C7F084CE08">
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restoreUrl</span><span class="params">(String shortUri, ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serverName</span> <span class="operator">=</span> request.getServerName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">serverPort</span> <span class="operator">=</span> Optional.of(request.getServerPort())</span><br><span class="line">        .filter(each -&gt; !Objects.equals(each, <span class="number">80</span>))</span><br><span class="line">        .map(String::valueOf)</span><br><span class="line">        .map(each -&gt; <span class="string">&quot;:&quot;</span> + each)</span><br><span class="line">        .orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullShortUrl</span> <span class="operator">=</span> serverName + serverPort + <span class="string">&quot;/&quot;</span> + shortUri; <span class="comment">// ä»æŠ¥æ–‡ä¸­è¯»å‡ºçŸ­é“¾å†…å®¹</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">originalLink</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(String.format(GOTO_SHORT_LINK_KEY, fullShortUrl)); <span class="comment">// ä»redisè·å–åŸå§‹é“¾</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(originalLink)) &#123;</span><br><span class="line">        shortLinkStats(buildLinkStatsRecordAndSetUser(fullShortUrl, request, response)); <span class="comment">// è®°å½•çŸ­é“¾æ¥çš„è®¿é—®ç»Ÿè®¡ä¿¡æ¯ã€‚</span></span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(originalLink);  <span class="comment">// ä½¿ç”¨HttpServletResponseå¯¹è±¡å°†ç”¨æˆ·é‡å®šå‘åˆ°åŸå§‹é“¾æ¥URLã€‚  `sendRedirect` æ–¹æ³•ä¼šè®¾ç½® HTTP å“åº”çš„çŠ¶æ€ç ä¸º 302 (Found) æˆ– 301 (Moved Permanently)ï¼Œå¹¶åœ¨å“åº”å¤´ä¸­è®¾ç½® `Location` å­—æ®µä¸ºç›®æ ‡ URLã€‚</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">contains</span> <span class="operator">=</span> shortUriCreateCachePenetrationBloomFilter.contains(fullShortUrl); <span class="comment">// å¸ƒéš†åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (!contains) &#123;  <span class="comment">// çŸ­é“¾ä¸å­˜åœ¨</span></span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>); <span class="comment">// å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸€ä¸ª &quot;notfound&quot; é¡µé¢ï¼Œè¡¨ç¤ºè¯¥çŸ­é“¾æ¥URLæ— æ•ˆã€‚</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">gotoIsNullShortLink</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl));  <span class="comment">// ä»redisä¸­è·å–è¯¥çŸ­é“¾æ¥æ˜¯å¦è¢«æ ‡è®°ä¸ºnullã€‚ ç”¨äºé˜²æ­¢ç¼“å­˜å‡»ç©¿ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(gotoIsNullShortLink)) &#123; <span class="comment">// å¦‚æœredisä¸­å­˜åœ¨è¯¥çŸ­é“¾è¢«æ ‡è®°ä¸ºnullã€‚</span></span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>); <span class="comment">// å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸€ä¸ª &quot;notfound&quot; é¡µé¢ï¼Œè¡¨ç¤ºè¯¥çŸ­é“¾æ¥URLæ— æ•ˆã€‚</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(String.format(LOCK_GOTO_SHORT_LINK_KEY, fullShortUrl));</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦åšä¸¤éï¼Ÿ</span></span><br><span class="line">        <span class="comment">// å‡å¦‚ç”¨æˆ·aå’Œç”¨æˆ·bå‡è®¿é—®çŸ­é“¾xï¼ŒçŸ­é“¾ä»…å­˜åœ¨äºæ•°æ®åº“ï¼ˆredisä¸­ä¸å­˜åœ¨ï¼Œç¼“å­˜ç©¿é€æ£€æŸ¥ä¸ä¸ºç©ºï¼‰ï¼›æ­¤æ—¶ç”¨æˆ·aè·å¾—é”ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­æŸ¥åˆ°ä¿¡æ¯å¹¶ä¿å­˜åˆ°rediså’Œå¸ƒéš†ï¼›ç”¨æˆ·bè·å¾—é”è¿›å…¥ï¼Œæ­¤æ—¶rediså·²åŒ…å«è¯¥é“¾æ¥</span></span><br><span class="line">        originalLink = stringRedisTemplate.opsForValue().get(String.format(GOTO_SHORT_LINK_KEY, fullShortUrl));</span><br><span class="line">        <span class="comment">//   å†æ¬¡å°è¯•ä»Redisä¸­è·å–åŸå§‹é“¾æ¥URLã€‚  è¿™ä¸€æ­¥æ˜¯ä¸ºäº†é˜²æ­¢åœ¨è·å–é”ä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹å·²ç»å°†åŸå§‹é“¾æ¥URLæ”¾å…¥äº†Redisä¸­ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(originalLink)) &#123;</span><br><span class="line">            shortLinkStats(buildLinkStatsRecordAndSetUser(fullShortUrl, request, response));</span><br><span class="line">            ((HttpServletResponse) response).sendRedirect(originalLink);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        gotoIsNullShortLink = stringRedisTemplate.opsForValue().get(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl));</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(gotoIsNullShortLink)) &#123;</span><br><span class="line">            ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŸ¥è¡¨è·å–çŸ­é“¾æ˜ å°„åŸé“¾</span></span><br><span class="line">        LambdaQueryWrapper&lt;ShortLinkDO&gt; queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)</span><br><span class="line">            .eq(ShortLinkDO::getGid, shortLinkGotoDO.getGid())</span><br><span class="line">            .eq(ShortLinkDO::getFullShortUrl, fullShortUrl)</span><br><span class="line">            .eq(ShortLinkDO::getDelFlag, <span class="number">0</span>)</span><br><span class="line">            .eq(ShortLinkDO::getEnableStatus, <span class="number">0</span>);</span><br><span class="line">        <span class="type">ShortLinkDO</span> <span class="variable">shortLinkDO</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (shortLinkDO == <span class="literal">null</span> || (shortLinkDO.getValidDate() != <span class="literal">null</span> &amp;&amp; shortLinkDO.getValidDate().before(<span class="keyword">new</span> <span class="title class_">Date</span>()))) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(String.format(GOTO_IS_NULL_SHORT_LINK_KEY, fullShortUrl), <span class="string">&quot;-&quot;</span>, <span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">            <span class="comment">// å°†è¯¥çŸ­é“¾æ¥URLæ ‡è®°ä¸ºnullï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨Redisä¸­ï¼Œæœ‰æ•ˆæœŸä¸º30åˆ†é’Ÿã€‚</span></span><br><span class="line">            ((HttpServletResponse) response).sendRedirect(<span class="string">&quot;/page/notfound&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿å­˜çŸ­é“¾-åŸé“¾ åˆ° redis_ex</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set( <span class="comment">// å°†åŸå§‹é“¾æ¥URLå­˜å‚¨åœ¨Redisä¸­ï¼Œå¹¶è®¾ç½®æœ‰æ•ˆæœŸã€‚</span></span><br><span class="line">            String.format(GOTO_SHORT_LINK_KEY, fullShortUrl),</span><br><span class="line">            shortLinkDO.getOriginUrl(),</span><br><span class="line">            LinkUtil.getLinkCacheValidTime(shortLinkDO.getValidDate()), TimeUnit.MILLISECONDS</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—æ›´æ–°çŸ­é“¾è®¿é—®ä¿¡æ¯</span></span><br><span class="line">        shortLinkStats(buildLinkStatsRecordAndSetUser(fullShortUrl, request, response));</span><br><span class="line">        ((HttpServletResponse) response).sendRedirect(shortLinkDO.getOriginUrl());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµç¨‹</p>
<ul>
<li>
<p>æ£€æŸ¥redis_exï¼ˆå†…å­˜èŒƒå›´ï¼‰ï¼›å­˜åœ¨ç›´æ¥è¿”å›ï¼Œä¸å­˜åœ¨è¿›å…¥ä¸‹ä¸€æ­¥ï¼›</p>
</li>
<li>
<p>bloomåˆ¤æ–­çŸ­é“¾æ¥æ˜¯å¦å­˜åœ¨ï¼ˆæ•°æ®åº“èŒƒå›´ï¼‰ï¼Œä¸å­˜åœ¨ç›´æ¥è¿”å›ï¼Œå¯èƒ½å­˜åœ¨è¿›å…¥ä¸‹ä¸€æ­¥ï¼›</p>
</li>
<li>
<p>æ£€æŸ¥redis_nxï¼Œå­˜åœ¨ç›´æ¥è¿”å›ï¼Œä¸å­˜åœ¨è¿›å…¥ä¸‹ä¸€æ­¥ï¼›</p>
</li>
<li>
<p>å¼€å¯åˆ†å¸ƒå¼é”</p>
<ul>
<li>
<p>äºŒæ¬¡æ£€æŸ¥ redis_ex å’Œ redis_nx æ˜¯å¦å­˜åœ¨</p>
</li>
<li>
<p>æŸ¥è¯¢æ•°æ®åº“</p>
<ul>
<li>æŸ¥è¯¢è¡¨ï¼Œè‹¥ä¸å­˜åœ¨æˆ–å¤±æ•ˆæ·»åŠ  redis_nxï¼Œè¿”å›ï¼›è‹¥å­˜åœ¨è¿›å…¥ä¸‹ä¸€æ­¥</li>
<li>å°†æŸ¥è¯¢ç»“æœåŠ å…¥ redis_ex</li>
</ul>
</li>
<li>
<p>å°†ç»Ÿè®¡çŠ¶æ€ä¿¡æ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—</p>
</li>
</ul>
</li>
</ul>
<br>
<p>Rediså†…å®¹</p>
<ul>
<li>å¸ƒéš†è¿‡æ»¤å™¨</li>
<li>redis_nxï¼ˆkey: <code>short-link:is-null:goto_&#123;fullShortUrl&#125;</code>, value: <code>-</code>ï¼‰</li>
<li>redis_exï¼ˆkey: <code>short-link:goto:&#123;fullShortUrl&#125;</code>, value: <code>originUrl</code>ï¼‰</li>
</ul>
<br>
<p>Q: ä¸ºä»€ä¹ˆéœ€è¦åšäºŒæ¬¡æ£€æŸ¥ï¼Ÿ</p>
<p>è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p>
<p>åœºæ™¯1ï¼šç”Ÿæˆçš„çŸ­é“¾é•¿æ—¶é—´æœªè¢«ä½¿ç”¨ï¼ˆredis_exå†…çŸ­é“¾æ˜ å°„è¿‡æœŸï¼‰ï¼Œç¬¬ä¸€æ¬¡è®¿é—®</p>
<p>å‡å¦‚ç”¨æˆ·aå’Œç”¨æˆ·bå‡è®¿é—®çŸ­é“¾xï¼ŒçŸ­é“¾ä»…å­˜åœ¨äºæ•°æ®åº“ï¼ˆredis_exä¸å­˜åœ¨ï¼Œredis_nxä¸å­˜åœ¨ï¼‰ï¼›æ­¤æ—¶ç”¨æˆ·aè·å¾—é”ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­æŸ¥åˆ°ä¿¡æ¯å¹¶ä¿å­˜åˆ°rediså’ŒBloomFilterï¼›ç”¨æˆ·bè·å¾—é”è¿›å…¥ï¼Œæ­¤æ—¶rediså·²åŒ…å«è¯¥é“¾æ¥ï¼Œåº”å½“ç›´æ¥è¿”å›ï¼Œä¸å†æŸ¥æ•°æ®åº“ï¼›</p>
<p>åœºæ™¯2ï¼šæ— æ•ˆçŸ­é“¾ï¼Œç¬¬ä¸€æ¬¡è®¿é—®</p>
<p>å‡å¦‚ç”¨æˆ·aå’Œç”¨æˆ·bå‡è®¿é—®çŸ­é“¾xï¼ŒçŸ­é“¾å­˜åœ¨äºæ•°æ®åº“ä¸”è¿‡æœŸï¼ˆredis_exä¸å­˜åœ¨ï¼Œredis_nxä¸å­˜åœ¨ï¼‰ï¼›æ­¤æ—¶ç”¨æˆ·aè·å¾—é”ï¼Œåœ¨æ•°æ®åº“ä¸­ä¸èƒ½æŸ¥åˆ°ä¿¡æ¯ï¼Œä¿å­˜åˆ° redis_nxï¼›ç”¨æˆ·bè·å¾—é”è¿›å…¥ï¼Œæ­¤æ—¶ redis_nx å·²æŒ‡å‡ºè¯¥é“¾æ¥æ— æ•ˆï¼Œåº”å½“ç›´æ¥è¿”å›ï¼Œä¸å†æŸ¥æ•°æ®åº“ï¼›</p>
<br>
<h4 id="çŸ­é“¾çŠ¶æ€ä¿¡æ¯æ›´æ–°æµç¨‹">çŸ­é“¾çŠ¶æ€ä¿¡æ¯æ›´æ–°æµç¨‹</h4>
<br>
<h4 id="å¯èƒ½åœºæ™¯åˆ†æ">å¯èƒ½åœºæ™¯åˆ†æ</h4>
<img src="/2025/02/19/Project/0CE3A54805CB047FA700CFDE30A643BA.png" class="" title="0CE3A54805CB047FA700CFDE30A643BA">
<br>
<h2 id="Feedæµ">Feedæµ</h2>
<img src="/2025/02/19/Project/njjbtvfwn2.png" class="" title="img">
<p>è¯»æ‰©æ•£ï¼ˆæ‹‰æ¨¡å¼ï¼‰ï¼šç²‰ä¸å»å‘å¸ƒè€…çš„å‘ä»¶ç®±æ‹‰å–å†…å®¹</p>
<p>å†™æ‰©æ•£ï¼ˆæ¨æ¨¡å¼ï¼‰ï¼šå‘å¸ƒè€…å‘ç²‰ä¸çš„æ”¶ä»¶ç®±æ¨é€å†…å®¹</p>
<p>è¯»å†™æ··åˆï¼šå¦‚å›¾</p>
<br>
<p>æ¨æ–¹æ³•ï¼š</p>
<p>å‘å¸ƒè€… å‘å¸ƒå†…å®¹ ä¿å­˜åˆ°mysql + redis</p>
<p>æ¯ä¸ªç”¨æˆ·æœ‰ä¸€ä¸ªå¯¹åº”çš„Redisé˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨ä»–ä»¬çš„åŠ¨æ€ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Redisçš„LPUSHï¼ˆåˆ—è¡¨æ“ä½œï¼‰å‘½ä»¤å°†æ–°çš„å†…å®¹æ¨é€åˆ°ç”¨æˆ·çš„feedæµé˜Ÿåˆ—ã€‚</p>
<p>ç”¨æˆ·ä¸Šçº¿åä»è‡ªå·±çš„Redisé˜Ÿåˆ—è·å– RRANGE æ•°æ®</p>
<p>ä¼˜åŒ–</p>
<p>ä½¿ç”¨Redis Pipelineè¿›è¡Œæ‰¹é‡å†™å…¥</p>
<p>å°†å†…å®¹æ¨é€æ“ä½œæ”¾åˆ°åå°å¼‚æ­¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åŒæ­¥å®Œæˆã€‚è¿™å¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚RabbitMQã€Kafkaï¼‰æ¥å®ç°ï¼Œåå°æ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†æ¨é€ä»»åŠ¡ã€‚ é‡‡ç”¨å»¶è¿Ÿå†™å…¥ç­–ç•¥ã€‚å¯ä»¥è®¾ç½®ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—æˆ–è€…åˆ©ç”¨Redisçš„Sorted Setæ¥å®ç°ã€‚åœ¨æ–°åŠ¨æ€å‘å¸ƒæ—¶ï¼ŒåŠ¨æ€å†…å®¹å…ˆè¿›å…¥ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—ï¼Œç³»ç»Ÿå®šæœŸï¼ˆä¾‹å¦‚æ¯åˆ†é’Ÿï¼‰å†æ‰¹é‡å°†å†…å®¹æ¨é€åˆ°ç”¨æˆ·çš„feedæµã€‚</p>
<p>å®ç°æ–¹å¼ï¼š ä½¿ç”¨Redisçš„ZADDå‘½ä»¤å°†æ¶ˆæ¯æŒ‰ç…§æ—¶é—´æˆ³å­˜å…¥ä¸€ä¸ªæœ‰åºé›†åˆï¼Œç„¶åå®šæœŸä»æœ‰åºé›†åˆä¸­å–å‡ºå¹¶æ¨é€ã€‚</p>
<br>
<p>å‘ä»¶ç®±</p>
<p>sender_id, message_id, other</p>
<p>æ”¶ä»¶ç®±</p>
<p>(receiver_id, sequence_id,) sender_id, message_id, other</p>
<br>
<h2 id="AI-RAG">AI RAG</h2>
<h3 id="Base">Base</h3>
<p>Meta AI çš„ç ”ç©¶äººå‘˜å¼•å…¥äº†ä¸€ç§å«åšæ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval Augmented Generationï¼ŒRAGï¼‰çš„æ–¹æ³•æ¥å®Œæˆè¿™ç±»çŸ¥è¯†å¯†é›†å‹çš„ä»»åŠ¡ã€‚RAG æŠŠä¸€ä¸ªä¿¡æ¯æ£€ç´¢ç»„ä»¶å’Œæ–‡æœ¬ç”Ÿæˆæ¨¡å‹ç»“åˆåœ¨ä¸€èµ·ã€‚RAG å¯ä»¥å¾®è°ƒï¼Œå…¶å†…éƒ¨çŸ¥è¯†çš„ä¿®æ”¹æ–¹å¼å¾ˆé«˜æ•ˆï¼Œä¸éœ€è¦å¯¹æ•´ä¸ªæ¨¡å‹è¿›è¡Œé‡æ–°è®­ç»ƒã€‚</p>
<br>
<p>RAG ä¼šæ¥å—è¾“å…¥å¹¶æ£€ç´¢å‡ºä¸€ç»„ç›¸å…³/æ”¯æ’‘çš„æ–‡æ¡£ï¼Œå¹¶ç»™å‡ºæ–‡æ¡£çš„æ¥æºï¼ˆä¾‹å¦‚ç»´åŸºç™¾ç§‘ï¼‰ã€‚è¿™äº›æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡å’Œè¾“å…¥çš„åŸå§‹æç¤ºè¯ç»„åˆï¼Œé€ç»™æ–‡æœ¬ç”Ÿæˆå™¨å¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚è¿™æ · RAG æ›´åŠ é€‚åº”äº‹å®ä¼šéšæ—¶é—´å˜åŒ–çš„æƒ…å†µã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸º LLM çš„å‚æ•°åŒ–çŸ¥è¯†æ˜¯é™æ€çš„ã€‚RAG è®©è¯­è¨€æ¨¡å‹ä¸ç”¨é‡æ–°è®­ç»ƒå°±èƒ½å¤Ÿè·å–æœ€æ–°çš„ä¿¡æ¯ï¼ŒåŸºäºæ£€ç´¢ç”Ÿæˆäº§ç”Ÿå¯é çš„è¾“å‡ºã€‚</p>
<br>
<p>Lewis ç­‰äººï¼ˆ2021ï¼‰æå‡ºä¸€ä¸ªé€šç”¨çš„ RAG å¾®è°ƒæ–¹æ³•ã€‚è¿™ç§æ–¹æ³•ä½¿ç”¨é¢„è®­ç»ƒçš„ seq2seq ä½œä¸ºå‚æ•°è®°å¿†ï¼Œç”¨ç»´åŸºç™¾ç§‘çš„å¯†é›†å‘é‡ç´¢å¼•ä½œä¸ºéå‚æ•°è®°å¿†ï¼ˆä½¿é€šè¿‡ç¥ç»ç½‘ç»œé¢„è®­ç»ƒçš„æ£€ç´¢å™¨è®¿é—®ï¼‰</p>
<img src="/2025/02/19/Project/FnuC7iOSLJbLu9apUaP886tm7eGD" class="" title="ai-rag-knowledge-1-01.png">
<p>å‘é‡æ•°æ®åº“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;doc123&quot;,               // å”¯ä¸€æ ‡è¯†ç¬¦</span><br><span class="line">    &quot;embedding&quot;: [0.1, 0.2, ...], // å‘é‡</span><br><span class="line">    &quot;text&quot;: &quot;ç‹å¤§ç“œï¼Œ1990å¹´å‡ºç”Ÿ&quot;, // åŸå§‹æ–‡æœ¬</span><br><span class="line">    &quot;metadata&quot;: &#123;                 // å…ƒæ•°æ®</span><br><span class="line">        &quot;knowledge&quot;: &quot;çŸ¥è¯†åº“åç§°&quot;,</span><br><span class="line">        &quot;timestamp&quot;: &quot;2023-10-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>
<h3 id="è®¿é—®é€»è¾‘">è®¿é—®é€»è¾‘</h3>
<p>æ‰§è¡Œ</p>
<ul>
<li>
<p>åŠ è½½åŸå§‹æ–‡æ¡£</p>
</li>
<li>
<p>ä½¿ç”¨SentenceSplitteråˆ†å‰²æ–‡æ¡£</p>
</li>
<li>
<p>ä½¿ç”¨embeddingæ¨¡å‹å°†æ–‡æ¡£å‘é‡åŒ–</p>
</li>
<li>
<p>æ„å»ºBM25æ£€ç´¢å’Œå‘é‡æ£€ç´¢æ•°æ®åº“</p>
</li>
<li>
<p>ä¿å­˜æ•°æ®åº“åˆ°æŒ‡å®šä½ç½®</p>
</li>
</ul>
<p>ç³»ç»Ÿå†…éƒ¨æµç¨‹ï¼š</p>
<ul>
<li>
<p>å…ˆç”¨LLMå¯¹é—®é¢˜è¿›è¡Œåˆæ­¥å›ç­”</p>
</li>
<li>
<p>å°†é—®é¢˜å’Œåˆæ­¥å›ç­”ç»“åˆä½œä¸ºæ£€ç´¢å…³é”®è¯</p>
</li>
<li>
<p>åŒæ—¶ä½¿ç”¨BM25å’Œå‘é‡å¬å›è·å–ç›¸å…³æ–‡æ¡£</p>
</li>
<li>
<p>ä½¿ç”¨é‡æ’å™¨å¯¹ç»“æœæ’åº</p>
</li>
<li>
<p>æ„é€ RAG promptï¼ŒåŒ…å«æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹ã€åŸé—®é¢˜å’ŒLLMåˆæ­¥å›ç­”</p>
</li>
<li>
<p>å†æ¬¡è°ƒç”¨LLMç”Ÿæˆæœ€ç»ˆå›ç­”</p>
</li>
</ul>
<br>
<p>æ•°æ®æµè½¬é€»è¾‘</p>
<ol>
<li>
<p>æ„å»ºé˜¶æ®µï¼š</p>
<p>åŸå§‹æ–‡æ¡£ -&gt; å¥å­åˆ†å‰² -&gt; å‘é‡åŒ– -&gt; æ„å»ºBM25å’Œå‘é‡ç´¢å¼• -&gt; ä¿å­˜æ•°æ®åº“</p>
</li>
<li>
<p>æ£€ç´¢é˜¶æ®µï¼š</p>
<p>ç”¨æˆ·æŸ¥è¯¢ -&gt; LLMåˆæ­¥å›ç­” -&gt; å¤šè·¯å¬å›(BM25+å‘é‡) -&gt; é‡æ’ -&gt; æ„é€ RAG Prompt -&gt; LLMç”Ÿæˆæœ€ç»ˆå›ç­”</p>
</li>
</ol>
<br>
<p>ç³»ç»Ÿç‰¹ç‚¹</p>
<p>è½»é‡çº§ï¼šå¯ä»¥ä½¿ç”¨å°å‹æ¨¡å‹è¿è¡Œ</p>
<p>æ¨¡å—åŒ–ï¼šå„ä¸ªç»„ä»¶å¯ä»¥ç‹¬ç«‹æ›¿æ¢</p>
<p>å¤šè·¯å¬å›ï¼šç»“åˆBM25å’Œå‘é‡å¬å›ï¼Œæé«˜å¬å›è´¨é‡</p>
<p>é‡æ’ä¼˜åŒ–ï¼šä½¿ç”¨ä¸“é—¨çš„é‡æ’æ¨¡å‹æé«˜ç›¸å…³æ€§</p>
<p>çµæ´»é…ç½®ï¼šé€šè¿‡é…ç½®æ–‡ä»¶å¯ä»¥è°ƒæ•´å„ä¸ªå‚æ•°</p>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒTinyRAGå®ç°äº†åœ¨æœ‰é™èµ„æºä¸‹çš„é«˜æ•ˆçŸ¥è¯†æ£€ç´¢å’Œå¢å¼ºç”Ÿæˆèƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·éœ€æ±‚å’Œç¡¬ä»¶æ¡ä»¶è¿›è¡Œå®šåˆ¶åŒ–é…ç½®ã€‚</p>
<br>
<br>
<h2 id="å¼¹å¹•">å¼¹å¹•</h2>
<p><strong>æŠ€æœ¯é€‰å‹åˆ†æ</strong></p>
<p><strong>å®æ—¶é€šä¿¡æŠ€æœ¯</strong></p>
<p>â€¢ <strong>WebSocketåè®®</strong>ï¼šä½œä¸ºæ ¸å¿ƒé€šä¿¡åè®®ï¼Œå®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„å…¨åŒå·¥é•¿è¿æ¥ã€‚ç›¸æ¯”HTTPè½®è¯¢ï¼ŒWebSocketæ˜¾è‘—é™ä½å»¶è¿Ÿï¼ˆæ§åˆ¶åœ¨1ç§’å†…ï¼‰ï¼Œæ»¡è¶³å®æ—¶å¼¹å¹•æ¨é€éœ€æ±‚ã€‚<br>
â€¢ <strong>Nettyæ¡†æ¶</strong>ï¼šç”¨äºæ„å»ºé«˜æ€§èƒ½ç½‘ç»œæœåŠ¡ï¼ˆå¦‚å¼¹å¹•æœåŠ¡å™¨ï¼‰ï¼Œæ”¯æŒWebSocketåè®®å®ç°ï¼Œæä¾›å¼‚æ­¥äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä¼˜åŒ–I/Oæ•ˆç‡ã€‚æ—©æœŸæ¶æ„ä¸­ï¼ŒNettyè´Ÿè´£ç»´æŠ¤TCPè¿æ¥æ± ï¼Œå¤„ç†10ä¸‡çº§å¹¶å‘è¿æ¥ã€‚</p>
<p><strong>åˆ†å¸ƒå¼æ¶æ„è®¾è®¡</strong></p>
<p>â€¢ <strong>æ¨¡å—è§£è€¦</strong>ï¼šæ‹†åˆ†ä¸ºCometï¼ˆé•¿è¿æ¥ç®¡ç†ï¼‰ã€Logicï¼ˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼‰ã€Routerï¼ˆä¼šè¯å­˜å‚¨ï¼‰ã€Jobï¼ˆæ¶ˆæ¯åˆ†å‘ï¼‰ã€Persistenceï¼ˆæŒä¹…åŒ–ï¼‰ç­‰ç‹¬ç«‹æ¨¡å—ï¼Œé€šè¿‡Kafkaæ¶ˆæ¯é˜Ÿåˆ—å®ç°æ¾è€¦åˆé€šä¿¡ã€‚</p>
<p><strong>é«˜å¹¶å‘å¤„ç†</strong></p>
<p>â€¢ <strong>Kafkaæ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ç°æ°´å¹³æ‰©å±•çš„å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œæ”¯æŒæ¯ç§’åƒä¸‡çº§å¼¹å¹•åˆ†å‘ã€‚Jobæ¨¡å—ä»Kafkaæ¶ˆè´¹æ¶ˆæ¯åï¼Œå¹¶è¡Œæ¨é€åˆ°æ‰€æœ‰CometèŠ‚ç‚¹ã€‚<br>
â€¢ <strong>Rediså†…å­˜æ•°æ®åº“</strong>ï¼šå­˜å‚¨åœ¨çº¿ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·ä¸CometèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼‰ï¼Œé…åˆBloomFilterå®ç°å¿«é€ŸæŸ¥è¯¢ã€‚</p>
<p><strong>ä¼˜åŒ–ç­–ç•¥</strong></p>
<p>â€¢ <strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šé‡‡ç”¨æ ˆå†…å­˜åˆ†é…ã€å†…å­˜æ± æŠ€æœ¯ï¼Œå•æœºæ‰¿è½½é‡ä»25ä¸‡ï¼ˆ2015å¹´ï¼‰æå‡è‡³100ä¸‡ï¼ˆ2016å¹´ï¼‰åœ¨çº¿ç”¨æˆ·ï¼›<br>
â€¢ <strong>ç½‘ç»œä¼˜åŒ–</strong>ï¼šéƒ¨ç½²å¤šçº¿IDC+ä¸“çº¿ç½‘ç»œï¼Œè§£å†³å•ç‚¹å¸¦å®½ç“¶é¢ˆï¼Œé™ä½è·¨æœºæˆ¿å»¶è¿Ÿï¼›<br>
â€¢ <strong>å¼¹å¹•åˆå¹¶</strong>ï¼šé«˜å³°æœŸå¯¹ç›¸ä¼¼å¼¹å¹•å†…å®¹èšåˆï¼Œå‡å°‘70%ä»¥ä¸Šå†—ä½™æ•°æ®ä¼ è¾“ã€‚</p>
<hr>
<p><strong>ç”¨æˆ·ä½¿ç”¨å…¨æµç¨‹åˆ†æ</strong></p>
<p><strong>è¿æ¥å»ºç«‹é˜¶æ®µ</strong></p>
<ol>
<li><strong>å®¢æˆ·ç«¯åˆå§‹åŒ–</strong>ï¼šç”¨æˆ·æ‰“å¼€è§†é¢‘æ—¶ï¼Œå‰ç«¯é€šè¿‡WebSocketä¸CometèŠ‚ç‚¹å»ºç«‹é•¿è¿æ¥ï¼›</li>
<li><strong>èº«ä»½éªŒè¯</strong>ï¼šLogicæ¨¡å—éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆè´¦å·/IPé»‘åå•è¿‡æ»¤ï¼‰ï¼›</li>
<li><strong>ä¼šè¯æ³¨å†Œ</strong>ï¼šRouteræ¨¡å—è®°å½•ç”¨æˆ·IDä¸CometèŠ‚ç‚¹æ˜ å°„å…³ç³»ï¼Œå­˜å…¥Redisã€‚</li>
</ol>
<p><strong>å¼¹å¹•å‘é€é˜¶æ®µ</strong></p>
<ol>
<li><strong>ç”¨æˆ·è¾“å…¥</strong>ï¼šå‰ç«¯æ•è·è¾“å…¥å†…å®¹ï¼Œé™„åŠ è§†é¢‘æ—¶é—´æˆ³ã€ç”¨æˆ·IDç­‰å…ƒæ•°æ®ï¼›</li>
<li><strong>åè®®å°è£…</strong>ï¼šé€šè¿‡WebSocketå‘é€è‡³CometèŠ‚ç‚¹ï¼›</li>
<li><strong>é€»è¾‘å¤„ç†</strong>ï¼š<br>
â€¢ Logicæ¨¡å—è¿›è¡Œæ•æ„Ÿè¯è¿‡æ»¤ã€å†…å®¹å®¡æ ¸ï¼ˆé›†æˆæœºå™¨å­¦ä¹ æ¨¡å‹ï¼‰ï¼›<br>
â€¢ åˆæ³•æ¶ˆæ¯å†™å…¥KafkaæŒ‡å®šTopicï¼ˆæŒ‰è§†é¢‘IDåˆ†åŒºï¼‰ã€‚</li>
</ol>
<p><strong>æ¶ˆæ¯åˆ†å‘é˜¶æ®µ</strong></p>
<ol>
<li><strong>Jobæ¶ˆè´¹</strong>ï¼šå¤šä¸ªJobè¿›ç¨‹å¹¶è¡Œæ¶ˆè´¹Kafkaæ¶ˆæ¯ï¼Œæ ¹æ®è§†é¢‘IDè·¯ç”±åˆ°å¯¹åº”CometèŠ‚ç‚¹é›†ç¾¤ï¼›</li>
<li><strong>å¹¶è¡Œæ¨é€</strong>ï¼šæ¯ä¸ªCometèŠ‚ç‚¹é€šè¿‡ç‹¬ç«‹é€šé“å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œé¿å…å…¨å±€é”ç«äº‰ï¼›</li>
<li><strong>æœ¬åœ°ç¼“å­˜</strong>ï¼šCometèŠ‚ç‚¹ä½¿ç”¨å†…å­˜æ± ç®¡ç†å¾…å‘é€æ¶ˆæ¯ï¼Œå‡å°‘GCåœé¡¿ã€‚</li>
</ol>
<p><strong>å®¢æˆ·ç«¯æ¸²æŸ“é˜¶æ®µ</strong></p>
<ol>
<li><strong>æ¶ˆæ¯æ¥æ”¶</strong>ï¼šå‰ç«¯WebSocketç›‘å¬æ¶ˆæ¯ï¼Œè§£æå¼¹å¹•å†…å®¹ã€ä½ç½®ã€æ ·å¼å±æ€§ï¼›</li>
<li><strong>æ¸²æŸ“ä¼˜åŒ–</strong>ï¼š<br>
â€¢ Canvas/WebGLç»˜åˆ¶ï¼Œæ”¯æŒ10ä¸‡+æ¡å¼¹å¹•åŒå±æ¸²æŸ“ï¼›<br>
â€¢ åŠ¨æ€å¯†åº¦æ§åˆ¶ï¼šæ ¹æ®è§†é¢‘åˆ†è¾¨ç‡è‡ªåŠ¨è°ƒæ•´å¼¹å¹•æ˜¾ç¤ºåŒºåŸŸï¼›</li>
<li><strong>äº¤äº’å¤„ç†</strong>ï¼šç”¨æˆ·ç‚¹èµ/ä¸¾æŠ¥æ“ä½œé€šè¿‡REST APIåé¦ˆè‡³åç«¯ï¼Œæ›´æ–°Redisè®¡æ•°ã€‚</li>
</ol>
<p><strong>æ ¸å¿ƒæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</strong></p>
<ol>
<li><strong>æµé‡ç“¶é¢ˆ</strong>ï¼šå•æœºå¸¦å®½æé™çº¦3Gbpsï¼ˆ2016å¹´æ•°æ®ï¼‰ï¼Œé€šè¿‡è¾¹ç¼˜èŠ‚ç‚¹CDNåˆ†å‘å¼¹å¹•æµé‡ï¼›</li>
<li><strong>æ¶ˆæ¯é¡ºåºæ€§</strong>ï¼šKafkaåˆ†åŒºå†…ä¿åº+å®¢æˆ·ç«¯æœ¬åœ°æ—¶é—´æˆ³æ’åºï¼Œè§£å†³ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„ä¹±åºé—®é¢˜ï¼›</li>
<li><strong>å†å²å¼¹å¹•æŸ¥è¯¢</strong>ï¼šé‡‡ç”¨MongoDBåˆ†ç‰‡å­˜å‚¨ï¼ŒæŒ‰è§†é¢‘ID+æ—¶é—´èŒƒå›´å»ºç«‹ç»„åˆç´¢å¼•ï¼Œå“åº”æ—¶é—´&lt;50msã€‚</li>
</ol>
<br>
<br>
<h2 id="åœºæ™¯é—®é¢˜">åœºæ™¯é—®é¢˜</h2>
<img src="/2025/02/19/Project/Camera_XHS_17416135605101040g2sg315pqsv4ohc0g5oun.jpg" class="" title="Camera_XHS_17416135605101040g2sg315pqsv4ohc0g5oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135708561040g2sg315pqsv4ohc2g5oun.jpg" class="" title="Camera_XHS_17416135708561040g2sg315pqsv4ohc2g5oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135670761040g2sg315pqsv4ohc205oun.jpg" class="" title="Camera_XHS_17416135670761040g2sg315pqsv4ohc205oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135625461040g2sg315pqsv4ohc105oun.jpg" class="" title="Camera_XHS_17416135625461040g2sg315pqsv4ohc105oun">
<img src="/2025/02/19/Project/Camera_XHS_17416135646421040g2sg315pqsv4ohc1g5oun.jpg" class="" title="Camera_XHS_17416135646421040g2sg315pqsv4ohc1g5oun">
<br>
<h3 id="çƒ­ç‚¹æ•°æ®å‘ç°ä¸å¤„ç†">çƒ­ç‚¹æ•°æ®å‘ç°ä¸å¤„ç†</h3>
<h4 id="åœºæ™¯åˆ†æ">åœºæ™¯åˆ†æ</h4>
<p>Redis ä½¿ç”¨ ZSet ä¿å­˜ä¸æ›´æ–°çƒ­keyï¼Œä½¿ç”¨ zadd æ–¹æ³•å’Œ zrangeæ–¹æ³•å®Œæˆæ’åºé˜Ÿåˆ—å’Œè·å–</p>
<p>åœºæ™¯ï¼š</p>
<p><strong>å•†å“è®¿é—®æ—¶æ›´æ–°æ’å</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>ZADD</code> å‘½ä»¤ï¼Œå°†å•†å“çš„æœ€æ–°è®¿é—®æ—¶é—´ä½œä¸º <code>score</code> æ·»åŠ åˆ°æœ‰åºé›†åˆä¸­ã€‚</li>
<li>å¦‚æœå•†å“å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–° <code>score</code>ï¼ˆå³è®¿é—®æ—¶é—´ï¼‰ã€‚</li>
</ul>
<p><strong>è·å–å‰ 1000 ä¸ªå•†å“</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>ZRANGE</code> å‘½ä»¤ï¼ŒæŒ‰ç…§ <code>score</code> é™åºè·å–å‰ 1000 ä¸ªå•†å“ IDã€‚</li>
</ul>
<p><strong>å®šæœŸæ¸…ç†å¹¶è¡¥å……å•†å“</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>ZREMRANGEBYRANK</code> åˆ é™¤æ’åæœ€åçš„ 200 ä¸ªå•†å“ã€‚</li>
<li>ä»æ•°æ®åº“ä¸­éšæœºè·å– 200 ä¸ªå•†å“ï¼Œå¹¶ä½¿ç”¨ <code>ZADD</code> åŠ å…¥æœ‰åºé›†åˆã€‚</li>
</ul>
<p><strong>è¯·æ±‚åˆ°è¾¾æ—¶è·å–å•†å“æ•°æ®</strong>ï¼š</p>
<ul>
<li>å…ˆç”¨ <code>ZRANK</code> ç¡®å®šå•†å“æ˜¯å¦åœ¨å‰ 1000 åä¸­ã€‚</li>
<li>å¦‚æœå‘½ä¸­ï¼Œåˆ™ä»ç¼“å­˜è·å–å•†å“è¯¦ç»†ä¿¡æ¯ï¼Œå¦åˆ™ä»æ•°æ®åº“åŠ è½½ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisZSetExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCT_RANK_KEY</span> <span class="operator">=</span> <span class="string">&quot;hot_products&quot;</span>; <span class="comment">// Redis ZSet key</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TOP_N</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REMOVE_COUNT</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT)) &#123;</span><br><span class="line">            <span class="comment">// è®¿é—®å•†å“</span></span><br><span class="line">            accessProduct(jedis, <span class="string">&quot;product_123&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å– Top 1000 å•†å“</span></span><br><span class="line">            Set&lt;String&gt; topProducts = getTopProducts(jedis);</span><br><span class="line">            System.out.println(<span class="string">&quot;Top Products: &quot;</span> + topProducts);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šæœŸæ¸…ç†å¹¶è¡¥å……æ•°æ®</span></span><br><span class="line">            refreshProductList(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¿é—®å•†å“æ—¶æ›´æ–°è®¿é—®æ—¶é—´ï¼ˆä½œä¸ºscoreï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">accessProduct</span><span class="params">(Jedis jedis, String productId)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// ä»¥å½“å‰æ—¶é—´æˆ³ä½œä¸ºscore</span></span><br><span class="line">        jedis.zadd(PRODUCT_RANK_KEY, currentTime, productId);</span><br><span class="line">        <span class="comment">// zaddå¾€æœ‰åºé›†åˆkeyä¸­åŠ å…¥å¸¦åˆ†å€¼å…ƒç´ ,è‹¥å…ƒç´ å·²å­˜åœ¨ï¼Œåˆ™è¦†ç›–å…¶åŸæœ‰åˆ†å€¼</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Updated access time for product: &quot;</span> + productId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å– Top 1000 å•†å“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">getTopProducts</span><span class="params">(Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jedis.zrevrange(PRODUCT_RANK_KEY, <span class="number">0</span>, TOP_N - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// zrevrangeå€’åºè·å–æœ‰åºé›†åˆkeyä»startä¸‹æ ‡åˆ°stopä¸‹æ ‡çš„å…ƒç´ </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®šæœŸæ¸…ç†å¹¶è¡¥å……å•†å“æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">refreshProductList</span><span class="params">(Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">totalSize</span> <span class="operator">=</span> jedis.zcard(PRODUCT_RANK_KEY); <span class="comment">// zcardè¿”å›æœ‰åºé›†åˆkeyä¸­å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">if</span> (totalSize &gt; TOP_N) &#123;</span><br><span class="line">            <span class="comment">// åˆ é™¤æ’åé åçš„ 200 ä¸ªå•†å“</span></span><br><span class="line">            jedis.zremrangeByRank(PRODUCT_RANK_KEY, <span class="number">0</span>, REMOVE_COUNT - <span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Removed least accessed products.&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä»æ•°æ®åº“ä¸­éšæœºè·å– 200 ä¸ªå•†å“ï¼ˆæ¨¡æ‹Ÿï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; REMOVE_COUNT; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">newProduct</span> <span class="operator">=</span> <span class="string">&quot;random_product_&quot;</span> + i;</span><br><span class="line">                <span class="type">double</span> <span class="variable">timeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                jedis.zadd(PRODUCT_RANK_KEY, timeStamp, newProduct);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Added 200 random products from DB.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>è®¿é—®å•†å“æ—¶æ›´æ–° score</strong></p>
<ul>
<li>è®¿é—®å•†å“æ—¶ï¼Œè°ƒç”¨ <code>zadd</code> æ–¹æ³•ï¼Œå°†å½“å‰æ—¶é—´æˆ³ä½œä¸º <code>score</code>ï¼Œå®ç°è¶Šæ–°è®¿é—®çš„å•†å“æ’åè¶Šé å‰ã€‚</li>
</ul>
<p><strong>è·å–å‰ 1000 ä¸ªå•†å“</strong></p>
<ul>
<li><code>zrevrange(PRODUCT_RANK_KEY, 0, 999)</code> è·å–æ’åé å‰çš„ 1000 ä¸ªå•†å“ã€‚</li>
</ul>
<p><strong>å®šæœŸæ¸…ç†å¹¶è¡¥å……</strong></p>
<ul>
<li><code>zremrangeByRank(PRODUCT_RANK_KEY, 0, 199)</code> åˆ é™¤æ’åæœ€æœ«çš„ 200 ä¸ªå•†å“ã€‚</li>
<li>éšæœºä»æ•°æ®åº“é€‰ 200 ä¸ªå•†å“ï¼Œä½¿ç”¨ <code>zadd</code> åŠ å…¥ Redisã€‚</li>
</ul>
<p><strong>æŸ¥è¯¢å•†å“æ˜¯å¦å‘½ä¸­</strong></p>
<ul>
<li><code>zrank(PRODUCT_RANK_KEY, productId)</code> ç¡®å®šæ˜¯å¦åœ¨å‰ 1000 åä¸­ã€‚</li>
<li>å‘½ä¸­åˆ™ä»ç¼“å­˜è·å–å•†å“è¯¦æƒ…ï¼Œå¦åˆ™ä»æ•°æ®åº“åŠ è½½ã€‚</li>
</ul>
<br>
<p>è€ƒè™‘Redisä¸­çƒ­ç‚¹æ•°æ®è‡ªåŠ¨ç»­æœŸ</p>
<p>ä½¿ç”¨ Lua è„šæœ¬</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> value = redis.call(<span class="string">&#x27;GET&#x27;</span>, key)</span><br><span class="line"><span class="keyword">if</span> value <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, key, ttl)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>
<br>
<h4 id="çƒ­ç‚¹æ•°æ®å‘ç°">çƒ­ç‚¹æ•°æ®å‘ç°</h4>
<ol>
<li>ç»éªŒè¯„ä¼°</li>
</ol>
<p>å¯¹äºç‰¹å®šä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆè¯„ä¼°å“ªäº›æ•°æ®å¯èƒ½æˆä¸ºçƒ­ç‚¹æ•°æ®ï¼Œä¾‹å¦‚ç§’æ€å•†å“ã€çƒ­é—¨å•†å“ã€å¤§ V çš„åŠ¨æ€å†…å®¹ç­‰ç­‰ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯å®æ–½æˆæœ¬è¾ƒä½ï¼Œä½†æ˜¯ç”±äºæ˜¯åŸºäºç»éªŒè€Œéå®é™…æ•°æ®ï¼Œå› æ­¤æœ€ç»ˆçš„ç»“æœå¯èƒ½ä¸å®é™…æƒ…å†µæœ‰æ‰€åå·®ã€‚</p>
<ol start="2">
<li>ä½¿ç”¨ hotkey å‘½ä»¤</li>
</ol>
<p>Redis ä»ç‰ˆæœ¬ 4.0 å¼€å§‹å¼•å…¥äº† <code>hotkey</code> å‘½ä»¤ï¼Œå…è®¸é€šè¿‡å®¢æˆ·ç«¯çš„ <code>redis-cli --hotkeys</code> å‘½ä»¤æ‰«æåº“ä¸­çš„æ‰€æœ‰çƒ­ç‚¹ Keyã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ— éœ€å¼•å…¥å…¶ä»–é…ç½®æˆ–ç»„ä»¶ï¼Œä½†ç¼ºç‚¹æ˜¯æ€§èƒ½è¾ƒå·®ï¼Œå°¤å…¶åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶å¯èƒ½ä¼šéå¸¸è€—æ—¶ã€‚</p>
<ol start="3">
<li>ä½¿ç”¨ monitor å‘½ä»¤</li>
</ol>
<p>å½“é€šè¿‡ <code>MONITOR</code> å‘½ä»¤å¼€å¯ç›‘è§†å™¨åï¼ŒRedis å°†åœ¨æ‰§è¡Œå‘½ä»¤åè¾“å‡ºä¸€äº›ç›¸å…³çš„ä¿¡æ¯ã€‚ç»“åˆæ—¥å¿—å’Œç›¸å…³åˆ†æå·¥å…·ï¼ˆå¦‚ <code>redis-faina</code>ï¼‰å°±å¯ä»¥å¯¹å…¶è¿›è¡Œç»Ÿè®¡ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹åœ¨äºï¼Œå¼€å¯ç›‘æ§ä¼šæ˜¾è‘—é™ä½ Redis æ€§èƒ½ï¼ˆå•ä¸ªå®ä¾‹ä¼šé™ä½å·®ä¸å¤š 50% çš„æ€§èƒ½ï¼‰ï¼Œå¦‚æœ Redis å®ä¾‹æœ¬èº«å·²ç»æ‰¿å—è¾ƒå¤§è´Ÿè·ï¼Œå¯ç”¨æ­¤åŠŸèƒ½å¯èƒ½ä¼šé›ªä¸ŠåŠ éœœã€‚</p>
<blockquote>
<p>å…·ä½“å‚è§ï¼š<a href="https://redis.io/commands/monitor/">Redis å®˜ç½‘ç›‘æ§ sourl.cn/pDDVv4</a></p>
</blockquote>
<ol start="4">
<li>å®¢æˆ·ç«¯ç›‘æ§</li>
</ol>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å®¢æˆ·ç«¯ï¼ˆå¦‚ Jedis æˆ– Lettuceï¼‰æ¥ä¸ Redis è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œé€šè¿‡åœ¨ä»£ç ä¸­æ·»åŠ ä¸€å±‚ä»£ç†ï¼Œæˆ–ä½¿ç”¨å­—èŠ‚ç æ’æ¡©çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºå®é™…è¯·æ±‚ Redis ä¹‹å‰ä¸ŠæŠ¥è¯·æ±‚å†…å®¹ï¼Œç„¶åé€šè¿‡ç¬¬ä¸‰æ–¹ç»„ä»¶æˆ–å¹³å°è¿›è¡Œåˆ†æï¼Œä»¥ç¡®å®šå“ªäº› Key æ˜¯çƒ­ Keyã€‚</p>
<p>è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹åœ¨äºå®æ–½é—¨æ§›è¾ƒä½ï¼Œå¹¶ä¸”ç”±äºå¯ä»¥ç›´æ¥åœ¨ä»£ç é‡Œé¢ä¿®æ”¹ï¼Œæ‰€ä»¥æ¯”è¾ƒçµæ´»ã€‚ç¼ºç‚¹åœ¨äºäºŒæ¬¡å¼€å‘ä¹Ÿéœ€è¦æˆæœ¬ï¼Œè€Œä¸”åœ¨ä¸åŒçš„ç³»ç»Ÿä¸­å¯èƒ½æ— æ³•å¤ç”¨ã€‚</p>
<p>å½“ç„¶ï¼Œç›®å‰å¸‚åœºä¸Šä¹Ÿæœ‰ä¸€äº›å¸¦å®¢æˆ·ç«¯çš„ä¸€ç«™å¼å¼€æºè§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚äº¬ä¸œçš„ <strong>Gitee/hotkey</strong>ï¼Œä¹Ÿå¾ˆå¥½åœ°è§£å†³äº†çƒ­ Key é—®é¢˜ã€‚</p>
<ol start="5">
<li>ä»£ç†å±‚ç›‘æ§</li>
</ol>
<p>å¯¹äºå¤§è§„æ¨¡çš„ Redis é›†ç¾¤ï¼ˆä¾‹å¦‚å„å¤§äº‘å•†æä¾›çš„ Redis æœåŠ¡ï¼‰çš„è¯·æ±‚é€šå¸¸ä¼šç»è¿‡ä»£ç†æˆ–ç½‘å…³å±‚è¿›è¡Œè½¬å‘ã€‚å› æ­¤ï¼Œå¦‚æœä»£ç†å±‚å¯ä»¥æ”¶é›†è¯·æ±‚ä¿¡æ¯å¹¶ä¸ŠæŠ¥ï¼Œé‚£å°±å¯ä»¥é€šè¿‡åˆ†æç›¸å…³è¯·æ±‚ä¿¡æ¯æ¥ç¡®è®¤çƒ­ Keyã€‚</p>
<p>è¿™ç§æ–¹æ³•ä¸å®¢æˆ·ç«¯ç›‘æ§ç›¸ä¼¼ï¼Œä½†é€‚ç”¨èŒƒå›´æ›´å¹¿ï¼Œç¼ºç‚¹æ˜¯å¼•å…¥é¢å¤–çš„ä»£ç†å±‚ä¼šå¢åŠ è¿ç»´æˆæœ¬ï¼Œè€Œä¸æ˜¯æ‰€æœ‰é›†ç¾¤éƒ½æ”¯æŒè¿™ç§æ–¹å¼ã€‚</p>
<blockquote>
<p>æ­¤å¤„æ¨èé˜…è¯»ä¸€ä¸‹å¾—ç‰©æŠ€æœ¯å›¢é˜Ÿçš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/7202531472720756791">å¾—ç‰©çƒ­ç‚¹æ¢æµ‹è®¾è®¡ä¸å®è·µ</a></p>
</blockquote>
<ol start="6">
<li>æœåŠ¡ç«¯ç›‘æ§</li>
</ol>
<p>é™¤äº†ä¸Šè¿°æ–¹æ³•ï¼Œè¿˜å¯ä»¥å°è¯•åœ¨æœåŠ¡ç«¯ç›‘å¬ç«¯å£ä»¥æŠ“åŒ…åˆ†æè¯·æ±‚ï¼Œæˆ–ç›´æ¥ä¿®æ”¹ Redis æºç æ·»åŠ ä¸ŠæŠ¥åŠŸèƒ½ã€‚è¿™ç§æ–¹æ³•ç±»ä¼¼äºä»£ç†å±‚ç›‘æ§ï¼Œä½†æœ€å¤§çš„é—®é¢˜æ˜¯å®æ–½æˆæœ¬è¾ƒé«˜ã€‚</p>
<p>ref: <a href="https://open8gu.com/cache/big-hot-key/gcgigmnixrmu640t/">https://open8gu.com/cache/big-hot-key/gcgigmnixrmu640t/</a></p>
<br>
<h4 id="æ–¹æ¡ˆ">æ–¹æ¡ˆ</h4>
<p><strong>æ•°æ®åˆ†ç‰‡</strong></p>
<p>æ•°æ®åˆ†ç‰‡æ˜¯é€šè¿‡å°†çƒ­ç‚¹æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªRedisèŠ‚ç‚¹ä¸Šï¼Œé¿å…å•ä¸ªèŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œæ˜¯è§£å†³çƒ­ç‚¹Keyé—®é¢˜æœ€å¸¸ç”¨çš„ç­–ç•¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨Redis Clusteræ¨¡å¼ä¸‹ï¼Œæ•°æ®è‡ªåŠ¨æŒ‰æ§½ä½åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡ã€‚å¯¹äºéClusteræ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡å®¢æˆ·ç«¯æˆ–ä»£ç†å±‚å®ç°ä¸€è‡´æ€§å“ˆå¸Œç­‰åˆ†ç‰‡ç®—æ³•ï¼Œå°†æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªRediså®ä¾‹ä¸Šã€‚</p>
<br>
<p><strong>è¯»å†™åˆ†ç¦»</strong></p>
<p>è¯»å†™åˆ†ç¦»å¯ä»¥å°†è¯»æ“ä½œä¸å†™æ“ä½œåˆ†å¼€å¤„ç†ï¼Œé™ä½å•ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½ã€‚åœ¨ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸‹ï¼Œå¯ä»¥å°†è¯»æ“ä½œåˆ†å‘åˆ°ä»èŠ‚ç‚¹ä¸Šï¼Œä»è€Œåˆ†æ‹…ä¸»èŠ‚ç‚¹çš„å‹åŠ›ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨ä»£ç†å±‚å¦‚Redis Sentinelæˆ–Twemproxyå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œè¯»å†™åˆ†ç¦»ã€‚</p>
<br>
<p><strong>å¤šçº§ç¼“å­˜</strong></p>
<p>å¯¹äºä¸€äº›çƒ­ Keyï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€äº›æœ¬åœ°ç¼“å­˜å·¥å…·ï¼ˆæ¯”å¦‚ Guava æˆ– Ehcacheï¼‰ ç›´æ¥å°†å…¶ç¼“å­˜åˆ° JVM å†…å­˜ä¸­ï¼Œä»æ ¹æœ¬ä¸Šé¿å…å¯¹ Redis é€ æˆå‹åŠ›ã€‚</p>
<p>ä¸è¿‡ï¼Œè¿™ç§æ–¹æ¡ˆä¸‹ç¼“å­˜ä¼šå ç”¨é¢å¤–çš„è¿è¡Œæ—¶å†…å­˜ï¼Œå› æ­¤éœ€è¦æœ‰é€‰æ‹©è¿›è¡Œç¼“å­˜ï¼Œä»¥é¿å…å ç”¨è¿‡å¤šå†…å­˜èµ„æºã€‚å¹¶ä¸”å½“ä¸ Redis ç¼“å­˜å…±ç”¨æ—¶ï¼Œä¹Ÿè¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<br>
<p><strong>é™æµä¸ç†”æ–­é™çº§</strong></p>
<p>é™æµæ˜¯é€šè¿‡æ§åˆ¶è¯·æ±‚çš„é€Ÿç‡æ¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚åœ¨åº”ç”¨å±‚å®ç°é™æµï¼Œå¯ä»¥æœ‰æ•ˆå‡è½»çƒ­ç‚¹Keyå¯¹Redisçš„å‹åŠ›ã€‚å¸¸è§çš„é™æµç®—æ³•æœ‰æ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚</p>
<p>ç†”æ–­é™çº§æ˜¯åœ¨ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶ï¼Œè‡ªåŠ¨é™ä½ç³»ç»ŸåŠŸèƒ½çš„ä¸€ç§ç­–ç•¥ã€‚åœ¨åº”ç”¨å±‚å®ç°ç†”æ–­é™çº§ï¼Œå¯ä»¥åœ¨Rediså‡ºç°çƒ­ç‚¹Keyé—®é¢˜æ—¶ï¼Œå¿«é€Ÿé™ä½å¯¹Redisçš„è®¿é—®å‹åŠ›ã€‚ç†”æ–­é™çº§å¯ä»¥é€šè¿‡å¼€æºå·¥å…·å¦‚Hystrixå®ç°ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°ç­–ç•¥ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³Redisçš„çƒ­ç‚¹Keyé—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯å’Œéœ€æ±‚é€‰æ‹©åˆé€‚çš„ç­–ç•¥ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®è·µæ¡ˆä¾‹æ¥è¯´æ˜å¦‚ä½•è§£å†³çƒ­ç‚¹Keyé—®é¢˜ã€‚</p>
<br>
<br>
<h3 id="å†·çƒ­æ•°æ®åˆ†ç¦»">å†·çƒ­æ•°æ®åˆ†ç¦»</h3>
<p>å››çº§ç¼“å­˜</p>
<p>guava</p>
<p>redis</p>
<p>MySQL</p>
<p>Hadoop</p>
<br>
<h3 id="å¤šçº§ç¼“å­˜">å¤šçº§ç¼“å­˜</h3>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8a949368c524bed93123c832290610b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1244&amp;h=617&amp;s=43089&amp;e=png&amp;b=ffffff" alt="image.png"></p>
<p>Nginxé™æ€ç¼“å­˜ + è¿›ç¨‹å†…ç¼“å­˜ + redisç¼“å­˜ + MySQLç¼“å­˜</p>
<br>
<p>æœ¬åœ°ç¼“å­˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»º Caffeine ç¼“å­˜å®ä¾‹</span></span><br><span class="line">Cache&lt;String, String&gt; caffeineCache = Caffeine.newBuilder()</span><br><span class="line"><span class="comment">// è®¾ç½®ç¼“å­˜é¡¹åœ¨ 5s åå¼€å§‹è‡ªåŠ¨æ›´æ–°</span></span><br><span class="line">.refreshAfterWrite(<span class="number">5</span>, TimeUnit.SECONDS)</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ç¼“å­˜æ›´æ–°é€»è¾‘ï¼ˆå³è·å–æ–°å€¼é€»è¾‘ï¼‰</span></span><br><span class="line">.build(<span class="keyword">new</span> <span class="title class_">CacheLoader</span>&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reload</span><span class="params">(String key, String oldValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ›´æ–°ç¼“å­˜çš„æ“ä½œ</span></span><br><span class="line">        updateCache(key, oldValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<br>
<p>æœ¬åœ°ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆï¼š</p>
<p>MQ</p>
<img src="/2025/02/19/Project/v2-788007b6d898a775abd4889d22892a3d_1440w.jpg" class="" title="img">
<p>Canal + MQ</p>
<img src="/2025/02/19/Project/v2-41835bffd6cf315cffaf8c4e52a94496_1440w.jpg" class="" title="img">
<br>
<br>
<h3 id="åˆ†åº“åˆ†è¡¨">åˆ†åº“åˆ†è¡¨</h3>
<p>ä½¿ç”¨ ShardingSphere</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="attr">t_link:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_0.t_link_$&#123;0..15&#125;</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">gid</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">link_table_hash_mod</span></span><br><span class="line">      <span class="attr">t_link_goto:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_0.t_link_goto_$&#123;0..15&#125;</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">full_short_url</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">link_goto_table_hash_mod</span></span><br><span class="line">      <span class="attr">t_group:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_0.t_group_$&#123;0..15&#125;</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">username</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">group_table_hash_mod</span></span><br><span class="line">    <span class="attr">shardingAlgorithms:</span></span><br><span class="line">      <span class="attr">link_table_hash_mod:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">sharding-count:</span> <span class="number">16</span></span><br><span class="line">      <span class="attr">link_goto_table_hash_mod:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">sharding-count:</span> <span class="number">16</span></span><br><span class="line">      <span class="attr">group_table_hash_mod:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">HASH_MOD</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">sharding-count:</span> <span class="number">16</span></span><br><span class="line"> <span class="bullet">-</span> <span class="type">!ENCRYPT</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="attr">t_user:</span></span><br><span class="line">        <span class="attr">columns:</span></span><br><span class="line">          <span class="attr">phone:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">phone</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">          <span class="attr">mail:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">mail</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">        <span class="attr">queryWithCipherColumn:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">encryptors:</span></span><br><span class="line">      <span class="attr">common_encryptor:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">AES</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">aes-key-value:</span> <span class="string">d6oadClrrb9A3GWo</span></span><br></pre></td></tr></table></figure>
<p><strong>åˆ†ç‰‡ï¼š</strong></p>
<p>è¿™ä¸ªé…ç½®æ–‡ä»¶çš„ä½œç”¨æ˜¯å°†ä¸‰ä¸ªè¡¨ (t_link, t_link_goto, t_group) é€šè¿‡å“ˆå¸Œå–æ¨¡çš„æ–¹å¼ï¼Œå„è‡ªæ‹†åˆ†æˆ 16 ä¸ªåˆ†ç‰‡ï¼Œå¹¶å°†è¿™äº›åˆ†ç‰‡å­˜å‚¨åœ¨ ds_0 æ•°æ®æºä¸­ã€‚æ¯ä¸ªè¡¨çš„åˆ†ç‰‡é”®åˆ†åˆ«æ˜¯ gid, full_short_url å’Œ usernameã€‚ HASH_MOD ç®—æ³•ä¼šè®¡ç®—åˆ†ç‰‡é”®çš„å“ˆå¸Œå€¼ï¼Œç„¶åå¯¹ 16 å–æ¨¡ï¼Œæ ¹æ®ç»“æœå°†æ•°æ®è·¯ç”±åˆ°å¯¹åº”çš„åˆ†ç‰‡è¡¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äº t_link è¡¨ï¼Œå¦‚æœ gid çš„å“ˆå¸Œå€¼å¯¹ 16 å–æ¨¡çš„ç»“æœä¸º 5ï¼Œé‚£ä¹ˆè¯¥æ¡æ•°æ®å°†è¢«å­˜å‚¨åˆ° ds_0.t_link_5 è¡¨ä¸­ã€‚ å…¶ä»–ä¸¤ä¸ªè¡¨çš„åˆ†ç‰‡è¿‡ç¨‹ç±»ä¼¼ï¼Œåªæ˜¯åˆ†ç‰‡é”®ä¸åŒã€‚</p>
<p><strong>åŠ å¯†ï¼š</strong> t_user è¡¨çš„ phone å’Œ mail åˆ—ä½¿ç”¨ AES ç®—æ³•è¿›è¡ŒåŠ å¯†ã€‚åŠ å¯†åçš„æ•°æ®ç›´æ¥å­˜å‚¨åœ¨åŸåˆ—ä¸­ã€‚queryWithCipherColumn: true ç¡®ä¿åœ¨æŸ¥è¯¢ phone å’Œ mail åˆ—æ—¶ï¼ŒæŸ¥è¯¢æ¡ä»¶ä¼šè¢«è‡ªåŠ¨åŠ å¯†ï¼Œç„¶åå¯¹å¯†æ–‡åˆ—è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<br>
<p><strong>åˆ†åº“åˆ†è¡¨äº§ç”Ÿçš„é¢å¤–è¡¨</strong></p>
<p>åœ¨åˆ†åº“åˆ†è¡¨ä¸­ï¼Œå‡å¦‚æ˜¯é€šè¿‡ç”¨æˆ·åè¿›è¡Œåˆ†ç‰‡çš„ï¼Œå¦‚æœåœ¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ—¶ä¸å¸¦ç”¨æˆ·åï¼Œå°†ä¼šè§¦å‘è¯»æ‰©æ•£é—®é¢˜ã€‚</p>
<p>ç”±äºç™»å½•æ—¶æ²¡æœ‰å¸¦ç”¨æˆ·åï¼Œå¯¼è‡´æ— æ³•ç¡®å®šç”¨æˆ·çš„åˆ†ç‰‡é”®ï¼Œä½¿å¾—ç³»ç»Ÿæ— æ³•ç›´æ¥é”å®šç”¨æˆ·çš„æ•°æ®ä½äºå“ªä¸ªæ•°æ®åº“æˆ–è€…å“ªå¼ è¡¨ä¸­ã€‚ä¸ºäº†æ‰¾åˆ°ç”¨æˆ·çš„æ•°æ®ï¼Œåªèƒ½å¯¹å…¨éƒ¨çš„æ•°æ®åº“å’Œè¡¨è¿›è¡Œæ‰«ææŸ¥è¯¢ï¼Œè¿™å°±é€ æˆäº†æ‰€è°“çš„â€œè¯»è¯·æ±‚æ‰©æ•£â€é—®é¢˜ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸæœ¬è¯»è¯·æ±‚å¯ä»¥ç›´æ¥å®šä½åˆ°æŸä¸ªæ•°æ®åº“æŸå¼ è¡¨ï¼Œç°åœ¨å´è¦å¤šå¤„æŸ¥è¯¢ï¼Œæ— ç–‘å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„æŸ¥è¯¢è´Ÿè½½ã€‚</p>
<p>ä¸€æ—¦å‡ºç°äº†è¯»è¯·æ±‚æ‰©æ•£é—®é¢˜ï¼ŒåŠ¿å¿…ä¼šå¯¼è‡´ç”¨æˆ·çš„ç™»å½•è¯·æ±‚å“åº”æ—¶é—´å˜é•¿ï¼Œä¸¥é‡çš„è¯è¿˜å¯èƒ½é€ æˆç™»å½•è¶…æ—¶</p>
<br>
<h2 id="SSO">SSO</h2>
<img src="/2025/02/19/Project/cas-1741240463041.png" class="" title="img">]]></content>
      <categories>
        <category>Project</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>pic_test</title>
    <url>/2024/04/12/pic-test/</url>
    <content><![CDATA[<p>å›¾ç‰‡æ’å…¥æµ‹è¯•ï¼š</p>
<img src="/2024/04/12/pic-test/img.png" class="">]]></content>
  </entry>
  <entry>
    <title>Spring-learning-record</title>
    <url>/2024/10/01/Spring-learning-record/</url>
    <content><![CDATA[<p>Springç›¸å…³å­¦ä¹ è®°å½•</p>
<span id="more"></span>
<h1>ç½‘ç»œç›¸å…³</h1>
<p>æ¡ˆä¾‹</p>
<p><strong>å¤„ç† GET è¯·æ±‚çš„æµç¨‹ä¸¾ä¾‹ (ä»¥ä¸€ä¸ªç®€å•çš„ Java Web åº”ç”¨ä¸ºä¾‹):</strong></p>
<p>å‡è®¾ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è®¿é—® <a href="http://www.example.com/products/123%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E4%BA%A7%E5%93%81">http://www.example.com/products/123ï¼Œè¿™æ˜¯ä¸€ä¸ªè·å–äº§å“</a> ID ä¸º 123 çš„äº§å“çš„ GET è¯·æ±‚ã€‚</p>
<ol>
<li>
<p><strong>å®¢æˆ·ç«¯ (æµè§ˆå™¨) å‘èµ·è¯·æ±‚:</strong> æµè§ˆå™¨å°† GET è¯·æ±‚å‘é€åˆ° <a href="http://www.example.com">www.example.com</a>ã€‚</p>
</li>
<li>
<p><strong>åå‘ä»£ç†æœåŠ¡å™¨ (å¦‚æœå­˜åœ¨):</strong> åå‘ä»£ç†æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ã€‚å®ƒå¯èƒ½æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚æ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç»“æœã€‚å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™å°†è¯·æ±‚è½¬å‘åˆ° Web æœåŠ¡å™¨ã€‚</p>
</li>
<li>
<p><strong>Web æœåŠ¡å™¨ (ä¾‹å¦‚ Apache/Nginx):</strong> Web æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼Œæ ¹æ®é…ç½®å°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„åº”ç”¨æœåŠ¡å™¨ã€‚</p>
<p>å¯¹äºé™æ€å†…å®¹ï¼ˆå¦‚ HTML æ–‡ä»¶ã€å›¾ç‰‡ã€CSS å’Œ JavaScript æ–‡ä»¶ï¼‰ï¼ŒWeb æœåŠ¡å™¨å¯ä»¥ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ— éœ€æ¶‰åŠåº”ç”¨æœåŠ¡å™¨ï¼Œä»è€Œæ˜¾è‘—æå‡æ€§èƒ½ã€‚Web æœåŠ¡å™¨é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„è§„åˆ™ï¼ˆä¾‹å¦‚ï¼ŒNginx ä¸­çš„ location æŒ‡ä»¤ï¼‰æ¥è¯†åˆ«é™æ€æ–‡ä»¶è¯·æ±‚ï¼Œé€šå¸¸æ ¹æ® URL è·¯å¾„æˆ–æ–‡ä»¶æ‰©å±•åè¿›è¡ŒåŒ¹é…ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚ /images/logo.png æˆ– /styles.cssï¼ŒWeb æœåŠ¡å™¨ä¼šç›´æ¥è¿”å›å¯¹åº”çš„æ–‡ä»¶ã€‚ æ­¤å¤–ï¼ŒWebæœåŠ¡å™¨è¿˜å¯ä»¥è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚é€šè¿‡expiresæŒ‡ä»¤ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–å¯¹é™æ€èµ„æºçš„è®¿é—®é€Ÿåº¦ã€‚</p>
<p>å¯¹äºåŠ¨æ€å†…å®¹ï¼ŒWeb æœåŠ¡å™¨åˆ™å……å½“åå‘ä»£ç†çš„è§’è‰²ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„åº”ç”¨æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼ŒURL è·¯å¾„ /products å¯èƒ½å¯¹åº”ä¸€ä¸ªéœ€è¦æ•°æ®åº“äº¤äº’çš„äº§å“åˆ—è¡¨é¡µé¢ï¼ŒWeb æœåŠ¡å™¨ä¼šå°†è¯¥è¯·æ±‚è½¬å‘åˆ°ä¸“é—¨å¤„ç†äº§å“ç›¸å…³è¯·æ±‚çš„åº”ç”¨æœåŠ¡å™¨ã€‚è½¬å‘è§„åˆ™åŒæ ·åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¯ä»¥åŸºäº URL è·¯å¾„ã€è¯·æ±‚æ–¹æ³•ç­‰è¿›è¡ŒåŒ¹é…ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰ /api/ å¼€å¤´çš„è¯·æ±‚éƒ½å¯èƒ½è¢«è½¬å‘åˆ°ç‰¹å®šçš„åº”ç”¨æœåŠ¡å™¨ã€‚</p>
</li>
<li>
<p><strong>åº”ç”¨æœåŠ¡å™¨ (ä¾‹å¦‚ Tomcat):</strong> åº”ç”¨æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ã€‚</p>
<ul>
<li><strong>è·¯ç”±:</strong> åº”ç”¨æœåŠ¡å™¨æ ¹æ® URL è·¯å¾„ /products/123 ç¡®å®šå“ªä¸ªæ§åˆ¶å™¨ (Controller) å’Œæ–¹æ³• (Method) åº”è¯¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½å°†è¯·æ±‚è·¯ç”±åˆ° ProductController çš„ getProduct æ–¹æ³•ã€‚</li>
<li><strong>æ§åˆ¶å™¨:</strong> ProductController çš„ getProduct æ–¹æ³•è¢«è°ƒç”¨ã€‚è¯¥æ–¹æ³•ä» URL ä¸­æå–äº§å“ ID (123)ã€‚</li>
<li><strong>æœåŠ¡å±‚ (å¯é€‰):</strong> æ§åˆ¶å™¨è°ƒç”¨æœåŠ¡å±‚ (Service Layer) çš„æ–¹æ³•æ¥è·å–äº§å“æ•°æ®ã€‚æœåŠ¡å±‚å°è£…äº†ä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚ä»æ•°æ®åº“ä¸­æ£€ç´¢äº§å“ä¿¡æ¯ã€‚</li>
<li><strong>æ•°æ®è®¿é—®å±‚ (DAO):</strong> æœåŠ¡å±‚è°ƒç”¨æ•°æ®è®¿é—®å±‚ (Data Access Object) çš„æ–¹æ³•æ¥ä¸æ•°æ®åº“äº¤äº’ã€‚DAO è´Ÿè´£æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ã€‚</li>
<li><strong>æ•°æ®åº“:</strong> æ•°æ®åº“æœåŠ¡å™¨æ¥æ”¶æŸ¥è¯¢è¯·æ±‚ï¼Œè¿”å›äº§å“ ID ä¸º 123 çš„äº§å“æ•°æ®ã€‚</li>
<li><strong>è¿”å›æ•°æ®:</strong> DAO å°†æ•°æ®è¿”å›ç»™æœåŠ¡å±‚ï¼ŒæœåŠ¡å±‚å°†æ•°æ®è¿”å›ç»™æ§åˆ¶å™¨ã€‚</li>
<li><strong>è§†å›¾æ¸²æŸ“ (å¯é€‰):</strong> æ§åˆ¶å™¨å°†æ•°æ®ä¼ é€’ç»™è§†å›¾æ¸²æŸ“å¼•æ“ (ä¾‹å¦‚ JSP, Thymeleaf)ï¼Œç”Ÿæˆ HTML å“åº”ã€‚å¦‚æœè¿”å›çš„æ˜¯ JSON æ•°æ®ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</li>
</ul>
</li>
<li>
<p><strong>åº”ç”¨æœåŠ¡å™¨è¿”å›å“åº”:</strong> åº”ç”¨æœåŠ¡å™¨å°†ç”Ÿæˆçš„ HTML å“åº”æˆ– JSON æ•°æ®è¿”å›ç»™ Web æœåŠ¡å™¨ã€‚</p>
</li>
<li>
<p><strong>Web æœåŠ¡å™¨è¿”å›å“åº”:</strong> Web æœåŠ¡å™¨å°†å“åº”è¿”å›ç»™åå‘ä»£ç†æœåŠ¡å™¨ (å¦‚æœå­˜åœ¨)ã€‚</p>
</li>
<li>
<p><strong>åå‘ä»£ç†æœåŠ¡å™¨è¿”å›å“åº”:</strong> åå‘ä»£ç†æœåŠ¡å™¨å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ (æµè§ˆå™¨)ã€‚</p>
</li>
<li>
<p><strong>æµè§ˆå™¨æ¸²æŸ“:</strong> æµè§ˆå™¨æ¥æ”¶ HTML å“åº”å¹¶æ¸²æŸ“é¡µé¢ï¼Œæˆ–è€…å¤„ç† JSON æ•°æ®ã€‚</p>
</li>
</ol>
<h2 id="servlet">servlet</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebServletæ³¨è§£è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªServletï¼Œå¹¶æ˜ å°„åˆ°åœ°å€/:</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å“åº”ç±»å‹:</span></span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–è¾“å‡ºæµ:</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        <span class="comment">// å†™å…¥å“åº”:</span></span><br><span class="line">        pw.write(<span class="string">&quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">// æœ€åä¸è¦å¿˜è®°flushå¼ºåˆ¶è¾“å‡º:</span></span><br><span class="line">        pw.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/signin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SignInServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/&quot;)</span>  <span class="comment">// ä¼šæ¥æ”¶æ‰€æœ‰æœªåŒ¹é…çš„è·¯å¾„ï¼Œç›¸å½“äº /*</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµç¨‹</p>
<ol>
<li><strong>å®¢æˆ·ç«¯å‘é€GETè¯·æ±‚:</strong> å®¢æˆ·ç«¯æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªHTTP GETè¯·æ±‚åˆ°æŒ‡å®šçš„URLï¼ˆä¾‹å¦‚/ï¼‰ã€‚</li>
<li><strong>æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚:</strong> æœåŠ¡å™¨ï¼ˆä¾‹å¦‚Tomcatï¼‰æ¥æ”¶åˆ°è¯·æ±‚ã€‚</li>
<li><strong>Servletå®¹å™¨åŒ¹é…Servlet:</strong> Servletå®¹å™¨æ ¹æ®URLæ‰¾åˆ°å¯¹åº”çš„Servletï¼ˆæœ¬ä¾‹ä¸­æ˜¯HelloServletï¼‰ã€‚</li>
<li><strong>Servletå®¹å™¨åˆ›å»ºrequestå’Œresponseå¯¹è±¡:</strong> Servletå®¹å™¨åˆ›å»ºHttpServletRequestå’ŒHttpServletResponseå¯¹è±¡ã€‚HttpServletRequestå°è£…äº†å®¢æˆ·ç«¯è¯·æ±‚çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚è¯·æ±‚å¤´ã€å‚æ•°ç­‰ï¼‰ï¼ŒHttpServletResponseç”¨äºæ„å»ºæœåŠ¡å™¨çš„å“åº”ã€‚</li>
<li><strong>Servletå®¹å™¨è°ƒç”¨doGetæ–¹æ³•:</strong> Servletå®¹å™¨è°ƒç”¨HelloServletçš„doGetæ–¹æ³•ï¼Œå¹¶å°†åˆ›å»ºçš„HttpServletRequestå’ŒHttpServletResponseå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</li>
<li><strong>Servletå¤„ç†è¯·æ±‚:</strong> åœ¨doGetæ–¹æ³•ä¸­ï¼Œä½¿ç”¨reqå¯¹è±¡è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨respå¯¹è±¡æ„å»ºå“åº”ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®å“åº”çš„å†…å®¹ç±»å‹ã€å†™å…¥å“åº”å†…å®¹ç­‰ã€‚</li>
<li><strong>Servletå®¹å™¨å‘é€å“åº”:</strong> doGetæ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼ŒServletå®¹å™¨å°†respå¯¹è±¡ä¸­å°è£…çš„å“åº”ä¿¡æ¯å‘é€å›å®¢æˆ·ç«¯ã€‚</li>
</ol>
<blockquote>
<p>ä¸€ä¸ªServletç±»åœ¨æœåŠ¡å™¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä½†å¯¹äºæ¯ä¸ªHTTPè¯·æ±‚ï¼ŒWebæœåŠ¡å™¨ä¼šä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡Œè¯·æ±‚ã€‚å› æ­¤ï¼Œä¸€ä¸ªServletçš„<code>doGet()</code>ã€<code>doPost()</code>ç­‰å¤„ç†è¯·æ±‚çš„æ–¹æ³•æ˜¯å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ã€‚å¦‚æœServletä¸­å®šä¹‰äº†å­—æ®µï¼Œè¦æ³¨æ„å¤šçº¿ç¨‹å¹¶å‘è®¿é—®çš„é—®é¢˜.</p>
</blockquote>
<h2 id="Redirect-ä¸-Forward">Redirect ä¸ Forward</h2>
<p>Redirecté€è¿‡HTTP 301 å’Œ 302å®ç°</p>
<p>æµè§ˆå™¨æ”¶åˆ°302å“åº”åï¼Œå®ƒä¼šç«‹åˆ»æ ¹æ®<code>Location</code>çš„æŒ‡ç¤ºå‘é€ä¸€ä¸ªæ–°çš„<code>GET /hello</code>è¯·æ±‚ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯é‡å®šå‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 302 ä¸´æ—¶é‡å®šå‘</span></span><br><span class="line"><span class="type">String</span> <span class="variable">redirectToUrl</span> <span class="operator">=</span> <span class="string">&quot;/hello&quot;</span> + (name == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;?name=&quot;</span> + name);</span><br><span class="line">resp.sendRedirect(redirectToUrl);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 301 æ°¸ä¹…é‡å®šå‘ï¼Œæµè§ˆå™¨ä¼šç¼“å­˜/hiåˆ°/helloè¿™ä¸ªé‡å®šå‘çš„å…³è”ï¼Œä¸‹æ¬¡è¯·æ±‚/hiçš„æ—¶å€™ï¼Œæµè§ˆå™¨å°±ç›´æ¥å‘é€/helloè¯·æ±‚äº†</span></span><br><span class="line">resp.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY); <span class="comment">// 301</span></span><br><span class="line">resp.setHeader(<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;/hello&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Forwardæ˜¯æŒ‡å†…éƒ¨è½¬å‘ã€‚å½“ä¸€ä¸ªServletå¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒå¯ä»¥å†³å®šè‡ªå·±ä¸ç»§ç»­å¤„ç†ï¼Œè€Œæ˜¯è½¬å‘ç»™å¦ä¸€ä¸ªServletå¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/morning&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForwardServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;/hello&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Session-ä¸-Cookie">Session ä¸ Cookie</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> req.getSession();</span><br><span class="line">session.setAttribute(<span class="string">&quot;user&quot;</span>, name);</span><br></pre></td></tr></table></figure>
<p>æµç¨‹:</p>
<ol>
<li>
<p>HttpSession session = req.getSession();: è¿™ä¸€è¡Œä»£ç è·å–æˆ–åˆ›å»ºä¸€ä¸ªä¸å½“å‰è¯·æ±‚å…³è”çš„ HttpSession å¯¹è±¡ã€‚å¦‚æœ<strong>è¯·æ±‚æŠ¥æ–‡</strong>ä¸­åŒ…å«çš„ä¼šè¯ IDï¼ˆ<code>Cookie: JSESSIONID=ABCDEF1234567890</code>ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šå°è¯•æ£€ç´¢ä¸è¯¥ ID å…³è”çš„ç°æœ‰ä¼šè¯ã€‚å¦‚æœæ‰¾ä¸åˆ°æˆ–ä¼šè¯ ID æ— æ•ˆï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¼šè¯ IDã€‚</p>
</li>
<li>
<p>session.setAttribute(â€œuserâ€, name);: è¿™ä¸€è¡Œä»£ç å°†åä¸º â€œuserâ€ çš„å±æ€§åŠå…¶å€¼ name å­˜å‚¨åˆ°ä¼šè¯å¯¹è±¡ä¸­ã€‚æ­¤æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œè€Œä¸æ˜¯ç›´æ¥å‘é€åˆ°å®¢æˆ·ç«¯ã€‚</p>
<blockquote>
<p>HttpSession å¯¹è±¡ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚å­˜å‚¨åœ¨ Session ä¸­çš„å€¼ä»£è¡¨äº†ä¸ç‰¹å®šå®¢æˆ·ç«¯ä¼šè¯ç›¸å…³çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨ç”¨æˆ·ç™»å½•åï¼Œå¯ä»¥å°†ç”¨æˆ·åå­˜å‚¨åœ¨ Session ä¸­ï¼Œä»¥ä¾¿åœ¨åç»­è¯·æ±‚ä¸­è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œè€Œæ— éœ€ç”¨æˆ·æ¯æ¬¡éƒ½é‡æ–°ç™»å½•ã€‚å…¶ä»–å¸¸è§çš„ä¾‹å­åŒ…æ‹¬ï¼š</p>
<ul>
<li>è´­ç‰©è½¦ä¸­çš„å•†å“</li>
<li>ç”¨æˆ·çš„åå¥½è®¾ç½®</li>
<li>ç”¨æˆ·çš„æµè§ˆå†å²</li>
<li>æ¸¸æˆä¸­çš„åˆ†æ•°</li>
</ul>
</blockquote>
</li>
<li>
<p><strong>è®¾ç½® Cookieï¼š</strong> å½“æœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚å¹¶å‡†å¤‡å‘é€å“åº”æ—¶ï¼Œå¦‚æœåˆ›å»ºäº†æ–°çš„ä¼šè¯æˆ–ç°æœ‰ä¼šè¯è¢«ä¿®æ”¹ï¼ŒæœåŠ¡å™¨ä¼šå°† Set-Cookie å¤´æ·»åŠ åˆ°å“åº”ä¸­ã€‚è¿™ä¸ªå¤´åŒ…å«æ–°åˆ›å»ºçš„æˆ–æ›´æ–°çš„ä¼šè¯ IDã€‚å®¢æˆ·ç«¯ï¼ˆé€šå¸¸æ˜¯æµè§ˆå™¨ï¼‰æ”¶åˆ°æ­¤å¤´åï¼Œä¼šå°†ä¼šè¯ ID å­˜å‚¨åœ¨ä¸€ä¸ª cookie ä¸­ã€‚</p>
<blockquote>
<p>åªæœ‰å½“ä»¥ä¸‹å‡ ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šæ›´æ–°æˆ–å‘é€æ–°çš„ Cookieï¼š</p>
<ol>
<li><strong>åˆ›å»ºæ–°çš„ä¼šè¯ï¼š</strong> å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è®¿é—®éœ€è¦ä¼šè¯çš„èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ HttpSession å¯¹è±¡ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¼šè¯ IDï¼Œç„¶åé€šè¿‡ Set-Cookie å¤´å°†æ–°çš„ä¼šè¯ ID å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>
<li><strong>ä¼šè¯ ID é‡æ–°ç”Ÿæˆï¼ˆè¾ƒå°‘è§ï¼‰ï¼š</strong> å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šåœ¨æŸäº›æƒ…å†µä¸‹é‡æ–°ç”Ÿæˆä¼šè¯ IDï¼Œä¾‹å¦‚ç”¨æˆ·ç™»å½•åã€‚è¿™æ—¶æœåŠ¡å™¨ä¼šå‘é€ä¸€ä¸ªæ–°çš„ Set-Cookie å¤´ï¼Œå…¶ä¸­åŒ…å«æ–°çš„ä¼šè¯ IDã€‚</li>
<li><strong>ä¼šè¯è¿‡æœŸæ—¶é—´æ›´æ–°ï¼ˆå¦‚æœé…ç½®äº†ï¼‰ï¼š</strong> å¦‚æœæœåŠ¡å™¨é…ç½®äº†ä¼šè¯çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”åœ¨ä¼šè¯è¿‡ç¨‹ä¸­æ›´æ–°äº†è¿‡æœŸæ—¶é—´ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šå‘é€ä¸€ä¸ªæ–°çš„ Set-Cookie å¤´æ¥æ›´æ–° Cookie ä¸­çš„è¿‡æœŸæ—¶é—´ä¿¡æ¯ã€‚</li>
<li><strong>å…¶ä»–ä¸ä¼šè¯ç›¸å…³çš„ Cookie å±æ€§æ›´æ”¹ï¼š</strong> ä¾‹å¦‚ï¼Œå¦‚æœæœåŠ¡å™¨æ›´æ”¹äº† Cookie çš„ HttpOnlyã€Secureã€Path æˆ– Domain å±æ€§ï¼Œåˆ™éœ€è¦å‘é€æ–°çš„ Set-Cookie å¤´æ¥æ›´æ–°å®¢æˆ·ç«¯çš„ Cookieã€‚</li>
</ol>
</blockquote>
</li>
<li>
<p><strong>åç»­è¯·æ±‚ï¼š</strong> å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­ä¼šè‡ªåŠ¨å°†è¿™ä¸ª cookie å‘é€å›æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ ¹æ® cookie ä¸­çš„ä¼šè¯ ID æ£€ç´¢ç›¸åº”çš„ HttpSession å¯¹è±¡ï¼Œä»è€Œç»´æŠ¤ä¼šè¯çŠ¶æ€ã€‚</p>
</li>
</ol>
<p>é™¤äº†ä½¿ç”¨Cookieæœºåˆ¶å¯ä»¥å®ç°Sessionå¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡éšè—è¡¨å•ã€URLæœ«å°¾é™„åŠ IDæ¥è¿½è¸ªSessionã€‚</p>
<h2 id="JSP">JSP</h2>
<p>JSPï¼ˆJavaServer Pagesï¼‰æ˜¯ä¸€ç§ç”¨äºåˆ›å»ºåŠ¨æ€ Web é¡µé¢çš„æŠ€æœ¯ã€‚å®ƒå…è®¸æ‚¨åœ¨ HTML é¡µé¢ä¸­åµŒå…¥ Java ä»£ç ï¼Œä»è€Œç”ŸæˆåŠ¨æ€å†…å®¹ã€‚Tomcat åœ¨å¤„ç† JSP é¡µé¢æ—¶æ‰®æ¼”ç€å…³é”®è§’è‰²ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p><strong>ç¿»è¯‘é˜¶æ®µ (Translation):</strong> å½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚ JSP é¡µé¢æ—¶ï¼ŒTomcat çš„ JSP å¼•æ“ä¼šå°† JSP é¡µé¢ç¿»è¯‘æˆä¸€ä¸ª Java Servlet æºæ–‡ä»¶ã€‚è¿™ä¸ªæºæ–‡ä»¶åŒ…å«äº† JSP é¡µé¢ä¸­çš„æ‰€æœ‰ HTMLã€Java ä»£ç ä»¥åŠ JSP æŒ‡ä»¤ã€‚  è¿™ä¸ªè½¬æ¢è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li><strong>è§£æ JSP æŒ‡ä»¤:</strong>  JSP æŒ‡ä»¤ï¼ˆä¾‹å¦‚ <code>&lt;%@ page ... %&gt;</code>, <code>&lt;%@ include ... %&gt;</code>, <code>&lt;%@ taglib ... %&gt;</code>ï¼‰ä¼šè¢«è§£æå¹¶ç”¨äºé…ç½®ç”Ÿæˆçš„ Servletã€‚</li>
<li><strong>å°† HTML è½¬æ¢ä¸º Java ä»£ç :</strong> JSP é¡µé¢ä¸­çš„ HTML ä»£ç ä¼šè¢«è½¬æ¢ä¸º <code>out.write()</code> è¯­å¥ï¼Œå…¶ä¸­ <code>out</code> æ˜¯ <code>JspWriter</code> å¯¹è±¡ï¼Œç”¨äºå°†å†…å®¹è¾“å‡ºåˆ°å®¢æˆ·ç«¯ã€‚</li>
<li><strong>åµŒå…¥ Java ä»£ç :</strong>  JSP é¡µé¢ä¸­çš„ Java ä»£ç ç‰‡æ®µï¼ˆä¾‹å¦‚ <code>&lt;% ... %&gt;</code> å’Œ <code>&lt;%= ... %&gt;</code>ï¼‰ä¼šè¢«ç›´æ¥åµŒå…¥åˆ°ç”Ÿæˆçš„ Servlet çš„ <code>_jspService()</code> æ–¹æ³•ä¸­ã€‚</li>
</ul>
</li>
<li>
<p><strong>ç¼–è¯‘é˜¶æ®µ (Compilation):</strong> ç¿»è¯‘ç”Ÿæˆçš„ Java Servlet æºæ–‡ä»¶ä¼šè¢« Java ç¼–è¯‘å™¨ç¼–è¯‘æˆä¸€ä¸ª Java Servlet class æ–‡ä»¶ (<code>.class</code> æ–‡ä»¶)ã€‚</p>
</li>
<li>
<p><strong>åŠ è½½é˜¶æ®µ (Loading):</strong> Tomcat çš„ç±»åŠ è½½å™¨ä¼šå°†ç¼–è¯‘å¥½çš„ Servlet class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p>
</li>
<li>
<p><strong>å®ä¾‹åŒ–é˜¶æ®µ (Instantiation):</strong> Tomcat åˆ›å»º Servlet çš„ä¸€ä¸ªå®ä¾‹ã€‚</p>
</li>
<li>
<p><strong>åˆå§‹åŒ–é˜¶æ®µ (Initialization):</strong> Tomcat è°ƒç”¨ Servlet çš„ <code>init()</code> æ–¹æ³•ï¼Œå¯¹ Servlet è¿›è¡Œåˆå§‹åŒ–ã€‚ è¿™é€šå¸¸åªå‘ç”Ÿä¸€æ¬¡ï¼Œåœ¨ Servlet ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚æ—¶ã€‚</p>
</li>
<li>
<p><strong>è¯·æ±‚å¤„ç†é˜¶æ®µ (Request Processing):</strong>  å½“æµè§ˆå™¨è¯·æ±‚ JSP é¡µé¢æ—¶ï¼ŒTomcat ä¼šè°ƒç”¨ Servlet çš„ <code>_jspService()</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•åŒ…å«äº† JSP é¡µé¢ä¸­çš„æ‰€æœ‰é€»è¾‘ï¼Œå¹¶è´Ÿè´£ç”ŸæˆåŠ¨æ€å†…å®¹ã€‚  <code>_jspService()</code> æ–¹æ³•ä¼šæ ¹æ® HTTP è¯·æ±‚çš„ç±»å‹ (GET, POST ç­‰) æ‰§è¡Œç›¸åº”çš„é€»è¾‘ã€‚</p>
</li>
<li>
<p><strong>é”€æ¯é˜¶æ®µ (Destruction):</strong> å½“ Tomcat å…³é—­æˆ–éœ€è¦å¸è½½ Servlet æ—¶ï¼Œä¼šè°ƒç”¨ Servlet çš„ <code>destroy()</code> æ–¹æ³•ï¼Œé‡Šæ”¾èµ„æºã€‚</p>
</li>
</ol>
<p><strong>ç®€è€Œè¨€ä¹‹ï¼ŒTomcat å°† JSP é¡µé¢è½¬æ¢ä¸º Servletï¼Œç„¶ååƒå¯¹å¾…å…¶ä»– Servlet ä¸€æ ·å¤„ç†å®ƒã€‚ è¿™æ„å‘³ç€ JSP é¡µé¢æœ€ç»ˆä¼šè¢«è½¬æ¢æˆ Java ä»£ç ï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œã€‚</strong></p>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<p>å‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„ JSP é¡µé¢ <code>hello.jsp</code>ï¼š</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Hello JSP&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Hello, &lt;%= <span class="keyword">new</span> <span class="title class_">java</span>.util.Date() %&gt;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>Tomcat ä¼šå°†å…¶è½¬æ¢ä¸ºç±»ä¼¼ä»¥ä¸‹çš„ Servlet ä»£ç  (ç®€åŒ–ç‰ˆ)ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hello_jsp</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">_jspService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    response.setContentType(<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">    <span class="type">JspWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line"></span><br><span class="line">    out.write(<span class="string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;html&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;head&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;title&gt;Hello JSP&lt;/title&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;/head&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;body&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;h1&gt;Hello, &quot;</span>);</span><br><span class="line">    out.print(<span class="keyword">new</span> <span class="title class_">java</span>.util.Date());</span><br><span class="line">    out.write(<span class="string">&quot;&lt;/h1&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;/body&gt;\n&quot;</span>);</span><br><span class="line">    out.write(<span class="string">&quot;&lt;/html&gt;\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒHTML ä»£ç è¢«è½¬æ¢ä¸º <code>out.write()</code> è¯­å¥ï¼Œè€Œ Java ä»£ç  <code>&lt;%= new java.util.Date() %&gt;</code> è¢«åµŒå…¥åˆ° <code>_jspService()</code> æ–¹æ³•ä¸­ã€‚  æœ€ç»ˆï¼Œè¿™ä¸ª Servlet ä¼šè¢«ç¼–è¯‘å¹¶æ‰§è¡Œï¼Œç”ŸæˆåŠ¨æ€çš„ HTML é¡µé¢å¹¶è¿”å›ç»™æµè§ˆå™¨ã€‚</p>
<h2 id="Filter">Filter</h2>
<p><strong>è¿‡æ»¤å™¨é“¾ (FilterChain):</strong> Servlet å®¹å™¨ä¼šæ ¹æ® web.xml æˆ–æ³¨è§£ä¸­çš„é…ç½®ï¼Œå°†åŒ¹é… URL æ¨¡å¼çš„è¿‡æ»¤å™¨ç»„æˆä¸€ä¸ªé“¾æ¡ã€‚å½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå®¹å™¨ä¼šä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„è¿‡æ»¤å™¨ã€‚</p>
<p><strong>chain.doFilter():</strong> è¿™ä¸ªæ–¹æ³•æ˜¯å°†æ§åˆ¶æƒäº¤ç»™è¿‡æ»¤å™¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªå®ä½“ã€‚</p>
<ul>
<li><strong>å¦‚æœæœ‰ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨:</strong> æ§åˆ¶æƒä¼šè½¬ç§»åˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ‰§è¡Œå…¶ doFilter() æ–¹æ³•ã€‚</li>
<li><strong>å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨:</strong> æ§åˆ¶æƒä¼šè½¬ç§»åˆ°ç›®æ ‡ servletï¼Œæ‰§è¡Œå…¶ service() æ–¹æ³• (è¿›è€Œè°ƒç”¨ doGet(), doPost() ç­‰)ã€‚</li>
</ul>
<p><strong>è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº:</strong> è¿‡æ»¤å™¨é“¾çš„æ‰§è¡Œé¡ºåºä¸å®ƒä»¬åœ¨ web.xml ä¸­çš„å£°æ˜é¡ºåºæˆ–æ³¨è§£çš„é¡ºåºç›¸åŒã€‚</p>
<p><strong>è¯·æ±‚å¤„ç†æµç¨‹:</strong> ä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´è¿‡æ»¤æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ã€‚</li>
<li>æœåŠ¡å™¨æ ¹æ® URL åŒ¹é…è¿‡æ»¤å™¨é“¾ã€‚</li>
<li>ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨æ‰§è¡Œ doFilter() æ–¹æ³•ã€‚</li>
<li>ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨è°ƒç”¨ chain.doFilter()ï¼Œå°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨æˆ– servletã€‚</li>
<li>é‡å¤æ­¥éª¤ 4ï¼Œç›´åˆ°æœ€åä¸€ä¸ªè¿‡æ»¤å™¨æ‰§è¡Œå®Œæ¯•ã€‚</li>
<li>ç›®æ ‡ servlet æ‰§è¡Œ service() æ–¹æ³•å¤„ç†è¯·æ±‚ã€‚</li>
<li>å“åº”è¿”å›å®¢æˆ·ç«¯ï¼Œè¿‡æ»¤å™¨é“¾åå‘æ‰§è¡Œï¼Œæ¯ä¸ªè¿‡æ»¤å™¨å¯ä»¥å¯¹å“åº”è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
<h2 id="Listener">Listener</h2>
<p>ä¸€ä¸ªwebé¡¹ç›®ä¸€ä¸ªServletContextå¯¹è±¡</p>
<blockquote>
<p>å³ä½¿ä¸€ä¸ªé¡¹ç›®ä¸­æœ‰å¤šä¸ª Servletï¼Œå®ƒä»¬éƒ½å…±äº«åŒä¸€ä¸ª ServletContextã€‚ServletContext ä»£è¡¨æ•´ä¸ª Web åº”ç”¨ç¨‹åºï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ä¸åŒ Servlet ä¹‹é—´å…±äº«ä¿¡æ¯å’Œèµ„æºçš„æœºåˆ¶ã€‚</p>
</blockquote>
<h1>Spring</h1>
<p><a href="https://liaoxuefeng.com/books/java/spring/index.html">https://liaoxuefeng.com/books/java/spring/index.html</a></p>
<h2 id="IoC">IoC</h2>
<p>Inversion of Control æ§åˆ¶åè½¬</p>
<ul>
<li>æ ¸å¿ƒæ˜¯ BeanFactory å’Œ ApplicationContext</li>
<li>é€šè¿‡åå°„æœºåˆ¶å®ä¾‹åŒ–beanå¹¶åˆ›å»ºbeanä¹‹é—´çš„ä¾èµ–å…³ç³»</li>
<li>ç®¡ç†beançš„ç”Ÿå‘½å‘¨æœŸ</li>
</ul>
<h2 id="AoP">AoP</h2>
<p>Aspect-Oriented-Programming é¢å‘åˆ‡é¢ç¼–ç¨‹</p>
<ul>
<li>æ ¸å¿ƒæ˜¯ProxyFactory</li>
<li>ä¸¤ç§ä»£ç†æ–¹å¼ï¼šJDKåŠ¨æ€ä»£ç†å’ŒCGLIB</li>
<li>é€šè¿‡ç»‡å…¥åˆ‡é¢æ¥å®ç°åŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤</li>
</ul>
<h3 id="JDKåŠ¨æ€ä»£ç†å’ŒCGLIB">JDKåŠ¨æ€ä»£ç†å’ŒCGLIB</h3>
<p><a href="https://open8gu.com/framework/spring/tc8yg7e1e6aa7khd/">https://open8gu.com/framework/spring/tc8yg7e1e6aa7khd/</a></p>
<p><strong>æ— æ³•AOP/beançš„æƒ…å†µ</strong></p>
<p>1.ç±»ä¸ºfinalç±»ä¸”æ²¡æœ‰å®ç°æ¥å£</p>
<p>æ³¨æ„ï¼šfinalç±»å¯ä»¥é€šè¿‡åå°„åˆ›å»º</p>
<blockquote>
<p>å¦‚æœç±»å®ç°äº†æ¥å£ï¼Œå¯ä»¥é€šè¿‡JDKåŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç°AOPï¼›å¦‚æœç±»ä¸ä¸ºFinalï¼Œå¯ä»¥é€šè¿‡CGLIBç»§æ‰¿çš„æ–¹å¼å®ç°AOP</p>
</blockquote>
<p>2.æ„é€ å‡½æ•°ä¸ºprivateçš„ç±»</p>
<p>æ³¨æ„ï¼šæ„é€ å‡½æ•°ä¸ºprivateçš„ç±»ä»ç„¶å¯ä»¥ä½¿ç”¨åå°„åˆ›å»ºï¼Œå³ä½¿é€šè¿‡åå°„ï¼Œè®¿é—® <code>private</code> æ„é€ å‡½æ•°ä¹Ÿéœ€è¦é¢å¤–çš„æƒé™ï¼ˆå¦‚è°ƒç”¨ <code>setAccessible(true)</code>ï¼‰ï¼Œè€Œ Spring é»˜è®¤ä¸ä¼šè¿™æ ·åšï¼Œå› ä¸ºè¿™å¯èƒ½è¿åç±»çš„è®¾è®¡æ„å›¾ã€‚</p>
<h2 id="IoCå®¹å™¨ä¸IoCå¯¹è±¡">IoCå®¹å™¨ä¸IoCå¯¹è±¡</h2>
<p><strong>Bean å¯¹è±¡</strong>é€šå¸¸è¢«ç§°ä¸º<strong>IoC å¯¹è±¡</strong>ï¼Œå®ƒä»¬æ˜¯ç”± Spring çš„ <strong>IoC å®¹å™¨</strong>è´Ÿè´£ç®¡ç†çš„å¯¹è±¡ã€‚</p>
<p>Spring IoC å®¹å™¨çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p>
<ul>
<li>
<p><strong>åŸºäº XML é…ç½®</strong>ï¼šå½“åŠ è½½ XML é…ç½®æ–‡ä»¶æ—¶ï¼Œå®¹å™¨ä¼šåˆå§‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Main.java</span></span><br><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ²¡æœ‰springæ³¨è§£å“¦ï¼Œæ­¤æ—¶springå®¹å™¨å°šæœªå¯åŠ¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;application.xml&quot;</span>);  <span class="comment">// å¯åŠ¨springå®¹å™¨å¹¶åŸºäºapplication.xmlæ‰«æå¹¶åˆ›å»ºbean</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– UserService Bean</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> context.getBean(UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ login æ–¹æ³•</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.login(<span class="string">&quot;bob@example.com&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        System.out.println(user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- application.xml --&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;emailService&quot;</span> class=<span class="string">&quot;com.example.EmailService&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;userService&quot;</span> class=<span class="string">&quot;com.example.UserService&quot;</span>&gt;</span><br><span class="line">        &lt;constructor-arg ref=<span class="string">&quot;emailService&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>åŸºäº Java é…ç½®ç±»</strong>ï¼šå½“æœ‰ <code>@Configuration</code> ç±»æ—¶ï¼ŒSpring ä¼šé€šè¿‡ Java é…ç½®ç±»åˆ›å»º IoC å®¹å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Main.java</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);  <span class="comment">// åŸºäºAppConfig.java æ‰«æ</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> context.getBean(UserService.class);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.login(<span class="string">&quot;bob@example.com&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        System.out.println(user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AppConfig.java</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserService <span class="title function_">userService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserService</span>(emailService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> EmailService <span class="title function_">emailService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EmailService</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="æ³¨è§£">æ³¨è§£</h2>
<p><strong>æ„é€ æ€§æ³¨è§£</strong>: è¢«æ„é€ æ€§æ³¨è§£æ ‡è®°çš„ç±»ï¼ŒSpringä¼šè‡ªåŠ¨ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°åˆ›å»ºè¯¥ç±»çš„Bean</p>
<ul>
<li>
<p>@Component: è¿™æ˜¯æœ€é€šç”¨çš„æ„é€ å‹æ³¨è§£ï¼Œå¯ä»¥ç”¨äºæ ‡è®°ä»»ä½•éœ€è¦è¢« Spring ç®¡ç†çš„ç±»ã€‚</p>
</li>
<li>
<p>@Service: ç”¨äºæ ‡è®°æœåŠ¡å±‚ç»„ä»¶ï¼Œé€šå¸¸åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚</p>
</li>
<li>
<p>@Repository: ç”¨äºæ ‡è®°æ•°æ®è®¿é—®å±‚ç»„ä»¶ï¼Œä¾‹å¦‚ DAO (Data Access Object) ç±»ã€‚</p>
</li>
<li>
<p>@Controller:</p>
<ul>
<li>ç”¨äºæ ‡è®° Web å±‚æ§åˆ¶å™¨ç»„ä»¶ï¼Œä¾‹å¦‚ Spring MVC ä¸­çš„æ§åˆ¶å™¨ç±»ã€‚</li>
<li>ä½¿ç”¨ @Controllerï¼Œéœ€è¦åœ¨æ¯ä¸ªå¤„ç† RESTful è¯·æ±‚çš„æ–¹æ³•ä¸Šæ·»åŠ  @ResponseBody æ³¨è§£ï¼Œä»¥ä¾¿å°†è¿”å›å€¼ä½œä¸ºå“åº”ä½“å‘é€ã€‚</li>
</ul>
</li>
<li>
<p>@Configuration: ç”¨äºæ ‡è®°é…ç½®ç±»ï¼Œé€šå¸¸åŒ…å« @Bean æ³¨è§£æ ‡è®°çš„æ–¹æ³•ï¼Œç”¨äºåˆ›å»º Beanã€‚</p>
</li>
<li>
<p>@RestController:</p>
<ul>
<li>ç”¨äºæ ‡è®° RESTful Web æœåŠ¡çš„æ§åˆ¶å™¨ç»„ä»¶ï¼Œç›¸å½“äº @Controller å’Œ @ResponseBody çš„ç»„åˆã€‚</li>
<li>ä½¿ç”¨ @RestControllerï¼Œæ‰€æœ‰æ–¹æ³•çš„è¿”å›å€¼éƒ½å°†è‡ªåŠ¨ä½œä¸ºå“åº”ä½“å‘é€ï¼Œæ— éœ€é¢å¤–æ·»åŠ  @ResponseBody æ³¨è§£ã€‚</li>
<li>ç¼–å†™RESTæ¥å£éœ€è¦å®šä¹‰<code>@RestController</code>ï¼Œç„¶åï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æ˜¯ä¸€ä¸ªAPIæ¥å£ï¼Œè¾“å…¥å’Œè¾“å‡ºåªè¦èƒ½è¢«Jacksonåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ä¸ºJSONå°±æ²¡æœ‰é—®é¢˜ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ä¾èµ–æ³¨å…¥æ³¨è§£ï¼š</strong></p>
<ul>
<li>
<p>@Autowiredï¼šç”¨äºè‡ªåŠ¨æ³¨å…¥ä¾èµ–</p>
<ul>
<li>é»˜è®¤æŒ‰ç…§ç±»å‹ï¼ˆbyTypeï¼‰è£…é…ä¾èµ–å¯¹è±¡ã€‚å¦‚æœæœ‰å¤šä¸ªç›¸åŒç±»å‹çš„ Beanï¼Œä¼šå°è¯•æŒ‰ç…§åç§°ï¼ˆbyNameï¼‰è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…çš„ Beanï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>å¯ä»¥ä½œç”¨äºæ„é€ å‡½æ•°ã€å­—æ®µã€Setter æ–¹æ³•ç­‰ã€‚</li>
</ul>
</li>
<li>
<p>@Resourceï¼šç”¨äºæ³¨å…¥ä¾èµ–</p>
<ul>
<li>é»˜è®¤æŒ‰ç…§åç§°ï¼ˆbyNameï¼‰è£…é…ä¾èµ–å¯¹è±¡ã€‚åç§°å¯ä»¥é€šè¿‡ name å±æ€§æŒ‡å®šï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨å­—æ®µåæˆ– setter æ–¹æ³•çš„å‚æ•°åä½œä¸ºåç§°ã€‚å¦‚æœæ‰¾ä¸åˆ°åç§°åŒ¹é…çš„ Beanï¼Œä¼šå›é€€åˆ°æŒ‰ç…§ç±»å‹ï¼ˆbyTypeï¼‰è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœä»ç„¶æ‰¾ä¸åˆ°åŒ¹é…çš„ Beanï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>å¯ä»¥ç”¨äºå­—æ®µå’Œ setter æ–¹æ³•ä¸Šï¼Œä¸èƒ½ç”¨äºæ„é€ å‡½æ•°å’Œé…ç½®æ–¹æ³•ä¸Šã€‚</li>
</ul>
</li>
<li>
<p>@Valueï¼šç”¨äºæ³¨å…¥å±æ€§å€¼ï¼Œå¯ä»¥æ³¨å…¥é…ç½®æ–‡ä»¶ä¸­çš„å€¼ã€ç³»ç»Ÿå±æ€§ã€ç¯å¢ƒå˜é‡ç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValueExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $&#123;&#125;è®¿é—®å¤–éƒ¨å±æ€§ï¼ˆé…ç½®æ–‡ä»¶ã€ç³»ç»Ÿå±æ€§ã€ç¯å¢ƒå˜é‡ï¼‰,ç®€å•å˜é‡æ›¿æ¢</span></span><br><span class="line">    <span class="comment">// #&#123;&#125;è¿è¡Œæ—¶è®¡ç®—è¡¨è¾¾å¼ï¼ŒåŠ¨æ€è®¡ç®—å€¼ã€æ¡ä»¶åˆ¤æ–­ã€é›†åˆæ“ä½œç­‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å…¥ application.properties æˆ– application.yml ä¸­çš„å±æ€§å€¼</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å…¥ç³»ç»Ÿå±æ€§</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.home&#125;&quot;)</span>  <span class="comment">// ç­‰åŒäº System.getProperty(&quot;user.home&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userHome;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å…¥ç¯å¢ƒå˜é‡ (éœ€è¦å…ˆè®¾ç½®ç¯å¢ƒå˜é‡)</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;MY_ENV_VAR&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String myEnvVar;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ SpEL è¡¨è¾¾å¼è®¾ç½®é»˜è®¤å€¼</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.description:Default Description&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appDescription;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å…¥å­—é¢é‡</span></span><br><span class="line">    <span class="meta">@Value(&quot;A hardcoded value&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hardcodedValue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å…¥æ•°ç»„ (application.properties: app.features=feature1,feature2,feature3)</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.features&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String[] appFeatures;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å…¥ List (éœ€è¦ Spring Boot 2.4 ä»¥ä¸Šç‰ˆæœ¬ï¼Œ application.properties: app.colors=red,green,blue)</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;$&#123;app.colors&#125;&#x27;.split(&#x27;,&#x27;)&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> java.util.List&lt;String&gt; appColors;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 + 2&#125;&quot;)</span> <span class="comment">// è®¡ç®— 1 + 2 çš„ç»“æœï¼Œç»“æœä¸º 3</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> sum;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;T(java.lang.Math).random() * 100.0&#125;&quot;)</span> <span class="comment">// è°ƒç”¨ Math.random() æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> randomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;beanName.methodName()&#125;&quot;)</span> <span class="comment">// è°ƒç”¨ Spring Bean çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> String result;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printValues</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;App Name: &quot;</span> + appName);</span><br><span class="line">        System.out.println(<span class="string">&quot;User Home: &quot;</span> + userHome);</span><br><span class="line">        System.out.println(<span class="string">&quot;My Env Var: &quot;</span> + myEnvVar);</span><br><span class="line">        System.out.println(<span class="string">&quot;App Description: &quot;</span> + appDescription);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hardcoded Value: &quot;</span> + hardcodedValue);</span><br><span class="line"></span><br><span class="line">        System.out.print(<span class="string">&quot;App Features: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(String feature : appFeatures) &#123;</span><br><span class="line">            System.out.print(feature + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        System.out.print(<span class="string">&quot;App Colors: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(String color : appColors) &#123;</span><br><span class="line">            System.out.print(color + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// application.properties ç¤ºä¾‹</span></span><br><span class="line"><span class="comment">// app.name=My Application</span></span><br><span class="line"><span class="comment">// app.description=A great application</span></span><br><span class="line"><span class="comment">// app.features=feature1,feature2,feature3</span></span><br><span class="line"><span class="comment">// app.colors=red,green,blue</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>ç”Ÿå‘½å‘¨æœŸæ³¨è§£ï¼š</strong></p>
<ul>
<li>@PostConstructï¼šç”¨äºæ ‡è®°åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨ Bean åˆ›å»ºåæ‰§è¡Œã€‚</li>
<li>@PreDestroyï¼šç”¨äºæ ‡è®°é”€æ¯æ–¹æ³•ï¼Œåœ¨ Bean é”€æ¯å‰æ‰§è¡Œã€‚</li>
</ul>
<p><strong>AOP ç›¸å…³æ³¨è§£ï¼š</strong></p>
<ul>
<li>
<p>@Aspectï¼šç”¨äºæ ‡è®°åˆ‡é¢ç±»ã€‚</p>
<p>ä¸€ä¸ªåˆ‡é¢ç±»å¯ä»¥å¯¹<strong>å¤šä¸ªç±»çš„å¤šä¸ªæ–¹æ³•</strong>è¿›è¡Œåˆ‡é¢å¢å¼ºï¼Œ</p>
<p>å¤šåˆ‡é¢ç±»ç¤ºä¾‹ï¼šä¾‹å¦‚ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª LoggingAspect ç”¨äºæ—¥å¿—è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ª SecurityAspect ç”¨äºå®‰å…¨æ§åˆ¶ï¼Œåˆ›å»ºä¸€ä¸ª TransactionAspect ç”¨äºäº‹åŠ¡ç®¡ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggingAspect</span> &#123;</span><br><span class="line">    <span class="comment">// åœ¨æ‰§è¡ŒUserServiceçš„æ¯ä¸ªæ–¹æ³•å‰æ‰§è¡Œ:</span></span><br><span class="line">    <span class="comment">// åˆ‡é¢å¢å¼ºUserServiceç±»çš„æ‰€æœ‰å…¬å…±æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(public * com.itranswarp.learnjava.service.UserService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAccessCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;[Before] do access check...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ‰§è¡ŒMailServiceçš„æ¯ä¸ªæ–¹æ³•å‰åæ‰§è¡Œ:</span></span><br><span class="line">    <span class="comment">// åˆ‡é¢å¢å¼ºMailServiceç±»çš„æ‰€æœ‰å…¬å…±æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Around(&quot;execution(public * com.itranswarp.learnjava.service.MailService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doLogging</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;[Around] start &quot;</span> + pjp.getSignature());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">retVal</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        System.err.println(<span class="string">&quot;[Around] done &quot;</span> + pjp.getSignature());</span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>  <span class="comment">// é…åˆ@Aspectä½¿ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Springçš„IoCå®¹å™¨å‘ç°é…ç½®ç±»å­˜åœ¨è¯¥æ³¨è§£åï¼Œå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¸¦æœ‰<code>@Aspect</code>çš„Beanï¼Œç„¶åæ ¹æ®æ¯ä¸ªæ–¹æ³•çš„<code>@Before</code>ã€<code>@Around</code>ç­‰æ³¨è§£æŠŠAOPæ³¨å…¥åˆ°ç‰¹å®šçš„Beanä¸­ã€‚</p>
</li>
<li>
<p>@Beforeã€@Afterã€@Around ç­‰ï¼šç”¨äºå®šä¹‰åˆ‡ç‚¹å’Œå¢å¼ºã€‚</p>
</li>
</ul>
<p><strong>äº‹åŠ¡ç®¡ç†æ³¨è§£ï¼š</strong></p>
<ul>
<li>
<p>@Transactionalï¼šç”¨äºå£°æ˜äº‹åŠ¡ï¼Œå¯ä»¥ä½œç”¨äºç±»æˆ–æ–¹æ³•</p>
<ul>
<li>
<p>è¡¨ç¤ºè¢«æ ‡è®°ç±»çš„æ‰€æœ‰<code>public</code>æ–¹æ³•/è¢«æ ‡è®°æ–¹æ³•å…·æœ‰äº‹åŠ¡æ”¯æŒ</p>
</li>
<li>
<p>ç±»çš„æ–¹æ³•æˆ–æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œå›æ»šå‘ç”Ÿ</p>
</li>
<li>
<p>å¯ä»¥é’ˆå¯¹æŒ‡å®šå¼‚å¸¸æŠ›å‡ºï¼Œå‘ç”Ÿå›æ»š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = &#123;RuntimeException.class, IOException.class&#125;)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>Web ç›¸å…³æ³¨è§£ï¼š</strong></p>
<ul>
<li>
<p>@RequestMappingï¼š</p>
<p>å°† HTTP è¯·æ±‚æ˜ å°„åˆ°æ§åˆ¶å™¨æ–¹æ³•;</p>
<p>å®šä¹‰ URL æ˜ å°„è§„åˆ™ï¼Œä¾‹å¦‚ /usersã€/users/{id} ç­‰;</p>
<p>æŒ‡å®š HTTP è¯·æ±‚æ–¹æ³•ï¼Œä¾‹å¦‚ GETã€POSTã€PUTã€DELETE ç­‰;</p>
<p>å®šä¹‰è¯·æ±‚å‚æ•°ï¼Œä¾‹å¦‚ @RequestParamã€@PathVariable ç­‰.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/&#123;id&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">createUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>@GetMappingã€@PostMapping ç­‰ï¼š@RequestMapping çš„ç‰¹åŒ–ï¼Œç”¨äºç®€åŒ–è¯·æ±‚æ˜ å°„çš„é…ç½®ã€‚</p>
</li>
<li>
<p>@PathVariableï¼šç”¨äºè·å– URL ä¸­çš„è·¯å¾„å˜é‡ã€‚</p>
</li>
<li>
<p>@RequestParamï¼šç”¨äºè·å–è¯·æ±‚å‚æ•°ã€‚</p>
</li>
<li>
<p>@RequestBodyï¼šç”¨äºå°† HTTP è¯·æ±‚ä½“è½¬æ¢ä¸ºæ–¹æ³•å‚æ•°ã€‚</p>
</li>
<li>
<p>@ResponseBody:</p>
<ul>
<li>æ–¹æ³•çš„è¿”å›å€¼è½¬æ¢ä¸ºæŒ‡å®šçš„æ ¼å¼ï¼Œä¾‹å¦‚ JSON æˆ– XMLï¼Œå¹¶å°†å…¶ä½œä¸ºå“åº”ä½“å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>åº”ç”¨äºæ–¹æ³•ä¸Š, åªå¯¹è¯¥æ–¹æ³•ç”Ÿæ•ˆ; åº”ç”¨äºç±»ä¸Š, å¯¹è¯¥ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ç”Ÿæ•ˆã€‚</li>
</ul>
</li>
</ul>
<p><strong>æµ‹è¯•ç›¸å…³æ³¨è§£ï¼š</strong></p>
<ul>
<li>@SpringBootTestï¼šç”¨äºæ ‡è®° Spring Boot æµ‹è¯•ç±»ã€‚</li>
<li>@MockBeanï¼šç”¨äºæ¨¡æ‹Ÿ Beanï¼Œæ–¹ä¾¿è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚</li>
</ul>
<p><strong>å…¶ä»–æ³¨è§£ï¼š</strong></p>
<ul>
<li>@Scopeï¼šç”¨äºæŒ‡å®š Bean çš„ä½œç”¨åŸŸã€‚</li>
<li>@ComponentScan
<ul>
<li>å¦‚æœæŸç±»è¢«æ³¨è§£<code>@ComponentScan</code>æ ‡æ³¨ï¼Œåˆ™ä¼šæ‰«ææ ‡æ³¨è¯¥æ³¨è§£çš„ç±»æ‰€åœ¨åŒ…åŠå…¶å­åŒ…ä¸­çš„æ‰€æœ‰ç»„ä»¶ï¼ˆåŒ…æ‹¬ <code>@Component</code>ã€<code>@Service</code>ã€<code>@Repository</code> ç­‰ï¼‰</li>
<li>å¦‚æœè¢« <code>@ComponentScan</code> æ ‡æ³¨çš„ <code>MyApplication</code> ç±»ä½äº <code>com.example</code> åŒ…ä¸‹ï¼ŒSpring ä¼šé»˜è®¤æ‰«æ <code>com.example</code> åŒ…åŠå…¶æ‰€æœ‰å­åŒ…ï¼Œä¾‹å¦‚ <code>com.example.domain</code>ã€‚</li>
</ul>
</li>
<li>@Lazyï¼šç”¨äºå»¶è¿Ÿåˆå§‹åŒ– Beanã€‚</li>
<li>@Profileï¼šç”¨äºæ ¹æ®ä¸åŒçš„ç¯å¢ƒæ¿€æ´»ä¸åŒçš„ Beanã€‚</li>
<li>@Conditionalï¼šç”¨äºæ ¹æ®æ¡ä»¶åˆ›å»º Beanã€‚</li>
<li><strong>@PropertySource:</strong>
<ul>
<li><strong>ä½œç”¨:</strong> å°†å¤–éƒ¨å±æ€§æ–‡ä»¶åŠ è½½åˆ° Spring çš„ Environment ä¸­ã€‚è¿™äº›å±æ€§æ–‡ä»¶å¯ä»¥æ˜¯ properties æ–‡ä»¶ã€yaml æ–‡ä»¶æˆ–å…¶ä»–æ ¼å¼çš„æ–‡ä»¶ã€‚</li>
<li><strong>ä½¿ç”¨åœºæ™¯:</strong> ä¸»è¦ç”¨äºå¯¼å…¥é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ application.propertiesã€application.yml ç­‰ï¼Œæˆ–è€…è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ã€‚</li>
<li><strong>ç»‘å®šæ–¹å¼:</strong> @PropertySource <strong>ä¸ä¼š</strong>ç›´æ¥å°†å±æ€§ç»‘å®šåˆ° Java Bean ä¸Šã€‚å®ƒåªæ˜¯å°†å±æ€§åŠ è½½åˆ° Environment ä¸­ï¼Œä½¿ç”¨ @Value æ³¨è§£æˆ– Environment å¯¹è±¡æ¥è®¿é—®è¿™äº›å±æ€§ã€‚</li>
</ul>
</li>
<li><strong>@ConfigurationProperties:</strong>
<ul>
<li><strong>ä½œç”¨:</strong> å°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§ç»‘å®šåˆ°ä¸€ä¸ª Java Bean ä¸Šã€‚</li>
<li><strong>ä½¿ç”¨åœºæ™¯:</strong> ä¸»è¦ç”¨äºå°†ä¸€ç»„ç›¸å…³çš„é…ç½®å±æ€§ç»„ç»‡æˆä¸€ä¸ª Java Beanï¼Œæ–¹ä¾¿ç®¡ç†å’Œä½¿ç”¨ã€‚</li>
<li><strong>ç»‘å®šæ–¹å¼:</strong> @ConfigurationProperties ä¼šè‡ªåŠ¨å°†é…ç½®æ–‡ä»¶ä¸­ä¸ Bean å±æ€§åç§°åŒ¹é…çš„å±æ€§å€¼æ³¨å…¥åˆ° Bean ä¸­ã€‚æ”¯æŒæ¾æ•£ç»‘å®šï¼ˆrelaxed bindingï¼‰ï¼Œä¾‹å¦‚ my-property å¯ä»¥ç»‘å®šåˆ° myProperty å±æ€§ã€‚</li>
</ul>
</li>
</ul>
<h3 id="Resource-ä¸-Autowired"><code>@Resource</code> ä¸ <code>@Autowired</code></h3>
<p><strong><code>@Autowired</code> å’Œ <code>@Resource</code> çš„æ³¨å…¥æ–¹å¼</strong></p>
<p><strong>å­—æ®µæ³¨å…¥ï¼š</strong></p>
<ul>
<li>
<p>ç›´æ¥åœ¨å­—æ®µä¸Šä½¿ç”¨ <code>@Autowired</code> æˆ– <code>@Resource</code>ï¼ŒSpring ä¼šé€šè¿‡åå°„å°†ä¾èµ–æ³¨å…¥åˆ°å­—æ®µä¸­ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AnotherComponent anotherComponent;<span class="comment">// å­—æ®µæ³¨å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>setter æ–¹æ³•æ³¨å…¥ï¼š</strong></p>
<ul>
<li>
<p>åœ¨ setter æ–¹æ³•ä¸Šä½¿ç”¨ <code>@Autowired</code> æˆ– <code>@Resource</code>ï¼ŒSpring ä¼šè°ƒç”¨è¯¥ setter æ–¹æ³•æ³¨å…¥ä¾èµ–ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AnotherComponent anotherComponent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAnotherComponent</span><span class="params">(AnotherComponent anotherComponent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.anotherComponent = anotherComponent;<span class="comment">// setter æ³¨å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>æ„é€ æ–¹æ³•æ³¨å…¥ï¼š</strong></p>
<ul>
<li>
<p>åœ¨æ„é€ æ–¹æ³•ä¸Šä½¿ç”¨ <code>@Autowired</code>ï¼ŒSpring ä¼šé€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥ä¾èµ–ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnotherComponent anotherComponent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyComponent</span><span class="params">(AnotherComponent anotherComponent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.anotherComponent = anotherComponent;<span class="comment">// æ„é€ æ–¹æ³•æ³¨å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p><strong>æ„é€ æ–¹æ³•æ³¨å…¥ä¸æ˜¾å¼ä½¿ç”¨ <code>@Autowired</code> æˆ– <code>@Resource</code></strong></p>
<ul>
<li>
<p><strong>Spring 4.3 åŠä»¥ä¸Šç‰ˆæœ¬</strong>ï¼š</p>
<ul>
<li>
<p>å¦‚æœç±»åªæœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼ŒSpring ä¼šè‡ªåŠ¨å°†å…¶ç”¨äºä¾èµ–æ³¨å…¥ï¼Œ<strong>ä¸éœ€è¦æ˜¾å¼æ·»åŠ  <code>@Autowired</code></strong>ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnotherComponent anotherComponent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyComponent</span><span class="params">(AnotherComponent anotherComponent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.anotherComponent = anotherComponent;<span class="comment">// è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¿™æ˜¯ Spring å®˜æ–¹æ¨èçš„æ„é€ æ–¹æ³•æ³¨å…¥æ–¹å¼ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>å¤šä¸ªæ„é€ æ–¹æ³•</strong>ï¼š</p>
<ul>
<li>
<p>å¦‚æœç±»æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œå¿…é¡»æ˜¾å¼ä½¿ç”¨ <code>@Autowired</code> æ¥æŒ‡å®šå“ªä¸ªæ„é€ æ–¹æ³•ç”¨äºä¾èµ–æ³¨å…¥ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnotherComponent anotherComponent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyComponent</span><span class="params">(AnotherComponent anotherComponent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.anotherComponent = anotherComponent;<span class="comment">// æ˜¾å¼æ³¨å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyComponent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.anotherComponent = <span class="literal">null</span>;<span class="comment">// é»˜è®¤æ„é€ æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><code>@Resource</code> ä¸æ”¯æŒæ„é€ æ–¹æ³•æ³¨å…¥ï¼š</p>
<ul>
<li><code>@Resource</code> åªèƒ½ç”¨äºå­—æ®µæ³¨å…¥å’Œ setter æ–¹æ³•æ³¨å…¥ï¼Œ<strong>ä¸èƒ½ç”¨äºæ„é€ æ–¹æ³•æ³¨å…¥</strong>ã€‚</li>
</ul>
</li>
</ul>
<p><strong><code>@Resource</code> çš„è®¾è®¡ç›®çš„å’Œè¡Œä¸º</strong></p>
<p><strong>è®¾è®¡ç›®çš„ï¼š</strong></p>
<ul>
<li><code>@Resource</code> æ˜¯ Java æ ‡å‡†æ³¨è§£ï¼ˆ<code>javax.annotation.Resource</code>ï¼‰ï¼Œæœ€åˆæ˜¯ä¸º Java EE è®¾è®¡çš„ï¼Œç”¨äºä¾èµ–æ³¨å…¥ã€‚ä¸ä¾èµ–äºç‰¹å®šçš„æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•ç¬¦åˆ Java EE æ ‡å‡†çš„åº”ç”¨ä¸­ä½¿ç”¨ã€‚</li>
<li>é»˜è®¤æŒ‰åç§°ï¼ˆbyNameï¼‰è¿›è¡Œæ³¨å…¥ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šåç§°ï¼Œåˆ™ä¼šæŒ‰ç±»å‹ï¼ˆbyTypeï¼‰è¿›è¡Œæ³¨å…¥ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„ beanï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¯ä»¥é€šè¿‡ <code>@Resource(name = &quot;beanName&quot;, type = MyBean.class)</code> æ¥æŒ‡å®šç±»å‹ï¼Œé¿å…å¼‚å¸¸ã€‚</li>
</ul>
<p><strong>è¡Œä¸ºï¼š</strong></p>
<ul>
<li><code>@Resource</code> åªèƒ½ç”¨äº<strong>å­—æ®µæ³¨å…¥</strong>å’Œ<strong>setter æ–¹æ³•æ³¨å…¥</strong>ï¼Œå› ä¸ºå®ƒä¾èµ–äº Java çš„åå°„æœºåˆ¶æ¥ç›´æ¥è®¿é—®å­—æ®µæˆ–è°ƒç”¨ setter æ–¹æ³•ã€‚</li>
<li><code>@Resource</code> ä¸æ”¯æŒæ„é€ æ–¹æ³•æ³¨å…¥ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è®¾è®¡ç”¨äºå¤„ç†æ„é€ æ–¹æ³•çš„é€»è¾‘ã€‚</li>
</ul>
<p><strong><code>@Autowired</code> çš„è®¾è®¡ç›®çš„å’Œè¡Œä¸º</strong></p>
<p><strong>è®¾è®¡ç›®çš„ï¼š</strong></p>
<ul>
<li><code>@Autowired</code> æ˜¯ Spring æ¡†æ¶çš„æ³¨è§£ï¼Œä¾èµ–äº Spring æ¡†æ¶ã€‚</li>
<li>é»˜è®¤æŒ‰ç±»å‹ï¼ˆbyTypeï¼‰è¿›è¡Œæ³¨å…¥ã€‚å¦‚æœæœ‰å¤šä¸ªç›¸åŒç±»å‹çš„ beanï¼Œä¼šæŒ‰åç§°ï¼ˆbyNameï¼‰è¿›è¡ŒåŒ¹é…ï¼ŒåŒæ—¶æ”¯æŒ<strong>æ„é€ æ–¹æ³•æ³¨å…¥</strong>ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring ä¼šè¦æ±‚è¢«æ³¨å…¥çš„ bean å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¯ä»¥é€šè¿‡ <code>@Autowired(required = false)</code> æ¥å…è®¸æ³¨å…¥ä¸º <code>null</code>ã€‚</li>
</ul>
<p><strong>è¡Œä¸ºï¼š</strong></p>
<ul>
<li><code>@Autowired</code> å¯ä»¥ç”¨äº<strong>å­—æ®µæ³¨å…¥</strong>ã€<strong>setter æ–¹æ³•æ³¨å…¥</strong>å’Œ<strong>æ„é€ æ–¹æ³•æ³¨å…¥</strong>ã€‚</li>
<li>å¯¹äºæ„é€ æ–¹æ³•æ³¨å…¥ï¼Œ<code>@Autowired</code> ä¼šé€šè¿‡ Spring çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œé€‰æ‹©åˆé€‚çš„æ„é€ æ–¹æ³•å¹¶æ³¨å…¥ä¾èµ–ã€‚</li>
</ul>
<h2 id="BeanFactory-FactoryBean">BeanFactory &amp; FactoryBean</h2>
<p>ref: <a href="https://open8gu.com/framework/spring/dhzlrik2ylop354g/">https://open8gu.com/framework/spring/dhzlrik2ylop354g/</a></p>
<p><strong>BeanFactory</strong></p>
<p><code>BeanFactory</code> æ˜¯ Spring ä¸­ç”¨äºç®¡ç† Bean ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒç»„ä»¶ï¼ŒSpring å®˜æ–¹æ–‡æ¡£å°†å…¶ç§°ä¸º IOC å®¹å™¨ï¼Œå®ƒå³æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¿—ç§°çš„ â€œSpring å®¹å™¨â€ã€‚</p>
<p><code>BeanFactory</code> æ˜¯æœ€é¡¶çº§çš„æ¥å£ï¼Œé‡Œé¢å®šä¹‰äº†è·å–å’Œåˆ›å»º Bean çš„æœ€åŸºæœ¬æ–¹æ³•ï¼Œå®ƒä¸‹é¢åˆæ ¹æ®åŠŸèƒ½å’ŒæŠ½è±¡çº§åˆ«ç»†åˆ†äº”ä¸ªæ¥å£ï¼š</p>
<ul>
<li><strong>ListableBeanFactory</strong>ï¼šæ‰©å±•äº†å¯¹ Bean çš„æ‰¹é‡æ“ä½œï¼Œæ¯”å¦‚è·å–æ‰€æœ‰ Bean çš„åç§°ï¼Œæˆ–è€…æŒ‰ç…§ç±»å‹è·å– Bean ç­‰ï¼ˆæˆ‘ä»¬å¸¸ç”¨çš„ <code>getBeansOfType</code> æ–¹æ³•å°±æ˜¯å®ƒæä¾›çš„ï¼‰ã€‚</li>
<li><strong>HierarchicalBeanFactory</strong>ï¼šç”¨äºæ”¯æŒå±‚æ¬¡æ€§çš„ <code>BeanFactory</code> ç»“æ„ï¼Œä»è€Œå®ç° <code>BeanFactory</code> çš„åµŒå¥—ï¼Œå½¢æˆçˆ¶å­å…³ç³»ã€‚</li>
<li><strong>AutowireCapableBeanFactory</strong>ï¼šç”¨äºæä¾›æä¾›å¯¹ Bean è‡ªåŠ¨è£…é…çš„æ”¯æŒã€‚</li>
<li><strong>ConfigurableBeanFactory</strong>ï¼šå®ƒç»§æ‰¿äº† <code>AutowireCapableBeanFactory</code> å’Œ <code>SingletonBeanRegistry</code> ï¼Œç”¨äºæä¾›åŒ…æ‹¬ <code>Scope</code> ç®¡ç†ã€ç±»åŠ è½½å™¨ã€ä¸Šçº§å·¥å‚ã€è¡¨è¾¾å¼è§£æå™¨â€¦â€¦ç­‰ç­‰å„ç§é…ç½®é¡¹ã€‚</li>
<li><strong>ConfigurableListableBeanFactory</strong>ï¼šç»§æ‰¿äº† <code>ConfigurableBeanFactory</code> å’Œ <code>ListableBeanFactory</code>ï¼Œæ˜¯é›†å…¨éƒ¨ <code>BeanFactory</code> æ¥å£ä¹‹å¤§æˆè€…ã€‚</li>
</ul>
<p>å®ƒçš„æœ€åº•å±‚å®ç°ç±»æ˜¯ <code>DefaultListableBeanFactory</code>ï¼Œå®ƒç›´æ¥æˆ–é—´æ¥å®ç°äº†æ‰€æœ‰ <code>BeanFactory</code> æ¥å£ï¼Œæ˜¯åœ¨é¡¹ç›®ä¸­æœ€å¸¸ç”¨çš„å®ç°ç±»ã€‚</p>
<p>åœ¨æ¯”è¾ƒæ—©æœŸçš„ç‰ˆæœ¬ä¸­ï¼ŒSpring åŸºäº <code>DefaultListableBeanFactory</code> æä¾›äº† <code>XmlBeanFactory</code> å®ƒç›¸å½“äºä¸€ä¸ªå…·å¤‡æ ¹æ® XML æ–‡ä»¶åŠ è½½ Bean å®šä¹‰åŠŸèƒ½çš„ <code>DefaultListableBeanFactory</code>ã€‚</p>
<p>è€Œåœ¨æ›´é«˜çš„ç‰ˆæœ¬ï¼ŒSpring åˆ™æä¾›äº† <code>ApplicationContext</code> æ¥å£ï¼Œå®ƒç»§æ‰¿äº† <code>BeanFactory</code>ï¼Œå¹¶ä¸”é¢å¤–é€šè¿‡å…¶ä»–æ¥å£è·å¾—äº†åŠ è½½èµ„æºã€å›½é™…åŒ–ã€æ—¶é—´ç­‰æ‰©å±•åŠŸèƒ½ã€‚</p>
<p><strong>FactoryBean</strong></p>
<p>Spring ä¸­çš„ <code>FactoryBean</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œå®ç°äº†è¯¥æ¥å£çš„ Bean å˜ä¸ºä¸“é—¨ç”¨æ¥åˆ›å»ºæŸç§ç‰¹å®šç±»å‹å¯¹è±¡çš„å·¥å‚ã€‚</p>
<p>å®ƒè¢«å¹¿æ³›ç”¨äºåˆ›å»ºä¸€äº›ï¼š</p>
<ul>
<li><strong>æ— æ³•é€šè¿‡æ­£å¸¸çš„æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡</strong>ï¼šæ¯”è¾ƒå…¸å‹çš„æ˜¯å„ç§ä»£ç†ï¼Œæ¯”å¦‚ Dubbo ä½¿ç”¨ <code>ReferenceBean</code> åˆ›å»º RPC æ¥å£çš„ä»£ç†å¯¹è±¡ï¼ŒMybatis ä½¿ç”¨ <code>MapperFactoryBean</code> æ¥åˆ›å»º Mapper æ¥å£ä»£ç†ã€‚</li>
<li><strong>åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚çš„å¯¹è±¡</strong>ï¼šæ¯”è¾ƒå…¸å‹çš„æ˜¯ <code>SqlSession</code>ï¼Œ æ¯”å¦‚ JPA å’Œ Myabtis éƒ½é€‰æ‹©é€šè¿‡ä¸€ä¸ª <code>SqlSessionFactoryBean</code> æ¥åˆ›å»ºå®ƒã€‚</li>
</ul>
<p>è¯¥æ¥å£ä¸­å®šä¹‰äº†<strong>ä¸‰ä¸ªæ–¹æ³•</strong>ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><code>getObject</code> ï¼šç”¨äºä»å·¥å‚ä¸­è·å–ä¸€ä¸ª Bean å®ä¾‹ã€‚</li>
<li><code>getObjectType</code>ï¼šè·å–å®ä¾‹çš„ç±»å‹ã€‚</li>
<li><code>isSingleton</code>ï¼šåˆ¤æ–­è¿™ä¸ª Bean æ˜¯å¦æ˜¯å•ä¾‹çš„ã€‚</li>
</ul>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœ <code>FactoryBean</code> çš„ <code>isSingleton</code> æ–¹æ³•è¿”å› <code>true</code>ï¼Œåˆ™å…¶ç”Ÿäº§çš„å¯¹è±¡å°±ä¼šæ˜¯å•ä¾‹çš„ï¼Œåä¹‹åˆ™ä¸ºå¤šä¾‹çš„ã€‚ä¸è¿‡ï¼Œå¦‚æœ <code>FactoryBean</code> æœ¬èº«æ˜¯å¤šä¾‹çš„ï¼Œé‚£ä¹ˆæ— è®º<code>isSingleton</code> æ–¹æ³•æ˜¯å¦è¿”å› <code>true</code>ï¼Œ å…¶äº§ç‰©ä¹Ÿå°†å˜ä¸ºå¤šä¾‹çš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>FactoryBean</code> çš„ beanName ä» Spring å®¹å™¨è·å¾—<strong>å…¶ç”Ÿäº§çš„å¯¹è±¡</strong>ï¼Œè€Œå½“éœ€è¦ä» Spring å®¹å™¨ä¸­è·å– <code>FactoryBean</code> æœ¬èº«æ—¶ï¼Œéœ€è¦åœ¨ beanName å‰åŠ  <code>&amp;</code> ç¬¦å·ã€‚</p>
<h2 id="Beançš„åˆ›å»º">Beançš„åˆ›å»º</h2>
<h3 id="ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥-ä½¿ç”¨-Setter-æ–¹æ³•æ³¨å…¥">ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ &amp;&amp; ä½¿ç”¨ Setter æ–¹æ³•æ³¨å…¥</h3>
<p>æ„é€ æ–¹æ³•æ³¨å…¥</p>
<ul>
<li>ä¸å¯å˜æ€§ï¼šä¾èµ–é€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥åï¼Œé€šå¸¸ä¼šè¢«å£°æ˜ä¸º <code>final</code>ï¼Œç¡®ä¿ä¾èµ–ä¸å¯å˜ã€‚</li>
<li>å¼ºåˆ¶ä¾èµ–ï¼šæ„é€ æ–¹æ³•è¦æ±‚æ‰€æœ‰ä¾èµ–å¿…é¡»åœ¨å®ä¾‹åŒ–æ—¶æ³¨å…¥ï¼Œç¡®ä¿ Bean åœ¨åˆ›å»ºåæ˜¯å®Œå…¨åˆå§‹åŒ–çš„ã€‚</li>
</ul>
<p>setteræ–¹æ³•æ³¨å…¥</p>
<ul>
<li>çµæ´»æ€§ï¼šSetter æ–¹æ³•å…è®¸åœ¨ Bean å®ä¾‹åŒ–ä¹‹åæ³¨å…¥ä¾èµ–ï¼Œå› æ­¤å¯ä»¥åŠ¨æ€åœ°ä¿®æ”¹ä¾èµ–ã€‚</li>
<li>å¯é€‰ä¾èµ–ï¼šä¾èµ–å¯ä»¥é€šè¿‡ setter æ–¹æ³•è®¾ç½®ä¸ºå¯é€‰ï¼Œå³ä½¿æ²¡æœ‰æ³¨å…¥ä¾èµ–ï¼ŒBean ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
<p><strong>æ„é€ å‡½æ•°æ³¨å…¥</strong></p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªç±»ï¼š<code>UserService</code> å’Œ <code>EmailService</code>ï¼Œ<code>UserService</code> ä¾èµ–äº <code>EmailService</code>ã€‚</p>
<p><strong>EmailService ç±»ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailService</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendEmail</span><span class="params">(String to, String subject, String body)</span> &#123;</span><br><span class="line">    	System.out.println(<span class="string">&quot;Sending email to &quot;</span> + to + <span class="string">&quot;:\nSubject: &quot;</span> + subject + <span class="string">&quot;\nBody: &quot;</span> + body);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserService ç±»ï¼š</strong></p>
<p>ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ <code>EmailService</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EmailService emailService;  <span class="comment">// ç›®æ ‡å­—æ®µå¯ä»¥æ˜¯ finalï¼Œä½†ä¸å¼ºåˆ¶å¿…é¡»æ˜¯ finalï¼Œå¼ºçƒˆå»ºè®®åœ¨æ„é€ å‡½æ•°æ³¨å…¥æ—¶å°†ä¾èµ–å­—æ®µå£°æ˜ä¸º finalï¼Œå› ä¸ºè¿™å¯ä»¥ç¡®ä¿ä¾èµ–åœ¨å¯¹è±¡åˆ›å»ºæ—¶è¢«å®Œå…¨åˆå§‹åŒ–ï¼Œè€Œä¸”ä¸ä¼šåœ¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¸­è¢«ä¿®æ”¹ï¼Œä»è€Œæä¾›æ›´é«˜çš„å®‰å…¨æ€§å’Œä¸å¯å˜æ€§ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°æ³¨å…¥</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ²¡æœ‰ä½¿ç”¨@Autowiredï¼Œä½†æ˜¯å±æ€§emailServiceè¢«è‡ªåŠ¨æ³¨å…¥bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(EmailService emailService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.emailService = emailService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerUser</span><span class="params">(String username, String email)</span> &#123;</span><br><span class="line">        <span class="comment">// ... ç”¨æˆ·æ³¨å†Œé€»è¾‘ ...</span></span><br><span class="line">        emailService.sendEmail(email, <span class="string">&quot;Welcome!&quot;</span>, <span class="string">&quot;Thank you for registering.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Setter æ–¹æ³•æ³¨å…¥</strong></p>
<p>ä»ä½¿ç”¨ <code>UserService</code> å’Œ <code>EmailService</code>ï¼Œä½¿ç”¨ Setter æ–¹æ³•æ³¨å…¥ <code>EmailService</code>ã€‚</p>
<p><strong>EmailService ç±»ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendEmail</span><span class="params">(String to, String subject, String body)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Sending email to &quot;</span> + to + <span class="string">&quot;:\nSubject: &quot;</span> + subject + <span class="string">&quot;\nBody: &quot;</span> + body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserService ç±»ï¼š</strong></p>
<p>ä½¿ç”¨ Setter æ–¹æ³•æ³¨å…¥ <code>EmailService</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;  </span><br><span class="line">    <span class="comment">// ä¾èµ–ä¸èƒ½æ˜¯ final çš„ï¼ï¼ï¼ï¼Œfinal å­—æ®µå¿…é¡»åœ¨å¯¹è±¡æ„é€ æ—¶è¢«èµ‹å€¼ï¼ˆå³é€šè¿‡æ„é€ å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">    <span class="comment">// å³ä½¿å­—æ®µçš„è®¿é—®çº§åˆ«æ˜¯ privateï¼ŒSpring ä»ç„¶å¯ä»¥ä½¿ç”¨åå°„æ¥ç»•è¿‡ Java çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œç›´æ¥ä¸ºç§æœ‰å­—æ®µè®¾ç½®å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setter æ–¹æ³•æ³¨å…¥</span></span><br><span class="line">    <span class="meta">@Autowired</span>  <span class="comment">// å°†Setteræ–¹æ³•æ ‡è®°ä¸º@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmailService</span><span class="params">(EmailService emailService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.emailService = emailService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerUser</span><span class="params">(String username, String email)</span> &#123;</span><br><span class="line">        <span class="comment">// ... ç”¨æˆ·æ³¨å†Œé€»è¾‘ ...</span></span><br><span class="line">        emailService.sendEmail(email, <span class="string">&quot;Welcome!&quot;</span>, <span class="string">&quot;Thank you for registering.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆä¸ç›´æ¥å°† <code>@Autowired</code> æ ‡è®°åœ¨å±æ€§ä¸Šï¼Ÿ</strong></p>
<p>å®é™…ä¸Šï¼Œ<strong>Spring æ”¯æŒå°† <code>@Autowired</code> ç›´æ¥æ ‡è®°åœ¨å±æ€§ä¸Š</strong>ï¼Œè¿™ç§æ–¹å¼å«åš<strong>å­—æ®µæ³¨å…¥</strong>ï¼ˆField Injectionï¼‰ã€‚è¿™ç§æ³¨å…¥æ–¹å¼ä¸éœ€è¦æä¾› <code>set</code> æ–¹æ³•ï¼ŒSpring ä¼šç›´æ¥é€šè¿‡åå°„ä¸ºå±æ€§æ³¨å…¥ä¾èµ–ã€‚ç„¶è€Œï¼Œå­—æ®µæ³¨å…¥é€šå¸¸è¢«è®¤ä¸ºæ˜¯<strong>ä¸æ¨èçš„åšæ³•</strong>ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<p><strong>å­—æ®µæ³¨å…¥çš„ç¼ºç‚¹ï¼š</strong></p>
<ol>
<li><strong>ä¸åˆ©äºæµ‹è¯•</strong>ï¼šç›´æ¥å°† <code>@Autowired</code> æ³¨è§£æ ‡è®°åœ¨å­—æ®µä¸Šï¼Œä¾èµ–ä¼šé€šè¿‡åå°„æ³¨å…¥ã€‚è¿™æ ·ä¼šè®©å•å…ƒæµ‹è¯•å˜å¾—å›°éš¾ï¼Œå› ä¸ºæ— æ³•ç›´æ¥é€šè¿‡æ„é€ å‡½æ•°æˆ– Setter æ–¹æ³•ä¼ é€’ mock å¯¹è±¡ï¼Œè€Œæ˜¯å¿…é¡»ä½¿ç”¨åƒ <code>ReflectionTestUtils</code> è¿™æ ·çš„å·¥å…·æ¥æ‰‹åŠ¨è®¾ç½®ç§æœ‰å­—æ®µçš„ä¾èµ–ã€‚</li>
<li><strong>è¿èƒŒå°è£…åŸåˆ™</strong>ï¼šå­—æ®µæ³¨å…¥ç›´æ¥ä¿®æ”¹ç±»çš„ç§æœ‰å±æ€§ï¼Œè¿èƒŒäº†å¯¹è±¡çš„å°è£…æ€§åŸåˆ™ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œé€šå¸¸å¸Œæœ›å±æ€§é€šè¿‡æ„é€ å‡½æ•°æˆ– Setter æ–¹æ³•æ¥è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥è¢«å¤–éƒ¨å¹²é¢„ã€‚</li>
<li><strong>æ— æ³•æ”¯æŒ <code>final</code> å…³é”®å­—</strong>ï¼šå¦‚æœä½¿ç”¨å­—æ®µæ³¨å…¥ï¼Œå±æ€§ä¸èƒ½å£°æ˜ä¸º <code>final</code>ï¼Œå› ä¸º <code>final</code> å±æ€§å¿…é¡»åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯é€šè¿‡åå°„ã€‚è¿™é™åˆ¶äº†å¯¹ä¸å¯å˜æ€§çš„æ”¯æŒã€‚<code>final</code>å­—æ®µçš„å€¼ä¸€æ—¦è¢«èµ‹å€¼åï¼Œåœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ã€‚è¿™æ„å‘³ç€åœ¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œ<code>final</code>å­—æ®µçš„å€¼ä¸èƒ½è¢«é‡æ–°èµ‹å€¼ã€‚æ— è®ºæ˜¯é€šè¿‡ç›´æ¥èµ‹å€¼ã€æ„é€ å‡½æ•°èµ‹å€¼ï¼Œè¿˜æ˜¯é€šè¿‡åˆå§‹åŒ–å—èµ‹å€¼ï¼Œä¸€æ—¦èµ‹å€¼å®Œæˆï¼Œå°±ä¸èƒ½å†ä¿®æ”¹ã€‚</li>
</ol>
</blockquote>
<p>ä¸æ˜¾ç¤ºä½¿ç”¨æ³¨è§£</p>
<p>å¦‚æœåªä½¿ç”¨ <code>@Component</code> æ³¨è§£ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ <code>@Autowired</code> æˆ– <code>@Resource</code> æ³¨è§£ï¼ŒSpring ä»ç„¶ä¼šå°†è¯¥ç±»æ³¨å†Œä¸ºä¸€ä¸ª Beanï¼Œä½†<strong>ä¸ä¼šè‡ªåŠ¨æ³¨å…¥å®ƒçš„ä¾èµ–</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AnotherComponent anotherComponent; <span class="comment">// ä¸ä¼šè‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¸Œæœ› Spring è‡ªåŠ¨æ³¨å…¥ä¾èµ–ï¼Œå¿…é¡»ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š</p>
<ul>
<li>
<p><code>@Autowired</code> æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AnotherComponent anotherComponent;<span class="comment">// è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>@Resource</code> æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AnotherComponent anotherComponent;<span class="comment">// è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>æ„é€ æ–¹æ³•æ³¨å…¥</strong>ï¼ˆæ¨èï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnotherComponent anotherComponent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyComponent</span><span class="params">(AnotherComponent anotherComponent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.anotherComponent = anotherComponent;<span class="comment">// è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>ä½¿ç”¨@Componentæˆ–@Beanå£°æ˜</strong></p>
<p><code>@Bean</code> æ³¨è§£çš„ä½œç”¨æ˜¯å‘Šè¯‰ Spring å®¹å™¨ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å¯¹è±¡åº”è¯¥è¢«æ³¨å†Œä¸ºä¸€ä¸ª Beanï¼Œå¹¶ä¸”è¿™ä¸ª Bean å¯ä»¥è¢«å…¶ä»–ç»„ä»¶é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼ä½¿ç”¨ã€‚Spring å®¹å™¨ä¼šè´Ÿè´£ç®¡ç†è¿™ä¸ª Bean çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€åˆå§‹åŒ–ã€é”€æ¯ç­‰ã€‚</p>
<ul>
<li><strong>å¯¹äºå¤§å¤šæ•° Beanï¼Œä½¿ç”¨ @Component (æˆ–å…¶è¡ç”Ÿæ³¨è§£) è¿›è¡Œå£°æ˜ï¼Œå¹¶è®© Spring è‡ªåŠ¨æ‰«æå’Œæ³¨å†Œã€‚</strong> è¿™æ˜¯æœ€ç®€æ´å’Œæ¨èçš„æ–¹å¼ã€‚</li>
<li><strong>åªæœ‰åœ¨éœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œä¾‹å¦‚è‡ªå®šä¹‰åˆå§‹åŒ–ã€ä½œç”¨åŸŸæˆ–æ¡ä»¶åŒ–åˆ›å»º Bean æ—¶ï¼Œæ‰éœ€è¦åœ¨configç±»ä¸­ä½¿ç”¨ @Bean æ–¹æ³•ã€‚</strong></li>
<li><strong>å§‹ç»ˆä¸º @Bean æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ç±»ï¼Œå³ä½¿å®ƒéå¸¸ç®€å•ã€‚</strong> é¿å…ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»æˆ– Lambda è¡¨è¾¾å¼åˆ›å»º Beanï¼Œé™¤éæœ‰éå¸¸ç‰¹æ®Šçš„ç†ç”±ã€‚</li>
</ul>
<p><strong>Spring æ³¨å…¥æ—¶ bean çš„é€‰æ‹©ï¼š</strong></p>
<ol>
<li><strong>@Autowired æ³¨è§£:</strong> åœ¨ createJdbcTemplate æ–¹æ³•ä¸­ï¼Œ@Autowired æ³¨è§£å‘Šè¯‰ Spring éœ€è¦æ³¨å…¥ä¸€ä¸ª DataSource ç±»å‹çš„ Beanã€‚</li>
<li><strong>ç±»å‹åŒ¹é…:</strong> Spring å®¹å™¨ä¼šæ‰«ææ‰€æœ‰å¸¦æœ‰ @Bean æ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶å°†å…¶è¿”å›å€¼æ³¨å†Œä¸º Beanã€‚å½“éœ€è¦æ³¨å…¥ DataSource ç±»å‹ Bean æ—¶ï¼ŒSpring ä¼šæŸ¥æ‰¾å®¹å™¨ä¸­æ‰€æœ‰ç±»å‹ä¸º DataSource çš„ Beanã€‚</li>
<li><strong>å”¯ä¸€ Bean:</strong> åœ¨æœ¬ä¾‹ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³• createDataSource è¿”å› DataSource ç±»å‹çš„ Beanã€‚å› æ­¤ï¼ŒSpring å¯ä»¥æ˜ç¡®åœ°å°† createDataSource æ–¹æ³•åˆ›å»ºçš„ Bean æ³¨å…¥åˆ° createJdbcTemplate æ–¹æ³•çš„å‚æ•°ä¸­ã€‚</li>
<li><strong>åç§°åŒ¹é…ï¼ˆå¦‚æœå­˜åœ¨å¤šä¸ªåŒç±»å‹ Beanï¼‰:</strong> å¦‚æœæœ‰å¤šä¸ª DataSource ç±»å‹çš„ Beanï¼Œ@Autowired é»˜è®¤ä¼šæŒ‰ç…§ç±»å‹è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœåŒ¹é…åˆ°å¤šä¸ªï¼Œåˆ™ä¼šå°è¯•æŒ‰ç…§åç§°è¿›è¡ŒåŒ¹é…ã€‚ä½ å¯ä»¥ä½¿ç”¨ @Qualifier æ³¨è§£æ¥æŒ‡å®šè¦æ³¨å…¥çš„ Bean çš„åç§°</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;  <span class="comment">// å°†è¢«springæ­£ç¡®æ³¨å…¥</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FactoryBean">FactoryBean</h3>
<p>å®ç°äº†FactoryBeanæ¥å£çš„ç±»å°†è¢«Springè§†ä¸ºå·¥å‚Bean</p>
<p>Springä¼šå°†å·¥å‚Beanåˆ›å»ºåä¿å­˜åœ¨IoCå®¹å™¨ä¸­ï¼Œå¹¶åœ¨æ³¨å…¥è¯¥å·¥å‚Beançš„æ—¶å€™ï¼Œä½¿ç”¨å·¥å‚Beanåˆ›å»ºBeanè¿›è¡Œæ³¨å…¥ï¼›</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;myConnection&quot;)</span> <span class="comment">// bean name</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConnectionFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;MyConnection&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setter methods for properties (url, username, password) -  injected via Spring</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MyConnection <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Create and return a new MyConnection object</span></span><br><span class="line">        <span class="comment">// This is where the object creation logic resides</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Creating a new MyConnection object&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyConnection</span>(url, username, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyConnection.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// Return false for a new instance each time</span></span><br><span class="line">        <span class="comment">// return true;  // Return true for a singleton instance</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A simple connection class (replace with your actual connection logic)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConnection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyConnection</span><span class="params">(String url, String username, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... other methods ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123; <span class="keyword">return</span> url;&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123; <span class="keyword">return</span> username;&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;<span class="keyword">return</span> password;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyConnection myConnection; <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œæ³¨å…¥çš„æ˜¯myConnectionå¯¹è±¡è€Œä¸æ˜¯myConnectionFactoryBeanå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Using MyConnection: &quot;</span> + myConnection.getUrl());</span><br><span class="line">        <span class="comment">// ... use the myConnection object ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è·å– FactoryBean æœ¬èº«ï¼š</strong></p>
<p>å¦‚æœéœ€è¦è·å– FactoryBean å®ä¾‹æœ¬èº«ï¼Œè€Œä¸æ˜¯å®ƒåˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥åœ¨ Bean çš„åç§°å‰é¢åŠ ä¸Š &amp; ç¬¦å·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">MyConnectionFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> (MyConnectionFactoryBean) applicationContext.getBean(<span class="string">&quot;&amp;myConnection&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li><strong>å°è£…å¤æ‚çš„åˆ›å»ºé€»è¾‘ï¼š</strong> å½“ Bean çš„åˆ›å»ºé€»è¾‘æ¯”è¾ƒå¤æ‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ FactoryBean å°†å…¶å°è£…èµ·æ¥ï¼Œä½¿é…ç½®æ›´åŠ ç®€æ´ã€‚</li>
<li><strong>å»¶è¿Ÿåˆå§‹åŒ–ï¼š</strong> FactoryBean çš„ getObject() æ–¹æ³•åªæœ‰åœ¨éœ€è¦çš„æ—¶å€™æ‰ä¼šè¢«è°ƒç”¨ï¼Œå¯ä»¥å®ç° Bean çš„å»¶è¿Ÿåˆå§‹åŒ–ã€‚</li>
<li><strong>åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡ï¼š</strong> FactoryBean å¯ä»¥æ ¹æ®ä¸åŒçš„é…ç½®åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡ã€‚</li>
<li><strong>ä¸ç¬¬ä¸‰æ–¹åº“é›†æˆï¼š</strong> å¯ä»¥ä½¿ç”¨ FactoryBean æ¥é›†æˆç¬¬ä¸‰æ–¹åº“ï¼Œä¾‹å¦‚åˆ›å»ºæ•°æ®åº“è¿æ¥ã€ç¼“å­˜è¿æ¥ç­‰ã€‚</li>
</ul>
<h3 id="åˆå§‹åŒ–ä¸é”€æ¯">åˆå§‹åŒ–ä¸é”€æ¯</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="type">ZoneId</span> <span class="variable">zoneId</span> <span class="operator">=</span> ZoneId.systemDefault();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span>  <span class="comment">// åˆ›å»ºå</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Init mail service with zoneId = &quot;</span> + <span class="built_in">this</span>.zoneId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span>  <span class="comment">// é”€æ¯å‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Shutdown mail service&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¾ªç¯ä¾èµ–">å¾ªç¯ä¾èµ–</h3>
<p>å¾ªç¯ä¾èµ–å­˜åœ¨ä¸‰ç§åœºæ™¯ï¼š</p>
<ol>
<li>é€šè¿‡æ„é€ æ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜</li>
<li>é€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ä¸”æ˜¯åœ¨å¤šä¾‹æ¨¡å¼ä¸‹äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜</li>
<li>é€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ä¸”æ˜¯åœ¨å•ä¾‹æ¨¡å¼ä¸‹äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜</li>
</ol>
<p>Spring åœ¨å¤„ç† Bean åˆ›å»ºæ—¶ï¼Œä¼šä½¿ç”¨ <strong>ä¸‰çº§ç¼“å­˜</strong> æ¥å¤„ç†ä¾èµ–æ³¨å…¥ä¸­çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼š</p>
<ul>
<li><strong>ä¸€çº§ç¼“å­˜</strong>ï¼ˆ<code>singletonObjects</code>ï¼‰ï¼šå­˜å‚¨å®Œå…¨åˆå§‹åŒ–å¥½çš„ Beanã€‚</li>
<li><strong>äºŒçº§ç¼“å­˜</strong>ï¼ˆ<code>earlySingletonObjects</code>ï¼‰ï¼šå­˜å‚¨éƒ¨åˆ†åˆå§‹åŒ–çš„ Beanï¼ˆå³å±æ€§æ³¨å…¥å®Œæˆï¼Œä½†æ„é€ å™¨è¿˜æœªæ‰§è¡Œå®Œæ¯•çš„ Beanï¼‰ã€‚</li>
<li><strong>ä¸‰çº§ç¼“å­˜</strong>ï¼ˆ<code>singletonFactories</code>ï¼‰ï¼šå­˜å‚¨è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„ Bean çš„å·¥å‚æ–¹æ³•ï¼Œç”¨äºå»¶è¿Ÿåˆ›å»º Beanã€‚</li>
</ul>
<p><strong>Spring è§£å†³ Bean ä¾èµ–çš„æµç¨‹</strong></p>
<ol>
<li>æ£€æŸ¥ <code>singletonObjects</code>ï¼š
<ul>
<li><code>singletonObjects</code> æ˜¯ Spring å®¹å™¨ä¸­å­˜å‚¨å®Œå…¨åˆå§‹åŒ–å¥½çš„å•ä¾‹ Bean çš„ç¼“å­˜ã€‚</li>
<li>å¦‚æœ <code>singletonObjects</code> ä¸­å­˜åœ¨ Bean Bï¼Œè¯´æ˜ B å·²ç»å®Œæˆåˆå§‹åŒ–ï¼ŒSpring ä¼šç›´æ¥å°†å…¶æ³¨å…¥åˆ° Bean A ä¸­ã€‚</li>
</ul>
</li>
<li>æ£€æŸ¥ <code>earlySingletonObjects</code>ï¼š
<ul>
<li><code>earlySingletonObjects</code> æ˜¯ Spring å®¹å™¨ä¸­å­˜å‚¨â€œæ—©æœŸå•ä¾‹ Beanâ€çš„ç¼“å­˜ã€‚è¿™äº› Bean å·²ç»é€šè¿‡å·¥å‚åˆ›å»ºï¼Œä½†å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆå±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–ã€‚</li>
<li>å¦‚æœ <code>earlySingletonObjects</code> ä¸­å­˜åœ¨ Bean Bï¼Œè¯´æ˜ B å·²ç»é€šè¿‡å·¥å‚åˆ›å»ºï¼Œä½†å¯èƒ½è¿˜åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ã€‚Spring ä¼šå°†å…¶æ³¨å…¥åˆ° Bean A ä¸­ï¼Œä»¥é¿å…å¾ªç¯ä¾èµ–é—®é¢˜ã€‚</li>
</ul>
</li>
<li>æ£€æŸ¥ <code>singletonFactories</code>ï¼š
<ul>
<li><code>singletonFactories</code> æ˜¯ Spring å®¹å™¨ä¸­å­˜å‚¨å•ä¾‹ Bean å·¥å‚çš„ç¼“å­˜ã€‚è¿™äº›å·¥å‚ç”¨äºåˆ›å»º Bean çš„æ—©æœŸå¼•ç”¨ï¼ˆå³æœªå®Œå…¨åˆå§‹åŒ–çš„ Beanï¼‰ã€‚</li>
<li>å¦‚æœ <code>singletonFactories</code> ä¸­å­˜åœ¨ Bean B çš„å·¥å‚ï¼ŒSpring ä¼šè°ƒç”¨è¯¥å·¥å‚åˆ›å»º B çš„æ—©æœŸå¼•ç”¨ï¼Œå¹¶å°†å…¶æ”¾å…¥ <code>earlySingletonObjects</code> ä¸­ï¼Œç„¶åæ³¨å…¥åˆ° Bean A ä¸­ã€‚</li>
</ul>
</li>
<li>å¦‚æœä»¥ä¸Šç¼“å­˜ä¸­éƒ½ä¸å­˜åœ¨ Bï¼š
<ul>
<li>å¦‚æœ <code>singletonObjects</code>ã€<code>earlySingletonObjects</code> å’Œ <code>singletonFactories</code> ä¸­éƒ½ä¸å­˜åœ¨ Bean Bï¼Œè¯´æ˜ B è¿˜æ²¡æœ‰å¼€å§‹åˆ›å»ºã€‚</li>
<li>Spring ä¼šå…ˆåˆ›å»º Bean Bï¼Œå®Œæˆå…¶åˆå§‹åŒ–åï¼Œå†ç»§ç»­åˆ›å»º Bean Aã€‚</li>
</ul>
</li>
</ol>
<h2 id="Spring-Bean-çš„ç”Ÿå‘½å‘¨æœŸ">Spring Bean çš„ç”Ÿå‘½å‘¨æœŸ</h2>
<p>ref: <a href="https://open8gu.com/framework/spring/cssibafmgio4g44c/">https://open8gu.com/framework/spring/cssibafmgio4g44c/</a></p>
<ol>
<li><strong>å®ä¾‹åŒ– Beanï¼š</strong>
<ul>
<li><strong>ç»„ä»¶æ‰«æï¼ˆComponent Scanningï¼‰ï¼š</strong> Spring æ ¹æ®é…ç½®çš„åŒ…è·¯å¾„ï¼Œæ‰«ææ‰€æœ‰å¸¦æœ‰æ„é€ å‹æ³¨è§£çš„ç±»ï¼ˆä¾‹å¦‚ <code>@Component</code>ã€<code>@Service</code>ã€<code>@Repository</code> ç­‰ï¼‰ï¼Œå¹¶å°†è¿™äº›ç±»æ³¨å†Œä¸º Spring å®¹å™¨ä¸­çš„ Beanã€‚</li>
<li><strong>æ¨æ–­æ„é€ æ–¹æ³•ï¼š</strong> Spring ä¼šæ ¹æ® Bean çš„ç±»å®šä¹‰ï¼Œé€‰æ‹©åˆé€‚çš„æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šæ„é€ æ–¹æ³•ï¼ŒSpring ä¼šä½¿ç”¨é»˜è®¤çš„æ— å‚æ„é€ æ–¹æ³•ã€‚</li>
<li><strong>åˆ›å»ºå¯¹è±¡ï¼š</strong> é€šè¿‡åå°„æœºåˆ¶æˆ–å·¥å‚æ–¹æ³•åˆ›å»º Bean çš„å®ä¾‹ã€‚æ­¤æ—¶ï¼Œå¯¹è±¡çš„å±æ€§è¿˜æœªè¢«å¡«å……ï¼ŒBean å¤„äºæœªåˆå§‹åŒ–çŠ¶æ€ã€‚</li>
</ul>
</li>
<li><strong>å¡«å……å±æ€§ (ä¾èµ–æ³¨å…¥)ï¼š</strong>
<ul>
<li><strong>è§£æä¾èµ–å…³ç³»ï¼š</strong> Spring å®¹å™¨æ ¹æ®é…ç½®ä¿¡æ¯è§£æ Bean çš„ä¾èµ–å…³ç³»ï¼Œç¡®å®šéœ€è¦æ³¨å…¥çš„å…¶ä»– Bean æˆ–å€¼ã€‚</li>
<li><strong>ä¾èµ–æ³¨å…¥ï¼š</strong> é€šè¿‡æ³¨è§£ï¼ˆå¦‚ <code>@Autowired</code>ã€<code>@Resource</code>ï¼‰æˆ– XML é…ç½®ï¼Œå°†ä¾èµ–çš„ Bean æ³¨å…¥åˆ°å½“å‰ Bean çš„å±æ€§ä¸­ã€‚Spring æ”¯æŒå­—æ®µæ³¨å…¥ã€æ„é€ å™¨æ³¨å…¥å’Œ Setter æ–¹æ³•æ³¨å…¥ç­‰å¤šç§æ³¨å…¥æ–¹å¼ã€‚</li>
</ul>
</li>
<li><strong>Aware æ¥å£å›è°ƒï¼š</strong>
<ul>
<li><strong>Aware æ¥å£ï¼š</strong> å¦‚æœ Bean å®ç°äº† Spring çš„ Aware æ¥å£ï¼ˆä¾‹å¦‚ <code>BeanNameAware</code>ã€<code>BeanFactoryAware</code>ã€<code>ApplicationContextAware</code> ç­‰ï¼‰ï¼ŒSpring å®¹å™¨ä¼šå›è°ƒç›¸åº”çš„æ–¹æ³•ï¼Œå°† Bean çš„åç§°ã€BeanFactoryã€ApplicationContext ç­‰ä¿¡æ¯æ³¨å…¥åˆ° Bean ä¸­ã€‚</li>
<li><strong>å›è°ƒæ—¶æœºï¼š</strong> è¿™äº›å›è°ƒæ–¹æ³•åœ¨ Bean çš„å±æ€§æ³¨å…¥ä¹‹åã€åˆå§‹åŒ–ä¹‹å‰è¢«è°ƒç”¨ã€‚</li>
</ul>
</li>
<li><strong>BeanPostProcessor çš„å‰ç½®å¤„ç†ï¼š</strong>
<ul>
<li><strong>å‰ç½®å¤„ç†ï¼š</strong> Spring å®¹å™¨ä¼šè°ƒç”¨æ‰€æœ‰å®ç°äº† <code>BeanPostProcessor</code> æ¥å£çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ï¼Œå¯¹ Bean è¿›è¡Œå‰ç½®å¤„ç†ã€‚</li>
<li><strong>è‡ªå®šä¹‰å¤„ç†ï¼š</strong> å¼€å‘è€…å¯ä»¥åœ¨ <code>BeanPostProcessor</code> ä¸­å¯¹ Bean è¿›è¡Œä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ï¼Œä¾‹å¦‚ä¿®æ”¹ Bean çš„å±æ€§ã€æ·»åŠ  Bean çš„ä»£ç†ç­‰ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯ Bean åˆå§‹åŒ–å‰çš„æœ€åæœºä¼šè¿›è¡Œå¹²é¢„ã€‚</li>
</ul>
</li>
<li><strong>åˆå§‹åŒ–ï¼š</strong>
<ul>
<li><strong>InitializingBean æ¥å£ï¼š</strong> å¦‚æœ Bean å®ç°äº† <code>InitializingBean</code> æ¥å£ï¼ŒSpring å®¹å™¨ä¼šè°ƒç”¨å…¶ <code>afterPropertiesSet()</code> æ–¹æ³•ï¼Œæ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚</li>
<li><strong>è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ï¼š</strong> å¦‚æœ Bean å®šä¹‰äº† <code>init-method</code> å±æ€§ï¼ŒSpring å®¹å™¨ä¼šè°ƒç”¨æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•ã€‚</li>
<li><strong>èµ„æºåˆå§‹åŒ–ï¼š</strong> åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œå¼€å‘è€…å¯ä»¥åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºçš„åˆå§‹åŒ–å·¥ä½œï¼Œä¾‹å¦‚æ‰“å¼€æ•°æ®åº“è¿æ¥ã€åŠ è½½é…ç½®æ–‡ä»¶ç­‰ã€‚</li>
</ul>
</li>
<li><strong>BeanPostProcessor çš„åç½®å¤„ç†ï¼š</strong>
<ul>
<li><strong>åç½®å¤„ç†ï¼š</strong> Spring å®¹å™¨ä¼šè°ƒç”¨æ‰€æœ‰å®ç°äº† <code>BeanPostProcessor</code> æ¥å£çš„ <code>postProcessAfterInitialization()</code> æ–¹æ³•ï¼Œå¯¹ Bean è¿›è¡Œåç½®å¤„ç†ã€‚</li>
<li><strong>AOP ä»£ç†ï¼š</strong> åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¼€å‘è€…å¯ä»¥åœ¨ <code>BeanPostProcessor</code> ä¸­å¯¹ Bean è¿›è¡Œ AOP ä»£ç†ï¼Œä¾‹å¦‚ä½¿ç”¨ Spring AOP åˆ›å»ºä»£ç†å¯¹è±¡ã€‚</li>
<li><strong>ä»£ç†å¯¹è±¡ï¼š</strong> å¦‚æœ Bean è¢« AOP ä»£ç†ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿”å›çš„ Bean å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸå§‹çš„ Bean å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>æ”¾å…¥å•ä¾‹æ±  (å¯é€‰)ï¼š</strong>
<ul>
<li><strong>å•ä¾‹ Beanï¼š</strong> å¦‚æœ Bean çš„ä½œç”¨åŸŸæ˜¯å•ä¾‹ (<code>singleton</code>)ï¼ŒSpring å®¹å™¨ä¼šå°† Bean æ”¾å…¥å•ä¾‹æ± ä¸­ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è·å–æ—¶ç›´æ¥ä½¿ç”¨ã€‚</li>
<li><strong>ä»£ç†å¯¹è±¡ï¼š</strong> å¦‚æœ Bean è¢« AOP ä»£ç†ï¼Œåˆ™æ”¾å…¥å•ä¾‹æ± çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸå§‹çš„ Bean å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>Bean å¯¹è±¡ï¼š</strong>
<ul>
<li><strong>å®Œæˆåˆ›å»ºï¼š</strong> æ­¤æ—¶ï¼ŒBean çš„åˆ›å»ºè¿‡ç¨‹å·²ç»å®Œæˆï¼ŒBean å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¯ä»¥è¢«åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸï¼š</strong> Bean çš„ç”Ÿå‘½å‘¨æœŸä»æ­¤æ—¶å¼€å§‹ï¼Œç›´åˆ°å®¹å™¨é”€æ¯å®ƒã€‚</li>
</ul>
</li>
<li><strong>é”€æ¯ï¼š</strong>
<ul>
<li><strong>é”€æ¯é˜¶æ®µï¼š</strong> å½“ Spring å®¹å™¨å…³é—­æˆ– Bean çš„ä½œç”¨åŸŸç»“æŸæ—¶ï¼ŒSpring å®¹å™¨ä¼šé”€æ¯ Beanã€‚</li>
<li><strong>DisposableBean æ¥å£ï¼š</strong> å¦‚æœ Bean å®ç°äº† <code>DisposableBean</code> æ¥å£ï¼ŒSpring å®¹å™¨ä¼šè°ƒç”¨å…¶ <code>destroy()</code> æ–¹æ³•ï¼Œæ‰§è¡Œé”€æ¯é€»è¾‘ã€‚</li>
<li><strong>è‡ªå®šä¹‰é”€æ¯æ–¹æ³•ï¼š</strong> å¦‚æœ Bean å®šä¹‰äº† <code>destroy-method</code> å±æ€§ï¼ŒSpring å®¹å™¨ä¼šè°ƒç”¨æŒ‡å®šçš„é”€æ¯æ–¹æ³•ã€‚</li>
<li><strong>èµ„æºé‡Šæ”¾ï¼š</strong> åœ¨é”€æ¯é˜¶æ®µï¼Œå¼€å‘è€…å¯ä»¥åœ¨é”€æ¯æ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºçš„é‡Šæ”¾å·¥ä½œï¼Œä¾‹å¦‚å…³é—­æ•°æ®åº“è¿æ¥ã€æ¸…ç†ç¼“å­˜ç­‰ã€‚</li>
</ul>
</li>
</ol>
<h2 id="Springæ•°æ®åº“ç›¸å…³">Springæ•°æ®åº“ç›¸å…³</h2>
<h3 id="JDBC">JDBC</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;jdbc.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    String jdbcUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    String jdbcUsername;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    String jdbcPassword;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>  <span class="comment">// åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼Œå¹¶ä½œä¸ºbean</span></span><br><span class="line">    DataSource <span class="title function_">createDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        config.setJdbcUrl(jdbcUrl);</span><br><span class="line">        config.setUsername(jdbcUsername);</span><br><span class="line">        config.setPassword(jdbcPassword);</span><br><span class="line">        config.addDataSourceProperty(<span class="string">&quot;autoCommit&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        config.addDataSourceProperty(<span class="string">&quot;connectionTimeout&quot;</span>, <span class="string">&quot;5&quot;</span>);</span><br><span class="line">        config.addDataSourceProperty(<span class="string">&quot;idleTimeout&quot;</span>, <span class="string">&quot;60&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>  <span class="comment">// åˆ›å»ºJdbcTemplateï¼Œæ³¨å…¥DataSource</span></span><br><span class="line">    JdbcTemplate <span class="title function_">createJdbcTemplate</span><span class="params">(<span class="meta">@Autowired</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>JdbcTemplateç”¨æ³•</strong></p>
<p>é…ç½®ç±»å®ç° JdbcTemplate Bean çš„åˆ›å»ºï¼Œæ³¨å…¥åˆ°Userç±»jdbcTemplateå±æ€§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ä¼ å…¥çš„æ˜¯ConnectionCallback:</span></span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.execute((Connection conn) -&gt; &#123;</span><br><span class="line">        <span class="comment">// å¯ä»¥ç›´æ¥ä½¿ç”¨connå®ä¾‹ï¼Œä¸è¦é‡Šæ”¾å®ƒï¼Œå›è°ƒç»“æŸåJdbcTemplateè‡ªåŠ¨é‡Šæ”¾:</span></span><br><span class="line">        <span class="comment">// åœ¨å†…éƒ¨æ‰‹åŠ¨åˆ›å»ºçš„PreparedStatementã€ResultSetå¿…é¡»ç”¨try(...)é‡Šæ”¾:</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">ps</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT * FROM users WHERE id = ?&quot;</span>)) &#123;</span><br><span class="line">            ps.setObject(<span class="number">1</span>, id);</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">rs</span> <span class="operator">=</span> ps.executeQuery()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>( <span class="comment">// new User object:</span></span><br><span class="line">                            rs.getLong(<span class="string">&quot;id&quot;</span>), <span class="comment">// id</span></span><br><span class="line">                            rs.getString(<span class="string">&quot;email&quot;</span>), <span class="comment">// email</span></span><br><span class="line">                            rs.getString(<span class="string">&quot;password&quot;</span>), <span class="comment">// password</span></span><br><span class="line">                            rs.getString(<span class="string">&quot;name&quot;</span>)); <span class="comment">// name</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;user not found by id.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="comment">// éœ€è¦ä¼ å…¥SQLè¯­å¥ï¼Œä»¥åŠPreparedStatementCallback:</span></span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.execute(<span class="string">&quot;SELECT * FROM users WHERE name = ?&quot;</span>, (PreparedStatement ps) -&gt; &#123;</span><br><span class="line">        <span class="comment">// PreparedStatementå®ä¾‹å·²ç»ç”±JdbcTemplateåˆ›å»ºï¼Œå¹¶åœ¨å›è°ƒåè‡ªåŠ¨é‡Šæ”¾:</span></span><br><span class="line">        ps.setObject(<span class="number">1</span>, name);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">rs</span> <span class="operator">=</span> ps.executeQuery()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>( <span class="comment">// new User object:</span></span><br><span class="line">                        rs.getLong(<span class="string">&quot;id&quot;</span>), <span class="comment">// id</span></span><br><span class="line">                        rs.getString(<span class="string">&quot;email&quot;</span>), <span class="comment">// email</span></span><br><span class="line">                        rs.getString(<span class="string">&quot;password&quot;</span>), <span class="comment">// password</span></span><br><span class="line">                        rs.getString(<span class="string">&quot;name&quot;</span>)); <span class="comment">// name</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;user not found by id.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¼ å…¥SQLï¼Œå‚æ•°å’ŒRowMapperå®ä¾‹:</span></span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(<span class="string">&quot;SELECT * FROM users WHERE email = ?&quot;</span>,</span><br><span class="line">            (ResultSet rs, <span class="type">int</span> rowNum) -&gt; &#123;</span><br><span class="line">                <span class="comment">// å°†ResultSetçš„å½“å‰è¡Œæ˜ å°„ä¸ºä¸€ä¸ªJavaBean:</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>( <span class="comment">// new User object:</span></span><br><span class="line">                        rs.getLong(<span class="string">&quot;id&quot;</span>), <span class="comment">// id</span></span><br><span class="line">                        rs.getString(<span class="string">&quot;email&quot;</span>), <span class="comment">// email</span></span><br><span class="line">                        rs.getString(<span class="string">&quot;password&quot;</span>), <span class="comment">// password</span></span><br><span class="line">                        rs.getString(<span class="string">&quot;name&quot;</span>)); <span class="comment">// name</span></span><br><span class="line">            &#125;,</span><br><span class="line">            email);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<blockquote>
<p>jdbcTemplate.queryForObject() æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª RowMapper æ¥å£çš„å®ç°ã€‚RowMapper æ¥å£å®šä¹‰äº†ä¸€ä¸ª mapRow(ResultSet rs, int rowNum) æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°† ResultSet çš„æ¯ä¸€è¡Œæ•°æ®æ˜ å°„æˆä¸€ä¸ª Java å¯¹è±¡ã€‚</p>
</blockquote>
<p><strong>å£°æ˜å¼äº‹åŠ¡</strong></p>
<p><code>PlatformTransactionManager</code>è¡¨ç¤ºäº‹åŠ¡ç®¡ç†å™¨ï¼›</p>
<p><code>TransactionStatus</code>è¡¨ç¤ºäº‹åŠ¡ï¼›</p>
<blockquote>
<p>Springä¸ºäº†åŒæ—¶æ”¯æŒJDBCå’ŒJTAä¸¤ç§äº‹åŠ¡æ¨¡å‹ï¼Œæ•…ä½¿ç”¨<code>PlatformTransactionManager</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;jdbc.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    PlatformTransactionManager <span class="title function_">createTxManager</span><span class="params">(<span class="meta">@Autowired</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">TransactionStatus</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¼€å¯äº‹åŠ¡:</span></span><br><span class="line">    tx = txManager.getTransaction(<span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>());</span><br><span class="line">    <span class="comment">// ç›¸å…³JDBCæ“ä½œ:</span></span><br><span class="line">    jdbcTemplate.update(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    jdbcTemplate.update(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="comment">// æäº¤äº‹åŠ¡:</span></span><br><span class="line">    txManager.commit(tx);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    <span class="comment">// å›æ»šäº‹åŠ¡:</span></span><br><span class="line">    txManager.rollback(tx);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">// å¯ç”¨å£°æ˜å¼</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;jdbc.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å£°æ˜å¼äº‹åŠ¡é€è¿‡AOPä»£ç†çš„æ–¹å¼ï¼Œä¸ºUserServiceç±»åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡æ‹¥æœ‰å±æ€§txManagerï¼Œå¹¶ä½¿æ¯ä¸ªæ–¹æ³•äº‹åŠ¡åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService$$EnhancerBySpringCGLIB</span> <span class="keyword">extends</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">target</span> <span class="operator">=</span> ...</span><br><span class="line">    <span class="type">PlatformTransactionManager</span> <span class="variable">txManager</span> <span class="operator">=</span> ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">register</span><span class="params">(String email, String password, String name)</span> &#123;</span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tx = txManager.getTransaction(<span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>());</span><br><span class="line">            target.register(email, password, name);</span><br><span class="line">            txManager.commit(tx);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            txManager.rollback(tx);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>äº‹åŠ¡å›æ»š</strong></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå‘ç”Ÿäº†<code>RuntimeException</code>ï¼ŒSpringçš„å£°æ˜å¼äº‹åŠ¡å°†è‡ªåŠ¨å›æ»š</p>
<p>å¦‚æœè¦é’ˆå¯¹Checked Exceptionå›æ»šäº‹åŠ¡ï¼Œéœ€è¦åœ¨<code>@Transactional</code>æ³¨è§£ä¸­å†™å‡ºæ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = &#123;RuntimeException.class, IOException.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">buyProducts</span><span class="params">(<span class="type">long</span> productId, <span class="type">int</span> num)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JDBCäº‹åŠ¡ä¼ æ’­">JDBCäº‹åŠ¡ä¼ æ’­</h3>
<p>Springçš„å£°æ˜å¼äº‹åŠ¡ä¸ºäº‹åŠ¡ä¼ æ’­å®šä¹‰åˆ†çº§ï¼Œé»˜è®¤ä¼ æ’­çº§åˆ« <code>REQUIRED</code></p>
<p><code>REQUIRED</code>ï¼šè¡¨ç¤ºå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œã€‚</p>
<p><code>SUPPORTS</code>ï¼šè¡¨ç¤ºå¦‚æœæœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹Ÿä¸å¼€å¯äº‹åŠ¡æ‰§è¡Œã€‚è¿™ç§ä¼ æ’­çº§åˆ«å¯ç”¨äºæŸ¥è¯¢æ–¹æ³•ï¼Œå› ä¸ºSELECTè¯­å¥æ—¢å¯ä»¥åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ä¸éœ€è¦äº‹åŠ¡ï¼›</p>
<p><code>MANDATORY</code>ï¼šè¡¨ç¤ºå¿…é¡»è¦å­˜åœ¨å½“å‰äº‹åŠ¡å¹¶åŠ å…¥æ‰§è¡Œï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ç§ä¼ æ’­çº§åˆ«å¯ç”¨äºæ ¸å¿ƒæ›´æ–°é€»è¾‘ï¼Œæ¯”å¦‚ç”¨æˆ·ä½™é¢å˜æ›´ï¼Œå®ƒæ€»æ˜¯è¢«å…¶ä»–äº‹åŠ¡æ–¹æ³•è°ƒç”¨ï¼Œä¸èƒ½ç›´æ¥ç”±éäº‹åŠ¡æ–¹æ³•è°ƒç”¨ï¼›</p>
<p><code>REQUIRES_NEW</code>ï¼šè¡¨ç¤ºä¸ç®¡å½“å‰æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œéƒ½å¿…é¡»å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡æ‰§è¡Œã€‚å¦‚æœå½“å‰å·²ç»æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡ä¼šæŒ‚èµ·ï¼Œç­‰æ–°äº‹åŠ¡å®Œæˆåï¼Œå†æ¢å¤æ‰§è¡Œï¼›</p>
<p><code>NOT_SUPPORTED</code>ï¼šè¡¨ç¤ºä¸æ”¯æŒäº‹åŠ¡ï¼Œå¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡ä¼šæŒ‚èµ·ï¼Œç­‰è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œå†æ¢å¤æ‰§è¡Œï¼›</p>
<p><code>NEVER</code>ï¼šå’Œ<code>NOT_SUPPORTED</code>ç›¸æ¯”ï¼Œå®ƒä¸ä½†ä¸æ”¯æŒäº‹åŠ¡ï¼Œè€Œä¸”åœ¨ç›‘æµ‹åˆ°å½“å‰æœ‰äº‹åŠ¡æ—¶ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸æ‹’ç»æ‰§è¡Œï¼›</p>
<p><code>NESTED</code>ï¼šè¡¨ç¤ºå¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œåˆ™å¼€å¯ä¸€ä¸ªåµŒå¥—çº§åˆ«äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ã€‚</p>
<blockquote>
<p><strong>Springä½¿ç”¨ThreadLocalè·çŸ¥å½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡</strong></p>
<p>Springå°†JDBCç›¸å…³çš„<code>Connection</code>å’Œ<code>TransactionStatus</code>å®ä¾‹ç»‘å®šåˆ°<code>ThreadLocal</code>ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ä»<code>ThreadLocal</code>æœªå–åˆ°äº‹åŠ¡ï¼Œé‚£ä¹ˆå®ƒä¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„JDBCè¿æ¥ï¼ŒåŒæ—¶å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦åˆ™ï¼Œå®ƒå°±ç›´æ¥ä½¿ç”¨ä»<code>ThreadLocal</code>è·å–çš„JDBCè¿æ¥ä»¥åŠ<code>TransactionStatus</code>ã€‚</p>
<p>å› æ­¤ï¼Œäº‹åŠ¡èƒ½æ­£ç¡®ä¼ æ’­çš„å‰ææ˜¯ï¼Œæ–¹æ³•è°ƒç”¨å¿…é¡»åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ã€‚</p>
</blockquote>
<h3 id="ç»“åˆHibernate">ç»“åˆHibernate</h3>
<p>å°†å…³ç³»æ•°æ®åº“çš„è¡¨è®°å½•æ˜ å°„ä¸ºJavaå¯¹è±¡çš„è¿‡ç¨‹å°±æ˜¯ORMï¼šObject-Relational Mapping</p>
<p>å¯¹äºè¡¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    createdAt <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `email` (`email`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>å¯¹äºjavaå¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span>  <span class="comment">// @Entity æ³¨è§£æ ‡è®° User ç±»ä¸ºä¸€ä¸ªå®ä½“ï¼Œè¡¨ç¤ºå®ƒå¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€ä¸ªè¡¨ã€‚</span></span><br><span class="line"><span class="meta">@Table(name=&quot;users&quot;)</span>  <span class="comment">// æŒ‡å®šå¯¹åº”çš„è¡¨å</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span>  <span class="comment">// @Id æ³¨è§£æ ‡è®° getId() æ–¹æ³•è¿”å›çš„å€¼ä½œä¸ºä¸»é”®ã€‚</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// @Column æ³¨è§£ç”¨äºæ˜ å°„å®ä½“ç±»çš„å±æ€§åˆ°æ•°æ®åº“è¡¨çš„åˆ—ã€‚</span></span><br><span class="line">    <span class="comment">// @Column æ³¨è§£åœ¨ getEmail() æ–¹æ³•ä¸Šï¼ŒHibernate ä¼šæ ¹æ®çº¦å®šæ¨æ–­å‡ºå¯¹åº”çš„å­—æ®µåä¸º email (å»æ‰getï¼Œå¹¶å°†é¦–å­—æ¯å°å†™)ã€‚</span></span><br><span class="line">    <span class="meta">@Column(nullable = false, unique = true, length = 100)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEmail</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(nullable = false, length = 100)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(nullable = false, length = 100)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getCreatedAt</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªå±æ€§åˆ°æ•°æ®åº“åˆ—çš„æ˜ å°„ç”¨<code>@Column()</code>æ ‡è¯†ï¼Œ<code>nullable</code>æŒ‡ç¤ºåˆ—æ˜¯å¦å…è®¸ä¸º<code>NULL</code>ï¼Œ<code>updatable</code>æŒ‡ç¤ºè¯¥åˆ—æ˜¯å¦å…è®¸è¢«ç”¨åœ¨<code>UPDATE</code>è¯­å¥ï¼Œ<code>length</code>æŒ‡ç¤º<code>String</code>ç±»å‹çš„åˆ—çš„é•¿åº¦ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯<code>255</code>ï¼‰ã€‚</p>
<p>å¯¹äºä¸»é”®ï¼Œè¿˜éœ€è¦ç”¨<code>@Id</code>æ ‡è¯†ï¼Œè‡ªå¢ä¸»é”®å†è¿½åŠ ä¸€ä¸ª<code>@GeneratedValue</code>ï¼Œä»¥ä¾¿Hibernateèƒ½è¯»å–åˆ°è‡ªå¢ä¸»é”®çš„å€¼ã€‚</p>
<blockquote>
<p>Hibernate ä½¿ç”¨åå°„æœºåˆ¶æ¥è®¿é—®å’Œæ“ä½œå®ä½“ç±»çš„å­—æ®µã€‚@Column æ³¨è§£æ ‡æ³¨åœ¨ getter æ–¹æ³•ä¸Šåªæ˜¯ä¸€ç§ä¾¿æ·çš„å£°æ˜æ–¹å¼ï¼Œå®ƒå®é™…ä¸Šæ˜¯å‘Šè¯‰ Hibernate â€œè¿™ä¸ª getter æ–¹æ³•å¯¹åº”çš„å­—æ®µéœ€è¦æ˜ å°„åˆ°æ•°æ®åº“çš„åˆ—â€ã€‚</p>
<p>Hibernate ä½¿ç”¨ä¸€ç§åŸºäºçº¦å®šçš„å‘½åç­–ç•¥ã€‚å®ƒä¼šæŸ¥æ‰¾ç¬¦åˆ JavaBean è§„èŒƒçš„ getter/setter æ–¹æ³•ï¼Œå¹¶æ ¹æ®æ–¹æ³•åæ¨æ–­å‡ºå¯¹åº”çš„å­—æ®µåã€‚</p>
<p>å…·ä½“è§„åˆ™å¦‚ä¸‹:</p>
<ul>
<li>å¯¹äº getter æ–¹æ³•ï¼Œå»æ‰ get æˆ– is å‰ç¼€ï¼Œå¹¶å°†å‰©ä½™éƒ¨åˆ†çš„é¦–å­—æ¯å°å†™ã€‚ä¾‹å¦‚ï¼ŒgetEmail() å¯¹åº”å­—æ®µ emailï¼ŒisActivated() å¯¹åº”å­—æ®µ activatedã€‚</li>
<li>å¯¹äº setter æ–¹æ³•ï¼Œå»æ‰ set å‰ç¼€ï¼Œå¹¶å°†å‰©ä½™éƒ¨åˆ†çš„é¦–å­—æ¯å°å†™ã€‚ä¾‹å¦‚ï¼ŒsetEmail(String email) å¯¹åº”å­—æ®µ emailã€‚</li>
</ul>
</blockquote>
<p>å¯é€šè¿‡ç»§æ‰¿æ˜ å°„è¶…ç±»å®ç°å­ç±»çš„æ˜ å°„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MappedSuperclass</span>  <span class="comment">// æ˜ å°„è¶…ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractEntity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long createdAt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getCreatedAt</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transient</span>  <span class="comment">// æš«ãï¼Œè¦æ±‚ JPA å¿½ç•¥è¯¥å­—æ®µï¼Œä¸è¦å°†å…¶æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚è¿™æ„å‘³ç€ createdDateTime å­—æ®µä¸ä¼šåœ¨æ•°æ®åº“è¡¨ä¸­æ‹¥æœ‰å¯¹åº”çš„åˆ—ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> ZonedDateTime <span class="title function_">getCreatedDateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Instant.ofEpochMilli(<span class="built_in">this</span>.createdAt).atZone(ZoneId.systemDefault());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PrePersist</span>  <span class="comment">// æŒ‡å®šåœ¨å®ä½“æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¹‹å‰è¦æ‰§è¡Œçš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInsert</span><span class="params">()</span> &#123;</span><br><span class="line">        setCreatedAt(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º</p>
<p>SessionFactory æ˜¯ä¸€ä¸ªé‡é‡çº§å¯¹è±¡ï¼Œé€šå¸¸åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡ï¼Œå¹¶åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚å®ƒç”¨äºåˆ›å»º Session å¯¹è±¡ã€‚</p>
<p>Session æ˜¯ä¸€ä¸ªè½»é‡çº§å¯¹è±¡ï¼Œä»£è¡¨ä¸æ•°æ®åº“çš„ä¸€æ¬¡äº¤äº’ã€‚æ¯æ¬¡æ“ä½œæ•°æ®åº“éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Session å¯¹è±¡ã€‚åœ¨Springæ¶æ„ä¸­é€šè¿‡SessionFactory Beançš„æ³¨å…¥è·å¾—Session Beanã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span> <span class="comment">// ä½¿ç”¨ classpath</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    DataSource <span class="title function_">createDataSource</span><span class="params">(<span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span> String jdbcUrl,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span> String jdbcUsername,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span> String jdbcPassword)</span> &#123;</span><br><span class="line">        <span class="type">DriverManagerDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>();</span><br><span class="line">        dataSource.setUrl(jdbcUrl);</span><br><span class="line">        dataSource.setUsername(jdbcUsername);</span><br><span class="line">        dataSource.setPassword(jdbcPassword);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¿™é‡Œåˆ›å»ºäº† LocalSessionFactoryBean å¯¹è±¡ï¼Œåœ¨ç±»ä¸­è¦æ±‚æ³¨å…¥æ—¶ï¼Œä¼šæ³¨å…¥ SessionFactory å¯¹è±¡ï¼Œç”±äº SessionFactory å¯¹è±¡æ˜¯å•ä¾‹Beanï¼Œæ•… SessionFactory å¹¶æ²¡æœ‰è¢«åå¤åˆ›å»ºæ³¨å…¥</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    LocalSessionFactoryBean <span class="title function_">createSessionFactory</span><span class="params">(<span class="meta">@Autowired</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">LocalSessionFactoryBean</span> <span class="variable">sessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalSessionFactoryBean</span>();</span><br><span class="line">        sessionFactoryBean.setDataSource(dataSource);</span><br><span class="line">        sessionFactoryBean.setPackagesToScan(<span class="string">&quot;com.itranswarp.learnjava.entity&quot;</span>); <span class="comment">// æ‰«æ Entity ç±»</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.setProperty(<span class="string">&quot;hibernate.hbm2ddl.auto&quot;</span>, <span class="string">&quot;update&quot;</span>); <span class="comment">// æˆ– create-drop, validate</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.HSQLDialect&quot;</span>); <span class="comment">// æ ¹æ®æ•°æ®åº“é€‰æ‹©æ–¹è¨€</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        sessionFactoryBean.setHibernateProperties(props);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    PlatformTransactionManager <span class="title function_">createTxManager</span><span class="params">(<span class="meta">@Autowired</span> LocalSessionFactoryBean sessionFactoryBean)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è·å– SessionFactory å¯¹è±¡</span></span><br><span class="line">        <span class="type">SessionFactory</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> sessionFactoryBean.getObject();  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HibernateTransactionManager</span>(sessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>LocalSessionFactoryBean </code>æ˜¯ Spring æä¾›çš„ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œé…ç½® Hibernate <code>SessionFactory </code>çš„å·¥å‚ beanï¼Œå®é™…ä¸ŠæŒ‰ç…§é€»è¾‘è€Œè¨€ï¼Œ<code>LocalSessionFactoryBean </code>åº”è¯¥ä¸º<code>SessionFactory FactoryBean </code>ï¼Œå› ä¸ºå®ƒåˆ›å»ºçš„æ˜¯<code>SessionFactory </code> ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œ<code>SessionFactory </code> åœ¨åˆ›å»ºåä¸ºå•ä¾‹ beanï¼Œä¸ä¼šå‡ºç°åˆ›å»ºå¤šä¸ª<code>SessionFactory </code>çš„æƒ…å†µã€‚åœ¨ç±»éœ€è¦ä½¿ç”¨<code>SessionFactory </code>æ—¶ï¼ŒSpring æ³¨å…¥<code>SessionFactory </code></p>
<p><strong>å¦‚æœæˆ‘ä»¬æ¯ä¸ªç±»éœ€è¦çš„æ˜¯Sessionï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥ä½¿ç”¨<code>SessionFactoryBean </code>æ³¨å…¥åŸå‹ Session Beanåˆ°æ¯ä¸ªç±»ä¸­å‘¢ï¼Ÿ</strong></p>
<ol>
<li><strong>Session çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å›°éš¾:</strong> Session ä»£è¡¨ä¸æ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥ä¸ç‰¹å®šçš„æ“ä½œï¼ˆä¾‹å¦‚ä¸€æ¬¡æ•°æ®åº“äº‹åŠ¡ï¼‰ç»‘å®šã€‚ å¦‚æœå°† Session ä½œä¸ºåŸå‹ bean æ³¨å…¥ï¼Œå°±éœ€è¦æ‰‹åŠ¨ç®¡ç† Session çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€å…³é—­å’Œäº‹åŠ¡ç®¡ç†ã€‚ è¿™ä¼šä½¿ä»£ç å˜å¾—å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ï¼Œå¹¶ä¸”éš¾ä»¥ç»´æŠ¤ã€‚</li>
<li><strong>çº¿ç¨‹å®‰å…¨é—®é¢˜:</strong> Session ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ å¦‚æœå°†åŸå‹ Session bean æ³¨å…¥åˆ°å•ä¾‹ bean ä¸­ï¼Œå¹¶ä¸”åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–å…¶ä»–å¹¶å‘é—®é¢˜ã€‚</li>
<li><strong>èµ„æºç®¡ç†é—®é¢˜:</strong> Session æŒæœ‰æ•°æ®åº“è¿æ¥ç­‰èµ„æºã€‚ å¦‚æœä¸æ­£ç¡®åœ°ç®¡ç† Session çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºæ³„éœ²ã€‚</li>
<li><strong>è¿å Hibernate çš„è®¾è®¡ç†å¿µ:</strong> Hibernate çš„è®¾è®¡ç†å¿µæ˜¯å°† Session çš„ç”Ÿå‘½å‘¨æœŸä¸äº‹åŠ¡ç»‘å®šã€‚ é€šè¿‡ SessionFactory.openSession() æˆ– SessionFactory.getCurrentSession() è·å– Sessionï¼Œå¯ä»¥ç¡®ä¿ Session çš„ç”Ÿå‘½å‘¨æœŸä¸äº‹åŠ¡åŒæ­¥ï¼Œå¹¶ç”± Hibernate ç®¡ç†èµ„æºã€‚ ç›´æ¥æ³¨å…¥ Session bean ä¼šç ´åè¿™ç§è®¾è®¡ã€‚</li>
</ol>
</blockquote>
<p>CRUD</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span> <span class="comment">// å¯ç”¨å£°æ˜å¼äº‹åŠ¡ç®¡ç†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">register</span><span class="params">(String email, String password, String name)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        user.setName(name);</span><br><span class="line">        user.setCreatedAt(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionFactory.getCurrentSession(); <span class="comment">// è·å–å½“å‰ Session</span></span><br><span class="line">        session.persist(user);</span><br><span class="line">        <span class="keyword">return</span> user; <span class="comment">// ä¸éœ€è¦æ‰‹åŠ¨ commitï¼ŒSpring ä¼šè‡ªåŠ¨å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span> <span class="comment">// åªè¯»äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="keyword">return</span> session.get(User.class, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span> <span class="comment">// åªè¯»äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="keyword">return</span> session.createQuery(<span class="string">&quot;FROM User&quot;</span>, User.class).list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(Long id, String name)</span> &#123;</span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> session.get(User.class, id);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            user.setName(name);</span><br><span class="line">            session.merge(user); <span class="comment">// æˆ– session.update(user)</span></span><br><span class="line">            <span class="comment">// ä¸éœ€è¦æ‰‹åŠ¨ commitï¼ŒSpring ä¼šè‡ªåŠ¨å¤„ç†</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†ç”¨æˆ·ä¸å­˜åœ¨çš„æƒ…å†µ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteUser</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> session.get(User.class, id);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            session.delete(user);</span><br><span class="line">            <span class="comment">// ä¸éœ€è¦æ‰‹åŠ¨ commitï¼ŒSpring ä¼šè‡ªåŠ¨å¤„ç†</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨DAOå±‚ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    User <span class="title function_">get</span><span class="params">(Long id)</span>;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">getAll</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(User user)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line">	<span class="comment">// sessionåœ¨è¿™é‡Œä½¿ç”¨~</span></span><br><span class="line">    <span class="comment">// ... å®ç° UserDao æ¥å£ä¸­çš„æ–¹æ³•ï¼Œè¿›è¡Œæ•°æ®åº“æ“ä½œ ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... ä½¿ç”¨ userDao è·å¾—æ•°æ® ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»“åˆMyBatis">ç»“åˆMyBatis</h3>
<p>@Mapper æ³¨è§£</p>
<ul>
<li><strong>è‡ªåŠ¨ç”Ÿæˆ Mapper æ¥å£çš„å®ç°ç±»:</strong> @Mapper æ³¨è§£ä¼šå‘Šè¯‰ MyBatis ä¸ºæ ‡æ³¨çš„æ¥å£ç”Ÿæˆä¸€ä¸ªå®ç°ç±»ï¼Œå¹¶å°†è¯¥å®ç°ç±»æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RuleTreeNodeDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢è§„åˆ™æ ‘èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> treeId    è§„åˆ™æ ‘ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>          è§„åˆ™æ ‘èŠ‚ç‚¹é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;RuleTreeNodePO&gt; <span class="title function_">queryRuleTreeNodeList</span><span class="params">(Long treeId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢è§„åˆ™æ ‘èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> treeId    è§„åˆ™æ ‘ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>          èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">queryTreeNodeCount</span><span class="params">(Long treeId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢è§„åˆ™æ ‘èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> treeId    è§„åˆ™æ ‘ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>          èŠ‚ç‚¹é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;RuleTreeNodePO&gt; <span class="title function_">queryTreeRulePoint</span><span class="params">(Long treeId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ˜ å°„ SQL è¯­å¥:</strong> MyBatis ä½¿ç”¨ XML æ–‡ä»¶æˆ–æ³¨è§£çš„æ–¹å¼å°† SQL è¯­å¥ä¸ Java æ–¹æ³•å…³è”èµ·æ¥ã€‚ä¾‹å¦‚ï¼ŒqueryRuleTreeNodeList æ–¹æ³•ä¼šå¯¹åº”ä¸€ä¸ª SQL æŸ¥è¯¢è¯­å¥ï¼Œè¯¥è¯­å¥ç”¨äºæŸ¥è¯¢è§„åˆ™æ ‘èŠ‚ç‚¹ã€‚</p>
<p><strong>å‚æ•°ç»‘å®š:</strong> MyBatis ä¼šå°† Java æ–¹æ³•çš„å‚æ•°ç»‘å®šåˆ° SQL è¯­å¥ä¸­çš„å‚æ•°å ä½ç¬¦ã€‚ä¾‹å¦‚ï¼ŒqueryRuleTreeNodeList æ–¹æ³•çš„ treeId å‚æ•°ä¼šè¢«ç»‘å®šåˆ° SQL è¯­å¥ä¸­çš„ #{treeId} å ä½ç¬¦ã€‚</p>
<p><strong>ç»“æœæ˜ å°„:</strong> MyBatis ä¼šå°† SQL æŸ¥è¯¢ç»“æœæ˜ å°„åˆ° Java å¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒqueryRuleTreeNodeList æ–¹æ³•çš„è¿”å›å€¼ç±»å‹æ˜¯ <code>List&lt;RuleTreeNodePO&gt;</code>ï¼ŒMyBatis ä¼šå°†æŸ¥è¯¢ç»“æœçš„æ¯ä¸€è¡Œæ˜ å°„åˆ°ä¸€ä¸ª <code>RuleTreeNodePO</code> å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›å¯¹è±¡æ·»åŠ åˆ°ä¸€ä¸ª List ä¸­è¿”å›ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;cn.bugstack.xfg.frame.infrastructure.dao.RuleTreeNodeDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;ruleTreeNodeMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;cn.bugstack.xfg.frame.infrastructure.po.RuleTreeNodePO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;tree_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;treeId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;node_type&quot;</span> <span class="attr">property</span>=<span class="string">&quot;nodeType&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;node_value&quot;</span> <span class="attr">property</span>=<span class="string">&quot;nodeValue&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;rule_key&quot;</span> <span class="attr">property</span>=<span class="string">&quot;ruleKey&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;rule_desc&quot;</span> <span class="attr">property</span>=<span class="string">&quot;ruleDesc&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryRuleTreeNodeList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;ruleTreeNodeMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT id, tree_id, node_type, node_value, rule_key, rule_desc</span><br><span class="line">        FROM rule_tree_node</span><br><span class="line">        where tree_id = #&#123;treeId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryTreeNodeCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">        select count(id) from rule_tree_node where tree_id = #&#123;treeId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryTreeRulePoint&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;ruleTreeNodeMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT distinct (rule_key), rule_desc</span><br><span class="line">        FROM rule_tree_node</span><br><span class="line">        where tree_id = #&#123;treeId&#125; and rule_key is not null</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="JDBCä¸Hibernate-JPA-MyBatis">JDBCä¸Hibernate, JPA, MyBatis</h3>
<p>ORMï¼Œä¹Ÿæ˜¯å»ºç«‹åœ¨JDBCçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ResultSetåˆ°JavaBeançš„æ˜ å°„ï¼Œå®ç°å„ç§æŸ¥è¯¢ã€‚æœ‰è‡ªåŠ¨è·Ÿè¸ªEntityä¿®æ”¹çš„å…¨è‡ªåŠ¨åŒ–ORMå¦‚Hibernateå’ŒJPAï¼Œéœ€è¦ä¸ºæ¯ä¸ªEntityåˆ›å»ºä»£ç†ï¼Œä¹Ÿæœ‰å®Œå…¨è‡ªå·±æ˜ å°„ï¼Œè¿INSERTå’ŒUPDATEè¯­å¥éƒ½éœ€è¦æ‰‹åŠ¨ç¼–å†™çš„MyBatisï¼Œä½†æ²¡æœ‰ä»»ä½•é€æ˜çš„Proxyã€‚</p>
<h3 id="Spring-Transaction">Spring Transaction</h3>
<p>åœ¨Beanå†…ä½¿ç”¨ <code>@Transactional</code> æ³¨è§£æ˜¯æœ€æ¨èçš„æ–¹å¼ï¼ŒåŸºäºAOPå®ç°</p>
<p>æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li><strong>è¢« @Transactional æ³¨è§£çš„æ–¹æ³•ä¸èƒ½æ˜¯ private çš„</strong> Spring AOP çš„ä»£ç†æœºåˆ¶æ— æ³•æ‹¦æˆª private æ–¹æ³•ï¼Œå› æ­¤ @Transactional æ³¨è§£åœ¨ private æ–¹æ³•ä¸Šä¸ä¼šç”Ÿæ•ˆã€‚</li>
<li><strong>æ–¹æ³•å†…ä½¿ç”¨ try-catch å¤„ç†å¼‚å¸¸</strong> å¯ä»¥åœ¨ @Transactional æ–¹æ³•å†…éƒ¨ä½¿ç”¨ try-catch å—æ¥å¤„ç†å¼‚å¸¸ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ•è·äº†å¼‚å¸¸å¹¶ä¸”<strong>æ²¡æœ‰é‡æ–°æŠ›å‡º</strong>ï¼ŒSpring çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶å°±æ— æ³•æ„ŸçŸ¥åˆ°å¼‚å¸¸çš„å‘ç”Ÿï¼Œä»è€Œå¯¼è‡´äº‹åŠ¡ä¸ä¼šå›æ»šã€‚ å¦‚æœå¸Œæœ›äº‹åŠ¡åœ¨ç‰¹å®šå¼‚å¸¸å‘ç”Ÿæ—¶å›æ»šï¼Œä½ éœ€è¦åœ¨ catch å—ä¸­é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œæˆ–è€…æŠ›å‡ºä¸€ä¸ª Spring èƒ½å¤Ÿè¯†åˆ«çš„å¼‚å¸¸ç±»å‹ï¼ˆä¾‹å¦‚ RuntimeException æˆ–å…¶å­ç±»ï¼‰ã€‚</li>
<li><strong>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸æ˜¯ RuntimeException</strong> Spring çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶é»˜è®¤åªå¯¹ RuntimeExceptionï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰åŠå…¶å­ç±»è¿›è¡Œå›æ»šã€‚ ä½†æ˜¯ï¼Œä½ å¯ä»¥é€šè¿‡ @Transactional æ³¨è§£çš„ rollbackFor å±æ€§æ¥æŒ‡å®šéœ€è¦å›æ»šçš„å…¶ä»–å¼‚å¸¸ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥æŒ‡å®š rollbackFor = Exception.class æ¥è®©äº‹åŠ¡åœ¨ä»»ä½•å¼‚å¸¸å‘ç”Ÿæ—¶éƒ½å›æ»šã€‚ ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ noRollbackFor å±æ€§æ¥æŒ‡å®šä¸å›æ»šçš„å¼‚å¸¸ç±»å‹ã€‚</li>
</ul>
<h3 id="MyBatis">MyBatis</h3>
<p><strong><code>#&#123;&#125;</code> å’Œ <code>$&#123;&#125;</code> åŒºåˆ«</strong></p>
<ul>
<li><code>#&#123;&#125;</code> æ˜¯é¢„ç¼–è¯‘å¤„ç†ï¼Œä¼šå°†å‚æ•°æ›¿æ¢ä¸º?</li>
<li><code>$&#123;&#125;</code> æ˜¯å­—ç¬¦ä¸²æ›¿æ¢ï¼Œç›´æ¥å°†å‚æ•°æ‹¼æ¥åˆ°SQLä¸­ï¼Œå­˜åœ¨SQLæ³¨å…¥é£é™©</li>
</ul>
<p>åœ¨ MyBatis ä¸­ï¼Œæ³¨è§£ <code>@Select</code> ç”¨æ¥å®šä¹‰ SQL æŸ¥è¯¢ã€‚å¯¹äºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;SELECT * FROM user WHERE user_name = #&#123;username&#125;&quot;)</span></span><br><span class="line">User <span class="title function_">getUserByName</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè¿‡ç¨‹</p>
<ol>
<li><strong>æŸ¥è¯¢æ‰§è¡Œ</strong>ï¼šå½“ä½ è°ƒç”¨ <code>getUserByName</code> æ–¹æ³•æ—¶ï¼ŒMyBatis å°†æ¥æ”¶ä¼ å…¥çš„ <code>username</code> å‚æ•°ï¼Œå¹¶å°†å…¶æ³¨å…¥åˆ° SQL è¯­å¥ä¸­æ›¿æ¢ <code>#&#123;username&#125;</code> å ä½ç¬¦ã€‚</li>
<li><strong>SQL æŸ¥è¯¢</strong>ï¼šMyBatis ä¼šåœ¨æ•°æ®åº“ä¸­æ‰§è¡Œæ›¿æ¢åçš„ SQL æŸ¥è¯¢ã€‚</li>
<li><strong>ç»“æœæ˜ å°„</strong>ï¼šæŸ¥è¯¢ç»“æœå°†æ˜ å°„åˆ° <code>User</code> å¯¹è±¡ã€‚MyBatis ä½¿ç”¨ <strong>ç»“æœæ˜ å°„</strong> æœºåˆ¶ï¼Œå°†æŸ¥è¯¢å¾—åˆ°çš„æ•°æ®åº“è®°å½•ä¸­çš„å­—æ®µä¸ <code>User</code> ç±»çš„å±æ€§è¿›è¡ŒåŒ¹é…ã€‚æ˜ å°„çš„ä¾æ®é€šå¸¸æ˜¯å­—æ®µåç§°å’Œå±æ€§åç§°ç›¸åŒã€‚</li>
</ol>
<p>ç»“æœå¤„ç†</p>
<ul>
<li><strong>è‡ªåŠ¨æ˜ å°„</strong>ï¼šMyBatis ä¼šæ ¹æ® <code>User</code> ç±»çš„å±æ€§åç§°ä¸ <code>SELECT</code> è¯­å¥è¿”å›çš„åˆ—åç§°è¿›è¡Œæ˜ å°„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„ <code>user</code> è¡¨æœ‰ <code>id</code>, <code>user_name</code>, <code>password</code> ç­‰å­—æ®µï¼ŒMyBatis ä¼šè‡ªåŠ¨å°†è¿™äº›åˆ—çš„å€¼å¡«å……åˆ° <code>User</code> ç±»çš„ <code>id</code>, <code>userName</code>, <code>password</code> ç­‰ç›¸åº”çš„å±æ€§ä¸­ã€‚</li>
<li><strong>æ˜ å°„è§„åˆ™</strong>ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒMyBatis ä½¿ç”¨ <strong>é©¼å³°å‘½åè§„åˆ™</strong>ï¼Œå³å¦‚æœæ•°æ®åº“ä¸­åˆ—çš„åç§°æ˜¯ <code>user_name</code>ï¼Œå®ƒä¼šæ˜ å°„åˆ° Java ç±»ä¸­çš„ <code>userName</code> å±æ€§ã€‚å¦‚æœå±æ€§å’Œåˆ—åä¸åŒ¹é…ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨ <code>@Results</code> æˆ– XML é…ç½®æ¥æ‰‹åŠ¨æŒ‡å®šæ˜ å°„å…³ç³»ã€‚</li>
</ul>
<p>ç»“æœè¿”å›</p>
<ul>
<li><strong>è¿”å›å¯¹è±¡</strong>ï¼š<code>getUserByName</code> æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª <code>User</code> å¯¹è±¡ï¼Œå¦‚æœæŸ¥è¯¢åˆ°çš„ç»“æœä¸ºç©ºï¼Œæ–¹æ³•å°†è¿”å› <code>null</code>ã€‚</li>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå¦‚æœæŸ¥è¯¢è¿”å›äº†å¤šè¡Œï¼Œè€Œè¯¥æ–¹æ³•å®šä¹‰ä¸ºè¿”å›å•ä¸ª <code>User</code> å¯¹è±¡ï¼ŒMyBatis å°†æŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>
<h2 id="Spring-MVC">Spring MVC</h2>
<p>æ ‡å‡†çš„Maven Webå·¥ç¨‹ç›®å½•ç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring-web-mvc</span><br><span class="line">â”œâ”€â”€ pom.xml</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â””â”€â”€ main</span><br><span class="line">        â”œâ”€â”€ java</span><br><span class="line">        â”‚   â””â”€â”€ com</span><br><span class="line">        â”‚       â””â”€â”€ itranswarp</span><br><span class="line">        â”‚           â””â”€â”€ learnjava</span><br><span class="line">        â”‚               â”œâ”€â”€ AppConfig.java  // Springé…ç½®ç±»</span><br><span class="line">        â”‚               â”œâ”€â”€ DatabaseInitializer.java</span><br><span class="line">        â”‚               â”œâ”€â”€ entity</span><br><span class="line">        â”‚               â”‚   â””â”€â”€ User.java</span><br><span class="line">        â”‚               â”œâ”€â”€ service</span><br><span class="line">        â”‚               â”‚   â””â”€â”€ UserService.java</span><br><span class="line">        â”‚               â””â”€â”€ web</span><br><span class="line">        â”‚                   â””â”€â”€ UserController.java</span><br><span class="line">        â”œâ”€â”€ resources</span><br><span class="line">        â”‚   â”œâ”€â”€ jdbc.properties  // æ•°æ®åº“è¿æ¥é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æ•°æ®åº“URLã€ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯ã€‚</span><br><span class="line">        â”‚   â””â”€â”€ logback.xml  // æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ—¥å¿—è¾“å‡ºæ ¼å¼ã€çº§åˆ«ç­‰ã€‚</span><br><span class="line">        â””â”€â”€ webapp</span><br><span class="line">            â”œâ”€â”€ WEB-INF</span><br><span class="line">            â”‚   â”œâ”€â”€ templates</span><br><span class="line">            â”‚   â”‚   â”œâ”€â”€ _base.html</span><br><span class="line">            â”‚   â”‚   â”œâ”€â”€ index.html</span><br><span class="line">            â”‚   â”‚   â”œâ”€â”€ profile.html</span><br><span class="line">            â”‚   â”‚   â”œâ”€â”€ register.html</span><br><span class="line">            â”‚   â”‚   â””â”€â”€ signin.html</span><br><span class="line">            â”‚   â””â”€â”€ web.xml  // æŒ‡å¯¼ Web å®¹å™¨ï¼ˆä¾‹å¦‚ Tomcatï¼‰å¦‚ä½•éƒ¨ç½²å’Œè¿è¡Œåº”ç”¨, ä¸€èˆ¬åŒ…å«Servletä¿¡æ¯,servlet-mappingä¿¡æ¯, Filterä¿¡æ¯, welcomeé¡µé¢ä¿¡æ¯.</span><br><span class="line">            â””â”€â”€ static</span><br><span class="line">                â”œâ”€â”€ css</span><br><span class="line">                â”‚   â””â”€â”€ bootstrap.css</span><br><span class="line">                â””â”€â”€ js</span><br><span class="line">                    â””â”€â”€ jquery.js</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Spring Web MVC çš„æ ‡å‡†åšæ³•ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ª Servlet, å¤šä¸ª Filter,</p>
</blockquote>
<h3 id="å¯åŠ¨">å¯åŠ¨</h3>
<p><strong>ä¼ ç»Ÿçš„éƒ¨ç½²æ–¹å¼ (WARåŒ…éƒ¨ç½²åˆ°å¤–éƒ¨Tomcat):</strong></p>
<ol>
<li><strong>æ„å»ºWARåŒ…:</strong> ä½¿ç”¨Mavenæˆ–Gradleç­‰æ„å»ºå·¥å…·å°†Spring MVCé¡¹ç›®æ‰“åŒ…æˆWARæ–‡ä»¶ã€‚</li>
<li><strong>éƒ¨ç½²WARåŒ…:</strong> å°†WARæ–‡ä»¶å¤åˆ¶åˆ°Tomcatçš„webappsç›®å½•ä¸‹ã€‚</li>
<li><strong>Tomcatå¯åŠ¨:</strong> å¯åŠ¨TomcatæœåŠ¡å™¨ã€‚</li>
<li><strong>WARåŒ…è§£å‹:</strong> Tomcatä¼šè‡ªåŠ¨è§£å‹WARæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªåŒåçš„Webåº”ç”¨ç›®å½•ã€‚</li>
<li><strong>è¯»å–web.xml:</strong> Tomcatè¯»å–Webåº”ç”¨ç›®å½•ä¸‹çš„WEB-INF/web.xmlæ–‡ä»¶ã€‚</li>
<li><strong>åˆå§‹åŒ–DispatcherServlet:</strong> Tomcatæ ¹æ®web.xmlä¸­çš„é…ç½®ï¼Œåˆå§‹åŒ–DispatcherServletã€‚</li>
<li><strong>åˆ›å»ºWebApplicationContext:</strong> DispatcherServletåˆå§‹åŒ–æ—¶ï¼Œä¼šæ ¹æ®contextConfigLocationå‚æ•°æŒ‡å®šçš„é…ç½®ç±»ï¼ˆä¾‹å¦‚AppConfigï¼‰åˆ›å»ºWebApplicationContextï¼ˆSpringçš„IoCå®¹å™¨ï¼‰ã€‚</li>
<li><strong>æ‰«æå’Œåˆå§‹åŒ–Bean:</strong> WebApplicationContextä¼šæ‰«ææŒ‡å®šçš„åŒ…ï¼ŒæŸ¥æ‰¾å¹¶åˆå§‹åŒ–æ‰€æœ‰å¸¦æœ‰@Componentã€@Serviceã€@Repositoryã€@Controllerç­‰æ³¨è§£çš„Beanã€‚</li>
<li><strong>åˆå§‹åŒ–å…¶ä»–ç»„ä»¶:</strong> WebApplicationContextè¿˜ä¼šåˆå§‹åŒ–Spring MVCçš„å…¶ä»–ç»„ä»¶ï¼Œä¾‹å¦‚HandlerMappingã€ViewResolverç­‰ã€‚</li>
<li><strong>åº”ç”¨å¯åŠ¨å®Œæˆ:</strong> Tomcatå®ŒæˆWebåº”ç”¨çš„å¯åŠ¨ï¼ŒDispatcherServletå‡†å¤‡å¥½æ¥æ”¶HTTPè¯·æ±‚ã€‚</li>
</ol>
<p><strong>åµŒå…¥å¼Tomcat:</strong></p>
<ol>
<li><strong>æ·»åŠ ä¾èµ–:</strong> åœ¨pom.xmlä¸­æ·»åŠ Spring Boot Starter Webä¾èµ–ï¼Œè¯¥ä¾èµ–åŒ…å«äº†åµŒå…¥å¼Tomcatã€‚</li>
<li><strong>ç¼–å†™å¯åŠ¨ç±»:</strong> åˆ›å»ºä¸€ä¸ªå¸¦æœ‰main()æ–¹æ³•çš„å¯åŠ¨ç±»ï¼Œä½¿ç”¨@SpringBootApplicationæ³¨è§£æ ‡è®°ã€‚</li>
<li><strong>è¿è¡Œmain()æ–¹æ³•:</strong> è¿è¡Œå¯åŠ¨ç±»çš„main()æ–¹æ³•ã€‚</li>
<li><strong>Spring Bootåˆå§‹åŒ–:</strong> Spring Bootä¼šè¿›è¡Œè‡ªåŠ¨é…ç½®ï¼Œæ ¹æ®classpathä¸­çš„ä¾èµ–è‡ªåŠ¨é…ç½®Spring MVCã€åµŒå…¥å¼Tomcatç­‰ç»„ä»¶ã€‚</li>
<li><strong>å¯åŠ¨åµŒå…¥å¼Tomcat:</strong> Spring Bootå¯åŠ¨åµŒå…¥å¼TomcatæœåŠ¡å™¨ã€‚</li>
<li><strong>åˆ›å»ºWebApplicationContext:</strong> ä¸ä¼ ç»Ÿæ–¹å¼ç±»ä¼¼ï¼ŒSpring Bootä¼šåˆ›å»ºWebApplicationContextã€‚</li>
<li><strong>æ‰«æå’Œåˆå§‹åŒ–Bean:</strong> WebApplicationContextæ‰«æå¹¶åˆå§‹åŒ–Beanã€‚</li>
<li><strong>åˆå§‹åŒ–DispatcherServlet:</strong> Spring Bootå°†DispatcherServletæ³¨å†Œåˆ°åµŒå…¥å¼Tomcatä¸­ã€‚</li>
<li><strong>åº”ç”¨å¯åŠ¨å®Œæˆ:</strong> åµŒå…¥å¼Tomcatå¯åŠ¨å®Œæˆï¼ŒDispatcherServletå‡†å¤‡å¥½æ¥æ”¶HTTPè¯·æ±‚ã€‚</li>
</ol>
<blockquote>
<p>è¯¥æ–¹å¼å®Œå…¨è¿è¡Œåœ¨ä¸€ä¸ªJVMå†…éƒ¨</p>
<ul>
<li><strong>Spring Bootåº”ç”¨ç®¡ç†åµŒå…¥å¼Tomcatçš„ç”Ÿå‘½å‘¨æœŸ:</strong> Spring Bootåº”ç”¨è´Ÿè´£å¯åŠ¨ã€åœæ­¢å’Œé…ç½®åµŒå…¥å¼Tomcatã€‚</li>
<li><strong>åµŒå…¥å¼Tomcatæä¾›Servletå®¹å™¨çš„åŠŸèƒ½:</strong> åµŒå…¥å¼Tomcatè´Ÿè´£æ¥æ”¶HTTPè¯·æ±‚ã€ç®¡ç†Servletç”Ÿå‘½å‘¨æœŸã€å¤„ç†Servletè¯·æ±‚ç­‰ã€‚</li>
<li><strong>DispatcherServletæ˜¯è¿è¡Œåœ¨åµŒå…¥å¼Tomcatä¸­çš„ä¸€ä¸ªServlet:</strong> DispatcherServletä¾èµ–äºåµŒå…¥å¼Tomcatæä¾›çš„Servletå®¹å™¨åŠŸèƒ½ï¼Œå®ƒè¢«æ³¨å†Œåˆ°åµŒå…¥å¼Tomcatä¸­ï¼Œç”±åµŒå…¥å¼Tomcatè´Ÿè´£è°ƒç”¨å®ƒçš„service()æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ã€‚</li>
</ul>
<p>DispatcherServletçš„å®ä¾‹æ˜¯ç”±åµŒå…¥å¼Tomcatåˆ›å»ºçš„ï¼Œä½†å®ƒçš„åˆå§‹åŒ–å’Œé…ç½®æ˜¯ç”±Spring Bootå®Œæˆçš„ã€‚ Spring Bootä¼šå°†DispatcherSeHrvletæ³¨å†Œåˆ°åµŒå…¥å¼Tomcatä¸­ï¼Œå¹¶å°†å…¶ä¸Springçš„WebApplicationContextå…³è”èµ·æ¥ã€‚ è¿™æ ·ï¼ŒDispatcherServletå°±å¯ä»¥è®¿é—®Springå®¹å™¨ä¸­çš„Beanï¼Œå¹¶ä½¿ç”¨Spring MVCçš„åŠŸèƒ½æ¥å¤„ç†è¯·æ±‚ã€‚</p>
</blockquote>
<h3 id="HandlerMapping">HandlerMapping</h3>
<p><code>HandlerMapping</code>åœ¨Springåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œåˆå§‹åŒ–ã€‚å®ƒä¼šæ‰«ææ•´ä¸ªé¡¹ç›®ï¼Œç¼“å­˜æ‰€æœ‰å¸¦æœ‰ç›¸å…³æ³¨è§£ï¼ˆå¦‚<code>@RequestMapping</code>ã€<code>@GetMapping</code>ç­‰ï¼‰çš„Controlleræ–¹æ³•çš„<code>request</code>-<code>handler</code>æ˜ å°„åˆ°<code>HandlerMapping</code>çš„beanä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â” â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€</span><br><span class="line">  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span><br><span class="line">â”‚ â”‚DelegatingFilterProxyâ”‚â”€â”‚â”€â”‚â”€ â”€â–¶â”‚AuthFilter â”‚</span><br><span class="line">  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span><br><span class="line">â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">  â”‚  DispatcherServlet  â”‚â”€ â”€ â”€ â”€â–¶â”‚Controllersâ”‚   â”‚</span><br><span class="line">â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                                                 â”‚</span><br><span class="line">â”‚    Servlet Container    â”‚ â”‚  Spring Container</span><br><span class="line"> â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€   â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜</span><br></pre></td></tr></table></figure>
<h3 id="REST-æ¶æ„é£æ ¼">REST æ¶æ„é£æ ¼</h3>
<p>RESTï¼ˆRepresentational State Transferï¼‰æ˜¯ä¸€ç§è®¾è®¡ Web æœåŠ¡çš„æ¶æ„é£æ ¼ï¼Œå®ƒå¼ºè°ƒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’åº”è¯¥å›´ç»• <strong>èµ„æº</strong> å±•å¼€ï¼Œå¹¶ä½¿ç”¨æ ‡å‡†çš„ HTTP æ–¹æ³•æ¥æ“ä½œè¿™äº›èµ„æºã€‚</p>
<ul>
<li><strong>èµ„æºï¼ˆResourcesï¼‰ï¼š</strong> REST æ¶æ„çš„æ ¸å¿ƒæ˜¯èµ„æºã€‚ä»»ä½•å¯ä»¥è¢«å‘½åçš„ä¿¡æ¯éƒ½å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªèµ„æºï¼Œä¾‹å¦‚ä¸€ä¸ªæ–‡æ¡£ã€ä¸€å¼ å›¾ç‰‡ã€ä¸€ä¸ªç”¨æˆ·ã€ä¸€ä¸ªè®¢å•ç­‰ã€‚æ¯ä¸ªèµ„æºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆURIï¼‰ã€‚</li>
<li><strong>è¡¨è¿°ï¼ˆRepresentationsï¼‰ï¼š</strong> èµ„æºçš„è¡¨è¿°æ˜¯èµ„æºåœ¨æŸä¸ªç‰¹å®šæ—¶åˆ»çš„çŠ¶æ€çš„å±•ç°å½¢å¼ã€‚å®ƒå¯ä»¥æ˜¯å„ç§æ ¼å¼ï¼Œä¾‹å¦‚ JSONã€XMLã€HTML ç­‰ã€‚å®¢æˆ·ç«¯é€šè¿‡è·å–èµ„æºçš„è¡¨è¿°æ¥äº†è§£èµ„æºçš„çŠ¶æ€ã€‚</li>
<li><strong>çŠ¶æ€è½¬ç§»ï¼ˆState Transferï¼‰ï¼š</strong> å®¢æˆ·ç«¯é€šè¿‡ HTTP æ–¹æ³•ï¼ˆä¾‹å¦‚ GETã€POSTã€PUTã€DELETEï¼‰ä¸æœåŠ¡å™¨äº¤äº’ï¼Œä»è€Œæ”¹å˜èµ„æºçš„çŠ¶æ€ã€‚è¿™äº› HTTP æ–¹æ³•å¯¹åº”ç€ä¸åŒçš„æ“ä½œï¼š
<ul>
<li><strong>GET:</strong> è·å–èµ„æºçš„è¡¨è¿°ã€‚</li>
<li><strong>POST:</strong> åˆ›å»ºæ–°çš„èµ„æºã€‚</li>
<li><strong>PUT:</strong> æ›´æ–°ç°æœ‰èµ„æºã€‚</li>
<li><strong>DELETE:</strong> åˆ é™¤èµ„æºã€‚</li>
</ul>
</li>
<li><strong>æ— çŠ¶æ€ï¼ˆStatelessï¼‰ï¼š</strong> RESTful API æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªè¯·æ±‚éƒ½åŒ…å«äº†å¤„ç†è¯¥è¯·æ±‚æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ã€‚æœåŠ¡å™¨ä¸å­˜å‚¨å®¢æˆ·ç«¯çš„ä»»ä½•çŠ¶æ€ä¿¡æ¯ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>HTTP æ–¹æ³•</th>
<th>REST æ“ä½œ</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>è·å–èµ„æº</td>
<td>è·å–èµ„æºçš„è¡¨è¿°</td>
</tr>
<tr>
<td>POST</td>
<td>åˆ›å»ºèµ„æº</td>
<td>åˆ›å»ºæ–°çš„èµ„æº</td>
</tr>
<tr>
<td>PUT</td>
<td>æ›´æ–°èµ„æº</td>
<td>æ›¿æ¢æ•´ä¸ªèµ„æº</td>
</tr>
<tr>
<td>PATCH</td>
<td>éƒ¨åˆ†æ›´æ–°èµ„æº</td>
<td>æ›´æ–°èµ„æºçš„ä¸€éƒ¨åˆ†</td>
</tr>
<tr>
<td>DELETE</td>
<td>åˆ é™¤èµ„æº</td>
<td>åˆ é™¤èµ„æº</td>
</tr>
</tbody>
</table>
<p><strong>RESTful è¯·æ±‚</strong>æ˜¯æŒ‡ç¬¦åˆ REST æ¶æ„é£æ ¼çš„ HTTP è¯·æ±‚ã€‚å®ƒé€šå¸¸åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>
<ul>
<li><strong>URLï¼š</strong> æŒ‡å‘è¦æ“ä½œçš„èµ„æºçš„å”¯ä¸€åœ°å€ã€‚</li>
<li><strong>HTTP æ–¹æ³•ï¼š</strong> æŒ‡ç¤ºè¦æ‰§è¡Œçš„æ“ä½œï¼ˆGETã€POSTã€PUTã€DELETE ç­‰ï¼‰ã€‚</li>
<li><strong>è¯·æ±‚å¤´ï¼š</strong> åŒ…å«ä¸€äº›å…ƒæ•°æ®ï¼Œä¾‹å¦‚å†…å®¹ç±»å‹ã€æˆæƒä¿¡æ¯ç­‰ã€‚</li>
<li><strong>è¯·æ±‚ä½“ï¼š</strong> å¯¹äº POST å’Œ PUT è¯·æ±‚ï¼Œå¯èƒ½åŒ…å«è¦åˆ›å»ºæˆ–æ›´æ–°çš„èµ„æºçš„æ•°æ®ã€‚</li>
</ul>
<p><strong>ä¾‹å¦‚ï¼š</strong></p>
<p>ä¸€ä¸ªè·å–ç”¨æˆ·ä¿¡æ¯çš„ RESTful è¯·æ±‚å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">GET /users/123</span><br></pre></td></tr></table></figure>
<h1>Spring Boot</h1>
<p><a href="https://liaoxuefeng.com/books/java/springboot/index.html">https://liaoxuefeng.com/books/java/springboot/index.html</a></p>
<p>è¿™äº›è‡ªåŠ¨åˆ›å»ºçš„Beanå°±æ˜¯Spring Bootçš„ç‰¹è‰²ï¼šAutoConfigurationã€‚</p>
<p>å½“æˆ‘ä»¬å¼•å…¥<code>spring-boot-starter-jdbc</code>æ—¶ï¼Œå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰çš„<code>XxxAutoConfiguration</code>ï¼š</p>
<ul>
<li><code>DataSourceAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>DataSource</code>ï¼Œå…¶ä¸­é…ç½®é¡¹ä»<code>application.yml</code>çš„<code>spring.datasource</code>è¯»å–ï¼›</li>
<li><code>DataSourceTransactionManagerAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ªåŸºäºJDBCçš„äº‹åŠ¡ç®¡ç†å™¨ï¼›</li>
<li><code>JdbcTemplateAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª<code>JdbcTemplate</code>ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è‡ªåŠ¨å¾—åˆ°äº†ä¸€ä¸ª<code>DataSource</code>ã€ä¸€ä¸ª<code>DataSourceTransactionManager</code>å’Œä¸€ä¸ª<code>JdbcTemplate</code>ã€‚</p>
<p>ç±»ä¼¼çš„ï¼Œå½“æˆ‘ä»¬å¼•å…¥<code>spring-boot-starter-web</code>æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºäº†ï¼š</p>
<ul>
<li><code>ServletWebServerFactoryAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåµŒå…¥å¼WebæœåŠ¡å™¨ï¼Œé»˜è®¤æ˜¯Tomcatï¼›</li>
<li><code>DispatcherServletAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>DispatcherServlet</code>ï¼›</li>
<li><code>HttpEncodingAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>CharacterEncodingFilter</code>ï¼›</li>
<li><code>WebMvcAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºè‹¥å¹²ä¸MVCç›¸å…³çš„Beanã€‚</li>
<li>â€¦</li>
</ul>
<p>å¼•å…¥ç¬¬ä¸‰æ–¹<code>pebble-spring-boot-starter</code>æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºäº†ï¼š</p>
<ul>
<li><code>PebbleAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª<code>PebbleViewResolver</code>ã€‚</li>
</ul>
<h2 id="æ³¨è§£-2">æ³¨è§£</h2>
<p>åŸºäº Spring Boot åº”ç”¨ç¨‹åº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">     SpringApplication.run(Application.class, args);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring å®¹å™¨çš„åˆ›å»ºæ˜¯é€šè¿‡ <code>@SpringBootApplication</code> æ³¨è§£è§¦å‘çš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼ŒåŒ…å«äº† <code>@Configuration</code>ã€<code>@EnableAutoConfiguration</code> å’Œ <code>@ComponentScan</code>ã€‚</p>
<p><strong><code>SpringApplication.run()</code></strong>ï¼šè¿™æ˜¯ Spring Boot åº”ç”¨ç¨‹åºçš„å…¥å£ã€‚è¿™ä¸ªæ–¹æ³•å¯åŠ¨äº† Spring Boot åº”ç”¨ï¼Œå¹¶åˆ›å»ºäº† IoC å®¹å™¨ã€‚<code>@SpringBootApplication</code> ä¼šè‡ªåŠ¨æ‰«ææŒ‡å®šçš„åŒ…è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ° IoC å®¹å™¨ä¸­ã€‚</p>
<p>@Configurable</p>
<p>@Configurable å…è®¸å°† Spring ç®¡ç†çš„ Bean æ³¨å…¥åˆ°é€šè¿‡ new å…³é”®å­—åˆ›å»ºçš„å¯¹è±¡ä¸­ã€‚è¿™åœ¨ä¸€äº›æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨é—ç•™ä»£ç æˆ–æ— æ³•ç›´æ¥ä½¿ç”¨ Spring ç®¡ç†çš„åº“æ—¶ã€‚</p>
<p>è¢«æ·»åŠ  @Configurable æ³¨è§£çš„ç±»ï¼Œåœ¨è¢«newåˆ›å»ºæ—¶ï¼ŒAspectJ çš„ä»£ç ä¼šæ‹¦æˆªå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¹¶ä½¿ç”¨ Spring çš„ BeanFactory å°†ä¾èµ–æ³¨å…¥åˆ°å¯¹è±¡ä¸­ï¼ˆå³ä¸ä¼šnewå‡ºæ–°å¯¹è±¡ï¼Œå°†ä»Springä¸­è·å¾—å·²ç»åˆ›å»ºçš„è¯¥ç±»å‹çš„Beanä½œä¸ºnewçš„ç»“æœï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        repository.save(<span class="string">&quot;some data&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ new åˆ›å»ºå¯¹è±¡</span></span><br><span class="line"><span class="type">MyService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyService</span>();</span><br><span class="line">service.doSomething(); <span class="comment">// repository å·²ç»è¢«æ³¨å…¥ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨</span></span><br></pre></td></tr></table></figure>
<p>@ConfigurationProperties</p>
<p>è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå°†é…ç½®æ–‡ä»¶ä¸­ç›¸åº”çš„å€¼æ³¨å…¥åˆ°Beanä¸­</p>
<blockquote>
<p>é…ç½®æ–‡ä»¶æœç´¢ä½ç½®</p>
<p>æ‰“åŒ…åœ¨åº”ç”¨ç¨‹åºä¸­çš„ç‰¹å®šäºé…ç½®æ–‡ä»¶çš„åº”ç”¨ç¨‹åºå±æ€§ï¼ˆapplication-{profile}.properties å’Œ YAML å˜ä½“ï¼‰</p>
<p>æ‰“åŒ…åœ¨åº”ç”¨ç¨‹åºä¸­çš„åº”ç”¨ç¨‹åºå±æ€§ï¼ˆapplication.properties å’Œ YAML å˜ä½“ï¼‰</p>
</blockquote>
<p>å‡è®¾æœ‰ä»¥ä¸‹é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ–‡ä»¶ï¼šapplication.properties  ymlæ ¼å¼</span></span><br><span class="line"><span class="attr">rate-limiter:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">unknown-property:</span> <span class="string">some-value</span></span><br></pre></td></tr></table></figure>
<p>ä»¥åŠä»¥ä¸‹ Java Beanï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ï¼šRateLimiterAopConfigProperties.java</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;rate-limiter&quot;, ignoreInvalidFields = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">limit</span> <span class="operator">=</span> <span class="number">200</span>;  <span class="comment">// é»˜è®¤å€¼200ï¼Œä¼šè¢«é…ç½®æ–‡ä»¶è¦†ç›–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// getters and setters for enabled and limit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äº ignoreInvalidFields = trueï¼Œunknown-property å°†ä¼šè¢«å¿½ç•¥ï¼Œè€Œ enabled å’Œ limit å°†åˆ†åˆ«è¢«è®¾ç½®ä¸º true å’Œ 100ã€‚</p>
<p>@EnableConfigurationProperties(â€¦)</p>
<p>å°†ä¸€ä¸ªç±»ä½œä¸ºé…ç½®å±æ€§ç±»ï¼Œå¹¶å¯ç”¨å±æ€§ç»‘å®šï¼›<strong>è¢«æŒ‡å®šä½œä¸ºé…ç½®å±æ€§ç±»å¯ä»¥æ²¡æœ‰ä»»ä½• Spring æ³¨è§£</strong></p>
<p>@Component + @ConfigurationProperties çš„é…ç½®å±æ€§ç±» ç­‰äº @EnableConfigurationProperties</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(AliPayConfigProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPayConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;alipayClient&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AlipayClient <span class="title function_">alipayClient</span><span class="params">(AliPayConfigProperties properties)</span> &#123;  <span class="comment">// beanå¯¹è±¡è¢«æ³¨å…¥ä½œä¸ºä¼ å…¥å‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(properties.getGatewayUrl(),</span><br><span class="line">                properties.getApp_id(),</span><br><span class="line">                properties.getMerchant_private_key(),</span><br><span class="line">                properties.getFormat(),</span><br><span class="line">                properties.getCharset(),</span><br><span class="line">                properties.getAlipay_public_key(),</span><br><span class="line">                properties.getSign_type());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>å¸¸ç”¨åº“</h1>
<h2 id="retrofit">retrofit</h2>
<p>Retrofit æ˜¯ä¸€ä¸ªç”¨äº Android å’Œ Java çš„ç±»å‹å®‰å…¨çš„ HTTP å®¢æˆ·ç«¯ï¼Œå®ƒé€šè¿‡å°† HTTP API è½¬æ¢ä¸º Java æ¥å£ï¼Œç®€åŒ–äº†ç½‘ç»œè¯·æ±‚çš„ç¼–å†™å’Œç®¡ç†ã€‚å®ƒåˆ©ç”¨æ³¨è§£æ¥æè¿° HTTP è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨ OkHttp åº“æ‰§è¡Œå®é™…çš„ç½‘ç»œæ“ä½œã€‚</p>
<p>ä¸€ä¸ªRetrofitçš„Callå¯¹è±¡é€šå¸¸åªå¯¹åº”<strong>ä¸€æ¬¡HTTPè¯·æ±‚å’Œä¸€æ¬¡HTTPå“åº”</strong></p>
<p>Call&lt;T&gt; çš„æ³›å‹Tæ˜¯ç”¨æ¥æŒ‡å®šè¯¥ HTTP è¯·æ±‚æˆåŠŸåï¼Œé¢„æœŸä»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ•°æ®ç±»å‹</p>
<p>æ¡ˆä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ API æ¥å£ï¼Œä½¿ç”¨æ¥å£å®šä¹‰ç½‘ç»œè¯·æ±‚</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ApiService</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @GET æ³¨è§£æŒ‡å®š GET è¯·æ±‚ï¼Œ@Path æ³¨è§£ç”¨äºæ›¿æ¢ URL è·¯å¾„ä¸­çš„å ä½ç¬¦ &#123;id&#125;</span></span><br><span class="line">    <span class="meta">@GET(&quot;/users/&#123;id&#125;&quot;)</span></span><br><span class="line">    Call&lt;User&gt; <span class="title function_">getUser</span><span class="params">(<span class="meta">@Path(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @Query æ³¨è§£æ·»åŠ æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">    <span class="meta">@GET(&quot;/users&quot;)</span></span><br><span class="line">    Call&lt;List&lt;User&gt;&gt; <span class="title function_">getUsers</span><span class="params">(<span class="meta">@Query(&quot;page&quot;)</span> <span class="type">int</span> page, <span class="meta">@Query(&quot;per_page&quot;)</span> <span class="type">int</span> perPage)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @QueryMap æ³¨è§£æ·»åŠ å¤šä¸ªæŸ¥è¯¢å‚æ•°ï¼Œä»¥ Map çš„å½¢å¼ä¼ é€’</span></span><br><span class="line">    <span class="meta">@GET(&quot;/users&quot;)</span></span><br><span class="line">    Call&lt;List&lt;User&gt;&gt; <span class="title function_">getUsers</span><span class="params">(<span class="meta">@QueryMap</span> Map&lt;String, String&gt; options)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @POST æ³¨è§£æŒ‡å®š POST è¯·æ±‚ï¼Œ@Headers æ³¨è§£æ·»åŠ é™æ€è¯·æ±‚å¤´, @Body æ³¨è§£ç”¨äºå‘é€è¯·æ±‚ä½“ï¼Œå³è¢«æ ‡è®°ä¼ å…¥å‚æ•°ä¼šç›´æ¥ä½œä¸ºpostæŠ¥æ–‡ä½“</span></span><br><span class="line">    <span class="meta">@POST(&quot;/users&quot;)</span></span><br><span class="line">    <span class="meta">@Headers(&#123;</span></span><br><span class="line"><span class="meta">            &quot;Content-Type: application/json&quot;,</span></span><br><span class="line"><span class="meta">            &quot;Accept: application/json&quot;</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    Call&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@Body</span> User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @FormUrlEncoded æ³¨è§£æŒ‡å®š POST è¯·æ±‚çš„ç¼–ç ç±»å‹ä¸º application/x-www-form-urlencodedï¼Œ@Field æ³¨è§£æ·»åŠ è¡¨å•æ•°æ®ï¼Œå³è¢«æ ‡è®°çš„ä¼ å…¥å‚æ•°ä¼šæ‹¼æ¥ï¼Œä½œä¸ºpostæŠ¥æ–‡ä½“</span></span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="meta">@POST(&quot;/users&quot;)</span></span><br><span class="line">    Call&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@Field(&quot;name&quot;)</span> String name, <span class="meta">@Field(&quot;email&quot;)</span> String email)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @FieldMap æ³¨è§£æ·»åŠ å¤šä¸ªè¡¨å•æ•°æ®ï¼Œä»¥ Map çš„å½¢å¼ä¼ é€’</span></span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="meta">@POST(&quot;/users&quot;)</span></span><br><span class="line">    Call&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@FieldMap</span> Map&lt;String, String&gt; fields)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @Multipart æ³¨è§£æŒ‡å®š POST è¯·æ±‚ä¸ºå¤šéƒ¨åˆ†è¯·æ±‚ï¼Œ@Part æ³¨è§£ç”¨äºå¤šéƒ¨åˆ†è¯·æ±‚ä¸­çš„æ¯ä¸ªéƒ¨åˆ†ï¼›è¯·æ±‚ä½“ä¼šè¢«åˆ†å‰²æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½åŒ…å«è‡ªå·±çš„å†…å®¹ç±»å‹ã€å¤´éƒ¨ä¿¡æ¯å’Œæ•°æ®ï¼›æŒ‰ç…§@Partè¿›è¡Œåˆ‡å‰²ï¼Œå³fileä¸ºå—1ï¼Œdescriptionä¸ºå—2</span></span><br><span class="line">    <span class="meta">@Multipart</span></span><br><span class="line">    <span class="meta">@POST(&quot;/upload&quot;)</span></span><br><span class="line">    Call&lt;ResponseBody&gt; <span class="title function_">uploadFile</span><span class="params">(<span class="meta">@Part(&quot;file&quot;)</span> RequestBody file, <span class="meta">@Part(&quot;description&quot;)</span> RequestBody description)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @PartMap æ³¨è§£æ·»åŠ å¤šä¸ª Partï¼Œä»¥ Map çš„å½¢å¼ä¼ é€’ï¼›æŒ‰ç…§ä¸€ä¸ªé”®å€¼å¯¹ä¸€å—è¿›è¡Œåˆ‡å‰²</span></span><br><span class="line">    <span class="meta">@Multipart</span></span><br><span class="line">    <span class="meta">@POST(&quot;/upload&quot;)</span></span><br><span class="line">    Call&lt;ResponseBody&gt; <span class="title function_">uploadMultipleFiles</span><span class="params">(<span class="meta">@PartMap</span> Map&lt;String, RequestBody&gt; files)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @PUT æ³¨è§£æŒ‡å®š PUT è¯·æ±‚</span></span><br><span class="line">    <span class="meta">@PUT(&quot;/users/&#123;id&#125;&quot;)</span></span><br><span class="line">    Call&lt;User&gt; <span class="title function_">updateUser</span><span class="params">(<span class="meta">@Path(&quot;id&quot;)</span> <span class="type">int</span> id, <span class="meta">@Body</span> User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @DELETE æ³¨è§£æŒ‡å®š DELETE è¯·æ±‚ï¼Œ@Header æ³¨è§£æ·»åŠ åŠ¨æ€è¯·æ±‚å¤´</span></span><br><span class="line">    <span class="meta">@DELETE(&quot;/users/&#123;id&#125;&quot;)</span></span><br><span class="line">    Call&lt;Void&gt; <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@Path(&quot;id&quot;)</span> <span class="type">int</span> id, <span class="meta">@Header(&quot;Authorization&quot;)</span> String authToken)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RetrofitExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// æ‹¦æˆªå™¨ æ‹¦æˆªçš„æ˜¯ OkHttp å‘å‡ºçš„ç½‘ç»œè¯·æ±‚</span></span><br><span class="line">        <span class="comment">// åˆ›å»º HttpLoggingInterceptorï¼Œç”¨äºæ‰“å°è¯·æ±‚å’Œå“åº”çš„æ—¥å¿—</span></span><br><span class="line">        <span class="type">HttpLoggingInterceptor</span> <span class="variable">loggingInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpLoggingInterceptor</span>();</span><br><span class="line">        loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY); <span class="comment">// è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º BODYï¼Œæ‰“å°è¯·æ±‚å’Œå“åº”ä½“</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œä¾‹å¦‚æ·»åŠ è®¤è¯ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Interceptor</span> <span class="variable">authInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">Request</span> <span class="variable">original</span> <span class="operator">=</span> chain.request(); <span class="comment">// è·å–åŸå§‹è¯·æ±‚</span></span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> original.newBuilder() <span class="comment">// åˆ›å»ºæ–°çš„è¯·æ±‚æ„å»ºå™¨</span></span><br><span class="line">                        .header(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer your_token_here&quot;</span>) <span class="comment">// æ·»åŠ  Authorization è¯·æ±‚å¤´</span></span><br><span class="line">                        .build(); <span class="comment">// æ„å»ºæ–°çš„è¯·æ±‚</span></span><br><span class="line">                <span class="keyword">return</span> chain.proceed(request); <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º OkHttpClientï¼Œå¹¶æ·»åŠ æ‹¦æˆªå™¨</span></span><br><span class="line">        <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .addInterceptor(loggingInterceptor) <span class="comment">// æ·»åŠ æ—¥å¿—æ‹¦æˆªå™¨</span></span><br><span class="line">                .addInterceptor(authInterceptor) <span class="comment">// æ·»åŠ è®¤è¯æ‹¦æˆªå™¨</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º Retrofit å®ä¾‹</span></span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šå¯ä»¥ä¸æ˜¾å¼çš„æŒ‡å®š OkHttpClient å®ä¾‹ï¼Œé»˜è®¤ä¼šåˆ›å»º</span></span><br><span class="line">        <span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://api.example.com/&quot;</span>) <span class="comment">// è®¾ç½® API åŸºåœ°å€</span></span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create()) <span class="comment">// æ·»åŠ  Gson è½¬æ¢å™¨</span></span><br><span class="line">                .client(okHttpClient) <span class="comment">// è®¾ç½® OkHttpClient</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º API æœåŠ¡</span></span><br><span class="line">        <span class="type">ApiService</span> <span class="variable">apiService</span> <span class="operator">=</span> retrofit.create(ApiService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œ GET è¯·æ±‚</span></span><br><span class="line">        Call&lt;User&gt; call = apiService.getUser(<span class="number">123</span>);</span><br><span class="line">        call.enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>&lt;User&gt;() &#123; <span class="comment">// ä½¿ç”¨ enqueue() æ–¹æ³•å¼‚æ­¥æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call&lt;User&gt; call, Response&lt;User&gt; response)</span> &#123; <span class="comment">// è¯·æ±‚æˆåŠŸçš„å›è°ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (response.isSuccessful()) &#123; <span class="comment">// æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">                    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> response.body(); <span class="comment">// è·å–å“åº”ä½“</span></span><br><span class="line">                    System.out.println(user);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Error: &quot;</span> + response.code()); <span class="comment">// æ‰“å°é”™è¯¯ç </span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call&lt;User&gt; call, Throwable t)</span> &#123; <span class="comment">// è¯·æ±‚å¤±è´¥çš„å›è°ƒ</span></span><br><span class="line">                System.out.println(<span class="string">&quot;Failure: &quot;</span> + t.getMessage()); <span class="comment">// æ‰“å°é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ QueryMap çš„ç¤ºä¾‹</span></span><br><span class="line">        Map&lt;String, String&gt; options = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        options.put(<span class="string">&quot;page&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        options.put(<span class="string">&quot;per_page&quot;</span>, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">        Call&lt;List&lt;User&gt;&gt; callWithQueryMap = apiService.getUsers(options);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ FieldMap çš„ç¤ºä¾‹</span></span><br><span class="line">        Map&lt;String, String&gt; fields = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        fields.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">        fields.put(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        Call&lt;User&gt; callWithFieldMap = apiService.createUser(fields);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... å…¶ä»–è¯·æ±‚ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¤ºä¾‹ User ç±»</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">        <span class="keyword">public</span> String name;</span><br><span class="line">        <span class="keyword">public</span> String email;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é‡å†™ toString æ–¹æ³•ï¼Œæ–¹ä¾¿æ‰“å° User å¯¹è±¡çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                    <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&quot;, email=&#x27;&quot;</span> + email + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äº Multipart è¯·æ±‚çš„ RequestBody æ¥å£ (éœ€è¦æ·»åŠ  okhttp3 ä¾èµ–)</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">RequestBody</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºæ¥æ”¶å“åº”ä½“çš„ ResponseBody æ¥å£ (éœ€è¦æ·»åŠ  okhttp3 ä¾èµ–)</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">ResponseBody</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Guava">Guava</h2>
<p>Guava æ˜¯ Google å¼€å‘çš„ä¸€ä¸ª Java æ ¸å¿ƒåº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¸¸ç”¨çš„å®ç”¨å·¥å…·ç±»ã€æ‰©å±•ç±»å’Œæ•°æ®ç»“æ„ï¼Œæ—¨åœ¨æé«˜ Java ä»£ç çš„æ•ˆç‡ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚Guava çš„è®¾è®¡ç†å¿µæ˜¯è¡¥å…… JDK çš„ä¸è¶³ï¼Œæä¾›ä¸€äº› JDK ç¼ºå°‘çš„åŠŸèƒ½ï¼Œå¹¶å¯¹ä¸€äº› JDK ä¸­å·²æœ‰çš„åŠŸèƒ½è¿›è¡Œæ”¹è¿›å’Œä¼˜åŒ–ã€‚</p>
<p><strong>ç¼“å­˜ (Caching):</strong> æä¾›äº†å¼ºå¤§çš„ç¼“å­˜åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ç¼“å­˜ç­–ç•¥ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>CacheBuilder: ç”¨äºæ„å»ºç¼“å­˜å®ä¾‹ã€‚</li>
<li>LoadingCache: åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®çš„ç¼“å­˜ã€‚</li>
</ul>
<p><strong>äº‹ä»¶æ€»çº¿ (EventBus):</strong> å®ç°äº†å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œ</p>
<p>â€¦</p>
<h2 id="Spring-Security-jwt">Spring Security &amp; jwt</h2>
<p><strong>å®¢æˆ·ç«¯æ¥æ”¶JWTï¼š</strong> æœåŠ¡å™¨å°†ç”Ÿæˆçš„JWTè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œé€šå¸¸æ”¾åœ¨HTTP Authorization headerä¸­ï¼Œä½¿ç”¨Bearer schemeã€‚ä¾‹å¦‚ï¼šAuthorization: Bearer &lt;token&gt;ã€‚</p>
<p><strong>å®¢æˆ·ç«¯æºå¸¦JWTï¼š</strong> å®¢æˆ·ç«¯åœ¨åç»­çš„è¯·æ±‚ä¸­ï¼Œå°†JWTæ·»åŠ åˆ°Authorization headerä¸­ï¼Œå‘é€ç»™æœåŠ¡å™¨ã€‚ JWTå¯ä»¥å­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„localStorageã€cookieæˆ–session storageä¸­ã€‚</p>
<h3 id="jwtç”Ÿæˆæµç¨‹">jwtç”Ÿæˆæµç¨‹</h3>
<ol>
<li>æœåŠ¡å™¨<strong>åˆ†åˆ«</strong>å¯¹å¤´éƒ¨å’Œè½½è·è¿›è¡Œ <strong>Base64Url ç¼–ç </strong> ã€‚</li>
<li>å°†ç¼–ç åçš„å¤´éƒ¨å’Œè½½è·ç”¨ . æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œä¾‹å¦‚ encodedHeader.encodedPayloadã€‚</li>
<li>å°†æ‹¼æ¥åçš„å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥ï¼Œ<strong>ä½¿ç”¨å¯†é’¥å’ŒæŒ‡å®šçš„ç­¾åç®—æ³• (ä¾‹å¦‚ HS256, RS256) è¿›è¡Œç­¾å</strong>ï¼Œå¾—åˆ°ä¸€ä¸ªç­¾åå€¼ã€‚ è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯â€œåŠ å¯†â€ï¼Œæ›´å‡†ç¡®åœ°è¯´æ˜¯â€œç”Ÿæˆç­¾åâ€ã€‚ å¯¹äºHS256ï¼Œæ˜¯è¿›è¡ŒHMAC-SHA256å“ˆå¸Œè¿ç®—ï¼›å¯¹äºRS256ï¼Œæ˜¯ä½¿ç”¨RSAç§é’¥å¯¹æ•°æ®è¿›è¡Œç­¾åã€‚</li>
<li>å°†ç­¾åå€¼è¿›è¡Œ <strong>Base64Url ç¼–ç </strong>ã€‚</li>
<li>æœ€ç»ˆçš„JWTæ˜¯ç”± <strong>ç¼–ç åçš„å¤´éƒ¨ã€ç¼–ç åçš„è½½è·å’Œç¼–ç åçš„ç­¾å</strong> ä¸‰éƒ¨åˆ†ç”¨ . è¿æ¥è€Œæˆï¼Œä¾‹å¦‚ encodedHeader.encodedPayload.encodedSignatureã€‚</li>
</ol>
<h3 id="è¯·æ±‚è¿‡ç¨‹">è¯·æ±‚è¿‡ç¨‹</h3>
<p>åœ¨ Spring MVC é¡¹ç›®ä¸­ï¼ŒDispatcherServlet æ˜¯å”¯ä¸€çš„ Servletï¼Œå®ƒå……å½“å‰ç«¯æ§åˆ¶å™¨ï¼Œè´Ÿè´£æ¥æ”¶æ‰€æœ‰è¯·æ±‚å¹¶åˆ†å‘ç»™ç›¸åº”çš„ Spring Beanï¼ˆä¾‹å¦‚ Controllerï¼‰è¿›è¡Œå¤„ç†ã€‚</p>
<p>Spring Security Filter åœ¨ Servlet å®¹å™¨ï¼ˆä¾‹å¦‚ Tomcatï¼‰çš„è¿‡æ»¤å™¨é“¾ä¸­è¿›è¡Œæ³¨å†Œ</p>
<p>å®¢æˆ·ç«¯ --&gt; Nginx --&gt; Tomcat --&gt; Filter 1(Tomcat Filter) --&gt; Filter 2 --&gt; â€¦ --&gt; Spring Security Filter --&gt; â€¦ --&gt; DispatcherServlet --&gt; Controller</p>
<ol>
<li><strong>ç½‘ç»œå±‚:</strong>
<ul>
<li><strong>è´Ÿè½½å‡è¡¡å™¨ (Load Balancerï¼Œå¯é€‰):</strong> å¦‚æœæœåŠ¡å™¨é›†ç¾¤æœ‰å¤šå°æœºå™¨ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šå°†è¯·æ±‚åˆ†å‘åˆ°å…¶ä¸­ä¸€å°æœåŠ¡å™¨ã€‚</li>
<li><strong>åå‘ä»£ç† (Reverse Proxyï¼Œå¯é€‰):</strong> åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥ä½œä¸ºæœåŠ¡å™¨çš„å‰ç½®ï¼Œå¤„ç†ä¸€äº›é€šç”¨çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç¼“å­˜ã€SSL åŠ å¯†/è§£å¯†ã€è´Ÿè½½å‡è¡¡ç­‰ã€‚ä¾‹å¦‚ Nginxã€Apacheã€‚</li>
</ul>
</li>
<li><strong>Servlet å®¹å™¨ (ä¾‹å¦‚ Tomcatã€Jettyã€Undertow):</strong>
<ul>
<li><strong>è¿æ¥å™¨ (Connector):</strong> æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º Servlet å®¹å™¨å¯ä»¥å¤„ç†çš„è¯·æ±‚å¯¹è±¡ã€‚</li>
<li><strong>å¼•æ“ (Engine):</strong> è´Ÿè´£å¤„ç†æ‰€æœ‰è¯·æ±‚ã€‚</li>
<li><strong>ä¸»æœº (Host):</strong> åŸºäºåŸŸåæˆ– IP åœ°å€å°†è¯·æ±‚è·¯ç”±åˆ°ç›¸åº”çš„è™šæ‹Ÿä¸»æœºã€‚</li>
<li><strong>ä¸Šä¸‹æ–‡ (Context):</strong> ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼ŒåŒ…å« Servletã€è¿‡æ»¤å™¨ã€ç›‘å¬å™¨ç­‰ç»„ä»¶ã€‚</li>
</ul>
</li>
<li><strong>Spring Security è¿‡æ»¤å™¨é“¾ (Filter Chain):</strong>
<ul>
<li>è¯·æ±‚è¿›å…¥ Servlet å®¹å™¨åï¼Œä¼šå…ˆç»è¿‡ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨ã€‚è¿‡æ»¤å™¨å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†æˆ–åå¤„ç†ï¼Œä¾‹å¦‚èº«ä»½éªŒè¯ã€æˆæƒã€æ—¥å¿—è®°å½•ã€æ•°æ®è½¬æ¢ç­‰ã€‚</li>
<li>è¿‡æ»¤å™¨é“¾çš„æ‰§è¡Œé¡ºåºç”± web.xml æˆ– Spring Security é…ç½®å†³å®šã€‚</li>
</ul>
</li>
<li><strong>Servlet (ä¾‹å¦‚ Spring MVC çš„ DispatcherServlet):</strong>
<ul>
<li>DispatcherServlet æ˜¯ Spring MVC æ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒè´Ÿè´£å°†è¯·æ±‚åˆ†å‘åˆ°ç›¸åº”çš„ Controllerã€‚</li>
<li>DispatcherServlet ä¼šæ ¹æ®è¯·æ±‚çš„ URL å’Œé…ç½®çš„å¤„ç†å™¨æ˜ å°„ (Handler Mapping) æ‰¾åˆ°å¯¹åº”çš„ Controller æ–¹æ³•ã€‚</li>
</ul>
</li>
<li><strong>æ‹¦æˆªå™¨ (Interceptorï¼Œå¯é€‰):</strong>
<ul>
<li>æ‹¦æˆªå™¨å¯ä»¥åœ¨ Controller æ–¹æ³•æ‰§è¡Œå‰åè¿›è¡Œä¸€äº›å¤„ç†ï¼Œä¾‹å¦‚æ€§èƒ½ç›‘æ§ã€æ—¥å¿—è®°å½•ç­‰ã€‚</li>
</ul>
</li>
<li><strong>Controller:</strong>
<ul>
<li>Controller æ¥æ”¶è¯·æ±‚å‚æ•°ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶è¿”å› ModelAndView å¯¹è±¡ã€‚</li>
</ul>
</li>
</ol>
<p>å…ˆèº«ä»½éªŒè¯ï¼Œå†æƒé™åˆ¤æ–­</p>
<h3 id="èº«ä»½è®¤è¯æµç¨‹">èº«ä»½è®¤è¯æµç¨‹</h3>
<p><strong>å¸¦ JWT è¯·æ±‚çš„æµç¨‹</strong></p>
<ol>
<li><strong>è¯·æ±‚åˆ°è¾¾ <code>JwtRequestFilter</code></strong>
<ul>
<li>å½“ç”¨æˆ·å‘é€ä¸€ä¸ªå¸¦ JWT çš„è¯·æ±‚æ—¶ï¼ŒSpring Security ä¼šé¦–å…ˆé€šè¿‡ <code>JwtRequestFilter</code> è¿‡æ»¤å™¨ã€‚</li>
<li><code>JwtRequestFilter</code> ä¼šæ£€æŸ¥è¯·æ±‚ä¸­çš„ Authorization å¤´éƒ¨ï¼Œæå– JWT å¹¶éªŒè¯å…¶åˆæ³•æ€§ã€‚</li>
</ul>
</li>
<li><strong>JWT éªŒè¯</strong>
<ul>
<li><code>JwtRequestFilter</code> ä¼šéªŒè¯ JWT æ˜¯å¦æœ‰æ•ˆï¼ˆä¾‹å¦‚æ˜¯å¦è¿‡æœŸã€æ˜¯å¦ç¯¡æ”¹ï¼‰ï¼Œå¹¶ä»ä¸­è§£æå‡ºç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åï¼‰ã€‚</li>
<li>å¦‚æœéªŒè¯æˆåŠŸï¼Œ<code>JwtRequestFilter</code> ä¼šåˆ›å»ºä¸€ä¸ª <code>UsernamePasswordAuthenticationToken</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«ä» JWT ä¸­è§£æå‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åï¼‰ã€‚</li>
<li><code>UsernamePasswordAuthenticationToken</code> å¯¹è±¡å°†è¢«å­˜å‚¨åˆ° <code>SecurityContextHolder</code> ä¸­ï¼Œè¿™æ · Spring Security å°±çŸ¥é“å½“å‰è¯·æ±‚çš„ç”¨æˆ·èº«ä»½ã€‚</li>
</ul>
</li>
<li><strong><code>SecurityContextHolder</code> ä¸­çš„èº«ä»½ä¿¡æ¯</strong>
<ul>
<li>ç”±äºç”¨æˆ·èº«ä»½å·²ç»é€šè¿‡ JWT è¢«éªŒè¯ï¼Œ<code>SecurityContextHolder</code> ä¸­çš„ <code>Authentication</code> å¯¹è±¡å·²åŒ…å«äº†æœ‰æ•ˆçš„èº«ä»½ä¿¡æ¯ã€‚æ¥ä¸‹æ¥çš„æˆæƒå¤„ç†ï¼ˆå¦‚è®¿é—®æ§åˆ¶ï¼‰ä¼šåŸºäºè¿™ä¸ª <code>Authentication</code> å¯¹è±¡ï¼Œè€Œä¸éœ€è¦é‡æ–°é€šè¿‡ <code>AuthenticationManager</code> è¿›è¡Œèº«ä»½éªŒè¯ã€‚</li>
</ul>
</li>
<li><strong>æˆæƒè¿‡ç¨‹ï¼ˆæƒé™éªŒè¯ï¼‰</strong>
<ul>
<li>ä¸€æ—¦èº«ä»½ä¿¡æ¯å­˜å‚¨åœ¨ <code>SecurityContextHolder</code> ä¸­ï¼ŒSpring Security ä¼šè¿›è¡Œæˆæƒå¤„ç†ï¼ˆæ ¹æ®ç”¨æˆ·çš„è§’è‰²ã€æƒé™ç­‰åˆ¤æ–­æ˜¯å¦å…è®¸è®¿é—®èµ„æºï¼‰ã€‚å¦‚æœ JWT è§£ææˆåŠŸä¸”éªŒè¯é€šè¿‡ï¼ŒSpring Security ä¼šåŸºäº <code>GrantedAuthority</code>ï¼ˆç”¨æˆ·çš„è§’è‰²å’Œæƒé™ï¼‰è¿›è¡Œæƒé™éªŒè¯ã€‚</li>
</ul>
</li>
<li><strong>æ—  <code>UsernamePasswordAuthenticationFilter</code> å‚ä¸</strong>
<ul>
<li>ç”±äº JWT å·²ç»é€šè¿‡ <code>JwtRequestFilter</code> è¿›è¡ŒéªŒè¯ï¼Œ<code>UsernamePasswordAuthenticationFilter</code> ä¸ä¼šå†è¢«è§¦å‘ã€‚å› æ­¤ï¼Œæ•´ä¸ªè®¤è¯è¿‡ç¨‹ä¸æ¶‰åŠä¼ ç»Ÿçš„ç”¨æˆ·å/å¯†ç éªŒè¯ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä¸å¸¦ JWT è¯·æ±‚çš„æµç¨‹</strong></p>
<ol>
<li><strong>è¯·æ±‚åˆ°è¾¾ <code>UsernamePasswordAuthenticationFilter</code></strong>
<ul>
<li>å½“ç”¨æˆ·å‘é€ä¸€ä¸ªä¸å¸¦ JWT çš„è¯·æ±‚æ—¶ï¼ˆé€šå¸¸æ˜¯é€šè¿‡ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼‰ï¼ŒSpring Security ä¼šé€šè¿‡ <code>UsernamePasswordAuthenticationFilter</code> æ¥å¤„ç†è¯¥è¯·æ±‚ã€‚</li>
<li><code>UsernamePasswordAuthenticationFilter</code> ä¼šä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ï¼ˆé€šå¸¸æ¥è‡ªè¡¨å•æäº¤ï¼‰ï¼Œå¹¶å°†å…¶å°è£…æˆä¸€ä¸ª <code>UsernamePasswordAuthenticationToken</code> å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>èº«ä»½éªŒè¯</strong>
<ul>
<li><code>UsernamePasswordAuthenticationFilter</code> ä¼šå°† <code>UsernamePasswordAuthenticationToken</code> äº¤ç»™ <code>AuthenticationManager</code> è¿›è¡Œèº«ä»½éªŒè¯ã€‚æ­¤æ—¶ï¼ŒSpring Security ä¼šè°ƒç”¨ä½ åœ¨ <code>SecurityConfig</code> ä¸­é…ç½®çš„ <code>userDetailsService</code> æ¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚</li>
<li>åœ¨ <code>userDetailsService.loadUserByUsername()</code> ä¸­ï¼ŒSpring Security ä¼šä»æ•°æ®åº“ä¸­åŠ è½½ç”¨æˆ·çš„ç”¨æˆ·åã€å¯†ç å’Œæƒé™ä¿¡æ¯ï¼Œå¹¶å°†å…¶å°è£…æˆ <code>UserDetails</code> å¯¹è±¡è¿”å›ã€‚</li>
<li><code>AuthenticationManager</code> ä¼šå¯¹æ¯”è¯·æ±‚ä¸­æä¾›çš„å¯†ç ä¸æ•°æ®åº“ä¸­å­˜å‚¨çš„å¯†ç ï¼ˆç»è¿‡åŠ å¯†çš„ï¼‰ï¼Œå¦‚æœå¯†ç åŒ¹é…ï¼Œèº«ä»½éªŒè¯é€šè¿‡ã€‚</li>
</ul>
</li>
<li><strong>åˆ›å»ºè®¤è¯å¯¹è±¡å¹¶å­˜å‚¨åˆ° <code>SecurityContextHolder</code></strong>
<ul>
<li>å¦‚æœç”¨æˆ·åå’Œå¯†ç åŒ¹é…æˆåŠŸï¼Œ<code>AuthenticationManager</code> ä¼šåˆ›å»ºä¸€ä¸ª <code>UsernamePasswordAuthenticationToken</code> å¯¹è±¡ï¼ˆåŒ…å«ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯å’Œæƒé™ï¼‰ã€‚</li>
<li>ç„¶åï¼Œ<code>UsernamePasswordAuthenticationToken</code> ä¼šè¢«å­˜å‚¨åˆ° <code>SecurityContextHolder</code> ä¸­ï¼Œè¡¨ç¤ºç”¨æˆ·å·²ç»é€šè¿‡èº«ä»½éªŒè¯ã€‚</li>
</ul>
</li>
<li><strong>æˆæƒè¿‡ç¨‹ï¼ˆæƒé™éªŒè¯ï¼‰</strong>
<ul>
<li>åœ¨ <code>SecurityContextHolder</code> ä¸­å­˜å‚¨äº†æœ‰æ•ˆçš„è®¤è¯å¯¹è±¡åï¼ŒSpring Security ä¼šæ ¹æ®ç”¨æˆ·çš„è§’è‰²å’Œæƒé™è¿›è¡Œæˆæƒåˆ¤æ–­ï¼Œç¡®ä¿ç”¨æˆ·æœ‰æƒè®¿é—®è¯·æ±‚çš„èµ„æºã€‚</li>
</ul>
</li>
<li><strong>ä¼šè¯ç®¡ç†ä¸çŠ¶æ€ç®¡ç†</strong>
<ul>
<li>å¦‚æœä½ é…ç½®äº†ä¼šè¯ç®¡ç†ï¼ˆä¾‹å¦‚ï¼Œ<code>sessionCreationPolicy(SessionCreationPolicy.STATELESS)</code>ï¼‰ï¼ŒSpring Security ä¼šæ ¹æ®é…ç½®åˆ›å»ºç›¸åº”çš„ä¼šè¯æˆ–ç¡®ä¿æ— çŠ¶æ€è®¤è¯ã€‚</li>
</ul>
</li>
</ol>
<h1>é¡¹ç›®ç»“æ„</h1>
<p>DDDç»“æ„</p>
<ul>
<li>Domain (é¢†åŸŸå±‚)ï¼š
<ul>
<li>model:
<ul>
<li>aggregate (èšåˆ): æ ¸å¿ƒä¸šåŠ¡å¯¹è±¡ï¼Œä¾‹å¦‚è®¢å•ã€ç”¨æˆ·ç­‰ã€‚</li>
<li>entity (å®ä½“): å…·æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ã€‚</li>
<li>valobj (å€¼å¯¹è±¡): æè¿°å¯¹è±¡çš„æŸä¸ªç‰¹å¾ï¼Œæ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œä¾‹å¦‚åœ°å€ã€é¢œè‰²ç­‰ã€‚</li>
</ul>
</li>
<li>repository (ä»“å‚¨æ¥å£): å®šä¹‰æ•°æ®è®¿é—®æ¥å£ï¼Œå…·ä½“å®ç°æ”¾åœ¨åŸºç¡€è®¾æ–½å±‚ã€‚</li>
<li>service (é¢†åŸŸæœåŠ¡): å¤„ç†ä¸å±äºä»»ä½•å®ä½“æˆ–å€¼å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
</ul>
</li>
<li>Application (åº”ç”¨å±‚)ï¼šåè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆç”¨æˆ·ç”¨ä¾‹ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚
<ul>
<li>config</li>
<li>Application.java</li>
</ul>
</li>
<li>Infrastructure (åŸºç¡€è®¾æ–½å±‚)ï¼šæä¾›æŠ€æœ¯å®ç°ï¼Œä¾‹å¦‚æ•°æ®åº“è®¿é—®ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚
<ul>
<li>dao</li>
<li>redis</li>
<li>gateway
<ul>
<li>dto</li>
</ul>
</li>
<li>adapter
<ul>
<li>port</li>
<li>repositroy</li>
</ul>
</li>
<li>security</li>
</ul>
</li>
<li>trigger
<ul>
<li>http
<ul>
<li>httpController.java</li>
</ul>
</li>
<li>job</li>
<li>listener</li>
</ul>
</li>
<li>types
<ul>
<li>common</li>
<li>enums</li>
<li>exception</li>
<li>utils</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>reinforce-learning-record</title>
    <url>/2024/06/10/reinforce-learning-record/</url>
    <content><![CDATA[<p>reinforce learning</p>
<span id="more"></span>
<h1>reinforce learning record</h1>
<h2 id="æ•°å­¦åŸºç¡€">æ•°å­¦åŸºç¡€</h2>
<p>ä¸€é˜¶ä¼˜åŒ–ä¸äºŒé˜¶ä¼˜åŒ–</p>
<p>åœ¨ä¼˜åŒ–é—®é¢˜ä¸­ï¼Œ<strong>ä¸€é˜¶ä¼˜åŒ–ç®—æ³•</strong>å’Œ<strong>äºŒé˜¶ä¼˜åŒ–ç®—æ³•</strong>æ˜¯ä¸¤ç±»é‡è¦çš„ä¼˜åŒ–æ–¹æ³•ï¼Œå®ƒä»¬ä¸»è¦åŒºåˆ«åœ¨äºåˆ©ç”¨äº†ç›®æ ‡å‡½æ•°çš„å“ªäº›ä¿¡æ¯ï¼š</p>
<p><strong>ä¸€é˜¶ä¼˜åŒ–ç®—æ³•</strong></p>
<ul>
<li><strong>å®šä¹‰</strong>ï¼šä¸€é˜¶ä¼˜åŒ–ç®—æ³•ä»…åˆ©ç”¨ç›®æ ‡å‡½æ•°çš„ä¸€é˜¶å¯¼æ•°ï¼ˆæ¢¯åº¦ï¼‰ä¿¡æ¯è¿›è¡Œä¼˜åŒ–ã€‚</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼š
<ol>
<li><strong>æ¢¯åº¦ä¿¡æ¯</strong>ï¼šä¾èµ–æ¢¯åº¦æ¥æŒ‡å¼•ä¼˜åŒ–æ–¹å‘ã€‚</li>
<li><strong>è®¡ç®—æˆæœ¬ä½</strong>ï¼šæ¢¯åº¦çš„è®¡ç®—é€šå¸¸æ¯”äºŒé˜¶å¯¼æ•°ï¼ˆHessiançŸ©é˜µï¼‰ç®€å•ï¼Œå› æ­¤æ›´é«˜æ•ˆã€‚</li>
<li><strong>é€‚ç”¨æ€§å¹¿</strong>ï¼šå¸¸ç”¨äºé«˜ç»´é—®é¢˜æˆ–ç›®æ ‡å‡½æ•°å¤æ‚çš„æƒ…å†µã€‚</li>
</ol>
</li>
<li><strong>å¸¸è§ç®—æ³•</strong>ï¼š
<ul>
<li><strong>æ¢¯åº¦ä¸‹é™æ³•ï¼ˆGradient Descent, GDï¼‰</strong>ï¼š$ x_{k+1} = x_k - \eta \nabla f(x_k)$ å…¶ä¸­ï¼Œ$\eta$ æ˜¯å­¦ä¹ ç‡ï¼Œ$\nabla f(x_k)$ æ˜¯ç›®æ ‡å‡½æ•°åœ¨ $x_k$ å¤„çš„æ¢¯åº¦ã€‚</li>
<li><strong>éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰</strong>ï¼šåœ¨å¤§è§„æ¨¡æ•°æ®ä¸‹éšæœºé€‰æ‹©å°æ‰¹é‡æ ·æœ¬è®¡ç®—æ¢¯åº¦ï¼Œé€‚åˆæœºå™¨å­¦ä¹ è®­ç»ƒã€‚</li>
<li><strong>åŠ¨é‡æ³•ï¼ˆMomentumï¼‰</strong>ã€<strong>Adamä¼˜åŒ–å™¨</strong>ï¼šæ”¹è¿›äº†åŸºç¡€çš„æ¢¯åº¦ä¸‹é™ï¼Œå…·æœ‰æ›´å¿«çš„æ”¶æ•›é€Ÿåº¦ã€‚</li>
</ul>
</li>
</ul>
<p><strong>äºŒé˜¶ä¼˜åŒ–ç®—æ³•</strong></p>
<ul>
<li>
<p><strong>å®šä¹‰</strong>ï¼šäºŒé˜¶ä¼˜åŒ–ç®—æ³•åˆ©ç”¨ç›®æ ‡å‡½æ•°çš„ä¸€é˜¶å¯¼æ•°ï¼ˆæ¢¯åº¦ï¼‰å’ŒäºŒé˜¶å¯¼æ•°ï¼ˆHessiançŸ©é˜µï¼‰ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ol>
<li><strong>æ›²ç‡ä¿¡æ¯</strong>ï¼šHessiançŸ©é˜µåŒ…å«å…³äºç›®æ ‡å‡½æ•°æ›²ç‡çš„ä¿¡æ¯ï¼Œå› æ­¤äºŒé˜¶ä¼˜åŒ–ç®—æ³•èƒ½å¤Ÿæ›´å‡†ç¡®åœ°æ‰¾åˆ°æå€¼ç‚¹ã€‚</li>
<li><strong>æ›´å¿«æ”¶æ•›</strong>ï¼šåœ¨ç†æƒ³æ¡ä»¶ä¸‹ï¼Œå…·æœ‰äºŒæ¬¡æ”¶æ•›é€Ÿåº¦ã€‚</li>
<li><strong>è®¡ç®—æˆæœ¬é«˜</strong>ï¼šHessiançŸ©é˜µçš„è®¡ç®—å’Œå­˜å‚¨å¯¹äºé«˜ç»´é—®é¢˜éå¸¸æ˜‚è´µã€‚</li>
</ol>
</li>
<li>
<p><strong>å¸¸è§ç®—æ³•</strong>ï¼š</p>
<ul>
<li><strong>ç‰›é¡¿æ³•ï¼ˆNewtonâ€™s Methodï¼‰</strong>ï¼šä½¿äºŒé˜¶æ³°å‹’å±•å¼€å¼çš„å¯¼æ•°ä¸º0çš„ç‚¹ï¼Œè¿­ä»£è‡³$\nabla f(x_k)$ä¸ºæå°ï¼Œ$x_{k+1} = x_k - [\nabla^2 f(x_k)]^{-1} \nabla f(x_k)$ ï¼Œå…¶ä¸­ï¼Œ$[\nabla^2 f(x_k)]^{-1}$ æ˜¯HessiançŸ©é˜µçš„é€†ã€‚</li>
<li><strong>æ‹Ÿç‰›é¡¿æ³•ï¼ˆQuasi-Newton Methodsï¼‰</strong>ï¼šé€šè¿‡è¿‘ä¼¼HessiançŸ©é˜µé™ä½è®¡ç®—å¤æ‚åº¦ï¼Œä¾‹å¦‚ BFGS å’Œ L-BFGSã€‚</li>
<li><strong>ä¿¡èµ–åŸŸæ–¹æ³•ï¼ˆTrust Region Methodsï¼‰</strong>ï¼šç»“åˆHessianä¿¡æ¯é™åˆ¶æ›´æ–°æ­¥é•¿ï¼Œé€‚åˆå¤æ‚éçº¿æ€§ä¼˜åŒ–ã€‚</li>
</ul>
</li>
</ul>
<h2 id="æœºå™¨å­¦ä¹ æ¨¡å‹">æœºå™¨å­¦ä¹ æ¨¡å‹</h2>
<img src="/2024/06/10/reinforce-learning-record/00e7457c373413b80db70c958566dd84.png" class="" title="ma learning">
<h2 id="MRP">MRP</h2>
<img src="/2024/06/10/reinforce-learning-record/image-20240610205131367.png" class="" title="image-20240610205131367">
<h3 id="å›æŠ¥">å›æŠ¥</h3>
<p>åœ¨ä¸€ä¸ªé©¬å°”å¯å¤«å¥–åŠ±è¿‡ç¨‹ä¸­ï¼Œä»ç¬¬tæ—¶åˆ»çŠ¶æ€ S_t å¼€å§‹ï¼Œç›´åˆ°ç»ˆæ­¢çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰å¥–åŠ±çš„è¡°å‡ä¹‹å’Œç§°ä¸º<strong>å›æŠ¥</strong>ï¼ˆReturnï¼‰ï¼Œè¡¨ç¤ºä¸º G_t</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610203108806.png" class="" title="image-20240610203108806">
<ul>
<li>R_tè¡¨ç¤ºåœ¨æ—¶åˆ»tè·å¾—çš„å¥–åŠ±</li>
<li><strong>åˆ°è¾¾çŠ¶æ€S_i</strong>ï¼Œå¾—åˆ°å¥–åŠ±r(s)ï¼›è‹¥åœ¨æ—¶åˆ»tåˆ°è¾¾çŠ¶æ€S_iï¼Œåˆ™<strong>R_t=r(S_i)</strong></li>
<li>å¯¹äºæŸçŠ¶æ€åºåˆ—<img src="/2024/06/10/reinforce-learning-record/image-20240610203423677.png" class="" title="image-20240610203423677">æˆ‘ä»¬æœ‰å¯¹åº”äºè¯¥çŠ¶æ€åºåˆ—çš„å¥–åŠ±G<img src="/2024/06/10/reinforce-learning-record/image-20240610203434567.png" class="" title="image-20240610203434567"></li>
</ul>
<h3 id="ä»·å€¼å‡½æ•°">ä»·å€¼å‡½æ•°</h3>
<p>åœ¨é©¬å°”å¯å¤«å¥–åŠ±è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªçŠ¶æ€çš„æœŸæœ›å›æŠ¥ï¼ˆå³ä»è¿™ä¸ªçŠ¶æ€å‡ºå‘çš„æœªæ¥ç´¯ç§¯å¥–åŠ±çš„æœŸæœ›ï¼‰è¢«ç§°ä¸ºè¿™ä¸ªçŠ¶æ€çš„<strong>ä»·å€¼</strong>ï¼ˆvalueï¼‰ã€‚æ‰€æœ‰çŠ¶æ€çš„ä»·å€¼å°±ç»„æˆäº†<strong>ä»·å€¼å‡½æ•°</strong>ï¼ˆvalue functionï¼‰ï¼Œä»·å€¼å‡½æ•°çš„è¾“å…¥ä¸ºæŸä¸ªçŠ¶æ€ï¼Œè¾“å‡ºä¸ºè¿™ä¸ªçŠ¶æ€çš„ä»·å€¼ã€‚</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610203509585.png" class="" title="image-20240610203509585">
<ul>
<li>å¯¹äºæŸä¸ªçŠ¶æ€sï¼Œä»è¯¥çŠ¶æ€å‡ºå‘å¯å¾—åˆ°çš„çŠ¶æ€åºåˆ—æœ‰å¾ˆå¤šæ¡</li>
<li>å¯¹äºæŸä¸ªçŠ¶æ€sï¼Œä»·å€¼å‡½æ•°ä¸º<strong>ä»è¯¥çŠ¶æ€å‡ºå‘ï¼Œå¯èƒ½å­˜åœ¨çš„æ‰€æœ‰çŠ¶æ€åºåˆ—çš„å¥–åŠ±çš„å‡å€¼</strong></li>
</ul>
<p>è´å°”æ›¼æ–¹ç¨‹</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610203841177.png" class="" title="image-20240610203841177">
<h2 id="MDP">MDP</h2>
<p>ä¸MRPç›¸æ¯”ï¼Œå¥–åŠ±ä¸çŠ¶æ€å’ŒåŠ¨ä½œç›¸å…³</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610205112917.png" class="" title="image-20240610205112917">
<h3 id="ç­–ç•¥">ç­–ç•¥</h3>
<p>ç­–ç•¥è¡¨ç¤ºåœ¨çŠ¶æ€sä¸‹é‡‡å–åŠ¨ä½œaçš„<strong>æ¦‚ç‡</strong>ï¼Œä¸º<strong>æ¦‚ç‡</strong>ï¼Œå¯èƒ½ä¸º1</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610204522539.png" class="" title="image-20240610204522539">
<h3 id="çŠ¶æ€ä»·å€¼å‡½æ•°">çŠ¶æ€ä»·å€¼å‡½æ•°</h3>
<p>åœ¨ MDP ä¸­åŸºäºç­–ç•¥ $\pi$ çš„çŠ¶æ€ä»·å€¼å‡½æ•°ï¼ˆstate-value functionï¼‰ï¼Œå®šä¹‰ä¸ºä»çŠ¶æ€så‡ºå‘éµå¾ªç­–ç•¥Î èƒ½è·å¾—çš„æœŸæœ›å›æŠ¥</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610204014373.png" class="" title="image-20240610204014373">
<blockquote>
<p>ä»·å€¼æ˜¯å›æŠ¥çš„æœŸæœ›</p>
<p>ä¸‹æ ‡ Ï€ ç”¨æ¥<strong>æŒ‡æ˜è¿™ä¸ªæœŸæœ›æ˜¯åœ¨ä»€ä¹ˆæ¦‚ç‡åˆ†å¸ƒä¸‹è®¡ç®—çš„</strong>ã€‚</p>
<ul>
<li>åœ¨æ¦‚ç‡è®ºå’Œç»Ÿè®¡ä¸­ï¼ŒæœŸæœ›ç®—å­çš„ä¸‹æ ‡é€šå¸¸ç”¨æ¥è¡¨ç¤ºæœŸæœ›æ˜¯å…³äºå“ªä¸ªéšæœºå˜é‡çš„åˆ†å¸ƒï¼Œæˆ–è€…æ˜¯åœ¨å“ªä¸ªå‚æ•°ï¼ˆå®šä¹‰äº†åˆ†å¸ƒï¼‰çš„æ¡ä»¶ä¸‹è®¡ç®—çš„ã€‚ä¾‹å¦‚ï¼Œ$E_X[f(X)]$ è¡¨ç¤ºå¯¹éšæœºå˜é‡ $X$ çš„å‡½æ•° $f(X)$ æ±‚æœŸæœ›ï¼Œå…¶ä¸­ $X$ çš„åˆ†å¸ƒæ˜¯å·²çŸ¥çš„ã€‚</li>
</ul>
</blockquote>
<h3 id="åŠ¨ä½œä»·å€¼å‡½æ•°">åŠ¨ä½œä»·å€¼å‡½æ•°</h3>
<p>åœ¨ MDP ä¸­ï¼Œç”±äºåŠ¨ä½œçš„å­˜åœ¨ï¼Œæˆ‘ä»¬é¢å¤–å®šä¹‰ä¸€ä¸ª<strong>åŠ¨ä½œä»·å€¼å‡½æ•°</strong>ï¼ˆaction-value functionï¼‰ã€‚è¡¨ç¤ºåœ¨ MDP éµå¾ªç­–ç•¥Î æ—¶ï¼Œå¯¹å½“å‰çŠ¶æ€sæ‰§è¡ŒåŠ¨ä½œaå¾—åˆ°çš„æœŸæœ›å›æŠ¥</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610204152914.png" class="" title="image-20240610204152914">
<ul>
<li><strong>é‡‡å–åŠ¨ä½œaåˆ°è¾¾çŠ¶æ€s</strong>ï¼Œå¾—åˆ°å¥–åŠ±R</li>
</ul>
<h3 id="çŠ¶æ€ä»·å€¼å‡½æ•°ä¸åŠ¨ä½œä»·å€¼å‡½æ•°å…³ç³»">çŠ¶æ€ä»·å€¼å‡½æ•°ä¸åŠ¨ä½œä»·å€¼å‡½æ•°å…³ç³»</h3>
<img src="/2024/06/10/reinforce-learning-record/image-20240610213003398.png" class="" title="image-20240610213003398">
<ul>
<li>ä»çŠ¶æ€så‡ºå‘ï¼Œå¯èƒ½é‡‡å–åŠ¨ä½œa1, a2, a3, â€¦;å¯¹äºæ¯ä¸ªå¯èƒ½é‡‡å–çš„åŠ¨ä½œï¼Œå‡æœ‰åŠ¨ä½œä»·å€¼Qï¼Œåˆ™çŠ¶æ€sçš„çŠ¶æ€ä»·å€¼ä¸ºæ‰€æœ‰åŠ¨ä½œä»·å€¼çš„æœŸæœ›</li>
</ul>
<img src="/2024/06/10/reinforce-learning-record/image-20240610213050168.png" class="" title="image-20240610213050168">
<ul>
<li>åœ¨çŠ¶æ€sæ‰§è¡ŒåŠ¨ä½œaåï¼Œå¾—åˆ°å¥–åŠ±r(s,a)ï¼›ç”±äºå¯èƒ½åˆ°è¾¾å¤šä¸ªä¸åŒçš„çŠ¶æ€sâ€™ï¼ŒåŠ¨ä½œä»·å€¼ä¸ºå³æ—¶å¥–åŠ±r(s,a)+å¯èƒ½åˆ°è¾¾çš„æ‰€æœ‰çŠ¶æ€çš„ä»·å€¼çš„æœŸæœ›</li>
</ul>
<h3 id="æœ€ä¼˜ç­–ç•¥">æœ€ä¼˜ç­–ç•¥</h3>
<p>ç­–ç•¥ä¹‹é—´çš„ååºå…³ç³»</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612093758370.png" class="" title="image-20240612093758370">
<p>æœ€ä¼˜ç­–ç•¥ä¸º å¯¹äºä»»æ„çš„ç­–ç•¥ï¼Œå‡æœ‰æœ€ä¼˜ç­–ç•¥ä¼˜äºæˆ–ä¸å·®äºå…¶ä»–ç­–ç•¥</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612093948192.png" class="" title="image-20240612093948192">
<img src="/2024/06/10/reinforce-learning-record/image-20240612093958259.png" class="" title="image-20240612093958259">
<p>æœ€ä¼˜çŠ¶æ€ä»·å€¼ä¸æœ€ä¼˜åŠ¨ä½œä»·å€¼çš„å…³ç³»</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612094048209.png" class="" title="image-20240612094048209">
<h3 id="è´å°”æ›¼æœŸæœ›æ–¹ç¨‹">è´å°”æ›¼æœŸæœ›æ–¹ç¨‹</h3>
<p>é‡‡å–ç­–ç•¥Î </p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610204627264.png" class="" title="image-20240610204627264">
<ul>
<li>å¯¹äºçŠ¶æ€sï¼Œsçš„çŠ¶æ€ä»·å€¼ä¸º ( æŠ˜æŸçš„ <strong>æ‰€æœ‰å¯è¾¾çš„ä¸‹ä¸€çŠ¶æ€çš„ä»·å€¼çš„æœŸæœ›</strong> + <strong>åˆ°è¾¾æ‰€æœ‰å¯è¾¾çš„ä¸‹ä¸€çŠ¶æ€çš„r(sâ€™,a)çš„æœŸæœ›</strong> )</li>
<li>å¯¹äºçŠ¶æ€så’ŒåŠ¨ä½œaï¼Œåœ¨çŠ¶æ€sè¿›è¡ŒåŠ¨ä½œaçš„ä»·å€¼ä¸º ( <strong>åœ¨çŠ¶æ€sæ‰§è¡ŒåŠ¨ä½œaçš„r(s,a)çš„æœŸæœ›</strong>(å®é™…ä¸Šå°±æ˜¯r(s,a)) + æŠ˜æŸçš„ <strong>åœ¨æ‰§è¡ŒåŠ¨ä½œaåæ‰€æœ‰å¯è¾¾çš„ä¸‹ä¸€çŠ¶æ€çš„æ‰€æœ‰å¯æ‰§è¡ŒåŠ¨ä½œçš„ä»·å€¼çš„æœŸæœ›</strong> )</li>
</ul>
<img src="/2024/06/10/reinforce-learning-record/shiow.PNG" class="" title="shiow">
<p>å›¾ä¸­æƒ…å†µä¸ºæ¯ä¸ªåŠ¨ä½œåªä¼šåˆ°è¾¾ä¸€ä¸ªçŠ¶æ€&amp;åº”è¯¥ç›´æ¥å°†åŠ¨ä½œè§†ä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå›¾ä¸ºæ ‘</p>
<br>
<h3 id="è´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹">è´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹</h3>
<p>å­˜åœ¨ç­–ç•¥*ï¼Œä½¿å¯¹äºä»»æ„çš„çŠ¶æ€sï¼Œå‡æœ‰åŸºäºç­–ç•¥*çŠ¶æ€ä»·å€¼å‡½æ•°å¤§äºåŸºäºç­–ç•¥Î çš„çŠ¶æ€ä»·å€¼å‡½æ•°</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610205402396.png" class="" title="image-20240610205402396">
<ul>
<li>å¯¹äºçŠ¶æ€ä»·å€¼ï¼šéæœ€ä¼˜å½¢å¼æ˜¯æ±‚æœŸæœ›ï¼Œæœ€ä¼˜å½¢å¼æ˜¯ç›´æ¥é€‰å–å½“å‰çŠ¶æ€ï¼Œæ‰€æœ‰åŠ¨ä½œä¸­ï¼Œæœªæ¥çŠ¶æ€åºåˆ—ä¸­ä»·å€¼æœ€å¤§çš„</li>
<li>å¯¹äºåŠ¨ä½œä»·å€¼ï¼šéæœ€ä¼˜å½¢å¼æ˜¯æ±‚æœŸæœ›ï¼Œæœ€ä¼˜å½¢å¼æ˜¯ç›´æ¥é€‰å–ä¸‹ä¸€çŠ¶æ€ï¼Œæ‰€æœ‰åŠ¨ä½œä¸­ï¼Œæœªæ¥çŠ¶æ€åºåˆ—ä¸­åŠ¨ä½œä»·å€¼æœ€å¤§çš„</li>
</ul>
<br>
<h3 id="çŠ¶æ€è®¿é—®åˆ†å¸ƒ">çŠ¶æ€è®¿é—®åˆ†å¸ƒ</h3>
<p>çŠ¶æ€è®¿é—®åˆ†å¸ƒå®šä¹‰<br>
$$<br>
\nu^{\pi_\theta}(s) = (1-\gamma)\sum_{k=0}^\infty \gamma^k Pr(s_k=s|s_0,\pi_\theta)<br>
$$<br>
è¡¥å……ï¼š</p>
<p>åœ¨ç­–ç•¥æ¢¯åº¦å®šç†ä¸­ï¼Œ$Î½^{Ï€_Î¸}(s)$ <strong>è¢«å®šä¹‰ä¸º</strong> $Î·(s) / âˆ‘_{sâ€™} Î·(sâ€™)$ã€‚<br>
$$<br>
Î·(s) = âˆ‘_{k=0}^âˆ Î³^k d^{Ï€_Î¸}(s_0 â†’ s, k)<br>
$$</p>
<p>$$<br>
\begin{aligned}<br>
\sum_s \eta(s)<br>
&amp;= \sum_s \mathbb{E}<em>{s_0}\left[\sum</em>{k=0}^{\infty} \gamma^k P(S_k = s | S_0 = s_0, \pi_\theta)\right]<br>
\\<br>
&amp;= \mathbb{E}<em>{s_0}\left[\sum_s \sum</em>{k=0}^{\infty} \gamma^k P(S_k = s | S_0 = s_0, \pi_\theta)\right]<br>
\\<br>
&amp;= \mathbb{E}<em>{s_0}\left[\sum</em>{k=0}^{\infty} \sum_s \gamma^k P(S_k = s | S_0 = s_0, \pi_\theta)\right]<br>
\\<br>
&amp;= \mathbb{E}<em>{s_0}\left[\sum</em>{k=0}^{\infty} \gamma^k \left(\sum_s P(S_k = s | S_0 = s_0, \pi_\theta)\right)\right]<br>
\\<br>
&amp;= \mathbb{E}<em>{s_0}\left[\sum</em>{k=0}^{\infty} \gamma^k \cdot 1\right]<br>
\\<br>
&amp;= \mathbb{E}<em>{s_0}\left[\sum</em>{k=0}^{\infty} \gamma^k\right]<br>
\\<br>
&amp;= \mathbb{E}_{s_0}\left[\frac{1}{1 - \gamma}\right]<br>
\\<br>
&amp;= \frac{1}{1 - \gamma}</p>
<p>\end{aligned}<br>
$$</p>
<br>
<h2 id="ç­–ç•¥è¿­ä»£ç®—æ³•-åŸºäºç­–ç•¥å‡½æ•°çš„">ç­–ç•¥è¿­ä»£ç®—æ³•/åŸºäºç­–ç•¥å‡½æ•°çš„</h2>
<blockquote>
<p>ç­–ç•¥è¿­ä»£çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>äº¤æ›¿è¿›è¡Œç­–ç•¥è¯„ä¼°å’Œç­–ç•¥æå‡</strong>ï¼Œç›´åˆ°ç­–ç•¥æ”¶æ•›åˆ°æœ€ä¼˜ã€‚</p>
</blockquote>
<p><strong>ç­–ç•¥è¯„ä¼°ï¼š</strong></p>
<p>åŸºäºå½“å‰ç­–ç•¥Î ï¼Œåœ¨å·²çŸ¥çŠ¶æ€è½¬ç§»å‡½æ•°çš„æƒ…å†µä¸‹ï¼ˆå³æˆ‘ä»¬å¯ä»¥çŸ¥é“é‡‡å–åŠ¨ä½œaåæœ‰å¤šé«˜çš„å‡ ç‡åˆ°è¾¾å“ªä¸ªçŠ¶æ€ï¼‰ï¼Œä½¿ç”¨<strong>è´å°”æ›¼æœŸæœ›æ–¹ç¨‹</strong>è¿­ä»£æ›´æ–°çŠ¶æ€ä»·å€¼å‡½æ•°</p>
<p>ps: åŸæ–‡ä¸­è¿­ä»£æ›´æ–°çŠ¶æ€ä»·å€¼å‡½æ•°æ˜¯é€šè¿‡</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610213050168.png" class="" title="image-20240610213050168">
<img src="/2024/06/10/reinforce-learning-record/image-20240610213003398.png" class="" title="image-20240610213003398">
<p>ä»¥ä¸Šä¸¤ä¸ªå…¬å¼å®ç°çš„ï¼Œä¹Ÿå³</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">qsa_list = []</span><br><span class="line">	<span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># è¿·å®«ç¯å¢ƒï¼Œå››ç›¸è¿åŠ¨</span></span><br><span class="line">		qsa = <span class="number">0</span>  <span class="comment"># å½“å‰åŠ¨ä½œçš„åŠ¨ä½œä»·å€¼</span></span><br><span class="line">        <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:  <span class="comment"># æœ‰æ¨¡å‹ï¼Œå³çŠ¶æ€è½¬ç§»å‡½æ•°å·²çŸ¥</span></span><br><span class="line">        	p, next_state, r, done = res</span><br><span class="line">            qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))  <span class="comment"># ç¬¬ä¸€ä¸ªå…¬å¼ï¼Œè®¡ç®—è¯¥åŠ¨ä½œçš„ä»·å€¼(å¼€å¤´çš„pä¸ºåŠ¨ä½œæˆåŠŸæ¦‚ç‡)</span></span><br><span class="line">         qsa_list.append(self.pi[s][a] * qsa)  <span class="comment"># ä¹˜é‡‡å–è¯¥åŠ¨ä½œçš„å‡ ç‡</span></span><br><span class="line">	new_v[s] = <span class="built_in">sum</span>(qsa_list)  <span class="comment"># ç¬¬äºŒä¸ªå…¬å¼ï¼Œæ ¹æ®æ‰€æœ‰åŠ¨ä½œçš„ä»·å€¼è®¡ç®—çŠ¶æ€ä»·å€¼</span></span><br></pre></td></tr></table></figure>
<br>
<p><strong>ç­–ç•¥æå‡ï¼š</strong></p>
<p>ç”±äº</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610213003398.png" class="" title="image-20240610213003398">
<p>æ•…ä¿®æ”¹ç­–ç•¥ï¼Œä½¿å¾—åŠ¨ä½œä»·å€¼æœ€å¤§çš„åŠ¨ä½œä»¥æ›´é«˜çš„æ¦‚ç‡(è‹¥æœ€å¤§å€¼å”¯ä¸€ï¼Œè¯¥åŠ¨ä½œå°†æˆä¸ºå”¯ä¸€è¢«é€‰å–åŠ¨ä½œï¼›è‹¥ä¸å”¯ä¸€ï¼Œè¿™äº›åŠ¨ä½œå°†å‡åˆ†æ¦‚ç‡1)è¢«é€‰å–ï¼Œå¯ä½¿æ–°ç­–ç•¥ä¸‹çš„çŠ¶æ€ä»·å€¼å‡½æ•°å¢å¤§ï¼Œä¹Ÿå³<img src="/2024/06/10/reinforce-learning-record/image-20240611150030644.png" class="" title="image-20240611150030644"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">qsa_list = []</span><br><span class="line">	<span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># è¿·å®«ç¯å¢ƒï¼Œå››ç›¸è¿åŠ¨</span></span><br><span class="line">    	qsa = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:</span><br><span class="line">        	p, next_state, r, done = res</span><br><span class="line">            qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))</span><br><span class="line">        qsa_list.append(qsa)</span><br><span class="line">     maxq = <span class="built_in">max</span>(qsa_list)</span><br><span class="line">     cntq = qsa_list.count(maxq)  <span class="comment"># è®¡ç®—æœ‰å‡ ä¸ªåŠ¨ä½œå¾—åˆ°äº†æœ€å¤§çš„Qå€¼</span></span><br><span class="line">     <span class="comment"># è®©è¿™äº›åŠ¨ä½œå‡åˆ†æ¦‚ç‡</span></span><br><span class="line">     self.pi[s] = [<span class="number">1</span> / cntq <span class="keyword">if</span> q == maxq <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> q <span class="keyword">in</span> qsa_list]</span><br></pre></td></tr></table></figure>
<p>target: ä¿®æ”¹<strong>ç­–ç•¥</strong>ï¼Œä½¿åœ¨æ–°ç­–ç•¥ä¸‹ï¼Œæœ‰åŸºäºæ–°ç­–ç•¥çš„çŠ¶æ€ä»·å€¼å‡½æ•°å¤§äºåŸç­–ç•¥çš„çŠ¶æ€ä»·å€¼å‡½æ•°</p>
<br>
<p>å®Œæ•´ç­–ç•¥è¿­ä»£ç®—æ³•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PolicyIteration</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot; ç­–ç•¥è¿­ä»£ç®—æ³• &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, env, theta, gamma</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–å‡½æ•°ï¼Œæ¥å—ç¯å¢ƒå¯¹è±¡envã€ç­–ç•¥è¯„ä¼°æ”¶æ•›é˜ˆå€¼thetaå’ŒæŠ˜æ‰£å› å­gamma</span></span><br><span class="line">        self.env = env  <span class="comment"># ä¿å­˜ç¯å¢ƒå¯¹è±¡</span></span><br><span class="line">        self.v = [<span class="number">0</span>] * self.env.ncol * self.env.nrow  <span class="comment"># åˆå§‹åŒ–ä»·å€¼å‡½æ•°vä¸º0ï¼Œå¤§å°ä¸ºç¯å¢ƒçš„æ ¼å­æ•°</span></span><br><span class="line">        self.pi = [[<span class="number">0.25</span>, <span class="number">0.25</span>, <span class="number">0.25</span>, <span class="number">0.25</span>]</span><br><span class="line">                   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.env.ncol * self.env.nrow)]  <span class="comment"># åˆå§‹åŒ–ç­–ç•¥piä¸ºå‡åŒ€éšæœºç­–ç•¥ï¼Œæ¯ä¸ªçŠ¶æ€æœ‰4ä¸ªåŠ¨ä½œï¼Œæ¯ä¸ªåŠ¨ä½œçš„æ¦‚ç‡ä¸º0.25</span></span><br><span class="line">        self.theta = theta  <span class="comment"># ç­–ç•¥è¯„ä¼°çš„æ”¶æ•›é˜ˆå€¼</span></span><br><span class="line">        self.gamma = gamma  <span class="comment"># æŠ˜æ‰£å› å­ï¼Œç”¨äºè®¡ç®—æœªæ¥å¥–åŠ±çš„æŠ˜æ‰£</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">policy_evaluation</span>(<span class="params">self</span>):  <span class="comment"># ç­–ç•¥è¯„ä¼°</span></span><br><span class="line">        cnt = <span class="number">1</span>  <span class="comment"># è®¡æ•°å™¨ï¼Œè®°å½•ç­–ç•¥è¯„ä¼°çš„è¿­ä»£æ¬¡æ•°</span></span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            max_diff = <span class="number">0</span>  <span class="comment"># ç”¨äºè®°å½•ä»·å€¼å‡½æ•°çš„æœ€å¤§å˜åŒ–é‡</span></span><br><span class="line">            new_v = [<span class="number">0</span>] * self.env.ncol * self.env.nrow  <span class="comment"># åˆå§‹åŒ–æ–°çš„ä»·å€¼å‡½æ•°</span></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(self.env.ncol * self.env.nrow):  <span class="comment"># å½“æ¬¡åœ°å›¾æ‰«æ</span></span><br><span class="line">                qsa_list = []  <span class="comment"># ç”¨äºå­˜å‚¨çŠ¶æ€sä¸‹æ‰€æœ‰åŠ¨ä½œçš„Qå€¼</span></span><br><span class="line">                <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># éå†æ‰€æœ‰åŠ¨ä½œ</span></span><br><span class="line">                    qsa = <span class="number">0</span>  <span class="comment"># åˆå§‹åŒ–Q(s,a)ä¸º0</span></span><br><span class="line">                    <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:  <span class="comment"># éå†çŠ¶æ€sä¸‹æ‰§è¡ŒåŠ¨ä½œaçš„æ‰€æœ‰å¯èƒ½ç»“æœ</span></span><br><span class="line">                        p, next_state, r, done = res  <span class="comment"># è·å–è½¬ç§»æ¦‚ç‡pã€ä¸‹ä¸€ä¸ªçŠ¶æ€next_stateã€å¥–åŠ±rå’Œæ˜¯å¦ç»ˆæ­¢done</span></span><br><span class="line">                        qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))  <span class="comment"># è®¡ç®—Q(s,a)çš„å€¼ï¼Œè€ƒè™‘æŠ˜æ‰£å› å­gamma</span></span><br><span class="line">                    qsa_list.append(self.pi[s][a] * qsa)  <span class="comment"># å°†Q(s,a)ä¹˜ä»¥ç­–ç•¥pi(s,a)å¹¶åŠ å…¥åˆ—è¡¨</span></span><br><span class="line">                new_v[s] = <span class="built_in">sum</span>(qsa_list)  <span class="comment"># è®¡ç®—çŠ¶æ€sçš„æ–°ä»·å€¼å‡½æ•°å€¼</span></span><br><span class="line">                max_diff = <span class="built_in">max</span>(max_diff, <span class="built_in">abs</span>(new_v[s] - self.v[s]))  <span class="comment"># æ›´æ–°å½“æ¬¡åœ°å›¾æ‰«æä¸­æœ€å¤§å˜åŒ–é‡</span></span><br><span class="line">            self.v = new_v  <span class="comment"># æ›´æ–°ä»·å€¼å‡½æ•°</span></span><br><span class="line">            <span class="keyword">if</span> max_diff &lt; self.theta: <span class="keyword">break</span>  <span class="comment"># å¦‚æœæœ€å¤§å˜åŒ–é‡å°äºé˜ˆå€¼thetaï¼Œåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">            cnt += <span class="number">1</span>  <span class="comment"># å¢åŠ è¿­ä»£æ¬¡æ•°</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ç­–ç•¥è¯„ä¼°è¿›è¡Œ%dè½®åå®Œæˆ&quot;</span> % cnt)  <span class="comment"># æ‰“å°ç­–ç•¥è¯„ä¼°çš„è¿­ä»£æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">policy_improvement</span>(<span class="params">self</span>):  <span class="comment"># ç­–ç•¥æå‡</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(self.env.nrow * self.env.ncol):  <span class="comment"># éå†æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line">            qsa_list = []  <span class="comment"># ç”¨äºå­˜å‚¨çŠ¶æ€sä¸‹æ‰€æœ‰åŠ¨ä½œçš„Qå€¼</span></span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># éå†æ‰€æœ‰åŠ¨ä½œ</span></span><br><span class="line">                qsa = <span class="number">0</span>  <span class="comment"># åˆå§‹åŒ–Q(s,a)ä¸º0</span></span><br><span class="line">                <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:  <span class="comment"># éå†çŠ¶æ€sä¸‹æ‰§è¡ŒåŠ¨ä½œaçš„æ‰€æœ‰å¯èƒ½ç»“æœ</span></span><br><span class="line">                    p, next_state, r, done = res  <span class="comment"># è·å–è½¬ç§»æ¦‚ç‡pã€ä¸‹ä¸€ä¸ªçŠ¶æ€next_stateã€å¥–åŠ±rå’Œæ˜¯å¦ç»ˆæ­¢done</span></span><br><span class="line">                    qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))  <span class="comment"># è®¡ç®—Q(s,a)çš„å€¼ï¼Œè€ƒè™‘æŠ˜æ‰£å› å­gamma</span></span><br><span class="line">                qsa_list.append(qsa)  <span class="comment"># å°†Q(s,a)åŠ å…¥åˆ—è¡¨</span></span><br><span class="line">            maxq = <span class="built_in">max</span>(qsa_list)  <span class="comment"># æ‰¾åˆ°çŠ¶æ€sä¸‹æ‰€æœ‰åŠ¨ä½œçš„æœ€å¤§Qå€¼</span></span><br><span class="line">            cntq = qsa_list.count(maxq)  <span class="comment"># è®¡ç®—æœ‰å¤šå°‘ä¸ªåŠ¨ä½œå¾—åˆ°äº†æœ€å¤§Qå€¼</span></span><br><span class="line">            <span class="comment"># è®©è¿™äº›åŠ¨ä½œå‡åˆ†æ¦‚ç‡ï¼Œå…¶ä»–åŠ¨ä½œçš„æ¦‚ç‡ä¸º0</span></span><br><span class="line">            self.pi[s] = [<span class="number">1</span> / cntq <span class="keyword">if</span> q == maxq <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> q <span class="keyword">in</span> qsa_list]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ç­–ç•¥æå‡å®Œæˆ&quot;</span>)  <span class="comment"># æ‰“å°ç­–ç•¥æå‡å®Œæˆ</span></span><br><span class="line">        <span class="keyword">return</span> self.pi  <span class="comment"># è¿”å›æ›´æ–°åçš„ç­–ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">policy_iteration</span>(<span class="params">self</span>):  <span class="comment"># ç­–ç•¥è¿­ä»£</span></span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            self.policy_evaluation()  <span class="comment"># è¿›è¡Œç­–ç•¥è¯„ä¼°</span></span><br><span class="line">            old_pi = copy.deepcopy(self.pi)  <span class="comment"># æ·±æ‹·è´å½“å‰ç­–ç•¥ï¼Œç”¨äºæ¯”è¾ƒ</span></span><br><span class="line">            new_pi = self.policy_improvement()  <span class="comment"># è¿›è¡Œç­–ç•¥æå‡</span></span><br><span class="line">            <span class="keyword">if</span> old_pi == new_pi: <span class="keyword">break</span>  <span class="comment"># å¦‚æœç­–ç•¥ä¸å†å˜åŒ–ï¼Œåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">                </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_agent</span>(<span class="params">agent, action_meaning, disaster=[], end=[]</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;çŠ¶æ€ä»·å€¼ï¼š&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(agent.env.nrow):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(agent.env.ncol):</span><br><span class="line">            <span class="comment"># ä¸ºäº†è¾“å‡ºç¾è§‚,ä¿æŒè¾“å‡º6ä¸ªå­—ç¬¦</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;%6.6s&#x27;</span> % (<span class="string">&#x27;%.3f&#x27;</span> % agent.v[i * agent.env.ncol + j]), end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ç­–ç•¥ï¼š&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(agent.env.nrow):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(agent.env.ncol):</span><br><span class="line">            <span class="comment"># ä¸€äº›ç‰¹æ®Šçš„çŠ¶æ€,ä¾‹å¦‚æ‚¬å´–æ¼«æ­¥ä¸­çš„æ‚¬å´–</span></span><br><span class="line">            <span class="keyword">if</span> (i * agent.env.ncol + j) <span class="keyword">in</span> disaster:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;****&#x27;</span>, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> (i * agent.env.ncol + j) <span class="keyword">in</span> end:  <span class="comment"># ç›®æ ‡çŠ¶æ€</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;EEEE&#x27;</span>, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                a = agent.pi[i * agent.env.ncol + j]</span><br><span class="line">                pi_str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(action_meaning)):</span><br><span class="line">                    pi_str += action_meaning[k] <span class="keyword">if</span> a[k] &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">&#x27;o&#x27;</span></span><br><span class="line">                <span class="built_in">print</span>(pi_str, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">env = CliffWalkingEnv()</span><br><span class="line">action_meaning = [<span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>]</span><br><span class="line">theta = <span class="number">0.001</span></span><br><span class="line">gamma = <span class="number">0.9</span></span><br><span class="line">agent = PolicyIteration(env, theta, gamma)</span><br><span class="line">agent.policy_iteration()</span><br><span class="line">print_agent(agent, action_meaning, <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">37</span>, <span class="number">47</span>)), [<span class="number">47</span>])</span><br></pre></td></tr></table></figure>
<br>
<h2 id="ä»·å€¼è¿­ä»£ç®—æ³•-åŸºäºä»·å€¼å‡½æ•°çš„">ä»·å€¼è¿­ä»£ç®—æ³•/åŸºäºä»·å€¼å‡½æ•°çš„</h2>
<blockquote>
<p>ä»·å€¼è¿­ä»£çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>ç›´æ¥é€šè¿‡æœ€å¤§åŒ–ä»·å€¼å‡½æ•°æ¥æ‰¾åˆ°æœ€ä¼˜ç­–ç•¥</strong>ï¼Œä¸éœ€è¦æ˜¾å¼åœ°ç»´æŠ¤ç­–ç•¥ã€‚</p>
</blockquote>
<p>ä½¿ç”¨è´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611191853492.png" class="" title="image-20240611191853492">
<p>çš„è¿­ä»£å½¢å¼</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611152610430.png" class="" title="image-20240611152610430">
<p>è¿›è¡Œä»·å€¼è¿­ä»£ï¼›</p>
<p>ä½¿ç”¨</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611152643864.png" class="" title="image-20240611152643864">
<p>ä»è¿­ä»£å®Œæˆçš„çŠ¶æ€ä»·å€¼å‡½æ•°ä¸­è·å–ç­–ç•¥ï¼Œå³ ä»å½“å‰çŠ¶æ€å‡ºå‘ï¼Œå“ªä¸ªåŠ¨ä½œçš„ (å³æ—¶å¥–åŠ±+ä¸‹ä¸€çŠ¶æ€ä»·å€¼) æœ€å¤§ï¼Œç­–ç•¥å°±ä¸ºå“ªä¸ªåŠ¨ä½œ</p>
<br>
<p>æœ€ä¼˜çŠ¶æ€ä»·å€¼æ˜¯é€‰æ‹©æ­¤æ—¶ä½¿æœ€ä¼˜åŠ¨ä½œä»·å€¼æœ€å¤§çš„é‚£ä¸€ä¸ªåŠ¨ä½œæ—¶çš„çŠ¶æ€ä»·å€¼</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611153610316.png" class="" title="image-20240611153610316">
<img src="/2024/06/10/reinforce-learning-record/image-20240610213050168.png" class="" title="image-20240610213050168">
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">max_diff = <span class="number">0</span></span><br><span class="line">new_v = [<span class="number">0</span>] * self.env.ncol * self.env.nrow  <span class="comment"># è¿·å®«ç¯å¢ƒï¼Œåˆå§‹åŒ–çŠ¶æ€ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(self.env.ncol * self.env.nrow):</span><br><span class="line">    qsa_list = []</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        qsa = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:</span><br><span class="line">            p, next_state, r, done = res</span><br><span class="line">            qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))</span><br><span class="line">        qsa_list.append(qsa)  <span class="comment"># è®°å½•çŠ¶æ€sä¸‹çš„æ‰€æœ‰Q(s,a)ä»·å€¼</span></span><br><span class="line">     new_v[s] = <span class="built_in">max</span>(qsa_list)  <span class="comment"># å–æœ€å¤§ä½œä¸ºæ–°çŠ¶æ€ä»·å€¼</span></span><br><span class="line">     max_diff = <span class="built_in">max</span>(max_diff, <span class="built_in">abs</span>(new_v[s] - self.v[s]))</span><br><span class="line">self.v = new_v</span><br><span class="line"><span class="keyword">if</span> max_diff &lt; self.theta: <span class="keyword">break</span>  <span class="comment"># æ»¡è¶³æ”¶æ•›æ¡ä»¶,é€€å‡ºè¯„ä¼°è¿­ä»£</span></span><br><span class="line">cnt += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<br>
<p>å®Œæ•´ä»·å€¼è¿­ä»£ç®—æ³•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ValueIteration</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot; ä»·å€¼è¿­ä»£ç®—æ³• &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, env, theta, gamma</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–å‡½æ•°ï¼Œæ¥å—ç¯å¢ƒå¯¹è±¡envã€ä»·å€¼æ”¶æ•›é˜ˆå€¼thetaå’ŒæŠ˜æ‰£å› å­gamma</span></span><br><span class="line">        self.env = env  <span class="comment"># ä¿å­˜ç¯å¢ƒå¯¹è±¡</span></span><br><span class="line">        self.v = [<span class="number">0</span>] * self.env.ncol * self.env.nrow  <span class="comment"># åˆå§‹åŒ–ä»·å€¼å‡½æ•°vä¸º0ï¼Œå¤§å°ä¸ºç¯å¢ƒçš„æ ¼å­æ•°</span></span><br><span class="line">        self.theta = theta  <span class="comment"># ä»·å€¼æ”¶æ•›é˜ˆå€¼</span></span><br><span class="line">        self.gamma = gamma  <span class="comment"># æŠ˜æ‰£å› å­ï¼Œç”¨äºè®¡ç®—æœªæ¥å¥–åŠ±çš„æŠ˜æ‰£</span></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ç­–ç•¥piä¸ºNoneï¼Œè¡¨ç¤ºåœ¨ä»·å€¼è¿­ä»£ç»“æŸåå†è®¡ç®—ç­–ç•¥</span></span><br><span class="line">        self.pi = [<span class="literal">None</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.env.ncol * self.env.nrow)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">value_iteration</span>(<span class="params">self</span>):</span><br><span class="line">        cnt = <span class="number">0</span>  <span class="comment"># è®¡æ•°å™¨ï¼Œè®°å½•ä»·å€¼è¿­ä»£çš„è½®æ•°</span></span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            max_diff = <span class="number">0</span>  <span class="comment"># ç”¨äºè®°å½•ä»·å€¼å‡½æ•°çš„æœ€å¤§å˜åŒ–é‡</span></span><br><span class="line">            new_v = [<span class="number">0</span>] * self.env.ncol * self.env.nrow  <span class="comment"># åˆå§‹åŒ–æ–°çš„ä»·å€¼å‡½æ•°</span></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(self.env.ncol * self.env.nrow):  <span class="comment"># éå†æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line">                qsa_list = []  <span class="comment"># ç”¨äºå­˜å‚¨çŠ¶æ€sä¸‹æ‰€æœ‰åŠ¨ä½œçš„Qå€¼</span></span><br><span class="line">                <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># éå†æ‰€æœ‰åŠ¨ä½œ</span></span><br><span class="line">                    qsa = <span class="number">0</span>  <span class="comment"># åˆå§‹åŒ–Q(s,a)ä¸º0</span></span><br><span class="line">                    <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:  <span class="comment"># éå†çŠ¶æ€sä¸‹æ‰§è¡ŒåŠ¨ä½œaçš„æ‰€æœ‰å¯èƒ½ç»“æœ</span></span><br><span class="line">                        p, next_state, r, done = res  <span class="comment"># è·å–è½¬ç§»æ¦‚ç‡pã€ä¸‹ä¸€ä¸ªçŠ¶æ€next_stateã€å¥–åŠ±rå’Œæ˜¯å¦ç»ˆæ­¢done</span></span><br><span class="line">                        qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))  <span class="comment"># è®¡ç®—Q(s,a)çš„å€¼ï¼Œè€ƒè™‘æŠ˜æ‰£å› å­gamma</span></span><br><span class="line">                    qsa_list.append(qsa)  <span class="comment"># å°†Q(s,a)åŠ å…¥åˆ—è¡¨</span></span><br><span class="line">                new_v[s] = <span class="built_in">max</span>(qsa_list)  <span class="comment"># æ›´æ–°çŠ¶æ€sçš„ä»·å€¼å‡½æ•°ä¸ºæ‰€æœ‰åŠ¨ä½œQå€¼çš„æœ€å¤§å€¼</span></span><br><span class="line">                max_diff = <span class="built_in">max</span>(max_diff, <span class="built_in">abs</span>(new_v[s] - self.v[s]))  <span class="comment"># æ›´æ–°æœ€å¤§å˜åŒ–é‡</span></span><br><span class="line">            self.v = new_v  <span class="comment"># æ›´æ–°ä»·å€¼å‡½æ•°</span></span><br><span class="line">            <span class="keyword">if</span> max_diff &lt; self.theta: <span class="keyword">break</span>  <span class="comment"># å¦‚æœæœ€å¤§å˜åŒ–é‡å°äºé˜ˆå€¼thetaï¼Œåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">            cnt += <span class="number">1</span>  <span class="comment"># å¢åŠ è¿­ä»£æ¬¡æ•°</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ä»·å€¼è¿­ä»£ä¸€å…±è¿›è¡Œ%dè½®&quot;</span> % cnt)  <span class="comment"># æ‰“å°ä»·å€¼è¿­ä»£çš„è½®æ•°</span></span><br><span class="line">        self.get_policy()  <span class="comment"># æ ¹æ®æœ€ç»ˆçš„ä»·å€¼å‡½æ•°å¯¼å‡ºç­–ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_policy</span>(<span class="params">self</span>):  <span class="comment"># æ ¹æ®ä»·å€¼å‡½æ•°å¯¼å‡ºä¸€ä¸ªè´ªå©ªç­–ç•¥</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(self.env.nrow * self.env.ncol):  <span class="comment"># éå†æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line">            qsa_list = []  <span class="comment"># ç”¨äºå­˜å‚¨çŠ¶æ€sä¸‹æ‰€æœ‰åŠ¨ä½œçš„Qå€¼</span></span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># éå†æ‰€æœ‰åŠ¨ä½œ</span></span><br><span class="line">                qsa = <span class="number">0</span>  <span class="comment"># åˆå§‹åŒ–Q(s,a)ä¸º0</span></span><br><span class="line">                <span class="keyword">for</span> res <span class="keyword">in</span> self.env.P[s][a]:  <span class="comment"># éå†çŠ¶æ€sä¸‹æ‰§è¡ŒåŠ¨ä½œaçš„æ‰€æœ‰å¯èƒ½ç»“æœ</span></span><br><span class="line">                    p, next_state, r, done = res  <span class="comment"># è·å–è½¬ç§»æ¦‚ç‡pã€ä¸‹ä¸€ä¸ªçŠ¶æ€next_stateã€å¥–åŠ±rå’Œæ˜¯å¦ç»ˆæ­¢done</span></span><br><span class="line">                    qsa += p * (r + self.gamma * self.v[next_state] * (<span class="number">1</span> - done))  <span class="comment"># è®¡ç®—Q(s,a)çš„å€¼ï¼Œè€ƒè™‘æŠ˜æ‰£å› å­gamma</span></span><br><span class="line">                qsa_list.append(qsa)  <span class="comment"># å°†Q(s,a)åŠ å…¥åˆ—è¡¨</span></span><br><span class="line">            maxq = <span class="built_in">max</span>(qsa_list)  <span class="comment"># æ‰¾åˆ°çŠ¶æ€sä¸‹æ‰€æœ‰åŠ¨ä½œçš„æœ€å¤§Qå€¼</span></span><br><span class="line">            cntq = qsa_list.count(maxq)  <span class="comment"># è®¡ç®—æœ‰å¤šå°‘ä¸ªåŠ¨ä½œå¾—åˆ°äº†æœ€å¤§Qå€¼</span></span><br><span class="line">            <span class="comment"># è®©è¿™äº›åŠ¨ä½œå‡åˆ†æ¦‚ç‡ï¼Œå…¶ä»–åŠ¨ä½œçš„æ¦‚ç‡ä¸º0</span></span><br><span class="line">            self.pi[s] = [<span class="number">1</span> / cntq <span class="keyword">if</span> q == maxq <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> q <span class="keyword">in</span> qsa_list]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¯å¢ƒåˆå§‹åŒ–</span></span><br><span class="line">env = CliffWalkingEnv()  <span class="comment"># åˆ›å»ºä¸€ä¸ªæ‚¬å´–æ¼«æ­¥ç¯å¢ƒ</span></span><br><span class="line">action_meaning = [<span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>]  <span class="comment"># åŠ¨ä½œçš„å«ä¹‰ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸Šã€ä¸‹ã€å·¦ã€å³</span></span><br><span class="line">theta = <span class="number">0.001</span>  <span class="comment"># ä»·å€¼æ”¶æ•›é˜ˆå€¼</span></span><br><span class="line">gamma = <span class="number">0.9</span>  <span class="comment"># æŠ˜æ‰£å› å­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä»·å€¼è¿­ä»£ç®—æ³•å¯¹è±¡</span></span><br><span class="line">agent = ValueIteration(env, theta, gamma)</span><br><span class="line">agent.value_iteration()  <span class="comment"># æ‰§è¡Œä»·å€¼è¿­ä»£</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°ç­–ç•¥å’Œè·¯å¾„</span></span><br><span class="line">print_agent(agent, action_meaning, <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">37</span>, <span class="number">47</span>)), [<span class="number">47</span>])</span><br></pre></td></tr></table></figure>
<br>
<h2 id="ç­–ç•¥è¿­ä»£-ä»·å€¼è¿­ä»£å¯¹æ¯”">ç­–ç•¥è¿­ä»£&amp;ä»·å€¼è¿­ä»£å¯¹æ¯”</h2>
<ul>
<li>ç­–ç•¥è¿­ä»£çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>äº¤æ›¿è¿›è¡Œç­–ç•¥è¯„ä¼°å’Œç­–ç•¥æå‡</strong>ï¼Œç›´åˆ°ç­–ç•¥æ”¶æ•›åˆ°æœ€ä¼˜ã€‚</li>
<li>ä»·å€¼è¿­ä»£çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>ç›´æ¥é€šè¿‡æœ€å¤§åŒ–ä»·å€¼å‡½æ•°æ¥æ‰¾åˆ°æœ€ä¼˜ç­–ç•¥</strong>ï¼Œä¸éœ€è¦æ˜¾å¼åœ°ç»´æŠ¤ç­–ç•¥ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œä»·å€¼è¿­ä»£å‡½æ•° <code>value_iteration</code> å’Œç­–ç•¥è¯„ä¼°å‡½æ•° <code>policy_evaluation</code> æœ‰ç€ä¸€æ ·çš„å®ç°</p>
<br>
<p><strong>åŠ¨ä½œä»·å€¼æ›´æ–°</strong>å’Œ<strong>çŠ¶æ€ä»·å€¼æ›´æ–°</strong>æ˜¯ä»·å€¼å‡½æ•°æ›´æ–°çš„ä¸¤ç§æ–¹å¼ï¼Œå¯ä»¥ç”¨äº<strong>ç­–ç•¥è¿­ä»£</strong>ã€<strong>ä»·å€¼è¿­ä»£</strong>æˆ–å…¶ä»–ç®—æ³•ã€‚</p>
<ul>
<li>çŠ¶æ€ä»·å€¼è¿­ä»£å’ŒåŠ¨ä½œä»·å€¼è¿­ä»£æ˜¯ç­‰ä»·çš„ï¼Œåªæ˜¯æ›´æ–°çš„å¯¹è±¡ä¸åŒã€‚</li>
<li>åœ¨ä»·å€¼è¿­ä»£ä¸­ï¼Œé€šå¸¸ä½¿ç”¨çŠ¶æ€ä»·å€¼è¿­ä»£ï¼Œå› ä¸ºå®ƒçš„è®¡ç®—é‡è¾ƒå°ã€‚</li>
</ul>
<br>
<h2 id="æœ‰æ¨¡å‹-æ— æ¨¡å‹-åœ¨çº¿ç­–ç•¥-ç¦»çº¿ç­–ç•¥">æœ‰æ¨¡å‹&amp;æ— æ¨¡å‹+åœ¨çº¿ç­–ç•¥&amp;ç¦»çº¿ç­–ç•¥</h2>
<p><strong>æœ‰æ¨¡å‹å¼ºåŒ–å­¦ä¹ ï¼š</strong></p>
<p>æ™ºèƒ½ä½“å­¦ä¹ ç¯å¢ƒçš„çŠ¶æ€è½¬ç§»å‡½æ•°</p>
<p>ç¯å¢ƒçš„çŠ¶æ€è½¬ç§»å‡½æ•°å·²çŸ¥</p>
<p>æ™ºèƒ½ä½“å¯ä»¥ç›´æ¥æ ¹æ®çŠ¶æ€è½¬ç§»å‡½æ•°å¾—åˆ°åœ¨å¯¹ç¯å¢ƒè¿›è¡ŒåŠ¨ä½œaåç¯å¢ƒçš„ä¸‹ä¸€çŠ¶æ€</p>
<p># çŠ¶æ€è½¬ç§»å‡½æ•°P[state][action] = [(p, next_state, reward, done)]åŒ…å«è½¬ç§»æˆåŠŸæ¦‚ç‡ï¼Œä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œå¥–åŠ±å’Œæ˜¯å¦å®Œæˆ</p>
<ul>
<li>Dyna-Q</li>
<li>Monte Carlo Tree Search (MCTS)</li>
<li>PILCO (Probabilistic Inference for Learning Control)</li>
</ul>
<p><strong>æ— æ¨¡å‹å¼ºåŒ–å­¦ä¹ ï¼š</strong></p>
<p>æ™ºèƒ½ä½“é€šè¿‡ä¸ç¯å¢ƒäº¤äº’å­¦ä¹ çŠ¶æ€å’Œå¥–åŠ±ä¹‹é—´çš„æ˜ å°„å…³ç³»</p>
<p>ç¯å¢ƒçš„çŠ¶æ€è½¬ç§»å‡½æ•°æœªçŸ¥</p>
<p>æ™ºèƒ½ä½“å¿…é¡»é€šè¿‡ä¸ç¯å¢ƒçš„äº¤äº’æ‰èƒ½å¾—åˆ°ç¯å¢ƒçš„ä¸‹ä¸€çŠ¶æ€</p>
<ul>
<li>Q-learning</li>
<li>SARSA</li>
<li>Deep Q-Network (DQN)</li>
<li>Policy Gradient methods (e.g., REINFORCE, A2C, PPO)</li>
</ul>
<br>
<p>æ ·æœ¬ï¼šå½“å‰çŠ¶æ€ï¼Œä¸‹ä¸€çŠ¶æ€ï¼Œé‡‡å–åŠ¨ä½œï¼Œå¥–åŠ±</p>
<p><strong>åœ¨çº¿ç­–ç•¥å­¦ä¹ ï¼š</strong></p>
<p>ä¸ä¿å­˜æ ·æœ¬</p>
<p><strong>ç¦»çº¿ç­–ç•¥å­¦ä¹ ï¼š</strong></p>
<p>ä½¿ç”¨ç»éªŒå›æ”¾æ± ä¿å­˜æ ·æœ¬</p>
<br>
<h2 id="ç®—æ³•">ç®—æ³•</h2>
<h3 id="è’™ç‰¹å¡æ´›æ–¹æ³•">è’™ç‰¹å¡æ´›æ–¹æ³•</h3>
<p>Value-based + online</p>
<p>ä»æŸçŠ¶æ€så‡ºå‘ï¼ŒåŸºäºç­–ç•¥Î ï¼Œè·å¾—ä¸€æ¡çŠ¶æ€åºåˆ—ï¼Œè¯¥çŠ¶æ€åºåˆ—å¯¹åº”ä¸€ä¸ªå›æŠ¥Gï¼›è¯¥è¿‡ç¨‹ä¸ºä¸€æ¬¡é‡‡æ ·ã€‚</p>
<p>åå¤é‡‡æ ·ï¼Œå¾—åˆ°Nä¸ªçŠ¶æ€åºåˆ—+å›æŠ¥å’ŒMï¼Œç”±å¤§æ•°å®šå¾‹ï¼Œå¯å¾—è¯¥çŠ¶æ€çš„çŠ¶æ€ä»·å€¼</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611161858965.png" class="" title="image-20240611161858965">
<p>ä½¿ç”¨å¢é‡æ›´æ–°æ–¹æ³•</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611161157050.png" class="" title="image-20240611161157050">
<p>è¡¥ï¼šå¢é‡æ›´æ–°åŸç†</p>
<p>æ–°å‡å€¼ = æ—§å‡å€¼ + 1/æ€»é‡ * (æ–°å€¼ - æ—§å‡å€¼)</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611161942958.png" class="" title="image-20240611161942958">
<br>
<h3 id="æ—¶åºå·®åˆ†ç®—æ³•">æ—¶åºå·®åˆ†ç®—æ³•</h3>
<p>Value-based + online</p>
<p>ç±»ä¼¼äºè’™ç‰¹å¡æ´›ï¼Œæ›´æ–°çŠ¶æ€sçš„çŠ¶æ€ä»·å€¼æ—¶ï¼Œä¸ä½¿ç”¨å®Œæ•´çš„çŠ¶æ€åºåˆ—ï¼Œåœ¨å¾—åˆ°ä¸‹ä¸€çŠ¶æ€æ—¶ç«‹å³å¯¹çŠ¶æ€sçš„çŠ¶æ€ä»·å€¼è¿›è¡Œæ›´æ–°</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611162513650.png" class="" title="image-20240611162513650">
<p>è’™ç‰¹å¡æ´›ä½¿ç”¨ç¬¬ä¸‰è¡Œå¯¹çŠ¶æ€ä»·å€¼è¿›è¡Œæ›´æ–°ï¼Œæ—¶åºå·®åˆ†ä½¿ç”¨ç¬¬å››è¡Œå¯¹çŠ¶æ€ä»·å€¼è¿›è¡Œæ›´æ–°</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611162624769.png" class="" title="image-20240611162624769">
<ul>
<li>åªå‘å‰èµ°äº†ä¸€æ­¥çš„è’™ç‰¹å¡æ´›</li>
<li>ä½¿ç”¨ä¸‹ä¸€çŠ¶æ€çš„çŠ¶æ€ä»·å€¼ä»£æ›¿äº†å¾ˆé•¿çš„çŠ¶æ€åºåˆ—çš„å›æŠ¥(çŠ¶æ€ä»·å€¼æœ¬èº«å°±æ˜¯æ‰€æœ‰æœªæ¥æ—¶åˆ»çš„å›æŠ¥æœŸæœ›å’Œ)</li>
<li>å¢é‡æ›´æ–°ä½“ç°åœ¨ å‡å·å‰éƒ¨åˆ†ä¸º (æ–° çŠ¶æ€sçš„çŠ¶æ€ä»·å€¼)ï¼Œå‡å·åéƒ¨åˆ†ä¸º (æ—§ çŠ¶æ€sçš„çŠ¶æ€ä»·å€¼)</li>
</ul>
<br>
<h3 id="Sarsaç®—æ³•">Sarsaç®—æ³•</h3>
<p>Value-based + online</p>
<p>ç±»ä¼¼äºæ—¶åºå·®åˆ†ç®—æ³•ï¼Œå¯¹åŠ¨ä½œä»·å€¼è¿›è¡Œæ›´æ–°ï¼Œç›®æ ‡æ˜¯ä¼°è®¡ <strong>Îµ-greedyç­–ç•¥çš„åŠ¨ä½œä»·å€¼å‡½æ•°</strong></p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611191221769.png" class="" title="image-20240611191221769">
<p>ç®—æ³•</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612100452913.png" class="" title="image-20240612100452913">
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">td_error = r + self.gamma * self.Q_table[s1, a1] - self.Q_table[s0, a0]</span><br><span class="line">self.Q_table[s0, a0] += self.alpha * td_error</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Qè¡¨çš„å˜åŒ–å…¶å®æ˜¯ä»åå‘å‰è”“å»¶çš„</p>
<p>ä¸€ä¸ªå…¨0çš„Qè¡¨ï¼Œå½“æŸä¸€æ­¥äº§ç”Ÿå¥–åŠ±åï¼Œè¯¥æ­¥å¯¹åº”çš„Qå€¼å‡ºç°äº†å€¼ï¼Œç„¶ååœ¨æ¯ä¸€è½®çš„æ›´æ–°ä¸­ï¼Œå€¼å‘å‰æ‰©æ•£</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å½¢è±¡åœ°æ¯”å–»æˆï¼š</p>
<ul>
<li>
<p><strong>â€œå®è—â€è¢«å‘ç°ï¼š</strong> å½“æ™ºèƒ½ä½“åœ¨æŸä¸€æ­¥ <code>(s, a)</code> æ‰§è¡Œåï¼Œåˆ°è¾¾ <code>s'</code> å¹¶è·å¾—äº†å¥–åŠ± <code>r</code> (å°¤å…¶æ˜¯æ­£å¥–åŠ±ï¼Œå¯ä»¥çœ‹ä½œæ‰¾åˆ°äº†â€œå®è—â€çš„ç¬¬ä¸€ä¸çº¿ç´¢)ï¼Œé‚£ä¹ˆ <code>Q(s, a)</code> ä¼šé¦–å…ˆç›´æ¥å—åˆ°è¿™ä¸ª <code>r</code> çš„å½±å“è€Œæ›´æ–°ã€‚å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡è·å¾—å¥–åŠ±ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Q(s, a)</code> å°±ä»0å˜æˆäº†é0å€¼ã€‚</p>
</li>
<li>
<p><strong>â€œæ¶ˆæ¯â€å‘å‰ä¼ é€’ï¼š</strong></p>
<ul>
<li>åœ¨<strong>ä¸‹ä¸€è½®</strong>çš„è®­ç»ƒä¸­ï¼Œå¦‚æœæ™ºèƒ½ä½“å†æ¬¡è®¿é—®åˆ°çŠ¶æ€ <code>s_prev</code>ï¼Œå¹¶ä¸”å®ƒé‡‡å–çš„åŠ¨ä½œ <code>a_prev</code> èƒ½å¤Ÿå¼•å¯¼å®ƒåˆ°è¾¾ä¹‹å‰é‚£ä¸ªçŠ¶æ€ <code>s</code>ï¼ˆä¹Ÿå°±æ˜¯å®è—çº¿ç´¢æ›´è¿‘ä¸€æ­¥çš„çŠ¶æ€ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ›´æ–° <code>Q(s_prev, a_prev)</code> æ—¶ï¼Œä¼šä½¿ç”¨åˆ° <code>Q(s, a_selected_in_s)</code>ï¼ˆå¯¹äºSARSAï¼‰æˆ– <code>max_a' Q(s, a')</code>ï¼ˆå¯¹äºQ-learningï¼‰ã€‚</li>
<li>å› ä¸º <code>Q(s, ...)</code> å·²ç»å› ä¸ºä¸Šä¸€è½®çš„å¥–åŠ±è€Œæœ‰äº†ä¸€ä¸ªéé›¶å€¼ï¼Œè¿™ä¸ªå€¼å°±ä¼šé€šè¿‡æŠ˜æ‰£å› å­ <code>Î³</code> â€œæ‰“æŠ˜â€åï¼Œè´¡çŒ®ç»™ <code>Q(s_prev, a_prev)</code> çš„æ›´æ–°ã€‚</li>
<li>è¿™å°±å¥½æ¯”ï¼ŒçŠ¶æ€ <code>s</code> å‘Šè¯‰äº†çŠ¶æ€ <code>s_prev</code>ï¼šâ€œå˜¿ï¼Œä»ä½ è¿™é‡Œèµ°æŸæ¡è·¯åˆ°æˆ‘è¿™é‡Œï¼Œæˆ‘è¿™é‡Œæœ‰ç‚¹å¥½ä¸œè¥¿ï¼ˆæˆ–è€…é¢„ç¤ºç€å¥½ä¸œè¥¿ï¼‰ï¼â€</li>
</ul>
</li>
<li>
<p><strong>é€å±‚è”“å»¶/æ‰©æ•£ï¼š</strong> è¿™ä¸ªè¿‡ç¨‹ä¼šä¸æ–­é‡å¤ã€‚çŠ¶æ€ <code>s_prev</code> çš„æ›´æ–°å€¼åˆä¼šå½±å“åˆ°æ›´æ—©è®¿é—®å®ƒçš„çŠ¶æ€ <code>s_prev_prev</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚å°±åƒæ°´æ³¢ä¸€æ ·ï¼Œä»å¥–åŠ±äº§ç”Ÿçš„åœ°æ–¹ï¼ˆæˆ–ç›®æ ‡çŠ¶æ€é™„è¿‘ï¼‰å¼€å§‹ï¼Œä»·å€¼ä¿¡æ¯é€æ¸å‘èµ·å§‹çŠ¶æ€æˆ–è¿œç¦»ç›®æ ‡çš„çŠ¶æ€æ‰©æ•£ã€‚</p>
</li>
</ul>
</blockquote>
<br>
<h3 id="Q-learningç®—æ³•">Q-learningç®—æ³•</h3>
<p>Value-based + offline</p>
<p>å¯¹åŠ¨ä½œä»·å€¼è¿›è¡Œæ›´æ–°ï¼Œç›®æ ‡æ˜¯ä¼°è®¡ <strong>æœ€ä¼˜ç­–ç•¥çš„åŠ¨ä½œä»·å€¼å‡½æ•°</strong></p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611194333945.png" class="" title="image-20240611194333945">
<p>ç®—æ³•</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612100509915.png" class="" title="image-20240612100509915">
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">td_error = r + self.gamma * self.Q_table[s1].<span class="built_in">max</span>() - self.Q_table[s0, a0]</span><br><span class="line">self.Q_table[s0, a0] += self.alpha * td_error</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯¹æ¯”Sarsaå’ŒQ-learning</p>
<p>å®é™…ä¸Šï¼Œ$r_t$å’Œ$R_t$åœ¨å„è‡ªçš„ç®—æ³•ä¸­éƒ½è¡¨ç¤ºåœ¨æ—¶é—´æ­¥$t$æ—¶ç¯å¢ƒåé¦ˆçš„å³æ—¶å¥–åŠ±ï¼Œä½†åœ¨æ›´æ–°å…¬å¼ä¸­çš„ä½¿ç”¨æ–¹å¼ç•¥æœ‰ä¸åŒã€‚Sarsaç®—æ³•ä½¿ç”¨ä¸‹ä¸€ä¸ªåŠ¨ä½œ$a_{t+1}$çš„åŠ¨ä½œä»·å€¼$Q(s_{t+1}, a_{t+1})$ï¼Œè€ŒQ-learningç®—æ³•ä½¿ç”¨ä¸‹ä¸€çŠ¶æ€$s_{t+1}$ä¸‹æœ€ä¼˜åŠ¨ä½œçš„åŠ¨ä½œä»·å€¼$\max_{aâ€™} Q(sâ€™, aâ€™)$ã€‚</p>
<p>Sarsa æ˜¯<strong>åœ¨çº¿ç­–ç•¥</strong>ï¼ˆon-policyï¼‰ç®—æ³•ï¼Œ Q-learning æ˜¯<strong>ç¦»çº¿ç­–ç•¥</strong>ï¼ˆoff-policyï¼‰ç®—æ³•ï¼Œå› ä¸ºç›®æ ‡ç­–ç•¥å’Œè¡Œä¸ºç­–ç•¥åˆ†ç¦»ï¼ŒQ-learning å¯ä»¥é‡‡ç”¨éå¸¸å…·æœ‰æ¢ç´¢æ€§çš„è¡Œä¸ºç­–ç•¥ï¼ˆç”šè‡³æ˜¯å®Œå…¨éšæœºçš„ç­–ç•¥ï¼‰ï¼ŒåŒæ—¶ä»ç„¶å­¦ä¹ æœ€ä¼˜çš„Qå€¼ã€‚è¿™ä½¿å¾—å®ƒåœ¨æ¢ç´¢æœªçŸ¥ç¯å¢ƒæ—¶å¯èƒ½æ›´æœ‰æ•ˆç‡ã€‚SARSA å­¦ä¹ çš„ä»·å€¼å‡½æ•°ç›´æ¥å—åˆ°å…¶æ¢ç´¢è¡Œä¸ºçš„å½±å“ã€‚å¦‚æœæ¢ç´¢ç­–ç•¥åŒ…å«äº†ä¸€äº›â€œæ„šè ¢â€çš„åŠ¨ä½œï¼ŒSARSAè®¡ç®—å‡ºçš„Qå€¼ä¼šåæ˜ è¿™äº›â€œæ„šè ¢â€åŠ¨ä½œçš„åæœã€‚</p>
<p>è¯´äººè¯å°±æ˜¯ï¼ŒQ-learningåœ¨å®é™…è¡ŒåŠ¨ä¸­â€œå¤§èƒ†å°è¯•â€ï¼Œä½†åœ¨å­¦ä¹ å’Œè¯„ä¼°æ—¶åˆ™â€œä»¥æœ€ä¼˜ä¸ºç›®æ ‡â€ã€‚</p>
</blockquote>
<br>
<blockquote>
<p>Q: ä¸ºä»€ä¹ˆQ-leanringä¸­çš„Qè¡¨çš„å€¼æ˜¯ä»ï¼šä¸€ä¸ªå…¨0çš„Qè¡¨ï¼Œå½“æŸä¸€æ­¥äº§ç”Ÿå¥–åŠ±åï¼Œè¯¥æ­¥å¯¹åº”çš„Qå€¼å‡ºç°äº†å€¼ï¼Œç„¶ååœ¨æ¯ä¸€è½®çš„æ›´æ–°ä¸­ï¼Œå€¼å‘å‰æ‰©æ•£ï¼›ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥ä»ç»ˆç‚¹å‡ºå‘ï¼ˆä»æœ‰rewardçš„åœ°æ–¹å‡ºå‘ï¼‰ï¼Œåå‘å‘å‰æ¨è¿›ï¼Œç›´æ¥ä¸€æ¬¡éå†å¾—åˆ°Qè¡¨å‘¢ï¼Ÿè¿™ä¸æ˜¯æ›´å¿«å—ï¼Ÿ</p>
<p>A: ä½ æå‡ºçš„æƒ³æ³•éå¸¸å¥½ï¼Œä¹Ÿéå¸¸æœ‰æ´å¯ŸåŠ›ï¼ä½ æ‰€æè¿°çš„â€œä»ç»ˆç‚¹å‡ºå‘ï¼Œåå‘å‘å‰æ¨è¿›ï¼Œç›´æ¥ä¸€æ¬¡éå†å¾—åˆ°Qè¡¨â€çš„æ–¹æ³•ï¼Œå…¶å®éå¸¸æ¥è¿‘ç”šè‡³å°±æ˜¯ä¸€ç§ç»å…¸çš„**åŠ¨æ€è§„åˆ’ï¼ˆDynamic Programming, DPï¼‰<strong>æ–¹æ³•ï¼Œæ¯”å¦‚</strong>ä»·å€¼è¿­ä»£ï¼ˆValue Iterationï¼‰<strong>æˆ–</strong>ç­–ç•¥è¿­ä»£ï¼ˆPolicy Iterationï¼‰**ä¸­çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆQ-learningä¸ç›´æ¥è¿™ä¹ˆåšå‘¢ï¼Ÿä¸»è¦åŸå› åœ¨äºå®ƒä»¬è§£å†³é—®é¢˜çš„<strong>å‰æå‡è®¾å’Œé€‚ç”¨åœºæ™¯</strong>ä¸åŒï¼š</p>
<ol>
<li>
<p><strong>æ¨¡å‹æœªçŸ¥ vs. æ¨¡å‹å·²çŸ¥ (Model-Free vs. Model-Based)</strong></p>
<ul>
<li><strong>ä½ æè¿°çš„æ–¹æ³• (ç±»ä¼¼DP)ï¼š</strong> è¿™ç§æ–¹æ³•é€šå¸¸éœ€è¦æˆ‘ä»¬<strong>å·²çŸ¥ç¯å¢ƒçš„æ¨¡å‹ (Model-Based)</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ éœ€è¦çŸ¥é“ï¼š
<ul>
<li><strong>çŠ¶æ€è½¬ç§»æ¦‚ç‡ P(sâ€™ | s, a):</strong> åœ¨çŠ¶æ€sæ‰§è¡ŒåŠ¨ä½œaåï¼Œè½¬ç§»åˆ°çŠ¶æ€sâ€™çš„æ¦‚ç‡ã€‚</li>
<li><strong>å¥–åŠ±å‡½æ•° R(s, a, sâ€™):</strong> åœ¨çŠ¶æ€sæ‰§è¡ŒåŠ¨ä½œaå¹¶è½¬ç§»åˆ°çŠ¶æ€sâ€™åèƒ½è·å¾—çš„å¥–åŠ±ã€‚</li>
<li>æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œä½ æ‰èƒ½ä»ç»ˆç‚¹ï¼ˆæˆ–æœ‰å¥–åŠ±çš„åœ°æ–¹ï¼‰å‡†ç¡®åœ°åå‘æ¨ç®—å‡ºå‰ä¸€ä¸ªçŠ¶æ€é‡‡å–ä»€ä¹ˆåŠ¨ä½œèƒ½è¾¾åˆ°è¿™ä¸ªå¥–åŠ±çŠ¶æ€ï¼Œä»¥åŠè¿™ä¸ªåŠ¨ä½œçš„ä»·å€¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ä»·å€¼è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬ä¼šç”¨è´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹ <code>V*(s) = max_a Î£_&#123;s'&#125; P(s'|s,a) [R(s,a,s') + Î³V*(s')]</code> æ¥æ›´æ–°æ‰€æœ‰çŠ¶æ€çš„ä»·å€¼ï¼Œè¿™ç¡®å®æ˜¯ä»â€œç»“æœâ€å€’æ¨ã€‚</li>
</ul>
</li>
<li><strong>Q-learningï¼š</strong> Q-learningæ˜¯ä¸€ç§<strong>æ¨¡å‹æ— å…³ (Model-Free)</strong> çš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ã€‚å®ƒ<strong>ä¸éœ€è¦äº‹å…ˆçŸ¥é“ç¯å¢ƒçš„æ¨¡å‹</strong>ã€‚æ™ºèƒ½ä½“å°±åƒä¸€ä¸ªåœ¨æœªçŸ¥è¿·å®«ä¸­æ¢ç´¢çš„äººï¼Œå®ƒåªèƒ½é€šè¿‡ä¸ç¯å¢ƒäº¤äº’ï¼ˆå°è¯•åŠ¨ä½œã€è§‚å¯Ÿç»“æœå’Œå¥–åŠ±ï¼‰æ¥å­¦ä¹ ã€‚å®ƒä¸çŸ¥é“â€œå¢™çš„å¦ä¸€è¾¹æ˜¯ä»€ä¹ˆâ€ï¼Œä¹Ÿä¸çŸ¥é“â€œèµ°è¿™æ¡è·¯ä¸€å®šèƒ½æ‹¿åˆ°å¥¶é…ªâ€ã€‚</li>
</ul>
</li>
<li>
<p><strong>å­¦ä¹ æ–¹å¼ï¼šé€šè¿‡ç»éªŒå­¦ä¹  vs. é€šè¿‡è§„åˆ’å­¦ä¹ </strong></p>
<ul>
<li><strong>ä½ æè¿°çš„æ–¹æ³• (ç±»ä¼¼DP)ï¼š</strong> è¿™æ˜¯åœ¨<strong>è§„åˆ’ (Planning)</strong>ã€‚ä½ æ‹¥æœ‰äº†å®Œæ•´çš„åœ°å›¾ï¼ˆæ¨¡å‹ï¼‰ï¼Œç„¶åä½ å¯ä»¥åœ¨è„‘æµ·ä¸­æˆ–çº¸ä¸Šè¿›è¡Œæ¨æ¼”ï¼Œè®¡ç®—å‡ºæœ€ä¼˜è·¯å¾„ã€‚</li>
<li><strong>Q-learningï¼š</strong> è¿™æ˜¯åœ¨<strong>å­¦ä¹  (Learning)</strong>ã€‚æ™ºèƒ½ä½“é€šè¿‡ä¸€æ¬¡æ¬¡çš„<strong>è¯•é”™ (trial-and-error)</strong> æ¥ç§¯ç´¯ç»éªŒã€‚
<ul>
<li>åˆå§‹Qè¡¨ä¸º0ï¼Œè¡¨ç¤ºå¯¹ç¯å¢ƒä¸€æ— æ‰€çŸ¥ã€‚</li>
<li>å½“æŸä¸€æ­¥äº§ç”Ÿå¥–åŠ±æ—¶ï¼ŒQ-learningä¼šæ›´æ–°è¯¥<code>(çŠ¶æ€, åŠ¨ä½œ)</code>å¯¹çš„Qå€¼ã€‚è¿™ä¸ªQå€¼ä»£è¡¨äº†â€œåœ¨é‚£ä¸ªçŠ¶æ€ä¸‹æ‰§è¡Œé‚£ä¸ªåŠ¨ä½œï¼ŒæœŸæœ›æœªæ¥èƒ½è·å¾—çš„æ€»å›æŠ¥ï¼ˆåŒ…æ‹¬å³æ—¶å¥–åŠ±ï¼‰â€ã€‚</li>
<li>â€œå€¼å‘å‰æ‰©æ•£â€ï¼ˆå®é™…ä¸Šæ˜¯å¥–åŠ±ä¿¡æ¯é€šè¿‡è´å°”æ›¼æ–¹ç¨‹åå‘ä¼ æ’­ï¼‰çš„è¿‡ç¨‹ï¼Œæ˜¯æ™ºèƒ½ä½“é€æ¸è®¤è¯†åˆ°â€œå“¦ï¼ŒåŸæ¥è¿™ä¸ªåŠ¨ä½œæœ€ç»ˆèƒ½å¯¼å‘é‚£ä¸ªæœ‰å¥–åŠ±çš„çŠ¶æ€ï¼Œæ‰€ä»¥è¿™ä¸ªåŠ¨ä½œçš„ä»·å€¼ä¹Ÿåº”è¯¥é«˜ä¸€äº›â€ã€‚è¿™ä¸ªâ€œæ‰©æ•£â€æ˜¯åŸºäºå®é™…æ¢ç´¢åˆ°çš„è·¯å¾„å’Œå¥–åŠ±ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>é€‚ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>ä½ æè¿°çš„æ–¹æ³• (ç±»ä¼¼DP)ï¼š</strong> éå¸¸é€‚åˆäºæ¨¡å‹å·²çŸ¥ä¸”çŠ¶æ€ç©ºé—´ä¸è‡³äºè¿‡å¤§çš„é—®é¢˜ï¼Œä¾‹å¦‚æ£‹ç›˜æ¸¸æˆï¼ˆè§„åˆ™å·²çŸ¥ï¼‰ã€æœ€çŸ­è·¯å¾„é—®é¢˜ï¼ˆåœ°å›¾å·²çŸ¥ï¼‰ã€‚å®ƒçš„è®¡ç®—æ•ˆç‡åœ¨æ¨¡å‹å·²çŸ¥æ—¶é€šå¸¸æ›´é«˜ã€‚</li>
<li><strong>Q-learningï¼š</strong> éå¸¸é€‚åˆäºæ¨¡å‹æœªçŸ¥æˆ–æ¨¡å‹éå¸¸å¤æ‚éš¾ä»¥ç²¾ç¡®æè¿°çš„ç¯å¢ƒï¼Œä¾‹å¦‚æœºå™¨äººæ§åˆ¶ï¼ˆç‰©ç†æ¨¡å‹å¤æ‚ï¼‰ã€å¾ˆå¤šç°å®ä¸–ç•Œçš„äº¤äº’é—®é¢˜ã€‚å®ƒå¯ä»¥é€šè¿‡ä¸çœŸå®ç¯å¢ƒæˆ–æ¨¡æ‹Ÿç¯å¢ƒäº¤äº’æ¥å­¦ä¹ ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆQ-learningçš„â€œæ‰©æ•£â€çœ‹èµ·æ¥æ…¢ï¼Ÿ</strong></p>
<ul>
<li><strong>æ¢ç´¢çš„å¿…è¦æ€§ï¼š</strong> å› ä¸ºæ¨¡å‹æœªçŸ¥ï¼ŒQ-learningéœ€è¦é€šè¿‡æ¢ç´¢ï¼ˆæ¯”å¦‚Îµ-greedyç­–ç•¥ï¼‰æ¥å‘ç°æ–°çš„è·¯å¾„å’Œæ½œåœ¨çš„å¥–åŠ±ã€‚å¦‚æœå®ƒåªèµ°å·²çŸ¥çš„â€œå¥½è·¯â€ï¼Œå¯èƒ½æ°¸è¿œå‘ç°ä¸äº†æ›´å¥½çš„è·¯å¾„ã€‚</li>
<li><strong>é‡‡æ ·æ•ˆç‡ï¼š</strong> Q-learningæ˜¯åŸºäºé‡‡æ ·çš„ï¼Œå®ƒåªæ›´æ–°å®é™…ç»å†è¿‡çš„<code>(çŠ¶æ€, åŠ¨ä½œ)</code>å¯¹ã€‚å¦‚æœä¸€ä¸ªçŠ¶æ€å¾ˆå°‘è¢«è®¿é—®ï¼Œæˆ–è€…æŸä¸ªé€šå¾€å¥–åŠ±çš„è·¯å¾„å¾ˆé•¿ï¼Œé‚£ä¹ˆå¥–åŠ±ä¿¡æ¯å°±éœ€è¦å¾ˆå¤šè½®è¿­ä»£æ‰èƒ½æ…¢æ…¢â€œä¼ æ’­â€å›å»ã€‚</li>
<li><strong>åœ¨çº¿å­¦ä¹ ï¼š</strong> Q-learningå¯ä»¥è¿›è¡Œåœ¨çº¿å­¦ä¹ ï¼Œå³åœ¨ä¸ç¯å¢ƒäº¤äº’çš„è¿‡ç¨‹ä¸­ä¸æ–­æ›´æ–°Qè¡¨ï¼Œé€‚åº”ç¯å¢ƒçš„å˜åŒ–ã€‚è€ŒDPé€šå¸¸æ˜¯ç¦»çº¿è¿›è¡Œçš„ï¼Œå‡è®¾ç¯å¢ƒæ¨¡å‹å›ºå®šã€‚</li>
</ul>
<p><strong>æ€»ç»“ä¸€ä¸‹ï¼š</strong></p>
<ul>
<li>å¦‚æœä½ <strong>æœ‰å®Œæ•´çš„ç¯å¢ƒæ¨¡å‹</strong>ï¼ˆçŸ¥é“æ‰€æœ‰çŠ¶æ€è½¬ç§»å’Œå¥–åŠ±ï¼‰ï¼Œé‚£ä¹ˆä½ æè¿°çš„ä»ç»ˆç‚¹åå‘ä¼ æ’­çš„æ–¹æ³•ï¼ˆå¦‚ä»·å€¼è¿­ä»£ï¼‰ç¡®å®æ˜¯æ›´ç›´æ¥å’Œé«˜æ•ˆçš„ï¼Œèƒ½å¤Ÿä¸€æ¬¡æ€§ï¼ˆæˆ–ç»è¿‡å‡ æ¬¡è¿­ä»£ï¼‰è®¡ç®—å‡ºQè¡¨ã€‚</li>
<li>Q-learningçš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†è§£å†³<strong>æ¨¡å‹æœªçŸ¥</strong>çš„é—®é¢˜ã€‚å®ƒé€šè¿‡ä¸ç¯å¢ƒäº¤äº’ã€é€æ­¥æ¢ç´¢å’Œåˆ©ç”¨è´å°”æ›¼æ–¹ç¨‹æ¥å­¦ä¹ Qå€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹çœ‹èµ·æ¥åƒæ˜¯â€œå¥–åŠ±å‘å‰æ‰©æ•£â€ï¼Œä½†æœ¬è´¨ä¸Šæ˜¯å¥–åŠ±ä¿¡æ¯é€šè¿‡ç»éªŒé€æ­¥åå‘ä¼ æ’­æ›´æ–°å…ˆå‰çŠ¶æ€çš„ä»·å€¼ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œä¸æ˜¯Q-learningâ€œå‚»â€ï¼Œè€Œæ˜¯å®ƒè¢«è®¾è®¡ç”¨æ¥è§£å†³ä¸€ç±»æ›´æ™®éï¼ˆæ¨¡å‹æœªçŸ¥ï¼‰çš„é—®é¢˜ï¼Œä¸ºæ­¤å®ƒé‡‡ç”¨äº†é€šè¿‡ç»éªŒå­¦ä¹ çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼çš„ç‰¹æ€§å°±æ˜¯é€æ­¥æ›´æ–°å’Œä¿¡æ¯ä¼ æ’­ã€‚</p>
</blockquote>
<br>
<h3 id="DQN-DDQN">DQN/DDQN</h3>
<p>Value-based + offline</p>
<p><strong>DQN</strong></p>
<p>å°†Q-learningçš„Qè¡¨æ¢æˆnet</p>
<p>ç½‘ç»œçš„æŸå¤±å‡½æ•°</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250322111503025.png" class="" title="image-20250322111503025">
<blockquote>
<p>DQNç½‘ç»œæ—¨åœ¨è®©Q(s,a)æ›´æ–°åˆ°é€¼è¿‘æœ€ä¼˜åŠ¨ä½œçš„åŠ¨ä½œä»·å€¼$r + \max_{aâ€™} Q(sâ€™, aâ€™)$</p>
<p>å•ç½‘ç»œå­˜åœ¨é—®é¢˜ï¼š</p>
<p>åœ¨ DQN ä¸­ï¼ŒæŸå¤±å‡½æ•°TDæœ¬èº«ä¾èµ–äºç¥ç»ç½‘ç»œçš„è¾“å‡º <em>Q</em>(<em>s</em>â€²,<em>a</em>â€²)ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>å½“æˆ‘ä»¬æ›´æ–°ç¥ç»ç½‘ç»œçš„å‚æ•°æ—¶ï¼Œ<em>Q</em>(<em>s</em>â€²,<em>a</em>â€²) ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
<li>è¿™ç§å˜åŒ–ä¼šå¯¼è‡´ TD ç›®æ ‡ä¸æ–­æ”¹å˜ï¼Œä»è€Œä½¿å¾—è®­ç»ƒè¿‡ç¨‹å˜å¾—ä¸ç¨³å®šã€‚</li>
</ul>
</blockquote>
<p>è®­ç»ƒç½‘ç»œæ¯æ­¥æ›´æ–°ï¼Œç›®æ ‡ç½‘ç»œæ¯éš”Cæ­¥è¿›è¡Œä¸€æ¬¡æ›´æ–°ï¼›</p>
<p>ä½¿ç”¨ç›®æ ‡ç½‘ç»œè®¡ç®—æœ€ä¼˜åŠ¨ä½œä»·å€¼ï¼ˆæœ€ä¼˜åŠ¨ä½œé€‰å–ä½¿ç”¨ç›®æ ‡ç½‘ç»œï¼‰ï¼Œæœ€å°åŒ–æŸå¤±å‡½æ•°æ›´æ–°è®­ç»ƒç½‘ç»œï¼›</p>
<br>
<p><strong>Double DQN</strong></p>
<p>DQNåœ¨<strong>é€‰æ‹©å’Œè¯„ä¼°åŠ¨ä½œä½¿ç”¨çš„æ˜¯åŒä¸€å¥—ç¥ç»ç½‘ç»œ</strong>ï¼Œå¦‚æœç¥ç»ç½‘ç»œåœ¨ä¼°ç®—Qå€¼æ—¶å­˜åœ¨è¯¯å·®ï¼ˆå°¤å…¶æ˜¯æ­£å‘è¯¯å·®ï¼‰ï¼Œè¿™ç§è¯¯å·®ä¼šåœ¨é€‰æ‹©å’Œè¯„ä¼°åŠ¨ä½œçš„è¿‡ç¨‹ä¸­è¢«æ”¾å¤§ã€‚å…·ä½“æ¥è¯´ï¼š</p>
<ul>
<li>å½“ç¥ç»ç½‘ç»œé«˜ä¼°æŸä¸ªåŠ¨ä½œçš„Qå€¼æ—¶ï¼Œè¯¥åŠ¨ä½œæ›´å¯èƒ½è¢«é€‰ä¸ºæœ€ä¼˜åŠ¨ä½œã€‚</li>
<li>è¢«é€‰ä¸­çš„åŠ¨ä½œçš„Qå€¼åˆè¢«ç”¨äºè®¡ç®—ç›®æ ‡Qå€¼ï¼Œè¿›ä¸€æ­¥æ”¾å¤§äº†é«˜ä¼°çš„å½±å“ã€‚</li>
<li>è¿™ç§æ­£å‘è¯¯å·®ä¼šåœ¨æ›´æ–°è¿‡ç¨‹ä¸­é€æ­¥ç´¯ç§¯ï¼Œå¯¼è‡´Qå€¼ä¸¥é‡åç¦»çœŸå®å€¼ã€‚</li>
</ul>
<p>Double DQNé€šè¿‡ä¸¤å¥—ç‹¬ç«‹ç½‘ç»œåˆ†åˆ«é€‰æ‹©å’Œè¯„ä¼°åŠ¨ä½œï¼Œæœ‰æ•ˆé™ä½äº†è¿‡ä¼°è®¡é—®é¢˜ï¼Œä½¿ç›®æ ‡Qå€¼æ›´æ¥è¿‘çœŸå®å€¼ã€‚</p>
<p>è¿™ç§æ”¹è¿›åœ¨åŠ¨ä½œç©ºé—´è¾ƒå¤§çš„ä»»åŠ¡ä¸­å°¤ä¸ºé‡è¦ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç®—æ³•çš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250322111831741.png" class="" title="image-20250322111831741">
<br>
<h3 id="ç­–ç•¥æ¢¯åº¦ç®—æ³•-REINFORCE">ç­–ç•¥æ¢¯åº¦ç®—æ³•(REINFORCE)</h3>
<p>Policy-based + online</p>
<p>å®šä¹‰ç­–ç•¥å­¦ä¹ çš„ç›®æ ‡å‡½æ•°ä¸ºï¼Œs0ä¸ºåˆå§‹çŠ¶æ€</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612100629893.png" class="" title="image-20240612100629893">
<blockquote>
<p>æœŸæœ›æ˜¯å…³äº $s_0$ çš„æœŸæœ›ï¼Œè¿™æ„å‘³ç€ $s_0$ çš„åˆå§‹åŒ–å­˜åœ¨ç›¸åº”çš„åˆ†å¸ƒ</p>
</blockquote>
<p>ç›®æ ‡æ˜¯ä¿®æ”¹å‚æ•°Î¸ï¼Œä½¿J(Î¸)å–æœ€å¤§ï¼›å³å¯¹Î¸æ±‚å¯¼</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240610213003398.png" class="" title="image-20240610213003398">
<img src="/2024/06/10/reinforce-learning-record/image-20240612100732404.png" class="" title="image-20240612100732404">
<p>ä¸Šè¿°å…¬å¼è¿˜å¯ä»¥è¡¨ç¤ºä¸ºï¼š<br>
$$<br>
\nabla_{\theta} J(\theta) = \mathbb{E}<em>{s \sim \nu^{\pi</em>{\theta}}, a \sim \pi_{\theta}(\cdot | s)} \left[ A^{\pi_{\theta}}(s, a) \nabla_{\theta} \log \pi_{\theta}(a | s) \right]<br>
$$</p>
<br>
<p>å…¬å¼æ¨å¯¼ï¼š<br>
$$<br>
\begin{align*}<br>
\nabla_\theta V^{\pi_\theta} (s) &amp;= \nabla_\theta \left(\sum_{a \in A} \pi_\theta (a|s) Q^{\pi_\theta} (s, a)\right) \<br>
&amp;= \sum_{a \in A} \left(\nabla_\theta \pi_\theta (a|s) Q^{\pi_\theta} (s, a) + \pi_\theta (a|s) \nabla_\theta Q^{\pi_\theta} (s, a)\right) \<br>
&amp;= \sum_{a \in A} \left(\nabla_\theta \pi_\theta (a|s) Q^{\pi_\theta} (s, a) + \pi_\theta (a|s) \nabla_\theta \sum_{sâ€™,r} p(sâ€™,r|s,a) (r + \gamma V^{\pi_\theta} (sâ€™))\right) \<br>
&amp;= \sum_{a \in A} \left(\nabla_\theta \pi_\theta (a|s) Q^{\pi_\theta} (s, a) + \gamma \pi_\theta (a|s) \sum_{sâ€™,r} p(sâ€™,r|s,a) \nabla_\theta V^{\pi_\theta} (sâ€™)\right) \<br>
&amp;= \sum_{a \in A} \left(\nabla_\theta \pi_\theta (a|s) Q^{\pi_\theta} (s, a) + \gamma \pi_\theta (a|s) \sum_{sâ€™} p(sâ€™|s,a) \nabla_\theta V^{\pi_\theta} (sâ€™)\right)<br>
\end{align*}<br>
$$<br>
3è¡Œ -&gt; 4è¡Œï¼šç¬¬äºŒé¡¹çš„ç¬¬ä¸€é¡¹rewardä¸ç­–ç•¥å‚æ•°æ— å…³ï¼Œçº¦å»ï¼›</p>
<p>ä¸ºäº†ç®€åŒ–è¡¨ç¤ºï¼Œæˆ‘ä»¬è®© $\phi(s) = \sum_{a\in A} \nabla_{\theta}\pi_{\theta}(a|s)Q^{\pi\theta}(s,a)$ï¼Œå®šä¹‰ $d^{\pi\theta}(s \to x, k)$ ä¸º ç­–ç•¥ $\pi$ ä»çŠ¶æ€ $s$ å‡ºå‘ $k$ æ­¥ååˆ°è¾¾çŠ¶æ€ $x$ çš„æ¦‚ç‡ã€‚æˆ‘ä»¬ç»§ç»­æ¨å¯¼ï¼š<br>
$$<br>
\begin{align*}<br>
\nabla_\theta V^{\pi_\theta}(s) &amp;= \phi(s) + \gamma \sum_a \pi_\theta(a|s) \sum_{sâ€™} P(sâ€™|s,a) \nabla_\theta V^{\pi_\theta}(sâ€™) \<br>
&amp;= \phi(s) + \gamma \sum_a \sum_{sâ€™} \pi_\theta(a|s) P(sâ€™|s,a) \nabla_\theta V^{\pi_\theta}(sâ€™) \<br>
&amp;= \phi(s) + \gamma \sum_{sâ€™} d^{\pi_\theta}(s \to sâ€™, 1) \nabla_\theta V^{\pi_\theta}(sâ€™) \<br>
&amp;= \phi(s) + \gamma \sum_{sâ€™} d^{\pi_\theta}(s \to sâ€™, 1) \left[\phi(sâ€™) + \gamma \sum_{sâ€™â€˜} d^{\pi_\theta}(sâ€™ \to sâ€™â€˜, 1) \nabla_\theta V^{\pi_\theta}(sâ€™â€˜)\right] \<br>
&amp;= \phi(s) + \gamma \sum_{sâ€™} d^{\pi_\theta}(s \to sâ€™, 1) \phi(sâ€™) + \gamma^2 \sum_{sâ€™â€˜} d^{\pi_\theta}(s \to sâ€™â€˜, 2) \nabla_\theta V^{\pi_\theta}(sâ€™â€˜) \<br>
&amp;= \phi(s) + \gamma \sum_{sâ€™} d^{\pi_\theta}(s \to sâ€™, 1) \phi(sâ€™) + \gamma^2 \sum_{sâ€™â€˜} d^{\pi_\theta}(s \to sâ€™â€˜, 2) \phi(sâ€™â€˜) \<br>
&amp;\quad + \gamma^3 \sum_{sâ€™â€˜â€™} d^{\pi_\theta}(s \to sâ€™â€˜â€™, 3) \nabla_\theta V^{\pi_\theta}(sâ€™â€˜â€™) \<br>
&amp;= \cdots \<br>
&amp;= \sum_{x \in S} \sum_{k=0}^\infty \gamma^k d^{\pi_\theta}(s \to x, k) \phi(x)<br>
\end{align*}<br>
$$<br>
3è¡Œ -&gt; 4è¡Œï¼šå¯¹è´å°”æ›¼æœŸæœ›æ–¹ç¨‹ $V^Ï€(s) = Î£_{aâˆˆA} Ï€(a|s) (r(s, a) + Î³ Î£_{sâ€™âˆˆS} p(sâ€™|s, a)V^Ï€(sâ€™))$ æ±‚å¯¼å¾—åˆ°ï¼ˆå…¶å®å°±æ˜¯ç¬¬ä¸€æ­¥çš„å¥—å¨ƒ</p>
<p>å®šä¹‰ $\eta(s) = \mathbb{E}<em>{s_0}[\sum</em>{k=0}^{\infty} \gamma^k d^{\pi_\theta}(s_0 \to s, k)]$ï¼Œå®ƒä»£è¡¨ä»åˆå§‹çŠ¶æ€ $s_0$å‡ºå‘ï¼Œåœ¨ç­–ç•¥ $\pi_{\theta}$ ä¸‹ï¼Œæœªæ¥èƒ½å¤Ÿè®¿é—®åˆ°çŠ¶æ€ $s$ çš„è¡°å‡é¢‘ç‡ï¼Œ</p>
<p>è‡³æ­¤ï¼Œå›åˆ°ç›®æ ‡å‡½æ•°ï¼š<br>
$$<br>
\begin{align*}<br>
\nabla_\theta J(\theta) &amp;= \nabla_\theta \mathbb{E}<em>{s_0}[V^{\pi</em>\theta}(s_0)] \<br>
&amp;= \sum_s \mathbb{E}<em>{s_0}\left[\sum</em>{k=0}^{\infty} \gamma^k d^{\pi_\theta}(s_0 \to s, k)\right]\phi(s) \<br>
&amp;= \sum_s \eta(s)\phi(s) \<br>
&amp;= \left(\sum_s \eta(s)\right)\sum_s \frac{\eta(s)}{\sum_s \eta(s)}\phi(s) \<br>
&amp;\propto \sum_s \frac{\eta(s)}{\sum_s \eta(s)}\phi(s) \<br>
&amp;= \sum_s \nu^{\pi_\theta}(s)\sum_a Q^{\pi_\theta}(s, a)\nabla_\theta \pi_\theta(a|s)<br>
\end{align*}<br>
$$</p>
<p>ç¬¬4è¡Œ -&gt; ç¬¬5è¡Œ</p>
<p>$\eta(s)$ æ˜¾ç„¶å¤§äºç­‰äº 0ï¼Œ$\sum_s \eta(s)$ æ˜¯ä¸€ä¸ªæ­£æ ‡é‡ï¼Œç”±äºå°†æ¢¯åº¦ä¹˜ä»¥ä¸€ä¸ªæ­£æ ‡é‡ä¸ä¼šæ”¹å˜æ¢¯åº¦çš„æ–¹å‘ï¼Œå› æ­¤ï¼Œå¯¹äºæ¢¯åº¦ä¸Šå‡ç®—æ³•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥æ‰è¿™ä¸ªæ­£çš„æ ‡é‡å› å­</p>
<br>
<p>ç›®æ ‡ï¼šæœ€å¤§åŒ–å‡½æ•°J(Î¸)</p>
<p>ç®—æ³•</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240611200059062.png" class="" title="image-20240611200059062">
<p>æ—¶åˆ»tå‘åçš„å›æŠ¥å³ä¸º(åŠ¨ä½œ)ä»·å€¼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">reward_list = transition_dict[<span class="string">&#x27;rewards&#x27;</span>]</span><br><span class="line">state_list = transition_dict[<span class="string">&#x27;states&#x27;</span>]</span><br><span class="line">action_list = transition_dict[<span class="string">&#x27;actions&#x27;</span>]</span><br><span class="line"></span><br><span class="line">G = <span class="number">0</span></span><br><span class="line">self.optimizer.zero_grad()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(reward_list))):  <span class="comment"># ä»æœ€åä¸€æ­¥ç®—èµ·</span></span><br><span class="line">    reward = reward_list[i]  <span class="comment"># å–æ—¶é—´æ­¥iè·å¾—çš„å¥–åŠ±</span></span><br><span class="line">    state = torch.tensor([state_list[i]],</span><br><span class="line">                         dtype=torch.<span class="built_in">float</span>).to(self.device)  <span class="comment"># å–æ—¶é—´æ­¥içš„çŠ¶æ€</span></span><br><span class="line">    action = torch.tensor([action_list[i]]).view(-<span class="number">1</span>, <span class="number">1</span>).to(self.device)  <span class="comment"># å–æ—¶é—´æ­¥içš„åŠ¨ä½œ</span></span><br><span class="line">    log_prob = torch.log(self.policy_net(state).gather(<span class="number">1</span>, action))</span><br><span class="line">    <span class="comment"># self.policy_net(state)ï¼š å°†çŠ¶æ€è¾“å…¥ç­–ç•¥ç½‘ç»œï¼Œå¾—åˆ°æ‰€æœ‰å¯èƒ½åŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒã€‚</span></span><br><span class="line">	<span class="comment"># .gather(1, action): ä»æ¦‚ç‡åˆ†å¸ƒä¸­é€‰å–å®é™…æ‰§è¡ŒåŠ¨ä½œå¯¹åº”çš„æ¦‚ç‡å€¼ã€‚</span></span><br><span class="line">	<span class="comment"># torch.log(...): å¯¹é€‰å–çš„æ¦‚ç‡å€¼å–å¯¹æ•°ï¼Œå¾—åˆ°å¯¹æ•°æ¦‚ç‡</span></span><br><span class="line">    G = self.gamma * G + reward  <span class="comment"># Gç´¯è®¡äº†ä»å½“å‰æ—¶é—´æ­¥iåˆ°episodeç»“æŸçš„æ‰€æœ‰å¥–åŠ±</span></span><br><span class="line">    loss = -log_prob * G  <span class="comment"># losså¯¹åº”å…¬å¼ä¸­ç¬¦å·Î±åçš„éƒ¨åˆ†</span></span><br><span class="line">    loss.backward()  <span class="comment"># åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">self.optimizer.step()  <span class="comment"># æ¢¯åº¦ä¸‹é™ï¼Œå®é™…ä¸Šæ˜¯å¯¹ç­–ç•¥è¿›è¡Œæ±‚å¯¼</span></span><br></pre></td></tr></table></figure>
<br>
<h3 id="Actor-Critic">Actor-Critic</h3>
<p>(Value + Policy)-based + offline</p>
<p><strong>Actoré‡‡ç”¨ç­–ç•¥è¿­ä»£ç®—æ³•æ›´æ–°ï¼ŒCriticé‡‡ç”¨ä»·å€¼(çŠ¶æ€ä»·å€¼)è¿­ä»£ç®—æ³•æ›´æ–°</strong>ï¼ŒActorçš„æ›´æ–°ä¾èµ–äºäºCriticè®¡ç®—çš„ä¼˜åŠ¿å‡½æ•°ï¼›</p>
<p>ç­–ç•¥å‡½æ•°æ¢¯åº¦</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612110026419.png" class="" title="image-20240612110026419">
<p>å…¶ä¸­ï¼ŒÏˆ_t å¯ä¸ºä¸åŒå€¼ï¼Œè¡¨ç¤ºä¸åŒçš„æ–¹æ³•</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612110241521.png" class="" title="image-20240612110241521">
<blockquote>
<p>æ³¨æ„ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œåœ¨æ”¶æ•›æ¨¡å‹ä¸Šä¸Šè¿°6ç§æ–¹æ³•å¾—åˆ°çš„å€¼æ˜¯ä¸€è‡´çš„ï¼Œè¿™å…­ç§æ–¹æ³•éƒ½æ˜¯åŸºäºç­–ç•¥æ¢¯åº¦å®šç†ï¼ˆPolicy Gradient Theoremï¼‰çš„ä¸åŒå®ç°å½¢å¼</p>
</blockquote>
<p>ä»·å€¼å‡½æ•°çš„æŸå¤±å‡½æ•°ä¸æ¢¯åº¦</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612110951796.png" class="" title="image-20240612110951796">
<img src="/2024/06/10/reinforce-learning-record/image-20240612111022161.png" class="" title="image-20240612111022161">
<p>ActoråŸºäºç­–ç•¥å‡½æ•°ï¼Œä½¿ç”¨ä¸Šå›¾ä¸­çš„ç¬¬6ç§çš„ <code>td_delta</code> ä½œä¸ºåŠ¨ä½œä»·å€¼ï¼Œä½¿ç”¨Criticçš„ä»·å€¼å‡½æ•°å¾—åˆ°åŠ¨ä½œä»·å€¼çš„å€¼ï¼›</p>
<p>CriticåŸºäºä»·å€¼å‡½æ•°ï¼Œç”¨äºæœ€å°åŒ–å½“å‰çŠ¶æ€çš„ä»·å€¼ä¼°è®¡ä¸æ—¶åºå·®åˆ†ç›®æ ‡ä¹‹é—´çš„å·®å¼‚ï¼Œåå‘ä¼ æ’­æ—¶å¯¹ <code>td_delta</code> åšäº† <code>.detach()</code></p>
<br>
<p>åŸºäº<strong>æ—¶åºå·®åˆ†(TD)<strong>æ–¹æ³•çš„</strong>Actor-Critic</strong>ç®—æ³•</p>
<img src="/2024/06/10/reinforce-learning-record/image-20240612110750284.png" class="" title="image-20240612110750284">
<p>ä»·å€¼ç½‘ç»œä½¿ç”¨æ—¶åºå·®åˆ†(TD)æ›´æ–°ï¼Œç­–ç•¥ç½‘ç»œä½¿ç”¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">states = torch.tensor(transition_dict[<span class="string">&#x27;states&#x27;</span>],</span><br><span class="line">                              dtype=torch.<span class="built_in">float</span>).to(self.device)</span><br><span class="line">actions = torch.tensor(transition_dict[<span class="string">&#x27;actions&#x27;</span>]).view(-<span class="number">1</span>, <span class="number">1</span>).to(</span><br><span class="line">            self.device)</span><br><span class="line">rewards = torch.tensor(transition_dict[<span class="string">&#x27;rewards&#x27;</span>],</span><br><span class="line">                               dtype=torch.<span class="built_in">float</span>).view(-<span class="number">1</span>, <span class="number">1</span>).to(self.device)</span><br><span class="line">next_states = torch.tensor(transition_dict[<span class="string">&#x27;next_states&#x27;</span>],</span><br><span class="line">                                   dtype=torch.<span class="built_in">float</span>).to(self.device)</span><br><span class="line">dones = torch.tensor(transition_dict[<span class="string">&#x27;dones&#x27;</span>],</span><br><span class="line">                             dtype=torch.<span class="built_in">float</span>).view(-<span class="number">1</span>, <span class="number">1</span>).to(self.device)</span><br><span class="line"><span class="comment"># å½“å‰çŠ¶æ€ï¼ŒåŠ¨ä½œã€å¥–åŠ±ã€ä¸‹ä¸€ä¸ªçŠ¶æ€å’Œç»“æŸæ ‡å¿—</span></span><br><span class="line"></span><br><span class="line">td_target = rewards + self.gamma * self.critic(next_states) * (<span class="number">1</span> - dones)</span><br><span class="line"><span class="comment"># ä»·å€¼ç½‘ç»œ(critic)</span></span><br><span class="line"><span class="comment"># self.critic(next_states) ä½¿ç”¨ä»·å€¼ç½‘ç»œ(critic)é¢„æµ‹ä¸‹ä¸€ä¸ªçŠ¶æ€çš„ä»·å€¼ã€‚</span></span><br><span class="line"><span class="comment"># (1 - dones) ç”¨äºå¤„ç† episode ç»“æŸçš„æƒ…å†µï¼Œå¦‚æœ dones ä¸º 1 (True)ï¼Œåˆ™è¡¨ç¤º episode ç»“æŸï¼Œæ­¤æ—¶ä¸éœ€è¦è€ƒè™‘æœªæ¥çš„å¥–åŠ±ã€‚</span></span><br><span class="line">td_delta = td_target - self.critic(states)  </span><br><span class="line"><span class="comment"># è®¡ç®—æ—¶åºå·®åˆ†è¯¯å·®ï¼Œå³ç›®æ ‡å€¼ä¸å½“å‰çŠ¶æ€ä»·å€¼çš„å·®ã€‚</span></span><br><span class="line"></span><br><span class="line">log_probs = torch.log(self.actor(states).gather(<span class="number">1</span>, actions))</span><br><span class="line"><span class="comment"># ç­–ç•¥ç½‘ç»œ(actor)</span></span><br><span class="line"><span class="comment"># self.actor(states) ä½¿ç”¨ç­–ç•¥ç½‘ç»œé¢„æµ‹æ¯ä¸ªåŠ¨ä½œçš„æ¦‚ç‡ã€‚</span></span><br><span class="line"><span class="comment"># .gather(1, actions) ä»é¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒä¸­é€‰æ‹©å®é™…é‡‡å–çš„åŠ¨ä½œå¯¹åº”çš„æ¦‚ç‡ã€‚torch.log è®¡ç®—å¯¹æ•°æ¦‚ç‡ã€‚</span></span><br><span class="line"></span><br><span class="line">critic_loss = torch.mean(</span><br><span class="line">	F.mse_loss(self.critic(states), td_target.detach()))</span><br><span class="line"><span class="comment"># è®¡ç®—ä»·å€¼ç½‘ç»œçš„æŸå¤±å‡½æ•°ã€‚(ä»·å€¼ç½‘ç»œç»™å‡ºçš„å½“å‰çŠ¶æ€ä»·å€¼)å’Œ(r+ä»·å€¼ç½‘ç»œç»™å‡ºçš„ä¸‹ä¸€çŠ¶æ€çš„çŠ¶æ€ä»·å€¼)çš„å‡æ–¹è¯¯å·®ï¼Œå³((a-b)^2)/2</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ td_target.detach() é˜»æ­¢æ¢¯åº¦é€šè¿‡ td_target å‘ç­–ç•¥ç½‘ç»œå›ä¼ ã€‚</span></span><br><span class="line">actor_loss = torch.mean(-log_probs * td_delta.detach())</span><br><span class="line"><span class="comment"># è®¡ç®—ç­–ç•¥ç½‘ç»œçš„æŸå¤±å‡½æ•°ã€‚ç­–ç•¥å‡½æ•°æ¢¯åº¦</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ td_delta.detach() é˜»æ­¢æ¢¯åº¦é€šè¿‡ td_delta å‘ä»·å€¼ç½‘ç»œå›ä¼ ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">self.actor_optimizer.zero_grad()</span><br><span class="line">self.critic_optimizer.zero_grad()</span><br><span class="line">actor_loss.backward()  <span class="comment"># è®¡ç®—ç­–ç•¥ç½‘ç»œçš„æ¢¯åº¦</span></span><br><span class="line">critic_loss.backward()  <span class="comment"># è®¡ç®—ä»·å€¼ç½‘ç»œçš„æ¢¯åº¦</span></span><br><span class="line">self.actor_optimizer.step()  <span class="comment"># æ›´æ–°ç­–ç•¥ç½‘ç»œçš„å‚æ•°</span></span><br><span class="line">self.critic_optimizer.step()  <span class="comment"># æ›´æ–°ä»·å€¼ç½‘ç»œçš„å‚æ•°</span></span><br></pre></td></tr></table></figure>
<br>
<h3 id="TRPO">TRPO</h3>
<p>åœ¨TRPOä¸­ï¼Œä¼˜åŒ–ç›®æ ‡ä¸ºæœ€å¤§åŒ– æ–°ç­–ç•¥ä¸æ—§ç­–ç•¥çš„ä»·å€¼å·® $J(Î¸â€™)- J(Î¸) $ ï¼Œé€šè¿‡è¿‘ä¼¼æ–¹æ³•ï¼ˆç›¸ä¼¼ç­–ç•¥ä¸‹çŠ¶æ€åˆ†å¸ƒå‡½æ•°ä¸å˜å‡è®¾ä¸<strong>é‡è¦æ€§é‡‡æ ·</strong>ï¼‰å°†åŸç›®æ ‡  $J(Î¸â€™)- J(Î¸) $  è¿‘ä¼¼ä¸ºä¸‹å›¾ï¼Œä¸”æ»¡è¶³<strong>KLæ•£åº¦</strong>çº¦æŸï¼ˆ<strong>çº¦æŸ</strong>ç­–ç•¥ä¸ºç›¸ä¼¼ç­–ç•¥ï¼‰</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250324141848364.png" class="" title="image-20250324141848364">
<h4 id="æ•´ä½“æµç¨‹">æ•´ä½“æµç¨‹</h4>
<p><strong>ç­–ç•¥æ€§èƒ½å·®å¼‚ (Policy Performance Difference)</strong></p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ªæ–°ç­–ç•¥ $Ï€_Î¸â€™$ï¼Œä½¿å…¶æ€§èƒ½  $J(Î¸â€™)$ ä¼˜äºæˆ–ç­‰äºå½“å‰ç­–ç•¥ $Ï€_Î¸$ çš„æ€§èƒ½ $J(Î¸)$ã€‚ç­–ç•¥æ€§èƒ½çš„å·®å¼‚å¯ä»¥è¢«ç²¾ç¡®åœ°è¡¨ç¤ºä¸ºä¸ä¼˜åŠ¿å‡½æ•° $A$ ç›¸å…³çš„æœŸæœ›ï¼š</p>
<p>$$<br>
J(\thetaâ€™) - J(\theta) = \mathbb{E}<em>{s_0, a_0, â€¦ \sim \pi</em>{\thetaâ€™}} \left[ \sum_{t=0}^{\infty} \gamma^t A^{\pi_{\theta}}(s_t, a_t) \right]<br>
$$</p>
<p>å…¶ä¸­ï¼Œ$A^{\pi_{\theta}}(s, a) = Q^{\pi_{\theta}}(s, a) - V^{\pi_{\theta}}(s)$ æ˜¯æ—§ç­–ç•¥ $Ï€_Î¸$ çš„ä¼˜åŠ¿å‡½æ•°ã€‚è¿™ä¸ªç­‰å¼æ˜¯ç­–ç•¥æ¢¯åº¦ç†è®ºä¸­çš„ä¸€ä¸ªåŸºæœ¬æ’ç­‰å¼ã€‚å®ƒè¡¨æ˜ï¼Œ<strong>æ–°ç­–ç•¥å¸¦æ¥çš„æ€§èƒ½æå‡ï¼Œç­‰äºåœ¨æ–°ç­–ç•¥çš„è½¨è¿¹ä¸Šï¼Œç´¯ç§¯æ—§ç­–ç•¥ä¼˜åŠ¿å‡½æ•°çš„æœŸæœ›</strong>ã€‚</p>
<blockquote>
<p>$$<br>
\begin{aligned}<br>
J(\theta) &amp;= \mathbb{E}<em>{\tau \sim \pi</em>{\theta}} \left[ \sum_{t=0}^{\infty} \gamma^t r_t \right] \<br>
&amp;= \mathbb{E}<em>{s_0 \sim \rho_0} \left[ \mathbb{E}</em>{\tau \sim \pi_{\theta} | s_0} \left[ \sum_{t=0}^{\infty} \gamma^t r_t \right] \right] \quad \text{(æ ¹æ®å…¨æœŸæœ›å®šå¾‹åˆ†è§£)} \<br>
&amp;= \mathbb{E}<em>{s_0 \sim \rho_0} \left[ V^{\pi</em>{\theta}}(s_0) \right] \quad \text{(æ ¹æ® } V^{\pi} \text{ çš„å®šä¹‰)}<br>
\end{aligned}<br>
$$<br>
$$<br>
\nabla_{\theta} J(\theta) = \mathbb{E}<em>{s \sim \nu^{\pi</em>{\theta}}, a \sim \pi_{\theta}(\cdot | s)} \left[ A^{\pi_{\theta}}(s, a) \nabla_{\theta} \log \pi_{\theta}(a | s) \right]<br>
$$</p>
</blockquote>
<p><strong>å¼•å…¥çŠ¶æ€è®¿é—®åˆ†å¸ƒ (State-Visitation Distribution)</strong></p>
<p>ä¸Šè¿°å…¬å¼ä¸­çš„æœŸæœ›æ˜¯åŸºäºæ–°ç­–ç•¥ $Ï€_Î¸â€™$ çš„è½¨è¿¹é‡‡æ ·çš„ï¼Œè¿™åœ¨ä¼˜åŒ–æ—¶éå¸¸ä¸ä¾¿ï¼Œå› ä¸º $Î¸â€™$ æ˜¯æˆ‘ä»¬æ­£åœ¨æ±‚è§£çš„å˜é‡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†æœŸæœ›æ‹†è§£ï¼Œå¹¶å¼•å…¥çŠ¶æ€è®¿é—®åˆ†å¸ƒ $Î½^{\pi_{\thetaâ€™}}(s)$ï¼š</p>
<p>$$<br>
J(\thetaâ€™) - J(\theta) = \sum_{s} \nu^{\pi_{\thetaâ€™}}(s) \sum_{a} \pi_{\thetaâ€™}(a|s) A^{\pi_{\theta}}(s, a)<br>
$$</p>
<p>å…¶ä¸­ $\nu^{\pi_{\thetaâ€™}}(s) = \sum_{t=0}^\infty \gamma^t P(s_t=s | \pi_{\thetaâ€™})$ æ˜¯æ–°ç­–ç•¥ä¸‹çš„æŠ˜æ‰£çŠ¶æ€è®¿é—®é¢‘ç‡ã€‚è¿™ä¸ªå…¬å¼ä»ç„¶ä¾èµ–äºæ–°ç­–ç•¥çš„è®¿é—®åˆ†å¸ƒ $Î½^{\pi_{\thetaâ€™}}$ï¼Œé—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚</p>
<p><strong>æ„é€ ä»£ç†ç›®æ ‡å‡½æ•° (Surrogate Objective)</strong></p>
<p>ç”±äº $Î½^{\pi_{\thetaâ€™}}$ ä¾èµ–äº $Î¸â€™$ï¼Œå¯¼è‡´ç›®æ ‡å‡½æ•°éš¾ä»¥ä¼˜åŒ–ã€‚TRPOæå‡ºï¼Œå¦‚æœæ–°æ—§ç­–ç•¥è¶³å¤Ÿæ¥è¿‘ï¼Œé‚£ä¹ˆå®ƒä»¬çš„çŠ¶æ€è®¿é—®åˆ†å¸ƒä¹Ÿåº”è¯¥å¾ˆç›¸ä¼¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ—§ç­–ç•¥çš„çŠ¶æ€è®¿é—®åˆ†å¸ƒ $Î½^{\pi_{\theta}}(s)$ æ¥è¿‘ä¼¼ $Î½^{\pi_{\thetaâ€™}}(s)$ã€‚</p>
<p>åŸºäºè¿™ä¸ªè¿‘ä¼¼ï¼Œæˆ‘ä»¬æ„é€ ä¸€ä¸ª<strong>ä»£ç†ç›®æ ‡å‡½æ•° (Surrogate Objective)</strong> $L_{\theta}(\thetaâ€™)$ï¼š</p>
<p>$$<br>
L_{\theta}(\thetaâ€™) = \sum_{s} \nu^{\pi_{\theta}}(s) \sum_{a} \pi_{\thetaâ€™}(a|s) A^{\pi_{\theta}}(s, a)<br>
$$</p>
<p>è¿™ä¸ªä»£ç†ç›®æ ‡å‡½æ•° $L_{\theta}(\thetaâ€™)$ æœ‰ä¸¤ä¸ªå¾ˆå¥½çš„æ€§è´¨ï¼š</p>
<ol>
<li>$L_{\theta}(\theta) = 0$ã€‚</li>
<li>$\nabla_{\thetaâ€™} L_{\theta}(\thetaâ€™)|<em>{\thetaâ€™=\theta} = \nabla</em>{\thetaâ€™} J(\thetaâ€™)|_{\thetaâ€™=\theta}$ã€‚<br>
è¿™æ„å‘³ç€ $L$ åœ¨ $Î¸â€™ = Î¸$ å¤„çš„æ¢¯åº¦å’ŒçœŸå®ç›®æ ‡ $J$ çš„æ¢¯åº¦å®Œå…¨ä¸€æ ·ï¼Œä¼˜åŒ– $L$ çš„åˆå§‹æ–¹å‘æ˜¯æ­£ç¡®çš„ã€‚</li>
</ol>
<p><strong>åº”ç”¨é‡è¦æ€§é‡‡æ · (Importance Sampling)</strong></p>
<p>ä»£ç†ç›®æ ‡ $L_{\theta}(\thetaâ€™)$ ä»ç„¶éœ€è¦åœ¨æ¯ä¸ªçŠ¶æ€ $s$ ä¸‹ï¼Œæ ¹æ®æ–°ç­–ç•¥ $Ï€_{\thetaâ€™}$ é‡‡æ ·åŠ¨ä½œ $a$ã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨å®Œå…¨ä½¿ç”¨æ—§ç­–ç•¥ $Ï€_{\theta}$ äº§ç”Ÿçš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—ï¼Œæˆ‘ä»¬å¼•å…¥<strong>é‡è¦æ€§é‡‡æ · (Importance Sampling)</strong>ï¼š</p>
<p>$$<br>
\sum_{a} \pi_{\thetaâ€™}(a|s) A^{\pi_{\theta}}(s, a) = \mathbb{E}<em>{a \sim \pi</em>{\thetaâ€™}}[A^{\pi_{\theta}}(s, a)] = \mathbb{E}<em>{a \sim \pi</em>{\theta}} \left[ \frac{\pi_{\thetaâ€™}(a|s)}{\pi_{\theta}(a|s)} A^{\pi_{\theta}}(s, a) \right]<br>
$$</p>
<p>å°†æ­¤å¼å¸¦å…¥ $L_{\theta}(\thetaâ€™)$ï¼Œæˆ‘ä»¬å¾—åˆ°æœ€ç»ˆå¯ä»¥ç”¨æ ·æœ¬æ¥ä¼°è®¡çš„ä»£ç†ç›®æ ‡ï¼š</p>
<p>$$<br>
L_{\theta}(\thetaâ€™) = \mathbb{E}<em>{s \sim \nu^{\pi</em>{\theta}}, a \sim \pi_{\theta}} \left[ \frac{\pi_{\thetaâ€™}(a|s)}{\pi_{\theta}(a|s)} A^{\pi_{\theta}}(s, a) \right]<br>
$$</p>
<p><strong>å¼•å…¥ä¿¡èµ–åŸŸçº¦æŸ (Trust Region Constraint)</strong></p>
<p>ç›´æ¥æœ€å¤§åŒ– $L_{\theta}(\thetaâ€™)$ æ˜¯å±é™©çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ¨å¯¼åŸºäºä¸€ä¸ªæ ¸å¿ƒå‡è®¾ï¼š$Ï€_{\thetaâ€™}$ ä¸ $Ï€_{\theta}$ è¶³å¤Ÿæ¥è¿‘ã€‚å¦‚æœä¸€æ¬¡æ›´æ–°æ­¥é•¿å¤ªå¤§ï¼Œå¯¼è‡´ $Ï€_{\thetaâ€™}$ åç¦» $Ï€_{\theta}$ å¤ªè¿œï¼Œé‚£ä¹ˆ $Î½^{\pi_{\thetaâ€™}} \approx \nu^{\pi_{\theta}}$ çš„è¿‘ä¼¼å°±ä¼šå¤±æ•ˆï¼Œ$L$ çš„æå‡å°†ä¸å†ä¿è¯ $J$ çš„æå‡ï¼Œå¯èƒ½å¯¼è‡´ç­–ç•¥å´©æºƒã€‚</p>
<p>ä¸ºäº†ç¡®ä¿è¿™ä¸ªè¿‘ä¼¼çš„æœ‰æ•ˆæ€§ï¼ŒTRPOå¼•å…¥äº†ä¸€ä¸ª<strong>ä¿¡èµ–åŸŸ (Trust Region)</strong>ï¼Œé€šè¿‡çº¦æŸæ–°æ—§ç­–ç•¥çš„**KLæ•£åº¦ (KL Divergence)**æ¥é™åˆ¶ç­–ç•¥æ›´æ–°çš„å¹…åº¦ã€‚</p>
<p>$$<br>
\mathbb{E}<em>{s \sim \nu^{\pi</em>{\theta}}} \left[ D_{KL}(\pi_{\theta}(\cdot|s) || \pi_{\thetaâ€™}(\cdot|s)) \right] \leq \delta<br>
$$</p>
<p>å…¶ä¸­ $\delta$ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œä»£è¡¨äº†æˆ‘ä»¬ä¿¡ä»»è¯¥è¿‘ä¼¼çš„â€œåŠå¾„â€ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼ŒTRPOçš„æ¯ä¸€æ­¥æ›´æ–°å®é™…ä¸Šæ˜¯åœ¨æ±‚è§£ä¸€ä¸ªå¸¦çº¦æŸçš„ä¼˜åŒ–é—®é¢˜ï¼š</p>
<p>$$<br>
\begin{aligned}<br>
\text{maximize}<em>{\thetaâ€™} \quad &amp; L</em>{\theta}(\thetaâ€™) = \mathbb{E}<em>{s \sim \nu^{\pi</em>{\theta}}, a \sim \pi_{\theta}} \left[ \frac{\pi_{\thetaâ€™}(a|s)}{\pi_{\theta}(a|s)} A^{\pi_{\theta}}(s, a) \right] \<br>
\text{subject to} \quad &amp; \mathbb{E}<em>{s \sim \nu^{\pi</em>{\theta}}} \left[ D_{KL}(\pi_{\theta}(\cdot|s) || \pi_{\thetaâ€™}(\cdot|s)) \right] \leq \delta<br>
\end{aligned}<br>
$$</p>
<p>è¿™ä¸ªå…¬å¼å®Œæ•´åœ°æè¿°äº†TRPOçš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>åœ¨ç¡®ä¿æ–°ç­–ç•¥ä¸ä¼šä¸æ—§ç­–ç•¥åç¦»å¤ªè¿œï¼ˆä¿¡èµ–åŸŸçº¦æŸï¼‰çš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–ä¸€ä¸ªèƒ½å¤Ÿè¿‘ä¼¼çœŸå®æ€§èƒ½æå‡çš„ä»£ç†ç›®æ ‡å‡½æ•°</strong>ã€‚è¿™å°±æ˜¯TRPOèƒ½å¤Ÿå®ç°ç¨³å®šå•è°ƒç­–ç•¥æå‡çš„ç†è®ºä¿éšœã€‚</p>
<br>
<h4 id="è¿‘ä¼¼å¤„ç†">è¿‘ä¼¼å¤„ç†</h4>
<p>åœ¨ç­–ç•¥ä¼˜åŒ–ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°æ–°ç­–ç•¥ï¼Œä½¿å…¶æœŸæœ›å›æŠ¥æœ€å¤§åŒ–ã€‚ä½†æ˜¯ï¼Œç”±äºè®¡ç®—æ–°ç­–ç•¥çš„çŠ¶æ€éƒ¨åˆ†å›°éš¾ï¼Œæœ‰å¦‚ä¸‹å‡è®¾ï¼š</p>
<p>TRPOå‡è®¾ï¼š<strong>å½“æ–°æ—§ç­–ç•¥éå¸¸æ¥è¿‘æ—¶ï¼ŒçŠ¶æ€åˆ†å¸ƒçš„å˜åŒ–å¯ä»¥å¿½ç•¥</strong>ï¼Œå³<strong>æ–°ç­–ç•¥çš„çŠ¶æ€åˆ†å¸ƒå’Œæ—§ç­–ç•¥çš„çŠ¶æ€åˆ†å¸ƒä¸€è‡´</strong></p>
<blockquote>
<p>åˆç†æ€§ï¼šå¦‚æœç­–ç•¥æ›´æ–°æ­¥å¹…å¾ˆå°ï¼ˆé€šè¿‡åç»­çš„KLæ•£åº¦æˆ–ä¿¡ä»»åŸŸçº¦æŸï¼‰ï¼Œæ–°æ—§ç­–ç•¥ç”Ÿæˆçš„è½¨è¿¹ç›¸ä¼¼ï¼Œå› æ­¤çŠ¶æ€åˆ†å¸ƒçš„å·®å¼‚æ˜¯â€œé«˜é˜¶å°é‡â€ï¼Œå¯ä»¥è¢«å¿½ç•¥ã€‚è¿™ç±»ä¼¼äºæ³°å‹’å±•å¼€ä¸­çš„ä¸€é˜¶è¿‘ä¼¼ã€‚</p>
</blockquote>
<p>çŠ¶æ€åˆ†å¸ƒè¢«è¿‘ä¼¼ä¸ºæ—§ç­–ç•¥ï¼Œä½†æ˜¯åŠ¨ä½œé€‰æ‹©ä½¿ç”¨æ–°ç­–ç•¥ï¼Œä¸ºäº†å¤„ç†åŠ¨ä½œåˆ†å¸ƒçš„å·®å¼‚ï¼ŒTRPOä½¿ç”¨<strong>é‡è¦æ€§é‡‡æ ·</strong>ï¼ˆImportance Samplingï¼‰ï¼Œå³å›¾ä¸­çš„æ–°æ—§ç­–ç•¥æ¦‚ç‡æ¯”å€¼ï¼›</p>
<p>æœ€åï¼ŒçŠ¶æ€åˆ†å¸ƒä½¿ç”¨æ—§ç­–ç•¥çš„ï¼ŒåŠ¨ä½œé€‰æ‹©ä½¿ç”¨æ—§ç­–ç•¥çš„ï¼ŒåŠ æƒè®¡ç®—æ–°ç­–ç•¥çš„æ”¹è¿›é‡ã€‚</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250322151444000.png" class="" title="image-20250322151444000">
<img src="/2024/06/10/reinforce-learning-record/image-20250322151537751.png" class="" title="image-20250322151537751">
<blockquote>
<p>é‡è¦æ€§é‡‡æ ·æ˜¯ä»€ä¹ˆ?</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250611134637079.png" class="" title="image-20250611134637079">
</blockquote>
<br>
<h4 id="è¿‘ä¼¼çº¦æŸä¸æ±‚è§£">è¿‘ä¼¼çº¦æŸä¸æ±‚è§£</h4>
<p>ç”±äºè¿™é‡Œä½¿ç”¨äº†è¿‘ä¼¼ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥çº¦æŸï¼Œä½¿è¿‘ä¼¼å¯è¡Œã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯æ–°æ—§ç­–ç•¥è¶³å¤Ÿæ¥è¿‘ï¼ŒTRPO ä½¿ç”¨äº†<strong>åº“å°”è´å…‹-è±å¸ƒå‹’</strong>ï¼ˆKullback-Leiblerï¼ŒKLï¼‰æ•£åº¦æ¥è¡¡é‡ç­–ç•¥ä¹‹é—´çš„è·ç¦»ã€‚</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250322162045699.png" class="" title="image-20250322162045699">
<br>
<h4 id="å¹¿ä¹‰ä¼˜åŠ¿">å¹¿ä¹‰ä¼˜åŠ¿</h4>
<p>å¤šæ­¥æ—¶åºå·®åˆ†çš„æŒ‡æ•°åŠ æƒå¹³å‡</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250325154631583.png" class="" title="image-20250325154631583">
<blockquote>
<p>å¹¿ä¹‰ä¼˜åŠ¿æ˜¯å¹²å˜›çš„ï¼Ÿ</p>
<p>ä¼˜åŠ¿æ˜¯ä¼˜åŒ–ç›®æ ‡é‡Œçš„é‚£ä¸ª $A^{\pi_{\theta}}(s_{t}, a_{t})$ï¼Œå®šä¹‰æ˜¯ï¼š $A^{\pi_{\theta}}(s_t, a_t) = Q^{\pi_{\theta}}(s_t, a_t) - V^{\pi_{\theta}}(s_t) = \left( r(s,a) + \gamma E_{sâ€™ \sim P(\cdot|s,a)}[V^{\pi}(sâ€™)] \right) - V^{\pi}(s)$ï¼Œä¼˜åŠ¿å‡½æ•°å‘Šè¯‰æˆ‘ä»¬ï¼šåœ¨çŠ¶æ€ <code>s</code> ä¸‹ï¼Œé€‰æ‹©åŠ¨ä½œ <code>a</code> <strong>ç›¸æ¯”äºéµå¾ªå½“å‰ç­–ç•¥ <code>Ï€</code> çš„å¹³å‡è¡¨ç°</strong>ï¼Œæ˜¯æ›´å¥½è¿˜æ˜¯æ›´å·®ã€‚</p>
<p>å¹¿ä¹‰ä¼˜åŠ¿å…¶å®å°±æ˜¯å°†å•æ­¥ä¼˜åŠ¿å˜æˆäº†å¤šæ­¥ä¼˜åŠ¿ï¼Œä½¿å¾—ä¼˜åŠ¿æ›´åŠ å¹³å‡ï¼›</p>
<p>å•æ­¥TDè¯¯å·®ï¼ˆ$\lambda=0$ï¼‰ï¼šæ–¹å·®ç›¸å¯¹è¾ƒä½ï¼Œä½†å¦‚æœå€¼å‡½æ•°ä¼°è®¡ $V^{\pi_{\theta}}$ ä¸å‡†ï¼Œä¼šæœ‰è¾ƒé«˜çš„åå·®ã€‚<br>
è’™ç‰¹å¡æ´›ï¼ˆMCï¼‰ä¼˜åŠ¿ä¼°è®¡ï¼ˆç›¸å½“äºGAEä¸­ $\lambda=1$ï¼‰ï¼šä½¿ç”¨ä»å½“å‰æ—¶åˆ»åˆ°å›åˆç»“æŸçš„å®Œæ•´å›æŠ¥æ¥ä¼°è®¡ $Q^{\pi_{\theta}}(s_t, a_t)$ï¼Œç„¶åå‡å» $V^{\pi_{\theta}}(s_t)$ã€‚è¿™ç§æ–¹æ³•åå·®ä½ï¼ˆå› ä¸ºå®ƒä¸ä¾èµ–äºåç»­çš„å€¼å‡½æ•°ä¼°è®¡ï¼Œåªä¾èµ–äºå½“å‰çš„ $V^{\pi_{\theta}}(s_t)$ï¼‰ï¼Œä½†æ–¹å·®éå¸¸é«˜ï¼Œå› ä¸ºå®ƒç´¯ç§¯äº†å¤šä¸ªæ—¶é—´æ­¥çš„éšæœºæ€§ã€‚</p>
</blockquote>
<blockquote>
<p>Criticç½‘ç»œå’ŒActorç½‘ç»œåœ¨å“ªé‡Œï¼Ÿ</p>
<p><strong>å¹¿ä¹‰ä¼˜åŠ¿çš„è®¡ç®—ä¾èµ–äº Critic</strong>ï¼ŒCriticç½‘ç»œçš„æ ¸å¿ƒä»»åŠ¡æ˜¯å­¦ä¹ ä¸€ä¸ªå€¼å‡½æ•° <code>V(s)</code>ï¼Œç”¨äºè¯„ä¼°åœ¨æŸä¸ªçŠ¶æ€ <code>s</code> ä¸‹çš„æœŸæœ›ç´¯ç§¯å›æŠ¥ã€‚åœ¨GAEçš„è®¡ç®—ä¸­ï¼Œ<code>V(s_t)</code> å’Œ <code>V(s_&#123;t+1&#125;)</code> è¿™ä¸¤ä¸ªå…³é”®çš„ç»„æˆéƒ¨åˆ†<strong>ç›´æ¥ç”±Criticç½‘ç»œè¾“å‡º</strong>ã€‚å› æ­¤ï¼ŒGAEçš„å‡†ç¡®æ€§ç›´æ¥å—åˆ°Criticç½‘ç»œä¼°è®¡å‡†ç¡®æ€§çš„å½±å“ã€‚å¦‚æœCriticä¼°è®¡ä¸å‡†ï¼Œé‚£ä¹ˆè®¡ç®—å‡ºçš„GAEä¹Ÿä¼šä¸å‡†ç¡®ã€‚</p>
<ul>
<li><strong>Criticç½‘ç»œ</strong>ï¼šç›´æ¥å‚ä¸GAEçš„è®¡ç®—ï¼Œæä¾›çŠ¶æ€å€¼ <code>V(s)</code>ï¼Œæ˜¯è®¡ç®—TDè¯¯å·® <code>Î´_t</code> å’Œè¿›è€Œè®¡ç®— <code>A_t^GAE</code> çš„åŸºç¡€ã€‚</li>
<li><strong>Actorç½‘ç»œ</strong>ï¼š
<ul>
<li>ç”Ÿæˆç”¨äºè®¡ç®—GAEçš„ç»éªŒæ•°æ®ï¼ˆçŠ¶æ€ã€åŠ¨ä½œã€å¥–åŠ±ï¼‰ï¼ŒActorç½‘ç»œæ ¹æ®å½“å‰ç­–ç•¥ä¸ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œç”Ÿæˆä¸€ç³»åˆ—çš„è½¨è¿¹ (episodes)ï¼Œå³ <code>(s_0, a_0, r_0, s_1, a_1, r_1, ..., s_T, a_T, r_T)</code>ã€‚è¿™äº›æ”¶é›†åˆ°çš„çŠ¶æ€ <code>s_t</code>ã€<code>s_&#123;t+1&#125;</code> å’Œå¥–åŠ± <code>r_t</code> æ˜¯è®¡ç®—GAEæ‰€å¿…éœ€çš„åŸå§‹æ•°æ®ã€‚</li>
<li>æ˜¯GAEæœ€ç»ˆæœåŠ¡çš„å¯¹è±¡ã€‚GAEè®¡ç®—å‡ºæ¥åï¼Œç”¨äºæŒ‡å¯¼Actorç½‘ç»œå‚æ•°çš„æ›´æ–°ï¼Œä½¿å…¶å­¦ä¹ åˆ°æ›´å¥½çš„ç­–ç•¥ã€‚GAEè®¡ç®—å‡ºæ¥çš„ä¼˜åŠ¿ <code>A_t^GAE</code> ç”¨äºè¯„ä¼°åœ¨çŠ¶æ€ <code>s_t</code> ä¸‹é‡‡å–åŠ¨ä½œ <code>a_t</code> ç›¸å¯¹äºå¹³å‡åŠ¨ä½œçš„å¥½åç¨‹åº¦ã€‚è¿™ä¸ªä¼˜åŠ¿å€¼éšåè¢«ç”¨äºæ„å»ºTRPOçš„ç›®æ ‡å‡½æ•°ï¼ˆæˆ–å…¶æ›¿ä»£ç›®æ ‡å‡½æ•°ï¼‰çš„æ¢¯åº¦ï¼Œä»¥æ›´æ–°Actorç½‘ç»œçš„å‚æ•° <code>Î¸</code>ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
<br>
<h4 id="ç®—æ³•-2">ç®—æ³•</h4>
<img src="/2024/06/10/reinforce-learning-record/image-20250322211023368.png" class="" title="image-20250322211023368">
<br>
<h3 id="PPO-clip">PPO-clip</h3>
<p>åŸºäºACå’ŒTRPOçš„ï¼Œæ›¿æ¢<strong>KLæ•£åº¦çº¦æŸ</strong>å®ç°è¿‘ä¼¼ä¸º<strong>æƒ©ç½šä¼˜åŒ–/è£å‰ªç›®æ ‡ä¼˜åŒ–</strong>å®ç°è¿‘ä¼¼</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250325200037093.png" class="" title="image-20250325200037093">
<blockquote>
<p>è¯´ç™½äº†å°±æ˜¯æŠŠçº¦æŸå»æ‰å˜æˆæ— çº¦æŸé—®é¢˜ï¼Œæ›´åŠ æ˜“äºæ±‚è§£</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">states = torch.tensor(transition_dict[<span class="string">&#x27;states&#x27;</span>],</span><br><span class="line">                      dtype=torch.<span class="built_in">float</span>).to(self.device)</span><br><span class="line">actions = torch.tensor(transition_dict[<span class="string">&#x27;actions&#x27;</span>]).view(-<span class="number">1</span>, <span class="number">1</span>).to(</span><br><span class="line">    self.device)</span><br><span class="line">rewards = torch.tensor(transition_dict[<span class="string">&#x27;rewards&#x27;</span>],</span><br><span class="line">                       dtype=torch.<span class="built_in">float</span>).view(-<span class="number">1</span>, <span class="number">1</span>).to(self.device)</span><br><span class="line">next_states = torch.tensor(transition_dict[<span class="string">&#x27;next_states&#x27;</span>],</span><br><span class="line">                           dtype=torch.<span class="built_in">float</span>).to(self.device)</span><br><span class="line">dones = torch.tensor(transition_dict[<span class="string">&#x27;dones&#x27;</span>],</span><br><span class="line">                     dtype=torch.<span class="built_in">float</span>).view(-<span class="number">1</span>, <span class="number">1</span>).to(self.device)</span><br><span class="line">td_target = rewards + self.gamma * self.critic(next_states) * (<span class="number">1</span> -</span><br><span class="line">                                                               dones)</span><br><span class="line">td_delta = td_target - self.critic(states)</span><br><span class="line">advantage = rl_utils.compute_advantage(self.gamma, self.lmbda,</span><br><span class="line">                                       td_delta.cpu()).to(self.device)</span><br><span class="line">old_log_probs = torch.log(self.actor(states).gather(<span class="number">1</span>,</span><br><span class="line">                                                    actions)).detach()</span><br><span class="line"></span><br><span class="line"><span class="comment"># epochsä¸­å¯¹actorè¿›è¡Œè¿­ä»£</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(self.epochs):</span><br><span class="line">    log_probs = torch.log(self.actor(states).gather(<span class="number">1</span>, actions))</span><br><span class="line">    ratio = torch.exp(log_probs - old_log_probs)</span><br><span class="line">    surr1 = ratio * advantage</span><br><span class="line">    surr2 = torch.clamp(ratio, <span class="number">1</span> - self.eps,</span><br><span class="line">                        <span class="number">1</span> + self.eps) * advantage  <span class="comment"># æˆªæ–­</span></span><br><span class="line">    actor_loss = torch.mean(-torch.<span class="built_in">min</span>(surr1, surr2))  <span class="comment"># PPOæŸå¤±å‡½æ•°</span></span><br><span class="line">    critic_loss = torch.mean(</span><br><span class="line">        F.mse_loss(self.critic(states), td_target.detach()))</span><br><span class="line">    self.actor_optimizer.zero_grad()</span><br><span class="line">    self.critic_optimizer.zero_grad()</span><br><span class="line">    actor_loss.backward()</span><br><span class="line">    critic_loss.backward()</span><br><span class="line">    self.actor_optimizer.step()</span><br><span class="line">    self.critic_optimizer.step()</span><br></pre></td></tr></table></figure>
<br>
<h3 id="DDPG">DDPG</h3>
<p>ç¡®å®šæ€§ç­–ç•¥</p>
<img src="/2024/06/10/reinforce-learning-record/image-20250323105541258.png" class="" title="image-20250323105541258">
<p>4ä¸ªç½‘ç»œï¼Œä»·å€¼ç›®æ ‡+è®­ç»ƒç½‘ç»œï¼Œç­–ç•¥ç›®æ ‡+è®­ç»ƒç½‘ç»œ</p>
<p>åŠ¨ä½œé€‰æ‹©å¼•å…¥å™ªå£°</p>
<p>ä»·å€¼ç½‘ç»œæ›´æ–°ä½¿ç”¨ç±»ä¼¼äºDDQNçš„æ€è·¯æ›´æ–°ï¼Œæ®‹å·®è®¡ç®—æ—¶ä½¿ç”¨ç›®æ ‡ç½‘ç»œå€¼-è®­ç»ƒç½‘ç»œå€¼</p>
<p>ç­–ç•¥ç½‘ç»œä½¿ç”¨ï¼Ÿï¼ˆè¯æ˜å¥½å¤æ‚</p>
<p>ä»·å€¼ç›®æ ‡ç½‘ç»œå’Œç­–ç•¥ç›®æ ‡ç½‘ç»œä½¿ç”¨è½¯æ›´æ–°</p>
<h2 id="éƒ¨åˆ†å¿ƒå¾—">éƒ¨åˆ†å¿ƒå¾—</h2>
<h3 id="ACåˆ†ç¦»">ACåˆ†ç¦»</h3>
<p><strong>å…³äºDQNç®—æ³•ä¸­ç½‘ç»œçš„æ„æˆ</strong></p>
<ul>
<li><strong>Deep Q-Network (DQN):</strong> å½“çŠ¶æ€ç©ºé—´æˆ–åŠ¨ä½œç©ºé—´å˜å¾—éå¸¸å¤§æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¥ç»ç½‘ç»œæ¥è¿‘ä¼¼Qå‡½æ•°ï¼Œè¿™å°±æ˜¯DQNã€‚
<ul>
<li>DQNçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ª<strong>Qç½‘ç»œ (Q-Network)</strong>ã€‚è¿™ä¸ªç½‘ç»œè¾“å…¥çŠ¶æ€ <code>s</code>ï¼Œè¾“å‡ºå¯¹åº”çŠ¶æ€ä¸‹æ‰€æœ‰å¯èƒ½åŠ¨ä½œçš„Qå€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¯å¢ƒæœ‰3ä¸ªç¦»æ•£åŠ¨ä½œï¼Œè¾“å…¥çŠ¶æ€ <code>s</code>ï¼Œç½‘ç»œä¼šè¾“å‡º <code>[Q(s, a1), Q(s, a2), Q(s, a3)]</code>ã€‚</li>
<li><strong>åŠ¨ä½œé€‰æ‹© (Policy Derivation):</strong> åœ¨DQNä¸­ï¼Œç­–ç•¥ï¼ˆå¦‚ä½•é€‰æ‹©åŠ¨ä½œï¼‰æ˜¯æ ¹æ®Qç½‘ç»œè¾“å‡ºçš„Qå€¼<strong>æ´¾ç”Ÿ</strong>å‡ºæ¥çš„ï¼Œé€šå¸¸ä½¿ç”¨Îµ-greedyç­–ç•¥ï¼š
<ul>
<li>ä»¥ <code>1-Îµ</code> çš„æ¦‚ç‡é€‰æ‹©å…·æœ‰æœ€å¤§Qå€¼çš„åŠ¨ä½œï¼š<code>a = argmax_a' Q(s, a')</code></li>
<li>ä»¥ <code>Îµ</code> çš„æ¦‚ç‡éšæœºé€‰æ‹©ä¸€ä¸ªåŠ¨ä½œï¼ˆç”¨äºæ¢ç´¢ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æ‰€ä»¥ï¼ŒDQNä¸­å¹¶æ²¡æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ã€å‚æ•°åŒ–çš„â€œActorç½‘ç»œâ€æ¥ç›´æ¥è¾“å‡ºç­–ç•¥ <code>Ï€(a|s)</code> æˆ–ç¡®å®šæ€§åŠ¨ä½œ <code>a = Î¼(s)</code>ã€‚</strong> å®ƒçš„â€œè¡Œä¸ºâ€ (acting) æ˜¯ç”±Qç½‘ç»œçš„ç»“æœé©±åŠ¨çš„ã€‚Qç½‘ç»œæœ¬èº«æ˜¯ä¸€ä¸ª<strong>ä»·å€¼ç½‘ç»œ (Value Network)</strong>ã€‚</li>
</ul>
</li>
</ul>
<p>å› æ­¤ï¼ŒQ-learningåŠå…¶æ·±åº¦ç‰ˆæœ¬DQNæœ¬è´¨ä¸Šæ˜¯<strong>åŸºäºå€¼ (Value-based)</strong> çš„æ–¹æ³•ï¼Œå®ƒä»¬å­¦ä¹ ä¸€ä¸ªå€¼å‡½æ•°ï¼ˆQå‡½æ•°ï¼‰ï¼Œç„¶åä»è¿™ä¸ªå€¼å‡½æ•°ä¸­éšå¼åœ°æˆ–æ˜¾å¼åœ°å¯¼å‡ºç­–ç•¥ã€‚å®ƒä»¬æ²¡æœ‰åƒActor-Criticæ–¹æ³•é‚£æ ·æ˜¾å¼åœ°å­¦ä¹ ä¸€ä¸ªç‹¬ç«‹çš„ç­–ç•¥ç½‘ç»œï¼ˆActorï¼‰ã€‚</p>
<br>
<p><strong>ä¸ºä»€ä¹ˆä¼šå‡ºç°Actor-Criticç½‘ç»œçš„åˆ†ç¦»ï¼Ÿ</strong></p>
<p>Actor-Critic (AC) æ¶æ„å°†ç­–ç•¥å­¦ä¹ å’Œä»·å€¼å­¦ä¹ åˆ†ç¦»å¼€æ¥ï¼Œç”±ä¸¤ä¸ªç‹¬ç«‹çš„ï¼ˆæˆ–éƒ¨åˆ†å…±äº«å‚æ•°çš„ï¼‰ç½‘ç»œï¼ˆæˆ–å‡½æ•°é€¼è¿‘å™¨ï¼‰æ¥æ‰¿æ‹…ï¼š</p>
<ol>
<li>
<p><strong>Actor (ç­–ç•¥ç½‘ç»œ <code>Ï€_Î¸(a|s)</code>)</strong>:</p>
<ul>
<li>è´Ÿè´£å­¦ä¹ ç­–ç•¥ï¼Œå³åœ¨ç»™å®šçŠ¶æ€ <code>s</code> ä¸‹åº”è¯¥é‡‡å–ä»€ä¹ˆåŠ¨ä½œ <code>a</code>ï¼ˆæˆ–åŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒï¼‰ã€‚</li>
<li>å®ƒçš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–æœŸæœ›ç´¯ç§¯å›æŠ¥ã€‚</li>
<li>å‚æ•°ä¸º <code>Î¸</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>Critic (ä»·å€¼ç½‘ç»œ <code>V_Ï†(s)</code> æˆ– <code>Q_Ï†(s,a)</code>)</strong>:</p>
<ul>
<li>è´Ÿè´£è¯„ä¼°Actoræ‰€é€‰æ‹©çš„ç­–ç•¥çš„å¥½åã€‚å®ƒå­¦ä¹ ä¸€ä¸ªå€¼å‡½æ•°ï¼Œè¿™ä¸ªå€¼å‡½æ•°å¯ä»¥æ˜¯å¯¹å½“å‰ç­–ç•¥ä¸‹çŠ¶æ€ <code>s</code> çš„ä»·å€¼ <code>V(s)</code>ï¼ˆçŠ¶æ€å€¼å‡½æ•°ï¼‰ï¼Œæˆ–è€…æ˜¯çŠ¶æ€-åŠ¨ä½œå¯¹ <code>(s,a)</code> çš„ä»·å€¼ <code>Q(s,a)</code>ï¼ˆåŠ¨ä½œå€¼å‡½æ•°ï¼‰ã€‚</li>
<li>å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½å‡†ç¡®åœ°ä¼°è®¡ä»·å€¼ã€‚</li>
<li>å‚æ•°ä¸º <code>Ï†</code>ã€‚</li>
</ul>
</li>
</ol>
<p><strong>åˆ†ç¦»çš„ä¸»è¦åŸå› å’Œä¼˜åŠ¿å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li>
<p><strong>é™ä½ç­–ç•¥æ¢¯åº¦çš„æ–¹å·® (Variance Reduction) - è¿™æ˜¯æœ€æ ¸å¿ƒçš„åŸå› ï¼š</strong></p>
<ul>
<li>çº¯ç²¹çš„ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆå¦‚REINFORCEï¼‰ç›´æ¥ä½¿ç”¨è’™ç‰¹å¡æ´›å›æŠ¥ <code>G_t</code> æ¥ä¼°è®¡ç­–ç•¥æ¢¯åº¦ã€‚è¿™ç§å›æŠ¥çš„æ–¹å·®é€šå¸¸éå¸¸å¤§ï¼Œå› ä¸ºä¸€ä¸ªå¥½çš„åŠ¨ä½œå¯èƒ½å› ä¸ºåç»­ä¸€ç³»åˆ—åçš„éšæœºäº‹ä»¶è€Œå¯¼è‡´ä½å›æŠ¥ï¼Œåä¹‹äº¦ç„¶ã€‚é«˜æ–¹å·®ä½¿å¾—å­¦ä¹ è¿‡ç¨‹ä¸ç¨³å®šä¸”æ”¶æ•›ç¼“æ…¢ã€‚</li>
<li>Criticé€šè¿‡å­¦ä¹ ä¸€ä¸ªå€¼å‡½æ•°ï¼ˆå¦‚ <code>V(s)</code>ï¼‰æä¾›äº†ä¸€ä¸ª<strong>åŸºçº¿ (baseline)</strong>ã€‚ç­–ç•¥æ¢¯åº¦å¯ä»¥ä½¿ç”¨<strong>ä¼˜åŠ¿å‡½æ•° (Advantage Function)</strong> <code>A(s, a) = Q(s, a) - V(s)</code> æˆ–è€… <code>A(s, a) = r_t + Î³V(s_&#123;t+1&#125;) - V(s_t)</code> (TDè¯¯å·®) æ¥æ›´æ–°ã€‚</li>
<li>ä¼˜åŠ¿å‡½æ•°è¡¡é‡äº†åœ¨çŠ¶æ€ <code>s</code> ä¸‹é‡‡å–åŠ¨ä½œ <code>a</code> ç›¸å¯¹äºåœ¨è¯¥çŠ¶æ€ä¸‹é‡‡å–å¹³å‡åŠ¨ä½œçš„å¥½åç¨‹åº¦ã€‚ä½¿ç”¨ä¼˜åŠ¿å‡½æ•°ä»£æ›¿åŸå§‹å›æŠ¥ <code>G_t</code> å¯ä»¥æ˜¾è‘—é™ä½æ¢¯åº¦çš„æ–¹å·®ï¼Œå› ä¸ºæˆ‘ä»¬å‡å»äº†ä¸€ä¸ªä¸å½“å‰çŠ¶æ€ç›¸å…³çš„æœŸæœ›å€¼ï¼Œä½¿å¾—æ¢¯åº¦ä¿¡å·æ›´é›†ä¸­äºåŠ¨ä½œæœ¬èº«çš„å¥½åï¼Œè€Œä¸æ˜¯çŠ¶æ€æœ¬èº«çš„å¥½åæˆ–åç»­è½¨è¿¹çš„éšæœºæ€§ã€‚</li>
<li><strong>æ›´ç¨³å®šçš„å­¦ä¹ ä¿¡å·ï¼š</strong> Criticä¸ºActoræä¾›äº†ä¸€ä¸ªæ›´ç¨³å®šã€æ–¹å·®æ›´ä½çš„å­¦ä¹ ä¿¡å·ï¼ŒæŒ‡å¯¼Actorå¦‚ä½•è°ƒæ•´å…¶ç­–ç•¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¤„ç†è¿ç»­åŠ¨ä½œç©ºé—´çš„èƒ½åŠ›ï¼š</strong></p>
<ul>
<li><strong>Value-basedæ–¹æ³• (å¦‚DQN)</strong> åœ¨å¤„ç†é«˜ç»´æˆ–è¿ç»­åŠ¨ä½œç©ºé—´æ—¶ä¼šé‡åˆ°å›°éš¾ã€‚å¦‚æœåŠ¨ä½œæ˜¯è¿ç»­çš„ï¼Œ<code>argmax_a Q(s, a)</code> å˜æˆäº†ä¸€ä¸ªåœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½éœ€è¦è§£å†³çš„å¤æ‚ä¼˜åŒ–é—®é¢˜ã€‚</li>
<li><strong>Actor-Criticæ–¹æ³•</strong> ä¸­çš„Actorå¯ä»¥ç›´æ¥è¾“å‡ºè¿ç»­åŠ¨ä½œï¼ˆä¾‹å¦‚ï¼Œè¾“å‡ºé«˜æ–¯åˆ†å¸ƒçš„å‡å€¼å’Œæ–¹å·®ï¼‰ï¼Œæˆ–è€…ç›´æ¥è¾“å‡ºç¡®å®šæ€§åŠ¨ä½œï¼Œè¿™ä½¿å¾—å®ƒä»¬éå¸¸é€‚åˆè¿ç»­åŠ¨ä½œç©ºé—´ã€‚</li>
</ul>
</li>
<li>
<p><strong>å­¦ä¹ éšæœºç­–ç•¥çš„èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>Actorå¯ä»¥ç›´æ¥å‚æ•°åŒ–ä¸€ä¸ªéšæœºç­–ç•¥ <code>Ï€(a|s)</code>ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯å¿…è¦çš„ï¼ˆä¾‹å¦‚ï¼Œéƒ¨åˆ†å¯è§‚å¯Ÿç¯å¢ƒï¼Œæˆ–è€…ä¸ºäº†æ›´å¥½çš„æ¢ç´¢ï¼‰ã€‚</li>
<li>è™½ç„¶å¯ä»¥é€šè¿‡Îµ-greedyä»Qå€¼å¯¼å‡ºéšæœºæ€§ï¼Œä½†Actorå¯ä»¥ç›´æ¥å­¦ä¹ æ›´å¤æ‚çš„éšæœºç­–ç•¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ›´å¿«çš„æ”¶æ•›ï¼ˆæœ‰æ—¶ï¼‰ï¼š</strong></p>
<ul>
<li>ç”±äºæ–¹å·®é™ä½å’Œæ›´æœ‰æ•ˆçš„ä¿¡ç”¨åˆ†é…ï¼ŒACæ–¹æ³•æœ‰æ—¶å¯ä»¥æ¯”çº¯ç­–ç•¥æ¢¯åº¦æ–¹æ³•æˆ–æŸäº›çº¯ä»·å€¼æ–¹æ³•æ”¶æ•›æ›´å¿«ã€‚Criticçš„å¼•å¯¼å¯ä»¥å¸®åŠ©Actoræ›´å¿«åœ°æ‰¾åˆ°å¥½çš„ç­–ç•¥æ–¹å‘ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ¨¡å—åŒ–å’Œçµæ´»æ€§ï¼š</strong></p>
<ul>
<li>Actorå’ŒCriticå¯ä»¥æœ‰ä¸åŒçš„ç½‘ç»œç»“æ„ã€å­¦ä¹ ç‡ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨ä¸åŒçš„ä¼˜åŒ–ç®—æ³•ã€‚è¿™ç§æ¨¡å—åŒ–è®¾è®¡æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</li>
<li>ä¾‹å¦‚ï¼Œåœ¨A2C/A3Cä¸­ï¼ŒActorå’ŒCriticå¯ä»¥å…±äº«åº•å±‚çš„ç‰¹å¾æå–å±‚ï¼Œç„¶ååœ¨é¡¶éƒ¨åˆ†åˆ«æœ‰å„è‡ªçš„è¾“å‡ºå¤´ã€‚</li>
</ul>
</li>
</ol>
<p><strong>æ€»ç»“ä¸€ä¸‹Actor-Criticåˆ†ç¦»çš„åŠ¨æœºï¼š</strong></p>
<ul>
<li><strong>æ ¸å¿ƒï¼š</strong> Criticå¸®åŠ©Actorè¿›è¡Œæ›´æœ‰æ•ˆçš„å­¦ä¹ ï¼Œä¸»è¦æ˜¯é€šè¿‡<strong>é™ä½ç­–ç•¥æ¢¯åº¦çš„æ–¹å·®</strong>ã€‚</li>
<li><strong>é€‚ç”¨æ€§ï¼š</strong> ä½¿å¼ºåŒ–å­¦ä¹ ç®—æ³•èƒ½æ›´å¥½åœ°åº”ç”¨äº<strong>è¿ç»­åŠ¨ä½œç©ºé—´</strong>ã€‚</li>
<li><strong>ç­–ç•¥è¡¨è¾¾ï¼š</strong> æ–¹ä¾¿å­¦ä¹ <strong>éšæœºç­–ç•¥</strong>ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼ŒActor-Criticçš„åˆ†ç¦»æ˜¯ä¸€ç§æƒè¡¡å’Œç»“åˆï¼šActorè´Ÿè´£â€œåšä»€ä¹ˆâ€ï¼ŒCriticè´Ÿè´£â€œåšå¾—æ€ä¹ˆæ ·â€ï¼Œä¸¤è€…ååŒå·¥ä½œï¼Œä½¿å¾—ç®—æ³•åœ¨å…·æœ‰æŒ‘æˆ˜æ€§çš„ç¯å¢ƒä¸­è¡¨ç°æ›´å¥½ï¼Œå­¦ä¹ æ›´ç¨³å®šã€‚</p>
<br>
<p><strong>è¯´æ˜æ¡ˆä¾‹</strong></p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜è’™ç‰¹å¡æ´›å›æŠ¥ <code>G_t</code> çš„é«˜æ–¹å·®é—®é¢˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆå®ƒä¼šå¯¼è‡´å­¦ä¹ ä¸ç¨³å®šã€‚</p>
<p><strong>åœºæ™¯è®¾å®šï¼š</strong></p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„ç¯å¢ƒï¼Œæ™ºèƒ½ä½“ä»ä¸€ä¸ªèµ·å§‹çŠ¶æ€ <code>S_0</code> å¼€å§‹ï¼Œå¯ä»¥é‡‡å–ä¸¤ä¸ªåŠ¨ä½œï¼š<code>A_left</code> æˆ– <code>A_right</code>ã€‚</p>
<ul>
<li><strong>åŠ¨ä½œæ•ˆæœï¼š</strong>
<ul>
<li><code>A_left</code>ï¼šæœ‰ 70% çš„æ¦‚ç‡ç«‹å³è·å¾— +10 çš„å¥–åŠ±å¹¶ç»“æŸå›åˆ (win)ï¼›æœ‰ 30% çš„æ¦‚ç‡ç«‹å³è·å¾— -5 çš„å¥–åŠ±å¹¶ç»“æŸå›åˆ (lose)ã€‚</li>
<li><code>A_right</code>ï¼šè¿›å…¥ä¸€ä¸ªä¸­é—´çŠ¶æ€ <code>S_intermediate</code>ã€‚</li>
</ul>
</li>
<li><strong>ä¸­é—´çŠ¶æ€ <code>S_intermediate</code>ï¼š</strong>
<ul>
<li>ä» <code>S_intermediate</code> å¼€å§‹ï¼Œæ— è®ºé‡‡å–ä»€ä¹ˆåç»­åŠ¨ä½œï¼ˆå‡è®¾åªæœ‰ä¸€ä¸ªé»˜è®¤åŠ¨ä½œï¼‰ï¼Œæœ‰ 50% çš„æ¦‚ç‡è·å¾— +100 çš„å·¨å¤§å¥–åŠ±å¹¶ç»“æŸå›åˆ (big win)ï¼›æœ‰ 50% çš„æ¦‚ç‡è·å¾— -100 çš„å·¨å¤§æƒ©ç½šå¹¶ç»“æŸå›åˆ (big loss)ã€‚</li>
</ul>
</li>
</ul>
<p><strong>æ™ºèƒ½ä½“çš„ç­–ç•¥ï¼š</strong></p>
<p>å‡è®¾æ™ºèƒ½ä½“çš„ç­–ç•¥ç½‘ç»œ <code>Ï€_Î¸(a|S_0)</code> åœ¨èµ·å§‹çŠ¶æ€ <code>S_0</code> å¯¹ä¸¤ä¸ªåŠ¨ä½œçš„è¾“å‡ºæ¦‚ç‡æ˜¯å¯è°ƒæ•´çš„ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å­¦ä¹ åˆ°åœ¨ <code>S_0</code> æ—¶åº”è¯¥é€‰æ‹©å“ªä¸ªåŠ¨ä½œã€‚</p>
<p><strong>çº¯ç²¹çš„ç­–ç•¥æ¢¯åº¦ (REINFORCE) å¦‚ä½•å·¥ä½œï¼š</strong></p>
<p>REINFORCEç®—æ³•çš„ç­–ç•¥æ¢¯åº¦æ›´æ–°è§„åˆ™å¤§è‡´å¦‚ä¸‹ï¼š<br>
<code>âˆ‡_Î¸ J(Î¸) â‰ˆ E [ Î£_t âˆ‡_Î¸ log Ï€_Î¸(a_t|s_t) * G_t ]</code></p>
<p>å…¶ä¸­ <code>G_t</code> æ˜¯ä»æ—¶é—´æ­¥ <code>t</code> å¼€å§‹åˆ°å›åˆç»“æŸçš„ç´¯ç§¯æŠ˜æ‰£å›æŠ¥ã€‚ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å‡è®¾æŠ˜æ‰£å› å­ <code>Î³ = 1</code>ï¼Œå¹¶ä¸”æˆ‘ä»¬åªå…³æ³¨åœ¨ <code>S_0</code> å¤„åšçš„ç¬¬ä¸€ä¸ªå†³ç­–ã€‚æ‰€ä»¥ï¼Œ<code>G_0</code> å°±æ˜¯æ•´ä¸ªå›åˆçš„æ€»å›æŠ¥ã€‚</p>
<p><strong>åˆ†æé«˜æ–¹å·®é—®é¢˜ï¼š</strong></p>
<p>æˆ‘ä»¬æ¥åˆ†æåœ¨ <code>S_0</code> é‡‡å–ä¸åŒåŠ¨ä½œæ—¶ <code>G_0</code> çš„æƒ…å†µï¼š</p>
<ol>
<li>
<p><strong>å¦‚æœæ™ºèƒ½ä½“åœ¨ <code>S_0</code> é€‰æ‹© <code>A_left</code>ï¼š</strong></p>
<ul>
<li>æœ‰ 70% çš„æ¦‚ç‡ï¼Œ<code>G_0 = +10</code>ã€‚</li>
<li>æœ‰ 30% çš„æ¦‚ç‡ï¼Œ<code>G_0 = -5</code>ã€‚</li>
<li><code>A_left</code> çš„æœŸæœ›å›æŠ¥ = <code>0.7 * 10 + 0.3 * (-5) = 7 - 1.5 = 5.5</code>ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å½“ä¸é”™çš„ç¨³å®šæ­£å›æŠ¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¦‚æœæ™ºèƒ½ä½“åœ¨ <code>S_0</code> é€‰æ‹© <code>A_right</code>ï¼š</strong></p>
<ul>
<li>æ™ºèƒ½ä½“è¿›å…¥ <code>S_intermediate</code>ã€‚</li>
<li>ç„¶åï¼Œæœ‰ 50% çš„æ¦‚ç‡ï¼Œ<code>G_0 = +100</code>ã€‚</li>
<li>æœ‰ 50% çš„æ¦‚ç‡ï¼Œ<code>G_0 = -100</code>ã€‚</li>
<li><code>A_right</code> çš„æœŸæœ›å›æŠ¥ = <code>0.5 * 100 + 0.5 * (-100) = 50 - 50 = 0</code>ã€‚ä»æœŸæœ›ä¸Šçœ‹ï¼Œè¿™ä¸ªåŠ¨ä½œå¹¶ä¸å¥½ã€‚</li>
</ul>
</li>
</ol>
<p><strong>é«˜æ–¹å·®å¦‚ä½•å½±å“å­¦ä¹ ï¼š</strong></p>
<p>å‡è®¾æ™ºèƒ½ä½“é€šè¿‡å¤šæ¬¡è¯•éªŒæ¥å­¦ä¹ ã€‚</p>
<ul>
<li>
<p><strong>è€ƒè™‘ <code>A_left</code>ï¼š</strong></p>
<ul>
<li>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ™ºèƒ½ä½“é‡‡å– <code>A_left</code> ä¼šå¾—åˆ° <code>+10</code> çš„å›æŠ¥ã€‚<code>log Ï€_Î¸(A_left|S_0)</code> è¿™ä¸€é¡¹ä¼šä¹˜ä»¥ä¸€ä¸ªæ­£æ•°ï¼Œä½¿å¾—ç­–ç•¥æ›´å€¾å‘äº <code>A_left</code>ã€‚</li>
<li>å°‘æ•°æƒ…å†µä¸‹ï¼Œå¾—åˆ° <code>-5</code>ã€‚<code>log Ï€_Î¸(A_left|S_0)</code> ä¼šä¹˜ä»¥ä¸€ä¸ªè´Ÿæ•°ï¼Œç•¥å¾®æŠ‘åˆ¶ <code>A_left</code>ã€‚</li>
<li>å›æŠ¥çš„æ–¹å·®ç›¸å¯¹è¾ƒå°ï¼ˆå€¼åœ¨ -5 åˆ° 10 ä¹‹é—´æ³¢åŠ¨ï¼‰ã€‚</li>
</ul>
</li>
<li>
<p><strong>è€ƒè™‘ <code>A_right</code>ï¼š</strong></p>
<ul>
<li>ä¸€åŠæƒ…å†µä¸‹ï¼Œæ™ºèƒ½ä½“é‡‡å– <code>A_right</code> ä¼šå¾—åˆ° <code>+100</code> çš„å·¨å¤§å›æŠ¥ã€‚<code>log Ï€_Î¸(A_right|S_0)</code> ä¼šä¹˜ä»¥ä¸€ä¸ªéå¸¸å¤§çš„æ­£æ•°ã€‚è¿™ä¼š<strong>æå¤§åœ°</strong>å¢å¼ºé€‰æ‹© <code>A_right</code> çš„å€¾å‘ã€‚</li>
<li>å¦ä¸€åŠæƒ…å†µä¸‹ï¼Œæ™ºèƒ½ä½“é‡‡å– <code>A_right</code> ä¼šå¾—åˆ° <code>-100</code> çš„å·¨å¤§æƒ©ç½šã€‚<code>log Ï€_Î¸(A_right|S_0)</code> ä¼šä¹˜ä»¥ä¸€ä¸ªéå¸¸å¤§çš„è´Ÿæ•°ã€‚è¿™ä¼š<strong>æå¤§åœ°</strong>æŠ‘åˆ¶é€‰æ‹© <code>A_right</code> çš„å€¾å‘ã€‚</li>
<li>å›æŠ¥çš„æ–¹å·®éå¸¸å¤§ï¼ˆåœ¨ -100 å’Œ +100 ä¹‹é—´å‰§çƒˆæ³¢åŠ¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å­¦ä¹ è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼š</strong></p>
<ol>
<li>
<p><strong>ä¸ç¨³å®šçš„æ¢¯åº¦ä¼°è®¡ï¼š</strong> å‡è®¾æ™ºèƒ½ä½“å½“å‰ç­–ç•¥å¯¹ <code>A_left</code> å’Œ <code>A_right</code> çš„æ¦‚ç‡ç›¸è¿‘ã€‚</p>
<ul>
<li>å¦‚æœæŸä¸€æ‰¹æ¬¡çš„ç»éªŒä¸­ï¼Œæ°å¥½å¤šæ¬¡é‡‡å– <code>A_right</code> éƒ½ç¢°ä¸Šäº† <code>+100</code> çš„å¥½è¿æ°”ï¼Œé‚£ä¹ˆæ¢¯åº¦æ›´æ–°ä¼šå¼ºçƒˆåœ°è®©æ™ºèƒ½ä½“æœªæ¥æ›´å€¾å‘äºé€‰æ‹© <code>A_right</code>ï¼Œå°½ç®¡ <code>A_right</code> çš„æœŸæœ›å›æŠ¥æ˜¯0ï¼Œä¸å¦‚ <code>A_left</code> çš„æœŸæœ›å›æŠ¥5.5ã€‚</li>
<li>åä¹‹ï¼Œå¦‚æœå¤šæ¬¡é‡‡å– <code>A_right</code> éƒ½ç¢°ä¸Šäº† <code>-100</code> çš„åè¿æ°”ï¼Œæ¢¯åº¦æ›´æ–°ä¼šå¼ºçƒˆåœ°è®©æ™ºèƒ½ä½“é¿å¼€ <code>A_right</code>ã€‚</li>
<li>è¿™ç§åŸºäºå°‘æ•°æ ·æœ¬çš„å‰§çƒˆæ³¢åŠ¨ä½¿å¾—æ¢¯åº¦çš„æ–¹å‘éå¸¸ä¸ç¨³å®šã€‚</li>
</ul>
</li>
<li>
<p><strong>â€œå¥½çš„åŠ¨ä½œå¯èƒ½å› ä¸ºåç»­ä¸€ç³»åˆ—åçš„éšæœºäº‹ä»¶è€Œå¯¼è‡´ä½å›æŠ¥â€ï¼š</strong><br>
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>A_left</code> æœ¬èº«æ˜¯ä¸€ä¸ªæœŸæœ›å›æŠ¥ä¸ºæ­£ (5.5) çš„å¥½åŠ¨ä½œã€‚ä½†å¦‚æœæ™ºèƒ½ä½“å°è¯• <code>A_left</code>ï¼Œæœ‰ 30% çš„å‡ ç‡å¾—åˆ° <code>-5</code>ã€‚å¦‚æœæ­¤æ—¶å®ƒä¹Ÿå°è¯•äº† <code>A_right</code> å¹¶ä¸”ç¢°å·§å¾—åˆ°äº† <code>+100</code>ï¼Œé‚£ä¹ˆç®—æ³•å¯èƒ½ä¼šé”™è¯¯åœ°è®¤ä¸º <code>A_right</code> æ¯” <code>A_left</code> å¥½å¾—å¤šï¼Œå°½ç®¡åªæ˜¯å› ä¸º <code>A_right</code> åç»­çš„éšæœºæ€§å¯¼è‡´äº†ä¸€ä¸ªå¶ç„¶çš„é«˜å›æŠ¥ã€‚</p>
</li>
<li>
<p><strong>â€œåçš„åŠ¨ä½œå¯èƒ½å› ä¸ºåç»­ä¸€ç³»åˆ—å¥½çš„éšæœºäº‹ä»¶è€Œå¯¼è‡´é«˜å›æŠ¥â€ï¼š</strong><br>
<code>A_right</code> æœ¬èº«æ˜¯ä¸€ä¸ªæœŸæœ›å›æŠ¥ä¸ºé›¶çš„åŠ¨ä½œï¼ˆä¸å¦‚ <code>A_left</code>ï¼‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ™ºèƒ½ä½“å°è¯• <code>A_right</code>ï¼Œæœ‰ 50% çš„æ¦‚ç‡å¾—åˆ° <code>+100</code> çš„é«˜å›æŠ¥ã€‚å¦‚æœå®ƒæ°å¥½åœ¨å°‘æ•°å‡ ä¸ªæ ·æœ¬ä¸­éƒ½ç»å†äº†è¿™ç§æƒ…å†µï¼Œç®—æ³•ä¼šé”™è¯¯åœ°å¼ºåŒ–è¿™ä¸ªâ€œåâ€åŠ¨ä½œã€‚</p>
</li>
<li>
<p><strong>ç¼“æ…¢æ”¶æ•›ï¼š</strong> ä¸ºäº†å…‹æœè¿™ç§é«˜æ–¹å·®ï¼Œç®—æ³•éœ€è¦æ”¶é›†å¤§é‡çš„æ ·æœ¬ï¼Œæ‰èƒ½è®© <code>G_t</code> çš„å¹³å‡æ•ˆæœé€æ¸æ¥è¿‘å…¶çœŸå®æœŸæœ›ã€‚å¦‚æœæ–¹å·®å¾ˆå¤§ï¼Œå°±éœ€è¦æ›´å¤šçš„æ ·æœ¬æ¥è·å¾—ä¸€ä¸ªå¯é çš„æ¢¯åº¦ä¼°è®¡ï¼Œè¿™å¯¼è‡´æ”¶æ•›ç¼“æ…¢ã€‚æ™ºèƒ½ä½“çš„ç­–ç•¥å¯èƒ½ä¼šåœ¨å¥½åä¹‹é—´æ¥å›æ‘†åŠ¨å¾ˆé•¿æ—¶é—´ã€‚</p>
</li>
</ol>
<p><strong>Actor-Criticå¦‚ä½•å¸®åŠ©ï¼š</strong></p>
<p>å¦‚æœä½¿ç”¨Actor-Criticï¼š</p>
<ul>
<li>
<p>Criticä¼šå­¦ä¹ çŠ¶æ€å€¼å‡½æ•° <code>V(s)</code>ã€‚</p>
<ul>
<li>ç†æƒ³æƒ…å†µä¸‹ï¼Œ<code>V(S_0)</code> ä¼šå­¦ä¹ åˆ°æ¥è¿‘ <code>5.5</code>ï¼ˆå¦‚æœæœ€ä¼˜ç­–ç•¥æ˜¯é€‰ <code>A_left</code>ï¼‰ã€‚</li>
<li><code>V(S_intermediate)</code> ä¼šå­¦ä¹ åˆ°æ¥è¿‘ <code>0</code>ã€‚</li>
</ul>
</li>
<li>
<p>å½“è®¡ç®—ä¼˜åŠ¿ <code>A(s, a)</code> æ—¶ï¼š</p>
<ul>
<li>å¯¹äº <code>A_left</code> å¾—åˆ° <code>+10</code>ï¼š<code>A(S_0, A_left) = r + Î³V(end) - V(S_0) = 10 + 0 - V(S_0)</code>ã€‚å¦‚æœ <code>V(S_0)</code> æ¥è¿‘ <code>5.5</code>ï¼Œä¼˜åŠ¿å°±æ˜¯ <code>4.5</code>ã€‚</li>
<li>å¯¹äº <code>A_left</code> å¾—åˆ° <code>-5</code>ï¼š<code>A(S_0, A_left) = -5 + 0 - V(S_0)</code>ã€‚å¦‚æœ <code>V(S_0)</code> æ¥è¿‘ <code>5.5</code>ï¼Œä¼˜åŠ¿å°±æ˜¯ <code>-10.5</code>ã€‚</li>
<li>å¯¹äº <code>A_right</code> å¾—åˆ° <code>+100</code>ï¼šæ™ºèƒ½ä½“å…ˆåˆ°è¾¾ <code>S_intermediate</code>ï¼ˆå‡è®¾è¿™é‡Œæ²¡æœ‰ç«‹å³å¥–åŠ±ï¼‰ï¼Œç„¶åå¾—åˆ° <code>+100</code>ã€‚<br>
ä¼˜åŠ¿çš„è®¡ç®—ä¼šæ›´åƒæ˜¯ <code>Î´_0 = r_0 + Î³V(S_intermediate) - V(S_0)</code>ã€‚å¦‚æœ <code>r_0=0</code>ï¼ˆç«‹å³å¥–åŠ±ä¸º0ï¼‰ï¼Œ<code>Î´_0 = Î³V(S_intermediate) - V(S_0)</code>ã€‚å¦‚æœ <code>V(S_intermediate)</code> æ¥è¿‘0ï¼Œ<code>V(S_0)</code> æ¥è¿‘5.5ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆå§‹TDè¯¯å·®æ˜¯è´Ÿçš„ã€‚åç»­çš„TDè¯¯å·® <code>Î´_1 = 100 + Î³V(end) - V(S_intermediate) = 100 - V(S_intermediate)</code> ä¼šæ˜¯å¤§çš„æ­£å€¼ã€‚GAEä¼šå°†è¿™äº›TDè¯¯å·®ç»„åˆèµ·æ¥ã€‚<br>
æ›´ç®€å•åœ°çœ‹ï¼Œå¦‚æœCriticå·²ç»æ¯”è¾ƒå‡†ç¡®ï¼Œ<code>A(S_0, A_right) = Q(S_0, A_right) - V(S_0)</code>ã€‚<code>Q(S_0, A_right)</code> çš„æœŸæœ›æ˜¯0ã€‚å¦‚æœ <code>V(S_0)</code> æ˜¯åŸºäºå½“å‰æ··åˆç­–ç•¥çš„å¹³å‡å€¼ï¼Œé‚£ä¹ˆä¼˜åŠ¿å€¼ä¼šæ›´å¥½åœ°åæ˜  <code>A_right</code> ç›¸å¯¹äºå½“å‰å¹³å‡è¡¨ç°çš„å¥½åï¼Œè€Œä¸æ˜¯å…¶ç»å¯¹å›æŠ¥çš„å‰§çƒˆæ³¢åŠ¨ã€‚</li>
</ul>
</li>
</ul>
<p>é€šè¿‡å¼•å…¥åŸºçº¿ <code>V(S_0)</code>ï¼Œä¼˜åŠ¿å‡½æ•° <code>A(S_0, a)</code> çš„æ³¢åŠ¨å¹…åº¦ä¼šå‡å°ã€‚ä¾‹å¦‚ï¼Œå³ä½¿ <code>A_right</code> å¾—åˆ°äº† <code>+100</code>ï¼Œå¦‚æœ <code>V(S_0)</code> å·²ç»å­¦åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒé«˜çš„å€¼ï¼ˆæ¯”å¦‚å› ä¸ºå½“å‰ç­–ç•¥æœ‰æ—¶ä¼šé€‰ <code>A_left</code>ï¼‰ï¼Œé‚£ä¹ˆ <code>+100 - V(S_0)</code> ç›¸æ¯”äºç›´æ¥ä½¿ç”¨ <code>+100</code> ä½œä¸ºæƒé‡ï¼Œå…¶ç»å¯¹å€¼å¯èƒ½æ›´å°ï¼Œæˆ–è€…å…¶ç›¸å¯¹å…¶ä»–åŠ¨ä½œçš„ä¼˜åŠ¿æ›´åˆç†ã€‚</p>
<p>è¿™ä¸ªä¾‹å­æ¸…æ™°åœ°å±•ç¤ºäº†ï¼š</p>
<ul>
<li>è’™ç‰¹å¡æ´›å›æŠ¥ <code>G_t</code> çš„å€¼å¯ä»¥æœ‰å¾ˆå¤§çš„æ³¢åŠ¨èŒƒå›´ã€‚</li>
<li>è¿™ç§æ³¢åŠ¨ä¸æ˜¯ç”±åŠ¨ä½œæœ¬èº«çš„å¥½åå”¯ä¸€å†³å®šçš„ï¼Œè€Œæ˜¯å—åˆ°äº†åç»­å¤§é‡éšæœºäº‹ä»¶çš„å¼ºçƒˆå½±å“ã€‚</li>
<li>ä½¿ç”¨è¿™ç§é«˜æ–¹å·®çš„å›æŠ¥æ¥æŒ‡å¯¼ç­–ç•¥æ›´æ–°ï¼Œä¼šå¯¼è‡´æ¢¯åº¦ä¼°è®¡éå¸¸å˜ˆæ‚ï¼Œä½¿å¾—å­¦ä¹ ä¸ç¨³å®šä¸”æ•ˆç‡ä½ä¸‹ã€‚</li>
</ul>
<p>è€Œå¼•å…¥Criticå’Œä¼˜åŠ¿å‡½æ•°ï¼Œå°±æ˜¯ä¸ºäº†ä»å›æŠ¥ä¸­å‰¥ç¦»æ‰é‚£äº›ä¸å½“å‰çŠ¶æ€ä»·å€¼ç›¸å…³ä½†ä¸å½“å‰åŠ¨ä½œé€‰æ‹©æ— å…³çš„éƒ¨åˆ†ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªæ›´çº¯ç²¹ã€æ›´ä½æ–¹å·®çš„ä¿¡å·æ¥æŒ‡å¯¼Actorçš„å­¦ä¹ ã€‚</p>
<br>
<h3 id="å¿ƒå¾—">å¿ƒå¾—</h3>
<p>æ§åˆ¶çŠ¶æ€ç©ºé—´å¤§å°ï¼Œå°½é‡é€‰æ‹©æœ‰é™çŠ¶æ€ç©ºé—´</p>
<p>eg: å°†stateä¸­çš„ä¸€äº›å€¼intåŒ–</p>
<br>
<p>çŠ¶æ€ç©ºé—´çš„è¡¨ç¤ºå€¼å°½é‡æ¥è¿‘</p>
<p>é‡‡ç”¨æ ‡å‡†åŒ–æŠ€æœ¯å°†stateå†…çš„å€¼å‡ä¸€åŒ–</p>
<p>eg: [1, 200, 9999] -&gt; [0.001, 0.99, 0.9999]</p>
<br>
<p>æ›´å¥½çš„åˆå§‹åŒ–</p>
<br>
<p>rewardè®¾ç½®</p>
<p>æƒ©ç½šå’Œå¥–åŠ±è®¾ç½®æ’å€¼ä¸è¦è¿‡å¤§, é˜²æ­¢æƒ©ç½šæ‹Ÿåˆè¿‡å¿«</p>
<p>+2, -200 -&gt; +2, 0</p>
<br>
<h3 id="GRPOç›¸å…³">GRPOç›¸å…³</h3>
<p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œ<strong>ä¼˜åŠ¿å‡½æ•° (Advantage Function)</strong> <code>A(s, a)</code> çš„æ ‡å‡†å®šä¹‰æ˜¯ï¼š</p>
<p><code>A(s, a) = Q(s, a) - V(s)</code></p>
<p>è¿™é‡Œçš„æ¯ä¸ªéƒ¨åˆ†ä»£è¡¨ï¼š</p>
<ul>
<li><code>s</code> (State): çŠ¶æ€ã€‚åœ¨LLMçš„åœºæ™¯ä¸­ï¼Œè¿™é€šå¸¸æ˜¯è¾“å…¥çš„<strong>æç¤ºï¼ˆPromptï¼‰</strong>ï¼Œä¾‹å¦‚ â€œWhat is 2+2?â€ã€‚</li>
<li><code>a</code> (Action): åŠ¨ä½œã€‚åœ¨LLMä¸­ï¼Œè¿™æ˜¯æ¨¡å‹ç”Ÿæˆçš„<strong>å›ç­”ï¼ˆResponseï¼‰</strong>ï¼Œä¾‹å¦‚ â€œ4â€ã€‚</li>
<li><code>Q(s, a)</code> (Q-Value): <strong>åŠ¨ä½œä»·å€¼å‡½æ•°</strong>ã€‚å®ƒä»£è¡¨åœ¨çŠ¶æ€ <code>s</code> ä¸‹ï¼Œæ‰§è¡ŒåŠ¨ä½œ <code>a</code> åï¼ŒæœŸæœ›èƒ½è·å¾—çš„æ€»å›æŠ¥ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯**â€œè¿™ä¸ªå…·ä½“å›ç­”æœ‰å¤šå¥½ï¼Ÿâ€**ã€‚åœ¨RLHFä¸­ï¼Œè¿™ä¸ªå€¼é€šå¸¸ç”±å¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ç›´æ¥ç»™å‡ºï¼Œå³ <code>R(s, a)</code>ã€‚</li>
<li><code>V(s)</code> (Value): <strong>çŠ¶æ€ä»·å€¼å‡½æ•°</strong>ã€‚å®ƒä»£è¡¨åœ¨çŠ¶æ€ <code>s</code> ä¸‹ï¼Œéµå¾ªå½“å‰ç­–ç•¥ï¼ˆpolicyï¼‰ï¼Œæ‰€èƒ½è·å¾—çš„<strong>å¹³å‡æœŸæœ›å›æŠ¥</strong>ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯**â€œå¯¹äºè¿™ä¸ªæç¤ºï¼Œæˆ‘çš„æ¨¡å‹å¹³å‡èƒ½å›ç­”å¾—å¤šå¥½ï¼Ÿâ€**ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œä¼˜åŠ¿å‡½æ•°çš„ç›´è§‚ç†è§£æ˜¯ï¼š</p>
<p><strong><code>A(s, a) = (æ‰§è¡Œç‰¹å®šåŠ¨ä½œ a çš„ä»·å€¼) - (åœ¨è¯¥çŠ¶æ€ s ä¸‹çš„å¹³å‡ä»·å€¼)</code></strong></p>
<p>å®ƒè¡¡é‡çš„æ˜¯ï¼ŒæŸä¸ªå…·ä½“çš„å›ç­”ï¼ˆ<code>a</code>ï¼‰ç›¸æ¯”äºå½“å‰æ¨¡å‹å¯¹äºè¯¥æç¤ºï¼ˆ<code>s</code>ï¼‰çš„â€œå¹³å‡æ°´å¹³â€æ¥è¯´ï¼Œæ˜¯<strong>æ›´å¥½è¿˜æ˜¯æ›´å·®</strong>ã€‚</p>
<ul>
<li>å¦‚æœ <code>A(s, a) &gt; 0</code>ï¼Œè¯´æ˜è¿™ä¸ªå›ç­”æ¯”æ¨¡å‹çš„å¹³å‡è¡¨ç°è¦å¥½ï¼Œæˆ‘ä»¬åº”è¯¥å¢åŠ ç”Ÿæˆè¿™ä¸ªå›ç­”çš„æ¦‚ç‡ã€‚</li>
<li>å¦‚æœ <code>A(s, a) &lt; 0</code>ï¼Œè¯´æ˜è¿™ä¸ªå›ç­”æ¯”æ¨¡å‹çš„å¹³å‡è¡¨ç°è¦å·®ï¼Œæˆ‘ä»¬åº”è¯¥é™ä½ç”Ÿæˆè¿™ä¸ªå›ç­”çš„æ¦‚ç‡ã€‚</li>
</ul>
<br>
<p>ä½¿ç”¨å‡å€¼ä»£æ›¿GAEï¼š</p>
<p><strong>æˆ‘ä»¬ä¸éœ€è¦ä¸€ä¸ªå¤æ‚çš„ç¥ç»ç½‘ç»œå» <em>å­¦ä¹ </em> <code>V(s)</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å½“å‰æ‰¹æ¬¡çš„æ•°æ®ä¸­ <em>ä¼°ç®—</em> å®ƒã€‚</strong></p>
<p><code>V(s)</code> çš„å®šä¹‰æ˜¯â€œåœ¨çŠ¶æ€ <code>s</code> ä¸‹çš„<strong>æœŸæœ›å›æŠ¥</strong>â€ã€‚æœŸæœ›å€¼åœ¨æ•°å­¦ä¸Šå¯ä»¥é€šè¿‡å¤§é‡çš„é‡‡æ ·æ¥è¿‘ä¼¼ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼ˆç”¨ä½ çš„ä¾‹å­ â€œWhat is 2+2?â€ï¼‰ï¼š</p>
<ol>
<li>
<p><strong>çŠ¶æ€ (State)</strong>: <code>s</code> = â€œWhat is 2+2?â€</p>
</li>
<li>
<p><strong>é‡‡æ ·å¤šä¸ªåŠ¨ä½œ (Sample Actions)</strong>: ä½¿ç”¨å½“å‰ç­–ç•¥ï¼ˆLLMï¼‰ï¼Œé’ˆå¯¹åŒä¸€ä¸ªæç¤º <code>s</code> ç”Ÿæˆ <code>k</code> ä¸ªä¸åŒçš„å›ç­”ï¼ˆæ¯”å¦‚ <code>k=4</code>ï¼‰ã€‚</p>
<ul>
<li><code>a1</code> = â€œ4â€</li>
<li><code>a2</code> = â€œ3â€</li>
<li><code>a3</code> = â€œDâ€</li>
<li><code>a4</code> = â€œCâ€</li>
</ul>
</li>
<li>
<p><strong>è·å–æ¯ä¸ªåŠ¨ä½œçš„å›æŠ¥ (Get Rewards)</strong>: ç”¨å¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ä¸ºæ¯ä¸ªå›ç­”æ‰“åˆ†ã€‚</p>
<ul>
<li><code>R(s, a1)</code> = 10.0 (éå¸¸å¥½çš„å›ç­”)</li>
<li><code>R(s, a2)</code> = 2.0 (é”™è¯¯çš„æ•°å­¦è®¡ç®—)</li>
<li><code>R(s, a3)</code> = -5.0 (æ— å…³çš„å›ç­”)</li>
<li><code>R(s, a4)</code> = -5.0 (æ— å…³çš„å›ç­”)</li>
</ul>
</li>
<li>
<p><strong>ä¼°ç®— V(s) - æ ¸å¿ƒæ­¥éª¤</strong>: æˆ‘ä»¬ç”¨è¿™ <code>k</code> ä¸ªå›æŠ¥çš„<strong>ç»Ÿè®¡å‡å€¼</strong>æ¥ä½œä¸º <code>V(s)</code> çš„ä¸€ä¸ªè¿‘ä¼¼ä¼°è®¡å€¼ <code>VÌ‚(s)</code>ã€‚</p>
<ul>
<li><code>VÌ‚(s) â‰ˆ mean(10.0, 2.0, -5.0, -5.0) = (10+2-5-5) / 4 = 0.5</code></li>
<li>è¿™ä¸ª <code>0.5</code> å°±ä»£è¡¨äº†æˆ‘ä»¬å¯¹å½“å‰æ¨¡å‹åœ¨å›ç­”â€œWhat is 2+2?â€è¿™ä¸ªé—®é¢˜ä¸Šçš„**â€œå¹³å‡è¡¨ç°â€**çš„ä¼°è®¡ã€‚</li>
</ul>
</li>
<li>
<p><strong>è®¡ç®—ä¼˜åŠ¿å‡½æ•° A(s, a)</strong>: ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸€ä¸ªé‡‡æ ·å‡ºçš„å›ç­”è®¡ç®—å…¶ä¼˜åŠ¿å€¼äº†ã€‚</p>
<ul>
<li><code>A(s, a1) = R(s, a1) - VÌ‚(s) = 10.0 - 0.5 = 9.5</code> (è¿œé«˜äºå¹³å‡ï¼Œéå¸¸å¥½)</li>
<li><code>A(s, a2) = R(s, a2) - VÌ‚(s) = 2.0 - 0.5 = 1.5</code> (ç•¥é«˜äºå¹³å‡)</li>
<li><code>A(s, a3) = R(s, a3) - VÌ‚(s) = -5.0 - 0.5 = -5.5</code> (è¿œä½äºå¹³å‡ï¼Œå¾ˆå·®)</li>
<li><code>A(s, a4) = R(s, a4) - VÌ‚(s) = -5.0 - 0.5 = -5.5</code> (è¿œä½äºå¹³å‡ï¼Œå¾ˆå·®)</li>
</ul>
</li>
</ol>
<p>è¿™ç§æ–¹æ³•æ˜¯<strong>ç”¨ç»éªŒå‡å€¼ï¼ˆEmpirical Meanï¼‰æ¥ä»£æ›¿æœŸæœ›å€¼ï¼ˆExpectationï¼‰</strong>ã€‚æ ¹æ®å¤§æ•°å®šå¾‹ï¼Œå½“é‡‡æ ·æ•°é‡ <code>k</code> è¶³å¤Ÿå¤§æ—¶ï¼Œæ ·æœ¬å‡å€¼ä¼šæ”¶æ•›äºçœŸå®çš„æœŸæœ›å€¼ã€‚</p>
<ul>
<li><strong>ä»·å€¼ç½‘ç»œ V(s)</strong>: è¯•å›¾å­¦ä¹ ä¸€ä¸ª<strong>å‡½æ•°</strong>ï¼Œå¯¹äºä»»ä½•è¾“å…¥ <code>s</code>ï¼Œéƒ½èƒ½è¾“å‡ºä¸€ä¸ªæœŸæœ›å›æŠ¥ã€‚å®ƒå…·æœ‰æ³›åŒ–èƒ½åŠ›ï¼Œä½†éœ€è¦é¢å¤–è®­ç»ƒå’Œå†…å­˜ã€‚</li>
<li><strong>å–å‡å€¼ VÌ‚(s)</strong>: ä¸å­¦ä¹ å‡½æ•°ï¼Œè€Œæ˜¯<strong>å³æ—¶è®¡ç®—</strong>ã€‚å®ƒç›´æ¥åˆ©ç”¨å½“å‰ç­–ç•¥çš„è¡¨ç°æ¥ä¼°ç®—æœŸæœ›å›æŠ¥ã€‚è¿™æ˜¯ä¸€ç§â€œæ— æ¨¡å‹â€ï¼ˆmodel-freeï¼‰çš„ä¼°ç®—æ–¹å¼ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Reinforce Learning</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
</search>
